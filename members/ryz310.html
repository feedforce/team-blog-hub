<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon shortcut" type="image/png" href="https://engineers.feedforce.jp/logo.png"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&amp;display=swap"/><title>ryz310 | Feedforce Engineers&#x27; Blogs</title><meta property="og:title" content="ryz310"/><meta property="og:url" content="https://engineers.feedforce.jp/members/ryz310"/><meta name="twitter:card" content="summary_large_image"/><meta property="og:site" content="Feedforce Engineers&#x27; Blogs"/><meta property="og:image" content="https://engineers.feedforce.jp/og.png"/><link rel="canonical" href="https://engineers.feedforce.jp/members/ryz310"/><link rel="alternate" type="application/rss+xml" title="Feedforce Engineers&#x27; Blogs" href="https://engineers.feedforce.jp/rss.xml"/><link rel="alternate" type="application/atom+xml" title="Feedforce Engineers&#x27; Blogs" href="https://engineers.feedforce.jp/atom.xml"/><link rel="preload" href="/_next/static/css/d7faf1fdf25fe7d3262e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d7faf1fdf25fe7d3262e.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-8a83f0fd99327c4684a8.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.1daf1ec1ecf144ee9147.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.9e003f150a446b53bdd9.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-99db904e083fc7f74e35.js" as="script"/><link rel="preload" href="/_next/static/chunks/588505f8033a39c9ef82bc46b1145ac9fd1db500.35a80b323597683276be.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/members/%5Bname%5D-42a7756adc6c0800b4dc.js" as="script"/></head><body><div id="__next"><header class="site-header"><div class="content-wrapper"><div class="site-header__inner"><a class="site-header__logo-link" href="/"><img src="https://engineers.feedforce.jp/logo.svg" alt="Feedforce Engineers&#x27; Blogs" class="site-header__logo-img"/></a><div class="site-header__links"><a href="https://feedforcegroup.jp" class="site-header__link">Company</a><a href="https://github.com/feedforce" class="site-header__link">GitHub</a><a href="https://engineers.recruit.feedforce.jp" class="site-header__link">Recruit</a></div></div></div></header><section class="member"><div class="content-wrapper"><header class="member-header"><div class="member-header__avatar"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" alt="ryz310" width="100" height="100" class="member-header__avatar-img"/></div><h1 class="member-header__name">ryz310</h1><p class="member-header__bio">バックエンドエンジニア。クラロワ好き⚔️</p><div class="member-header__links"><a href="https://twitter.com/ryosuke_sato" class="member-header__link"><img src="https://engineers.feedforce.jp/icons/twitter.svg" alt="Twitterのユーザー@ryosuke_sato" width="22" height="22"/></a><a href="https://github.com/ryz310" class="member-header__link"><img src="https://engineers.feedforce.jp/icons/github.svg" alt="GitHubのユーザー@ryz310" width="22" height="22"/></a><a href="https://rubygems.org/profiles/ryz310" class="member-header__link"><img src="https://engineers.feedforce.jp/icons/link.svg" alt="ウェブサイトのリンク" width="22" height="22"/></a></div></header><div class="member-posts-container"><div class="post-list"><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2021-09-24T02:30:00.000Z" class="post-link__date">4 months ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2021/09/24/113000" class="post-link__main-link"><h2 class="post-link__title">Rubocop Challenger 作者が教えるオススメの使い方。 〜 .rubocop_todo.yml 解消後も消さないで残しておくと良いことがあります！〜</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2021-09-23T11:38:04.000Z" class="post-link__date">4 months ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2021/09/23/203804" class="post-link__main-link"><h2 class="post-link__title">MAU, DAU も計測できるようになった redis-objects-daily-counter v0.3.0</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2021-09-20T08:20:54.000Z" class="post-link__date">4 months ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2021/09/20/172054" class="post-link__main-link"><h2 class="post-link__title">Redis::Objects を使ったサービス改善と新しい gem を作ったお話</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2021-03-07T11:25:19.000Z" class="post-link__date">a year ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2021/03/07/202519" class="post-link__main-link"><h2 class="post-link__title">自作の gem の名前を考えるのは難しい</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2021-03-02T02:39:27.000Z" class="post-link__date">a year ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2021/03/02/113927" class="post-link__main-link"><h2 class="post-link__title">ActiveJob の retry_on に jitter というオプションがあるの知ってますか？</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2021-02-23T13:27:20.000Z" class="post-link__date">a year ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2021/02/23/222720" class="post-link__main-link"><h2 class="post-link__title">RuboCop で違反してるコードを自動的に修正する PR 作ってくれたら嬉しいやろ。できるでそれ。</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2020-03-29T13:08:05.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2020/03/29/220805" class="post-link__main-link"><h2 class="post-link__title">my_api_client v0.16.0 をリリースしました🚀</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2020-03-21T07:38:49.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2020/03/21/163849" class="post-link__main-link"><h2 class="post-link__title">my_api_client v0.15.0 をリリースしました🚀</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2020-02-20T14:55:48.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2020/02/20/235548" class="post-link__main-link"><h2 class="post-link__title">駆け込みで Chrome 80 の SameSite=None; Secure の対応をやった🍪</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2020-01-21T14:00:12.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2020/01/21/230012" class="post-link__main-link"><h2 class="post-link__title">my_api_client v0.13.0 をリリースしました🚀</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2020-01-19T06:28:26.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2020/01/19/152826" class="post-link__main-link"><h2 class="post-link__title">my_api_client v0.12.0 をリリースしました🚀</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2019-12-15T13:43:12.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://ryz310.hateblo.jp/entry/2019/12/15/224312" class="post-link__main-link"><h2 class="post-link__title">私と gem</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=ryz310.hateblo.jp" width="14" height="14" class="post-link__site-favicon"/>ryz310.hateblo.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2018-12-05T05:00:00.000Z" class="post-link__date">3 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2018/12/05/140000" class="post-link__main-link"><h2 class="post-link__title">まだ .rubocop_todo.yml で消耗してるの？</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2018-06-25T01:00:00.000Z" class="post-link__date">4 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2018/06/25/100000" class="post-link__main-link"><h2 class="post-link__title">10 分でわかる Ruby Guild</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2018-02-25T14:45:56.000Z" class="post-link__date">4 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2018/02/25/234556" class="post-link__main-link"><h2 class="post-link__title">続・Rails 5.2 開発環境を Docker で構築する</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2018-02-11T05:00:12.000Z" class="post-link__date">4 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2018/02/11/140012" class="post-link__main-link"><h2 class="post-link__title">Rails 5.2 開発環境を Docker で構築する</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2017-12-31T05:36:11.000Z" class="post-link__date">4 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2017/12/31/143611" class="post-link__main-link"><h2 class="post-link__title">mackerel のカスタムメトリックを echo でワンライナーしたった</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2017-11-26T10:55:09.000Z" class="post-link__date">4 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2017/11/26/195509" class="post-link__main-link"><h2 class="post-link__title">Dynamoid の使い方【global_secondary_index 編】</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2017-11-05T02:15:53.000Z" class="post-link__date">4 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2017/11/05/111553" class="post-link__main-link"><h2 class="post-link__title">Serverlessconf Tokyo 2017 に参加してきました</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/ryz310"><img src="https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">ryz310</div><time dateTime="2017-11-04T14:53:23.000Z" class="post-link__date">4 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2017/11/04/235323" class="post-link__main-link"><h2 class="post-link__title">Dynamoid の使い方【range 編】</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article></div></div></div></section><footer class="site-footer"><div class="content-wrapper"><p>© <!-- -->Feedforce Group Inc.</p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"member":{"name":"ryz310","bio":"バックエンドエンジニア。クラロワ好き⚔️","avatarSrc":"https://www.gravatar.com/userimage/47883079/b6f69b2794a96e21e5a037f511603d43?size=256","sources":["https://developer.feedforce.jp/rss/author/ryz310","https://ryz310.hateblo.jp/rss"],"twitterUsername":"ryosuke_sato","githubUsername":"ryz310","websiteUrl":"https://rubygems.org/profiles/ryz310"},"postItems":[{"title":"Rubocop Challenger 作者が教えるオススメの使い方。 〜 .rubocop_todo.yml 解消後も消さないで残しておくと良いことがあります！〜","content":"\u003cp\u003e1 ヶ月も前になってしまいましたが、クラッソーネの \u003ca href=\"https://twitter.com/yamat47\"\u003e@yamat47\u003c/a\u003e さんが拙作の \u003ca href=\"https://github.com/ryz310/rubocop_challenger\"\u003erubocop_challenger\u003c/a\u003e を使って \u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e を解消した、というブログを書いて下さいました。\u003c/p\u003e\n\n\u003cp\u003eかつての自分と同じような課題を抱えていた方に自分の gem を役立てて頂けたのは本当に嬉しいです。\nブログ化までして下さった @yamat47 さん、本当にありがとうございます！\u003c/p\u003e\n\n\u003cblockquote class=\"twitter-tweet\"\u003e\u003cp lang=\"ja\" dir=\"ltr\"\u003e今年に入ってからちょっとずつ進めてたRuboCopのTodoとの戦いをまとめて記事にしました！こんな感じの、開発者向けの改善をするのもめちゃ好きです😀\u003ca href=\"https://t.co/82F6xmAKko\"\u003ehttps://t.co/82F6xmAKko\u003c/a\u003e\u003c/p\u003e\u0026mdash; Takuya Yamaguchi (@yamat47) \u003ca href=\"https://twitter.com/yamat47/status/1427785662602743811?ref_src=twsrc%5Etfw\"\u003eAugust 18, 2021\u003c/a\u003e\u003c/blockquote\u003e\n\n\n\u003cp\u003e \u003cscript async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"\u003e\u003c/script\u003e\u003c/p\u003e\n\n\u003cp\u003eまた、gem の README では Circle CI を使った方法しか紹介してなかったのですが、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GitHub\"\u003eGitHub\u003c/a\u003e Actions を使った方法についても解説して頂いており、重ね重ね感謝感激です🙏\n\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GitHub\"\u003eGitHub\u003c/a\u003e の README からもリンク貼らせて頂きました！\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fzenn.dev%2Fyamat47%2Farticles%2F219e14ebcf31a1d13ff4\" title=\"RuboCop ChallengerをGitHub Actionsで動かす\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://zenn.dev/yamat47/articles/219e14ebcf31a1d13ff4\"\u003ezenn.dev\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003e一方で、ひとつ気になったことが。。\u003c/h2\u003e\n\n\u003cblockquote\u003e\u003cp\u003e自動で解消できるものがなくなって以降はRuboCop Challengerの仕組みが不要になったので、最後は削除してしまいました。\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"https://tech.crassone.jp/images/posts/resolve-rubocop-todos-step-by-step/good-bye-rubocop-challenger.png\" alt=\"手動で対応した履歴\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eありがとう、RuboCop Challenger...!!\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003e待って！\n\u003cstrong\u003eRubocop Challenger は消さないで残しておくと良いことがあります！\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2\u003eRubocop Challenger は v2.0.0 から bundle update 機能も兼ね備えています\u003c/h2\u003e\n\n\u003cp\u003e本家 RuboCop の gem をアップデートする時、新しく追加された Cop によってエラーが出てしまった、という経験は無いでしょうか？\nこのエラーの解消が億劫で gem のアップデートを放置してしまっている方もいるかも知れません。\u003c/p\u003e\n\n\u003cp\u003eRubocop Challenger v1.0.0 のテーマは「負債の解消」だったんですが、 v2.0.0 からは「RuboCop との共生」だったりします。\u003c/p\u003e\n\n\u003cp\u003e誰にも話したこと無いので今始めて公表しました←\u003c/p\u003e\n\n\u003cp\u003ev2.0.0 以上の Rubocop Challenger では最初に RuboCop 関連の gem に対して \u003ccode\u003ebundle update\u003c/code\u003e を実行するようになっています。\u003c/p\u003e\n\n\u003cp\u003e最新の RuboCop にアップデートした状態で Rubocop Challenge を実行するので、新しく追加された Cop に違反したコードがあった場合、その場で即 \u003ccode\u003eauto-correct\u003c/code\u003e を実行し、\u003ca href=\"https://github.com/ryz310/my_api_client/pull/616\"\u003e以下のような PR\u003c/a\u003e を作成してくれます。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"PR1\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210923/20210923205915.png\" alt=\"f:id:ryz310:20210923205915p:plain\" width=\"949\" height=\"388\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/RSpec\"\u003eRSpec\u003c/a\u003e/ExcessiveDocstringSpacing を修正した PR が作成されました\u003c/figcaption\u003e\u003c/figure\u003e\n\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"PR2\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210923/20210923210041.png\" alt=\"f:id:ryz310:20210923210041p:plain\" width=\"1200\" height=\"455\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003e同 PR で \u003ccode\u003erubocop-rspec\u003c/code\u003e が v2.4.0 から v2.5.0 にアップデートされています\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003e一方 dependabot も \u003ccode\u003erubocop-rspec\u003c/code\u003e v2.5.0 の bundle update の PR を作成してくれていますが、こちらは CI の RuboCop チェックでエラーになっています。\nRuboCop の CI チェックをパスしないと merge 出来ない設定にしている場合も多いと思いますが、これを修正するのは地味に面倒です。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"aaa\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210923/20210923210548.png\" alt=\"f:id:ryz310:20210923210548p:plain\" width=\"936\" height=\"364\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210923/20210923210545.png\" alt=\"f:id:ryz310:20210923210545p:plain\" width=\"955\" height=\"291\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eRuboCop の CI チェックでエラー\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003eちなみに違反したコードが存在しない場合は \u003ca href=\"https://github.com/ryz310/rubocop_challenger/pull/531\"\u003eRe-generate .rubocop_todo.yml with RuboCop v1.21.0\u003c/a\u003e のような PR が作成され、 \u003ccode\u003ebundle update\u003c/code\u003e を実行しただけの PR が作成されます。\u003c/p\u003e\n\n\u003cp\u003eこの機能は地味に便利なので、CI のスケジュール実行を使って週イチくらいで動かすのがオススメの使い方です。\u003c/p\u003e\n\n\u003ch2\u003ev2.0.0 以降の RuboCop Challenger は Gemfile に含めない事をオススメします\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003ev2.0.0\u003c/code\u003e あたりから RuboCop Challenger を Gemfile に含めて実行すると、他の gem との互換性問題でエラーになるケースを確認しております🙏\n現在では以下のように CI での実行時に \u003ccode\u003egem install rubocop_challenger\u003c/code\u003e を実行する方法をオススメしております。\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# .circleci/config.yml\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003eversion\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e\n\n\u003cspan class=\"synIdentifier\"\u003ejobs\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003erubocop_challenge\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003edocker\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eimage\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e circleci/ruby:3.0\n    \u003cspan class=\"synIdentifier\"\u003eworking_directory\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ~/repo\n    \u003cspan class=\"synIdentifier\"\u003esteps\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003echeckout\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Rubocop Challenge\n          \u003cspan class=\"synIdentifier\"\u003ecommand\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e |\n            gem install rubocop_challenger\n            rubocop_challenger go \\\n              --email=rubocop-challenger@example.com \\\n              --name=\u0026quot;Rubocop Challenger\u0026quot;\n\n\u003cspan class=\"synIdentifier\"\u003eworkflows\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003eversion\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e\n\n  \u003cspan class=\"synIdentifier\"\u003enightly\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003etriggers\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eschedule\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003ecron\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;30 23 * * 1,2,3\u0026quot;\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # 8:30am every Tuesday, Wednsday and Thursday (JST)\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003efilters\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"synIdentifier\"\u003ebranches\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"synIdentifier\"\u003eonly\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003emaster\n    \u003cspan class=\"synIdentifier\"\u003ejobs\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003erubocop_challenge\n\u003c/pre\u003e\n\n\n\u003cp\u003eこちらは完全に自分がやらかしたというか、会社で書いた以下のブログの内容が古いまま更新しなかったため、 \u003ccode\u003eGemfile\u003c/code\u003e に \u003ccode\u003erubocop_challenger\u003c/code\u003e を入れて使っている方が沢山 (?) いるかも知れません。\n\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GitHub\"\u003eGitHub\u003c/a\u003e の README ですら間違っていたので、さっき慌てて修正しました。。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2018%2F12%2F05%2F140000\" title=\"まだ .rubocop_todo.yml で消耗してるの？ - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2018/12/05/140000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e古い方法で使ってしまった皆さん、本当にすみません。。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003erubocop_challenger\u003c/code\u003e を Gemfile に含めるのが\u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e 解消後にアンインストールしたくなる理由の一つだと思うので、これで使い続ける人が増えてくれると嬉しいです🙏\u003c/p\u003e\n\n\u003ch2\u003e安全な auto-correct かどうかが分かります\u003c/h2\u003e\n\n\u003cp\u003e特にアナウンスしていなかった気がするのでついでにご紹介しておくと、最新の Rubocop Challenger では「安全な auto-correct」かどうかが分かるようになっていて、 PR の本文に以下のような記述が入るようになっています。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"安全な auto-correct \"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210923/20210923215918.png\" alt=\"f:id:ryz310:20210923215918p:plain\" width=\"426\" height=\"156\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003e✅ 安全な auto-correct\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"安全でない auto-correct\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210923/20210923220846.png\" alt=\"f:id:ryz310:20210923220846p:plain\" width=\"427\" height=\"168\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003e⚠️ 安全でない auto-correct\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003eRuboCop 公式によると「安全な auto-correct」の場合、元の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9\"\u003eソースコード\u003c/a\u003eが壊れる心配は無いとのことなので、 PR merge する際の判断材料にして頂ければ。\u003c/p\u003e\n","contentSnippet":"1 ヶ月も前になってしまいましたが、クラッソーネの @yamat47 さんが拙作の rubocop_challenger を使って .rubocop_todo.yml を解消した、というブログを書いて下さいました。かつての自分と同じような課題を抱えていた方に自分の gem を役立てて頂けたのは本当に嬉しいです。ブログ化までして下さった @yamat47 さん、本当にありがとうございます！今年に入ってからちょっとずつ進めてたRuboCopのTodoとの戦いをまとめて記事にしました！こんな感じの、開発者向けの改善をするのもめちゃ好きです😀https://t.co/82F6xmAKko— Takuya Yamaguchi (@yamat47) August 18, 2021 また、gem の README では Circle CI を使った方法しか紹介してなかったのですが、GitHub Actions を使った方法についても解説して頂いており、重ね重ね感謝感激です🙏GitHub の README からもリンク貼らせて頂きました！zenn.dev一方で、ひとつ気になったことが。。自動で解消できるものがなくなって以降はRuboCop Challengerの仕組みが不要になったので、最後は削除してしまいました。ありがとう、RuboCop Challenger...!!待って！Rubocop Challenger は消さないで残しておくと良いことがあります！Rubocop Challenger は v2.0.0 から bundle update 機能も兼ね備えています本家 RuboCop の gem をアップデートする時、新しく追加された Cop によってエラーが出てしまった、という経験は無いでしょうか？このエラーの解消が億劫で gem のアップデートを放置してしまっている方もいるかも知れません。Rubocop Challenger v1.0.0 のテーマは「負債の解消」だったんですが、 v2.0.0 からは「RuboCop との共生」だったりします。誰にも話したこと無いので今始めて公表しました←v2.0.0 以上の Rubocop Challenger では最初に RuboCop 関連の gem に対して bundle update を実行するようになっています。最新の RuboCop にアップデートした状態で Rubocop Challenge を実行するので、新しく追加された Cop に違反したコードがあった場合、その場で即 auto-correct を実行し、以下のような PR を作成してくれます。RSpec/ExcessiveDocstringSpacing を修正した PR が作成されました同 PR で rubocop-rspec が v2.4.0 から v2.5.0 にアップデートされています一方 dependabot も rubocop-rspec v2.5.0 の bundle update の PR を作成してくれていますが、こちらは CI の RuboCop チェックでエラーになっています。RuboCop の CI チェックをパスしないと merge 出来ない設定にしている場合も多いと思いますが、これを修正するのは地味に面倒です。RuboCop の CI チェックでエラーちなみに違反したコードが存在しない場合は Re-generate .rubocop_todo.yml with RuboCop v1.21.0 のような PR が作成され、 bundle update を実行しただけの PR が作成されます。この機能は地味に便利なので、CI のスケジュール実行を使って週イチくらいで動かすのがオススメの使い方です。v2.0.0 以降の RuboCop Challenger は Gemfile に含めない事をオススメしますv2.0.0 あたりから RuboCop Challenger を Gemfile に含めて実行すると、他の gem との互換性問題でエラーになるケースを確認しております🙏現在では以下のように CI での実行時に gem install rubocop_challenger を実行する方法をオススメしております。# .circleci/config.ymlversion: 2jobs:  rubocop_challenge:    docker:      - image: circleci/ruby:3.0    working_directory: ~/repo    steps:      - checkout      - run:          name: Rubocop Challenge          command: |            gem install rubocop_challenger            rubocop_challenger go \\              --email=rubocop-challenger@example.com \\              --name=\"Rubocop Challenger\"workflows:  version: 2  nightly:    triggers:      - schedule:          cron: \"30 23 * * 1,2,3\" # 8:30am every Tuesday, Wednsday and Thursday (JST)          filters:            branches:              only:                - master    jobs:      - rubocop_challengeこちらは完全に自分がやらかしたというか、会社で書いた以下のブログの内容が古いまま更新しなかったため、 Gemfile に rubocop_challenger を入れて使っている方が沢山 (?) いるかも知れません。GitHub の README ですら間違っていたので、さっき慌てて修正しました。。developer.feedforce.jp古い方法で使ってしまった皆さん、本当にすみません。。rubocop_challenger を Gemfile に含めるのが.rubocop_todo.yml 解消後にアンインストールしたくなる理由の一つだと思うので、これで使い続ける人が増えてくれると嬉しいです🙏安全な auto-correct かどうかが分かります特にアナウンスしていなかった気がするのでついでにご紹介しておくと、最新の Rubocop Challenger では「安全な auto-correct」かどうかが分かるようになっていて、 PR の本文に以下のような記述が入るようになっています。✅ 安全な auto-correct⚠️ 安全でない auto-correctRuboCop 公式によると「安全な auto-correct」の場合、元のソースコードが壊れる心配は無いとのことなので、 PR merge する際の判断材料にして頂ければ。","link":"https://ryz310.hateblo.jp/entry/2021/09/24/113000","isoDate":"2021-09-24T02:30:00.000Z","dateMiliSeconds":1632450600000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210923/20210923205915.png","authorName":"ryz310"},{"title":"MAU, DAU も計測できるようになった redis-objects-daily-counter v0.3.0","content":"\u003cp\u003e前回のブログで \u003ca href=\"https://github.com/ryz310/redis-objects-daily-counter\"\u003eredis-objects-daily-counter\u003c/a\u003e という gem を作ったという話をしました。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fryz310.hateblo.jp%2Fentry%2F2021%2F09%2F20%2F172054\" title=\"Redis::Objects を使ったサービス改善と新しい gem を作ったお話 - 逃げる8回で会心の一撃\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://ryz310.hateblo.jp/entry/2021/09/20/172054\"\u003eryz310.hateblo.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e今回は \u003ccode\u003ev0.3.0\u003c/code\u003e をリリースしたのでそちらのご紹介です。\u003c/p\u003e\n\n\u003ch2\u003e【おさらい】redis-objects-daily-counter はどういう gem なのか\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/nateware/redis-objects\"\u003eredis-objects\u003c/a\u003e gem の拡張として作られており、日付の変更毎に新しい  counter を定義してくれる \u003ccode\u003edaily_counter\u003c/code\u003e 機能を提供する gem です。\u003c/p\u003e\n\n\u003cp\u003e例えば以下のような \u003ccode\u003eHomepage\u003c/code\u003e という class で \u003ccode\u003edaily_counter :pv\u003c/code\u003e という定義をします。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eHomepage\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003einclude\u003c/span\u003e \u003cspan class=\"synType\"\u003eRedis\u003c/span\u003e::\u003cspan class=\"synType\"\u003eObjects\u003c/span\u003e\n\n  daily_counter \u003cspan class=\"synConstant\"\u003e:pv\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eexpireat\u003c/span\u003e: -\u0026gt; { \u003cspan class=\"synType\"\u003eTime\u003c/span\u003e.now + \u003cspan class=\"synConstant\"\u003e2_678_400\u003c/span\u003e } \u003cspan class=\"synComment\"\u003e# about a month\u003c/span\u003e\n\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eid\u003c/span\u003e\n    \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eすると以下のように \u003ccode\u003e#pv\u003c/code\u003e という\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9\"\u003eインスタンス\u003c/a\u003eメソッドが使えるようになります。\nこれは \u003ccode\u003eredis-objects\u003c/code\u003e gem の \u003ccode\u003ecounter\u003c/code\u003e の拡張であり、 \u003ccode\u003e#increment\u003c/code\u003e や \u003ccode\u003e#decrement\u003c/code\u003e というメソッドで Redis 上の値を更新することが可能です。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# 2021-04-01\u003c/span\u003e\nhomepage = \u003cspan class=\"synType\"\u003eHomepage\u003c/span\u003e.new\nhomepage.id \u003cspan class=\"synComment\"\u003e# 1\u003c/span\u003e\n\nhomepage.pv.increment\nhomepage.pv.increment\nhomepage.pv.increment\nputs homepage.pv.value \u003cspan class=\"synComment\"\u003e# 3\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003edaily_counter\u003c/code\u003e が \u003ccode\u003ecounter\u003c/code\u003e とどのように違うかというと、日付が変わるとRedis 上の Key が変化するという点です。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# 2021-04-02 (next day)\u003c/span\u003e\nputs homepage.pv.value \u003cspan class=\"synComment\"\u003e# 0\u003c/span\u003e\nhomepage.pv.increment\nhomepage.pv.increment\nputs homepage.pv.value \u003cspan class=\"synComment\"\u003e# 2\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eこれは、 \u003ccode\u003edaily_counter\u003c/code\u003e が以下のようなルールに則って Redis の Key にアクセスするように振る舞うためです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003emodel_name:id:field_name:yyyy-mm-dd\u003c/pre\u003e\n\n\n\u003cp\u003eなお、この時の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%BE%A1%BC%A5%F3\"\u003eタイムゾーン\u003c/a\u003eは実行中の \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ruby\"\u003eRuby\u003c/a\u003e プロセスの標準\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%BE%A1%BC%A5%F3\"\u003eタイムゾーン\u003c/a\u003eに従いますが、 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e 上で実行した場合は \u003ccode\u003eapplication.rb\u003c/code\u003e で指定した\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%BE%A1%BC%A5%F3\"\u003eタイムゾーン\u003c/a\u003eに従います。\u003c/p\u003e\n\n\u003cp\u003e日付が変わった後も、前日までの Key-\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Value\"\u003eValue\u003c/a\u003e は削除していないので、 \u003ccode\u003e#range\u003c/code\u003e や \u003ccode\u003e#[]\u003c/code\u003e や \u003ccode\u003e#at\u003c/code\u003e というメソッドでアクセスすることが可能です。\nちなみに \u003ccode\u003e#range\u003c/code\u003e や \u003ccode\u003e#[]\u003c/code\u003e では値が返却されますが、 \u003ccode\u003e#at\u003c/code\u003e では \u003ccode\u003eRedis::Counter\u003c/code\u003e \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9\"\u003eインスタンス\u003c/a\u003eが返却されます。\n\u003ccode\u003ev0.2.0\u003c/code\u003e までは \u003ccode\u003e#[]\u003c/code\u003e と \u003ccode\u003e#at\u003c/code\u003e は同じ挙動でしたが、 \u003ccode\u003ev0.3.0\u003c/code\u003e からそういう実装に変わりました 🙏\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# 2021-04-01\u003c/span\u003e\nhomepage.pv.increment(\u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e)\n\n\u003cspan class=\"synComment\"\u003e# 2021-04-02 (next day)\u003c/span\u003e\nhomepage.pv.increment(\u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)\n\n\u003cspan class=\"synComment\"\u003e# 2021-04-03 (next day)\u003c/span\u003e\nhomepage.pv.increment(\u003cspan class=\"synConstant\"\u003e5\u003c/span\u003e)\n\nhomepage.pv[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e)] \u003cspan class=\"synComment\"\u003e# =\u0026gt; 3\u003c/span\u003e\nhomepage.pv[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e), \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e] \u003cspan class=\"synComment\"\u003e# =\u0026gt; [3, 2, 5]\u003c/span\u003e\nhomepage.pv[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e)..\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)] \u003cspan class=\"synComment\"\u003e# =\u0026gt; [3, 2]\u003c/span\u003e\n\nhomepage.pv.delete_at(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e))\nhomepage.pv.range(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e), \u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e)) \u003cspan class=\"synComment\"\u003e# =\u0026gt; [0, 2, 5]\u003c/span\u003e\nhomepage.pv.at(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)) \u003cspan class=\"synComment\"\u003e# =\u0026gt; #\u0026lt;Redis::Counter key=\u0026quot;homepage:1:pv:2021-04-02\u0026quot;\u0026gt;\u003c/span\u003e\nhomepage.pv.at(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)).value \u003cspan class=\"synComment\"\u003e# 2\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch2\u003ev0.3.0 で追加された機能とは\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003edaily_counter\u003c/code\u003e に加えて \u003ccode\u003edaily_set\u003c/code\u003e が追加されました。\nこちらは \u003ccode\u003eredis-objects\u003c/code\u003e gem の \u003ccode\u003eset\u003c/code\u003eに \u003ccode\u003edaily-\u003c/code\u003e 機能を追加したものになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eHomepage\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003einclude\u003c/span\u003e \u003cspan class=\"synType\"\u003eRedis\u003c/span\u003e::\u003cspan class=\"synType\"\u003eObjects\u003c/span\u003e\n\n  daily_set \u003cspan class=\"synConstant\"\u003e:dau\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eexpireat\u003c/span\u003e: -\u0026gt; { \u003cspan class=\"synType\"\u003eTime\u003c/span\u003e.now + \u003cspan class=\"synConstant\"\u003e2_678_400\u003c/span\u003e } \u003cspan class=\"synComment\"\u003e# about a month\u003c/span\u003e\n\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eid\u003c/span\u003e\n    \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\nhomepage.dau \u0026lt;\u0026lt; \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003euser1\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\nhomepage.dau \u0026lt;\u0026lt; \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003euser2\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\nhomepage.dau \u0026lt;\u0026lt; \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003euser1\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e \u003cspan class=\"synComment\"\u003e# dup ignored\u003c/span\u003e\nputs homepage.dau.members \u003cspan class=\"synComment\"\u003e# ['user1', 'user2']\u003c/span\u003e\nputs homepage.dau.length \u003cspan class=\"synComment\"\u003e# 2\u003c/span\u003e\nputs homepage.dau.count \u003cspan class=\"synComment\"\u003e# alias of #length\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003eset\u003c/code\u003e は重複を受け付けない \u003ccode\u003eArray\u003c/code\u003e と考えて良いと思います。\n上記の例を見てもらうと分かりますが \u003ccode\u003euser1\u003c/code\u003e を 2 回追加しても \u003ccode\u003e#members\u003c/code\u003e による取得結果には 1 つしか含まれていません。\u003c/p\u003e\n\n\u003cp\u003eこれを使って何が実現できるかというと、 DAU (Daily Active User) の計測です。\nログインしたユーザーの ID を \u003ccode\u003edaily_set\u003c/code\u003e で定義した変数に追加していくことで、その日アクティブだったユーザー一覧とその数を知ることが出来ます。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# 2021-04-01\u003c/span\u003e\nhomepage.dau.merge(\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003euser1\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003euser2\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e)\nputs homepage.dau.members \u003cspan class=\"synComment\"\u003e# ['user1', 'user2']\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e# 2021-04-02 (next day)\u003c/span\u003e\nputs homepage.dau.members \u003cspan class=\"synComment\"\u003e# []\u003c/span\u003e\n\nhomepage.dau.merge(\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003euser2\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003euser3\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e)\nputs homepage.dau.members \u003cspan class=\"synComment\"\u003e# ['user2', 'user3']\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e# 2021-04-03 (next day)\u003c/span\u003e\nhomepage.dau.merge(\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003euser4\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e)\n\nhomepage.dau.at(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)) \u003cspan class=\"synComment\"\u003e# =\u0026gt; #\u0026lt;Redis::Set key=\u0026quot;homepage:1:dau:2021-04-02\u0026quot;\u0026gt;\u003c/span\u003e\nhomepage.dau.at(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)).members \u003cspan class=\"synComment\"\u003e# =\u0026gt; ['user2', 'user3']\u003c/span\u003e\nhomepage.dau.at(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)).length \u003cspan class=\"synComment\"\u003e# =\u0026gt; 2\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003e#range\u003c/code\u003e や \u003ccode\u003e#[]\u003c/code\u003e を使う事で指定した期間内の値を結合することも出来ます。\nこれによって DAU 目的で記録した値から MAU を求めることも可能です。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003ehomepage.dau[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e)] \u003cspan class=\"synComment\"\u003e# =\u0026gt; ['user1', 'user2']\u003c/span\u003e\nhomepage.dau[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e), \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e] \u003cspan class=\"synComment\"\u003e# =\u0026gt; ['user1', 'user2', 'user3', 'user4']\u003c/span\u003e\nhomepage.dau[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e)..\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)] \u003cspan class=\"synComment\"\u003e# =\u0026gt; ['user1', 'user2', 'user3']\u003c/span\u003e\n\nhomepage.dau.delete_at(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e))\nhomepage.dau.range(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e), \u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e)) \u003cspan class=\"synComment\"\u003e# =\u0026gt; ['user2', 'user3', 'user4']\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003e#at\u003c/code\u003e で一日ずつ値を取得して \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ruby\"\u003eRuby\u003c/a\u003e の \u003ccode\u003eArray#uniq\u003c/code\u003e を使っても同じ結果が得られますが、 \u003ccode\u003e#range\u003c/code\u003e や \u003ccode\u003e#[]\u003c/code\u003e の方が内部で \u003ca href=\"https://redis.io/commands/sunion\"\u003eRedis の \u003ccode\u003eSUNION\u003c/code\u003e\u003c/a\u003e を利用するため高速だと思います。\u003c/p\u003e\n\n\u003cp\u003eちなみに \u003ccode\u003e#range\u003c/code\u003e や \u003ccode\u003e#[]\u003c/code\u003e の結果は \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ruby\"\u003eRuby\u003c/a\u003e の Array なので、 \u003ccode\u003e#length\u003c/code\u003e を使って長さを求める際は実行中のマシンリソースを消費します。\n一方 \u003ccode\u003e#at\u003c/code\u003e では \u003ccode\u003eRedis::Set\u003c/code\u003e を返しており、 \u003ccode\u003eRedis::Set#length\u003c/code\u003e は内部で \u003ca href=\"https://redis.io/commands/scard\"\u003eRedis の \u003ccode\u003eSCARD\u003c/code\u003e\u003c/a\u003e を実行するため、 \u003ccode\u003e#length\u003c/code\u003e は \u003ccode\u003e#at\u003c/code\u003e からの方が高速だと思います。\nただし一定期間の値の結合は \u003ccode\u003e#range\u003c/code\u003e や \u003ccode\u003e#[]\u003c/code\u003e を使う必要があるので、結局マシンリソースの消費は避けられないですね。。\u003c/p\u003e\n\n\u003cp\u003eこの辺りの仕様は実装していてかなり頭を悩ませました。なので今後のアップデートで破壊的な変更が入るかも知れません。\u003c/p\u003e\n\n\u003ch2\u003e\u003ccode\u003emonthly_set\u003c/code\u003e なども実装してあります\u003c/h2\u003e\n\n\u003cp\u003e前回の記事でも紹介したような \u003ccode\u003emonthly_counter\u003c/code\u003e に相当する \u003ccode\u003emonthly_set\u003c/code\u003e なども使えます。\nMAU, WAU, DAU で使い分けると良いかと思います。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eannual_set\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eRedis is a highly volatile key-\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/value\"\u003evalue\u003c/a\u003e store, so I don't recommend using it.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emonthly_set\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy-mm\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eweekly_set\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyyWw\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edaily_set\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy-mm-dd\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehourly_set\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy-mm-ddThh\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eminutely_set\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy-mm-ddThh:mi\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n","contentSnippet":"前回のブログで redis-objects-daily-counter という gem を作ったという話をしました。ryz310.hateblo.jp今回は v0.3.0 をリリースしたのでそちらのご紹介です。【おさらい】redis-objects-daily-counter はどういう gem なのかredis-objects gem の拡張として作られており、日付の変更毎に新しい  counter を定義してくれる daily_counter 機能を提供する gem です。例えば以下のような Homepage という class で daily_counter :pv という定義をします。class Homepage  include Redis::Objects  daily_counter :pv, expireat: -\u003e { Time.now + 2_678_400 } # about a month  def id    1  endendすると以下のように #pv というインスタンスメソッドが使えるようになります。これは redis-objects gem の counter の拡張であり、 #increment や #decrement というメソッドで Redis 上の値を更新することが可能です。# 2021-04-01homepage = Homepage.newhomepage.id # 1homepage.pv.incrementhomepage.pv.incrementhomepage.pv.incrementputs homepage.pv.value # 3daily_counter が counter とどのように違うかというと、日付が変わるとRedis 上の Key が変化するという点です。# 2021-04-02 (next day)puts homepage.pv.value # 0homepage.pv.incrementhomepage.pv.incrementputs homepage.pv.value # 2これは、 daily_counter が以下のようなルールに則って Redis の Key にアクセスするように振る舞うためです。model_name:id:field_name:yyyy-mm-ddなお、この時のタイムゾーンは実行中の Ruby プロセスの標準タイムゾーンに従いますが、 Rails 上で実行した場合は application.rb で指定したタイムゾーンに従います。日付が変わった後も、前日までの Key-Value は削除していないので、 #range や #[] や #at というメソッドでアクセスすることが可能です。ちなみに #range や #[] では値が返却されますが、 #at では Redis::Counter インスタンスが返却されます。v0.2.0 までは #[] と #at は同じ挙動でしたが、 v0.3.0 からそういう実装に変わりました 🙏# 2021-04-01homepage.pv.increment(3)# 2021-04-02 (next day)homepage.pv.increment(2)# 2021-04-03 (next day)homepage.pv.increment(5)homepage.pv[Date.new(2021, 4, 1)] # =\u003e 3homepage.pv[Date.new(2021, 4, 1), 3] # =\u003e [3, 2, 5]homepage.pv[Date.new(2021, 4, 1)..Date.new(2021, 4, 2)] # =\u003e [3, 2]homepage.pv.delete_at(Date.new(2021, 4, 1))homepage.pv.range(Date.new(2021, 4, 1), Date.new(2021, 4, 3)) # =\u003e [0, 2, 5]homepage.pv.at(Date.new(2021, 4, 2)) # =\u003e #\u003cRedis::Counter key=\"homepage:1:pv:2021-04-02\"\u003ehomepage.pv.at(Date.new(2021, 4, 2)).value # 2v0.3.0 で追加された機能とはdaily_counter に加えて daily_set が追加されました。こちらは redis-objects gem の setに daily- 機能を追加したものになります。class Homepage  include Redis::Objects  daily_set :dau, expireat: -\u003e { Time.now + 2_678_400 } # about a month  def id    1  endendhomepage.dau \u003c\u003c 'user1'homepage.dau \u003c\u003c 'user2'homepage.dau \u003c\u003c 'user1' # dup ignoredputs homepage.dau.members # ['user1', 'user2']puts homepage.dau.length # 2puts homepage.dau.count # alias of #lengthset は重複を受け付けない Array と考えて良いと思います。上記の例を見てもらうと分かりますが user1 を 2 回追加しても #members による取得結果には 1 つしか含まれていません。これを使って何が実現できるかというと、 DAU (Daily Active User) の計測です。ログインしたユーザーの ID を daily_set で定義した変数に追加していくことで、その日アクティブだったユーザー一覧とその数を知ることが出来ます。# 2021-04-01homepage.dau.merge('user1', 'user2')puts homepage.dau.members # ['user1', 'user2']# 2021-04-02 (next day)puts homepage.dau.members # []homepage.dau.merge('user2', 'user3')puts homepage.dau.members # ['user2', 'user3']# 2021-04-03 (next day)homepage.dau.merge('user4')homepage.dau.at(Date.new(2021, 4, 2)) # =\u003e #\u003cRedis::Set key=\"homepage:1:dau:2021-04-02\"\u003ehomepage.dau.at(Date.new(2021, 4, 2)).members # =\u003e ['user2', 'user3']homepage.dau.at(Date.new(2021, 4, 2)).length # =\u003e 2#range や #[] を使う事で指定した期間内の値を結合することも出来ます。これによって DAU 目的で記録した値から MAU を求めることも可能です。homepage.dau[Date.new(2021, 4, 1)] # =\u003e ['user1', 'user2']homepage.dau[Date.new(2021, 4, 1), 3] # =\u003e ['user1', 'user2', 'user3', 'user4']homepage.dau[Date.new(2021, 4, 1)..Date.new(2021, 4, 2)] # =\u003e ['user1', 'user2', 'user3']homepage.dau.delete_at(Date.new(2021, 4, 1))homepage.dau.range(Date.new(2021, 4, 1), Date.new(2021, 4, 3)) # =\u003e ['user2', 'user3', 'user4']#at で一日ずつ値を取得して Ruby の Array#uniq を使っても同じ結果が得られますが、 #range や #[] の方が内部で Redis の SUNION を利用するため高速だと思います。ちなみに #range や #[] の結果は Ruby の Array なので、 #length を使って長さを求める際は実行中のマシンリソースを消費します。一方 #at では Redis::Set を返しており、 Redis::Set#length は内部で Redis の SCARD を実行するため、 #length は #at からの方が高速だと思います。ただし一定期間の値の結合は #range や #[] を使う必要があるので、結局マシンリソースの消費は避けられないですね。。この辺りの仕様は実装していてかなり頭を悩ませました。なので今後のアップデートで破壊的な変更が入るかも知れません。monthly_set なども実装してあります前回の記事でも紹介したような monthly_counter に相当する monthly_set なども使えます。MAU, WAU, DAU で使い分けると良いかと思います。annual_setKey format: model_name:id:field_name:yyyyRedis is a highly volatile key-value store, so I don't recommend using it.monthly_setKey format: model_name:id:field_name:yyyy-mmweekly_setKey format: model_name:id:field_name:yyyyWwdaily_setKey format: model_name:id:field_name:yyyy-mm-ddhourly_setKey format: model_name:id:field_name:yyyy-mm-ddThhminutely_setKey format: model_name:id:field_name:yyyy-mm-ddThh:mi","link":"https://ryz310.hateblo.jp/entry/2021/09/23/203804","isoDate":"2021-09-23T11:38:04.000Z","dateMiliSeconds":1632397084000,"imageUrl":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","authorName":"ryz310"},{"title":"Redis::Objects を使ったサービス改善と新しい gem を作ったお話","content":"\u003cp\u003e半年ぶりくらいに会社の勉強会で発表しました。\u003c/p\u003e\n\n\u003ciframe class=\"speakerdeck-iframe\" frameborder=\"0\" src=\"https://speakerdeck.com/player/58bb74a90a8b444e8607850fc76d8eb7\" title=\"Redis::Objects で遊んでみよう\" allowfullscreen=\"true\" mozallowfullscreen=\"true\" webkitallowfullscreen=\"true\" style=\"border: 0px; background: padding-box padding-box rgba(0, 0, 0, 0.1); margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 560px; height: 314px;\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003eRedis::Objects という gem を使って RDS にかかっていた IO 負荷を改善した、という話と、 Redis::Objects を拡張する gem を作ったという話（後述）です。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Fredis-objects-daily-counter\" title=\"GitHub - ryz310/redis-objects-daily-counter: Daily counter within Redis::Objects. Works with any class or ORM.\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/redis-objects-daily-counter\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eRedis を使って DB の負荷を下げる系のお話って 2010 年代にされ尽くした感があって、今更な気もするんですが、一周回って最近聞かない話だなーと思ってます。\nフロントエンドエンジニアで最近サーバーサイドも触る機会が増えたような方々にウケが良かった感じがありますね。\u003c/p\u003e\n\n\u003chr /\u003e\n\n\u003cp\u003e一方で社内のインフラエンジニアからは Redis ってメンテナンスの手間が掛かって評判悪いですね。\n使うだけなら手軽で楽なんですが、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/AWS\"\u003eAWS\u003c/a\u003e のアップデートでダウンタイムが発生する時に利用者向けにアナウンスしないといけなかったり。\nダウンタイムと言っても深夜に数秒〜数分なので影響は少ないと思うんですが、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%F3%A5%BF%A1%BC%A5%D7%A5%E9%A5%A4%A5%BA\"\u003eエンタープライズ\u003c/a\u003e向けのサービスとかやってるとこの辺は厳しいですね。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://cloud.google.com/blog/ja/products/management-tools/sre-error-budgets-and-maintenance-windows\"\u003eSRE のエラーバジェットの概念\u003c/a\u003e が日本全体に浸透すればソフトウェア開発の生産性は底上げされるんじゃないかと思うのですが、この辺は時間を掛けて少しずつ啓蒙していくしか無いですね。例えば日本の生活インフラ（電気・水道・ガスとか電車とか）ってめっちゃ高水準なので、ソフトウェアの世界でも100％稼働することが当たり前という価値観になってしまうんじゃないかな、と思うのですが、この辺の価値観は表裏一体というか、当たり前と感じているから高品質になる一方で、生産性は下がってしまうという構図だと思っています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.nic.ad.jp/ja/materials/iw/2017/proceedings/s15/s15-fujisaki.pdf\"\u003ehttps://www.nic.ad.jp/ja/materials/iw/2017/proceedings/s15/s15-fujisaki.pdf\u003c/a\u003e\n\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"SREの信条 (Google)\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210920/20210920165304.png\" alt=\"f:id:ryz310:20210920165304p:plain\" width=\"963\" height=\"527\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eSREの信条 (\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Google\"\u003eGoogle\u003c/a\u003e)\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003e一応メンテナンスの手間、という点では夏頃に \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/AWS\"\u003eAWS\u003c/a\u003e から \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Amazon\"\u003eAmazon\u003c/a\u003e MemoryDB for Redis というフルマネージドな Redis が発表されています。\n東京リージョンは未対応で、書き込み速度が遅くなっていたり、料金も若干高くなっていたりしますが、気になるサービスではありますね。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdev.classmethod.jp%2Farticles%2Faws-release-durable-redis-amazon-memorydb-for-redis%2F\" title=\"Redisに耐久性が加わったAmazon MemoryDB for Redisが登場 | DevelopersIO\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://dev.classmethod.jp/articles/aws-release-durable-redis-amazon-memorydb-for-redis/\"\u003edev.classmethod.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003chr /\u003e\n\n\u003cp\u003eさて、この記事のメインは冒頭で触れた Redis::Objects を拡張する gem を作ったよ、という話です。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Fredis-objects-daily-counter\" title=\"GitHub - ryz310/redis-objects-daily-counter: Daily counter within Redis::Objects. Works with any class or ORM.\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/redis-objects-daily-counter\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e発端は Redis::Objects の \u003ccode\u003ecounter\u003c/code\u003e を使ってサービスの効果測定（メール配信数、CV 数、ログイン数など）をしたいなーと考えたことなんですが、効果測定って一定の期間毎に集計して改善した・していないの指標にしたいやつじゃないですか？\n\u003ccode\u003ecounter\u003c/code\u003e でカウントアップしつつ、日次の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D0%A5%C3%A5%C1%BD%E8%CD%FD\"\u003eバッチ処理\u003c/a\u003eで集計すれば良いんですが、それだとあまり気軽じゃないというか、測定対象となるサービス開発の後、測定ロジックと\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D0%A5%C3%A5%C1%BD%E8%CD%FD\"\u003eバッチ処理\u003c/a\u003e、保存先の DB テーブル作成までセットで実装しないと実現できないですよね。\u003c/p\u003e\n\n\u003cp\u003eこれはサクッと実装するには \u003ccode\u003ecounter\u003c/code\u003e が自動で日次で保存先を切り替えてくれれば良さそう、ということで、 \u003ccode\u003eredis-objects-daily-counter\u003c/code\u003e という gem は \u003ccode\u003edaily_counter\u003c/code\u003e という日次で保存先を切り替えるカウンター機能を提供します。\nRedis::Objects を拡張して作ってあるので、使い方はほぼ同じで、対象としたい Class に \u003ccode\u003einclude Redis::Objects\u003c/code\u003e を追加すると使えるようになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# Gemfile\u003c/span\u003e\ngem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eredis-objects-daily-counter\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eHomepage\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003einclude\u003c/span\u003e \u003cspan class=\"synType\"\u003eRedis\u003c/span\u003e::\u003cspan class=\"synType\"\u003eObjects\u003c/span\u003e\n\n  daily_counter \u003cspan class=\"synConstant\"\u003e:pv\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eexpireat\u003c/span\u003e: -\u0026gt; { \u003cspan class=\"synType\"\u003eTime\u003c/span\u003e.now + \u003cspan class=\"synConstant\"\u003e2_678_400\u003c/span\u003e } \u003cspan class=\"synComment\"\u003e# about a month\u003c/span\u003e\n\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eid\u003c/span\u003e\n    \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e# 2021-04-01\u003c/span\u003e\nhomepage = \u003cspan class=\"synType\"\u003eHomepage\u003c/span\u003e.new\nhomepage.id \u003cspan class=\"synComment\"\u003e# 1\u003c/span\u003e\n\nhomepage.pv.increment\nhomepage.pv.increment\nhomepage.pv.increment\nputs homepage.pv.value \u003cspan class=\"synComment\"\u003e# 3\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e# 2021-04-02 (next day)\u003c/span\u003e\nputs homepage.pv.value \u003cspan class=\"synComment\"\u003e# 0\u003c/span\u003e\nhomepage.pv.increment\nhomepage.pv.increment\nputs homepage.pv.value \u003cspan class=\"synComment\"\u003e# 2\u003c/span\u003e\n\nstart_date = \u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e)\nend_date = \u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)\nhomepage.pv.range(start_date, end_date) \u003cspan class=\"synComment\"\u003e# [3, 2]\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003e#increment\u003c/code\u003e \u003ccode\u003e#decrement\u003c/code\u003e は \u003ccode\u003ecounter\u003c/code\u003e と同じ使い勝手です。ただ、日付が変わると自動的に保存先が切り替わります。\nこれは Redis で保存している Key 名が以下のフォーマットになっているためです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003emodel_name:id:field_name:yyyy-mm-dd\u003c/pre\u003e\n\n\n\u003cp\u003e日付が変わった後も過去のレコードは削除されていないので、以下のコードでアクセス出来ます。この使い方は同じく Redis::Objects の \u003ccode\u003elist\u003c/code\u003e と似たような使い勝手になっています。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# 2021-04-01\u003c/span\u003e\nhomepage.pv.increment(\u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e)\n\n\u003cspan class=\"synComment\"\u003e# 2021-04-02 (next day)\u003c/span\u003e\nhomepage.pv.increment(\u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)\n\n\u003cspan class=\"synComment\"\u003e# 2021-04-03 (next day)\u003c/span\u003e\nhomepage.pv.increment(\u003cspan class=\"synConstant\"\u003e5\u003c/span\u003e)\n\nhomepage.pv[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e)] \u003cspan class=\"synComment\"\u003e# =\u0026gt; 3\u003c/span\u003e\nhomepage.pv[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e), \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e] \u003cspan class=\"synComment\"\u003e# =\u0026gt; [3, 2, 5]\u003c/span\u003e\nhomepage.pv[\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e)..\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)] \u003cspan class=\"synComment\"\u003e# =\u0026gt; [3, 2]\u003c/span\u003e\n\nhomepage.pv.delete(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e))\nhomepage.pv.range(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e), \u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e)) \u003cspan class=\"synComment\"\u003e# =\u0026gt; [0, 2, 5]\u003c/span\u003e\nhomepage.pv.at(\u003cspan class=\"synType\"\u003eDate\u003c/span\u003e.new(\u003cspan class=\"synConstant\"\u003e2021\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e4\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e)) \u003cspan class=\"synComment\"\u003e# =\u0026gt; 2\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eこれで測定対象となるサービスを開発した後、 \u003ccode\u003edaily_counter\u003c/code\u003e で測定処理を実装しておくだけで OK。\nこの状態でリリースすればデータは溜まっていくので、週次や月次で集計する\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D0%A5%C3%A5%C1%BD%E8%CD%FD\"\u003eバッチ処理\u003c/a\u003eを後でゆっくり実装すれば良いです。\n\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D0%A5%C3%A5%C1%BD%E8%CD%FD\"\u003eバッチ処理\u003c/a\u003e実装前にサーバー内で \u003ccode\u003e$ bin/rails console\u003c/code\u003e を実行して \u003ccode\u003edaily_counter\u003c/code\u003e の値を確認しながら\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D0%A5%C3%A5%C1%BD%E8%CD%FD\"\u003eバッチ処理\u003c/a\u003eの実装を考える、とかも出来ますね。\n具体的なデータを見ながらの方が開発難易度は下がります。\u003c/p\u003e\n\n\u003cp\u003eちなみにですが、 \u003cstrong\u003e\u003ccode\u003eexpireat\u003c/code\u003e オプションを指定しておくことをオススメします。\u003c/strong\u003e\ngem の仕様上、どんどん Redis 上のメモリを圧迫していくので、一定期間後に自動的に削除するようにしましょう。\u003c/p\u003e\n\n\u003chr /\u003e\n\n\u003cp\u003e\u003ccode\u003edaily_counter\u003c/code\u003e があるなら週次、月次、年次カウンターがあっても良いよね、なんだったら毎時、毎分カウンターもあったって良いじゃないか、という事で \u003ccode\u003ev0.2.0\u003c/code\u003e ではそれらが追加されています。\u003c/p\u003e\n\n\u003cp\u003e毎時・毎分のカウンターは \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e rate limit 機能の実装にも良いかもしれないですね。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eannual_counter\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eRedis is a highly volatile key-\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/value\"\u003evalue\u003c/a\u003e store, so I don't recommend using it.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emonthly_counter\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy-mm\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eweekly_counter\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyyWw\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edaily_counter\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy-mm-dd\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehourly_counter\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy-mm-ddThh\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eminutely_counter\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey format: \u003ccode\u003emodel_name:id:field_name:yyyy-mm-ddThh:mi\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e一応実装はしましたが、 \u003ccode\u003eannual_counter\u003c/code\u003e のように期間の長いカウンターの利用はあまりオススメしません。\nRedis ってふとした拍子にデータが飛んでしまう可能性があるので、あくまでキャッシュ的な位置付けで利用するのが良いと思います。\n\u003ccode\u003edaily_counter\u003c/code\u003e も週次・月次で RDS に集計結果を保存する運用を想定していますので。\u003c/p\u003e\n\n\u003chr /\u003e\n\n\u003cp\u003eというわけで久々のブログ更新では新しく作った \u003ccode\u003eredis-objects-daily-counter\u003c/code\u003e という gem の紹介をさせて頂きました。\nこれから弊社プロダクトでも利用していく予定ですし、色々なサービスでも活用頂けると嬉しいです。\u003c/p\u003e\n","contentSnippet":"半年ぶりくらいに会社の勉強会で発表しました。Redis::Objects という gem を使って RDS にかかっていた IO 負荷を改善した、という話と、 Redis::Objects を拡張する gem を作ったという話（後述）です。github.comRedis を使って DB の負荷を下げる系のお話って 2010 年代にされ尽くした感があって、今更な気もするんですが、一周回って最近聞かない話だなーと思ってます。フロントエンドエンジニアで最近サーバーサイドも触る機会が増えたような方々にウケが良かった感じがありますね。一方で社内のインフラエンジニアからは Redis ってメンテナンスの手間が掛かって評判悪いですね。使うだけなら手軽で楽なんですが、AWS のアップデートでダウンタイムが発生する時に利用者向けにアナウンスしないといけなかったり。ダウンタイムと言っても深夜に数秒〜数分なので影響は少ないと思うんですが、エンタープライズ向けのサービスとかやってるとこの辺は厳しいですね。SRE のエラーバジェットの概念 が日本全体に浸透すればソフトウェア開発の生産性は底上げされるんじゃないかと思うのですが、この辺は時間を掛けて少しずつ啓蒙していくしか無いですね。例えば日本の生活インフラ（電気・水道・ガスとか電車とか）ってめっちゃ高水準なので、ソフトウェアの世界でも100％稼働することが当たり前という価値観になってしまうんじゃないかな、と思うのですが、この辺の価値観は表裏一体というか、当たり前と感じているから高品質になる一方で、生産性は下がってしまうという構図だと思っています。https://www.nic.ad.jp/ja/materials/iw/2017/proceedings/s15/s15-fujisaki.pdfSREの信条 (Google)一応メンテナンスの手間、という点では夏頃に AWS から Amazon MemoryDB for Redis というフルマネージドな Redis が発表されています。東京リージョンは未対応で、書き込み速度が遅くなっていたり、料金も若干高くなっていたりしますが、気になるサービスではありますね。dev.classmethod.jpさて、この記事のメインは冒頭で触れた Redis::Objects を拡張する gem を作ったよ、という話です。github.com発端は Redis::Objects の counter を使ってサービスの効果測定（メール配信数、CV 数、ログイン数など）をしたいなーと考えたことなんですが、効果測定って一定の期間毎に集計して改善した・していないの指標にしたいやつじゃないですか？counter でカウントアップしつつ、日次のバッチ処理で集計すれば良いんですが、それだとあまり気軽じゃないというか、測定対象となるサービス開発の後、測定ロジックとバッチ処理、保存先の DB テーブル作成までセットで実装しないと実現できないですよね。これはサクッと実装するには counter が自動で日次で保存先を切り替えてくれれば良さそう、ということで、 redis-objects-daily-counter という gem は daily_counter という日次で保存先を切り替えるカウンター機能を提供します。Redis::Objects を拡張して作ってあるので、使い方はほぼ同じで、対象としたい Class に include Redis::Objects を追加すると使えるようになります。# Gemfilegem 'redis-objects-daily-counter'class Homepage  include Redis::Objects  daily_counter :pv, expireat: -\u003e { Time.now + 2_678_400 } # about a month  def id    1  endend# 2021-04-01homepage = Homepage.newhomepage.id # 1homepage.pv.incrementhomepage.pv.incrementhomepage.pv.incrementputs homepage.pv.value # 3# 2021-04-02 (next day)puts homepage.pv.value # 0homepage.pv.incrementhomepage.pv.incrementputs homepage.pv.value # 2start_date = Date.new(2021, 4, 1)end_date = Date.new(2021, 4, 2)homepage.pv.range(start_date, end_date) # [3, 2]#increment #decrement は counter と同じ使い勝手です。ただ、日付が変わると自動的に保存先が切り替わります。これは Redis で保存している Key 名が以下のフォーマットになっているためです。model_name:id:field_name:yyyy-mm-dd日付が変わった後も過去のレコードは削除されていないので、以下のコードでアクセス出来ます。この使い方は同じく Redis::Objects の list と似たような使い勝手になっています。# 2021-04-01homepage.pv.increment(3)# 2021-04-02 (next day)homepage.pv.increment(2)# 2021-04-03 (next day)homepage.pv.increment(5)homepage.pv[Date.new(2021, 4, 1)] # =\u003e 3homepage.pv[Date.new(2021, 4, 1), 3] # =\u003e [3, 2, 5]homepage.pv[Date.new(2021, 4, 1)..Date.new(2021, 4, 2)] # =\u003e [3, 2]homepage.pv.delete(Date.new(2021, 4, 1))homepage.pv.range(Date.new(2021, 4, 1), Date.new(2021, 4, 3)) # =\u003e [0, 2, 5]homepage.pv.at(Date.new(2021, 4, 2)) # =\u003e 2これで測定対象となるサービスを開発した後、 daily_counter で測定処理を実装しておくだけで OK。この状態でリリースすればデータは溜まっていくので、週次や月次で集計するバッチ処理を後でゆっくり実装すれば良いです。バッチ処理実装前にサーバー内で $ bin/rails console を実行して daily_counter の値を確認しながらバッチ処理の実装を考える、とかも出来ますね。具体的なデータを見ながらの方が開発難易度は下がります。ちなみにですが、 expireat オプションを指定しておくことをオススメします。gem の仕様上、どんどん Redis 上のメモリを圧迫していくので、一定期間後に自動的に削除するようにしましょう。daily_counter があるなら週次、月次、年次カウンターがあっても良いよね、なんだったら毎時、毎分カウンターもあったって良いじゃないか、という事で v0.2.0 ではそれらが追加されています。毎時・毎分のカウンターは API rate limit 機能の実装にも良いかもしれないですね。annual_counterKey format: model_name:id:field_name:yyyyRedis is a highly volatile key-value store, so I don't recommend using it.monthly_counterKey format: model_name:id:field_name:yyyy-mmweekly_counterKey format: model_name:id:field_name:yyyyWwdaily_counterKey format: model_name:id:field_name:yyyy-mm-ddhourly_counterKey format: model_name:id:field_name:yyyy-mm-ddThhminutely_counterKey format: model_name:id:field_name:yyyy-mm-ddThh:mi一応実装はしましたが、 annual_counter のように期間の長いカウンターの利用はあまりオススメしません。Redis ってふとした拍子にデータが飛んでしまう可能性があるので、あくまでキャッシュ的な位置付けで利用するのが良いと思います。daily_counter も週次・月次で RDS に集計結果を保存する運用を想定していますので。というわけで久々のブログ更新では新しく作った redis-objects-daily-counter という gem の紹介をさせて頂きました。これから弊社プロダクトでも利用していく予定ですし、色々なサービスでも活用頂けると嬉しいです。","link":"https://ryz310.hateblo.jp/entry/2021/09/20/172054","isoDate":"2021-09-20T08:20:54.000Z","dateMiliSeconds":1632126054000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210920/20210920165304.png","authorName":"ryz310"},{"title":"自作の gem の名前を考えるのは難しい","content":"\u003ch2\u003e自作の gem の名前を変えたい。\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e という自作の gem がありまして、\u003ca href=\"https://ryz310.hateblo.jp/search?q=my_api_clien\"\u003eこのブログでは何度も紹介している\u003c/a\u003e んですが、ニッチすぎるのか宣伝が下手すぎるのか、一向に使ってみた、という噂を聞きません (´・ω・｀)\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Fmy_api_client\" title=\"ryz310/my_api_client\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/my_api_client\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eまあ弊社のプロダクトの中ではガッツリ使ってるんで別にそれは良いんですが、もう少しまともな名前にならんのかね、というコメントを頂きます。\nいい機会だしちゃんと良い名前付けようと思って考えました。どうせなら自分が好きなゲームからいい名前付けたいな、と思って『Luida（\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EB%A5%A4%A1%BC%A5%C0\"\u003eルイーダ\u003c/a\u003e）』という名前が浮かびました。\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%C9%A5%E9%A5%AF%A5%A8\"\u003eドラクエ\u003c/a\u003e III のあれです。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"ここはルイーダの店\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20201004/20201004001621.jpg\" alt=\"f:id:ryz310:20201004001621j:plain:w300\" title=\"\" class=\"hatena-fotolife\" style=\"width:300px\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eここは\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EB%A5%A4%A1%BC%A5%C0\"\u003eルイーダ\u003c/a\u003eの店。旅人たちが仲間を求めてあつまる出会いと別れの酒場よ。\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e は \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e Client を簡単に作ったりテストしたりするための gem なので、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%CB%C1%B8%B1%BC%D4\"\u003e冒険者\u003c/a\u003eを登録して一緒に旅する\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EB%A5%A4%A1%BC%A5%C0\"\u003eルイーダ\u003c/a\u003eの店のイメージがピッタリだなーと思ったんですよね。とはいえ gem の名前を変えるのって面倒だしそのうちやろう、って思ってたら半年くらい経っちゃいましたけどね。上の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EB%A5%A4%A1%BC%A5%C0\"\u003eルイーダ\u003c/a\u003eの店の画像ってわざわざ \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/iPhone\"\u003eiPhone\u003c/a\u003e 版の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%C9%A5%E9%A5%AF%A5%A8III\"\u003eドラクエIII\u003c/a\u003e 買ってスクショ撮ったんですが、その日付が 2020/10/04 でした 😇\u003c/p\u003e\n\n\u003cp\u003e多分そのうちやります（フラグ）\u003c/p\u003e\n\n\u003ch2\u003emy_\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/api\"\u003eapi\u003c/a\u003e_client v0.20.0 をリリースしました 🚀\u003c/h2\u003e\n\n\u003cp\u003egem の名前は変わらないけどアップデートはされていく。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Fmy_api_client%2Freleases%2Ftag%2Fv0.20.0\" title=\"Release v0.20.0 (Mar 07, 2021) · ryz310/my_api_client\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/releases/tag/v0.20.0\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e元々 \u003ccode\u003emy_api_client\u003c/code\u003e には \u003ccode\u003e#pageable_get\u003c/code\u003e (alias: \u003ccode\u003e#pget\u003c/code\u003e) というメソッドがあり、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/REST%20API\"\u003eREST API\u003c/a\u003e のレスポンス \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JSON\"\u003eJSON\u003c/a\u003e に含まれる URL を順に辿ってリク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトする \u003ccode\u003eEnumerator\u003c/code\u003e を取得することが出来ます。機能自体は実相してテストもしてあるものの、実際のプロダクトで使う機会がなく長いこと日の目を見なかったんですが、この度ついに弊プロダクトで利用する機会が訪れたのでチームのエンジニアに使ってもらってるんですが、 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/RSpec\"\u003eRSpec\u003c/a\u003e を書く際のスタブ化が特にサポートされていなくてテストしづらい問題がありました。\u003c/p\u003e\n\n\u003cp\u003e今回のアップデートでは、この \u003ccode\u003e#pageable_get\u003c/code\u003e に対応するスタブ化をサポートしています。 \u003ca href=\"https://github.com/ryz310/my_api_client/blob/master/README.jp.md#pageable-option\"\u003e詳しい解説は README.jp.md にも書いた\u003c/a\u003e んですが、せっかくなのでブログにも転記しておきます。まあ文章で説明されても実際に使ってみないとピンと来ないのはわかってますけどね。。。\u003c/p\u003e\n\n\u003chr /\u003e\n\n\u003cp\u003e\u003ccode\u003e#pageable_get\u003c/code\u003e  (\u003ccode\u003e#pget\u003c/code\u003e) を使った実装用に \u003ccode\u003epageable\u003c/code\u003e というオプションが利用できます。\n\u003ccode\u003epageable\u003c/code\u003e に設定する値は \u003ccode\u003eEnumerable\u003c/code\u003e である必要があります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003estub_api_client_all(\n  \u003cspan class=\"synType\"\u003eMyPaginationApiClient\u003c/span\u003e,\n  \u003cspan class=\"synConstant\"\u003epagination\u003c/span\u003e: {\n    \u003cspan class=\"synConstant\"\u003epageable\u003c/span\u003e: [\n      { \u003cspan class=\"synConstant\"\u003epage\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e },\n      { \u003cspan class=\"synConstant\"\u003epage\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e },\n      { \u003cspan class=\"synConstant\"\u003epage\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e },\n    ],\n  }\n)\n\n\u003cspan class=\"synType\"\u003eMyPaginationApiClient\u003c/span\u003e.new.pagination.each \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e |\u003cspan class=\"synIdentifier\"\u003eresponse\u003c/span\u003e|\n  response.page \u003cspan class=\"synComment\"\u003e#=\u0026gt; 1, 2, 3\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eなお、 \u003ccode\u003eEnumerable\u003c/code\u003e の各値にはここまで紹介した \u003ccode\u003eresponse\u003c/code\u003e, \u003ccode\u003eraise\u003c/code\u003e, \u003ccode\u003eProc\u003c/code\u003e など全てのオプションが利用可能です。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003estub_api_client_all(\n  \u003cspan class=\"synType\"\u003eMyPaginationApiClient\u003c/span\u003e,\n  \u003cspan class=\"synConstant\"\u003epagination\u003c/span\u003e: {\n    \u003cspan class=\"synConstant\"\u003epageable\u003c/span\u003e: [\n      { \u003cspan class=\"synConstant\"\u003eresponse\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003epage\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e } },\n      { \u003cspan class=\"synConstant\"\u003epage\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e },\n      -\u0026gt;(params) { { \u003cspan class=\"synConstant\"\u003epage\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003euser_id\u003c/span\u003e: params[\u003cspan class=\"synConstant\"\u003e:user_id\u003c/span\u003e] } },\n      { \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e::\u003cspan class=\"synType\"\u003eIamTeapot\u003c/span\u003e },\n    ],\n  }\n)\n\u003c/pre\u003e\n\n\n\u003cp\u003eまた、 \u003ccode\u003eEnumerator\u003c/code\u003e を使えば無限に続くページネーションを定義することもできます。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003estub_api_client_all(\n  \u003cspan class=\"synType\"\u003eMyPaginationApiClient\u003c/span\u003e,\n  \u003cspan class=\"synConstant\"\u003epagination\u003c/span\u003e: {\n    \u003cspan class=\"synConstant\"\u003epageable\u003c/span\u003e: \u003cspan class=\"synType\"\u003eEnumerator\u003c/span\u003e.new \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e |\u003cspan class=\"synIdentifier\"\u003ey\u003c/span\u003e|\n      \u003cspan class=\"synStatement\"\u003eloop\u003c/span\u003e.with_index(\u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e) \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e |\u003cspan class=\"synIdentifier\"\u003e_\u003c/span\u003e, \u003cspan class=\"synIdentifier\"\u003ei\u003c/span\u003e|\n        y \u0026lt;\u0026lt; { \u003cspan class=\"synConstant\"\u003epage\u003c/span\u003e: i }\n      \u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e,\n  }\n)\n\u003c/pre\u003e\n\n","contentSnippet":"自作の gem の名前を変えたい。my_api_client という自作の gem がありまして、このブログでは何度も紹介している んですが、ニッチすぎるのか宣伝が下手すぎるのか、一向に使ってみた、という噂を聞きません (´・ω・｀)github.comまあ弊社のプロダクトの中ではガッツリ使ってるんで別にそれは良いんですが、もう少しまともな名前にならんのかね、というコメントを頂きます。いい機会だしちゃんと良い名前付けようと思って考えました。どうせなら自分が好きなゲームからいい名前付けたいな、と思って『Luida（ルイーダ）』という名前が浮かびました。ドラクエ III のあれです。ここはルイーダの店。旅人たちが仲間を求めてあつまる出会いと別れの酒場よ。my_api_client は API Client を簡単に作ったりテストしたりするための gem なので、冒険者を登録して一緒に旅するルイーダの店のイメージがピッタリだなーと思ったんですよね。とはいえ gem の名前を変えるのって面倒だしそのうちやろう、って思ってたら半年くらい経っちゃいましたけどね。上のルイーダの店の画像ってわざわざ iPhone 版のドラクエIII 買ってスクショ撮ったんですが、その日付が 2020/10/04 でした 😇多分そのうちやります（フラグ）my_api_client v0.20.0 をリリースしました 🚀gem の名前は変わらないけどアップデートはされていく。github.com元々 my_api_client には #pageable_get (alias: #pget) というメソッドがあり、REST API のレスポンス JSON に含まれる URL を順に辿ってリクエストする Enumerator を取得することが出来ます。機能自体は実相してテストもしてあるものの、実際のプロダクトで使う機会がなく長いこと日の目を見なかったんですが、この度ついに弊プロダクトで利用する機会が訪れたのでチームのエンジニアに使ってもらってるんですが、 RSpec を書く際のスタブ化が特にサポートされていなくてテストしづらい問題がありました。今回のアップデートでは、この #pageable_get に対応するスタブ化をサポートしています。 詳しい解説は README.jp.md にも書いた んですが、せっかくなのでブログにも転記しておきます。まあ文章で説明されても実際に使ってみないとピンと来ないのはわかってますけどね。。。#pageable_get  (#pget) を使った実装用に pageable というオプションが利用できます。pageable に設定する値は Enumerable である必要があります。stub_api_client_all(  MyPaginationApiClient,  pagination: {    pageable: [      { page: 1 },      { page: 2 },      { page: 3 },    ],  })MyPaginationApiClient.new.pagination.each do |response|  response.page #=\u003e 1, 2, 3endなお、 Enumerable の各値にはここまで紹介した response, raise, Proc など全てのオプションが利用可能です。stub_api_client_all(  MyPaginationApiClient,  pagination: {    pageable: [      { response: { page: 1 } },      { page: 2 },      -\u003e(params) { { page: 3, user_id: params[:user_id] } },      { raise: MyApiClient::ClientError::IamTeapot },    ],  })また、 Enumerator を使えば無限に続くページネーションを定義することもできます。stub_api_client_all(  MyPaginationApiClient,  pagination: {    pageable: Enumerator.new do |y|      loop.with_index(1) do |_, i|        y \u003c\u003c { page: i }      end    end,  })","link":"https://ryz310.hateblo.jp/entry/2021/03/07/202519","isoDate":"2021-03-07T11:25:19.000Z","dateMiliSeconds":1615116319000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20201004/20201004001621.jpg","authorName":"ryz310"},{"title":"ActiveJob の retry_on に jitter というオプションがあるの知ってますか？","content":"\u003cp\u003e僕は知らなかったです (・∀・)\u003c/p\u003e\n\n\u003cblockquote class=\"twitter-tweet\"\u003e\u003cp lang=\"ja\" dir=\"ltr\"\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e で ActiveJob の retry_on が同時に発火されるの何とかしたいなーと思って調べてたら、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e 6 からは jitter というオプションが指定できるようになってて、デフォルトでリトライ間隔を 15% ランダマイズしてくれるとの事。Rate Limit の回避とかで便利。 \u003ca href=\"https://t.co/kpIx6YVFEq\"\u003ehttps://t.co/kpIx6YVFEq\u003c/a\u003e\u003c/p\u003e\u0026mdash; サトウリョウスケ (@ryosuke_sato) \u003ca href=\"https://twitter.com/ryosuke_sato/status/1365707024357466115?ref_src=twsrc%5Etfw\"\u003eFebruary 27, 2021\u003c/a\u003e\u003c/blockquote\u003e\n\n\n\u003cp\u003e \u003cscript async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"\u003e\u003c/script\u003e\u003c/p\u003e\n\n\u003ch2\u003ejitter とは\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/rails/rails/blob/5aaaa1630a/activejob/CHANGELOG.md#rails-610-december-09-2020\"\u003eRails 6.1 から追加されたオプション\u003c/a\u003e で、 \u003ccode\u003eretry_on\u003c/code\u003e の待ち時間に対して任意の割合でバラけさせてくれるようになります（デフォルト 15% ）。\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003e\u003ca href=\"https://edgeapi.rubyonrails.org/classes/ActiveJob/Exceptions/ClassMethods.html#method-i-retry_on\"\u003eActiveJob::Exceptions::ClassMethods - retry_on\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003e:jitter\u003c/code\u003e - A random delay of wait time used when calculating backoff. The default is 15% (0.15) which represents the upper bound of possible wait time (expressed as a percentage)\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003ch3\u003e実装を確認してみた\u003c/h3\u003e\n\n\u003cp\u003eこのバラけさせ方が待ち時間に対して増えるのか減るのかが気になって実装を見てみました。増える方向でバラけるようです。\n例えば \u003ccode\u003ewait: 60.seconds\u003c/code\u003e で \u003ccode\u003ejitter: 0.5\u003c/code\u003e の場合だと、最大 \u003ccode\u003e90\u003c/code\u003e 秒の待ち時間となります。\u003c/p\u003e\n\n\u003cp\u003eうっかり \u003ccode\u003e100.0\u003c/code\u003e とか指定すると最大 10000% 待ち時間が加算されちゃいそうです。\n間違えて指定しないようにご注意下さい🙏\u003c/p\u003e\n\n\u003cpre class=\"code rb\" data-lang=\"rb\" data-unlink\u003edelay = seconds_or_duration_or_algorithm.to_i\ndelay_jitter = determine_jitter_for_delay(delay, jitter)\ndelay + delay_jitter\u003c/pre\u003e\n\n\n\u003cp\u003e📝 jitter の計算処理は \u003ca href=\"https://github.com/rails/rails/blob/35e9812dfcb030d4c986532e7672ad8f8f95286f/activejob/lib/active_job/exceptions.rb#L132-L155\"\u003eこのあたり\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003eどういう場面で使うの？\u003c/h3\u003e\n\n\u003cp\u003eこの機能が無かった従来だと、リトライ処理が一斉に起動してしまうという問題がありました。\u003c/p\u003e\n\n\u003cp\u003e例えば外部のサービスに \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトするような Job を作ったとします。\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e Rate Limit 超過の例外をハンドリングして、 \u003ccode\u003eretry_on\u003c/code\u003e で N 分後にリトライするように実装します。\nこの時、 1000 件の Job が同時に実行され 900 件が Rate Limit 超過となった場合、N 分後に 900 件の Job が一斉にリトライされてしまい、再び 800 件がエラーとなってしまう。\nこれが何度も繰り返される、という現象が起こってました。\u003c/p\u003e\n\n\u003ch3\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e 6.1 以前だと回避できないの？\u003c/h3\u003e\n\n\u003cp\u003e従来の ActiveJob でも一応回避策はあって、 \u003ccode\u003ewait\u003c/code\u003e に \u003ccode\u003eProc\u003c/code\u003e を与えてランダムな待ち時間を返すような処理を書くことで似たような動作は可能です。\u003c/p\u003e\n\n\u003cpre class=\"code rb\" data-lang=\"rb\" data-unlink\u003eretry_on SomeError, wait: -\u0026gt; { rand(60..90).seconds }\u003c/pre\u003e\n\n\n\u003ch2\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/iPad\"\u003eiPad\u003c/a\u003e \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Air\"\u003eAir\u003c/a\u003e (第4世代) 買っちゃった\u003c/h2\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"iPad Air (第4世代)\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210302/20210302102542.jpg\" alt=\"f:id:ryz310:20210302102542j:plain\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/iPad\"\u003eiPad\u003c/a\u003e \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Air\"\u003eAir\u003c/a\u003e (第4世代)\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003e近日中に \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/iPad\"\u003eiPad\u003c/a\u003e Pro の新型が出るとの噂があるが、軽い \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Air\"\u003eAir\u003c/a\u003e がほしかったので問題 🍆 （知らなかったけどね）\u003c/p\u003e\n\n\u003cp\u003e🔗 \u003ca href=\"https://iphone-mania.jp/news-350190/\"\u003e新型iPad Pro搭載A14X/A14Zチップの処理能力はM1チップに匹敵か - iPhone Mania\u003c/a\u003e\u003c/p\u003e\n","contentSnippet":"僕は知らなかったです (・∀・)Rails で ActiveJob の retry_on が同時に発火されるの何とかしたいなーと思って調べてたら、Rails 6 からは jitter というオプションが指定できるようになってて、デフォルトでリトライ間隔を 15% ランダマイズしてくれるとの事。Rate Limit の回避とかで便利。 https://t.co/kpIx6YVFEq— サトウリョウスケ (@ryosuke_sato) February 27, 2021 jitter とはRails 6.1 から追加されたオプション で、 retry_on の待ち時間に対して任意の割合でバラけさせてくれるようになります（デフォルト 15% ）。ActiveJob::Exceptions::ClassMethods - retry_on:jitter - A random delay of wait time used when calculating backoff. The default is 15% (0.15) which represents the upper bound of possible wait time (expressed as a percentage)実装を確認してみたこのバラけさせ方が待ち時間に対して増えるのか減るのかが気になって実装を見てみました。増える方向でバラけるようです。例えば wait: 60.seconds で jitter: 0.5 の場合だと、最大 90 秒の待ち時間となります。うっかり 100.0 とか指定すると最大 10000% 待ち時間が加算されちゃいそうです。間違えて指定しないようにご注意下さい🙏delay = seconds_or_duration_or_algorithm.to_idelay_jitter = determine_jitter_for_delay(delay, jitter)delay + delay_jitter📝 jitter の計算処理は このあたりどういう場面で使うの？この機能が無かった従来だと、リトライ処理が一斉に起動してしまうという問題がありました。例えば外部のサービスに API リクエストするような Job を作ったとします。API Rate Limit 超過の例外をハンドリングして、 retry_on で N 分後にリトライするように実装します。この時、 1000 件の Job が同時に実行され 900 件が Rate Limit 超過となった場合、N 分後に 900 件の Job が一斉にリトライされてしまい、再び 800 件がエラーとなってしまう。これが何度も繰り返される、という現象が起こってました。Rails 6.1 以前だと回避できないの？従来の ActiveJob でも一応回避策はあって、 wait に Proc を与えてランダムな待ち時間を返すような処理を書くことで似たような動作は可能です。retry_on SomeError, wait: -\u003e { rand(60..90).seconds }iPad Air (第4世代) 買っちゃったiPad Air (第4世代)近日中に iPad Pro の新型が出るとの噂があるが、軽い Air がほしかったので問題 🍆 （知らなかったけどね）🔗 新型iPad Pro搭載A14X/A14Zチップの処理能力はM1チップに匹敵か - iPhone Mania","link":"https://ryz310.hateblo.jp/entry/2021/03/02/113927","isoDate":"2021-03-02T02:39:27.000Z","dateMiliSeconds":1614652767000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20210302/20210302102542.jpg","authorName":"ryz310"},{"title":"RuboCop で違反してるコードを自動的に修正する PR 作ってくれたら嬉しいやろ。できるでそれ。","content":"\u003cp\u003e久々の更新は Rubocop Challenger の話です。\u003c/p\u003e\n\n\u003cp\u003eこのブログでは触れたこと無かったですが、 \u003ca href=\"https://github.com/ryz310/rubocop_challenger\"\u003eそういう gem\u003c/a\u003e も作ってます。\n自動的に \u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e から  \u003ccode\u003eCop supports --auto-correct.\u003c/code\u003e になってる Cop を拾ってきて PR 作ってくれるやつです。\u003c/p\u003e\n\n\u003cp\u003eちょうど hey 社の CTO の藤村さんが同じ事をやっていてちょっとバズってたんですが、自分の gem 使ってほしかったなーと地味に思ってたりします。自分が世の中に対してアピールが足りてなさすぎましたね 😇\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Ftech.hey.jp%2Fentry%2F2020%2F10%2F23%2F111200\" title=\"たまってしまった .rubocop_todo.yml をGitHub Actionsで継続的かつ自動的に倒す方法 - STORES Tech Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://tech.hey.jp/entry/2020/10/23/111200\"\u003etech.hey.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e何年か前に会社のブログで書いたりはしてたのでリンク貼っておく ✍\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2018%2F12%2F05%2F140000\" title=\"まだ .rubocop_todo.yml で消耗してるの？ - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2018/12/05/140000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003eRubocop Challenger v2.3.0 をリリースしました 🚀\u003c/h2\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Frubocop_challenger%2Freleases%2Ftag%2Fv2.3.0\" title=\"Release v2.3.0 · ryz310/rubocop_challenger\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/rubocop_challenger/releases/tag/v2.3.0\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eとはいえ新機能は一つだけで、 auto-correct された Cop が SafeAutocorrect かどうかを教えてくれる、というものです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ryz310/rubocop_challenger/pull/465\"\u003eAdd description whether the challenge is created by safe autocorrect or not by ryz310 \u0026middot; Pull Request #465 \u0026middot; ryz310/rubocop_challenger \u0026middot; GitHub\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこんな感じの PR が作成されます。（画像は動作確認で作ったものなので、実際の \u003ccode\u003eStyle/Alias\u003c/code\u003e は常に \u003ccode\u003eSafeAutocorrect: true\u003c/code\u003e になります）\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/3985540/108836759-94096800-7614-11eb-8fb9-cb311711e120.png\" alt=\"Add description whether the challenge is created by safe autocorrect or not by ryz310 · Pull Request #465 · ryz310/rubocop_challenger\" /\u003e\n\u003cimg src=\"https://user-images.githubusercontent.com/3985540/108847589-392b3d00-7623-11eb-8c09-e5192edbbd80.png\" alt=\"Add description whether the challenge is created by safe autocorrect or not by ryz310 · Pull Request #465 · ryz310/rubocop_challenger\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eぜひお試し下さい 👍\u003c/p\u003e\n\n\u003ch2\u003eつぎやりたいこと\u003c/h2\u003e\n\n\u003cp\u003e先日 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GitHub\"\u003eGitHub\u003c/a\u003e が auto-merge 機能をリリースしましたね。自分は即全部の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA\"\u003eリポジトリ\u003c/a\u003eで有効化しました ✅\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.blog%2Fchangelog%2F2021-02-04-pull-request-auto-merge-is-now-generally-available%2F\" title=\"Pull request auto-merge is now generally available - GitHub Changelog\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.blog/changelog/2021-02-04-pull-request-auto-merge-is-now-generally-available/\"\u003egithub.blog\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e次やりたい機能としては \u003ccode\u003eSafeAutocorrect: true\u003c/code\u003e  の場合とかは auto-merge を有効化した PR を作るようにしたいんですよね。\u003c/p\u003e\n\n\u003cp\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GitHub\"\u003eGitHub\u003c/a\u003e の GraphQL \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e でこの機能を有効化できるらしいです。\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003eGraphQL APIs will be rolling out later this week. The pull request webhook event also now includes actions that indicate when auto-merge is enabled or disabled.\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eまた時間ある時にでも調べます。\u003c/p\u003e\n","contentSnippet":"久々の更新は Rubocop Challenger の話です。このブログでは触れたこと無かったですが、 そういう gem も作ってます。自動的に .rubocop_todo.yml から  Cop supports --auto-correct. になってる Cop を拾ってきて PR 作ってくれるやつです。ちょうど hey 社の CTO の藤村さんが同じ事をやっていてちょっとバズってたんですが、自分の gem 使ってほしかったなーと地味に思ってたりします。自分が世の中に対してアピールが足りてなさすぎましたね 😇tech.hey.jp何年か前に会社のブログで書いたりはしてたのでリンク貼っておく ✍developer.feedforce.jpRubocop Challenger v2.3.0 をリリースしました 🚀github.comとはいえ新機能は一つだけで、 auto-correct された Cop が SafeAutocorrect かどうかを教えてくれる、というものです。Add description whether the challenge is created by safe autocorrect or not by ryz310 · Pull Request #465 · ryz310/rubocop_challenger · GitHubこんな感じの PR が作成されます。（画像は動作確認で作ったものなので、実際の Style/Alias は常に SafeAutocorrect: true になります）ぜひお試し下さい 👍つぎやりたいこと先日 GitHub が auto-merge 機能をリリースしましたね。自分は即全部のリポジトリで有効化しました ✅github.blog次やりたい機能としては SafeAutocorrect: true  の場合とかは auto-merge を有効化した PR を作るようにしたいんですよね。GitHub の GraphQL API でこの機能を有効化できるらしいです。GraphQL APIs will be rolling out later this week. The pull request webhook event also now includes actions that indicate when auto-merge is enabled or disabled.また時間ある時にでも調べます。","link":"https://ryz310.hateblo.jp/entry/2021/02/23/222720","isoDate":"2021-02-23T13:27:20.000Z","dateMiliSeconds":1614086840000,"imageUrl":"https://user-images.githubusercontent.com/3985540/108836759-94096800-7614-11eb-8fb9-cb311711e120.png","authorName":"ryz310"},{"title":"my_api_client v0.16.0 をリリースしました🚀","content":"\u003cp\u003e前回のリリースから 1 週間ほどですが、今日予定していたライブが\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B3%A5%ED%A5%CA%A5%A6%A5%A4%A5%EB%A5%B9\"\u003eコロナウイルス\u003c/a\u003eの影響で中止になったので暇を持て余しました 😷\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Fmy_api_client%2Freleases%2Ftag%2Fv0.16.0\" title=\"Release v0.16.0 · ryz310/my_api_client\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/releases/tag/v0.16.0\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003ev0.16.0 の新機能\u003c/h2\u003e\n\n\u003cp\u003e2 つありますが、どちらも若干の Breaking Change です。\nとはいえ普通に使っていたら全く影響を受けないと思います。\u003c/p\u003e\n\n\u003ch3\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/pull/225([@ryz310](https://github.com/ryz310\"\u003e新機能 1. エラーハンドラがエラーを検出した際は常に例外を raise するようになりました\u003c/a\u003e\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e では \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JSON\"\u003eJSON\u003c/a\u003e \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e からのレスポンス内容に応じて例外を発生させる \u003ccode\u003eerror_handling\u003c/code\u003e というメソッドが利用できます。\u003c/p\u003e\n\n\u003cp\u003e以下に \u003ccode\u003eerror_handling\u003c/code\u003e を利用した例を示します。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e \u0026lt; \u003cspan class=\"synType\"\u003eApplicationApiClient\u003c/span\u003e\n  endpoint \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ehttps://example.com\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\n  error_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e }\n\n  error_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e20\u003c/span\u003e }, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyErrorClass\u003c/span\u003e\n\n  error_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e30\u003c/span\u003e }, \u003cspan class=\"synConstant\"\u003ewith\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e:my_error_handling\u003c/span\u003e\n\n  error_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e40\u003c/span\u003e } \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e |\u003cspan class=\"synIdentifier\"\u003eparams\u003c/span\u003e, \u003cspan class=\"synIdentifier\"\u003elogger\u003c/span\u003e|\n    \u003cspan class=\"synComment\"\u003e# Do something.\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"synComment\"\u003e# GET error/:code\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003erequest\u003c/span\u003e\n    get \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003epath/to/resouce\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"synStatement\"\u003eprivate\u003c/span\u003e\n\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003emy_error_handling\u003c/span\u003e(params, logger)\n    \u003cspan class=\"synComment\"\u003e# Do something.\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eこの例の場合、 \u003ccode\u003eExampleApiClient#request\u003c/code\u003e を実行すると \u003ccode\u003eGET https://example.com/path/to/resouce\u003c/code\u003e に対してリク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトが実行され、レスポンスボディが \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JSON\"\u003eJSON\u003c/a\u003e 形式だった場合、JSONPath \u003ccode\u003e$.error.code\u003c/code\u003e の値に応じて以下の処理を実行します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e10\u003c/code\u003e だった場合 \u003ccode\u003eMyApiClient::Error\u003c/code\u003e を発生させる\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e20\u003c/code\u003e だった場合 \u003ccode\u003eMyErrorClass\u003c/code\u003e を発生させる\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e30\u003c/code\u003e だった場合 \u003ccode\u003e#my_error_handling\u003c/code\u003e を実行する \u003cstrong\u003e（例外は発生しない）\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e40\u003c/code\u003e だった場合 \u003ccode\u003edo ~ end\u003c/code\u003e を実行する \u003cstrong\u003e（例外は発生しない）\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e\u003ccode\u003eMyApiClient::Error\u003c/code\u003e は \u003ccode\u003eraise\u003c/code\u003e オプションで例外クラスを指定しなかった場合のデフォルトの例外クラスです。\u003c/p\u003e\n\n\u003cp\u003eこの時、従来は \u003ccode\u003e30\u003c/code\u003e と \u003ccode\u003e40\u003c/code\u003e のように \u003ccode\u003ewith\u003c/code\u003e や \u003ccode\u003eblock\u003c/code\u003e を利用した場合は、処理の中で明示的に \u003ccode\u003eraise\u003c/code\u003e を実行しない限り、例外は発生しませんでした。\nエラー検出時に例外を発生させるかどうかは、 \u003ccode\u003emy_api_client\u003c/code\u003e の利用者に委ねられていた形になります。\u003c/p\u003e\n\n\u003cp\u003eしかしながら、ここに自由度を持たせるよりも、 \u003cstrong\u003eエラー検出時には必ず \u003ccode\u003eraise\u003c/code\u003e させて \u003ccode\u003erescue\u003c/code\u003e で異常時の処理を記述する\u003c/strong\u003e 、という方式に統一した方が \u003ccode\u003emy_api_client\u003c/code\u003e の利用方法としても理解しやすく、特に困るケースも想定されなかったことから、以下のように変更することにしました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e10\u003c/code\u003e だった場合 \u003ccode\u003eMyApiClient::Error\u003c/code\u003e を発生させる \u003cstrong\u003e（変更なし）\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e20\u003c/code\u003e だった場合 \u003ccode\u003eMyErrorClass\u003c/code\u003e を発生させる \u003cstrong\u003e（変更なし）\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e30\u003c/code\u003e だった場合 \u003ccode\u003e#my_error_handling\u003c/code\u003e を実行し、 \u003cstrong\u003e\u003ccode\u003eMyApiClient::Error\u003c/code\u003e を発生させる\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e40\u003c/code\u003e だった場合 \u003ccode\u003edo ~ end\u003c/code\u003e を実行し、 \u003cstrong\u003e\u003ccode\u003eMyApiClient::Error\u003c/code\u003e を発生させる\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e今後はエラー検出時には常に何らかの例外が \u003ccode\u003eraise\u003c/code\u003e されるようになります。\n上記の例では \u003ccode\u003eMyApiClient::Error\u003c/code\u003e が発生しますが、 \u003ccode\u003ewith\u003c/code\u003e や \u003ccode\u003eblock\u003c/code\u003e と同時に \u003ccode\u003eraise\u003c/code\u003e を指定すれば、任意の例外クラスが発生するようになります。\u003c/p\u003e\n\n\u003cp\u003eこれにより、 \u003ccode\u003ewith\u003c/code\u003e や \u003ccode\u003eblock\u003c/code\u003e は例外の前処理という位置付けになります。\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%E6%A1%BC%A5%B9%A5%B1%A1%BC%A5%B9\"\u003eユースケース\u003c/a\u003eとしてはログ出力や slack への通知などが考えられます。\u003c/p\u003e\n\n\u003ch3\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/pull/226\"\u003e新機能 2. 標準のエラーハンドラが用意されました\u003c/a\u003e\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e では \u003ca href=\"https://github.com/ryz310/my_api_client/blob/e6e4d2265fc834925d45e023c7d43590f98b7171/README.jp.md#installation\"\u003egenerator 機能\u003c/a\u003e が用意されており、 \u003ccode\u003e$ rails g api_client path/to/resource get:path/to/resource\u003c/code\u003e を実行すると以下のファイルが作成されます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003ecreate  app/api_clients/application_api_client.rb\ncreate  app/api_clients/path/to/resource_api_client.rb\ninvoke  rspec\ncreate    spec/api_clients/path/to/resource_api_client_spec.rb` \u003c/pre\u003e\n\n\n\u003cp\u003eこの時、 \u003ccode\u003eapplication_api_client.rb\u003c/code\u003e に標準のエラーハンドラの例がいくつか記載されるのですが、例というより必須のエラーハンドラだよね、ということで、 \u003ccode\u003emy_api_client\u003c/code\u003e の内部で標準実装するようにしました。\nこれにより、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B9%A5%C6%A1%BC%A5%BF%A5%B9%A5%B3%A1%BC%A5%C9\"\u003eステータスコード\u003c/a\u003e 4xx と 5xx のレスポンスに対しては標準で例外が発生するようなります。また、ネットワーク系のエラーに対しても標準で \u003ccode\u003e300 msec\u003c/code\u003e 間隔を空けて 3 回リトライが試行されるようになります。（リトライ処理も従来は明示的な定義が必須でした）\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# 従来の `application_api_client.rb` に出力されていた標準のエラーハンドラ例\u003c/span\u003e\nerror_handling \u003cspan class=\"synConstant\"\u003estatus_code\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e400\u003c/span\u003e..\u003cspan class=\"synConstant\"\u003e499\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e\nerror_handling \u003cspan class=\"synConstant\"\u003estatus_code\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e500\u003c/span\u003e..\u003cspan class=\"synConstant\"\u003e599\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eServerError\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e# 従来の `application_api_client.rb` に出力されていた標準のリトライ処理例\u003c/span\u003e\nretry_on \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eNetworkError\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003ewait\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e5\u003c/span\u003e.seconds, \u003cspan class=\"synConstant\"\u003eattempts\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e標準で定義されているエラーハンドラは \u003ca href=\"https://github.com/ryz310/my_api_client/blob/e6e4d2265fc834925d45e023c7d43590f98b7171/lib/my_api_client/default_error_handlers.rb\"\u003emy_api_client/default_error_handlers.rb\u003c/a\u003e から参照できます。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eerror_handling\u003c/code\u003e は後から定義した物が優先されますので、例えば\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B9%A5%C6%A1%BC%A5%BF%A5%B9%A5%B3%A1%BC%A5%C9\"\u003eステータスコード\u003c/a\u003e \u003ccode\u003e400\u003c/code\u003e に対しては独自の例外クラスを発生させるようにしたい場合、継承先のクラスで \u003ccode\u003eerror_handling status_code: 400, raise: MyErrorClass\u003c/code\u003e のように定義すれば、 \u003ccode\u003eMyErrorClass\u003c/code\u003e が例外として発生するようになります。\u003c/p\u003e\n\n\u003ch2\u003e所感\u003c/h2\u003e\n\n\u003cp\u003e社内のプロダクト用に作った gem ですが、少しずつ自分以外のエンジニアも利用してくれるようになってきました。\n一方で、自由度が高過ぎると熟知していないと使えない機能が増えてしまう点を課題感として感じるようになってきました。\u003c/p\u003e\n\n\u003cp\u003eなるべく自由度の高い gem を意識しつつ、標準の状態でも高度な機能の恩恵を受けられる状態を目指していきたいと思います。\u003c/p\u003e\n\n\u003cp\u003e恐らく次の新機能は \u003ccode\u003easync/await\u003c/code\u003e っぽい機能、または \u003ccode\u003esawyer\u003c/code\u003e gem の依存からの脱却なると思います。\u003c/p\u003e\n","contentSnippet":"前回のリリースから 1 週間ほどですが、今日予定していたライブがコロナウイルスの影響で中止になったので暇を持て余しました 😷github.comv0.16.0 の新機能2 つありますが、どちらも若干の Breaking Change です。とはいえ普通に使っていたら全く影響を受けないと思います。新機能 1. エラーハンドラがエラーを検出した際は常に例外を raise するようになりましたmy_api_client では JSON API からのレスポンス内容に応じて例外を発生させる error_handling というメソッドが利用できます。以下に error_handling を利用した例を示します。class ExampleApiClient \u003c ApplicationApiClient  endpoint 'https://example.com'  error_handling json: { '$.errors.code': 10 }  error_handling json: { '$.errors.code': 20 }, raise: MyErrorClass  error_handling json: { '$.errors.code': 30 }, with: :my_error_handling  error_handling json: { '$.errors.code': 40 } do |params, logger|    # Do something.  end  # GET error/:code  def request    get 'path/to/resouce'  end  private  def my_error_handling(params, logger)    # Do something.  endendこの例の場合、 ExampleApiClient#request を実行すると GET https://example.com/path/to/resouce に対してリクエストが実行され、レスポンスボディが JSON 形式だった場合、JSONPath $.error.code の値に応じて以下の処理を実行します。10 だった場合 MyApiClient::Error を発生させる20 だった場合 MyErrorClass を発生させる30 だった場合 #my_error_handling を実行する （例外は発生しない）40 だった場合 do ~ end を実行する （例外は発生しない）MyApiClient::Error は raise オプションで例外クラスを指定しなかった場合のデフォルトの例外クラスです。この時、従来は 30 と 40 のように with や block を利用した場合は、処理の中で明示的に raise を実行しない限り、例外は発生しませんでした。エラー検出時に例外を発生させるかどうかは、 my_api_client の利用者に委ねられていた形になります。しかしながら、ここに自由度を持たせるよりも、 エラー検出時には必ず raise させて rescue で異常時の処理を記述する 、という方式に統一した方が my_api_client の利用方法としても理解しやすく、特に困るケースも想定されなかったことから、以下のように変更することにしました。10 だった場合 MyApiClient::Error を発生させる （変更なし）20 だった場合 MyErrorClass を発生させる （変更なし）30 だった場合 #my_error_handling を実行し、 MyApiClient::Error を発生させる40 だった場合 do ~ end を実行し、 MyApiClient::Error を発生させる今後はエラー検出時には常に何らかの例外が raise されるようになります。上記の例では MyApiClient::Error が発生しますが、 with や block と同時に raise を指定すれば、任意の例外クラスが発生するようになります。これにより、 with や block は例外の前処理という位置付けになります。ユースケースとしてはログ出力や slack への通知などが考えられます。新機能 2. 標準のエラーハンドラが用意されましたmy_api_client では generator 機能 が用意されており、 $ rails g api_client path/to/resource get:path/to/resource を実行すると以下のファイルが作成されます。create  app/api_clients/application_api_client.rbcreate  app/api_clients/path/to/resource_api_client.rbinvoke  rspeccreate    spec/api_clients/path/to/resource_api_client_spec.rb` この時、 application_api_client.rb に標準のエラーハンドラの例がいくつか記載されるのですが、例というより必須のエラーハンドラだよね、ということで、 my_api_client の内部で標準実装するようにしました。これにより、ステータスコード 4xx と 5xx のレスポンスに対しては標準で例外が発生するようなります。また、ネットワーク系のエラーに対しても標準で 300 msec 間隔を空けて 3 回リトライが試行されるようになります。（リトライ処理も従来は明示的な定義が必須でした）# 従来の `application_api_client.rb` に出力されていた標準のエラーハンドラ例error_handling status_code: 400..499, raise: MyApiClient::ClientErrorerror_handling status_code: 500..599, raise: MyApiClient::ServerError# 従来の `application_api_client.rb` に出力されていた標準のリトライ処理例retry_on MyApiClient::NetworkError, wait: 5.seconds, attempts: 3標準で定義されているエラーハンドラは my_api_client/default_error_handlers.rb から参照できます。error_handling は後から定義した物が優先されますので、例えばステータスコード 400 に対しては独自の例外クラスを発生させるようにしたい場合、継承先のクラスで error_handling status_code: 400, raise: MyErrorClass のように定義すれば、 MyErrorClass が例外として発生するようになります。所感社内のプロダクト用に作った gem ですが、少しずつ自分以外のエンジニアも利用してくれるようになってきました。一方で、自由度が高過ぎると熟知していないと使えない機能が増えてしまう点を課題感として感じるようになってきました。なるべく自由度の高い gem を意識しつつ、標準の状態でも高度な機能の恩恵を受けられる状態を目指していきたいと思います。恐らく次の新機能は async/await っぽい機能、または sawyer gem の依存からの脱却なると思います。","link":"https://ryz310.hateblo.jp/entry/2020/03/29/220805","isoDate":"2020-03-29T13:08:05.000Z","dateMiliSeconds":1585487285000,"imageUrl":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","authorName":"ryz310"},{"title":"my_api_client v0.15.0 をリリースしました🚀","content":"\u003cp\u003eその前に \u003ccode\u003ev0.14.0\u003c/code\u003e もリリースしているのですが、こちらは\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%EA%A5%D5%A5%A1%A5%AF%A5%BF%A5%EA%A5%F3%A5%B0\"\u003eリファクタリング\u003c/a\u003eと Integration Test の実装だけで新機能はありませんでした。\n差分が \u003ccode\u003e+2,799 -1,246\u003c/code\u003e もあるので中身は結構書き換わっています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/releases/tag/v0.14.0\"\u003eRelease v0.14.0 \u0026middot; ryz310/my_api_client \u0026middot; GitHub\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eIntegration Test では \u003ca href=\"https://rubyonjets.com/\"\u003eRuby on Jets\u003c/a\u003e を使って \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/AWS\"\u003eAWS\u003c/a\u003e Lambda でサーバーを建てて、CI でのテストで \u003ccode\u003emy_api_client\u003c/code\u003e を使って実際に HTTP リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトが成功することを確認しているので、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%C7%A5%B0%A5%EC\"\u003eデグレ\u003c/a\u003eの心配が随分と緩和されました 😌\u003c/p\u003e\n\n\u003ch2\u003e新機能: Pagination \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e のサポート\u003c/h2\u003e\n\n\u003cp\u003eここからは \u003ccode\u003ev0.15.0\u003c/code\u003e の話になります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/releases/tag/v0.15.0\"\u003eRelease v0.15.0 \u0026middot; ryz310/my_api_client \u0026middot; GitHub\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ev0.15.0\u003c/code\u003e のメイン機能が Pagination \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e のサポートになります。\u003ca href=\"https://jsonapi.org/\"\u003eJSON:API\u003c/a\u003e というしっかりとした仕様もあるようですが、 \u003ccode\u003emy_api_client\u003c/code\u003e ではそこまで厳密な仕様に則っている訳ではなく、レスポンスに含まれる URL を認識して enumerable に HTTP リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトを実行する、というざっくりした機能になります。\nレスポンスヘッダの \u003ccode\u003eLink\u003c/code\u003e などで次のページの URL を返すケースもあるようですが、そちらは現時点では未対応です 🙏\u003c/p\u003e\n\n\u003cp\u003ePagination \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e という単語は \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Django\"\u003eDjango\u003c/a\u003e REST Framework の Pagination 機能の説明で出てきます。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.django-rest-framework.org%2Fapi-guide%2Fpagination%2F\" title=\"Pagination - Django REST framework\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://www.django-rest-framework.org/api-guide/pagination/\"\u003ewww.django-rest-framework.org\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e要するに一度のリク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトで結果を全件取得させるのではなく、一定の件数を返却し、続きを取得できる Link を一緒に返却する \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e のことですね。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eRequest:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eGET https://api.example.org/accounts/?page=4\u003c/pre\u003e\n\n\n\u003cp\u003e\u003cstrong\u003eResponse:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cpre class=\"code lang-json\" data-lang=\"json\" data-unlink\u003e\u003cspan class=\"synError\"\u003eHTTP\u003c/span\u003e 200 \u003cspan class=\"synError\"\u003eOK\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e{\u003c/span\u003e\n    \u0026quot;\u003cspan class=\"synStatement\"\u003ecount\u003c/span\u003e\u0026quot;: 1023\n    \u0026quot;\u003cspan class=\"synStatement\"\u003enext\u003c/span\u003e\u0026quot;: \u0026quot;\u003cspan class=\"synConstant\"\u003ehttps://api.example.org/accounts/?page=5\u003c/span\u003e\u0026quot;,\n    \u0026quot;\u003cspan class=\"synStatement\"\u003eprevious\u003c/span\u003e\u0026quot;: \u0026quot;\u003cspan class=\"synConstant\"\u003ehttps://api.example.org/accounts/?page=3\u003c/span\u003e\u0026quot;,\n    \u0026quot;\u003cspan class=\"synStatement\"\u003eresults\u003c/span\u003e\u0026quot;: \u003cspan class=\"synSpecial\"\u003e[\u003c/span\u003e\n       …\n    \u003cspan class=\"synSpecial\"\u003e]\u003c/span\u003e\n\u003cspan class=\"synSpecial\"\u003e}\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch3\u003e使い方\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e での使い方は以下のようになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eMyPaginationApiClient\u003c/span\u003e \u0026lt; \u003cspan class=\"synType\"\u003eApplicationApiClient\u003c/span\u003e\n  endpoint \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ehttps://example.com/v1\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\n  \u003cspan class=\"synComment\"\u003e# GET pagination?page=1\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003epagination\u003c/span\u003e\n    pageable_get \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003epagination\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003epaging\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.links.next\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eheaders\u003c/span\u003e: headers, \u003cspan class=\"synConstant\"\u003equery\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003epage\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e }\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\n  \u003cspan class=\"synStatement\"\u003eprivate\u003c/span\u003e\n\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eheaders\u003c/span\u003e\n    { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eContent-Type\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eapplication/json;charset=UTF-8\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e }\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e通常であれば \u003ccode\u003e#get\u003c/code\u003e を使って HTTP リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトを実行させるのですが、ここでは \u003ccode\u003e#pageable_get\u003c/code\u003e というメソッドを使用しています。 \u003ccode\u003e#pageable_get\u003c/code\u003e だと長いので \u003ccode\u003e#pget\u003c/code\u003e という\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%A4%A5%EA%A5%A2%A5%B9\"\u003eエイリアス\u003c/a\u003eも用意しています。\nまた、 \u003ccode\u003epaging\u003c/code\u003e というキーワード引数も新たに出てきました。 \u003ccode\u003epaging\u003c/code\u003e ではレスポンスのどの部分に次のページの URL が含まれるかを JSONPath expression で指定します。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgoessner.net%2Farticles%2FJsonPath%2Findex.html%23e2\" title=\"JSONPath - XPath for JSON\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://goessner.net/articles/JsonPath/index.html#e2\"\u003egoessner.net\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e以下のような \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JSON\"\u003eJSON\u003c/a\u003e であれば、 \u003ccode\u003e$.links.next\u003c/code\u003e という JSONPath expression は \u003ccode\u003e\"https://example.com/pagination?page=3\"\u003c/code\u003e を取得します。\u003c/p\u003e\n\n\u003cpre class=\"code lang-json\" data-lang=\"json\" data-unlink\u003e\u003cspan class=\"synSpecial\"\u003e{\u003c/span\u003e\n  \u0026quot;\u003cspan class=\"synStatement\"\u003elinks\u003c/span\u003e\u0026quot;: \u003cspan class=\"synSpecial\"\u003e{\u003c/span\u003e\n    \u0026quot;\u003cspan class=\"synStatement\"\u003enext\u003c/span\u003e\u0026quot;: \u0026quot;\u003cspan class=\"synConstant\"\u003ehttps://example.com/pagination?page=3\u003c/span\u003e\u0026quot;,\n    \u0026quot;\u003cspan class=\"synStatement\"\u003eprevious\u003c/span\u003e\u0026quot;: \u0026quot;\u003cspan class=\"synConstant\"\u003ehttps://example.com/pagination?page=1\u003c/span\u003e\u0026quot;\u003cspan class=\"synError\"\u003e,\u003c/span\u003e\n\u003cspan class=\"synError\"\u003e  }\u003c/span\u003e,\n  \u0026quot;\u003cspan class=\"synStatement\"\u003epage\u003c/span\u003e\u0026quot;: \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e\n}\n\u003c/pre\u003e\n\n\n\u003cp\u003e作成した \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e Client は以下のように使用できます。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003eapi_clinet = \u003cspan class=\"synType\"\u003eMyPaginationApiClient\u003c/span\u003e.new\napi_clinet.pagination.each \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e |\u003cspan class=\"synIdentifier\"\u003eresponse\u003c/span\u003e|\n  \u003cspan class=\"synComment\"\u003e# Do something.\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\np = api_clinet.pagination\np.next \u003cspan class=\"synComment\"\u003e# =\u0026gt; 1st page result\u003c/span\u003e\np.next \u003cspan class=\"synComment\"\u003e# =\u0026gt; 2nd page result\u003c/span\u003e\np.next \u003cspan class=\"synComment\"\u003e# =\u0026gt; 3rd page result\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch3\u003e結果は \u003ccode\u003eEnumerator::Lazy\u003c/code\u003e で返却される\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003e#pageable_get\u003c/code\u003e は \u003ccode\u003eEnumerator::Lazy\u003c/code\u003e を返却するので、 \u003ccode\u003eEnumerable\u003c/code\u003e で定義されているメソッドは一通り利用可能です。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdocs.ruby-lang.org%2Fja%2Flatest%2Fclass%2FEnumerator%3D3a%3D3aLazy.html\" title=\"class Enumerator::Lazy (Ruby 2.7.0 リファレンスマニュアル)\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://docs.ruby-lang.org/ja/latest/class/Enumerator=3a=3aLazy.html\"\u003edocs.ruby-lang.org\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eEnumerator\u003c/code\u003e で返してしまうと \u003ccode\u003e#take\u003c/code\u003e で 100 ページ目まで結果を取得するような処理を記述したときに、\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e100 ページ分の HTTP リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトを実行\u003c/li\u003e\n\u003cli\u003e結果を \u003ccode\u003e#each\u003c/code\u003e で回す\u003c/li\u003e\n\u003c/ol\u003e\n\n\n\u003cp\u003eという動きになり、 100 回分の HTTP リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトが完了するまで次の処理に移ることができません。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eEnumerator::Lazy\u003c/code\u003e であれば、\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e1 ページ目の HTTP リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトを実行\u003c/li\u003e\n\u003cli\u003e結果を処理する\u003c/li\u003e\n\u003cli\u003e2ページ目の HTTP リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトを実行\u003c/li\u003e\n\u003cli\u003e結果を処理する\u003c/li\u003e\n\u003cli\u003e...\u003c/li\u003e\n\u003c/ol\u003e\n\n\n\u003cp\u003eという動きになってくれます。便利ですね ✨\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eEnumerator\u003c/code\u003e と \u003ccode\u003eEnumerator::Lazy\u003c/code\u003e の違いは以下の記事が参考になると思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fgam0022%2Fitems%2F8acfc0c674b96060c03f\" title=\"EnumeratorとEnumerator::Lazyの違い - Qiita\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://qiita.com/gam0022/items/8acfc0c674b96060c03f\"\u003eqiita.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n","contentSnippet":"その前に v0.14.0 もリリースしているのですが、こちらはリファクタリングと Integration Test の実装だけで新機能はありませんでした。差分が +2,799 -1,246 もあるので中身は結構書き換わっています。Release v0.14.0 · ryz310/my_api_client · GitHubIntegration Test では Ruby on Jets を使って AWS Lambda でサーバーを建てて、CI でのテストで my_api_client を使って実際に HTTP リクエストが成功することを確認しているので、デグレの心配が随分と緩和されました 😌新機能: Pagination API のサポートここからは v0.15.0 の話になります。Release v0.15.0 · ryz310/my_api_client · GitHubv0.15.0 のメイン機能が Pagination API のサポートになります。JSON:API というしっかりとした仕様もあるようですが、 my_api_client ではそこまで厳密な仕様に則っている訳ではなく、レスポンスに含まれる URL を認識して enumerable に HTTP リクエストを実行する、というざっくりした機能になります。レスポンスヘッダの Link などで次のページの URL を返すケースもあるようですが、そちらは現時点では未対応です 🙏Pagination API という単語は Django REST Framework の Pagination 機能の説明で出てきます。www.django-rest-framework.org要するに一度のリクエストで結果を全件取得させるのではなく、一定の件数を返却し、続きを取得できる Link を一緒に返却する API のことですね。Request:GET https://api.example.org/accounts/?page=4Response:HTTP 200 OK{    \"count\": 1023    \"next\": \"https://api.example.org/accounts/?page=5\",    \"previous\": \"https://api.example.org/accounts/?page=3\",    \"results\": [       …    ]}使い方my_api_client での使い方は以下のようになります。class MyPaginationApiClient \u003c ApplicationApiClient  endpoint 'https://example.com/v1'  # GET pagination?page=1  def pagination    pageable_get 'pagination', paging: '$.links.next', headers: headers, query: { page: 1 }  end  private  def headers    { 'Content-Type': 'application/json;charset=UTF-8' }  endend通常であれば #get を使って HTTP リクエストを実行させるのですが、ここでは #pageable_get というメソッドを使用しています。 #pageable_get だと長いので #pget というエイリアスも用意しています。また、 paging というキーワード引数も新たに出てきました。 paging ではレスポンスのどの部分に次のページの URL が含まれるかを JSONPath expression で指定します。goessner.net以下のような JSON であれば、 $.links.next という JSONPath expression は \"https://example.com/pagination?page=3\" を取得します。{  \"links\": {    \"next\": \"https://example.com/pagination?page=3\",    \"previous\": \"https://example.com/pagination?page=1\",  },  \"page\": 2}作成した API Client は以下のように使用できます。api_clinet = MyPaginationApiClient.newapi_clinet.pagination.each do |response|  # Do something.endp = api_clinet.paginationp.next # =\u003e 1st page resultp.next # =\u003e 2nd page resultp.next # =\u003e 3rd page result結果は Enumerator::Lazy で返却される#pageable_get は Enumerator::Lazy を返却するので、 Enumerable で定義されているメソッドは一通り利用可能です。docs.ruby-lang.orgEnumerator で返してしまうと #take で 100 ページ目まで結果を取得するような処理を記述したときに、100 ページ分の HTTP リクエストを実行結果を #each で回すという動きになり、 100 回分の HTTP リクエストが完了するまで次の処理に移ることができません。Enumerator::Lazy であれば、1 ページ目の HTTP リクエストを実行結果を処理する2ページ目の HTTP リクエストを実行結果を処理する...という動きになってくれます。便利ですね ✨Enumerator と Enumerator::Lazy の違いは以下の記事が参考になると思います。qiita.com","link":"https://ryz310.hateblo.jp/entry/2020/03/21/163849","isoDate":"2020-03-21T07:38:49.000Z","dateMiliSeconds":1584776329000,"imageUrl":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","authorName":"ryz310"},{"title":"駆け込みで Chrome 80 の SameSite=None; Secure の対応をやった🍪","content":"\u003cp\u003eご存知の方も多いかと思いますが、 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\"\u003eChrome\u003c/a\u003e 80 から 3rd Party \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e の取り扱いが厳しくなり、特に指定がないと外部サイトの \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e は \u003cstrong\u003ePOST・iframe・XHR 等のリク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eト\u003c/strong\u003e  で送られなくなります。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdevelopers-jp.googleblog.com%2F2019%2F11%2Fcookie-samesitenone-secure.html\" title=\"新しい Cookie 設定 SameSite=None; Secure の準備を始めましょう\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developers-jp.googleblog.com/2019/11/cookie-samesitenone-secure.html\"\u003edevelopers-jp.googleblog.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003e2 月の \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\"\u003eChrome\u003c/a\u003e 80 以降、SameSite 値が宣言されていない \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e は SameSite=Lax として扱われます。外部アクセスは、SameSite=None; Secure 設定のある \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e のみ可能になります。ただし、これらが安全な接続からアクセスされることが条件です。\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eとはいえ完全に無効になるわけではなく、 \u003ccode\u003eSameSite\u003c/code\u003e という属性が宣言されていない \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e は \u003ccode\u003eLax\u003c/code\u003e という区分がデフォルトで適用されるという物なので、サーバーから返す \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e に対して明示的に \u003ccode\u003eSameSite\u003c/code\u003e を \u003ccode\u003eNone\u003c/code\u003e に指定して、かつ \u003ccode\u003eSecure\u003c/code\u003e という属性を付与すれば、従来どおり \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e が送信されます。\u003c/p\u003e\n\n\u003cp\u003e去年の秋くらいにもこの \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e の対応が必要かどうか、会社で調査していたんですが、その時点では影響を受ける箇所が無くて、特に何も対応せずにスルーしていたんですが、現在開発してる新機能が\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A4%BF%A4%DE%A4%BF%A4%DE%A4%B3\"\u003eたまたまこ\u003c/a\u003eの影響を受ける機能だったため、急遽対応することになりました。\u003c/p\u003e\n\n\u003cp\u003e結構厳しいな、と思ったのは、これが原因で動かないことに気付くのが結構難しいんですよね。\n\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B7%A5%F3%A5%B0%A5%EB%A5%B5%A5%A4%A5%F3%A5%AA%A5%F3\"\u003eシングルサインオン\u003c/a\u003eみたいな機能を作ってると\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3\"\u003eドメイン\u003c/a\u003eが異なるので 3rd Party \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e の扱いになります。\nそして \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e に入っているはずの Session ID が送られてこないので、サーバー側で Session が見つからずにエラー。\u003c/p\u003e\n\n\u003cp\u003e自分の手元の \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\"\u003eChrome\u003c/a\u003e は 79 で、まだ上記の制限が入っていなかったんですが、以前影響範囲を調査した時に \u003ccode\u003echrome://flags\u003c/code\u003e から有効にするフラグを ON にしていたので、他のエンジニアの環境では動作するけど、自分だけ動かないということになり、もしかして、と思って気付いた感じです。\u003c/p\u003e\n\n\u003cp\u003eリリース後に気付いてたらヤバかったですね。。\u003c/p\u003e\n\n\u003cp\u003eで、こういう問題は \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e みたいな\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D5%A5%EC%A1%BC%A5%E0%A5%EF%A1%BC%A5%AF\"\u003eフレームワーク\u003c/a\u003eで対応してくれよって気持ちになるんですが、ちゃんと対応する PR は作られていて、すでに merge もされています。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Frails%2Frails%2Fpull%2F28297\" title=\"Add SameSite to Cookies by cfabianski · Pull Request #28297 · rails/rails\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/rails/rails/pull/28297\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eですが、 2020/2/20 現在、これを反映した \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e はまだリリースされていないみたいですね。（最新が 2019/12/19 にリリースされた \u003ccode\u003e6.0.2.1\u003c/code\u003e ）\nまた、 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e 5.2 に反映されるかどうかは微妙な感じになっています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/rails/rails/pull/28297#issuecomment-577414543\"\u003ehttps://github.com/rails/rails/pull/28297#issuecomment-577414543\u003c/a\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003eWe will backport to 6.0 as a bug fix, but I don't know this warrants a backport to a security only release like 5.2. \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e 6.0 was released 6 months ago, and upgrading applications could be high, high priority if that problem is so important.\u003c/p\u003e\n\n\u003cp\u003eバグ修正として6.0にバックポートしますが、これが5.2のようなセキュリティのみのリリースへのバックポートを保証するかどうかわかりません。 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e 6.0は6か月前にリリースされました。その問題が非常に重要な場合、アプリケーションのアップグレードは優先度が高くなる可能性があります。\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003e自分の開発環境は恥ずかしながら \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Rails\"\u003eRails\u003c/a\u003e 4.2 （今年中にアップデートします！）なので、当然反映されるはずもないので、自前で Rack を作成して対応しました。\n参考まで以下のようなコードになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# config/initializers/custom_rack_middleware.rb\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e# \u003c/span\u003e\u003cspan class=\"synTodo\"\u003eNOTE\u003c/span\u003e\u003cspan class=\"synComment\"\u003e: Rails 6.0.x であれば以下の処理は不要となる。\u003c/span\u003e\n\u003cspan class=\"synType\"\u003eRails\u003c/span\u003e.application.config.middleware.insert_before(\n  \u003cspan class=\"synType\"\u003eActionDispatch\u003c/span\u003e::\u003cspan class=\"synType\"\u003eCookies\u003c/span\u003e,\n  \u003cspan class=\"synType\"\u003eCustomRackMiddleware\u003c/span\u003e::\u003cspan class=\"synType\"\u003eSetSameSiteOptionOnCookie\u003c/span\u003e\n)\n\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# lib/custom_rack_middleware/set_same_site_option_on_cookie.rb\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e# \u003c/span\u003e\u003cspan class=\"synTodo\"\u003eTODO\u003c/span\u003e\u003cspan class=\"synComment\"\u003e: Rails 6.0.x にアップデートしたら削除する\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003emodule\u003c/span\u003e \u003cspan class=\"synType\"\u003eCustomRackMiddleware\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eSetSameSiteOptionOnCookie\u003c/span\u003e\n    \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003einitialize\u003c/span\u003e(app)\n      \u003cspan class=\"synIdentifier\"\u003e@app\u003c/span\u003e = app\n    \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\n    \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003ecall\u003c/span\u003e(env)\n      status, headers, body = \u003cspan class=\"synIdentifier\"\u003e@app\u003c/span\u003e.call(env)\n\n      cookies = headers[\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eSet-Cookie\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e]\n      \u003cspan class=\"synStatement\"\u003eif\u003c/span\u003e cookies.present?\n        processed_cookies = cookies.split(\u003cspan class=\"synSpecial\"\u003e\u0026quot;\\n\u0026quot;\u003c/span\u003e).map \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e |\u003cspan class=\"synIdentifier\"\u003ecookie\u003c/span\u003e|\n          \u003cspan class=\"synSpecial\"\u003e\u0026quot;#{\u003c/span\u003ecookie\u003cspan class=\"synSpecial\"\u003e}\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e; SameSite=None; Secure\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e\u0026quot;\u003c/span\u003e\n        \u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n        headers[\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eSet-Cookie\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e] = processed_cookies.join(\u003cspan class=\"synSpecial\"\u003e\u0026quot;\\n\u0026quot;\u003c/span\u003e)\n      \u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\n      [status, headers, body]\n    \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003cstrong\u003e2020/02/22 追記\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eローカルの開発環境など HTTP リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトをする環境だと、 \u003ccode\u003eSameSite=None\u003c/code\u003e の設定を入れると \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\"\u003eCookie\u003c/a\u003e が送られなくなるようです。\u003c/p\u003e\n\n\u003cp\u003eローカルでは上述の Rack を読み込ませないようにするなどの工夫が必要だと思います。\u003c/p\u003e\n","contentSnippet":"ご存知の方も多いかと思いますが、 Chrome 80 から 3rd Party Cookie の取り扱いが厳しくなり、特に指定がないと外部サイトの Cookie は POST・iframe・XHR 等のリクエスト  で送られなくなります。developers-jp.googleblog.com2 月の Chrome 80 以降、SameSite 値が宣言されていない Cookie は SameSite=Lax として扱われます。外部アクセスは、SameSite=None; Secure 設定のある Cookie のみ可能になります。ただし、これらが安全な接続からアクセスされることが条件です。とはいえ完全に無効になるわけではなく、 SameSite という属性が宣言されていない Cookie は Lax という区分がデフォルトで適用されるという物なので、サーバーから返す Cookie に対して明示的に SameSite を None に指定して、かつ Secure という属性を付与すれば、従来どおり Cookie が送信されます。去年の秋くらいにもこの Cookie の対応が必要かどうか、会社で調査していたんですが、その時点では影響を受ける箇所が無くて、特に何も対応せずにスルーしていたんですが、現在開発してる新機能がたまたまこの影響を受ける機能だったため、急遽対応することになりました。結構厳しいな、と思ったのは、これが原因で動かないことに気付くのが結構難しいんですよね。シングルサインオンみたいな機能を作ってるとドメインが異なるので 3rd Party Cookie の扱いになります。そして Cookie に入っているはずの Session ID が送られてこないので、サーバー側で Session が見つからずにエラー。自分の手元の Chrome は 79 で、まだ上記の制限が入っていなかったんですが、以前影響範囲を調査した時に chrome://flags から有効にするフラグを ON にしていたので、他のエンジニアの環境では動作するけど、自分だけ動かないということになり、もしかして、と思って気付いた感じです。リリース後に気付いてたらヤバかったですね。。で、こういう問題は Rails みたいなフレームワークで対応してくれよって気持ちになるんですが、ちゃんと対応する PR は作られていて、すでに merge もされています。github.comですが、 2020/2/20 現在、これを反映した Rails はまだリリースされていないみたいですね。（最新が 2019/12/19 にリリースされた 6.0.2.1 ）また、 Rails 5.2 に反映されるかどうかは微妙な感じになっています。https://github.com/rails/rails/pull/28297#issuecomment-577414543We will backport to 6.0 as a bug fix, but I don't know this warrants a backport to a security only release like 5.2. Rails 6.0 was released 6 months ago, and upgrading applications could be high, high priority if that problem is so important.バグ修正として6.0にバックポートしますが、これが5.2のようなセキュリティのみのリリースへのバックポートを保証するかどうかわかりません。 Rails 6.0は6か月前にリリースされました。その問題が非常に重要な場合、アプリケーションのアップグレードは優先度が高くなる可能性があります。自分の開発環境は恥ずかしながら Rails 4.2 （今年中にアップデートします！）なので、当然反映されるはずもないので、自前で Rack を作成して対応しました。参考まで以下のようなコードになります。# config/initializers/custom_rack_middleware.rb# NOTE: Rails 6.0.x であれば以下の処理は不要となる。Rails.application.config.middleware.insert_before(  ActionDispatch::Cookies,  CustomRackMiddleware::SetSameSiteOptionOnCookie)# lib/custom_rack_middleware/set_same_site_option_on_cookie.rb# TODO: Rails 6.0.x にアップデートしたら削除するmodule CustomRackMiddleware  class SetSameSiteOptionOnCookie    def initialize(app)      @app = app    end    def call(env)      status, headers, body = @app.call(env)      cookies = headers['Set-Cookie']      if cookies.present?        processed_cookies = cookies.split(\"\\n\").map do |cookie|          \"#{cookie}; SameSite=None; Secure\"        end        headers['Set-Cookie'] = processed_cookies.join(\"\\n\")      end      [status, headers, body]    end  endend2020/02/22 追記ローカルの開発環境など HTTP リクエストをする環境だと、 SameSite=None の設定を入れると Cookie が送られなくなるようです。ローカルでは上述の Rack を読み込ませないようにするなどの工夫が必要だと思います。","link":"https://ryz310.hateblo.jp/entry/2020/02/20/235548","isoDate":"2020-02-20T14:55:48.000Z","dateMiliSeconds":1582210548000,"imageUrl":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","authorName":"ryz310"},{"title":"my_api_client v0.13.0 をリリースしました🚀","content":"\u003cp\u003e\u003ca href=\"https://ryz310.hateblo.jp/entry/2020/01/19/152826\"\u003eつい先日、v0.12.0 をリリースしたばかり\u003c/a\u003e ですが、 v0.13.0 をリリースしましたので、含まれる PR の内容について解説していきます。 より詳しい使い方は \u003ca href=\"https://github.com/ryz310/my_api_client/blob/master/README.jp.md\"\u003eREADME.jp.md\u003c/a\u003e をご参照ください。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Fmy_api_client%2Fblob%2Fmaster%2FCHANGELOG.md%23v0130-jan-21-2020\" title=\"ryz310/my_api_client\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/blob/master/CHANGELOG.md#v0130-jan-21-2020\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/pull/180\"\u003e#180\u003c/a\u003e Stub response on raising error (\u003ca href=\"https://github.com/ryz310\"\u003e@ryz310\u003c/a\u003e)\u003c/h2\u003e\n\n\u003cp\u003e今回はこの PR のみの更新です。\n仕事で spec 書いてる最中に「\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトで例外が発生した際にレスポンス内容を保存する処理のスタブ化できないじゃん」ってなって作りました。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e では作成した \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e Client クラスを \u003ccode\u003estub_api_client\u003c/code\u003e または \u003ccode\u003estub_api_client_all\u003c/code\u003e というメソッドでスタブ化できます。\n例えば以下のような \u003ccode\u003eExampleApiClient\u003c/code\u003e というクラスを定義した時:\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e \u0026lt; \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eBase\u003c/span\u003e\n  endpoint \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ehttps://example.com\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\n  error_handling \u003cspan class=\"synConstant\"\u003estatus_code\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e400\u003c/span\u003e..\u003cspan class=\"synConstant\"\u003e499\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e\n  error_handling \u003cspan class=\"synConstant\"\u003estatus_code\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e500\u003c/span\u003e..\u003cspan class=\"synConstant\"\u003e599\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eServerError\u003c/span\u003e\n\n  \u003cspan class=\"synComment\"\u003e# GET https://example.com/path/to/resouce\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003erequest\u003c/span\u003e\n     get \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003epath/to/resouce\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003estub_api_client_all\u003c/code\u003e を実行すると \u003ccode\u003eExampleApiClient\u003c/code\u003e の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9\"\u003eインスタンス\u003c/a\u003eが全てスタブ化されるようになります。\n以下の例だと、 \u003ccode\u003e#request\u003c/code\u003e を実行した時、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e から \u003ccode\u003e{ \"message\": \"Hello world!\" }\u003c/code\u003e という \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JSON\"\u003eJSON\u003c/a\u003e が返ってきた時と同じ振る舞いをするようになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003estub_api_client_all(\n  \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e,\n  \u003cspan class=\"synConstant\"\u003erequest\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003eresponse\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003emessage\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eHello world!\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e } }\n)\n\napi_client = \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e.new\nresponse = api_client.request\nresponse.message \u003cspan class=\"synComment\"\u003e# =\u0026gt; 'Hello world!'\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eで、 \u003ccode\u003eerror_handling\u003c/code\u003e で\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B9%A5%C6%A1%BC%A5%BF%A5%B9%A5%B3%A1%BC%A5%C9\"\u003eステータスコード\u003c/a\u003eが \u003ccode\u003e400..499\u003c/code\u003e の時は \u003ccode\u003eMyApiClient::ClientError\u003c/code\u003e という例外が発生する、という定義になっているのですが、このような例外が発生した時のテストを書くために、 \u003ccode\u003eraise\u003c/code\u003e のスタブ化も出来るようになっています。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003estub_api_client_all(\n  \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e,\n  \u003cspan class=\"synConstant\"\u003erequest\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e }\n)\n\n\u003cspan class=\"synStatement\"\u003ebegin\u003c/span\u003e\n  api_client = \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e.new\n  response = api_client.request\n\u003cspan class=\"synStatement\"\u003erescue\u003c/span\u003e \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e\n  puts \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e4xx error!\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e大抵の場合、これらのスタブ化ができれば問題ないのですが、例外発生時のレスポンスを見たい、というケースも無くはないかと思います。\n仕様として、例外\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9\"\u003eインスタンス\u003c/a\u003eの \u003ccode\u003e#params\u003c/code\u003e や \u003ccode\u003e#matadata\u003c/code\u003e というメソッドからリク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトパラメータとレスポンスパラメータを参照できるようになっています。\u003c/p\u003e\n\n\u003cp\u003e従来のスタブ化メソッドでも一応指定できなくはなかったんですが、結構手間だったので \u003ccode\u003eraise\u003c/code\u003e オプションの指定を以下のように拡張しました。\n\u003ccode\u003eraise\u003c/code\u003e と一緒に指定した \u003ccode\u003eresponse\u003c/code\u003e が \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e のレスポンスとして返されて、それが例外として処理された、というスタブ化になります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003estub_api_client_all(\n  \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e,\n  \u003cspan class=\"synConstant\"\u003erequest\u003c/span\u003e: { \n    \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e,\n    \u003cspan class=\"synConstant\"\u003eresponse\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003eerror_code\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e }\n  }\n)\n\n\u003cspan class=\"synStatement\"\u003ebegin\u003c/span\u003e\n  api_client = \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e.new\n  response = api_client.request\n\u003cspan class=\"synStatement\"\u003erescue\u003c/span\u003e \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e =\u0026gt; e\n  e.params.response.data.error_code \u003cspan class=\"synComment\"\u003e#=\u0026gt; 10\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e は内部で \u003ca href=\"https://github.com/lostisland/sawyer\"\u003eSawyer\u003c/a\u003e を使っています。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Flostisland%2Fsawyer\" title=\"lostisland/sawyer\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/lostisland/sawyer\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ee.params.response\u003c/code\u003e が \u003ccode\u003eSawyer::Response\u003c/code\u003e をそのまま返しているので、\u003ccode\u003eSawyer::Response#data\u003c/code\u003e からレスポンスボディを参照できます。\n\u003ccode\u003eSawyer::Response#data\u003c/code\u003e では、レスポンスの \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JSON\"\u003eJSON\u003c/a\u003e を \u003ca href=\"https://docs.ruby-lang.org/ja/latest/class/OpenStruct.html\"\u003eOpenStruct)\u003c/a\u003e のようにメソッドアクセスできるように変換してくれます。\u003c/p\u003e\n\n\u003cp\u003eただし、 \u003ccode\u003eV1.0.0\u003c/code\u003e で \u003ccode\u003eSawyer\u003c/code\u003e の依存を無くしたいと考えているので、いずれ \u003ccode\u003e#data\u003c/code\u003e を挟む書き方は変更になるかもしれません。\n一応こういう使い方もできますよ、という新機能でした。\u003c/p\u003e\n","contentSnippet":"つい先日、v0.12.0 をリリースしたばかり ですが、 v0.13.0 をリリースしましたので、含まれる PR の内容について解説していきます。 より詳しい使い方は README.jp.md をご参照ください。github.com#180 Stub response on raising error (@ryz310)今回はこの PR のみの更新です。仕事で spec 書いてる最中に「API リクエストで例外が発生した際にレスポンス内容を保存する処理のスタブ化できないじゃん」ってなって作りました。my_api_client では作成した API Client クラスを stub_api_client または stub_api_client_all というメソッドでスタブ化できます。例えば以下のような ExampleApiClient というクラスを定義した時:class ExampleApiClient \u003c MyApiClient::Base  endpoint 'https://example.com'  error_handling status_code: 400..499, raise: MyApiClient::ClientError  error_handling status_code: 500..599, raise: MyApiClient::ServerError  # GET https://example.com/path/to/resouce  def request     get 'path/to/resouce'  endendstub_api_client_all を実行すると ExampleApiClient のインスタンスが全てスタブ化されるようになります。以下の例だと、 #request を実行した時、API から { \"message\": \"Hello world!\" } という JSON が返ってきた時と同じ振る舞いをするようになります。stub_api_client_all(  ExampleApiClient,  request: { response: { message: 'Hello world!' } })api_client = ExampleApiClient.newresponse = api_client.requestresponse.message # =\u003e 'Hello world!'で、 error_handling でステータスコードが 400..499 の時は MyApiClient::ClientError という例外が発生する、という定義になっているのですが、このような例外が発生した時のテストを書くために、 raise のスタブ化も出来るようになっています。stub_api_client_all(  ExampleApiClient,  request: { raise: MyApiClient::ClientError })begin  api_client = ExampleApiClient.new  response = api_client.requestrescue MyApiClient::ClientError  puts '4xx error!'end大抵の場合、これらのスタブ化ができれば問題ないのですが、例外発生時のレスポンスを見たい、というケースも無くはないかと思います。仕様として、例外インスタンスの #params や #matadata というメソッドからリクエストパラメータとレスポンスパラメータを参照できるようになっています。従来のスタブ化メソッドでも一応指定できなくはなかったんですが、結構手間だったので raise オプションの指定を以下のように拡張しました。raise と一緒に指定した response が API のレスポンスとして返されて、それが例外として処理された、というスタブ化になります。stub_api_client_all(  ExampleApiClient,  request: {     raise: MyApiClient::ClientError,    response: { error_code: 10 }  })begin  api_client = ExampleApiClient.new  response = api_client.requestrescue MyApiClient::ClientError =\u003e e  e.params.response.data.error_code #=\u003e 10endmy_api_client は内部で Sawyer を使っています。github.come.params.response が Sawyer::Response をそのまま返しているので、Sawyer::Response#data からレスポンスボディを参照できます。Sawyer::Response#data では、レスポンスの JSON を OpenStruct) のようにメソッドアクセスできるように変換してくれます。ただし、 V1.0.0 で Sawyer の依存を無くしたいと考えているので、いずれ #data を挟む書き方は変更になるかもしれません。一応こういう使い方もできますよ、という新機能でした。","link":"https://ryz310.hateblo.jp/entry/2020/01/21/230012","isoDate":"2020-01-21T14:00:12.000Z","dateMiliSeconds":1579615212000,"imageUrl":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","authorName":"ryz310"},{"title":"my_api_client v0.12.0 をリリースしました🚀","content":"\u003cp\u003e\u003ca href=\"https://github.com/ryz310/my_api_client\"\u003emy_api_client v0.12.0\u003c/a\u003e に含まれる PR の内容について解説していきます。\nより詳しい使い方は \u003ca href=\"https://github.com/ryz310/my_api_client/blob/master/README.jp.md\"\u003eREADME.jp.md\u003c/a\u003e をご参照ください。\u003c/p\u003e\n\n\u003ch2\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/pull/173\"\u003e#173\u003c/a\u003e Avoid sleep on testing\u003c/h2\u003e\n\n\u003cp\u003emy_\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/api\"\u003eapi\u003c/a\u003e_client では以下のように書くと、任意の例外を補足して自動的に \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e リク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトをリトライしてくれます。\nネットワーク系のエラーとか、 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e Rate Limit に引っかかった時とかに便利なやつですね。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://edgeapi.rubyonrails.org/classes/ActiveJob/Exceptions/ClassMethods.html#method-i-retry_on\"\u003eActiveJob の \u003ccode\u003eretry_on\u003c/code\u003e\u003c/a\u003e とほぼ同じ使い方になっています。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e \u0026lt; \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eBase\u003c/span\u003e\n  endpoint \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ehttps://example.com\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\n  retry_on \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003ewait\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e.minute, \u003cspan class=\"synConstant\"\u003eattempts\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e\n  error_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e20\u003c/span\u003e }, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e\n\n  \u003cspan class=\"synComment\"\u003e# GET https://example.com/users\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eget_users\u003c/span\u003e\n    get \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eusers\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eそれは良いんですが、 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/rspec\"\u003erspec\u003c/a\u003e 上で \u003ccode\u003ewait\u003c/code\u003e が効いてしまっていたので、上記のコードだとリトライ3回分 wait するので、合計 3 分も待たされてしまっていました。\n一応 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/rspec\"\u003erspec\u003c/a\u003e で \u003ccode\u003esleep\u003c/code\u003e を stub するとかやれば回避できますが、そもそもテストでは wait を無視して欲しいですよね。\u003c/p\u003e\n\n\u003cp\u003emy_\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/api\"\u003eapi\u003c/a\u003e_client では \u003ccode\u003ebe_handled_as_an_error\u003c/code\u003e という \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/rspec\"\u003erspec\u003c/a\u003e の matcher を用意しているのですが、今回の対応で、この macher を経由してリトライが実行された場合は wait を無視するようになりました。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synType\"\u003eRSpec\u003c/span\u003e.describe \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003etype\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e:api_client\u003c/span\u003e \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e\n  let(\u003cspan class=\"synConstant\"\u003e:api_client\u003c/span\u003e) { described_class.new }\n\n  \u003cspan class=\"synComment\"\u003e# \u003c/span\u003e\u003cspan class=\"synTodo\"\u003eNOTE\u003c/span\u003e\u003cspan class=\"synComment\"\u003e: レスポンスで `{ \u0026quot;errors\u0026quot;: { \u0026quot;code\u0026quot;: 20 } }` を受診した際、3 回リトライが実行された後に `MyApiClient::ApiLimitError` として例外処理される。\u003c/span\u003e\n  it \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e\n    expect { api_request! }\n      .to be_handled_as_an_error(\u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e)\n      .after_retry(\u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e).times\n      .when_receive(\u003cspan class=\"synConstant\"\u003ebody\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003eerrors\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003ecode\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e20\u003c/span\u003e } }.to_json)\n  \u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eまた、 \u003ccode\u003eExampleApiClient\u003c/code\u003e は \u003ccode\u003estub_api_client\u003c/code\u003e や \u003ccode\u003estub_api_client_all\u003c/code\u003e を使用するとスタブ化できます。\nスタブ化した状態だと任意の \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e レスポンスを返すか、任意の例外を発生させる、という動作になってリトライが発生しなくなるので、上記の問題はありませんでした。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003estub_api_client_all(\u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eget_users\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003eusers\u003c/span\u003e: [{ \u003cspan class=\"synConstant\"\u003eid\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e }, { \u003cspan class=\"synConstant\"\u003eid\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e }, { \u003cspan class=\"synConstant\"\u003eid\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e }] })\n\nresponse = \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e.new.get_users\nresponse.users \u003cspan class=\"synComment\"\u003e# =\u0026gt; [{ id: 1 }, { id: 2 }, { id: 3 }]\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch2\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/pull/175\"\u003e#175\u003c/a\u003e Verify arguments on error handling definition\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eerror_handling\u003c/code\u003e の定義でレスポンスの\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B9%A5%C6%A1%BC%A5%BF%A5%B9%A5%B3%A1%BC%A5%C9\"\u003eステータスコード\u003c/a\u003eを指定することができるんですが、このオプション名が \u003ccode\u003estatus_code\u003c/code\u003e なのか \u003ccode\u003estatus\u003c/code\u003e なのかをよく間違える、という問題がありました。\u003ccode\u003e$ rails g api_client\u003c/code\u003e を使用するとテンプレが作成されるので、そこからエラーハンドリングの定義を行うと間違えにくいのですが、後からエラーハンドリングを追加する時とかにやらかします。作者自身もたまにやらかしてました😇\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# 正解\u003c/span\u003e\nerror_handling \u003cspan class=\"synConstant\"\u003estatus_code\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e400\u003c/span\u003e..\u003cspan class=\"synConstant\"\u003e499\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e# 間違い\u003c/span\u003e\nerror_handling \u003cspan class=\"synConstant\"\u003estatus\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e400\u003c/span\u003e..\u003cspan class=\"synConstant\"\u003e499\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eClientError\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eこの PR の対応で間違ったオプションを指定すると以下のような例外が発生するようになりました。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eRuntimeError:\n  Specified an incorrect option: `status`\n  You can use options that: [:response, :status_code, :json, :with, :raise, :block]\u003c/pre\u003e\n\n\n\u003ch2\u003e\u003ca href=\"https://github.com/ryz310/my_api_client/pull/176\"\u003e#176\u003c/a\u003e Provides a syntax sugar of \u003ccode\u003eretry_on\u003c/code\u003e on \u003ccode\u003eerror_handling\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e最初の PR でも出てきた \u003ccode\u003eretry_on\u003c/code\u003e ですが、 \u003ccode\u003eerror_handling raise: MyApiClient::ApiLimitError\u003c/code\u003e でも同じ例外を指定していて DRY な感じじゃなかったり、\u003ccode\u003eretry_on\u003c/code\u003e と \u003ccode\u003eerror_handling\u003c/code\u003e をそれぞれ定義してるとお互いの関連が実感しづらい、という不満がありました。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synPreProc\"\u003eclass\u003c/span\u003e \u003cspan class=\"synType\"\u003eExampleApiClient\u003c/span\u003e \u0026lt; \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eBase\u003c/span\u003e\n  endpoint \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ehttps://example.com\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\n  retry_on \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003ewait\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e.minute, \u003cspan class=\"synConstant\"\u003eattempts\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e\n  error_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e20\u003c/span\u003e }, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e\n\n  \u003cspan class=\"synComment\"\u003e# GET https://example.com/users\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003edef\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003eget_users\u003c/span\u003e\n    get \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eusers\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n  \u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eこの \u003ccode\u003ePR\u003c/code\u003e では \u003ccode\u003eretry\u003c/code\u003e というオプションを \u003ccode\u003eerror_handling\u003c/code\u003e に追加しています。これにより、以下の 2 つのコードは等価になります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003eretry_on \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003ewait\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e.minute, \u003cspan class=\"synConstant\"\u003eattempts\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e\nerror_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e20\u003c/span\u003e }, \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003eerror_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e20\u003c/span\u003e }, \n                          \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e, \n                          \u003cspan class=\"synConstant\"\u003eretry\u003c/span\u003e: { \u003cspan class=\"synConstant\"\u003ewait\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e.minute, \u003cspan class=\"synConstant\"\u003eattempts\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e3\u003c/span\u003e }\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003eretry_on\u003c/code\u003e にオプションを指定する必要がなければ \u003ccode\u003eretry: true\u003c/code\u003e と書けば OK です。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003eerror_handling \u003cspan class=\"synConstant\"\u003ejson\u003c/span\u003e: { \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e$.errors.code\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003e20\u003c/span\u003e }, \n                          \u003cspan class=\"synConstant\"\u003eraise\u003c/span\u003e: \u003cspan class=\"synType\"\u003eMyApiClient\u003c/span\u003e::\u003cspan class=\"synType\"\u003eApiLimitError\u003c/span\u003e, \n                          \u003cspan class=\"synConstant\"\u003eretry\u003c/span\u003e: \u003cspan class=\"synConstant\"\u003etrue\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eただし、 \u003ccode\u003eretry\u003c/code\u003e オプションを使用する際は以下の点に注意が必要です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eerror_handling\u003c/code\u003e に \u003ccode\u003eraise\u003c/code\u003e オプションの指定が必須となります。\u003c/li\u003e\n\u003cli\u003eBlock を使った \u003ccode\u003eerror_handling\u003c/code\u003e の定義は禁止されます。\u003c/li\u003e\n\u003c/ul\u003e\n\n","contentSnippet":"my_api_client v0.12.0 に含まれる PR の内容について解説していきます。より詳しい使い方は README.jp.md をご参照ください。#173 Avoid sleep on testingmy_api_client では以下のように書くと、任意の例外を補足して自動的に API リクエストをリトライしてくれます。ネットワーク系のエラーとか、 API Rate Limit に引っかかった時とかに便利なやつですね。ActiveJob の retry_on とほぼ同じ使い方になっています。class ExampleApiClient \u003c MyApiClient::Base  endpoint 'https://example.com'  retry_on MyApiClient::ApiLimitError, wait: 1.minute, attempts: 3  error_handling json: { '$.errors.code': 20 }, raise: MyApiClient::ApiLimitError  # GET https://example.com/users  def get_users    get 'users'  endendそれは良いんですが、 rspec 上で wait が効いてしまっていたので、上記のコードだとリトライ3回分 wait するので、合計 3 分も待たされてしまっていました。一応 rspec で sleep を stub するとかやれば回避できますが、そもそもテストでは wait を無視して欲しいですよね。my_api_client では be_handled_as_an_error という rspec の matcher を用意しているのですが、今回の対応で、この macher を経由してリトライが実行された場合は wait を無視するようになりました。RSpec.describe ExampleApiClient, type: :api_client do  let(:api_client) { described_class.new }  # NOTE: レスポンスで `{ \"errors\": { \"code\": 20 } }` を受診した際、3 回リトライが実行された後に `MyApiClient::ApiLimitError` として例外処理される。  it do    expect { api_request! }      .to be_handled_as_an_error(MyApiClient::ApiLimitError)      .after_retry(3).times      .when_receive(body: { errors: { code: 20 } }.to_json)  endendまた、 ExampleApiClient は stub_api_client や stub_api_client_all を使用するとスタブ化できます。スタブ化した状態だと任意の API レスポンスを返すか、任意の例外を発生させる、という動作になってリトライが発生しなくなるので、上記の問題はありませんでした。stub_api_client_all(ExampleApiClient, get_users: { users: [{ id: 1 }, { id: 2 }, { id: 3 }] })response = ExampleApiClient.new.get_usersresponse.users # =\u003e [{ id: 1 }, { id: 2 }, { id: 3 }]#175 Verify arguments on error handling definitionerror_handling の定義でレスポンスのステータスコードを指定することができるんですが、このオプション名が status_code なのか status なのかをよく間違える、という問題がありました。$ rails g api_client を使用するとテンプレが作成されるので、そこからエラーハンドリングの定義を行うと間違えにくいのですが、後からエラーハンドリングを追加する時とかにやらかします。作者自身もたまにやらかしてました😇# 正解error_handling status_code: 400..499, raise: MyApiClient::ClientError# 間違いerror_handling status: 400..499, raise: MyApiClient::ClientErrorこの PR の対応で間違ったオプションを指定すると以下のような例外が発生するようになりました。RuntimeError:  Specified an incorrect option: `status`  You can use options that: [:response, :status_code, :json, :with, :raise, :block]#176 Provides a syntax sugar of retry_on on error_handling最初の PR でも出てきた retry_on ですが、 error_handling raise: MyApiClient::ApiLimitError でも同じ例外を指定していて DRY な感じじゃなかったり、retry_on と error_handling をそれぞれ定義してるとお互いの関連が実感しづらい、という不満がありました。class ExampleApiClient \u003c MyApiClient::Base  endpoint 'https://example.com'  retry_on MyApiClient::ApiLimitError, wait: 1.minute, attempts: 3  error_handling json: { '$.errors.code': 20 }, raise: MyApiClient::ApiLimitError  # GET https://example.com/users  def get_users    get 'users'  endendこの PR では retry というオプションを error_handling に追加しています。これにより、以下の 2 つのコードは等価になります。retry_on MyApiClient::ApiLimitError, wait: 1.minute, attempts: 3error_handling json: { '$.errors.code': 20 }, raise: MyApiClient::ApiLimitErrorerror_handling json: { '$.errors.code': 20 },                           raise: MyApiClient::ApiLimitError,                           retry: { wait: 1.minute, attempts: 3 }retry_on にオプションを指定する必要がなければ retry: true と書けば OK です。error_handling json: { '$.errors.code': 20 },                           raise: MyApiClient::ApiLimitError,                           retry: trueただし、 retry オプションを使用する際は以下の点に注意が必要です。error_handling に raise オプションの指定が必須となります。Block を使った error_handling の定義は禁止されます。","link":"https://ryz310.hateblo.jp/entry/2020/01/19/152826","isoDate":"2020-01-19T06:28:26.000Z","dateMiliSeconds":1579415306000,"imageUrl":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","authorName":"ryz310"},{"title":"私と gem","content":"\u003cp\u003eどーも、サトウリョウスケです。\n\u003ca href=\"https://ginza-rails.connpass.com/event/155467\"\u003e金曜日に登壇した勉強会\u003c/a\u003e で \u003cdel\u003eうっかり\u003c/del\u003e ブログ作るって言ってしまったので 10 年ぶりくらいにブログを復活させてみました。ブログのタイトルも 10 年前のタイトルと同じです（元ネタは\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%DF%A5%B3%A5%F3\"\u003eファミコン\u003c/a\u003e時代の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%C9%A5%E9%A5%AF%A5%A8\"\u003eドラクエ\u003c/a\u003e IV）\u003c/p\u003e\n\n\u003cp\u003e勉強会の感想記事は近日中に書こうと思います✍️\u003c/p\u003e\n\n\u003ch2\u003eこの記事は Feedforce Advent Calendar 2019 の 15 日目です。\u003c/h2\u003e\n\n\u003cp\u003eさて、最初の記事からいきなり会社の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A2%A5%C9%A5%D9%A5%F3%A5%C8%A5%AB%A5%EC%A5%F3%A5%C0%A1%BC\"\u003eアドベントカレンダー\u003c/a\u003e記事になります🙏\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fadventar.org%2Fcalendars%2F4169\" title=\"feedforce Advent Calendar 2019 - Adventar\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://adventar.org/calendars/4169\"\u003eadventar.org\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e昨日は Yutaka KAWAI さんの「コーヒーは科学である ~抽出器具による味の違い~ \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%DA%A1%BC%A5%D1%A1%BC%A5%C9%A5%EA%A5%C3%A5%D7\"\u003eペーパードリップ\u003c/a\u003e編」でした。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fnote.com%2Futahca%2Fn%2Fn30594094e406\" title=\"コーヒーは科学である ~抽出器具による味の違い~ ペーパードリップ編｜Yutaka KAWAI｜note\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://note.com/utahca/n/n30594094e406\"\u003enote.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e珈琲屋さんかな？ってくらい凄い記事でしたね☕️\n記事に出てきたドリッパーは全種類持ってるってヤバくないですか？？？（もちろん良い意味で）\u003c/p\u003e\n\n\u003cp\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%DA%A1%BC%A5%D1%A1%BC%A5%C9%A5%EA%A5%C3%A5%D7\"\u003eペーパードリップ\u003c/a\u003e編ってことは続編もあるのかな？\nこの感じで記事が量産されたらそのうち書籍化されるかもしれません📚\u003c/p\u003e\n\n\u003ch2\u003e本編\u003c/h2\u003e\n\n\u003cp\u003e予告通り個人で gem を作る流れについて話そうと思うのですが、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A2%A5%C9%A5%D9%A5%F3%A5%C8%A5%AB%A5%EC%A5%F3%A5%C0%A1%BC\"\u003eアドベントカレンダー\u003c/a\u003eから流れてくると非エンジニアの方もきっと読まれると思うので、あんまり技術的な話題にせずにフワッとした話でもしようかと思います。\u003c/p\u003e\n\n\u003ch3\u003eそもそも gem ってなんだっけ？\u003c/h3\u003e\n\n\u003cp\u003eそもそも gem っていうのは \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ruby\"\u003eRuby\u003c/a\u003e でできたライブラリの事でして、例えば僕が凄く便利なプログラムを書いて、それを gem として公開すれば、世界中の人が僕のイケてるプログラムを使えるようになる、というものです。まさに \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Win-Win\"\u003eWin-Win\u003c/a\u003e しかない仕組み。gem は世界を救います。\u003c/p\u003e\n\n\u003cp\u003e一方で、プログラムってのは新機能が追加されたり、不具合が修正されたりして日々アップデートが繰り返されています。\n「この機能にはバージョン 1.3 以降でないと使えません」とか「色々イケてない部分が多いからこの機能は廃止します」という変更もあるので、自分のプログラムは一体どのバージョンの gem を使っているのか、という話が物凄く重要だったりします。\u003c/p\u003e\n\n\u003cp\u003egem にはどのバージョンを使っているのか（依存しているのか）という情報を管理する機能も備わっていますので、ある日突然新バージョンで挙動が変わっても「うちは一個前のバージョン使ってます！」という管理ができていれば動かなくなることはないのです。\u003c/p\u003e\n\n\u003cp\u003eとはいえ新バージョンでいきなりそんなトンデモ変更されたら困りますけども。\u003c/p\u003e\n\n\u003ch3\u003e僕が初めて作った gem\u003c/h3\u003e\n\n\u003cp\u003e自分が生まれて初めて作った gem はこの \u003ccode\u003erubocop_challenger\u003c/code\u003e という gem です。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Frubocop_challenger\" title=\"ryz310/rubocop_challenger\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/rubocop_challenger\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e一般的に gem は他のプログラムと組み合わせて使う事が多いのですが、 \u003ccode\u003erubocop_challenger\u003c/code\u003e は単体で動作するやつでして、実行した\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8\"\u003eディレクト\u003c/a\u003eリ（フォルダ）にあるプログラムの\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9\"\u003eソースコード\u003c/a\u003eを少しずつ綺麗に（人間にとって読みやすくしたり、書き方のルールを統一したり）してくれる、という gem です。\u003c/p\u003e\n\n\u003cp\u003eというと物凄い神 gem ですが、RuboCop という\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9\"\u003eソースコード\u003c/a\u003eを解析してくれる便利な gem を内部で呼び出してプルリク（プルリクが何なのかはググってください）作ってくれる、という仕組みになっているので、「人間が毎日手作業でやらないといけなかった事を自動的にやる」というのが \u003ccode\u003erubocop_challenger\u003c/code\u003e の提供する価値になります 🤖\u003c/p\u003e\n\n\u003cp\u003e詳しくはちょうど一年くらい前に会社のブログに書いたので、ご興味ありましたら是非。古い内容なので、現在のバージョンからは少しずれてますけど。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2018%2F12%2F05%2F140000\" title=\"まだ .rubocop_todo.yml で消耗してるの？ - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2018/12/05/140000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eちなみにもうすぐ \u003ccode\u003ev2.0.0\u003c/code\u003e をリリースする予定です。（pre バージョンですが、現時点でもすでに使えます）\u003c/p\u003e\n\n\u003ch3\u003eニッチな gem\u003c/h3\u003e\n\n\u003cp\u003e初めて作ったのは \u003ccode\u003erubocop_challenger\u003c/code\u003e という「人間が毎日手作業でやらないといけなかった事を自動的にやる」 gem でした。\n完全に自分の会社のプロダクト用に作った gem でしたが、 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Twitter\"\u003eTwitter\u003c/a\u003e などを\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B4%A5%B5\"\u003eエゴサ\u003c/a\u003eしてると、ぼちぼち使って頂けているようです。\n同じような悩みを抱えている人は世の中にはいるもんですね✨\u003c/p\u003e\n\n\u003cp\u003eとはいえ、 gem を公開したら世界中の人たちが使ってくれる、ということには中々ならないです。\n一応頑張って英語で説明を書いたりはしていますが、個人の発信力には限界もありますし、何よりニッチです。\u003c/p\u003e\n\n\u003cp\u003eというか、個人が作る gem なんて大抵はニッチなものになります。\n「あー、こんな gem あったらめっちゃ便利やん？」という gem は大抵世界のどこかの誰かが作ってます。\nなので、今までにないような新しいgem を作ろうと思ったら大抵ニッチになります。\u003c/p\u003e\n\n\u003cp\u003eじゃあ gem を公開しても大して使ってもらえないし、あんまり意味ないじゃん、って思うかもしれませんが、意味無くはないんですよね👍\u003c/p\u003e\n\n\u003ch3\u003e効能 1. \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B9%A5%AD%A5%EB%A5%A2%A5%C3%A5%D7\"\u003eスキルアップ\u003c/a\u003e\u003c/h3\u003e\n\n\u003cp\u003eまず、めっちゃプログラムを書く勉強になります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ruby\"\u003eRuby\u003c/a\u003e で Web 開発をしている人は大抵 \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ruby%20on%20Rails\"\u003eRuby on Rails\u003c/a\u003e を使って書いてると思います。ちなみに \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ruby%20on%20Rails\"\u003eRuby on Rails\u003c/a\u003e も gem です。\n\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ruby%20on%20Rails\"\u003eRuby on Rails\u003c/a\u003e は凄くよく出来ているので、Web 開発の難しい部分を 9 割くらいの肩代わりしてくれます。\u003c/p\u003e\n\n\u003cp\u003eところが、自分で一から gem を作ろうとすると、自分の力で解決しないといけないプログラム的な課題がめっちゃあります。\nWeb 開発はインターネット特有の課題が多いですが、 gem の開発には Web 開発以外の知識も色々要求されたりします。\u003c/p\u003e\n\n\u003cp\u003e何より、自分自身で仕様を一から考えないといけないので、普段の開発以上に意思決\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%C4%EA%CE%CC\"\u003e定量\u003c/a\u003eがめっちゃ多いです。\n自分は \u003ccode\u003erubocop_challenger\u003c/code\u003e 以外にもメンテナンスしている gem が 3 つほどありますが、これらの開発を通して日頃の Web 開発の品質も一段レベルが上がったな、と感じる事が多いです。\u003c/p\u003e\n\n\u003cp\u003eなので、gem の開発は自分自身の修行のためだと思ってやると良いかもしれません。誰かに使えてもらえたらラッキー、みたいな。\u003c/p\u003e\n\n\u003cp\u003e逆に使ってもらえる事をモチベーションにするとちょっと辛いかもしれないです。思った以上に流行らない。もっと流行れ！\u003c/p\u003e\n\n\u003ch3\u003e効能 2. \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%DD%A1%BC%A5%C8%A5%D5%A5%A9%A5%EA%A5%AA\"\u003eポートフォリオ\u003c/a\u003e\u003c/h3\u003e\n\n\u003cp\u003egem を公開してるせいか、企業からのスカウトがめっちゃ来るようになります。\u003c/p\u003e\n\n\u003cp\u003e自分自身、会社の採用活動に関わる機会が多いのですが、例えばスカウト候補を探す際に候補者の \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GitHub\"\u003eGitHub\u003c/a\u003e は必ず見るようにしています。\nその経験からですが自分で gem 書いて公開しているエンジニアは世の中の 1 割もいないんじゃないかな、って思っています。\u003c/p\u003e\n\n\u003cp\u003e自分も gem を作るようになったのはここ 1 ~ 2 年ですし、前職にいた頃だと普段の仕事の帰りが遅かったりもしたので家に帰ってから gem を作るような余裕もありませんでした。なので、本人の熱量や環境が整わないと gem の開発は難しいかもしれません。\u003c/p\u003e\n\n\u003cp\u003eしかしながら、自分も採用活動していて「お。この人すごいやん」ってなるのは \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GitHub\"\u003eGitHub\u003c/a\u003e や Qiita とかで何かしらアウトプットのある方なんですよね。\nもちろんアウトプットが無くても実際会ってみたら凄かったって人は沢山いるんですが、採用活動だとその人の仕事でのアウトプットって見えないもんですから。。\u003c/p\u003e\n\n\u003cp\u003e別に gem じゃなくても良いんですが、自分自身のキャリア形成を意識するためのアウトプットの一環としてとても有用だと思います。\u003c/p\u003e\n\n\u003ch3\u003e効能 3. 魔法のアイテム\u003c/h3\u003e\n\n\u003cp\u003e自分が今年作った gem に \u003ccode\u003emy_api_client\u003c/code\u003e という gem がありまして、\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e Client を作るための\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D5%A5%EC%A1%BC%A5%E0%A5%EF%A1%BC%A5%AF\"\u003eフレームワーク\u003c/a\u003eなんですが、これはプロダクトの\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9\"\u003eソースコード\u003c/a\u003eにも使っています。\u003c/p\u003e\n\n\u003cp\u003e自分が携わってるサービスは \u003ca href=\"https://socialplus.jp/\"\u003eソーシャルPLUS\u003c/a\u003e というものでして、企業の Web サービスとソーシャルログインプロバイダー（ LINE とか \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Twitter\"\u003eTwitter\u003c/a\u003e とか）のハブになってるサービスなんですね。そのせいもあって、外部の Web \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/API\"\u003eAPI\u003c/a\u003e へリク\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9\"\u003eエス\u003c/a\u003eトするという処理が多く、毎回同じようなエラーハンドリングやリトライの処理を何度も書かないといけなくて大変だった訳です。\u003c/p\u003e\n\n\u003cp\u003eあと、エラーが発生した際に「ソーシャルPLUS」「ソーシャルPLUSを利用している企業」「ソーシャルログインプロバイダ」の誰が原因なのかを特定するための情報をログに残すとかも都度対応しないといけなくて超大変でした。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e はその辺の処理をすっきり簡単に書けるようにするための gem でして、すっきり簡単なもんだから、チームメイトが \u003ccode\u003emy_api_client\u003c/code\u003e を活用して自発的にガンガン課題を解決してくれる、という最高にホットな状況を産み出すことに一役買っております。\u003c/p\u003e\n\n\u003cp\u003eやっぱエンジニアも人間なので、普段の業務で忙しい中で改善活動も同時にやろうなんてモチベーションは普通は湧いてこない訳です。でも、これを使えばすっきり簡単だよ、っていう魔法のアイテムがあれば、みんなの重い腰を少しだけ軽くする事ができます。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003emy_api_client\u003c/code\u003e は自分の中でも割とよくできた gem なので、毎回こんな良い gem が作れる訳じゃないですけど、 gem を作ってチームの生産性が上がるってのはやっぱ魔法のアイテムだなぁって思うんです。gem は世界を救います！（２回目）\u003c/p\u003e\n\n\u003cp\u003eなお、 \u003ccode\u003emy_api_client\u003c/code\u003e については \u003ca href=\"https://ginza-rails.connpass.com/event/133628/\"\u003e銀座 Rails #10\u003c/a\u003e で登壇したときの資料があるので貼っておきます。これも若干古いので、最新の仕様とは少し異なるかもしれません。\n最新の仕様は \u003ca href=\"https://github.com/ryz310/my_api_client/blob/master/README.jp.md\"\u003eこちら\u003c/a\u003e をご覧下さい。\u003c/p\u003e\n\n\u003cscript async class=\"speakerdeck-embed\" data-id=\"75d691da45b041deb3db8e6748d81638\" data-ratio=\"1.37081659973226\" src=\"//speakerdeck.com/assets/embed.js\"\u003e\u003c/script\u003e\n\n\n\u003ch3\u003e効能 4. たのしい\u003c/h3\u003e\n\n\u003cp\u003e最後はここに帰ってくるんですが、自分の gem を作るのはやっぱ楽しいのです。いきなり頭悪い文章になりました。いつから頭良い文章書いてると錯覚していた？\u003c/p\u003e\n\n\u003cp\u003e以前勉強会で「これまでどういうキャリアを意識してやってきましたか？」って若手のエンジニアから聞かれたのですが、自分みたいな 30 半ばのエンジニアって、エンジニアになった当初は今みたいにエンジニアが持て囃される時代でもなかったので、自分からエンジニアになろうって思った人は少なからず「ただプログラムが好きだった」っていう人が多いんじゃないですかね？わかんないですけど自分はそうでした。\u003c/p\u003e\n\n\u003cp\u003e自作の gem を作ってると「やっぱプログラム書くのって楽しい」ってのを思い出させてくれます。\n自分は他にも趣味でバンドやったり絵を描いたりしていますが、プログラミングが子供の頃に好きだった工作に一番近いような気がしています。\u003c/p\u003e\n\n\u003cp\u003e中々プライベートで時間を作るのは難しいんですが、やはり楽しさが一番根底の原動力になっているのかもしれないですね。\u003c/p\u003e\n\n\u003ch2\u003eまとまらないまとめ\u003c/h2\u003e\n\n\u003cp\u003e会社の\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A2%A5%C9%A5%D9%A5%F3%A5%C8%A5%AB%A5%EC%A5%F3%A5%C0%A1%BC\"\u003eアドベントカレンダー\u003c/a\u003e向けだし、非エンジニアにも伝わるようなフワッとした文章にしようと思って書いてたら、途中から俺のポエムを書き殴ってただけになった気がしますが、役に立つかどうかは 2 の次にして、とりあえず gem 作ってみると楽しく\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%B9%A5%AD%A5%EB%A5%A2%A5%C3%A5%D7\"\u003eスキルアップ\u003c/a\u003eできるし、もしかしたら誰かの魔法のアイテムになってるかもしれないよ、というお話でした。\u003c/p\u003e\n\n\u003cp\u003e久々にゆる〜い文章書いてて自分的には楽しかったです 笑\u003c/p\u003e\n\n\u003ch2\u003eさて、明日の Advent Calendar は？（CV. \u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%B2%C3%C6%A3%A4%DF%A4%C9%A4%EA\"\u003e加藤みどり\u003c/a\u003e）\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://adventar.org/calendars/4169\"\u003eFeedforce Advent Calendar 2019\u003c/a\u003e、明日は上岡君が「野球についてor遠隔\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%BF%A1%BC%A5%F3\"\u003eインターン\u003c/a\u003eについて」書いてくれるみたいです。\u003c/p\u003e\n\n\u003cp\u003e最近は\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%BF%A1%BC%A5%F3\"\u003eインターン\u003c/a\u003eも遠隔で出来るんですね。野球も遠隔\u003ca class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%BF%A1%BC%A5%F3\"\u003eインターン\u003c/a\u003eも未経験のままおじさんになってしまったので自分には未知の領域です⚾️💨\u003c/p\u003e\n\n\u003cp\u003e乞うご期待！\u003c/p\u003e\n","contentSnippet":"どーも、サトウリョウスケです。金曜日に登壇した勉強会 で うっかり ブログ作るって言ってしまったので 10 年ぶりくらいにブログを復活させてみました。ブログのタイトルも 10 年前のタイトルと同じです（元ネタはファミコン時代のドラクエ IV）勉強会の感想記事は近日中に書こうと思います✍️この記事は Feedforce Advent Calendar 2019 の 15 日目です。さて、最初の記事からいきなり会社のアドベントカレンダー記事になります🙏adventar.org昨日は Yutaka KAWAI さんの「コーヒーは科学である ~抽出器具による味の違い~ ペーパードリップ編」でした。note.com珈琲屋さんかな？ってくらい凄い記事でしたね☕️記事に出てきたドリッパーは全種類持ってるってヤバくないですか？？？（もちろん良い意味で）ペーパードリップ編ってことは続編もあるのかな？この感じで記事が量産されたらそのうち書籍化されるかもしれません📚本編予告通り個人で gem を作る流れについて話そうと思うのですが、アドベントカレンダーから流れてくると非エンジニアの方もきっと読まれると思うので、あんまり技術的な話題にせずにフワッとした話でもしようかと思います。そもそも gem ってなんだっけ？そもそも gem っていうのは Ruby でできたライブラリの事でして、例えば僕が凄く便利なプログラムを書いて、それを gem として公開すれば、世界中の人が僕のイケてるプログラムを使えるようになる、というものです。まさに Win-Win しかない仕組み。gem は世界を救います。一方で、プログラムってのは新機能が追加されたり、不具合が修正されたりして日々アップデートが繰り返されています。「この機能にはバージョン 1.3 以降でないと使えません」とか「色々イケてない部分が多いからこの機能は廃止します」という変更もあるので、自分のプログラムは一体どのバージョンの gem を使っているのか、という話が物凄く重要だったりします。gem にはどのバージョンを使っているのか（依存しているのか）という情報を管理する機能も備わっていますので、ある日突然新バージョンで挙動が変わっても「うちは一個前のバージョン使ってます！」という管理ができていれば動かなくなることはないのです。とはいえ新バージョンでいきなりそんなトンデモ変更されたら困りますけども。僕が初めて作った gem自分が生まれて初めて作った gem はこの rubocop_challenger という gem です。github.com一般的に gem は他のプログラムと組み合わせて使う事が多いのですが、 rubocop_challenger は単体で動作するやつでして、実行したディレクトリ（フォルダ）にあるプログラムのソースコードを少しずつ綺麗に（人間にとって読みやすくしたり、書き方のルールを統一したり）してくれる、という gem です。というと物凄い神 gem ですが、RuboCop というソースコードを解析してくれる便利な gem を内部で呼び出してプルリク（プルリクが何なのかはググってください）作ってくれる、という仕組みになっているので、「人間が毎日手作業でやらないといけなかった事を自動的にやる」というのが rubocop_challenger の提供する価値になります 🤖詳しくはちょうど一年くらい前に会社のブログに書いたので、ご興味ありましたら是非。古い内容なので、現在のバージョンからは少しずれてますけど。developer.feedforce.jpちなみにもうすぐ v2.0.0 をリリースする予定です。（pre バージョンですが、現時点でもすでに使えます）ニッチな gem初めて作ったのは rubocop_challenger という「人間が毎日手作業でやらないといけなかった事を自動的にやる」 gem でした。完全に自分の会社のプロダクト用に作った gem でしたが、 Twitter などをエゴサしてると、ぼちぼち使って頂けているようです。同じような悩みを抱えている人は世の中にはいるもんですね✨とはいえ、 gem を公開したら世界中の人たちが使ってくれる、ということには中々ならないです。一応頑張って英語で説明を書いたりはしていますが、個人の発信力には限界もありますし、何よりニッチです。というか、個人が作る gem なんて大抵はニッチなものになります。「あー、こんな gem あったらめっちゃ便利やん？」という gem は大抵世界のどこかの誰かが作ってます。なので、今までにないような新しいgem を作ろうと思ったら大抵ニッチになります。じゃあ gem を公開しても大して使ってもらえないし、あんまり意味ないじゃん、って思うかもしれませんが、意味無くはないんですよね👍効能 1. スキルアップまず、めっちゃプログラムを書く勉強になります。Ruby で Web 開発をしている人は大抵 Ruby on Rails を使って書いてると思います。ちなみに Ruby on Rails も gem です。Ruby on Rails は凄くよく出来ているので、Web 開発の難しい部分を 9 割くらいの肩代わりしてくれます。ところが、自分で一から gem を作ろうとすると、自分の力で解決しないといけないプログラム的な課題がめっちゃあります。Web 開発はインターネット特有の課題が多いですが、 gem の開発には Web 開発以外の知識も色々要求されたりします。何より、自分自身で仕様を一から考えないといけないので、普段の開発以上に意思決定量がめっちゃ多いです。自分は rubocop_challenger 以外にもメンテナンスしている gem が 3 つほどありますが、これらの開発を通して日頃の Web 開発の品質も一段レベルが上がったな、と感じる事が多いです。なので、gem の開発は自分自身の修行のためだと思ってやると良いかもしれません。誰かに使えてもらえたらラッキー、みたいな。逆に使ってもらえる事をモチベーションにするとちょっと辛いかもしれないです。思った以上に流行らない。もっと流行れ！効能 2. ポートフォリオgem を公開してるせいか、企業からのスカウトがめっちゃ来るようになります。自分自身、会社の採用活動に関わる機会が多いのですが、例えばスカウト候補を探す際に候補者の GitHub は必ず見るようにしています。その経験からですが自分で gem 書いて公開しているエンジニアは世の中の 1 割もいないんじゃないかな、って思っています。自分も gem を作るようになったのはここ 1 ~ 2 年ですし、前職にいた頃だと普段の仕事の帰りが遅かったりもしたので家に帰ってから gem を作るような余裕もありませんでした。なので、本人の熱量や環境が整わないと gem の開発は難しいかもしれません。しかしながら、自分も採用活動していて「お。この人すごいやん」ってなるのは GitHub や Qiita とかで何かしらアウトプットのある方なんですよね。もちろんアウトプットが無くても実際会ってみたら凄かったって人は沢山いるんですが、採用活動だとその人の仕事でのアウトプットって見えないもんですから。。別に gem じゃなくても良いんですが、自分自身のキャリア形成を意識するためのアウトプットの一環としてとても有用だと思います。効能 3. 魔法のアイテム自分が今年作った gem に my_api_client という gem がありまして、API Client を作るためのフレームワークなんですが、これはプロダクトのソースコードにも使っています。自分が携わってるサービスは ソーシャルPLUS というものでして、企業の Web サービスとソーシャルログインプロバイダー（ LINE とか Twitter とか）のハブになってるサービスなんですね。そのせいもあって、外部の Web API へリクエストするという処理が多く、毎回同じようなエラーハンドリングやリトライの処理を何度も書かないといけなくて大変だった訳です。あと、エラーが発生した際に「ソーシャルPLUS」「ソーシャルPLUSを利用している企業」「ソーシャルログインプロバイダ」の誰が原因なのかを特定するための情報をログに残すとかも都度対応しないといけなくて超大変でした。my_api_client はその辺の処理をすっきり簡単に書けるようにするための gem でして、すっきり簡単なもんだから、チームメイトが my_api_client を活用して自発的にガンガン課題を解決してくれる、という最高にホットな状況を産み出すことに一役買っております。やっぱエンジニアも人間なので、普段の業務で忙しい中で改善活動も同時にやろうなんてモチベーションは普通は湧いてこない訳です。でも、これを使えばすっきり簡単だよ、っていう魔法のアイテムがあれば、みんなの重い腰を少しだけ軽くする事ができます。my_api_client は自分の中でも割とよくできた gem なので、毎回こんな良い gem が作れる訳じゃないですけど、 gem を作ってチームの生産性が上がるってのはやっぱ魔法のアイテムだなぁって思うんです。gem は世界を救います！（２回目）なお、 my_api_client については 銀座 Rails #10 で登壇したときの資料があるので貼っておきます。これも若干古いので、最新の仕様とは少し異なるかもしれません。最新の仕様は こちら をご覧下さい。効能 4. たのしい最後はここに帰ってくるんですが、自分の gem を作るのはやっぱ楽しいのです。いきなり頭悪い文章になりました。いつから頭良い文章書いてると錯覚していた？以前勉強会で「これまでどういうキャリアを意識してやってきましたか？」って若手のエンジニアから聞かれたのですが、自分みたいな 30 半ばのエンジニアって、エンジニアになった当初は今みたいにエンジニアが持て囃される時代でもなかったので、自分からエンジニアになろうって思った人は少なからず「ただプログラムが好きだった」っていう人が多いんじゃないですかね？わかんないですけど自分はそうでした。自作の gem を作ってると「やっぱプログラム書くのって楽しい」ってのを思い出させてくれます。自分は他にも趣味でバンドやったり絵を描いたりしていますが、プログラミングが子供の頃に好きだった工作に一番近いような気がしています。中々プライベートで時間を作るのは難しいんですが、やはり楽しさが一番根底の原動力になっているのかもしれないですね。まとまらないまとめ会社のアドベントカレンダー向けだし、非エンジニアにも伝わるようなフワッとした文章にしようと思って書いてたら、途中から俺のポエムを書き殴ってただけになった気がしますが、役に立つかどうかは 2 の次にして、とりあえず gem 作ってみると楽しくスキルアップできるし、もしかしたら誰かの魔法のアイテムになってるかもしれないよ、というお話でした。久々にゆる〜い文章書いてて自分的には楽しかったです 笑さて、明日の Advent Calendar は？（CV. 加藤みどり）Feedforce Advent Calendar 2019、明日は上岡君が「野球についてor遠隔インターンについて」書いてくれるみたいです。最近はインターンも遠隔で出来るんですね。野球も遠隔インターンも未経験のままおじさんになってしまったので自分には未知の領域です⚾️💨乞うご期待！","link":"https://ryz310.hateblo.jp/entry/2019/12/15/224312","isoDate":"2019-12-15T13:43:12.000Z","dateMiliSeconds":1576417392000,"imageUrl":"https://cdn.blog.st-hatena.com/images/theme/og-image-1500.png","authorName":"ryz310"},{"title":"まだ .rubocop_todo.yml で消耗してるの？","content":"\u003cp\u003eどうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003e若干釣り臭いタイトルですが、先日 \u003ca href=\"https://github.com/ryz310/rubocop_challenger\"\u003eRubocopChallenger\u003c/a\u003e という gem の \u003ccode\u003ev1.0.0\u003c/code\u003e をリリースしたので紹介させて頂きます 🙏\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Frubocop_challenger\" title=\"GitHub - ryz310/rubocop_challenger: Make a clean your rubocop_todo.yml with CI\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/rubocop_challenger\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003e経緯\u003c/h2\u003e\n\n\u003cp\u003e僕が所属している \u003ca href=\"https://socialplus.jp/\"\u003eソーシャルPLUS\u003c/a\u003e は 2012 年頃から開発が始まりました。Rails のプロダクトとしては古株の方だと思います。\u003c/p\u003e\n\n\u003cp\u003eソーシャルPLUS に \u003ca href=\"https://github.com/rubocop-hq/rubocop\"\u003eRuboCop\u003c/a\u003e が導入されたのは 2017/02 頃 \u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" rel=\"footnote\"\u003e1\u003c/a\u003e\u003c/sup\u003e で、それまで特に RuboCop を意識したコードで開発を進めてこなかったので、巨大な .rubocop_todo.yml が出力され、それが手付かずのままになってしまっていました。ちなみに当初は \u003cstrong\u003e1669 行 195 種類\u003c/strong\u003e の違反ルールがありました。\u003c/p\u003e\n\n\u003cp\u003eこのままでは RuboCop の恩恵が受けられないので、 RuboCop Challenge と称して (以前 \u003ca href=\"https://ja.wikipedia.org/wiki/%E3%82%A2%E3%82%A4%E3%82%B9%E3%83%BB%E3%83%90%E3%82%B1%E3%83%84%E3%83%BB%E3%83%81%E3%83%A3%E3%83%AC%E3%83%B3%E3%82%B8\"\u003eIce Bucket Challenge\u003c/a\u003e が流行っていたので) 週イチで \u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e から違反ルールを一つ消して、 auto-correct で修正する、という事をやっていたのですが、数ヶ月（数週間だったかも）ですっかりやるのを忘れてしまいました 😇\u003c/p\u003e\n\n\u003cp\u003e最近また RuboCop Challenge を再開しよう、という流れになったのですが、手動でコツコツやるのも精神的にしんどくなって来たので、なんとか自動化したいな、という気持ちになり、手動でやっていた Rubocop Challenge を Ruby スクリプトで動かせるようにしました。\n最初は単純な Ruby スクリプトだったのですが、せっかくなので gem 化しよう、という事になり、作成したのが RubocopChallenger です。\u003c/p\u003e\n\n\u003cp\u003eところで、弊社エンジニアの \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e が circleci-bundle-update-pr という CI を利用した Bundle Update の自動更新 gem を作成しています。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fmasutaka%2Fcircleci-bundle-update-pr\" title=\"GitHub - masutaka/circleci-bundle-update-pr: Provide continues bundle update using CircleCI\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/masutaka/circleci-bundle-update-pr\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eこれに感銘を受けて (？) 自分の RubocopChallenger も CI から\u003ccode\u003e$ rubocop --auto-correct\u003c/code\u003e を実行した結果が PR として届くような仕組みになっています。\u003c/p\u003e\n\n\u003ch2\u003e使い方\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003e2021-09-23 修正\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch3\u003e1. \u003ccode\u003e.circleci/config.yml\u003c/code\u003e の編集\u003c/h3\u003e\n\n\u003cp\u003e以下に設定例を紹介します。\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# .circleci/config.yml\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003eversion\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e\n\n\u003cspan class=\"synIdentifier\"\u003ejobs\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003erubocop_challenge\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003edocker\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eimage\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e circleci/ruby:2.5-node-browsers\n    \u003cspan class=\"synIdentifier\"\u003eworking_directory\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ~/repo\n    \u003cspan class=\"synIdentifier\"\u003esteps\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003echeckout\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Rubocop Challenge\n          \u003cspan class=\"synIdentifier\"\u003ecommand\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e |\n            gem install rubocop_challenger\n            bundle exec rubocop_challenger go \\\n              --email={RubocopChallenger が commit する際の user email} \\\n              --name=\u0026quot;{RubocopChallenger が commit する際の user name}\u0026quot;\n\n\u003cspan class=\"synIdentifier\"\u003eworkflows\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003eversion\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e\n\n  \u003cspan class=\"synIdentifier\"\u003enightly\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003etriggers\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003eschedule\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003ecron\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;30 23 * * 1,2,3\u0026quot;\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # この設定の場合、火水木 の毎朝 8:30 に RubocopChallnger の PR が届きます\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003efilters\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"synIdentifier\"\u003ebranches\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"synIdentifier\"\u003eonly\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003emaster\n    \u003cspan class=\"synIdentifier\"\u003ejobs\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003erubocop_challenge\n\u003c/pre\u003e\n\n\n\u003cp\u003eインストールの際、 \u003cstrong\u003eGemfile に \u003ccode\u003egem 'rubocop_challenger'\u003c/code\u003e を追記しないようにご注意下さい。\u003c/strong\u003e\n他の gem との互換性問題により、 rubocop_challenger 実行中にエラーが発生するケースがあることを確認しております。\u003c/p\u003e\n\n\u003ch3\u003e2. GitHub personal access token の作成\u003c/h3\u003e\n\n\u003cp\u003eRubocopChallenger が PR を作成するために GitHub personal access token が必要になります。\n\u003ca href=\"https://github.com/settings/tokens\"\u003eSettings\u003c/a\u003e から \u003ca href=\"https://github.com/settings/tokens/new\"\u003eGenerate new token\u003c/a\u003e をクリックして access token を作成します。\n\u003cstrong\u003eSelect Scopes\u003c/strong\u003e では \u003ccode\u003erepo\u003c/code\u003e にチェック ✅ を入れて下さい。\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"https://github.com/ryz310/rubocop_challenger/raw/master/images/generate_token.png\" alt=\"Generate new token\" /\u003e\u003c/p\u003e\n\n\u003ch3\u003e3. CircleCI で環境変数の設定\u003c/h3\u003e\n\n\u003cp\u003e今回は \u003ca href=\"https://circleci.com/\"\u003eCircleCI\u003c/a\u003e での利用例を紹介します 🙏\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://circleci.com/dashboard\"\u003eダッシュボード画面\u003c/a\u003e に移動し、 RubocopChallenger を適用したいアプリケーションの \u003cstrong\u003eProject Settings\u003c/strong\u003e -\u003e \u003cstrong\u003eEnvironment Variables\u003c/strong\u003e へと移動します。\n\u003cstrong\u003eAdd Variable\u003c/strong\u003e をクリックして \u003ccode\u003eGITHUB_ACCESS_TOKEN\u003c/code\u003e という Key で先程作成した GitHub personal access token を設定します。\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"https://github.com/ryz310/rubocop_challenger/raw/master/images/circleci_environment_variables.png\" alt=\"Environment Variables\" /\u003e\u003c/p\u003e\n\n\u003ch3\u003e5. 作成された PR の確認\u003c/h3\u003e\n\n\u003cp\u003eここまでの手順を終えると、 CircleCI に指定したスケジュールで PR がされるようになると思います。\n後は auto-correct の内容を確認して、 merge するだけです。\u003c/p\u003e\n\n\u003cp\u003e中には適用したくないルールも出てくると思いますが、その場合は \u003ccode\u003e.rubocop.yml\u003c/code\u003e にルールを再定義して auto-correct されないようにします。\u003c/p\u003e\n\n\u003ch2\u003eどんな PR が作成されるのか？\u003c/h2\u003e\n\n\u003cp\u003eちょっと RubocopChallenger のバージョンが古い頃の物ですが、 \u003ca href=\"https://github.com/ryz310/rubocop_challenger/pull/97\"\u003e以下のような PR\u003c/a\u003e が自動的に作成されます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ryz310/rubocop_challenger/pull/97\"\u003e\u003cimg src=\"https://github.com/ryz310/rubocop_challenger/raw/master/images/rubocop_challenge.png\" alt=\"RubocopChallnge\" /\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eデフォルトの設定では、 \u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e の中から \u003cstrong\u003eCop supports --auto-correct\u003c/strong\u003e かつ \u003cstrong\u003eOffense count が最大\u003c/strong\u003e のルールを消して、 auto-correct した結果が PR として作成されます。\u003c/p\u003e\n\n\u003cp\u003eまた、 auto-correct の後で \u003ccode\u003e$ rubocop --auto-gen-config\u003c/code\u003e を実行して \u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e を再作成しています。 RuboCop のバージョンが変わった時とかに \u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e に出力される内容も若干変わっていたりするのですが、毎回最新の状態に作り直してくれるのがちょっと便利だったりします。\u003c/p\u003e\n\n\u003cp\u003eちなみに PR の \u003cstrong\u003eDescription\u003c/strong\u003e に表示されている内容は \u003ca href=\"https://www.rubydoc.info/gems/rubocop/RuboCop/Cop/Layout/AlignHash\"\u003e本家 RuboCop の RubyDoc\u003c/a\u003e に記載されている内容と同じものです。これを表示するのに地味に苦労しました 😓\u003c/p\u003e\n\n\u003ch2\u003e高度な設定\u003c/h2\u003e\n\n\u003cp\u003eRubocopChallnger にはいくつかオプションが用意されているので、ご紹介します。\u003c/p\u003e\n\n\u003ch3\u003e\u003ccode\u003e--mode\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e上述の通り、デフォルトでは auto-correct の対象は \u003cstrong\u003eCop supports --auto-correct\u003c/strong\u003e かつ \u003cstrong\u003eOffense count が最大\u003c/strong\u003e のルールが選択されますが、 \u003ccode\u003emode\u003c/code\u003e に渡す値によって対象を変更することが出来ます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003emost_occurrence\u003c/code\u003e (デフォルト)\n\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eOffense count が最大\u003c/strong\u003e のルールを選択する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eleast_occurrence\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eOffense count が最小\u003c/strong\u003e のルールを選択する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003erandom\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e全体からランダムに選択する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch4\u003e使用例\u003c/h4\u003e\n\n\u003cpre class=\"code lang-sh\" data-lang=\"sh\" data-unlink\u003e$ bundle \u003cspan class=\"synStatement\"\u003eexec\u003c/span\u003e rubocop_challenger go \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--email=rubocop-challenger@example.com\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--name=\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eRubocop Challenger\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--mode=random\u003c/span\u003e \n\u003c/pre\u003e\n\n\n\u003ch3\u003e\u003ccode\u003e--labels\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003eRubocopChallnger が作成する PR に付与される label を指定します。デフォルトでは \u003cstrong\u003erubocop challenge\u003c/strong\u003e というラベルが付与されます。\nソーシャルPLUS では \u003ca href=\"https://waffle.io/\"\u003ewaffle.io\u003c/a\u003e を利用していたりするのですが、レビュー待ち状態の label を付与するようにすると見落としがなくて便利です。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eスペース区切り\u003c/strong\u003eで複数指定することが出来ます。\u003c/p\u003e\n\n\u003ch4\u003e使用例\u003c/h4\u003e\n\n\u003cpre class=\"code lang-sh\" data-lang=\"sh\" data-unlink\u003e$ bundle \u003cspan class=\"synStatement\"\u003eexec\u003c/span\u003e rubocop_challenger go \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--email=rubocop-challenger@example.com\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--name=\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eRubocop Challenger\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--labels=\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"synConstant\"\u003erubocop challenge\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ein progress\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch3\u003e\u003ccode\u003e--template\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e作成される PR をカスタマイズしたい場合などあるかと思います。\nその場合は template に erb ファイルのパスを指定することが可能です。\u003c/p\u003e\n\n\u003cp\u003eデフォルトでは以下のテンプレートが使用されるので、必要に応じてカスタマイズしてご利用下さい 🙏\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/ryz310/rubocop_challenger/blob/master/lib/templates/default.md.erb\"\u003ehttps://github.com/ryz310/rubocop_challenger/blob/master/lib/templates/default.md.erb\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e使用例\u003c/h4\u003e\n\n\u003cpre class=\"code lang-sh\" data-lang=\"sh\" data-unlink\u003e$ bundle \u003cspan class=\"synStatement\"\u003eexec\u003c/span\u003e rubocop_challenger go \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--email=rubocop-challenger@example.com\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--name=\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eRubocop Challenger\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--template=./path/to/template.md.erb\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch3\u003e\u003ccode\u003e--no-regenerate-rubocop-todo\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e上述の通り、デフォルトでは auto-correct の後で \u003ccode\u003e$ rubocop --auto-gen-config\u003c/code\u003e を実行して .rubocop_todo.yml を再作成しています。これが不要な場合は no-regenerate-rubocop-todo オプションを指定します。\u003c/p\u003e\n\n\u003ch4\u003e使用例\u003c/h4\u003e\n\n\u003cpre class=\"code lang-sh\" data-lang=\"sh\" data-unlink\u003e$ bundle \u003cspan class=\"synStatement\"\u003eexec\u003c/span\u003e rubocop_challenger go \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--email=rubocop-challenger@example.com\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--name=\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e\u003cspan class=\"synConstant\"\u003eRubocop Challenger\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e\u0026quot;\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"synSpecial\"\u003e--no-regenerate-rubocop-todo\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch2\u003e既知の不具合 \u003cstrong\u003e(v1.2.0 で解消済み)\u003c/strong\u003e\u003c/h2\u003e\n\n\u003cp\u003eRuboCop のルールの中には \u003cstrong\u003eCop supports --auto-correct\u003c/strong\u003e と表記されているにも関わらず、部分的にしか auto-correct してくれないものがあります。\n例えば \u003ccode\u003eStyle/Semicolon\u003c/code\u003e が auto-correct できるのは行末に \u003ccode\u003e;\u003c/code\u003e が存在する場合だけのようです。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003eputs \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ehoge\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e; \u003cspan class=\"synComment\"\u003e# =\u0026gt; auto-correct される\u003c/span\u003e\nputs \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003efuga\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e; puts \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003epiyo\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e \u003cspan class=\"synComment\"\u003e# =\u0026gt; auto-correct されない\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eこのようなルールが auto-correct 対象に選ばれると、RubocopChallenger を実行した後も違反が解決されず、後続の \u003ccode\u003e$ rubocop --auto-gen-config\u003c/code\u003e で再度 \u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e に対象ルールが出てきてしまうので、 RubocopChallenger が機能しない状態になってしまいます。\n現状では \u003ccode\u003eStyle/Semicolon\u003c/code\u003e のようなルールに遭遇した場合は、手動で \u003ccode\u003e.rubocop.yml\u003c/code\u003e にルールを移動させる必要があります。\n\u003cdel\u003e今のところ RubocopChallenger 側での対策を思い付いていないので、もし良いアイデアがありましたら教えて下さい 🙏\u003c/del\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e2019/03/26 追記\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eRubocopChallenger v1.2.0 で Ignore リスト機能が追加されました。\nRubocopChallenger を実行した後も違反が解決されず、後続の \u003ccode\u003e$ rubocop --auto-gen-config\u003c/code\u003e で再度 \u003ccode\u003e.rubocop_todo.yml\u003c/code\u003e に対象ルールが出てきてしまった場合、 \u003ccode\u003e.rubocop_challenger.yml\u003c/code\u003e というファイルが作成され、対象ルールが Ignore リストに追加されます。\nIgnore リストに追加されたルールは次回以降、 RubocopChallenger の対象ルールとして選択されなくなるので、特に何もしなくとも運用を続けることが可能となります。\u003c/p\u003e\n\n\u003ch2\u003e最後に\u003c/h2\u003e\n\n\u003cp\u003e当初は \u003cstrong\u003e1669 行 195 種類\u003c/strong\u003e の違反ルールが .rubocop_todo.yml に存在していましたが、 RubocopChallenger を導入してから 3 ヶ月で \u003cstrong\u003e1187 行 132 種類\u003c/strong\u003e まで減らすことが出来ました。 auto-correct 可能な違反ルールはあと 62 種類残っているので、あと半分くらいまでは減らすことができそうです。\u003c/p\u003e\n\n\u003cp\u003e本記事では肥大化してしまった .rubocop_todo.yml を自動的に修正していく RubocopChallnger を紹介し、導入方法について解説させて頂きました。 .rubocop_todo.yml が肥大化して困っているプロジェクトで役立てて頂ければ幸いです 🙏\u003c/p\u003e\n\n\u003cp\u003eまた、利用してみてフィードバックなどあれば \u003ca href=\"https://github.com/ryz310/rubocop_challenger/issues\"\u003eIssue\u003c/a\u003e にてご連絡下さい。 GitHub では頑張って拙い英語を書くようにしていますが、日本語でも大丈夫です 🙆 PR も大歓迎です。どうぞ宜しくお願い致します 🙇\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr/\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\"\u003e\n\u003cp\u003eちなみに導入したのは自分です\u003ca href=\"#fnref:1\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n\n","contentSnippet":"どうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎若干釣り臭いタイトルですが、先日 RubocopChallenger という gem の v1.0.0 をリリースしたので紹介させて頂きます 🙏github.com経緯僕が所属している ソーシャルPLUS は 2012 年頃から開発が始まりました。Rails のプロダクトとしては古株の方だと思います。ソーシャルPLUS に RuboCop が導入されたのは 2017/02 頃 1 で、それまで特に RuboCop を意識したコードで開発を進めてこなかったので、巨大な .rubocop_todo.yml が出力され、それが手付かずのままになってしまっていました。ちなみに当初は 1669 行 195 種類 の違反ルールがありました。このままでは RuboCop の恩恵が受けられないので、 RuboCop Challenge と称して (以前 Ice Bucket Challenge が流行っていたので) 週イチで .rubocop_todo.yml から違反ルールを一つ消して、 auto-correct で修正する、という事をやっていたのですが、数ヶ月（数週間だったかも）ですっかりやるのを忘れてしまいました 😇最近また RuboCop Challenge を再開しよう、という流れになったのですが、手動でコツコツやるのも精神的にしんどくなって来たので、なんとか自動化したいな、という気持ちになり、手動でやっていた Rubocop Challenge を Ruby スクリプトで動かせるようにしました。最初は単純な Ruby スクリプトだったのですが、せっかくなので gem 化しよう、という事になり、作成したのが RubocopChallenger です。ところで、弊社エンジニアの id:masutaka26 が circleci-bundle-update-pr という CI を利用した Bundle Update の自動更新 gem を作成しています。github.comこれに感銘を受けて (？) 自分の RubocopChallenger も CI から$ rubocop --auto-correct を実行した結果が PR として届くような仕組みになっています。使い方2021-09-23 修正1. .circleci/config.yml の編集以下に設定例を紹介します。# .circleci/config.ymlversion: 2jobs:  rubocop_challenge:    docker:      - image: circleci/ruby:2.5-node-browsers    working_directory: ~/repo    steps:      - checkout      - run:          name: Rubocop Challenge          command: |            gem install rubocop_challenger            bundle exec rubocop_challenger go \\              --email={RubocopChallenger が commit する際の user email} \\              --name=\"{RubocopChallenger が commit する際の user name}\"workflows:  version: 2  nightly:    triggers:      - schedule:          cron: \"30 23 * * 1,2,3\" # この設定の場合、火水木 の毎朝 8:30 に RubocopChallnger の PR が届きます          filters:            branches:              only:                - master    jobs:      - rubocop_challengeインストールの際、 Gemfile に gem 'rubocop_challenger' を追記しないようにご注意下さい。他の gem との互換性問題により、 rubocop_challenger 実行中にエラーが発生するケースがあることを確認しております。2. GitHub personal access token の作成RubocopChallenger が PR を作成するために GitHub personal access token が必要になります。Settings から Generate new token をクリックして access token を作成します。Select Scopes では repo にチェック ✅ を入れて下さい。3. CircleCI で環境変数の設定今回は CircleCI での利用例を紹介します 🙏ダッシュボード画面 に移動し、 RubocopChallenger を適用したいアプリケーションの Project Settings -\u003e Environment Variables へと移動します。Add Variable をクリックして GITHUB_ACCESS_TOKEN という Key で先程作成した GitHub personal access token を設定します。5. 作成された PR の確認ここまでの手順を終えると、 CircleCI に指定したスケジュールで PR がされるようになると思います。後は auto-correct の内容を確認して、 merge するだけです。中には適用したくないルールも出てくると思いますが、その場合は .rubocop.yml にルールを再定義して auto-correct されないようにします。どんな PR が作成されるのか？ちょっと RubocopChallenger のバージョンが古い頃の物ですが、 以下のような PR が自動的に作成されます。デフォルトの設定では、 .rubocop_todo.yml の中から Cop supports --auto-correct かつ Offense count が最大 のルールを消して、 auto-correct した結果が PR として作成されます。また、 auto-correct の後で $ rubocop --auto-gen-config を実行して .rubocop_todo.yml を再作成しています。 RuboCop のバージョンが変わった時とかに .rubocop_todo.yml に出力される内容も若干変わっていたりするのですが、毎回最新の状態に作り直してくれるのがちょっと便利だったりします。ちなみに PR の Description に表示されている内容は 本家 RuboCop の RubyDoc に記載されている内容と同じものです。これを表示するのに地味に苦労しました 😓高度な設定RubocopChallnger にはいくつかオプションが用意されているので、ご紹介します。--mode上述の通り、デフォルトでは auto-correct の対象は Cop supports --auto-correct かつ Offense count が最大 のルールが選択されますが、 mode に渡す値によって対象を変更することが出来ます。most_occurrence (デフォルト)Offense count が最大 のルールを選択するleast_occurrenceOffense count が最小 のルールを選択するrandom全体からランダムに選択する使用例$ bundle exec rubocop_challenger go \\    --email=rubocop-challenger@example.com \\    --name=\"Rubocop Challenger\" \\    --mode=random --labelsRubocopChallnger が作成する PR に付与される label を指定します。デフォルトでは rubocop challenge というラベルが付与されます。ソーシャルPLUS では waffle.io を利用していたりするのですが、レビュー待ち状態の label を付与するようにすると見落としがなくて便利です。スペース区切りで複数指定することが出来ます。使用例$ bundle exec rubocop_challenger go \\    --email=rubocop-challenger@example.com \\    --name=\"Rubocop Challenger\" \\    --labels=\"rubocop challenge\" \"in progress\"--template作成される PR をカスタマイズしたい場合などあるかと思います。その場合は template に erb ファイルのパスを指定することが可能です。デフォルトでは以下のテンプレートが使用されるので、必要に応じてカスタマイズしてご利用下さい 🙏https://github.com/ryz310/rubocop_challenger/blob/master/lib/templates/default.md.erb使用例$ bundle exec rubocop_challenger go \\    --email=rubocop-challenger@example.com \\    --name=\"Rubocop Challenger\" \\    --template=./path/to/template.md.erb--no-regenerate-rubocop-todo上述の通り、デフォルトでは auto-correct の後で $ rubocop --auto-gen-config を実行して .rubocop_todo.yml を再作成しています。これが不要な場合は no-regenerate-rubocop-todo オプションを指定します。使用例$ bundle exec rubocop_challenger go \\    --email=rubocop-challenger@example.com \\    --name=\"Rubocop Challenger\" \\    --no-regenerate-rubocop-todo既知の不具合 (v1.2.0 で解消済み)RuboCop のルールの中には Cop supports --auto-correct と表記されているにも関わらず、部分的にしか auto-correct してくれないものがあります。例えば Style/Semicolon が auto-correct できるのは行末に ; が存在する場合だけのようです。puts 'hoge'; # =\u003e auto-correct されるputs 'fuga'; puts 'piyo' # =\u003e auto-correct されないこのようなルールが auto-correct 対象に選ばれると、RubocopChallenger を実行した後も違反が解決されず、後続の $ rubocop --auto-gen-config で再度 .rubocop_todo.yml に対象ルールが出てきてしまうので、 RubocopChallenger が機能しない状態になってしまいます。現状では Style/Semicolon のようなルールに遭遇した場合は、手動で .rubocop.yml にルールを移動させる必要があります。今のところ RubocopChallenger 側での対策を思い付いていないので、もし良いアイデアがありましたら教えて下さい 🙏2019/03/26 追記RubocopChallenger v1.2.0 で Ignore リスト機能が追加されました。RubocopChallenger を実行した後も違反が解決されず、後続の $ rubocop --auto-gen-config で再度 .rubocop_todo.yml に対象ルールが出てきてしまった場合、 .rubocop_challenger.yml というファイルが作成され、対象ルールが Ignore リストに追加されます。Ignore リストに追加されたルールは次回以降、 RubocopChallenger の対象ルールとして選択されなくなるので、特に何もしなくとも運用を続けることが可能となります。最後に当初は 1669 行 195 種類 の違反ルールが .rubocop_todo.yml に存在していましたが、 RubocopChallenger を導入してから 3 ヶ月で 1187 行 132 種類 まで減らすことが出来ました。 auto-correct 可能な違反ルールはあと 62 種類残っているので、あと半分くらいまでは減らすことができそうです。本記事では肥大化してしまった .rubocop_todo.yml を自動的に修正していく RubocopChallnger を紹介し、導入方法について解説させて頂きました。 .rubocop_todo.yml が肥大化して困っているプロジェクトで役立てて頂ければ幸いです 🙏また、利用してみてフィードバックなどあれば Issue にてご連絡下さい。 GitHub では頑張って拙い英語を書くようにしていますが、日本語でも大丈夫です 🙆 PR も大歓迎です。どうぞ宜しくお願い致します 🙇ちなみに導入したのは自分です↩","link":"https://developer.feedforce.jp/entry/2018/12/05/140000","isoDate":"2018-12-05T05:00:00.000Z","dateMiliSeconds":1543986000000,"imageUrl":"https://github.com/ryz310/rubocop_challenger/raw/master/images/generate_token.png","authorName":"ryz310"},{"title":"10 分でわかる Ruby Guild","content":"\u003cp\u003eどうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003eRubyKaigi 2018 から早 3 週間。この記事を読んでいる方でも参加された方が沢山いるのではないかと思います。\n個人的な感想ですが、今年は例年以上に充実していたんじゃないかな、と大満足です✨\u003c/p\u003e\n\n\u003cp\u003e感想記事はこちらの記事に詳しくまとめられています。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2018%2F06%2F22%2F141314\" title=\"RubyKaigi 2018 に行ってきたので今更所感などをまとめました - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2018/06/22/141314\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eさて、今回の RubyKaigi の発表では笹田さんから Guild の進捗についての発表がありました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"http://www.atdot.net/~ko1/activities/2018_rubykaigi2018.pdf\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20180621/20180621190557.png\" alt=\"Guild Prototype\" /\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこの Guild の概要について社内のメンバーに解説したところ中々に好評だったので、今回の記事では Guild とはどういうものなのかを超ざっくりですがご紹介します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#そもそも論なぜ-Guild-が必要なのか\"\u003eそもそも論。なぜ Guild が必要なのか？\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Guild-と-Thread-の関係\"\u003eGuild と Thread の関係\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Guild-間のデータの受け渡し\"\u003eGuild 間のデータの受け渡し\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#おわりに\"\u003eおわりに\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"そもそも論なぜ-Guild-が必要なのか\"\u003eそもそも論。なぜ Guild が必要なのか？\u003c/h1\u003e\n\n\u003cp\u003eご存知の方も多いかと思いますが、現在の Ruby のスレッド処理はマルチコアに対応していません。\n最近の PC の殆どにはマルチコア CPU が搭載されていると思いますが、１つの Ruby プロセスが利用できるコアは１つだけです。つまり、並列処理と言っても複数の処理を時間分割して実行しているだけという事になります。 Guild は Ruby でマルチコアを使った並列処理を実現するために必要な機能となります。\u003c/p\u003e\n\n\u003cp\u003eちなみに Guild という名称はあくまでコードネームであるため、リリース時には別の名称になると思われます。\u003c/p\u003e\n\n\u003ch1 id=\"Guild-と-Thread-の関係\"\u003eGuild と Thread の関係\u003c/h1\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20180621/20180621191002.png\" alt=\"f:id:ryz310:20180621191002p:plain\" title=\"f:id:ryz310:20180621191002p:plain\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e上図のように Guild に Thread が内包される関係になり、プロセス全体でいうと \u003ccode\u003eRubyVM → Guild → Thread → Fiber\u003c/code\u003e という関係になります。\nこれを踏まえて、 Guild 導入の前後を図に起こすと以下のようになります（雑な図で恐縮です。。🙇）\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20180621/20180621183710.jpg\" alt=\"f:id:ryz310:20180621183710j:plain\" title=\"f:id:ryz310:20180621183710j:plain\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e同一 Guild 内の Thread は従来どおりシングルコアで動作します。しかし、 Guild を複数定義することで、それぞれの Guild に所属する Thread は並列に動作するようになります。\nGuild が実装されていない現在の Ruby は \u003ccode\u003eRubyVM → Thread → Fiber\u003c/code\u003e という関係になりますが、言い換えればこれは単一の Guild で作られた Ruby プログラムとみなせると思います。\nこのことから、Guild が実装されても後方互換性は保たれるのではないか予想されます。\u003c/p\u003e\n\n\u003ch1 id=\"Guild-間のデータの受け渡し\"\u003eGuild 間のデータの受け渡し\u003c/h1\u003e\n\n\u003cp\u003eGuild 間でのデータ受け渡しについて、 Shareable Object と Non-Shareable Object という概念が出てきます。\n詳細は \u003ca href=\"http://www.atdot.net/~ko1/activities/2018_rubykaigi2018.pdf\"\u003e発表スライド\u003c/a\u003e を見てもらうとして、大雑把に両者の違いを説明すると以下のようになります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eShareable Object\n\n\u003cul\u003e\n\u003cli\u003eGuild 間でデータ共有が可能なオブジェクト\u003c/li\u003e\n\u003cli\u003e基本的に値が変化しない Immutable なデータがこれに該当する\n\n\u003cul\u003e\n\u003cli\u003eConst や Freeze したデータのこと\u003c/li\u003e\n\u003cli\u003eただし Array や Hash は Freeze しても内側のデータまで Freeze されないので、 Shareable とはならないので注意\n\n\u003cul\u003e\n\u003cli\u003eこれについては Deep Freeze を実装するかも、とのこと。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e他にも Isolated Proc という、ブロックの外側の変数へのアクセスを禁止した Proc もこれに該当しますが、詳細は割愛\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eNon-Shareable Object\n\n\u003cul\u003e\n\u003cli\u003eGuild 間でデータ共有が禁止されているオブジェクト\n\n\u003cul\u003e\n\u003cli\u003eデータの受け渡しができない訳ではない（詳しくは後述）\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e主に一般的な変数のこと\u003c/li\u003e\n\u003cli\u003e単一の Guild にのみ所属する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eShareable Object は Immutable (値が変化しない)オブジェクトなので、並列処理中にデータを共有しても問題ないことはイメージしやすいかと思います。\n重要なのは Non-Shareable Object の受け渡しで、以下に示す 2 つの方法があります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eCOPY\n\n\u003cul\u003e\n\u003cli\u003eデータを Guild 間で共有するのではなく、別の Guild にコピーして渡す\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eMOVE\n\n\u003cul\u003e\n\u003cli\u003e別の Guild にデータを渡すと、元の Guild からは見えなくなる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eCOPY は参照渡しではなく実体渡しなので、１つのデータに対して同時アクセスすることにはならず、 Thread-Safe なやりとりになります。\n一方の MOVE は、データを別の Guild に渡すと元の Guild からはアクセスできなくなる、カットアンドペーストのような振る舞いになります。\nこちらも同時アクセスが発生しないため、 Thread-Safe なやりとりになります。\u003c/p\u003e\n\n\u003cp\u003eちなみに MOVE より COPY が利用されるケースが多いだろうとのことでした。\u003c/p\u003e\n\n\u003ch1 id=\"おわりに\"\u003eおわりに\u003c/h1\u003e\n\n\u003cp\u003eRubyKaigi 2018 で発表された Guild について超ざっくりと説明してみました。間違ってるところがあればご指摘頂けますと幸いです🙏\nなお、開発中の仕様なので実装までにいくつかの変更があるかもしれません。\u003c/p\u003e\n\n\u003cp\u003e想像ですが、 Sidekiq とか Puma のような Thread ベースのサービスは Guild が導入されたら劇的にパフォーンスが良くなるかもしれませんね。\nこれからの Ruby の可能性に期待が高まります✨\u003c/p\u003e\n","contentSnippet":"どうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎RubyKaigi 2018 から早 3 週間。この記事を読んでいる方でも参加された方が沢山いるのではないかと思います。個人的な感想ですが、今年は例年以上に充実していたんじゃないかな、と大満足です✨感想記事はこちらの記事に詳しくまとめられています。developer.feedforce.jpさて、今回の RubyKaigi の発表では笹田さんから Guild の進捗についての発表がありました。この Guild の概要について社内のメンバーに解説したところ中々に好評だったので、今回の記事では Guild とはどういうものなのかを超ざっくりですがご紹介します。そもそも論。なぜ Guild が必要なのか？Guild と Thread の関係Guild 間のデータの受け渡しおわりにそもそも論。なぜ Guild が必要なのか？ご存知の方も多いかと思いますが、現在の Ruby のスレッド処理はマルチコアに対応していません。最近の PC の殆どにはマルチコア CPU が搭載されていると思いますが、１つの Ruby プロセスが利用できるコアは１つだけです。つまり、並列処理と言っても複数の処理を時間分割して実行しているだけという事になります。 Guild は Ruby でマルチコアを使った並列処理を実現するために必要な機能となります。ちなみに Guild という名称はあくまでコードネームであるため、リリース時には別の名称になると思われます。Guild と Thread の関係上図のように Guild に Thread が内包される関係になり、プロセス全体でいうと RubyVM → Guild → Thread → Fiber という関係になります。これを踏まえて、 Guild 導入の前後を図に起こすと以下のようになります（雑な図で恐縮です。。🙇）同一 Guild 内の Thread は従来どおりシングルコアで動作します。しかし、 Guild を複数定義することで、それぞれの Guild に所属する Thread は並列に動作するようになります。Guild が実装されていない現在の Ruby は RubyVM → Thread → Fiber という関係になりますが、言い換えればこれは単一の Guild で作られた Ruby プログラムとみなせると思います。このことから、Guild が実装されても後方互換性は保たれるのではないか予想されます。Guild 間のデータの受け渡しGuild 間でのデータ受け渡しについて、 Shareable Object と Non-Shareable Object という概念が出てきます。詳細は 発表スライド を見てもらうとして、大雑把に両者の違いを説明すると以下のようになります。Shareable ObjectGuild 間でデータ共有が可能なオブジェクト基本的に値が変化しない Immutable なデータがこれに該当するConst や Freeze したデータのことただし Array や Hash は Freeze しても内側のデータまで Freeze されないので、 Shareable とはならないので注意これについては Deep Freeze を実装するかも、とのこと。他にも Isolated Proc という、ブロックの外側の変数へのアクセスを禁止した Proc もこれに該当しますが、詳細は割愛Non-Shareable ObjectGuild 間でデータ共有が禁止されているオブジェクトデータの受け渡しができない訳ではない（詳しくは後述）主に一般的な変数のこと単一の Guild にのみ所属するShareable Object は Immutable (値が変化しない)オブジェクトなので、並列処理中にデータを共有しても問題ないことはイメージしやすいかと思います。重要なのは Non-Shareable Object の受け渡しで、以下に示す 2 つの方法があります。COPYデータを Guild 間で共有するのではなく、別の Guild にコピーして渡すMOVE別の Guild にデータを渡すと、元の Guild からは見えなくなるCOPY は参照渡しではなく実体渡しなので、１つのデータに対して同時アクセスすることにはならず、 Thread-Safe なやりとりになります。一方の MOVE は、データを別の Guild に渡すと元の Guild からはアクセスできなくなる、カットアンドペーストのような振る舞いになります。こちらも同時アクセスが発生しないため、 Thread-Safe なやりとりになります。ちなみに MOVE より COPY が利用されるケースが多いだろうとのことでした。おわりにRubyKaigi 2018 で発表された Guild について超ざっくりと説明してみました。間違ってるところがあればご指摘頂けますと幸いです🙏なお、開発中の仕様なので実装までにいくつかの変更があるかもしれません。想像ですが、 Sidekiq とか Puma のような Thread ベースのサービスは Guild が導入されたら劇的にパフォーンスが良くなるかもしれませんね。これからの Ruby の可能性に期待が高まります✨","link":"https://developer.feedforce.jp/entry/2018/06/25/100000","isoDate":"2018-06-25T01:00:00.000Z","dateMiliSeconds":1529888400000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20180621/20180621190557.png","authorName":"ryz310"},{"title":"続・Rails 5.2 開発環境を Docker で構築する","content":"\u003cp\u003eどうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003e前回の記事では Docker を使って Rails 5.2 の環境構築をしました。\n現在も引き続き Docker についてのお話をします。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2018%2F02%2F11%2F140012\" title=\"Rails 5.2 開発環境を Docker で構築する - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://developer.feedforce.jp/entry/2018/02/11/140012\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eその後も幾つか手を加え続けておりまして、現在この記事を書いている時点で \u003ccode\u003ev1.3.0\u003c/code\u003e になりました 🎉\n明らかに初回のナンバリングを間違えていた感がありますが、少しずつインクリメントさせていく楽しみを実感できて良いです 笑\u003c/p\u003e\n\n\u003ch2\u003e前回からの変更点について\u003c/h2\u003e\n\n\u003cp\u003eさて、前回の記事は \u003ccode\u003ev1.0.0\u003c/code\u003e 時点のものでしたが、ここで \u003ccode\u003ev1.3.0\u003c/code\u003e になった現在の \u003ccode\u003eDockerfile\u003c/code\u003e を見てみましょう。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# Dockerfile\nFROM ryz310/rails-on-docker\u003c/pre\u003e\n\n\n\u003cp\u003eなんと！たったの１行ぽっちです！＼＼\\٩( 'ω' )و //／／\u003c/p\u003e\n\n\u003cp\u003e何言ってんだコイツと思われそうですが、これはどういう事かというと、大部分を \u003ccode\u003ebase/Dockerfile\u003c/code\u003e に移動したためです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# base/Dockerfile\nFROM ruby:2.5\nMAINTAINER ryz310@gmail.com\n\nRUN apt-get update -qq \u0026amp;\u0026amp; apt-get install -y build-essential libpq-dev nodejs\n\nWORKDIR /myapp\nENV BUNDLE_JOBS=32\n\nONBUILD ADD Gemfile /myapp/Gemfile\nONBUILD ADD Gemfile.lock /myapp/Gemfile.lock\nONBUILD RUN bundle install\nONBUILD ADD . /myapp\u003c/pre\u003e\n\n\n\u003cp\u003eこの \u003ccode\u003ebase/Dockerfile\u003c/code\u003e のイメージは \u003ca href=\"https://hub.docker.com/r/ryz310/rails-on-docker/\"\u003e僕のDocker Hub\u003c/a\u003e に置いてあります。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eONBUILD\u003c/code\u003e が付いたコマンドはこのイメージを継承したイメージで実行されるため、先ほどの \u003ccode\u003eDockerfile\u003c/code\u003e には \u003ccode\u003eFROM\u003c/code\u003e しかありませんが、ビルドの際には以下の 4 つのコマンドが実行される事になります。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eADD Gemfile /myapp/Gemfile\nADD Gemfile.lock /myapp/Gemfile.lock\nRUN bundle install\nADD . /myapp\u003c/pre\u003e\n\n\n\u003cp\u003e感覚としては、 \u003ccode\u003ebase/Dockerfile\u003c/code\u003e で Rails の起動に必要なサーバー環境を構築して、 \u003ccode\u003eDockerfile\u003c/code\u003e で Rails そのものを構築していくような感じです。\nRails の構築には RDS イメージなども必須となってきますので、それについては \u003ccode\u003edocker-compose.yml\u003c/code\u003e と組み合わせて構築していきます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# docker-compose.yml\nversion: \u0026#39;3\u0026#39;\nservices:\n  db:\n    image: mysql:5.7\n    volumes:\n      - mysql_data:/var/lib/mysql\n    environment:\n      MYSQL_ALLOW_EMPTY_PASSWORD: \u0026#39;yes\u0026#39;\n    ports:\n      - \u0026#34;3306:3306\u0026#34;\n  web:\n    build: .\n    image: web_image\n    command: bundle exec rails s -p 3000 -b \u0026#39;0.0.0.0\u0026#39;\n    volumes:\n      - .:/myapp\n      - bundle:/usr/local/bundle\n    ports:\n      - \u0026#34;3000:3000\u0026#34;\n    depends_on:\n      - db\n    environment:\n      DB_HOST: db\n  spring:\n    image: web_image\n    command: bundle exec spring server\n    volumes:\n      - .:/myapp\n      - bundle:/usr/local/bundle\n    tty: false\n    stdin_open: false\n    environment:\n      DB_HOST: db\nvolumes:\n  mysql_data:\n  bundle:\u003c/pre\u003e\n\n\n\u003cp\u003eここも \u003ccode\u003ev1.0.0\u003c/code\u003e の頃からいくつか変更がありまして、例えば \u003ccode\u003eweb\u003c/code\u003e と \u003ccode\u003espring\u003c/code\u003e で同じ内容になるように \u003ccode\u003ev1.0.0\u003c/code\u003e では YAML のエイリアスを使っていたのですが、 docker image で共有する方法に変えました。この定義の記述について少し補足します。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eweb\u003c/code\u003e の定義で \u003ccode\u003ebuild: .\u003c/code\u003e と \u003ccode\u003eimage: web_image\u003c/code\u003e と言う記述がありますが、これは Dockerfile をビルドして \u003ccode\u003eweb_image\u003c/code\u003e というタグをつける、と言う振る舞いになります。一方、 \u003ccode\u003espring\u003c/code\u003e の定義の \u003ccode\u003eimage: web_image\u003c/code\u003e では \u003ccode\u003eweb_image\u003c/code\u003e というタグが付いたイメージを使用する、という振る舞いになります。この辺はなんだかややこしいですね 😓\u003c/p\u003e\n\n\u003cp\u003eまた、 \u003ccode\u003ebundle:/usr/local/bundle\u003c/code\u003e を volume に指定する事で、\u003ccode\u003ebundle install\u003c/code\u003e の内容を永続化するようにしてあります。これにより、\u003ccode\u003e$ docker-compose run --rm web bundle install\u003c/code\u003e というコマンドが有効になってくるので、Gemfile を更新した際に一から Build する必要がなくなります。\n同様に、 MySQL も \u003ccode\u003emysql_data:/var/lib/mysql\u003c/code\u003e を volume に指定する事で、テーブルの内容を永続化するようにしています。\u003c/p\u003e\n\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eONBUILD\u003c/code\u003e を使用する事で、他の Rails アプリでも同じイメージを転用できるようになったのが一番の改善点ではないかと思います。\u003c/p\u003e\n\n\u003cp\u003eただ、Rails アプリ側の事情で何か \u003ccode\u003e$ apt-get install\u003c/code\u003e を加えたくなった場合にどうするのか、という課題感があります。\u003ccode\u003ebase/Dockerfile\u003c/code\u003e は汎用的な環境構築を意識しているので、あまり一般的でないインストールは行いたくありません。理想としては「子イメージ」で \u003ccode\u003e$ apt-get install\u003c/code\u003e させて、「孫イメージ」で今回のように Rails の構築をする構成が実現できれば良いのではないかと思いますが、 \u003ccode\u003eONBUILD\u003c/code\u003e を「子イメージ」でスキップさせるとか出来るんでしょうか？\u003c/p\u003e\n\n\u003cp\u003e次回はこの辺について少し調べていければ、と思っています。\u003c/p\u003e\n","contentSnippet":"どうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎前回の記事では Docker を使って Rails 5.2 の環境構築をしました。現在も引き続き Docker についてのお話をします。developer.feedforce.jpその後も幾つか手を加え続けておりまして、現在この記事を書いている時点で v1.3.0 になりました 🎉明らかに初回のナンバリングを間違えていた感がありますが、少しずつインクリメントさせていく楽しみを実感できて良いです 笑前回からの変更点についてさて、前回の記事は v1.0.0 時点のものでしたが、ここで v1.3.0 になった現在の Dockerfile を見てみましょう。# DockerfileFROM ryz310/rails-on-dockerなんと！たったの１行ぽっちです！＼＼\\٩( 'ω' )و //／／何言ってんだコイツと思われそうですが、これはどういう事かというと、大部分を base/Dockerfile に移動したためです。# base/DockerfileFROM ruby:2.5MAINTAINER ryz310@gmail.comRUN apt-get update -qq \u0026\u0026 apt-get install -y build-essential libpq-dev nodejsWORKDIR /myappENV BUNDLE_JOBS=32ONBUILD ADD Gemfile /myapp/GemfileONBUILD ADD Gemfile.lock /myapp/Gemfile.lockONBUILD RUN bundle installONBUILD ADD . /myappこの base/Dockerfile のイメージは 僕のDocker Hub に置いてあります。ONBUILD が付いたコマンドはこのイメージを継承したイメージで実行されるため、先ほどの Dockerfile には FROM しかありませんが、ビルドの際には以下の 4 つのコマンドが実行される事になります。ADD Gemfile /myapp/GemfileADD Gemfile.lock /myapp/Gemfile.lockRUN bundle installADD . /myapp感覚としては、 base/Dockerfile で Rails の起動に必要なサーバー環境を構築して、 Dockerfile で Rails そのものを構築していくような感じです。Rails の構築には RDS イメージなども必須となってきますので、それについては docker-compose.yml と組み合わせて構築していきます。# docker-compose.ymlversion: '3'services:  db:    image: mysql:5.7    volumes:      - mysql_data:/var/lib/mysql    environment:      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'    ports:      - \"3306:3306\"  web:    build: .    image: web_image    command: bundle exec rails s -p 3000 -b '0.0.0.0'    volumes:      - .:/myapp      - bundle:/usr/local/bundle    ports:      - \"3000:3000\"    depends_on:      - db    environment:      DB_HOST: db  spring:    image: web_image    command: bundle exec spring server    volumes:      - .:/myapp      - bundle:/usr/local/bundle    tty: false    stdin_open: false    environment:      DB_HOST: dbvolumes:  mysql_data:  bundle:ここも v1.0.0 の頃からいくつか変更がありまして、例えば web と spring で同じ内容になるように v1.0.0 では YAML のエイリアスを使っていたのですが、 docker image で共有する方法に変えました。この定義の記述について少し補足します。web の定義で build: . と image: web_image と言う記述がありますが、これは Dockerfile をビルドして web_image というタグをつける、と言う振る舞いになります。一方、 spring の定義の image: web_image では web_image というタグが付いたイメージを使用する、という振る舞いになります。この辺はなんだかややこしいですね 😓また、 bundle:/usr/local/bundle を volume に指定する事で、bundle install の内容を永続化するようにしてあります。これにより、$ docker-compose run --rm web bundle install というコマンドが有効になってくるので、Gemfile を更新した際に一から Build する必要がなくなります。同様に、 MySQL も mysql_data:/var/lib/mysql を volume に指定する事で、テーブルの内容を永続化するようにしています。まとめONBUILD を使用する事で、他の Rails アプリでも同じイメージを転用できるようになったのが一番の改善点ではないかと思います。ただ、Rails アプリ側の事情で何か $ apt-get install を加えたくなった場合にどうするのか、という課題感があります。base/Dockerfile は汎用的な環境構築を意識しているので、あまり一般的でないインストールは行いたくありません。理想としては「子イメージ」で $ apt-get install させて、「孫イメージ」で今回のように Rails の構築をする構成が実現できれば良いのではないかと思いますが、 ONBUILD を「子イメージ」でスキップさせるとか出来るんでしょうか？次回はこの辺について少し調べていければ、と思っています。","link":"https://developer.feedforce.jp/entry/2018/02/25/234556","isoDate":"2018-02-25T14:45:56.000Z","dateMiliSeconds":1519569956000,"imageUrl":"https://cdn.user.blog.st-hatena.com/default_entry_og_image/116461321/1514251518718655","authorName":"ryz310"},{"title":"Rails 5.2 開発環境を Docker で構築する","content":"\u003cp\u003eどうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003e僕が所属している \u003ca href=\"https://socialplus.jp/\"\u003eソーシャルPLUS\u003c/a\u003e チームでは Rails の開発環境を Docker で構築しています。\n自分も日々お世話になっている Docker ですが、イチから Dockerfile 書いた事が無かったので、やってみました。\u003c/p\u003e\n\n\u003cp\u003eこちらのチュートリアルを参考にしています。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"http://docs.docker.jp/compose/rails.html\"\u003e\u0026#x30AF;\u0026#x30A4;\u0026#x30C3;\u0026#x30AF;\u0026#x30B9;\u0026#x30BF;\u0026#x30FC;\u0026#x30C8;\u0026#x30FB;\u0026#x30AC;\u0026#x30A4;\u0026#x30C9;\u0026#xFF1A;Docker Compose \u0026#x3068; Rails \u0026mdash; Docker-docs-ja 17.06.Beta \u0026#x30C9;\u0026#x30AD;\u0026#x30E5;\u0026#x30E1;\u0026#x30F3;\u0026#x30C8;\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003eやってみた✨\u003c/h1\u003e\n\n\u003cp\u003e早速ですがこちらが完成品の GitHub リポジトリになります。\n\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fryz310%2Frails-on-docker%2Ftree%2Fv1.0.0\" title=\"ryz310/rails-on-docker\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/ryz310/rails-on-docker/tree/v1.0.0\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eこの記事は \u003ccode\u003ev1.0.0\u003c/code\u003e 時点で書いていますが、リポジトリは今後も更新されていく可能性があります。\u003c/p\u003e\n\n\u003ch2\u003e環境\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003eDebian Stretch\u003c/li\u003e\n\u003cli\u003eRuby 2.5.0\u003c/li\u003e\n\u003cli\u003eRails 5.2.0.rc1\u003c/li\u003e\n\u003cli\u003eMySQL 5.7\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch2\u003eつかいかた\u003c/h2\u003e\n\n\u003cp\u003eRails 5.2 で環境構築したと言いましたが、リポジトリには Rails のソースコードが一切含まれていません。\nこれは \u003ccode\u003erails new\u003c/code\u003e から Docker でやっていくためです。\n以下に手順を示しますので、興味ある方はぜひ記事を読みながら一緒にやってみて下さい 🙏\u003c/p\u003e\n\n\u003ch3\u003e0. リポジトリをローカルにクローンする\u003c/h3\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e$ git clone https://github.com/ryz310/rails-on-docker.git\u003c/pre\u003e\n\n\n\u003ch3\u003e1. 以下のコマンドを実行する\u003c/h3\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e$ docker-compose run web rails new . --force --database=mysql --skip-bundle --skip-git\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003erails new\u003c/code\u003e によって必要なファイルがインストールされます。同時に Gemfile も Rails 用に更新されます。\n残念ながらアプリ名は指定できないので、必要に応じて変更して下さい。\u003c/p\u003e\n\n\u003cp\u003eなお、後述の MySQL データの永続化のため MySQL のデータファイルを含めないようにリポジトリの方で \u003ccode\u003e.gitignore\u003c/code\u003e を用意しています。\nそのため \u003ccode\u003e--skip-git\u003c/code\u003e を付けて Rails に \u003ccode\u003e.gitignore\u003c/code\u003e ファイルを作成させないようにしていますが、永続化が不用な場合はオプションを外して下さい。\u003c/p\u003e\n\n\u003ch3\u003e2. 更新された \u003ccode\u003eGemfile\u003c/code\u003e で以下のコメントアウトを外す\u003c/h3\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# gem \u0026#39;mini_racer\u0026#39;, platforms: :ruby\u003c/pre\u003e\n\n\n\u003cp\u003e以前であれば \u003ccode\u003etherubyracer\u003c/code\u003e だったのですが、いつの間にか \u003ccode\u003emini_racer\u003c/code\u003e に変わっていたのですね。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Ftechracho.bpsinc.jp%2Fhachi8833%2F2017_06_09%2F41039\" title=\"週刊Railsウォッチ（20170609）ついにtherubyracerからmini_racerへ、注意しないとハマるgem、5.1でのVue.jsとTurbolinksの共存ほか\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://techracho.bpsinc.jp/hachi8833/2017_06_09/41039\"\u003etechracho.bpsinc.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eTechRacho さんの週刊Railsウォッチにはいつもお世話になっております 🙏\u003c/p\u003e\n\n\u003ch3\u003e3. \u003ccode\u003e$ docker-compose build\u003c/code\u003e を実行する\u003c/h3\u003e\n\n\u003cp\u003eGemfile を変更したので再読イメージを作り直します。\u003c/p\u003e\n\n\u003ch3\u003e4. \u003ccode\u003econfig/database.yml\u003c/code\u003e を以下のように変更する\u003c/h3\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003edefault: \u0026amp;default\n  adapter: mysql2\n  encoding: utf8\n  pool: \u0026lt;%= ENV.fetch(\u0026#34;RAILS_MAX_THREADS\u0026#34;) { 5 } %\u0026gt;\n  username: root\n  password: xxxxxx # \u0026lt;- ここを変更\n  host: db # \u0026lt;- ここを変更\u003c/pre\u003e\n\n\n\u003cp\u003eあくまでローカルの開発環境構築なのでパスワードを隠したりとかはしません。本番運用とかでやっちゃダメですよ！\nMySQL の Root ユーザーのパスワードは \u003ccode\u003edocker-compose.yml\u003c/code\u003e で指定しています。必要に応じて書き換えて下さい。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e  db:\n    image: mysql:5.7\n    volumes:\n      - .mysql_data:/var/lib/mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: xxxxxx # \u0026lt;- ここ！\u003c/pre\u003e\n\n\n\u003ch3\u003e5. \u003ccode\u003e$ docker-compose up\u003c/code\u003e を実行する\u003c/h3\u003e\n\n\u003cp\u003eコンテナを起動させます。\u003c/p\u003e\n\n\u003ch3\u003e6. \u003ccode\u003e$ docker-compose exec spring spring rake db:create\u003c/code\u003e を実行する\u003c/h3\u003e\n\n\u003cp\u003eコンテナは起動していますが、Rails で使用する DB テーブルはまだ作成されていないので作成します。\n何気に \u003ccode\u003espring\u003c/code\u003e を使っている点に注目です。\u003c/p\u003e\n\n\u003ch3\u003e7. \u003ca href=\"http://localhost:3000/\"\u003ehttp://localhost:3000/\u003c/a\u003e にアクセスして Rails が動いていることを確認\u003c/h3\u003e\n\n\u003cp\u003eここまでの操作で Rails が正しく動作しているはずです。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20180211/20180211110115.png\" alt=\"f:id:ryz310:20180211110115p:plain\" title=\"f:id:ryz310:20180211110115p:plain\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eYay! You’re on Rails!\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003ch1\u003eポイント\u003c/h1\u003e\n\n\u003ch2\u003e\u003ccode\u003ebundle install\u003c/code\u003e が毎回走らないように工夫している\u003c/h2\u003e\n\n\u003cp\u003eDockerfile で WORKDIR に \u003ccode\u003e/tmp\u003c/code\u003e ディレクトリを指定しているところがポイントです。\nこれをせずに \u003ccode\u003eWORKDIR /myapp\u003c/code\u003e からの \u003ccode\u003eADD . /myapp\u003c/code\u003e をやってしまうと、 Rails のコードに変更がある度に \u003ccode\u003ebundle install\u003c/code\u003e が最初から実行されてしまいます。\nGemfile と Gemfile.lock を \u003ccode\u003e/tmp\u003c/code\u003e に格納することで、これらのファイルに変更がない限り \u003ccode\u003ebundle install\u003c/code\u003e が実行されないようになっています。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eWORKDIR /tmp\nADD Gemfile Gemfile\nADD Gemfile.lock Gemfile.lock\nRUN bundle install\nWORKDIR /myapp\nADD . /myapp\u003c/pre\u003e\n\n\n\u003cp\u003e参考: \u003ca href=\"https://easyramble.com/rails-development-on-docker.html#crayon-5a7fa9761d5ba051809395\"\u003eDocker\u0026#x3067;Rails + MySQL\u0026#x306E;\u0026#x958B;\u0026#x767A;\u0026#x74B0;\u0026#x5883;\u0026#x3092;\u0026#x69CB;\u0026#x7BC9; | EasyRamble\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\u003ccode\u003espring\u003c/code\u003e に対応\u003c/h2\u003e\n\n\u003cp\u003eRails で開発する上で欠かせない \u003ccode\u003espring\u003c/code\u003e も利用できるようにしてあります。\n前述の \u003ccode\u003erake db:create\u003c/code\u003e の時にも出てきましたが、\u003ccode\u003e$ docker-compose exec spring spring rails console\u003c/code\u003e のようにして使います。\n\u003ccode\u003espring\u003c/code\u003e が 2 回出てくるところがポイントです。一つ目はコンテナのサービス名です。\u003c/p\u003e\n\n\u003cp\u003e毎回書くのはだるいので僕は alias にしています。fish shell 用なので良いように読み替えて下さい 🙏\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# ~/.config/fish/config.fish\n\n# docker-compose aliases\nfunction fig\n  docker-compose $argv\nend\n\nfunction figspring\n  docker-compose exec spring spring $argv\nend\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# USAGE\n$ figspring rails c\u003c/pre\u003e\n\n\n\u003cp\u003e参考: \u003ca href=\"https://qiita.com/kawasin73/items/2253523be18e5afd994f\"\u003e\u0026#x9AD8;\u0026#x901F;\u0026#x306B;\u0026#x958B;\u0026#x767A;\u0026#x3067;\u0026#x304D;\u0026#x308B; Docker + Rails\u0026#x958B;\u0026#x767A;\u0026#x74B0;\u0026#x5883;\u0026#x306E;\u0026#x30C6;\u0026#x30F3;\u0026#x30D7;\u0026#x30EC;\u0026#x30FC;\u0026#x30C8;\u0026#x3092;\u0026#x4F5C;\u0026#x3063;\u0026#x305F; - Qiita\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003eMySQL データの永続化\u003c/h2\u003e\n\n\u003cp\u003eイメージを作り直した時に MySQL のデータが失われてしまうのは辛いものがあります。\n毎回テスト用のデータを一から作り直したくないので、 \u003ccode\u003edocker-compose.yml\u003c/code\u003e で以下のように指定してMySQL のデータを永続化させています。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e  db:\n    image: mysql:5.7\n    volumes:\n      - .mysql_data:/var/lib/mysql # \u0026lt;- これ！\n    environment:\n      MYSQL_ROOT_PASSWORD: xxxxxx\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003e.mysql_data\u003c/code\u003e ディレクトリ以下に MySQL のデータが格納されています。リポジトリの \u003ccode\u003e.gitignore\u003c/code\u003e で無視させています。\n試していませんが、参考にさせて頂いた記事によると Docker for Mac 以外の環境では問題が発生するようですのでご注意下さい。\n対応方法も記事内で紹介されています 🙏\u003c/p\u003e\n\n\u003cp\u003e参考: \u003ca href=\"https://blog.leko.jp/post/how-to-mount-data-volume-to-local-with-docker-compose/\"\u003edocker compose\u0026#x3067;MySQL\u0026#x306E;\u0026#x30C7;\u0026#x30FC;\u0026#x30BF;\u0026#x9818;\u0026#x57DF;\u0026#x3092;\u0026#x30ED;\u0026#x30FC;\u0026#x30AB;\u0026#x30EB;\u0026#x306B;\u0026#x30DE;\u0026#x30A6;\u0026#x30F3;\u0026#x30C8;\u0026#x3059;\u0026#x308B; | WEB EGG\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003e週末に何かアプリでも書こうかと思った時に、ついでに Docker で環境構築もやっちゃうか、と思い立って書きました。\nそうこうしてるうちに週末の半分くらいが過ぎ去っていますが、きっと今後は捗るはず。。 😇\n何度も確認していますが、もし間違っている点、不便な点などありましたらそっと教えて頂けますと幸いです 🙏\nFork も大歓迎ですし、誰かに使ってもらえると嬉しいです 😁\u003c/p\u003e\n","contentSnippet":"どうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎僕が所属している ソーシャルPLUS チームでは Rails の開発環境を Docker で構築しています。自分も日々お世話になっている Docker ですが、イチから Dockerfile 書いた事が無かったので、やってみました。こちらのチュートリアルを参考にしています。クイックスタート・ガイド：Docker Compose と Rails — Docker-docs-ja 17.06.Beta ドキュメントやってみた✨早速ですがこちらが完成品の GitHub リポジトリになります。github.comこの記事は v1.0.0 時点で書いていますが、リポジトリは今後も更新されていく可能性があります。環境Debian StretchRuby 2.5.0Rails 5.2.0.rc1MySQL 5.7つかいかたRails 5.2 で環境構築したと言いましたが、リポジトリには Rails のソースコードが一切含まれていません。これは rails new から Docker でやっていくためです。以下に手順を示しますので、興味ある方はぜひ記事を読みながら一緒にやってみて下さい 🙏0. リポジトリをローカルにクローンする$ git clone https://github.com/ryz310/rails-on-docker.git1. 以下のコマンドを実行する$ docker-compose run web rails new . --force --database=mysql --skip-bundle --skip-gitrails new によって必要なファイルがインストールされます。同時に Gemfile も Rails 用に更新されます。残念ながらアプリ名は指定できないので、必要に応じて変更して下さい。なお、後述の MySQL データの永続化のため MySQL のデータファイルを含めないようにリポジトリの方で .gitignore を用意しています。そのため --skip-git を付けて Rails に .gitignore ファイルを作成させないようにしていますが、永続化が不用な場合はオプションを外して下さい。2. 更新された Gemfile で以下のコメントアウトを外す# gem 'mini_racer', platforms: :ruby以前であれば therubyracer だったのですが、いつの間にか mini_racer に変わっていたのですね。techracho.bpsinc.jpTechRacho さんの週刊Railsウォッチにはいつもお世話になっております 🙏3. $ docker-compose build を実行するGemfile を変更したので再読イメージを作り直します。4. config/database.yml を以下のように変更するdefault: \u0026default  adapter: mysql2  encoding: utf8  pool: \u003c%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %\u003e  username: root  password: xxxxxx # \u003c- ここを変更  host: db # \u003c- ここを変更あくまでローカルの開発環境構築なのでパスワードを隠したりとかはしません。本番運用とかでやっちゃダメですよ！MySQL の Root ユーザーのパスワードは docker-compose.yml で指定しています。必要に応じて書き換えて下さい。  db:    image: mysql:5.7    volumes:      - .mysql_data:/var/lib/mysql    environment:      MYSQL_ROOT_PASSWORD: xxxxxx # \u003c- ここ！5. $ docker-compose up を実行するコンテナを起動させます。6. $ docker-compose exec spring spring rake db:create を実行するコンテナは起動していますが、Rails で使用する DB テーブルはまだ作成されていないので作成します。何気に spring を使っている点に注目です。7. http://localhost:3000/ にアクセスして Rails が動いていることを確認ここまでの操作で Rails が正しく動作しているはずです。Yay! You’re on Rails!ポイントbundle install が毎回走らないように工夫しているDockerfile で WORKDIR に /tmp ディレクトリを指定しているところがポイントです。これをせずに WORKDIR /myapp からの ADD . /myapp をやってしまうと、 Rails のコードに変更がある度に bundle install が最初から実行されてしまいます。Gemfile と Gemfile.lock を /tmp に格納することで、これらのファイルに変更がない限り bundle install が実行されないようになっています。WORKDIR /tmpADD Gemfile GemfileADD Gemfile.lock Gemfile.lockRUN bundle installWORKDIR /myappADD . /myapp参考: DockerでRails + MySQLの開発環境を構築 | EasyRamblespring に対応Rails で開発する上で欠かせない spring も利用できるようにしてあります。前述の rake db:create の時にも出てきましたが、$ docker-compose exec spring spring rails console のようにして使います。spring が 2 回出てくるところがポイントです。一つ目はコンテナのサービス名です。毎回書くのはだるいので僕は alias にしています。fish shell 用なので良いように読み替えて下さい 🙏# ~/.config/fish/config.fish# docker-compose aliasesfunction fig  docker-compose $argvendfunction figspring  docker-compose exec spring spring $argvend# USAGE$ figspring rails c参考: 高速に開発できる Docker + Rails開発環境のテンプレートを作った - QiitaMySQL データの永続化イメージを作り直した時に MySQL のデータが失われてしまうのは辛いものがあります。毎回テスト用のデータを一から作り直したくないので、 docker-compose.yml で以下のように指定してMySQL のデータを永続化させています。  db:    image: mysql:5.7    volumes:      - .mysql_data:/var/lib/mysql # \u003c- これ！    environment:      MYSQL_ROOT_PASSWORD: xxxxxx.mysql_data ディレクトリ以下に MySQL のデータが格納されています。リポジトリの .gitignore で無視させています。試していませんが、参考にさせて頂いた記事によると Docker for Mac 以外の環境では問題が発生するようですのでご注意下さい。対応方法も記事内で紹介されています 🙏参考: docker composeでMySQLのデータ領域をローカルにマウントする | WEB EGGまとめ週末に何かアプリでも書こうかと思った時に、ついでに Docker で環境構築もやっちゃうか、と思い立って書きました。そうこうしてるうちに週末の半分くらいが過ぎ去っていますが、きっと今後は捗るはず。。 😇何度も確認していますが、もし間違っている点、不便な点などありましたらそっと教えて頂けますと幸いです 🙏Fork も大歓迎ですし、誰かに使ってもらえると嬉しいです 😁","link":"https://developer.feedforce.jp/entry/2018/02/11/140012","isoDate":"2018-02-11T05:00:12.000Z","dateMiliSeconds":1518325212000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20180211/20180211110115.png","authorName":"ryz310"},{"title":"mackerel のカスタムメトリックを echo でワンライナーしたった","content":"\u003cp\u003eどうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003e突然ですがワテクシ、 Rails アプリはそこそこ書ける方なんですが、インフラはからきしだったりします。 \u003ca href=\"https://dic.pixiv.net/a/%E3%82%AD%E3%83%A2%E3%83%BC%E3%82%A4%E3%82%AC%E3%83%BC%E3%83%AB%E3%82%BA\"\u003eフルスタックじゃないエンジニアが許されるのは小学生までだよねー\u003c/a\u003e、というちょっと懐かしみのある煽りが社内のからも聞こえてきそうなので、最近インフラを少しずつ触るようにしています。触ってみるとインフラも色々楽しいですね ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003eとはいえ、インフラエンジニアレベル 1 の自分があれこれやっても障害に繋がるだけなので、まずはお手軽な雑用タスクから始めることにしました。\u003c/p\u003e\n\n\u003cp\u003eさて、少し話は変わって、最近、弊社サービスで Sidekiq プロセスのファイルディスクリプタが急騰してサーバーがダウンする、という障害が何度か発生しました。\n現象としては Sidekiq プロセスのファイルディスクリプタが上限値 (初期値は \u003ccode\u003e1024\u003c/code\u003e ) に達すると、サーバーの CPU 使用率が 100 % 付近まで達してしまう、というものだったので、ファイルディスクリプタの上限を \u003ccode\u003e65536\u003c/code\u003e まで上げる、というワークアラウンドな対応で凌いでいました。\u003c/p\u003e\n\n\u003cp\u003e現在は解決済み（この原因については、別途記事にします）ですが、当時はなぜファイルディスクリプタの数が上昇し続けてしまうのか原因が全くわからず、チームのエンジニアは安眠できない日々が続いていました。とりあえず Sidekiq のプロセスをリスタートすればファイルディスクリプタの数は一旦リセットされるので、監視してやばくなったらアラートを飛ばして再起動させる、という方法で一旦は凌ます。また、継続して監視することで、原因の解明にも繋がるかもしれません。\u003c/p\u003e\n\n\u003cp\u003e弊社のサービスでは監視に \u003ca href=\"https://mackerel.io/\"\u003emackerel\u003c/a\u003e を利用しているので、カスタムメトリックを使ってお手軽に監視させよう、ということになりました。\nmackerel のカスタムメトリックの投稿方法は \u003ca href=\"https://mackerel.io/ja/docs/entry/advanced/custom-metrics\"\u003eこちらの記事\u003c/a\u003e にまとまっています。\n要点だけ抜粋しますと、 \u003ca href=\"https://mackerel.io/ja/docs/entry/spec/agent#config-file\"\u003emackerel-agent の設定ファイル\u003c/a\u003e に \u003cstrong\u003e以下の書式で標準出力を実行するコマンドを記述\u003c/strong\u003e すれば OK です。\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003e設定ファイルで指定するコマンドは、標準出力の各行に以下のフォーマットの出力をすることが期待されます（\u003ccode\u003e\\t\u003c/code\u003e はタブ文字です）:\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e{metric name}\\t{metric value}\\t{epoch seconds}\u003c/pre\u003e\n\n\n\u003cp\u003eそして以下がファイルディスクリプタを監視するための設定です（完成品がレンジから出てくるパティーン）\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e[plugin.metrics.file_descriptor_count]\ncommand = \u0026#39;\u0026#39;\u0026#39;\n  echo -e \u0026#34;file_descriptor.sidekiq\\\\t$(sudo ls /proc/$(pgrep -f -u {user_name} sidekiq | head -1)/fd/ | wc -l)\\\\t$(date -u +%s)\u0026#34;\n\u0026#39;\u0026#39;\u0026#39;\u003c/pre\u003e\n\n\n\u003cp\u003e標準出力されれば OK なので、 \u003ccode\u003eecho\u003c/code\u003e で任意の文字列を出力するような方法でも実現可能です。内部で \u003ccode\u003epgrep -f -u {user_name} sidekiq\u003c/code\u003e と書いて、プロセス ID を取得していますが、 \u003ccode\u003e-u\u003c/code\u003e でプロセスを実行しているユーザーを指定しないと、 \u003ccode\u003epgrep\u003c/code\u003e のプロセス ID を取得してしまうケースがあるので注意が必要です。(mackerel-agent は \u003ccode\u003eroot\u003c/code\u003e で実行される)\n同じ要領で、他にも以下のように書けば \u003ccode\u003epuma\u003c/code\u003e のファイルディスクリプタも取ることができます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e[plugin.metrics.file_descriptor_count]\ncommand = \u0026#39;\u0026#39;\u0026#39;\n  echo -e \u0026#34;file_descriptor.puma\\\\t$(sudo ls /proc/$(pgrep -f -u {user_name} puma.sock | head -1)/fd/ | wc -l)\\\\t$(date -u +%s)\u0026#34;\n  echo -e \u0026#34;file_descriptor.puma_cluster_worker\\\\t$(sudo ls /proc/$(pgrep -f -u {user_name} \u0026#39;puma: cluster worker\u0026#39; | head -1)/fd/ | wc -l)\\\\t$(date -u +%s)\u0026#34;\n\u0026#39;\u0026#39;\u0026#39;\u003c/pre\u003e\n\n\n\u003cp\u003eちなみにこの記事を書くときに、もしやと思って調べてみたら、 \u003ccode\u003emackerel-agent-plugins\u003c/code\u003e の中に \u003ca href=\"https://github.com/mackerelio/mackerel-agent-plugins/tree/master/mackerel-plugin-proc-fd\"\u003e任意のプロセスのファイルディスクリプタを監視する奴\u003c/a\u003e がありました 😓\n試していませんが、こっちを使った方が良いと思います 😇\u003c/p\u003e\n\n\u003cp\u003eそんな感じで監視できたグラフが以下になります。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20171231/20171231142049.png\" alt=\"f:id:ryz310:20171231142049p:plain\" title=\"f:id:ryz310:20171231142049p:plain\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eファイルディスクリプタ数がファイナルファンタジーの HP みたいになってますね。。。\nとりあえず \u003ccode\u003e10,000\u003c/code\u003e を超えたらアラートを飛ばすように設定しましたが、デプロイする度にリセットされるので、結局アラートが飛ぶことも障害が発生することもなく、問題は解決しました。\u003c/p\u003e\n\n\u003cp\u003e本稿では \u003ccode\u003eecho\u003c/code\u003e を使ったワンライナーでカスタムメトリックを投稿する方法を紹介しました。\n\u003ccode\u003emackerel-agent-plugins\u003c/code\u003e に載っていないけどワークアラウンドでとりあえず監視させたい、という時は便利だと思うので、どこかでご活用ください 🙏\u003c/p\u003e\n","contentSnippet":"どうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎突然ですがワテクシ、 Rails アプリはそこそこ書ける方なんですが、インフラはからきしだったりします。 フルスタックじゃないエンジニアが許されるのは小学生までだよねー、というちょっと懐かしみのある煽りが社内のからも聞こえてきそうなので、最近インフラを少しずつ触るようにしています。触ってみるとインフラも色々楽しいですね ✌︎('ω')✌︎とはいえ、インフラエンジニアレベル 1 の自分があれこれやっても障害に繋がるだけなので、まずはお手軽な雑用タスクから始めることにしました。さて、少し話は変わって、最近、弊社サービスで Sidekiq プロセスのファイルディスクリプタが急騰してサーバーがダウンする、という障害が何度か発生しました。現象としては Sidekiq プロセスのファイルディスクリプタが上限値 (初期値は 1024 ) に達すると、サーバーの CPU 使用率が 100 % 付近まで達してしまう、というものだったので、ファイルディスクリプタの上限を 65536 まで上げる、というワークアラウンドな対応で凌いでいました。現在は解決済み（この原因については、別途記事にします）ですが、当時はなぜファイルディスクリプタの数が上昇し続けてしまうのか原因が全くわからず、チームのエンジニアは安眠できない日々が続いていました。とりあえず Sidekiq のプロセスをリスタートすればファイルディスクリプタの数は一旦リセットされるので、監視してやばくなったらアラートを飛ばして再起動させる、という方法で一旦は凌ます。また、継続して監視することで、原因の解明にも繋がるかもしれません。弊社のサービスでは監視に mackerel を利用しているので、カスタムメトリックを使ってお手軽に監視させよう、ということになりました。mackerel のカスタムメトリックの投稿方法は こちらの記事 にまとまっています。要点だけ抜粋しますと、 mackerel-agent の設定ファイル に 以下の書式で標準出力を実行するコマンドを記述 すれば OK です。設定ファイルで指定するコマンドは、標準出力の各行に以下のフォーマットの出力をすることが期待されます（\\t はタブ文字です）:{metric name}\\t{metric value}\\t{epoch seconds}そして以下がファイルディスクリプタを監視するための設定です（完成品がレンジから出てくるパティーン）[plugin.metrics.file_descriptor_count]command = '''  echo -e \"file_descriptor.sidekiq\\\\t$(sudo ls /proc/$(pgrep -f -u {user_name} sidekiq | head -1)/fd/ | wc -l)\\\\t$(date -u +%s)\"'''標準出力されれば OK なので、 echo で任意の文字列を出力するような方法でも実現可能です。内部で pgrep -f -u {user_name} sidekiq と書いて、プロセス ID を取得していますが、 -u でプロセスを実行しているユーザーを指定しないと、 pgrep のプロセス ID を取得してしまうケースがあるので注意が必要です。(mackerel-agent は root で実行される)同じ要領で、他にも以下のように書けば puma のファイルディスクリプタも取ることができます。[plugin.metrics.file_descriptor_count]command = '''  echo -e \"file_descriptor.puma\\\\t$(sudo ls /proc/$(pgrep -f -u {user_name} puma.sock | head -1)/fd/ | wc -l)\\\\t$(date -u +%s)\"  echo -e \"file_descriptor.puma_cluster_worker\\\\t$(sudo ls /proc/$(pgrep -f -u {user_name} 'puma: cluster worker' | head -1)/fd/ | wc -l)\\\\t$(date -u +%s)\"'''ちなみにこの記事を書くときに、もしやと思って調べてみたら、 mackerel-agent-plugins の中に 任意のプロセスのファイルディスクリプタを監視する奴 がありました 😓試していませんが、こっちを使った方が良いと思います 😇そんな感じで監視できたグラフが以下になります。ファイルディスクリプタ数がファイナルファンタジーの HP みたいになってますね。。。とりあえず 10,000 を超えたらアラートを飛ばすように設定しましたが、デプロイする度にリセットされるので、結局アラートが飛ぶことも障害が発生することもなく、問題は解決しました。本稿では echo を使ったワンライナーでカスタムメトリックを投稿する方法を紹介しました。mackerel-agent-plugins に載っていないけどワークアラウンドでとりあえず監視させたい、という時は便利だと思うので、どこかでご活用ください 🙏","link":"https://developer.feedforce.jp/entry/2017/12/31/143611","isoDate":"2017-12-31T05:36:11.000Z","dateMiliSeconds":1514698571000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/r/ryz310/20171231/20171231142049.png","authorName":"ryz310"},{"title":"Dynamoid の使い方【global_secondary_index 編】","content":"\u003cp\u003eどうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"http://developer.feedforce.jp/entry/2017/11/04/235323\"\u003e前回\u003c/a\u003eに引き続き、 Dynamoid 第3弾です ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003eRails で DynamoDB を利用する際の ORM として \u003ccode\u003edynamoid\u003c/code\u003e があります。\n今回は \u003ccode\u003edynamoid\u003c/code\u003e から Global Secondary Index (GSI) を利用する方法について紹介します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#Global-Secondary-Index-GSI-ってなんぞ\"\u003eGlobal Secondary Index (GSI) ってなんぞ\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#今回も名称の整理をしておきます\"\u003e今回も名称の整理をしておきます\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#GSI-は検索のためのインデックス\"\u003eGSI は検索のためのインデックス\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Local-Secondary-Index-LSI-もあるやで\"\u003eLocal Secondary Index (LSI) もあるやで\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#どういう用途で便利なのか\"\u003eどういう用途で便利なのか\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Dynamoid-での利用方法\"\u003eDynamoid での利用方法\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#テーブル定義\"\u003eテーブル定義\u003c/a\u003e\u003cul\u003e\n                    \u003cli\u003e\u003ca href=\"#where-を使えば-GSI-を使って自動的にクエリで検索してくれる\"\u003e#where を使えば GSI を使って自動的にクエリで検索してくれる\u003c/a\u003e\u003c/li\u003e\n                    \u003cli\u003e\u003ca href=\"#昇順降順を入れ替えたい場合\"\u003e昇順・降順を入れ替えたい場合\u003c/a\u003e\u003c/li\u003e\n                \u003c/ul\u003e\n            \u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003ccode\u003edynamoid\u003c/code\u003e の導入方法については以前書いたこちらの記事を参考にしてみて下さい。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Ftech.feedforce.jp%2Fdynamodb-setup-on-rails.html\" title=\"DynamoDB を Rails で使えるようにするためのあれこれ | feedforce Engineers\u0026#39; blog\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://tech.feedforce.jp/dynamodb-setup-on-rails.html\"\u003etech.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch1 id=\"Global-Secondary-Index-GSI-ってなんぞ\"\u003eGlobal Secondary Index (GSI) ってなんぞ\u003c/h1\u003e\n\n\u003ch2 id=\"今回も名称の整理をしておきます\"\u003e今回も名称の整理をしておきます\u003c/h2\u003e\n\n\u003cp\u003e文中に Hash Key やら Range Key という名称が出てきますが、現在は名称が異なります。\nしかし、 \u003ccode\u003edyanmoid\u003c/code\u003e では相変わらず旧名称のまま (\u003ccode\u003ehash_key\u003c/code\u003e, \u003ccode\u003erange_key\u003c/code\u003e) でパラメータを指定するので、今回も最初に対応表を記載しておきます。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:center;\"\u003e 旧名称 \u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e 現名称 \u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e Hash Key \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e Partition Key \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e Range Key \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e Sort Key \u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\n\u003ch2 id=\"GSI-は検索のためのインデックス\"\u003eGSI は検索のためのインデックス\u003c/h2\u003e\n\n\u003cp\u003eDynamoDB にはプライマリキーの指定方法として、単一の Partition Key を使用する方法と、Partition Key と Sort Key を組み合わせて使用する方法があります。\nこれについては前回の【range 編】の記事でも触れました。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2017%2F11%2F04%2F235323\" title=\"Dynamoid の使い方【range 編】 - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://developer.feedforce.jp/entry/2017/11/04/235323\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eプライマリキーに指定されたカラムに対してであれば、レコードの抽出や範囲検索などが実行可能となる訳ですが、プライマリキーに指定されていないカラムに対しては検索が実行できず、テーブルのフルスキャンを実行することになってしまい非効率です。そこで、別のカラムに対しても検索を行いたい場合は GSI を設定して、フルスキャンすることなく効率的にデータを抽出できるようにします。\u003c/p\u003e\n\n\u003ciframe src=\"//www.slideshare.net/slideshow/embed_code/key/gHjtA6AS8rk0sB?startSlide=47\" width=\"595\" height=\"485\" style=\"border: 1px solid #CCC; border-width: 1px; margin-bottom: 5px; max-width: 100%;\" scrolling=\"no\" marginwidth=\"0\" marginheight=\"0\" frameborder=\"0\"\u003e \u003c/iframe\u003e\n\n\n\u003cp\u003eGSI もプライマリキーの指定と同様に、単一の Partition Key のみで指定することも、 Partition Key と  Sort Key の組み合わせで指定することも可能です。\nただし、 \u003cstrong\u003eプライマリキーにはユニーク制約が設定されますが、 GSI にはユニーク制約が存在しない\u003c/strong\u003e ので、その点には注意が必要です。\u003c/p\u003e\n\n\u003ch2 id=\"Local-Secondary-Index-LSI-もあるやで\"\u003eLocal Secondary Index (LSI) もあるやで\u003c/h2\u003e\n\n\u003cp\u003eLSI の Partition Key はプライマリキーと共通です。Sort Key の部分だけ別に設定したい場合に使用します。その点を除けば GSI とよく似ていますが、こちらはテーブルの作成時にしか定義することができないようです。\u003c/p\u003e\n\n\u003ciframe src=\"//www.slideshare.net/slideshow/embed_code/key/gHjtA6AS8rk0sB?startSlide=46\" width=\"595\" height=\"485\" style=\"border: 1px solid #CCC; border-width: 1px; margin-bottom: 5px; max-width: 100%;\" scrolling=\"no\" marginwidth=\"0\" marginheight=\"0\" frameborder=\"0\"\u003e \u003c/iframe\u003e\n\n\n\u003cp\u003eなお、LSI も\u003ccode\u003edynamoid\u003c/code\u003e から指定することは可能 (\u003ccode\u003elocal_secondary_index\u003c/code\u003e を使用する) ですが、本稿では触れません。\u003c/p\u003e\n\n\u003ch2 id=\"どういう用途で便利なのか\"\u003eどういう用途で便利なのか\u003c/h2\u003e\n\n\u003cp\u003eあまり複雑なテーブル設計が推奨されない DynamoDB ですが、簡単なテーブル間の関連付けを行いたいシーンが出てきます。親テーブルの ID を結合キーとして子テーブルに設定したい場合などに GSI は便利です。\n以下に User Table と User Comment Table の例を示します。User Comment Table には親テーブルである User Table の ID が GSI の Partition Key として設定してあります。また、コメントの投稿日時 (Posted at) を GSI の Sort Key として設定しています。これで User 毎に投稿日時順にソートしたコメントを取得することができるようになります。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eUser Table\u003c/strong\u003e\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:center;\"\u003e ID \u003c/th\u003e\n\u003cth\u003e name \u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 1 \u003c/td\u003e\n\u003ctd\u003e John \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 2 \u003c/td\u003e\n\u003ctd\u003e Marry \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 3 \u003c/td\u003e\n\u003ctd\u003e Taro \u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\n\u003cp\u003e\u003cstrong\u003eUser Comment Table\u003c/strong\u003e\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:center;\"\u003e ID (Primary Partition Key) \u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e User ID (GSI Partition Key) \u003c/th\u003e\n\u003cth\u003e Posted at (GSI Sort Key) \u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e Comment \u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 1 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e 1 \u003c/td\u003e\n\u003ctd\u003e 1509529916 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e Hello \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 2 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e 1 \u003c/td\u003e\n\u003ctd\u003e 1509530052 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e I am John \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 3 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e 1 \u003c/td\u003e\n\u003ctd\u003e 1509530085 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e How do you do? \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 4 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e 2 \u003c/td\u003e\n\u003ctd\u003e 1509523925 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e Thanks a lot! \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 5 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e 3 \u003c/td\u003e\n\u003ctd\u003e 1509527628 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e こんにちは \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e 6 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e 3 \u003c/td\u003e\n\u003ctd\u003e 1509527101 \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e どうも \u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\n\u003cp\u003eちなみに、プライマリキーと GSI を逆に設定してもほぼ成立するのですが、前述したように GSI にはユニーク制約が存在しないので、User Comment Table では ID をプライマリキーとして、重複が生じないように設定してあります。\u003c/p\u003e\n\n\u003ch1 id=\"Dynamoid-での利用方法\"\u003eDynamoid での利用方法\u003c/h1\u003e\n\n\u003ch2 id=\"テーブル定義\"\u003eテーブル定義\u003c/h2\u003e\n\n\u003cp\u003eここからは前述の User Table と User Comment Table を \u003ccode\u003edynamoid\u003c/code\u003e から利用する例を示していきます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eclass User\n  include Dynamoid::Document\n\n  table name: :users, key: :id\n\n  field :name, :string\n\n  # 現在のユーザーに紐付くコメントを作成する\n  def create_comment!(attributes = {})\n    attributes[:user_id] = id\n    UserComment.new(attributes).tap(\u0026amp;:save!)\n  end\n\n  # 現在のユーザーのコメント一覧を取得する\n  def comments\n    UserComment.where(user_id: id)\n  end\n\n  # 現在のユーザーの最終コメントを取得する\n  def latest_comment\n    comments.scan_index_forward(false).scan_limit(1).all.first\n  end\nend\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eclass UserComment\n  include Dynamoid::Document\n\n  table name: :user_comments, key: :id\n\n  field :user_id, :string\n  field :posted_at, :datetime\n\n  global_secondary_index hash_key: :user_id, \n                         range_key: :posted_at, \n                         projected_attributes: :all\nend\u003c/pre\u003e\n\n\n\u003cp\u003e※ ちなみに \u003ccode\u003edynamoid\u003c/code\u003e には \u003ccode\u003ehas_many\u003c/code\u003e を利用して関連テーブルを実現する方法があるのですが、結合キーを親テーブルに持つ設計になるのがあまり好ましくなかったので、自前で実装しています。\u003c/p\u003e\n\n\u003cp\u003eいくつか注意する点があって、 \u003ccode\u003eglobal_secondary_index\u003c/code\u003e で使用する \u003ccode\u003ehash_key\u003c/code\u003e と \u003ccode\u003erange_key\u003c/code\u003e は \u003ccode\u003efield\u003c/code\u003e で定義されている必要があります。\nまた、 \u003ccode\u003eprojected_attributes: :all\u003c/code\u003e というオプションをつけないと後述の \u003ccode\u003e#where\u003c/code\u003e でインデックスを利用した検索が行われません。一旦これが無い状態でリリースとしてしまうと、射影される属性が限定された GSI が作成されてしまい、実行時にエラーになります。その場合は AWS マネジメントコンソールから直接 GSI を作り直す羽目になりますのでご注意ください 🙏\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eOne or more parameter values were invalid: Select type ALL_ATTRIBUTES is not supported for global secondary index\u003c/pre\u003e\n\n\n\u003ch3 id=\"where-を使えば-GSI-を使って自動的にクエリで検索してくれる\"\u003e\u003ccode\u003e#where\u003c/code\u003e を使えば GSI を使って自動的にクエリで検索してくれる\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003e#comments\u003c/code\u003e というメソッドの中で \u003ccode\u003e#where\u003c/code\u003e を使用した検索が登場しますが、 GSI が設定されていれば特別な記述がなくとも自動的にクエリ検索が行われます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eUserComment.where(user_id: id)\n# =\u0026gt; [#\u0026lt;UserComment:0x00007f44c86183e8\u0026gt;, ...]\u003c/pre\u003e\n\n\n\u003cp\u003e前述の通り \u003ccode\u003eprojected_attributes: :all\u003c/code\u003e が指定されていないとフルスキャンされてしまうのでご注意ください。\u003c/p\u003e\n\n\u003ch3 id=\"昇順降順を入れ替えたい場合\"\u003e昇順・降順を入れ替えたい場合\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003e#latest_comment\u003c/code\u003e というメソッド内で使用していますが、 \u003ccode\u003e#scan_index_forward(false)\u003c/code\u003e と指定すると降順でソートされた状態で結果が返ってきます。未指定の場合は昇順でソートされます。\nまた、 \u003ccode\u003e#scan_limit(n)\u003c/code\u003e と指定することで、先頭から \u003ccode\u003en\u003c/code\u003e 件の結果に限定して取得が可能です。\u003ccode\u003e#latest_comment\u003c/code\u003e ではこれらを組み合わせて最終のコメントを取得しています。\u003c/p\u003e\n\n\u003ch1 id=\"まとめ\"\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003e本稿では GSI と LSI とプライマリキーの違い、具体的な利用用途を紹介しました。\u003ca href=\"http://developer.feedforce.jp/entry/2017/11/04/235323\"\u003e前回の記事\u003c/a\u003eでも触れましたが、 \u003ccode\u003edynamoid\u003c/code\u003e は初回実行時にテーブルや GSI が存在していないと作成する、という挙動になるため、後で設計を変えたくなった場合に GSI や最悪テーブルを作り直す羽目になります。特に初めて利用する場合は設計の勘所を掴むのが難しいので、リリース前に入念に設計を見直すことをお勧めします。その点では RDS 以上に慎重な設計が求められるように感じています。\n色々と気を付けなければならない点も多いですが、並列動作性は非常に高いので、利用したくなるシーンが必ず出てくると思います。その際に本稿が少しでもお役に立てば幸いです 🙏\u003c/p\u003e\n","contentSnippet":"どうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎前回に引き続き、 Dynamoid 第3弾です ✌︎('ω')✌︎Rails で DynamoDB を利用する際の ORM として dynamoid があります。今回は dynamoid から Global Secondary Index (GSI) を利用する方法について紹介します。Global Secondary Index (GSI) ってなんぞ今回も名称の整理をしておきますGSI は検索のためのインデックスLocal Secondary Index (LSI) もあるやでどういう用途で便利なのかDynamoid での利用方法テーブル定義#where を使えば GSI を使って自動的にクエリで検索してくれる昇順・降順を入れ替えたい場合まとめdynamoid の導入方法については以前書いたこちらの記事を参考にしてみて下さい。tech.feedforce.jpGlobal Secondary Index (GSI) ってなんぞ今回も名称の整理をしておきます文中に Hash Key やら Range Key という名称が出てきますが、現在は名称が異なります。しかし、 dyanmoid では相変わらず旧名称のまま (hash_key, range_key) でパラメータを指定するので、今回も最初に対応表を記載しておきます。 旧名称  現名称  Hash Key  Partition Key  Range Key  Sort Key GSI は検索のためのインデックスDynamoDB にはプライマリキーの指定方法として、単一の Partition Key を使用する方法と、Partition Key と Sort Key を組み合わせて使用する方法があります。これについては前回の【range 編】の記事でも触れました。developer.feedforce.jpプライマリキーに指定されたカラムに対してであれば、レコードの抽出や範囲検索などが実行可能となる訳ですが、プライマリキーに指定されていないカラムに対しては検索が実行できず、テーブルのフルスキャンを実行することになってしまい非効率です。そこで、別のカラムに対しても検索を行いたい場合は GSI を設定して、フルスキャンすることなく効率的にデータを抽出できるようにします。 GSI もプライマリキーの指定と同様に、単一の Partition Key のみで指定することも、 Partition Key と  Sort Key の組み合わせで指定することも可能です。ただし、 プライマリキーにはユニーク制約が設定されますが、 GSI にはユニーク制約が存在しない ので、その点には注意が必要です。Local Secondary Index (LSI) もあるやでLSI の Partition Key はプライマリキーと共通です。Sort Key の部分だけ別に設定したい場合に使用します。その点を除けば GSI とよく似ていますが、こちらはテーブルの作成時にしか定義することができないようです。 なお、LSI もdynamoid から指定することは可能 (local_secondary_index を使用する) ですが、本稿では触れません。どういう用途で便利なのかあまり複雑なテーブル設計が推奨されない DynamoDB ですが、簡単なテーブル間の関連付けを行いたいシーンが出てきます。親テーブルの ID を結合キーとして子テーブルに設定したい場合などに GSI は便利です。以下に User Table と User Comment Table の例を示します。User Comment Table には親テーブルである User Table の ID が GSI の Partition Key として設定してあります。また、コメントの投稿日時 (Posted at) を GSI の Sort Key として設定しています。これで User 毎に投稿日時順にソートしたコメントを取得することができるようになります。User Table ID  name  1  John  2  Marry  3  Taro User Comment Table ID (Primary Partition Key)  User ID (GSI Partition Key)  Posted at (GSI Sort Key)  Comment  1  1  1509529916  Hello  2  1  1509530052  I am John  3  1  1509530085  How do you do?  4  2  1509523925  Thanks a lot!  5  3  1509527628  こんにちは  6  3  1509527101  どうも ちなみに、プライマリキーと GSI を逆に設定してもほぼ成立するのですが、前述したように GSI にはユニーク制約が存在しないので、User Comment Table では ID をプライマリキーとして、重複が生じないように設定してあります。Dynamoid での利用方法テーブル定義ここからは前述の User Table と User Comment Table を dynamoid から利用する例を示していきます。class User  include Dynamoid::Document  table name: :users, key: :id  field :name, :string  # 現在のユーザーに紐付くコメントを作成する  def create_comment!(attributes = {})    attributes[:user_id] = id    UserComment.new(attributes).tap(\u0026:save!)  end  # 現在のユーザーのコメント一覧を取得する  def comments    UserComment.where(user_id: id)  end  # 現在のユーザーの最終コメントを取得する  def latest_comment    comments.scan_index_forward(false).scan_limit(1).all.first  endendclass UserComment  include Dynamoid::Document  table name: :user_comments, key: :id  field :user_id, :string  field :posted_at, :datetime  global_secondary_index hash_key: :user_id,                          range_key: :posted_at,                          projected_attributes: :allend※ ちなみに dynamoid には has_many を利用して関連テーブルを実現する方法があるのですが、結合キーを親テーブルに持つ設計になるのがあまり好ましくなかったので、自前で実装しています。いくつか注意する点があって、 global_secondary_index で使用する hash_key と range_key は field で定義されている必要があります。また、 projected_attributes: :all というオプションをつけないと後述の #where でインデックスを利用した検索が行われません。一旦これが無い状態でリリースとしてしまうと、射影される属性が限定された GSI が作成されてしまい、実行時にエラーになります。その場合は AWS マネジメントコンソールから直接 GSI を作り直す羽目になりますのでご注意ください 🙏One or more parameter values were invalid: Select type ALL_ATTRIBUTES is not supported for global secondary index#where を使えば GSI を使って自動的にクエリで検索してくれる#comments というメソッドの中で #where を使用した検索が登場しますが、 GSI が設定されていれば特別な記述がなくとも自動的にクエリ検索が行われます。UserComment.where(user_id: id)# =\u003e [#\u003cUserComment:0x00007f44c86183e8\u003e, ...]前述の通り projected_attributes: :all が指定されていないとフルスキャンされてしまうのでご注意ください。昇順・降順を入れ替えたい場合#latest_comment というメソッド内で使用していますが、 #scan_index_forward(false) と指定すると降順でソートされた状態で結果が返ってきます。未指定の場合は昇順でソートされます。また、 #scan_limit(n) と指定することで、先頭から n 件の結果に限定して取得が可能です。#latest_comment ではこれらを組み合わせて最終のコメントを取得しています。まとめ本稿では GSI と LSI とプライマリキーの違い、具体的な利用用途を紹介しました。前回の記事でも触れましたが、 dynamoid は初回実行時にテーブルや GSI が存在していないと作成する、という挙動になるため、後で設計を変えたくなった場合に GSI や最悪テーブルを作り直す羽目になります。特に初めて利用する場合は設計の勘所を掴むのが難しいので、リリース前に入念に設計を見直すことをお勧めします。その点では RDS 以上に慎重な設計が求められるように感じています。色々と気を付けなければならない点も多いですが、並列動作性は非常に高いので、利用したくなるシーンが必ず出てくると思います。その際に本稿が少しでもお役に立てば幸いです 🙏","link":"https://developer.feedforce.jp/entry/2017/11/26/195509","isoDate":"2017-11-26T10:55:09.000Z","dateMiliSeconds":1511693709000,"imageUrl":"https://cdn.user.blog.st-hatena.com/default_entry_og_image/116461321/1514251518718655","authorName":"ryz310"},{"title":"Serverlessconf Tokyo 2017 に参加してきました","content":"\u003cp\u003eどうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003e先日のおとうふ先生の記事にもあったように、\u003ca href=\"http://tokyo.serverlessconf.io/\"\u003eServerlessconf Tokyo 2017\u003c/a\u003e というイベントが都内で開催されておりました。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2017%2F11%2F02%2F221452\" title=\"Serverlessconf Tokyo 2017 で IBM Cloud Functions のアツい話を聞いてきた - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://developer.feedforce.jp/entry/2017/11/02/221452\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e11/3(金) のメインカンファレンスには弊社からも5名ほど参加しており、みんな大学生の頃の100倍くらい意識高く勉強して参りました ✌︎('ω')✌︎\nお昼ご飯に弁当出たのが嬉しかったです ✌︎('ω')✌︎\nあと、馴染みあるメンツでカンファレンス行くと、終わってから飲みに行けるのも良いですね ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003eさて、今回の記事では当日の発表内容についていくつかダイジェストと感想を書いていきたいと思います。\u003c/p\u003e\n\n\u003cp\u003eスライドはこちらのサイトでまとめられているようで大変助かります 🙏\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fwww.n-novice.com%2Fentry%2F2017%2F11%2F03%2F240000\" title=\"Serverlessconf Tokyo 2017 公開資料 - にわかエンジニア好きなことを書く備忘録\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://www.n-novice.com/entry/2017/11/03/240000\"\u003ewww.n-novice.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch1\u003eサーバレスアーキテクチャによる時系列データベースの構築と監視\u003c/h1\u003e\n\n\u003cscript async class=\"speakerdeck-embed\" data-id=\"c1e5e041140945188ca5b0de4ee32f34\" data-ratio=\"1.77777777777778\" src=\"//speakerdeck.com/assets/embed.js\"\u003e\u003c/script\u003e\n\n\n\u003cul\u003e\n\u003cli\u003eMackerel という監視サービスをどのように監視・管理しているのか、というお話\u003c/li\u003e\n\u003cli\u003e時系列データベースの構成\n\n\u003cul\u003e\n\u003cli\u003eKinesis Streams へ保存\u003c/li\u003e\n\u003cli\u003eLambda で Redis へ保存\u003c/li\u003e\n\u003cli\u003eRedis に一定件数溜まったら DynamoDB へ保存\n\n\u003cul\u003e\n\u003cli\u003e一度 Redis を挟んでいるのは書き込みコストを抑えるため\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eDyanmoDB の TTL を超えるデータは S3 へ保存\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eデータの参照性に合わせて書き込み先を変更しているのはナルホド\u003c/li\u003e\n\u003cli\u003e監視についてまとめ\n\n\u003cul\u003e\n\u003cli\u003eメトリックを可視化して眺めよう\u003c/li\u003e\n\u003cli\u003e監視の基礎は平常状態を知ること\u003c/li\u003e\n\u003cli\u003e系全体の可用性を監視しよう\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eServerless を使った具体的な設計例として、とても参考になります。\n時系列データベースの実装として、複数のストレージを上手く組み合わせて設計されているのは色々なシーンで応用できる設計例ではないでしょうか。\u003c/p\u003e\n\n\u003ch1\u003eJava チームが選択したTypeScript による AWS Lambda 開発\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"http://riotz.works/slides/?2017-serverless-conf\"\u003eSlides | Riotz Works\u003c/a\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e固定 IP を実現するには VPC lambda が必要\n\n\u003cul\u003e\n\u003cli\u003eVPC の lambda はすごく遅い\u003c/li\u003e\n\u003cli\u003e固定 IP に対する需要は現在も一定数あるようなので。。。（日本では特に）\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eマイクロ化が過剰で複雑になった\n\n\u003cul\u003e\n\u003cli\u003eどの程度の粒度でサービスを切り分けていくか、というのは相変わらずセンスが問われるな、という印象\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e言語毎に実行速度がずいぶん違う\n\n\u003cul\u003e\n\u003cli\u003e一度 Java で実装して、スピードが出ずに TypeScript で実装し直した\n\n\u003cul\u003e\n\u003cli\u003eJava は初回実行時はオーバーヘッドが大きい\u003c/li\u003e\n\u003cli\u003eバッチ処理のように計算量が多い処理であれば Java の方が速いようです\u003c/li\u003e\n\u003cli\u003eAWS Lambdaの処理性能を言語毎に測ってみた\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"http://acro-engineer.hatenablog.com/entry/2016/08/02/120000\"\u003ehttp://acro-engineer.hatenablog.com/entry/2016/08/02/120000\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch1\u003eServerlessの世界に特別なことなんて何もなかった\u003c/h1\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fslideship.com%2Fusers%2F%40marcy-terui%2Fpresentations%2F2017%2F11%2F5vUYExsSUrPbyjyjKA7J99%2F\" title=\"The mind of Serverless as a Software - Serverlessの世界に特別なことなんて何もなかった -\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://slideship.com/users/@marcy-terui/presentations/2017/11/5vUYExsSUrPbyjyjKA7J99/\"\u003eslideship.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eServerless でよくある課題と解決\n\n\u003cul\u003e\n\u003cli\u003eFunctionの適切な分割・統合\u003c/li\u003e\n\u003cli\u003eFunctionやサービス間のデータの受け渡し\u003c/li\u003e\n\u003cli\u003e外部サービスの呼び出しとエラーハンドリング\u003c/li\u003e\n\u003cli\u003eテスト\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eスライドに色々な Tips が詳しく書かれているので一読すると吉\n\n\u003cul\u003e\n\u003cli\u003eただ、紹介されている方法だと Lambda Function の粒度がかなり細かくなるので、その辺の管理は大丈夫なのか気になりました\u003c/li\u003e\n\u003cli\u003eマイクロ化しすぎ問題とかは大丈夫でしょうか？\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eどういうサービスが Serverless に向いているのか、という話も出てくるので参考になります\n\n\u003cul\u003e\n\u003cli\u003e個人的には特性を押さえた上で、従来の Rails のようなアプリケーションと Serverless をハイブリッドに組み合わせて使うのが良いと考えています\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch1\u003eServerlessとか言う前に知ってほしいDBのこと\u003c/h1\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fslideship.com%2Fusers%2F%40marcy-terui%2Fpresentations%2F2017%2F11%2FNV8cP63mxs1tLw4qkct7Xd%2F\" title=\"Serverlessとか言う前に知ってほしいDBのこと\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://slideship.com/users/@marcy-terui/presentations/2017/11/NV8cP63mxs1tLw4qkct7Xd/\"\u003eslideship.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e一個前のと同じ登壇者の方\n\n\u003cul\u003e\n\u003cli\u003eこちらは DB についての tips\u003c/li\u003e\n\u003cli\u003eいい感じに煽られていたので、来週弊社で開催される \u003ca href=\"http://developer.feedforce.jp/entry/2017/11/02/190000\"\u003eLT大会\u003c/a\u003e でもこんな感じのノリを期待しています ✌︎('ω')✌︎\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"http://developer.feedforce.jp/entry/2017/11/02/190000\"\u003e\u0026#x793E;\u0026#x5185;LT\u0026#x5927;\u0026#x4F1A;\u0026#x6E96;\u0026#x5099;\u0026#x4E2D; - Feedforce Developer Blog\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e非同期で並列数を制限すれば RDS を Lambda から利用しても問題ない\n\n\u003cul\u003e\n\u003cli\u003e同時接続数が爆発しないように調整して使えば OK\n\n\u003cul\u003e\n\u003cli\u003eLambda から RDS を使ってはいけない、というのがセオリーだったので、使えると言い切る人がいたのはインパクトあった\u003c/li\u003e\n\u003cli\u003eまあ確かに。例えば AWS Aurora の db.r3.large だと 最大接続数が 1,000 ある\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"http://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/Aurora.Managing.html#Aurora.Managing.MaxConnections\"\u003ehttp://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/Aurora.Managing.html#Aurora.Managing.MaxConnections\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e同時に 1,000 を超える Lambda が実行されなければ理屈の上では大丈夫なはず\u003c/li\u003e\n\u003cli\u003e用法用量を守って正しくお使いください、というやつか。。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eDynamoDB でフルスキャンしたら負け\n\n\u003cul\u003e\n\u003cli\u003eこの辺は最近自分でも勉強していたので再確認しながら聞いていました（宣伝）\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2017%2F11%2F04%2F235323\" title=\"Dynamoid の使い方【range 編】 - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://developer.feedforce.jp/entry/2017/11/04/235323\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch1\u003e真のサーバレスアーキテクトとサーバレス時代のゲーム開発・運用\u003c/h1\u003e\n\n\u003cscript async class=\"speakerdeck-embed\" data-id=\"100ed8972466451a8fab9450e51bb0c6\" data-ratio=\"1.77777777777778\" src=\"//speakerdeck.com/assets/embed.js\"\u003e\u003c/script\u003e\n\n\n\u003cp\u003e他の発表と被ってしまったので、当日の講演は見られなかったのですが、ブログの方を見たらとても興味深い内容だったのでご紹介しておきます🙏\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Fgs2.hatenablog.com%2Fentry%2F2017%2F11%2F04%2F013215\" title=\"Serverlessconf Tokyo 2017 に登壇しました。そのほか雑感 - GS2 Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://gs2.hatenablog.com/entry/2017/11/04/013215\"\u003egs2.hatenablog.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003e実は、私もSaaSはサーバレスなのか？という事に対しては、ちょっと思うところがあります。\n私はフルマネージドサービスはサーバレスだと思いますが、マネージドサービスはサーバレスではない。と思っているためです。\nまた、別の言い方をすると、スケールに限界があるモノはサーバレスではない。と思っています。\nつまり、使用方法さえ間違えなければ《勝手に》《無限に》スケールするフルマネージドサービスこそがサーバレス。と言えるのではないか。と思っています。\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eSaaS の運用・開発してる人だと結構重要なテーマなのではないか、と思います。\nSaaS なんだからリクエストどんだけ送っても向こう側で良きに計らってくれるやろ。そう思ってた時期が俺にもありました 😇\nとは言え、SaaS 利用者からそう見えるようなサービスにしたい、という思いはあります。SaaS 利用者としても SaaS の裏側のことは一切考えずに利用したいと思うので。。\n弊社の \u003ca href=\"https://socialplus.jp/\"\u003eソーシャル PLUS\u003c/a\u003e も SaaS ですが、利用して頂いているサイトがイベントなどでアクセスが急騰するケースがありますので、開発・運用ではそういう点に気を遣っています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eコールドスタート対策\n\n\u003cul\u003e\n\u003cli\u003eコールドスタートとは\n\n\u003cul\u003e\n\u003cli\u003eLambda は初回呼び出し時やしばらく呼ばれなかった後に呼ばれたときは response time が長くなる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e1 つの Lambda Function に全ロジックを入れる\n\n\u003cul\u003e\n\u003cli\u003eAPI Gateway のエンドポイント毎にどのロジックを実行するかパラメータで渡している\u003c/li\u003e\n\u003cli\u003eコール比率の低いエンドポイントでもコールドスタートを回避できる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eパラメータで動作が変わる\n\n\u003cul\u003e\n\u003cli\u003eRails の Routing のようなものと佐藤は解釈しました\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e一定間隔で Lambda を起こすように Invoke させる方法もあるが、個人的には Routing やらせる方式の方が良いのではないか、という気がする\n\n\u003cul\u003e\n\u003cli\u003eLambda Function が大量に作られてしまう（マイクロ化しすぎ問題）と管理が難しくなるのではないか、という思いもあって\u003c/li\u003e\n\u003cli\u003eこの方法は実際に試してみたいです\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch1\u003e所感\u003c/h1\u003e\n\n\u003cp\u003eServerless に限ったことではありませんが、近年登場する新技術はトレードオフな側面が強いように感じています。\n一昔前は今までは解の無かった技術的課題を解決する形で新しい技術が登場する、というケースが多かったのではないでしょうか？\n対して今は、既存の技術でもできなくはないけど、特定のケースで困るから、それを解決する新しい技術が登場する、というケースが多いような。\nそして、その特定のケースを解決するために、一部のことは許容しなければならない、という印象です。\n（まあ単純に僕も歳をとって、保守的な考え方が強くなってきただけなのかもしれません。。）\u003c/p\u003e\n\n\u003cp\u003e今回のカンファレンスは実際の開発者からどういうトレードオフがあるか、という話が出てきたことで、自分の中で改めて Serverless と向き合う覚悟というか、モチベーションが出てきたように思います。\u003c/p\u003e\n\n\u003cp\u003eとはいえ、個人的には、従来の Rails アプリと Serverless をハイブリッドに使った設計に取り組んでいくのが現時点での最適解ではないかと感じています。\nもちろん、設計を考えた上で Full-Serverless が最適となれば、そういうアプリを作って行くつもりですが、それなりに複雑なロジックを考えるにはまだ Full-Serverless は早いのではないかな、と思います。\nやはり並列性の高さが Serverless の魅力なので、アプリケーションの基本的な部分は従来通り Rails で作成して、アクセス数が急にスパイクするような場所を局所的に Serverless にするような設計をこれから色々試していこうと考えています。\u003c/p\u003e\n\n\u003cp\u003eただ、Serverless のコンセプトとしては、ソフトウェア開発の生産性そのものを向上させることが目的とのことだったので、将来的にはハイブリッドよりも Serverless に振り切った設計がベストになっていくかもしれません。今後の発展に期待しています。\u003c/p\u003e\n","contentSnippet":"どうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎先日のおとうふ先生の記事にもあったように、Serverlessconf Tokyo 2017 というイベントが都内で開催されておりました。developer.feedforce.jp11/3(金) のメインカンファレンスには弊社からも5名ほど参加しており、みんな大学生の頃の100倍くらい意識高く勉強して参りました ✌︎('ω')✌︎お昼ご飯に弁当出たのが嬉しかったです ✌︎('ω')✌︎あと、馴染みあるメンツでカンファレンス行くと、終わってから飲みに行けるのも良いですね ✌︎('ω')✌︎さて、今回の記事では当日の発表内容についていくつかダイジェストと感想を書いていきたいと思います。スライドはこちらのサイトでまとめられているようで大変助かります 🙏www.n-novice.comサーバレスアーキテクチャによる時系列データベースの構築と監視Mackerel という監視サービスをどのように監視・管理しているのか、というお話時系列データベースの構成Kinesis Streams へ保存Lambda で Redis へ保存Redis に一定件数溜まったら DynamoDB へ保存一度 Redis を挟んでいるのは書き込みコストを抑えるためDyanmoDB の TTL を超えるデータは S3 へ保存データの参照性に合わせて書き込み先を変更しているのはナルホド監視についてまとめメトリックを可視化して眺めよう監視の基礎は平常状態を知ること系全体の可用性を監視しようServerless を使った具体的な設計例として、とても参考になります。時系列データベースの実装として、複数のストレージを上手く組み合わせて設計されているのは色々なシーンで応用できる設計例ではないでしょうか。Java チームが選択したTypeScript による AWS Lambda 開発Slides | Riotz Works固定 IP を実現するには VPC lambda が必要VPC の lambda はすごく遅い固定 IP に対する需要は現在も一定数あるようなので。。。（日本では特に）マイクロ化が過剰で複雑になったどの程度の粒度でサービスを切り分けていくか、というのは相変わらずセンスが問われるな、という印象言語毎に実行速度がずいぶん違う一度 Java で実装して、スピードが出ずに TypeScript で実装し直したJava は初回実行時はオーバーヘッドが大きいバッチ処理のように計算量が多い処理であれば Java の方が速いようですAWS Lambdaの処理性能を言語毎に測ってみたhttp://acro-engineer.hatenablog.com/entry/2016/08/02/120000Serverlessの世界に特別なことなんて何もなかったslideship.comServerless でよくある課題と解決Functionの適切な分割・統合Functionやサービス間のデータの受け渡し外部サービスの呼び出しとエラーハンドリングテストスライドに色々な Tips が詳しく書かれているので一読すると吉ただ、紹介されている方法だと Lambda Function の粒度がかなり細かくなるので、その辺の管理は大丈夫なのか気になりましたマイクロ化しすぎ問題とかは大丈夫でしょうか？どういうサービスが Serverless に向いているのか、という話も出てくるので参考になります個人的には特性を押さえた上で、従来の Rails のようなアプリケーションと Serverless をハイブリッドに組み合わせて使うのが良いと考えていますServerlessとか言う前に知ってほしいDBのことslideship.com一個前のと同じ登壇者の方こちらは DB についての tipsいい感じに煽られていたので、来週弊社で開催される LT大会 でもこんな感じのノリを期待しています ✌︎('ω')✌︎社内LT大会準備中 - Feedforce Developer Blog非同期で並列数を制限すれば RDS を Lambda から利用しても問題ない同時接続数が爆発しないように調整して使えば OKLambda から RDS を使ってはいけない、というのがセオリーだったので、使えると言い切る人がいたのはインパクトあったまあ確かに。例えば AWS Aurora の db.r3.large だと 最大接続数が 1,000 あるhttp://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/Aurora.Managing.html#Aurora.Managing.MaxConnections同時に 1,000 を超える Lambda が実行されなければ理屈の上では大丈夫なはず用法用量を守って正しくお使いください、というやつか。。DynamoDB でフルスキャンしたら負けこの辺は最近自分でも勉強していたので再確認しながら聞いていました（宣伝）developer.feedforce.jp真のサーバレスアーキテクトとサーバレス時代のゲーム開発・運用他の発表と被ってしまったので、当日の講演は見られなかったのですが、ブログの方を見たらとても興味深い内容だったのでご紹介しておきます🙏gs2.hatenablog.com実は、私もSaaSはサーバレスなのか？という事に対しては、ちょっと思うところがあります。私はフルマネージドサービスはサーバレスだと思いますが、マネージドサービスはサーバレスではない。と思っているためです。また、別の言い方をすると、スケールに限界があるモノはサーバレスではない。と思っています。つまり、使用方法さえ間違えなければ《勝手に》《無限に》スケールするフルマネージドサービスこそがサーバレス。と言えるのではないか。と思っています。SaaS の運用・開発してる人だと結構重要なテーマなのではないか、と思います。SaaS なんだからリクエストどんだけ送っても向こう側で良きに計らってくれるやろ。そう思ってた時期が俺にもありました 😇とは言え、SaaS 利用者からそう見えるようなサービスにしたい、という思いはあります。SaaS 利用者としても SaaS の裏側のことは一切考えずに利用したいと思うので。。弊社の ソーシャル PLUS も SaaS ですが、利用して頂いているサイトがイベントなどでアクセスが急騰するケースがありますので、開発・運用ではそういう点に気を遣っています。コールドスタート対策コールドスタートとはLambda は初回呼び出し時やしばらく呼ばれなかった後に呼ばれたときは response time が長くなる1 つの Lambda Function に全ロジックを入れるAPI Gateway のエンドポイント毎にどのロジックを実行するかパラメータで渡しているコール比率の低いエンドポイントでもコールドスタートを回避できるパラメータで動作が変わるRails の Routing のようなものと佐藤は解釈しました一定間隔で Lambda を起こすように Invoke させる方法もあるが、個人的には Routing やらせる方式の方が良いのではないか、という気がするLambda Function が大量に作られてしまう（マイクロ化しすぎ問題）と管理が難しくなるのではないか、という思いもあってこの方法は実際に試してみたいです所感Serverless に限ったことではありませんが、近年登場する新技術はトレードオフな側面が強いように感じています。一昔前は今までは解の無かった技術的課題を解決する形で新しい技術が登場する、というケースが多かったのではないでしょうか？対して今は、既存の技術でもできなくはないけど、特定のケースで困るから、それを解決する新しい技術が登場する、というケースが多いような。そして、その特定のケースを解決するために、一部のことは許容しなければならない、という印象です。（まあ単純に僕も歳をとって、保守的な考え方が強くなってきただけなのかもしれません。。）今回のカンファレンスは実際の開発者からどういうトレードオフがあるか、という話が出てきたことで、自分の中で改めて Serverless と向き合う覚悟というか、モチベーションが出てきたように思います。とはいえ、個人的には、従来の Rails アプリと Serverless をハイブリッドに使った設計に取り組んでいくのが現時点での最適解ではないかと感じています。もちろん、設計を考えた上で Full-Serverless が最適となれば、そういうアプリを作って行くつもりですが、それなりに複雑なロジックを考えるにはまだ Full-Serverless は早いのではないかな、と思います。やはり並列性の高さが Serverless の魅力なので、アプリケーションの基本的な部分は従来通り Rails で作成して、アクセス数が急にスパイクするような場所を局所的に Serverless にするような設計をこれから色々試していこうと考えています。ただ、Serverless のコンセプトとしては、ソフトウェア開発の生産性そのものを向上させることが目的とのことだったので、将来的にはハイブリッドよりも Serverless に振り切った設計がベストになっていくかもしれません。今後の発展に期待しています。","link":"https://developer.feedforce.jp/entry/2017/11/05/111553","isoDate":"2017-11-05T02:15:53.000Z","dateMiliSeconds":1509848153000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/t/tmd45/20171103/20171103011524.jpg","authorName":"ryz310"},{"title":"Dynamoid の使い方【range 編】","content":"\u003cp\u003eどうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎\u003c/p\u003e\n\n\u003cp\u003e最近こうして \u003ca href=\"http://developer.feedforce.jp/entry/2017/10/12/100000\"\u003e弊社の tech ブログが移転した\u003c/a\u003e 訳ですが、自社で管理してるブログだと投稿フローがめんどくさいと僕がボヤいたのが移転理由の一端だったりします 😎\nでも移転作業したのは僕じゃなくて、球だけ投げてどっか行きました 😎\n移転ありがとうございます 🙇\u003c/p\u003e\n\n\u003cp\u003e移転して一発目の投稿なので張り切って参ります 💪\u003c/p\u003e\n\n\u003cp\u003eさて、Rails で DynamoDB を利用する際の ORM として \u003ccode\u003edynamoid\u003c/code\u003e があります。\n今回は \u003ccode\u003edynamoid\u003c/code\u003e から Hash-Range Table (Partition Key と Sort Key の複合) を利用する方法について紹介します。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003edynamoid\u003c/code\u003e の導入方法については以前書いたこちらの記事を参考にしてみて下さい。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=http%3A%2F%2Ftech.feedforce.jp%2Fdynamodb-setup-on-rails.html\" title=\"DynamoDB を Rails で使えるようにするためのあれこれ | feedforce Engineers\u0026#39; blog\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"http://tech.feedforce.jp/dynamodb-setup-on-rails.html\"\u003etech.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch1\u003eHash-Range Table ってなんぞ\u003c/h1\u003e\n\n\u003ch2\u003eその前に名称の整理をしておきます\u003c/h2\u003e\n\n\u003cp\u003eタイトルに 【range 編】と書いているのですが、これは Sort Key の事を指します。\nどうやら DynamoDB は初期の頃と現在で一部の名称が変化したようです。\nしかし、 \u003ccode\u003eDyanmoid\u003c/code\u003e では相変わらず旧名称のまま (\u003ccode\u003ehash_key\u003c/code\u003e, \u003ccode\u003erange_key\u003c/code\u003e) でパラメータを指定するので、対応表を記載しておきます。\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:center;\"\u003e 旧名称 \u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e 現名称 \u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e Hash Key \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e Partition Key \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center;\"\u003e Range Key \u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e Sort Key \u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\n\u003ch2\u003eDyanmoDB には 2 種類のプライマリキーがある\u003c/h2\u003e\n\n\u003cp\u003eこちらのスライドが分かりやすいのですが、 DynamoDB のテーブル定義として Hash Table と Hash-Range Table というものがあります。\u003c/p\u003e\n\n\u003ciframe src=\"//www.slideshare.net/slideshow/embed_code/key/gHjtA6AS8rk0sB?startSlide=24\" width=\"595\" height=\"485\" style=\"border: 1px solid #CCC; border-width: 1px; margin-bottom: 5px; max-width: 100%;\" scrolling=\"no\" marginwidth=\"0\" marginheight=\"0\" frameborder=\"0\"\u003e \u003c/iframe\u003e\n\n\n\n\n\u003ciframe src=\"//www.slideshare.net/slideshow/embed_code/key/gHjtA6AS8rk0sB?startSlide=26\" width=\"595\" height=\"485\" style=\"border: 1px solid #CCC; border-width: 1px; margin-bottom: 5px; max-width: 100%;\" scrolling=\"no\" marginwidth=\"0\" marginheight=\"0\" frameborder=\"0\"\u003e \u003c/iframe\u003e\n\n\n\u003cul\u003e\n\u003cli\u003eHash Table\n\n\u003cul\u003e\n\u003cli\u003eHash Key (Partition Key) という一つのカラムの値でプライマリキーを表現するテーブル\u003c/li\u003e\n\u003cli\u003eこの構成だと Hash Key は \u003cstrong\u003e重複させることができない\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eHash-Range Table\n\n\u003cul\u003e\n\u003cli\u003eHash Key と Range Key (Partition Key,  Sort Key) の二つの値でプライマリキーを表現する\u003c/li\u003e\n\u003cli\u003eRange Key が異なっていれば、同一の Hash Key を持つレコードが複数存在しても良い\u003c/li\u003e\n\u003cli\u003eスキャンより高速なクエリ \u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" rel=\"footnote\"\u003e1\u003c/a\u003e\u003c/sup\u003e で複数のレコードを取得することが可能\n\n\u003cul\u003e\n\u003cli\u003eスキャンだと物凄くコストが高いので、基本的にクエリだけでデータ取得できるように設計すべき\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eRange Key での昇順・降順でのソートが可能\u003c/li\u003e\n\u003cli\u003eRange Key に対しての \u003ca href=\"http://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/Query.html#Query.KeyConditionExpressions\"\u003e範囲検索\u003c/a\u003e も可能\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch1\u003e\u003ccode\u003edynamoid\u003c/code\u003e での利用方法\u003c/h1\u003e\n\n\u003ch2\u003eテーブル定義\u003c/h2\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eclass User\n  include Dynamoid::Document\n\n  table name: :users, key: :hash_key\n  range :range_key, :string # \u0026lt;= これ\nend\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003erange :(フィールド名), :(データ型)\u003c/code\u003e で Range Key の定義が可能です。\nちょっと試せていないのですが、AWS コンソールからだとテーブル作成時にしか Range Key (ソートキー) を定義できないので、既に存在しているテーブルに途中で \u003ccode\u003erange\u003c/code\u003e の定義を加えても動作しないと思います。\u003c/p\u003e\n\n\u003ch2\u003e使い方\u003c/h2\u003e\n\n\u003cp\u003eDynamoid にも ActiveRecord と同じように \u003ccode\u003e#where\u003c/code\u003e というメソッドが実装されています。\nドキュメントでは内部でどのような動きをするのかが見当たらなかったので、実装から確認したのですが、検索条件に Hash Key や Range Key が含まれているかどうかを判断して、クエリが使える場合はクエリで検索してくれるようです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eUser.where(hash_key: \u0026#39;hash_key\u0026#39;) # クエリで検索される\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;, range_key: \u0026#39;range_key\u0026#39;) # クエリで検索される\nUser.where(name: \u0026#39;name\u0026#39;) # Hash Key が無いのでスキャンが実行される\u003c/pre\u003e\n\n\n\u003cp\u003eただし、引数の指定方法や定義の仕方が少しでも間違っていると \u003ccode\u003e#where\u003c/code\u003e でスキャンが実行されてしまっているケースがあります。本当にクエリ検索されているか、念のため Rails のログ出力を確認し、スキャンが実行されていないかどうか確認するようにして下さい ⚠️\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003e#where\u003c/code\u003e の使い方は ActiveRecord とほぼ同じです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eUser.where(hash_key: \u0026#39;hash_key\u0026#39;).all # =\u0026gt; [#\u0026lt;User:0x000000076ed848\u0026gt;, #\u0026lt;User:0x0000000779abb0\u0026gt;, ...]\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;).each do |user|\n  user # =\u0026gt; #\u0026lt;User:0x000000076ed848\u0026gt;\nend\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;).first # =\u0026gt; #\u0026lt;User:0x000000048cb050\u0026gt;\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;).last # =\u0026gt; #\u0026lt;User:0x000000048cb050\u0026gt;\u003c/pre\u003e\n\n\n\u003cp\u003eそして、 \u003ccode\u003erange_key\u003c/code\u003e に対して \u003ccode\u003egt\u003c/code\u003e, \u003ccode\u003elt\u003c/code\u003e, \u003ccode\u003egte\u003c/code\u003e, \u003ccode\u003elte\u003c/code\u003e, \u003ccode\u003ebegins_with\u003c/code\u003e, \u003ccode\u003ebetween\u003c/code\u003e の演算子が使用できます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eUser.where(hash_key: \u0026#39;hash_key\u0026#39;, \u0026#39;range_key.gt\u0026#39;: 123)\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;, \u0026#39;range_key.lt\u0026#39;: 123)\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;, \u0026#39;range_key.gte\u0026#39;: 123)\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;, \u0026#39;range_key.lte\u0026#39;: 123)\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;, \u0026#39;range_key.begins_with\u0026#39;: \u0026#39;range_\u0026#39;)\nUser.where(hash_key: \u0026#39;hash_key\u0026#39;, \u0026#39;range_key.between\u0026#39;: [100, 200])\u003c/pre\u003e\n\n\n\u003ch2\u003eハマりポイント\u003c/h2\u003e\n\n\u003cp\u003eここからは Range Key を \u003ccode\u003edyanmoid\u003c/code\u003e を使っていてハマった点をいくつか紹介したいと思います。\u003c/p\u003e\n\n\u003ch3\u003e\u003ccode\u003erange\u003c/code\u003e を定義していると \u003ccode\u003e#find_by_id\u003c/code\u003e の動作が変わる\u003c/h3\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# Hash Table として利用\nclass User\n  include Dynamoid::Document\n\n  table name: :users, key: :hash_key\nend\n\n# OK!\nUser.find_by_id(\u0026#39;hash_key\u0026#39;)\n# =\u0026gt; #\u0026lt;User:0x000000048cb050\u0026gt;\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# Hash-Range Table として利用\nclass User\n  include Dynamoid::Document\n\n  table name: :users, key: :hash_key\n  range :range_key, :string\nend\n\n# Error!\nUser.find_by_id(\u0026#39;hash_key\u0026#39;)\n# =\u0026gt; Aws::DynamoDB::Errors::ValidationException: The provided key element does not match the schema\u003c/pre\u003e\n\n\n\u003cp\u003eんん？？ってなったのですが、こういう事らしいです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e#find_by_id\u003c/code\u003e は内部的には \u003ccode\u003eAws::DynamoDB::Client#get_item\u003c/code\u003e を呼び出している\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e#get_item\u003c/code\u003e は結果が一意に定まる検索条件を指定しないとエラーになる\n\n\u003cul\u003e\n\u003cli\u003eつまり \u003ccode\u003erange_key (primary sort key)\u003c/code\u003e を定義している場合は引数一つだとエラー\u003c/li\u003e\n\u003cli\u003e引数に \u003ccode\u003erange_key\u003c/code\u003e を指定すれば OK\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eLine::User.find_by_id(\u0026#39;hash_key\u0026#39;, range_key: \u0026#39;range_key\u0026#39;)\n# =\u0026gt; #\u0026lt;User:0x000000048cb050\u0026gt;\n# OK!\u003c/pre\u003e\n\n\n\u003ch3\u003e\u003ccode\u003ehas_many\u003c/code\u003e は Hash-Range Table に対応していない\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003edynamoid\u003c/code\u003e では ActiveRecord のような \u003ccode\u003ehas_many\u003c/code\u003e \u003ccode\u003ehas_one\u003c/code\u003e \u003ccode\u003ebelongs_to\u003c/code\u003e が定義されているのですが、 Hash-Range Table だと上手く動作しません。\n内部の実装を見てみましたが、 Hash Table の状態で利用することが前提となっているようでした。\u003c/p\u003e\n\n\u003cp\u003eHash Table であればこんな感じで利用することができます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eclass User\n  include Dynamoid::Document\n\n  table name: :users, key: :hash_key\n  has_many :talks, class: Talk\nend\n\nclass Talk\n  include Dynamoid::Document\n\n  table name: :talks, key: :hash_key\n  belongs_to :user, class: User\nend\n\nuser = User.create(name: \u0026#39;Taro\u0026#39;)\nuser.talks.create(content: \u0026#39;Hello world\u0026#39;)\u003c/pre\u003e\n\n\n\u003ch1\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003eHash Table と Hash-Range Table の違いから、 Dynamoid における実装方法についてを紹介しました。\nDynamoid を利用した場合は migration を明示的に実行する訳ではないため、Rails のソースコードと DyanmoDB のテーブルの実態が必ずしも一致していないケースがある点がハマりどころのような気がします。\n本稿で紹介した Hash-Range Table が DynamoDB と Dynamoid 両方で正しく設定されているかをリリース前に入念にチェックした方が良いでしょう。\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr/\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\"\u003e\n\u003cp\u003e\u003ca href=\"http://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/QueryAndScanGuidelines.html\"\u003eクエリとスキャンのベストプラクティクス\u003c/a\u003e\u003ca href=\"#fnref:1\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n\n","contentSnippet":"どうも、バックエンドエンジニアのサトウリョウスケです ✌︎('ω')✌︎最近こうして 弊社の tech ブログが移転した 訳ですが、自社で管理してるブログだと投稿フローがめんどくさいと僕がボヤいたのが移転理由の一端だったりします 😎でも移転作業したのは僕じゃなくて、球だけ投げてどっか行きました 😎移転ありがとうございます 🙇移転して一発目の投稿なので張り切って参ります 💪さて、Rails で DynamoDB を利用する際の ORM として dynamoid があります。今回は dynamoid から Hash-Range Table (Partition Key と Sort Key の複合) を利用する方法について紹介します。dynamoid の導入方法については以前書いたこちらの記事を参考にしてみて下さい。tech.feedforce.jpHash-Range Table ってなんぞその前に名称の整理をしておきますタイトルに 【range 編】と書いているのですが、これは Sort Key の事を指します。どうやら DynamoDB は初期の頃と現在で一部の名称が変化したようです。しかし、 Dyanmoid では相変わらず旧名称のまま (hash_key, range_key) でパラメータを指定するので、対応表を記載しておきます。 旧名称  現名称  Hash Key  Partition Key  Range Key  Sort Key DyanmoDB には 2 種類のプライマリキーがあるこちらのスライドが分かりやすいのですが、 DynamoDB のテーブル定義として Hash Table と Hash-Range Table というものがあります。  Hash TableHash Key (Partition Key) という一つのカラムの値でプライマリキーを表現するテーブルこの構成だと Hash Key は 重複させることができないHash-Range TableHash Key と Range Key (Partition Key,  Sort Key) の二つの値でプライマリキーを表現するRange Key が異なっていれば、同一の Hash Key を持つレコードが複数存在しても良いスキャンより高速なクエリ 1 で複数のレコードを取得することが可能スキャンだと物凄くコストが高いので、基本的にクエリだけでデータ取得できるように設計すべきRange Key での昇順・降順でのソートが可能Range Key に対しての 範囲検索 も可能dynamoid での利用方法テーブル定義class User  include Dynamoid::Document  table name: :users, key: :hash_key  range :range_key, :string # \u003c= これendrange :(フィールド名), :(データ型) で Range Key の定義が可能です。ちょっと試せていないのですが、AWS コンソールからだとテーブル作成時にしか Range Key (ソートキー) を定義できないので、既に存在しているテーブルに途中で range の定義を加えても動作しないと思います。使い方Dynamoid にも ActiveRecord と同じように #where というメソッドが実装されています。ドキュメントでは内部でどのような動きをするのかが見当たらなかったので、実装から確認したのですが、検索条件に Hash Key や Range Key が含まれているかどうかを判断して、クエリが使える場合はクエリで検索してくれるようです。User.where(hash_key: 'hash_key') # クエリで検索されるUser.where(hash_key: 'hash_key', range_key: 'range_key') # クエリで検索されるUser.where(name: 'name') # Hash Key が無いのでスキャンが実行されるただし、引数の指定方法や定義の仕方が少しでも間違っていると #where でスキャンが実行されてしまっているケースがあります。本当にクエリ検索されているか、念のため Rails のログ出力を確認し、スキャンが実行されていないかどうか確認するようにして下さい ⚠️#where の使い方は ActiveRecord とほぼ同じです。User.where(hash_key: 'hash_key').all # =\u003e [#\u003cUser:0x000000076ed848\u003e, #\u003cUser:0x0000000779abb0\u003e, ...]User.where(hash_key: 'hash_key').each do |user|  user # =\u003e #\u003cUser:0x000000076ed848\u003eendUser.where(hash_key: 'hash_key').first # =\u003e #\u003cUser:0x000000048cb050\u003eUser.where(hash_key: 'hash_key').last # =\u003e #\u003cUser:0x000000048cb050\u003eそして、 range_key に対して gt, lt, gte, lte, begins_with, between の演算子が使用できます。User.where(hash_key: 'hash_key', 'range_key.gt': 123)User.where(hash_key: 'hash_key', 'range_key.lt': 123)User.where(hash_key: 'hash_key', 'range_key.gte': 123)User.where(hash_key: 'hash_key', 'range_key.lte': 123)User.where(hash_key: 'hash_key', 'range_key.begins_with': 'range_')User.where(hash_key: 'hash_key', 'range_key.between': [100, 200])ハマりポイントここからは Range Key を dyanmoid を使っていてハマった点をいくつか紹介したいと思います。range を定義していると #find_by_id の動作が変わる# Hash Table として利用class User  include Dynamoid::Document  table name: :users, key: :hash_keyend# OK!User.find_by_id('hash_key')# =\u003e #\u003cUser:0x000000048cb050\u003e# Hash-Range Table として利用class User  include Dynamoid::Document  table name: :users, key: :hash_key  range :range_key, :stringend# Error!User.find_by_id('hash_key')# =\u003e Aws::DynamoDB::Errors::ValidationException: The provided key element does not match the schemaんん？？ってなったのですが、こういう事らしいです。#find_by_id は内部的には Aws::DynamoDB::Client#get_item を呼び出している#get_item は結果が一意に定まる検索条件を指定しないとエラーになるつまり range_key (primary sort key) を定義している場合は引数一つだとエラー引数に range_key を指定すれば OKLine::User.find_by_id('hash_key', range_key: 'range_key')# =\u003e #\u003cUser:0x000000048cb050\u003e# OK!has_many は Hash-Range Table に対応していないdynamoid では ActiveRecord のような has_many has_one belongs_to が定義されているのですが、 Hash-Range Table だと上手く動作しません。内部の実装を見てみましたが、 Hash Table の状態で利用することが前提となっているようでした。Hash Table であればこんな感じで利用することができます。class User  include Dynamoid::Document  table name: :users, key: :hash_key  has_many :talks, class: Talkendclass Talk  include Dynamoid::Document  table name: :talks, key: :hash_key  belongs_to :user, class: Userenduser = User.create(name: 'Taro')user.talks.create(content: 'Hello world')まとめHash Table と Hash-Range Table の違いから、 Dynamoid における実装方法についてを紹介しました。Dynamoid を利用した場合は migration を明示的に実行する訳ではないため、Rails のソースコードと DyanmoDB のテーブルの実態が必ずしも一致していないケースがある点がハマりどころのような気がします。本稿で紹介した Hash-Range Table が DynamoDB と Dynamoid 両方で正しく設定されているかをリリース前に入念にチェックした方が良いでしょう。クエリとスキャンのベストプラクティクス↩","link":"https://developer.feedforce.jp/entry/2017/11/04/235323","isoDate":"2017-11-04T14:53:23.000Z","dateMiliSeconds":1509807203000,"imageUrl":"https://cdn.user.blog.st-hatena.com/default_entry_og_image/116461321/1514251518718655","authorName":"ryz310"}]},"__N_SSG":true},"page":"/members/[name]","query":{"name":"ryz310"},"buildId":"y6HlcMxfohCOugLf79Epk","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["link",{"rel":"icon shortcut","type":"image/png","href":"https://engineers.feedforce.jp/logo.png"}],["link",{"rel":"stylesheet","href":"https://fonts.googleapis.com/css2?family=Inter:wght@400;700\u0026display=swap"}],["title",{"children":"ryz310 | Feedforce Engineers' Blogs"}],["meta",{"property":"og:title","content":"ryz310"}],["meta",{"property":"og:url","content":"https://engineers.feedforce.jp/members/ryz310"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"property":"og:site","content":"Feedforce Engineers' Blogs"}],["meta",{"property":"og:image","content":"https://engineers.feedforce.jp/og.png"}],["link",{"rel":"canonical","href":"https://engineers.feedforce.jp/members/ryz310"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Feedforce Engineers' Blogs","href":"https://engineers.feedforce.jp/rss.xml"}],["link",{"rel":"alternate","type":"application/atom+xml","title":"Feedforce Engineers' Blogs","href":"https://engineers.feedforce.jp/atom.xml"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-fa276ba060a4a8ac7eef.js"></script><script src="/_next/static/chunks/main-8a83f0fd99327c4684a8.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.1daf1ec1ecf144ee9147.js" async=""></script><script src="/_next/static/chunks/commons.9e003f150a446b53bdd9.js" async=""></script><script src="/_next/static/chunks/pages/_app-99db904e083fc7f74e35.js" async=""></script><script src="/_next/static/chunks/588505f8033a39c9ef82bc46b1145ac9fd1db500.35a80b323597683276be.js" async=""></script><script src="/_next/static/chunks/pages/members/%5Bname%5D-42a7756adc6c0800b4dc.js" async=""></script><script src="/_next/static/y6HlcMxfohCOugLf79Epk/_buildManifest.js" async=""></script><script src="/_next/static/y6HlcMxfohCOugLf79Epk/_ssgManifest.js" async=""></script></body></html>