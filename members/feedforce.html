<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon shortcut" type="image/png" href="https://engineers.feedforce.jp/logo.png"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&amp;display=swap"/><title>feedforce | Feedforce Engineers&#x27; Blogs</title><meta property="og:title" content="feedforce"/><meta property="og:url" content="https://engineers.feedforce.jp/members/feedforce"/><meta name="twitter:card" content="summary_large_image"/><meta property="og:site" content="Feedforce Engineers&#x27; Blogs"/><meta property="og:image" content="https://engineers.feedforce.jp/og.png"/><link rel="canonical" href="https://engineers.feedforce.jp/members/feedforce"/><link rel="alternate" type="application/rss+xml" title="Feedforce Engineers&#x27; Blogs" href="https://engineers.feedforce.jp/rss.xml"/><link rel="alternate" type="application/atom+xml" title="Feedforce Engineers&#x27; Blogs" href="https://engineers.feedforce.jp/atom.xml"/><link rel="preload" href="/_next/static/css/d7faf1fdf25fe7d3262e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d7faf1fdf25fe7d3262e.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-8a83f0fd99327c4684a8.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.1daf1ec1ecf144ee9147.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.9e003f150a446b53bdd9.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-99db904e083fc7f74e35.js" as="script"/><link rel="preload" href="/_next/static/chunks/588505f8033a39c9ef82bc46b1145ac9fd1db500.41c1f7a773377a30b183.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/members/%5Bname%5D-42a7756adc6c0800b4dc.js" as="script"/></head><body><div id="__next"><header class="site-header"><div class="content-wrapper"><div class="site-header__inner"><a class="site-header__logo-link" href="/"><img src="https://engineers.feedforce.jp/logo.svg" alt="Feedforce Engineers&#x27; Blogs" class="site-header__logo-img"/></a><div class="site-header__links"><a href="https://feedforcegroup.jp" class="site-header__link">Company</a><a href="https://github.com/feedforce" class="site-header__link">GitHub</a><a href="https://engineers.recruit.feedforce.jp" class="site-header__link">Recruit</a></div></div></div></header><section class="member"><div class="content-wrapper"><header class="member-header"><div class="member-header__avatar"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" alt="feedforce" width="100" height="100" class="member-header__avatar-img"/></div><h1 class="member-header__name">feedforce</h1><p class="member-header__bio">Feedforce Developer Blog</p><div class="member-header__links"></div></header><div class="member-posts-container"><div class="post-list"><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-12-16T14:57:31.000Z" class="post-link__date">3 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/12/16/235731" class="post-link__main-link"><h2 class="post-link__title">【約 50 回】2022 年、家族で毎週ふりかえりをした話</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-12-05T02:00:00.000Z" class="post-link__date">4 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/12/05/110000" class="post-link__main-link"><h2 class="post-link__title">Looker のレイヤー化を本番環境に導入してみた</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-11-11T02:11:00.000Z" class="post-link__date">5 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/11/11/111100" class="post-link__main-link"><h2 class="post-link__title">Looker のキャッシュの仕組みを思い出して実装を整理した</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-09-30T09:00:00.000Z" class="post-link__date">6 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/09/30/180000" class="post-link__main-link"><h2 class="post-link__title">自分のブログを CloudFront + Heroku から Cloud Run に移行した話をした</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-09-16T04:00:00.000Z" class="post-link__date">6 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/09/16/130000" class="post-link__main-link"><h2 class="post-link__title">OSS 版 Spectacles を使って、LookML の data tests や validation などを GitHub Actions で継続的に実行させてみた</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-07-21T12:00:00.000Z" class="post-link__date">8 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/07/21/210000" class="post-link__main-link"><h2 class="post-link__title">Looker User Meetup Online #8 で『BigQuery経由で使うGoogleスプレッドシートのスキーマ管理』の話をした</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-06-21T04:00:00.000Z" class="post-link__date">9 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/06/21/130000" class="post-link__main-link"><h2 class="post-link__title">LAMS を導入して、LookML の再利用性を高められた</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-06-17T02:00:00.000Z" class="post-link__date">9 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/06/17/110000" class="post-link__main-link"><h2 class="post-link__title">Looker で困った時の解決手段まとめ</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-05-30T02:00:00.000Z" class="post-link__date">10 months ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/05/30/110000" class="post-link__main-link"><h2 class="post-link__title">LookML Validation を 20 秒から 11 秒に高速化出来た</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-02-04T09:00:00.000Z" class="post-link__date">a year ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/02/04/180000" class="post-link__main-link"><h2 class="post-link__title">『ボッチLookML開発者兼データ整備人を連れてきたよ！』という発表をした</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-12-13T02:00:00.000Z" class="post-link__date">a year ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/12/13/110000" class="post-link__main-link"><h2 class="post-link__title">LookML 開発で使っているディレクトリ構造を紹介する</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-11-05T00:50:50.000Z" class="post-link__date">a year ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/11/05/095050" class="post-link__main-link"><h2 class="post-link__title">GitHub Packages を使ってプライベート gem を社内限定で公開した</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-09-02T04:47:25.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/09/02/134725" class="post-link__main-link"><h2 class="post-link__title">Amazon EKS で高負荷時に CoreDNS が原因で稀にネットワークエラーが発生していた時のトラブルシュート</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-08-30T06:00:00.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/08/30/150000" class="post-link__main-link"><h2 class="post-link__title">Looker で Join 先の view の primary_key をいい感じにテストする方法をようやく見つけた</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-08-16T06:00:00.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/08/16/150000" class="post-link__main-link"><h2 class="post-link__title">私が１年かけて辿り着いた Looker の情報収集方法を紹介する</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-07-07T01:39:17.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/07/07/103917" class="post-link__main-link"><h2 class="post-link__title">Firestore エミュレーターを使ったテスト同士の競合が起きないようにしていい感じにテストできるようにした話</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-06-11T09:00:00.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/06/11/180000" class="post-link__main-link"><h2 class="post-link__title">『ここがつらいよ普段使いのLinux』という発表をした</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-06-11T07:42:53.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/06/11/164253" class="post-link__main-link"><h2 class="post-link__title">【2021年夏】半期に1度の Engineer’s Principles Award 受賞者を紹介します</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-05-31T01:48:13.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/05/31/104813" class="post-link__main-link"><h2 class="post-link__title">プランニングの難しさを乗り越えて...スクラム開発が良い感じになった話</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-05-24T02:00:00.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/career_path_revised_2021" class="post-link__main-link"><h2 class="post-link__title">エンジニアキャリアパスをアップデートしました</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article></div></div></div></section><footer class="site-footer"><div class="content-wrapper"><p>© <!-- -->Feedforce Group Inc.</p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"member":{"name":"feedforce","bio":"Feedforce Developer Blog","avatarSrc":"/avatars/feedforce.jpg","sources":["https://developer.feedforce.jp/rss"]},"postItems":[{"title":"【約 50 回】2022 年、家族で毎週ふりかえりをした話","content":"\u003cp\u003eこの記事は、Feedforce Group Advent Calendar 2022 の16日目の記事です。\u003c/p\u003e\n\n\u003ciframe src=\"https://adventar.org/calendars/7898/embed\" width=\"620\" height=\"450\" frameborder=\"0\" loading=\"lazy\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003e昨日は、アナグラム田中さんによる「クラス制のキャラ育成ができるRPGってキャリア形成のそれと似ているな...って思っただけの話」でした！\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fnote.com%2Fhyroki1980%2Fn%2Fn2f4ff15b1848\" title=\"クラス制のキャラ育成ができるRPGってキャリア形成のそれと似ているな...って思っただけの話｜Hiroki Tanaka｜note\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://note.com/hyroki1980/n/n2f4ff15b1848\"\u003enote.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e私はつい最近、フロントエンドエンジニアからスクラムマスターに社内で「転職（ドラクエ的表現）」したところでして、学生時代のアルバイトで貯めていた経験なんかが意外なところで活きたなぁと感じていたところがあったため、とてもしっくりくる内容でした！\u003c/p\u003e\n\n\u003cp\u003eまた、運用型広告というジョブのアビリティの豊富さ・プレイスタイルの幅広さが視覚的に表現されており、運用型広告というジョブの魅力がガッツリ伝わってきました。\u003cbr/\u003e\n余談ですが、自分も赤魔道士大好きです。\u003c/p\u003e\n\n\u003cp\u003e何の話なんだろう？と思った未読の方、是非本文を楽しんでください！\u003c/p\u003e\n\n\u003ch2 id=\"まえがき\"\u003eまえがき\u003c/h2\u003e\n\n\u003cp\u003e本記事では、この 1 年間家族でやってきたふりかえりについて書きます。\u003cbr/\u003e\nまずは 3 行で記事を紹介します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e2022 年、家族で毎週ふりかえりをした\u003c/li\u003e\n\u003cli\u003eふりかえりをすると、たくさんいいことがあった\u003c/li\u003e\n\u003cli\u003eたくさんの課題があり、工夫して乗り越えた\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこの記事は「家族のふりかえり」にフォーカスしたものですが、家族以外の親密な人とのふりかえりや、自分ひとりのふりかえりをしたい方にも届けたいと思って書きました。\u003cbr/\u003e\n個人のふりかえりとしても適用できます（「よかったこと」の「問題を共有できる」は軽く読み流してください）ので、よかったら読んでみてください。\u003c/p\u003e\n\n\u003ch2 id=\"はじめに\"\u003eはじめに\u003c/h2\u003e\n\n\u003ch3 id=\"自己紹介\"\u003e自己紹介\u003c/h3\u003e\n\n\u003cp\u003eこんにちは、はじめまして。 @zomysan と申します。\u003cbr/\u003e\nソーシャル PLUS のスクラムマスターです。\u003c/p\u003e\n\n\u003cp\u003e弊社は東京にオフィスのある会社ですが、私は関西からフルリモートで勤務しています。\u003cbr/\u003e\nフルリモートもスクラムマスターも初めての経験ですが、チームの方々に支えられ、毎日楽しく働いています！\u003c/p\u003e\n\n\u003ch3 id=\"家族について\"\u003e家族について\u003c/h3\u003e\n\n\u003cp\u003e二人暮らしです。同い年で、ゲーム、絵を描く、お菓子を食べるなど共通の趣味が多く仲良しです。\u003cbr/\u003e\n一緒に暮らし始めて今年で 9 年目になります。犬と猫が飼えるところへ引っ越すことがいまの一番の目標です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e自分: \u003ca href=\"https://twitter.com/zomysan\"\u003e@zomysan\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e犬好き\u003c/li\u003e\n\u003cli\u003e個人開発プロダクトを開発中\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e家族\n\n\u003cul\u003e\n\u003cli\u003e猫好き\u003c/li\u003e\n\u003cli\u003eWeb エンジニアを目指し勉強中\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch3 id=\"ふりかえりのきっかけ\"\u003eふりかえりのきっかけ\u003c/h3\u003e\n\n\u003cp\u003e2022 年 1 月、それぞれの 1 年の目標を立てました。\u003cbr/\u003e\n2021 年までも目標を立ててはいたのですが、毎年毎年日常を過ごすうちに目標について忘れてしまっていました。今年はなにかしら成し遂げたいと思い、私から毎週のふりかえりの実施を提案したところ家族も快諾してくれたため、実施することにしました。\u003c/p\u003e\n\n\u003ch2 id=\"ふりかえりの内容\"\u003eふりかえりの内容\u003c/h2\u003e\n\n\u003cp\u003e実施しているふりかえりについて紹介します。\u003c/p\u003e\n\n\u003ch3 id=\"いつどれくらいやるか\"\u003eいつどれくらいやるか\u003c/h3\u003e\n\n\u003cp\u003e毎週土曜日午前、2 時間の開催としています。\u003cbr/\u003e\n毎週 2 時間と表現すると重たく感じますが、雑談やコミュニケーションを兼ねた時間なので、いまのところ家族間での合意はできています。\u003c/p\u003e\n\n\u003ch3 id=\"ふりかえりの目的\"\u003eふりかえりの目的\u003c/h3\u003e\n\n\u003cp\u003eわが家では、ふりかえりの目的を下記のとおり定めています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eありたい姿に向かって、自分がどれくらい進んだのか？\u003c/li\u003e\n\u003cli\u003eありたい姿に向かって、正しい方向に進めているのか？\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e「ありたい姿」というと何やら大袈裟な感じがしますが、大層なものでなくても構わないです。\u003cbr/\u003e\nたとえば、「できるだけ健康で、美味しいものを食べる自分」「スプラトゥーンがうまい自分」「できる限りしんどいことはしたくない」みたいなものは、全部「ありたい姿」のひとつです。\u003cbr/\u003e\nこういう感じなら、誰しも「ありたい姿」を持っているのではないでしょうか？\u003c/p\u003e\n\n\u003cp\u003eふりかえりをすることで、自分の生活と「ありたい姿」のギャップを確認し、そこを目指すための軌道修正ができます。\nわが家では週に 1 度ふりかえりをしているので、「ありたい姿」を目指すための軌道修正が毎週できているということになります。\u003c/p\u003e\n\n\u003ch3 id=\"YKPT--ファイブフィンガー\"\u003eYKPT + ファイブフィンガー\u003c/h3\u003e\n\n\u003cp\u003eいわゆる「YKPT」という方法を少しアレンジし、ふりかえりをおこなっています。\u003c/p\u003e\n\n\u003cp\u003eYKPT の詳細は省きますが、客観的事実のみから成る「やったこと(Y)」、「やったこと」に基づく「よかったこと（Keep）」、「改善したいこと（Problem）」を書き出し、それに基づいて「次やること（Try）」を決めるという手法です。\u003c/p\u003e\n\n\u003cp\u003eまた、ファイブフィンガーという手法で、ふりかえりのふりかえりをおこなっています。\u003cbr/\u003e\nふりかえりについてもカイゼンを繰り返し、次の週はもっとよいふりかえりができるようにしたいと考えています。\u003c/p\u003e\n\n\u003cp\u003eこれらと併せて、家計簿等を見返す「お金のふりかえり」、アプリの利用時間やゲームのプレイ時間等を見返す「時間のふりかえり」もやっているのですが、今回はこれらについての詳細は省きます。\u003c/p\u003e\n\n\u003ch3 id=\"実際の様子\"\u003e実際の様子\u003c/h3\u003e\n\n\u003cp\u003e実際のふりかえりの様子をスクリーンショットですこし紹介します。これは「やったこと」「よかったこと」「改善したいこと」の一部が見えています。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/z/zomysan/20221217/20221217004703.png\" width=\"1200\" height=\"900\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch2 id=\"ふりかえりをしてよかったこと\"\u003eふりかえりをしてよかったこと\u003c/h2\u003e\n\n\u003cp\u003eさて、ここまではふりかえりの概要を紹介してきました。ここからいよいよ、約50回のふりかえりから得た経験について紹介していきます！\u003cbr/\u003e\nまずは、ふりかえりをしてよかったことについて挙げます。\u003c/p\u003e\n\n\u003ch3 id=\"問題を共有できる\"\u003e問題を共有できる\u003c/h3\u003e\n\n\u003cp\u003e一緒に暮らしていると、ちょっとした困りごとや、変えてもらうようお願いしたいことが出てくるものですよね。\u003cbr/\u003e\nわが家ではふりかえりの場がそういった「問題」を共有する場所として機能しています。\u003c/p\u003e\n\n\u003cp\u003e「いまは改善したいことを挙げる時間ですよ」と区切られていることで、ちょっと言い出しにくいことも表現しやすいです。「発生した課題と解決方法」で詳しくお話ししますが、言い出しにくいことを言い出すための工夫もしています。\u003c/p\u003e\n\n\u003cp\u003e1 年のふりかえりを通して、どういう課題であっても、「相手を責めたり押し付けたりするのではなく、解決方法について一緒に真剣に考える」ことで解決することを信じ、安心して話せるようになりました。このことで、さらに「改善したいこと」が出てきやすくなり、カイゼンにつながっています。\u003c/p\u003e\n\n\u003ch3 id=\"課題が解決する\"\u003e課題が解決する\u003c/h3\u003e\n\n\u003cp\u003eふりかえりをせずに過ごしていると、困っていることがあってもなんとなくそのまま過ごしてしまいます。ふりかえりで「改善したいこと」「困っていること」をあらためて書き出すことで、すぐに対応できます。\u003cbr/\u003e\nたとえば、「寒くて目が覚める」という課題を数年間見過ごしてきたのですが、今年は敷く毛布を買って対応できました。\u003c/p\u003e\n\n\u003cp\u003eそのほかには、「本を読む時間が 0 分だった」という客観的事実から、「寝る前に本を読む時間をとる」という改善すべきことが見つかりました。\u003cbr/\u003e\nこれに対し、「自由時間を就寝時間ギリギリまでではなく、30 分前までとする」という行動をとり、無事に 1 週間に数時間の読書時間を確保できるようになりました。\u003c/p\u003e\n\n\u003ch3 id=\"悩まなくていい悩みを捨てられる\"\u003e悩まなくていい悩みを捨てられる\u003c/h3\u003e\n\n\u003cp\u003e「課題が解決する」では、本を読む時間を確保できるようになったことについてお話ししました。\u003cbr/\u003e\nじつはその後私に起きたことなのですが、個人開発の時間が膨らんで読書時間が減っていってしまいました。個人開発の時間を削ることについても考えたのですが、「いまは読書よりも開発の時間をとることを優先したい」と考えている自分に気づきました。読書できていないことで悩まなくていいのだと、漠然と持っていた「できていない気持ち」を捨てることができました。\u003c/p\u003e\n\n\u003cp\u003e日常を過ごしていると、ついあれもこれもと考えてしまいがちです。ふりかえりの場で自分の優先順位を確認することで、自分が本当に集中したいこととそうでないことを振り分け、優先度の低いことに心を煩わされないようにしたいですね。\u003c/p\u003e\n\n\u003cp\u003eそれはそうとして、なんとかして読書の時間は確保したいものです。明日の家族会議で話してもいいかもしれません。\u003c/p\u003e\n\n\u003ch3 id=\"出来事が蓄積される\"\u003e出来事が蓄積される\u003c/h3\u003e\n\n\u003cp\u003e「やったこと」でその週にあったことを客観的事実として挙げます。これは、「よかったこと」「改善したいこと」につなげるための思い出しなのですが、挙げた「やったこと」自体にも価値があると感じます。\u003c/p\u003e\n\n\u003cp\u003e書いたカードは、すべてとっておき、ふりかえりをした順番に蓄積していきます。そうすると、楽しかったお出かけや、美味しかった自炊、外食、達成したことや困ったことなど、さまざまな「今年 1 年あったこと」のまとめになります。\u003c/p\u003e\n\n\u003cp\u003eもうすぐ年末休みなので、我が家でも家族で 1 年分の「あったこと」をまとめて見返す予定です。とても楽しみです！\u003c/p\u003e\n\n\u003ch2 id=\"発生した課題と解決方法\"\u003e発生した課題と解決方法\u003c/h2\u003e\n\n\u003cp\u003eここまでふりかえりの良かったところについて書きましたが、楽にこれらを得たわけではありませんでした。\u003c/p\u003e\n\n\u003cp\u003eふりかえりをやっていくと、大小さまざまな課題が発生します。\u003cbr/\u003e\nその中でもインパクトが大きかったものについて、どういう課題だったか、どのように解決したのかを紹介します。\u003c/p\u003e\n\n\u003ch3 id=\"決めた次やることを忘れてしまう\"\u003e決めた「次やること」を忘れてしまう\u003c/h3\u003e\n\n\u003cp\u003eせっかく「次やること」を決めてリストにしたのに、すっかり忘れたまま 1 週間を過ごす。\u003cbr/\u003e\nそして、次週のふりかえりの開始時「こんなのあったな……」と呆然とリストを眺める、ということがありました。\u003c/p\u003e\n\n\u003ch4 id=\"-解決方法-朝会を実施\"\u003e→ 解決方法: 朝会を実施\u003c/h4\u003e\n\n\u003cp\u003e「次やること」で決めたことを守れているか、やると決めたタスクはこなせているかを確認するため、朝にも短い家族会議をすることに決めました。わが家ではそのまま朝会と呼んでいます。\u003c/p\u003e\n\n\u003cp\u003e朝会で「次やること」を確認することで、日常のなにかを変えるような取り組み（「水をしっかり飲むためにお湯を 10 時に沸かす」など）についてあらためて認識できます。また、タスク的な取り組み（「敷き毛布を買う」「保温ケトルを買う」など）についても、その日の TODO に落とし込むなどして 1 週間のうちに確実に消化しきることができるようになりました。\u003c/p\u003e\n\n\u003cp\u003e余談ではありますが、朝会ではふりかえりの「次やること」の確認に加え、以下のような取り組みもやっています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e直近の家族の目標を確認\u003c/li\u003e\n\u003cli\u003e当日・直近のスケジュール確認\u003c/li\u003e\n\u003cli\u003eそれぞれの「今日の TODO」を付箋に書く\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこれも朝会をやっていく過程で試行錯誤があり、ふりかえりを通して今の形になりました。\u003c/p\u003e\n\n\u003ch3 id=\"改善したいことの話し合いが精神的につらくなる\"\u003e「改善したいこと」の話し合いが精神的につらくなる\u003c/h3\u003e\n\n\u003cp\u003e「改善したいこと」の深掘りではお互いにマイナスのフィードバックをするような場面も多く、「えっ」「いやいや」と言いたい気持ちになる場面もあります。\u003cbr/\u003e\nもちろん「改善したいこと」について話すわけだから、重たい話になって当然です。しかしあまりにも重いムードが続くと、ふりかえり自体に悪いイメージ・忌避感を持ち、ふりかえり自体から遠ざかってしまいます。\u003c/p\u003e\n\n\u003ch4 id=\"-解決方法-おやつ休憩を挟む\"\u003e→ 解決方法: おやつ休憩を挟む\u003c/h4\u003e\n\n\u003cp\u003e現在、わが家の「改善したいこと」を話す流れは以下のようになりました。\u003cbr/\u003e\nまず「改善したいこと」を各々がカードに書いたら、お互いにコメントをテキストで書きます。そして「おやつ休憩」を挟み、そのあと深掘りの会話をします。\u003c/p\u003e\n\n\u003cp\u003eおやつは血糖値を上げて脳の栄養になってくれそうな甘いものを選びます。紅茶やコーヒーなど、用意していたおやつに合いそうな飲み物もふたりで一緒に用意します。\u003c/p\u003e\n\n\u003cp\u003eまず文章で見て、自分なりに受け止める時間があり、楽しいおやつの時間も挟むので、反射的に言い返すことから喧嘩になる可能性が大幅に下がります。そのころには、最初に感じた「えっ」という衝撃はずいぶん和らいでいます。\u003c/p\u003e\n\n\u003cp\u003e余談ですが、元気なうちに「改善したいこと」の話を済ませてしまうという解決方法もあるかもしれません。わが家では「その週のふりかえりで食べるお菓子を選ぶ」という楽しいイベントが一つ加わり、ふりかえりの時間が楽しみになるという嬉しい副作用もあったので、今のやり方を続けています。\u003c/p\u003e\n\n\u003ch3 id=\"ふりかえりへの取り組み方に差が出てしまう\"\u003eふりかえりへの取り組み方に差が出てしまう\u003c/h3\u003e\n\n\u003cp\u003e一緒にやると決めたふりかえりですが、お互いがずっと高いモチベーションで取り組めていたわけではありません。\u003cbr/\u003e\nやりたいことがあるときや、ちょっと気になってることがあるとき、単純に疲れているときなど、ふりかえりの場に集中できていないこともありました。\u003c/p\u003e\n\n\u003cp\u003e「ちゃんとやってよ」と言い合うのは簡単ですが、集中できないのは集中できないなりの理由があるということです。ただ、これではせっかくのふりかえりの質が保てませんし、最悪ふりかえりのせいで言い争いが起きてしまいます。\u003c/p\u003e\n\n\u003ch4 id=\"-解決方法-ふりかえりについてふりかえりあらためてふりかえりの意義を共有する\"\u003e→ 解決方法: ふりかえりについてふりかえり、あらためてふりかえりの意義を共有する\u003c/h4\u003e\n\n\u003cp\u003eどうすべきなのか、一旦休んだほうがいいのかな、と思っていたところ、2022 年に開催された\u003ca href=\"https://www.scrumosaka.org/\"\u003eスクラムフェス大阪\u003c/a\u003eで、とてもタイムリーなセッションに出会いました。\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003e\u003ca href=\"https://confengine.com/conferences/scrum-fest-osaka-2022/proposal/16535\"\u003eふりかえりをふりかえるための「ふりかえりチェックシート」を使ってふりかえろう！\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eこのセッションで紹介されたのは、ふりかえりがうまくいっているのかをさまざまな観点からチェックし、話し合うためのチェックシートです。ぜひ一度\u003ca href=\"https://miro.com/miroverse/retrospective-check-sheet-japanese/\"\u003eこちら\u003c/a\u003eからシートの現物をごらんいただきたいです。\u003c/p\u003e\n\n\u003cp\u003eわが家でも、このチェックシートにふたりで取り組みました。\u003cbr/\u003e\nまずは各自でチェックシートを埋めていきます。書き終わったら、ひとつずつ結果を共有していきました。一致しているものもあれば、そうでないものもありました。お互いの抱えていた課題感を共有し、議論し、解決のためにいくつかのアクションが決まりました。ふりかえりに感じていたモヤモヤが解消され、より雰囲気よくふりかえりに取り組めるようになりました。\u003c/p\u003e\n\n\u003cp\u003eしかし、シートの効果はそれだけではありませんでした。このシートのチェック項目は、場づくり、アイデア出し、思い出しといった「ふりかえりの要素」ごとに整理されています。\u003cbr/\u003e\nそして、「なぜその要素がふりかえりに重要なのか」「その要素がふりかえりにどう影響をあたえるのか」といった解説が併記されています。\u003cbr/\u003e\nこの解説を読みながら自分たちのふりかえりをふりかえり、議論したことで、二人のあいだで「質の高いふりかえりに何が重要なのか」についての共通認識を持てたことが一番の収穫だったように思います。\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eふりかえりをしてよかったことをまとめます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e問題を家族で共有できる\u003c/li\u003e\n\u003cli\u003e課題が解決する\u003c/li\u003e\n\u003cli\u003e悩まなくていい悩みを捨てられる\u003c/li\u003e\n\u003cli\u003e出来事が蓄積される\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eまた、ふりかえりをよいものにするために取り組んだことは以下のとおりです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eふりかえったことは、毎日確認する機会をつくる\u003c/li\u003e\n\u003cli\u003eふりかえり自体のふりかえりもする\u003c/li\u003e\n\u003cli\u003eごきげんでいるために、おやつ休憩を挟む\u003c/li\u003e\n\u003cli\u003eありたい姿を認識する\u003c/li\u003e\n\u003cli\u003eふりかえりの意義を共有する\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e長い記事を読んでいただき、感謝しかありません。\u003cbr/\u003e\n今思い返すと、家族でやってきたことが、この冬からはじめたスクラムマスターとしての仕事にも活かせているのではないかと思っています。\u003c/p\u003e\n\n\u003cp\u003e2023 年、プライベートについてもふりかえりをはじめてみませんか？\u003c/p\u003e\n\n\u003cp\u003eTwitter でもふりかえりのことなど発信していきたいと思っていますので、興味があれば是非そちらもチェックしていただければと思います！\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://twitter.com/zomysan\"\u003ehttps://twitter.com/zomysan\u003c/a\u003e\u003c/p\u003e\n","contentSnippet":"この記事は、Feedforce Group Advent Calendar 2022 の16日目の記事です。昨日は、アナグラム田中さんによる「クラス制のキャラ育成ができるRPGってキャリア形成のそれと似ているな...って思っただけの話」でした！note.com私はつい最近、フロントエンドエンジニアからスクラムマスターに社内で「転職（ドラクエ的表現）」したところでして、学生時代のアルバイトで貯めていた経験なんかが意外なところで活きたなぁと感じていたところがあったため、とてもしっくりくる内容でした！また、運用型広告というジョブのアビリティの豊富さ・プレイスタイルの幅広さが視覚的に表現されており、運用型広告というジョブの魅力がガッツリ伝わってきました。何の話なんだろう？と思った未読の方、是非本文を楽しんでください！まえがき本記事では、この 1 年間家族でやってきたふりかえりについて書きます。2022 年、家族で毎週ふりかえりをしたふりかえりをすると、たくさんいいことがあったたくさんの課題があり、工夫して乗り越えたこの記事は「家族のふりかえり」にフォーカスしたものですが、家族以外の親密な人とのふりかえりや、自分ひとりのふりかえりをしたい方にも届けたいと思って書きました。はじめに自己紹介こんにちは、はじめまして。 @zomysan と申します。弊社は東京にオフィスのある会社ですが、私は関西からフルリモートで勤務しています。家族について二人暮らしです。同い年で、ゲーム、絵を描く、お菓子を食べるなど共通の趣味が多く仲良しです。自分: @zomysan犬好き個人開発プロダクトを開発中家族猫好きWeb エンジニアを目指し勉強中ふりかえりのきっかけ2022 年 1 月、それぞれの 1 年の目標を立てました。ふりかえりの内容実施しているふりかえりについて紹介します。いつどれくらいやるか毎週土曜日午前、2 時間の開催としています。ふりかえりの目的わが家では、ふりかえりの目的を下記のとおり定めています。ありたい姿に向かって、自分がどれくらい進んだのか？ありたい姿に向かって、正しい方向に進めているのか？「ありたい姿」というと何やら大袈裟な感じがしますが、大層なものでなくても構わないです。ふりかえりをすることで、自分の生活と「ありたい姿」のギャップを確認し、そこを目指すための軌道修正ができます。わが家では週に 1 度ふりかえりをしているので、「ありたい姿」を目指すための軌道修正が毎週できているということになります。YKPT + ファイブフィンガーいわゆる「YKPT」という方法を少しアレンジし、ふりかえりをおこなっています。YKPT の詳細は省きますが、客観的事実のみから成る「やったこと(Y)」、「やったこと」に基づく「よかったこと（Keep）」、「改善したいこと（Problem）」を書き出し、それに基づいて「次やること（Try）」を決めるという手法です。また、ファイブフィンガーという手法で、ふりかえりのふりかえりをおこなっています。これらと併せて、家計簿等を見返す「お金のふりかえり」、アプリの利用時間やゲームのプレイ時間等を見返す「時間のふりかえり」もやっているのですが、今回はこれらについての詳細は省きます。実際の様子実際のふりかえりの様子をスクリーンショットですこし紹介します。これは「やったこと」「よかったこと」「改善したいこと」の一部が見えています。ふりかえりをしてよかったことさて、ここまではふりかえりの概要を紹介してきました。ここからいよいよ、約50回のふりかえりから得た経験について紹介していきます！問題を共有できる一緒に暮らしていると、ちょっとした困りごとや、変えてもらうようお願いしたいことが出てくるものですよね。「いまは改善したいことを挙げる時間ですよ」と区切られていることで、ちょっと言い出しにくいことも表現しやすいです。「発生した課題と解決方法」で詳しくお話ししますが、言い出しにくいことを言い出すための工夫もしています。1 年のふりかえりを通して、どういう課題であっても、「相手を責めたり押し付けたりするのではなく、解決方法について一緒に真剣に考える」ことで解決することを信じ、安心して話せるようになりました。このことで、さらに「改善したいこと」が出てきやすくなり、カイゼンにつながっています。課題が解決するふりかえりをせずに過ごしていると、困っていることがあってもなんとなくそのまま過ごしてしまいます。ふりかえりで「改善したいこと」「困っていること」をあらためて書き出すことで、すぐに対応できます。そのほかには、「本を読む時間が 0 分だった」という客観的事実から、「寝る前に本を読む時間をとる」という改善すべきことが見つかりました。悩まなくていい悩みを捨てられる「課題が解決する」では、本を読む時間を確保できるようになったことについてお話ししました。日常を過ごしていると、ついあれもこれもと考えてしまいがちです。ふりかえりの場で自分の優先順位を確認することで、自分が本当に集中したいこととそうでないことを振り分け、優先度の低いことに心を煩わされないようにしたいですね。それはそうとして、なんとかして読書の時間は確保したいものです。明日の家族会議で話してもいいかもしれません。出来事が蓄積される「やったこと」でその週にあったことを客観的事実として挙げます。これは、「よかったこと」「改善したいこと」につなげるための思い出しなのですが、挙げた「やったこと」自体にも価値があると感じます。書いたカードは、すべてとっておき、ふりかえりをした順番に蓄積していきます。そうすると、楽しかったお出かけや、美味しかった自炊、外食、達成したことや困ったことなど、さまざまな「今年 1 年あったこと」のまとめになります。もうすぐ年末休みなので、我が家でも家族で 1 年分の「あったこと」をまとめて見返す予定です。とても楽しみです！発生した課題と解決方法ここまでふりかえりの良かったところについて書きましたが、楽にこれらを得たわけではありませんでした。ふりかえりをやっていくと、大小さまざまな課題が発生します。決めた「次やること」を忘れてしまうせっかく「次やること」を決めてリストにしたのに、すっかり忘れたまま 1 週間を過ごす。→ 解決方法: 朝会を実施「次やること」で決めたことを守れているか、やると決めたタスクはこなせているかを確認するため、朝にも短い家族会議をすることに決めました。わが家ではそのまま朝会と呼んでいます。朝会で「次やること」を確認することで、日常のなにかを変えるような取り組み（「水をしっかり飲むためにお湯を 10 時に沸かす」など）についてあらためて認識できます。また、タスク的な取り組み（「敷き毛布を買う」「保温ケトルを買う」など）についても、その日の TODO に落とし込むなどして 1 週間のうちに確実に消化しきることができるようになりました。余談ではありますが、朝会ではふりかえりの「次やること」の確認に加え、以下のような取り組みもやっています。直近の家族の目標を確認当日・直近のスケジュール確認それぞれの「今日の TODO」を付箋に書くこれも朝会をやっていく過程で試行錯誤があり、ふりかえりを通して今の形になりました。「改善したいこと」の話し合いが精神的につらくなる「改善したいこと」の深掘りではお互いにマイナスのフィードバックをするような場面も多く、「えっ」「いやいや」と言いたい気持ちになる場面もあります。→ 解決方法: おやつ休憩を挟む現在、わが家の「改善したいこと」を話す流れは以下のようになりました。おやつは血糖値を上げて脳の栄養になってくれそうな甘いものを選びます。紅茶やコーヒーなど、用意していたおやつに合いそうな飲み物もふたりで一緒に用意します。まず文章で見て、自分なりに受け止める時間があり、楽しいおやつの時間も挟むので、反射的に言い返すことから喧嘩になる可能性が大幅に下がります。そのころには、最初に感じた「えっ」という衝撃はずいぶん和らいでいます。余談ですが、元気なうちに「改善したいこと」の話を済ませてしまうという解決方法もあるかもしれません。わが家では「その週のふりかえりで食べるお菓子を選ぶ」という楽しいイベントが一つ加わり、ふりかえりの時間が楽しみになるという嬉しい副作用もあったので、今のやり方を続けています。ふりかえりへの取り組み方に差が出てしまう一緒にやると決めたふりかえりですが、お互いがずっと高いモチベーションで取り組めていたわけではありません。「ちゃんとやってよ」と言い合うのは簡単ですが、集中できないのは集中できないなりの理由があるということです。ただ、これではせっかくのふりかえりの質が保てませんし、最悪ふりかえりのせいで言い争いが起きてしまいます。→ 解決方法: ふりかえりについてふりかえり、あらためてふりかえりの意義を共有するどうすべきなのか、一旦休んだほうがいいのかな、と思っていたところ、2022 年に開催されたスクラムフェス大阪で、とてもタイムリーなセッションに出会いました。ふりかえりをふりかえるための「ふりかえりチェックシート」を使ってふりかえろう！このセッションで紹介されたのは、ふりかえりがうまくいっているのかをさまざまな観点からチェックし、話し合うためのチェックシートです。ぜひ一度こちらからシートの現物をごらんいただきたいです。わが家でも、このチェックシートにふたりで取り組みました。しかし、シートの効果はそれだけではありませんでした。このシートのチェック項目は、場づくり、アイデア出し、思い出しといった「ふりかえりの要素」ごとに整理されています。まとめふりかえりをしてよかったことをまとめます。問題を家族で共有できる課題が解決する悩まなくていい悩みを捨てられる出来事が蓄積されるまた、ふりかえりをよいものにするために取り組んだことは以下のとおりです。ふりかえったことは、毎日確認する機会をつくるふりかえり自体のふりかえりもするごきげんでいるために、おやつ休憩を挟むありたい姿を認識するふりかえりの意義を共有する長い記事を読んでいただき、感謝しかありません。2023 年、プライベートについてもふりかえりをはじめてみませんか？Twitter でもふりかえりのことなど発信していきたいと思っていますので、興味があれば是非そちらもチェックしていただければと思います！https://twitter.com/zomysan","link":"https://developer.feedforce.jp/entry/2022/12/16/235731","isoDate":"2022-12-16T14:57:31.000Z","dateMiliSeconds":1671202651000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/z/zomysan/20221217/20221217004703.png","authorName":"feedforce"},{"title":"Looker のレイヤー化を本番環境に導入してみた","content":"\u003cp\u003eこんにちは。\u003ca href=\"https://twitter.com/masutaka/status/1550357627779284992\"\u003e自称 Looker エバンジェリスト\u003c/a\u003eの \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003eこの記事は Looker Advent Calendar 2022 の 5 日目の記事です。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fadvent-calendar%2F2022%2Flooker\" title=\"Calendar for Looker | Advent Calendar 2022 - Qiita\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://qiita.com/advent-calendar/2022/looker\"\u003eqiita.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e昨日と一昨日は記事がなくて、その前は BASE 永野さん (\u003ca href=\"https://twitter.com/glassmonekey\"\u003e@glassmonekey\u003c/a\u003e) の「\u003ca href=\"https://devblog.thebase.in/entry/2022/12/02/110000\"\u003eアジリティを保ってデータ基盤を作る取り組み\u003c/a\u003e」でした。使用した技術そのものよりも、どのように合意形成してこのような体制に出来たのかが気になりました。👀\u003c/p\u003e\n\n\u003cp\u003e今回は奇しくも去年の Advent Calendar その後の話になります。全然狙っていませんでした。たまたまです。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2021%2F12%2F13%2F110000\" title=\"LookML 開発で使っているディレクトリ構造を紹介する - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2021/12/13/110000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#LookML-のレイヤー化とは\"\u003eLookML のレイヤー化とは\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#導入戦略\"\u003e導入戦略\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#実際の導入方法\"\u003e実際の導入方法\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#_baselayerlkml\"\u003e/_base.layer.lkml\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#_basiclayerlkml\"\u003e/_basic.layer.lkml\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#layerslayerlkml\"\u003e/layers/*.layer.lkml\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#modellkml\"\u003e/*.model.lkml\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#コラム-複数レイヤーで共通するロジックの置き場所\"\u003e[コラム] 複数レイヤーで共通するロジックの置き場所\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"LookML-のレイヤー化とは\"\u003eLookML のレイヤー化とは\u003c/h2\u003e\n\n\u003cp\u003eLookML には \u003ca href=\"https://cloud.google.com/looker/docs/lookml-refinements\"\u003eRefinements\u003c/a\u003e という \u003ca href=\"https://cloud.google.com/looker/docs/reusing-code-with-extends\"\u003eExtends\u003c/a\u003e に似た機能があり、explore や view の定義を分散させたり、元のコードを変更せずに機能を追加することが出来ます。\u003c/p\u003e\n\n\u003cp\u003eこの Refinements を応用することで LookML に「レイヤー化」という概念を導入することが出来ます。まずはこちらの記事をどうぞ。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fcommunity.looker.com%2F%25E3%2582%25B3%25E3%2583%25A9%25E3%2583%25A0-103%2Frefinements%25E3%2582%2592%25E4%25BD%25BF%25E3%2581%25A3%25E3%2581%25A6lookml%25E3%2581%25AE%25E3%2582%25B3%25E3%2583%25BC%25E3%2583%2589%25E3%2582%2592%25E6%2595%25B4%25E7%2590%2586%25E3%2581%2599%25E3%2582%258B-18809\" title=\"Refinementsを使ってLookMLのコードを整理する | Looker Community\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://community.looker.com/%E3%82%B3%E3%83%A9%E3%83%A0-103/refinements%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6lookml%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E6%95%B4%E7%90%86%E3%81%99%E3%82%8B-18809\"\u003ecommunity.looker.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eこのような責務だと理解しました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e/_base.layer.lkml\n\n\u003cul\u003e\n\u003cli\u003eスキーマと Explore の定義に徹する。Join はしない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e/_basic.layer.lkml\n\n\u003cul\u003e\n\u003cli\u003eデータ構造に着目した Join と、primary_key の定義に徹する。ビジネスロジックは定義しない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e/layers/*.layer.lkml\n\n\u003cul\u003e\n\u003cli\u003eビジネスロジックの論理レイヤーをここに定義する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e💭 \u003ccode\u003e_base\u003c/code\u003e と \u003ccode\u003e_basic\u003c/code\u003e はもっと良い命名はあるかもしれません。\u003c/p\u003e\n\n\u003ch2 id=\"導入戦略\"\u003e導入戦略\u003c/h2\u003e\n\n\u003cp\u003e既存のプロジェクトを全部書き換えるのはリスクが大きいので、新規で Join する view からレイヤー化を試すことにしました。\u003c/p\u003e\n\n\u003cp\u003eただ、責務はこのように再定義しました。特に \u003ccode\u003e/_basic.layer.lkml\u003c/code\u003e を変えました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e/_base.layer.lkml\n\n\u003cul\u003e\n\u003cli\u003eスキーマ定義に徹する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e/_basic.layer.lkml\n\n\u003cul\u003e\n\u003cli\u003eprimary_key のテストを書ける定義を書く。Join はしない。ビジネスロジックは知らない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e/layers/*.layer.lkml\n\n\u003cul\u003e\n\u003cli\u003eJoin 含めて、ビジネスロジックの論理レイヤーをここに定義する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eというのも、今回は「データ構造に着目した Join」と同じ Join を論理レイヤーにも定義する必要があり、実装が分散するからです。後述します。\u003c/p\u003e\n\n\u003ch2 id=\"実際の導入方法\"\u003e実際の導入方法\u003c/h2\u003e\n\n\u003ch3 id=\"_baselayerlkml\"\u003e/_base.layer.lkml\u003c/h3\u003e\n\n\u003cp\u003eこのようなスキーマ定義を、1 つのファイルに書いていきます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eview: ad_budget {\n  sql_table_name: @{table_ad_budget} ;;\n\n  dimension: month        { type: string }\n  dimension: client_name  { type: string }\n  dimension: site_name    { type: string }\n  dimension: media        { type: string }\n  dimension: budget_gross { type: number }\n}\u003c/pre\u003e\n\n\n\u003cp\u003e💡 \u003ccode\u003esql: ${TABLE}.date ;;\u003c/code\u003e 等がなくて違和感があるかも知れませんが、以下のとおり問題ありません。\u003c/p\u003e\n\n\u003cp\u003e🔗 \u003ca href=\"https://cloud.google.com/looker/docs/reference/param-field-sql#sql_for_dimensions\"\u003esql (for fields) \u003e Definition \u003e sql for Dimensions\u003c/a\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003eIf \u003ccode\u003esql\u003c/code\u003e is left unspecified, then Looker assumes that there is a column in the underlying table with the same name as the field. For example, selecting a field called \u003ccode\u003ecity\u003c/code\u003e without a \u003ccode\u003esql\u003c/code\u003e parameter would be equivalent to specifying \u003ccode\u003esql: ${TABLE}.city\u003c/code\u003e.\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003esql\u003c/code\u003e が指定されていない場合、Looker はそのフィールドと同じ名前のカラムが基礎となるテーブルに存在すると仮定します。例えば、\u003ccode\u003esql\u003c/code\u003e パラメータを指定せずに \u003ccode\u003ecity\u003c/code\u003e というフィールドを選択すると、\u003ccode\u003esql: ${TABLE}.city\u003c/code\u003e と指定したのと同じことになります。\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003ch3 id=\"_basiclayerlkml\"\u003e/_basic.layer.lkml\u003c/h3\u003e\n\n\u003cp\u003eこのような定義を書きます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003einclude: \u0026#34;/_base.layer\u0026#34;\n\n# Define for tests\nexplore: ad_budget {\n  required_access_grants: [can_view_explores_for_tests]\n  hidden: yes\n}\n\nview: +ad_budget {\n  dimension: pk {\n    primary_key: yes\n    type: string\n    sql: CONCAT(${month}, ${client_name}, ${site_name}, ${media}) ;;\n    hidden: yes\n  }\n\n  measure: count {\n    type: count\n    description: \u0026#34;Row Count\u0026#34;\n    filters: {\n      field: \u0026#34;pk\u0026#34;\n      value: \u0026#34;-NULL\u0026#34;\n    }\n  }\n}\u003c/pre\u003e\n\n\n\u003cp\u003e💡 ad_budget view は直接使われず、他の Explore から Join して使うので、ad_budget explore はテストだけで使うように隠しています。\u003c/p\u003e\n\n\u003cp\u003e関連記事です。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2021%2F08%2F30%2F150000\" title=\"Looker で Join 先の view の primary_key をいい感じにテストする方法をようやく見つけた - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2021/08/30/150000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch3 id=\"layerslayerlkml\"\u003e/layers/*.layer.lkml\u003c/h3\u003e\n\n\u003cp\u003ead_budget view を 2 つの Explore から Join します。\u003ccode\u003ejoin\u003c/code\u003e 内容はほとんど同じで、\u003ccode\u003esql_on\u003c/code\u003e の view 名が違うだけです。\u003c/p\u003e\n\n\u003cp\u003e似た実装を 1 つにまとめられるメリットがあります。corp_name1 という名前から推測できるとおり、corp_nameN explore は複数存在しており、その数数十にもなります。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003einclude: \u0026#34;/_basic.layer\u0026#34;\ninclude: \u0026#34;/explores/all_media.explore\u0026#34;\n\nexplore: +all_media {\n  join: ad_budget {\n    view_label: \u0026#34;広告予算\u0026#34;\n    relationship: many_to_many\n    sql_on: ${all_media.date_month} = ${ad_budget.month}\n            AND ${all_media.corporate_name} = ${ad_budget.client_name}\n            AND ${all_media.proposition_name} = ${ad_budget.site_name} ;;\n  }\n}\n\nexplore: +corp_name1 {\n  join: ad_budget {\n    view_label: \u0026#34;広告予算\u0026#34;\n    relationship: many_to_many\n    sql_on: ${corp_name1.date_month} = ${ad_budget.month}\n            AND ${corp_name1.corporate_name} = ${ad_budget.client_name}\n            AND ${corp_name1.proposition_name} = ${ad_budget.site_name} ;;\n  }\n}\n\nview: +ad_budget {\n  dimension: budget_gross { hidden: yes }\n\n  measure: total_budget_gross {\n    type: sum\n    sql: ${budget_gross} ;;\n    label: \u0026#34;広告予算 (Gross)\u0026#34;\n    value_format_name: jpy_0\n  }\n}\u003c/pre\u003e\n\n\n\u003ch3 id=\"modellkml\"\u003e/*.model.lkml\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003e/model_name.model.lkml\u003c/code\u003e のようなファイルに、レイヤーファイルの include を追加しました。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003einclude: \u0026#34;/layers/**/*.layer\u0026#34;\u003c/pre\u003e\n\n\n\u003ch3 id=\"コラム-複数レイヤーで共通するロジックの置き場所\"\u003e[コラム] 複数レイヤーで共通するロジックの置き場所\u003c/h3\u003e\n\n\u003cp\u003e少し脱線。複数レイヤーで共通するロジックをどう書けばよいか？の話はあると思います。\u003c/p\u003e\n\n\u003cp\u003e今まで通り \u003ccode\u003eextends\u003c/code\u003e パラメーターを使えば良いです。Refinements と Extends は共存できます。詳しくは \u003ca href=\"https://help.looker.com/hc/en-us/articles/5043112335891-Lookml-refinements-compared-to-extends\"\u003eLookml refinements compared to extends\u003c/a\u003e をどうぞ。\u003c/p\u003e\n\n\u003cp\u003eまだ試行錯誤中ですが、私は \u003ccode\u003e/modules/*.module.lkml\u003c/code\u003e に共通ロジックをまとめています。\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eLookML のレイヤー化を紹介しました。今回の例以外にもガッツリと使っています。\u003c/p\u003e\n\n\u003cp\u003e記事を書いていて、具体的な例を出してもピンと来ないだろうし、抽象的な例にするとボンヤリするしで、いろんな意味で難易度が高かったです。どなたか 1 人にでも参考になれば十分です。\u003c/p\u003e\n\n\u003cp\u003eレイヤー化は LookML の到達点ではなく、1 つの選択肢に過ぎません。素朴なデータ構造であれば、\u003ccode\u003e/views\u003c/code\u003e や \u003ccode\u003e/explores\u003c/code\u003e で実装したほうが良いと思います。\u003c/p\u003e\n\n\u003cp\u003eというのも、レイヤー化を導入すると、スキーマ定義と Dimension\u0026amp;Measure 定義の距離が離れるので、その view で何が使えるのか、コードから理解するのが難しくなるからです。\u003c/p\u003e\n\n\u003cp\u003e今回紹介した例も、記事を書いていてもっと良い方法があるような気がしました。Explore をうまいこと Extends して Join を 1 つにまとめれば、レイヤー化を使わなくてよいのでは？とか。でも以前検討した時はうまくいかなかったんですよね...。\u003c/p\u003e\n\n\u003cp\u003e正解はないと思うので、他の試行錯誤も是非教えて下さい。\u003c/p\u003e\n\n\u003cp\u003e🔗 \u003ca href=\"https://community.looker.com/lookml-5/what-is-the-looker-recommended-folder-structure-for-lookml-development-28826\"\u003eWhat is the looker recommended folder structure for LookML development ? | Looker Community\u003c/a\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003eI used different approaches in the last few years and found it that I always have to have some kind of a hybrid system.\n(snip)\nBut to be honest, I am still experimenting with what’s the best physical split versus logical\u003c/p\u003e\n\n\u003cp\u003e私は過去数年間、さまざまなアプローチを使用し、私は常にいくつかの種類のハイブリッドシステムを持たなければならないことを発見した。\n（省略）\nしかし、正直なところ、物理的な分割と論理的な分割のどちらが良いのか、まだ試行錯誤の段階です。\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003e以前、Looker Community のこちらのコメントを紹介したことがあります。\u003ca href=\"https://community.looker.com/members/dawid-5902\"\u003eDawid\u003c/a\u003e さんはよくお見かけする方で、かなりの熟練者のはずです。そんな彼も、未だに試行錯誤しているようです。\u003c/p\u003e\n\n\u003cp\u003e始めは \u003ccode\u003e/views\u003c/code\u003e や \u003ccode\u003e/explores\u003c/code\u003e のような素朴な実装から始めて、必要に応じてレイヤー化を取り入れれば良いと思います。いつか公式から、データの複雑度に応じたベストプラクティスが出てくることを期待します。🙃\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/advent-calendar/2022/looker\"\u003eLooker Advent Calendar 2022\u003c/a\u003e の明日、明後日は書く人はまだいなくて、その次は @saenakano さんの「System Activity入門」です。お楽しみに。\u003c/p\u003e\n","contentSnippet":"こんにちは。自称 Looker エバンジェリストの id:masutaka26 です。この記事は Looker Advent Calendar 2022 の 5 日目の記事です。qiita.com昨日と一昨日は記事がなくて、その前は BASE 永野さん (@glassmonekey) の「アジリティを保ってデータ基盤を作る取り組み」でした。使用した技術そのものよりも、どのように合意形成してこのような体制に出来たのかが気になりました。👀今回は奇しくも去年の Advent Calendar その後の話になります。全然狙っていませんでした。たまたまです。developer.feedforce.jpLookML のレイヤー化とは導入戦略実際の導入方法/_base.layer.lkml/_basic.layer.lkml/layers/*.layer.lkml/*.model.lkml[コラム] 複数レイヤーで共通するロジックの置き場所まとめLookML のレイヤー化とはLookML には Refinements という Extends に似た機能があり、explore や view の定義を分散させたり、元のコードを変更せずに機能を追加することが出来ます。この Refinements を応用することで LookML に「レイヤー化」という概念を導入することが出来ます。まずはこちらの記事をどうぞ。community.looker.comこのような責務だと理解しました。/_base.layer.lkmlスキーマと Explore の定義に徹する。Join はしない/_basic.layer.lkmlデータ構造に着目した Join と、primary_key の定義に徹する。ビジネスロジックは定義しない/layers/*.layer.lkmlビジネスロジックの論理レイヤーをここに定義する💭 _base と _basic はもっと良い命名はあるかもしれません。導入戦略既存のプロジェクトを全部書き換えるのはリスクが大きいので、新規で Join する view からレイヤー化を試すことにしました。ただ、責務はこのように再定義しました。特に /_basic.layer.lkml を変えました。/_base.layer.lkmlスキーマ定義に徹する/_basic.layer.lkmlprimary_key のテストを書ける定義を書く。Join はしない。ビジネスロジックは知らない/layers/*.layer.lkmlJoin 含めて、ビジネスロジックの論理レイヤーをここに定義するというのも、今回は「データ構造に着目した Join」と同じ Join を論理レイヤーにも定義する必要があり、実装が分散するからです。後述します。実際の導入方法/_base.layer.lkmlこのようなスキーマ定義を、1 つのファイルに書いていきます。view: ad_budget {  sql_table_name: @{table_ad_budget} ;;  dimension: month        { type: string }  dimension: client_name  { type: string }  dimension: site_name    { type: string }  dimension: media        { type: string }  dimension: budget_gross { type: number }}💡 sql: ${TABLE}.date ;; 等がなくて違和感があるかも知れませんが、以下のとおり問題ありません。🔗 sql (for fields) \u003e Definition \u003e sql for DimensionsIf sql is left unspecified, then Looker assumes that there is a column in the underlying table with the same name as the field. For example, selecting a field called city without a sql parameter would be equivalent to specifying sql: ${TABLE}.city.sql が指定されていない場合、Looker はそのフィールドと同じ名前のカラムが基礎となるテーブルに存在すると仮定します。例えば、sql パラメータを指定せずに city というフィールドを選択すると、sql: ${TABLE}.city と指定したのと同じことになります。/_basic.layer.lkmlこのような定義を書きます。include: \"/_base.layer\"# Define for testsexplore: ad_budget {  required_access_grants: [can_view_explores_for_tests]  hidden: yes}view: +ad_budget {  dimension: pk {    primary_key: yes    type: string    sql: CONCAT(${month}, ${client_name}, ${site_name}, ${media}) ;;    hidden: yes  }  measure: count {    type: count    description: \"Row Count\"    filters: {      field: \"pk\"      value: \"-NULL\"    }  }}💡 ad_budget view は直接使われず、他の Explore から Join して使うので、ad_budget explore はテストだけで使うように隠しています。関連記事です。developer.feedforce.jp/layers/*.layer.lkmlad_budget view を 2 つの Explore から Join します。join 内容はほとんど同じで、sql_on の view 名が違うだけです。似た実装を 1 つにまとめられるメリットがあります。corp_name1 という名前から推測できるとおり、corp_nameN explore は複数存在しており、その数数十にもなります。include: \"/_basic.layer\"include: \"/explores/all_media.explore\"explore: +all_media {  join: ad_budget {    view_label: \"広告予算\"    relationship: many_to_many    sql_on: ${all_media.date_month} = ${ad_budget.month}            AND ${all_media.corporate_name} = ${ad_budget.client_name}            AND ${all_media.proposition_name} = ${ad_budget.site_name} ;;  }}explore: +corp_name1 {  join: ad_budget {    view_label: \"広告予算\"    relationship: many_to_many    sql_on: ${corp_name1.date_month} = ${ad_budget.month}            AND ${corp_name1.corporate_name} = ${ad_budget.client_name}            AND ${corp_name1.proposition_name} = ${ad_budget.site_name} ;;  }}view: +ad_budget {  dimension: budget_gross { hidden: yes }  measure: total_budget_gross {    type: sum    sql: ${budget_gross} ;;    label: \"広告予算 (Gross)\"    value_format_name: jpy_0  }}/*.model.lkml/model_name.model.lkml のようなファイルに、レイヤーファイルの include を追加しました。include: \"/layers/**/*.layer\"[コラム] 複数レイヤーで共通するロジックの置き場所少し脱線。複数レイヤーで共通するロジックをどう書けばよいか？の話はあると思います。今まで通り extends パラメーターを使えば良いです。Refinements と Extends は共存できます。詳しくは Lookml refinements compared to extends をどうぞ。まだ試行錯誤中ですが、私は /modules/*.module.lkml に共通ロジックをまとめています。まとめLookML のレイヤー化を紹介しました。今回の例以外にもガッツリと使っています。記事を書いていて、具体的な例を出してもピンと来ないだろうし、抽象的な例にするとボンヤリするしで、いろんな意味で難易度が高かったです。どなたか 1 人にでも参考になれば十分です。レイヤー化は LookML の到達点ではなく、1 つの選択肢に過ぎません。素朴なデータ構造であれば、/views や /explores で実装したほうが良いと思います。というのも、レイヤー化を導入すると、スキーマ定義と Dimension\u0026Measure 定義の距離が離れるので、その view で何が使えるのか、コードから理解するのが難しくなるからです。今回紹介した例も、記事を書いていてもっと良い方法があるような気がしました。Explore をうまいこと Extends して Join を 1 つにまとめれば、レイヤー化を使わなくてよいのでは？とか。でも以前検討した時はうまくいかなかったんですよね...。正解はないと思うので、他の試行錯誤も是非教えて下さい。🔗 What is the looker recommended folder structure for LookML development ? | Looker CommunityI used different approaches in the last few years and found it that I always have to have some kind of a hybrid system.(snip)But to be honest, I am still experimenting with what’s the best physical split versus logical私は過去数年間、さまざまなアプローチを使用し、私は常にいくつかの種類のハイブリッドシステムを持たなければならないことを発見した。（省略）しかし、正直なところ、物理的な分割と論理的な分割のどちらが良いのか、まだ試行錯誤の段階です。以前、Looker Community のこちらのコメントを紹介したことがあります。Dawid さんはよくお見かけする方で、かなりの熟練者のはずです。そんな彼も、未だに試行錯誤しているようです。始めは /views や /explores のような素朴な実装から始めて、必要に応じてレイヤー化を取り入れれば良いと思います。いつか公式から、データの複雑度に応じたベストプラクティスが出てくることを期待します。🙃Looker Advent Calendar 2022 の明日、明後日は書く人はまだいなくて、その次は @saenakano さんの「System Activity入門」です。お楽しみに。","link":"https://developer.feedforce.jp/entry/2022/12/05/110000","isoDate":"2022-12-05T02:00:00.000Z","dateMiliSeconds":1670205600000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"Looker のキャッシュの仕組みを思い出して実装を整理した","content":"\u003cp\u003eこんにちは。\u003ca href=\"https://twitter.com/masutaka/status/1550357627779284992\"\u003e自称 Looker エバンジェリスト\u003c/a\u003eの \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003eフィードフォースで Looker を使っているサービスで最近 BigQuery の料金が上がってきました。\u003c/p\u003e\n\n\u003cp\u003e本当に使われているのならとても良いことですが、Looker のキャッシュが有効に使われずに BigQuery 料金が増えていたら嫌だなと思い、キャッシュの仕組みを思い出しつつ実装を整理してみました。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#Looker-のキャッシュおさらい\"\u003eLooker のキャッシュおさらい\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#今回のサービスでのキャッシュ設定\"\u003e今回のサービスでのキャッシュ設定\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#変更後のキャッシュ設定\"\u003e変更後のキャッシュ設定\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#さらなる足掻きからの失敗\"\u003eさらなる足掻きからの失敗\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#もっと足掻いてからの困惑\"\u003eもっと足掻いてからの困惑\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#さらなるキャッシュへの理解\"\u003eさらなるキャッシュへの理解\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"Looker-のキャッシュおさらい\"\u003eLooker のキャッシュおさらい\u003c/h2\u003e\n\n\u003cp\u003eLooker にはキャッシュの仕組みがあり、LookML 開発者が適切に設定することで、データベースのクエリ実行を減らすことができます。\u003c/p\u003e\n\n\u003cp\u003e全く同じ SQL の実行結果がキャッシュされていれば、データベースにクエリ実行せずにキャッシュを返します。\u003c/p\u003e\n\n\u003cp\u003eLooker ユーザーとしてはダッシュボードの表示速度向上のメリットがあり、LookML 開発者としては（BigQuery 等であれば）料金削減に繋がります。\u003c/p\u003e\n\n\u003cp\u003eキャッシュの有効期限はデフォルトで 1 時間です。これは \u003ca href=\"https://cloud.google.com/looker/docs/reference/param-model-persist-for\"\u003epersist_for (for models)\u003c/a\u003e のデフォルト値です。\u003c/p\u003e\n\n\u003ch2 id=\"今回のサービスでのキャッシュ設定\"\u003e今回のサービスでのキャッシュ設定\u003c/h2\u003e\n\n\u003cp\u003e良くも悪くも設定は最小限で、PDT（永続的派生テーブル）の実装箇所だけでした。\u003c/p\u003e\n\n\u003cp\u003e例えば Google や Criteo などの広告媒体数値が入ったテーブルを参照する、all_media explore があります。このようなキャッシュ設定でした。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003edatagroup: cache_all_media {\n  # 最新の日付か総レコード数に変化があったら検知する。\n  sql_trigger: SELECT CONCAT(MAX(date), \u0026#39;_\u0026#39;, COUNT(*)) FROM @{table_all_media} ;;\n  max_cache_age: \u0026#34;1 hour\u0026#34;\n}\n\nexplore: all_media {\n  persist_with: cache_all_media # (1)\n\n  # ...\n}\n\nview: all_media {\n  derived_table: {\n    # めちゃめちゃ長い SQL\n    sql: SELECT\n           ...\n         FROM @{table_all_media}\n         GROUP BY ... ;;\n    datagroup_trigger: cache_all_media # (2)\n    partition_keys: [\u0026#34;date\u0026#34;]\n  }\n\n  # ...\n}\u003c/pre\u003e\n\n\n\u003cp\u003e(1) で \u003ccode\u003ecache_all_media\u003c/code\u003e datagroup と \u003ccode\u003eall_media\u003c/code\u003e explore が \u003ca href=\"https://cloud.google.com/looker/docs/reference/param-explore-persist-with\"\u003epersist_with (for Explores)\u003c/a\u003e で紐付くことで、以下の振る舞いが生まれます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003esql_trigger\u003c/code\u003e によりテーブルの変更が検知されると、キャッシュが破棄される\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emax_cache_age\u003c/code\u003e を超えたキャッシュは破棄される\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eつまりキャッシュの生存期間は最長でも 1 時間です。その前に PDT が再作成されればもっと短くなります。\u003c/p\u003e\n\n\u003cp\u003eどちらかと言えば、データベースを優先する設定です。このテーブルは 1 日に 3 回しか更新されないため、最適化の余地がありそうです。\u003c/p\u003e\n\n\u003cp\u003e(2) で \u003ccode\u003ecache_all_media\u003c/code\u003e datagroup と \u003ccode\u003eall_media\u003c/code\u003e view も \u003ca href=\"https://cloud.google.com/looker/docs/reference/param-view-datagroup-trigger\"\u003edatagroup_trigger\u003c/a\u003e で紐付いていますが、これは derived_table を永続化するための設定です。\u003ccode\u003esql_trigger\u003c/code\u003e によりテーブルの変更が検知されると、PDT が再作成されるとともに、キャッシュが破棄されます。\u003c/p\u003e\n\n\u003cp\u003e※ 余談: \u003ccode\u003epersist_with\u003c/code\u003e を設定していたことをすっかり忘れていたこともあり、調査前は (1) の理解が出来ていませんでした。😇\u003c/p\u003e\n\n\u003ch2 id=\"変更後のキャッシュ設定\"\u003e変更後のキャッシュ設定\u003c/h2\u003e\n\n\u003cp\u003e紆余曲折あり、\u003ccode\u003emax_cache_age\u003c/code\u003e を少し増やしただけにしました。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003edatagroup: cache_all_media {\n  # 最新の日付か総レコード数に変化があったら検知する。\n  sql_trigger: SELECT CONCAT(MAX(date), \u0026#39;_\u0026#39;, COUNT(*)) FROM @{table_all_media} ;;\n  max_cache_age: \u0026#34;2 hours\u0026#34;\n}\u003c/pre\u003e\n\n\n\u003cp\u003e本当は \"24 hours\" にして「PDT 再作成のタイミングでのみキャッシュを破棄」したかったのですが、他の Explore でも参照される関係で、\u003ccode\u003emax_cache_age\u003c/code\u003e を思い切って増やせませんでした。\u003c/p\u003e\n\n\u003ch2 id=\"さらなる足掻きからの失敗\"\u003eさらなる足掻きからの失敗\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003emax_cache_age\u003c/code\u003e を 1 時間から 2 時間に増やした程度では、BigQuery 料金を抑えられたように見えませんでした。\u003c/p\u003e\n\n\u003cp\u003e仕方がないので、all_media explore 以外の Explore で \u003ccode\u003ecache_all_media\u003c/code\u003e datagroup を使うのを止めて、専用 persist_with + datagroup を設定しました。\u003c/p\u003e\n\n\u003cp\u003eこのような LookML を 40 個書きました。😱\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003edatagroup: cache_corp_xxx {\n  sql_trigger:  SELECT\n                  STRING_AGG(CONCAT(table, \u0026#39;_\u0026#39;, date, \u0026#39;_\u0026#39;, count) ORDER BY table)\n                FROM (\n                  SELECT \u0026#39;all_media\u0026#39; AS table, MAX(date) AS date, COUNT(*) AS count FROM @{table_all_media} UNION ALL\n                  SELECT \u0026#39;UA_1\u0026#39;, MAX(date), COUNT(*) FROM @{table_ga_xxx} UNION ALL\n                  SELECT \u0026#39;UA_2\u0026#39;, MAX(date), COUNT(*) FROM @{table_ga_xxx2}\n                ) ;;\n  max_cache_age: \u0026#34;24 hours\u0026#34; # テーブル更新のタイミングでのみ、キャッシュを破棄する。\n}\n\nexplore: corp_xxx {\n  persist_with: cache_corp_xxx\n\n  # ...\n}\u003c/pre\u003e\n\n\n\u003cp\u003e結果的には大失敗。40 個の datagroup が 5 分に 1 回トリガーされる関係で、Looker を使わない土日でも BigQuery 料金が変わらなくなってしまいました。\u003c/p\u003e\n\n\u003cp\u003e※ 補足: 「可能な限り Explore を少なくする」が Looker のベストプラクティスなので、40 個もの Explore は本来はアンチパターンです。ですが、今回のサービスはお客様にダッシュボードを提供する上に、やむを得ず個別実装が発生することもあります。そのような経緯で結果的にこの数になっています。\u003c/p\u003e\n\n\u003ch2 id=\"もっと足掻いてからの困惑\"\u003eもっと足掻いてからの困惑\u003c/h2\u003e\n\n\u003cp\u003eそれならばと、利用頻度が高い Explore だけに、専用 persist_with + datagroup を設定すれば良いのでは？と思いました。\u003ca href=\"https://cloud.google.com/looker/docs/usage-reports-with-system-activity-explores\"\u003eSystem Activity の History Explore\u003c/a\u003e から、このようなフィールドを選択すれば利用頻度の高い Explore が分かります。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20221110/20221110171713.png\" width=\"1200\" height=\"692\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e設定してから一週間。BigQuery 料金はあまり変わりませんでした。😇\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://cloud.google.com/looker/docs/system-activity-dashboards#dashboard_performance_dashboard\"\u003eDatabase Performance ダッシュボード\u003c/a\u003eの Results from Cache\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" rel=\"footnote\"\u003e1\u003c/a\u003e\u003c/sup\u003eは 18% から 20% に向上しました。もっと高いほうが良いのか、どうなのか...。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20221110/20221110165849.png\" width=\"390\" height=\"388\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eSystem Activity の History Explore からダッシュボードを作ってもみましたが、設定変更とキャッシュヒット率の相関性は見いだせませんでした。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20221110/20221110171721.png\" width=\"1200\" height=\"763\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eとはいえ、BigQuery 料金はそこまで増えなかったので、とりあえず続けています。\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eBigQuery 料金が増えたことをきっかけにして、Looker のキャッシュ設定を見直しました。\u003c/p\u003e\n\n\u003cp\u003e実装は整理できましたが、BigQuery 料金の変化はなく、キャッシュ難しい...という気持ちです。\u003c/p\u003e\n\n\u003ch2 id=\"さらなるキャッシュへの理解\"\u003eさらなるキャッシュへの理解\u003c/h2\u003e\n\n\u003cp\u003e中の人が翻訳して下さった記事がとても良いです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://community.looker.com/%E3%82%B3%E3%83%A9%E3%83%A0-103/%E3%82%AF%E3%82%A8%E3%83%AA%E3%81%AE%E3%83%AD%E3%82%B0%E3%81%8B%E3%82%89%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B-28549\"\u003eクエリのログからキャッシュを理解する | Looker Community\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr/\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\"\u003e\n\u003cp\u003eキャッシュから返されたクエリの割合\u003ca href=\"#fnref:1\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n\n","contentSnippet":"こんにちは。自称 Looker エバンジェリストの id:masutaka26 です。フィードフォースで Looker を使っているサービスで最近 BigQuery の料金が上がってきました。本当に使われているのならとても良いことですが、Looker のキャッシュが有効に使われずに BigQuery 料金が増えていたら嫌だなと思い、キャッシュの仕組みを思い出しつつ実装を整理してみました。Looker のキャッシュおさらい今回のサービスでのキャッシュ設定変更後のキャッシュ設定さらなる足掻きからの失敗もっと足掻いてからの困惑まとめさらなるキャッシュへの理解Looker のキャッシュおさらいLooker にはキャッシュの仕組みがあり、LookML 開発者が適切に設定することで、データベースのクエリ実行を減らすことができます。全く同じ SQL の実行結果がキャッシュされていれば、データベースにクエリ実行せずにキャッシュを返します。Looker ユーザーとしてはダッシュボードの表示速度向上のメリットがあり、LookML 開発者としては（BigQuery 等であれば）料金削減に繋がります。キャッシュの有効期限はデフォルトで 1 時間です。これは persist_for (for models) のデフォルト値です。今回のサービスでのキャッシュ設定良くも悪くも設定は最小限で、PDT（永続的派生テーブル）の実装箇所だけでした。例えば Google や Criteo などの広告媒体数値が入ったテーブルを参照する、all_media explore があります。このようなキャッシュ設定でした。datagroup: cache_all_media {  # 最新の日付か総レコード数に変化があったら検知する。  sql_trigger: SELECT CONCAT(MAX(date), '_', COUNT(*)) FROM @{table_all_media} ;;  max_cache_age: \"1 hour\"}explore: all_media {  persist_with: cache_all_media # (1)  # ...}view: all_media {  derived_table: {    # めちゃめちゃ長い SQL    sql: SELECT           ...         FROM @{table_all_media}         GROUP BY ... ;;    datagroup_trigger: cache_all_media # (2)    partition_keys: [\"date\"]  }  # ...}(1) で cache_all_media datagroup と all_media explore が persist_with (for Explores) で紐付くことで、以下の振る舞いが生まれます。sql_trigger によりテーブルの変更が検知されると、キャッシュが破棄されるmax_cache_age を超えたキャッシュは破棄されるつまりキャッシュの生存期間は最長でも 1 時間です。その前に PDT が再作成されればもっと短くなります。どちらかと言えば、データベースを優先する設定です。このテーブルは 1 日に 3 回しか更新されないため、最適化の余地がありそうです。(2) で cache_all_media datagroup と all_media view も datagroup_trigger で紐付いていますが、これは derived_table を永続化するための設定です。sql_trigger によりテーブルの変更が検知されると、PDT が再作成されるとともに、キャッシュが破棄されます。※ 余談: persist_with を設定していたことをすっかり忘れていたこともあり、調査前は (1) の理解が出来ていませんでした。😇変更後のキャッシュ設定紆余曲折あり、max_cache_age を少し増やしただけにしました。datagroup: cache_all_media {  # 最新の日付か総レコード数に変化があったら検知する。  sql_trigger: SELECT CONCAT(MAX(date), '_', COUNT(*)) FROM @{table_all_media} ;;  max_cache_age: \"2 hours\"}本当は \"24 hours\" にして「PDT 再作成のタイミングでのみキャッシュを破棄」したかったのですが、他の Explore でも参照される関係で、max_cache_age を思い切って増やせませんでした。さらなる足掻きからの失敗max_cache_age を 1 時間から 2 時間に増やした程度では、BigQuery 料金を抑えられたように見えませんでした。仕方がないので、all_media explore 以外の Explore で cache_all_media datagroup を使うのを止めて、専用 persist_with + datagroup を設定しました。このような LookML を 40 個書きました。😱datagroup: cache_corp_xxx {  sql_trigger:  SELECT                  STRING_AGG(CONCAT(table, '_', date, '_', count) ORDER BY table)                FROM (                  SELECT 'all_media' AS table, MAX(date) AS date, COUNT(*) AS count FROM @{table_all_media} UNION ALL                  SELECT 'UA_1', MAX(date), COUNT(*) FROM @{table_ga_xxx} UNION ALL                  SELECT 'UA_2', MAX(date), COUNT(*) FROM @{table_ga_xxx2}                ) ;;  max_cache_age: \"24 hours\" # テーブル更新のタイミングでのみ、キャッシュを破棄する。}explore: corp_xxx {  persist_with: cache_corp_xxx  # ...}結果的には大失敗。40 個の datagroup が 5 分に 1 回トリガーされる関係で、Looker を使わない土日でも BigQuery 料金が変わらなくなってしまいました。※ 補足: 「可能な限り Explore を少なくする」が Looker のベストプラクティスなので、40 個もの Explore は本来はアンチパターンです。ですが、今回のサービスはお客様にダッシュボードを提供する上に、やむを得ず個別実装が発生することもあります。そのような経緯で結果的にこの数になっています。もっと足掻いてからの困惑それならばと、利用頻度が高い Explore だけに、専用 persist_with + datagroup を設定すれば良いのでは？と思いました。System Activity の History Explore から、このようなフィールドを選択すれば利用頻度の高い Explore が分かります。設定してから一週間。BigQuery 料金はあまり変わりませんでした。😇Database Performance ダッシュボードの Results from Cache1は 18% から 20% に向上しました。もっと高いほうが良いのか、どうなのか...。System Activity の History Explore からダッシュボードを作ってもみましたが、設定変更とキャッシュヒット率の相関性は見いだせませんでした。とはいえ、BigQuery 料金はそこまで増えなかったので、とりあえず続けています。まとめBigQuery 料金が増えたことをきっかけにして、Looker のキャッシュ設定を見直しました。実装は整理できましたが、BigQuery 料金の変化はなく、キャッシュ難しい...という気持ちです。さらなるキャッシュへの理解中の人が翻訳して下さった記事がとても良いです。クエリのログからキャッシュを理解する | Looker Communityキャッシュから返されたクエリの割合↩","link":"https://developer.feedforce.jp/entry/2022/11/11/111100","isoDate":"2022-11-11T02:11:00.000Z","dateMiliSeconds":1668132660000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"自分のブログを CloudFront + Heroku から Cloud Run に移行した話をした","content":"\u003cp\u003eこんにちは \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e本日、週次の社内勉強会 \u003ca href=\"https://developer.feedforce.jp/archive/category/FFTT\"\u003eFFTT\u003c/a\u003e で『引っ越ししたら家賃が3分の1になったかも』というタイトルで、実際は Amazon CloudFront + Heroku で動いていた\u003ca href=\"https://masutaka.net/\"\u003e自分のブログ\u003c/a\u003eを GCP の \u003ca href=\"https://cloud.google.com/run\"\u003eCloud Run\u003c/a\u003e に移行した話をしました。\u003c/p\u003e\n\n\u003ciframe src=\"https://docs.google.com/presentation/d/e/2PACX-1vTucSlV9z4czouHd-hIOiDBwaeh1a7CMbEm2mmx5kGDTijuRKJF4ID3blnnKz1nhG6rvMfMBLyTSFMM/embed?start=false\u0026loop=false\u0026delayms=3000\" frameborder=\"0\" width=\"960\" height=\"410\" allowfullscreen=\"true\" mozallowfullscreen=\"true\" webkitallowfullscreen=\"true\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003eモチベーションはスライドにつらつら書きつつも、実際はこの FFTT の発表当番だったからではあります。結果的に満足行く結果にはなったので、これからコード管理などもう少し作り込んでいきます。\u003cs\u003e今後ネタに困ったらまた引っ越せばよいし。\u003c/s\u003e\u003c/p\u003e\n\n\u003cp\u003eCloud Run もそうですが、\u003ca href=\"https://domains.google/intl/ja_jp/\"\u003eGoogle Domains\u003c/a\u003e や \u003ca href=\"https://cloud.google.com/monitoring\"\u003eCloud Monitoring\u003c/a\u003e の外形監視（稼働時間チェック）など、便利でライトに使える GCP を知ることが出来たことも収穫でした。\u003c/p\u003e\n\n\u003cp\u003eそれでは良い週末を！(^^)/\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e2022-11-04 追記：\u003c/strong\u003e\n個人ブログにオチを書きました。\n\u003ca href=\"https://masutaka.net/2022-11-04-1/\"\u003eHeroku から Cloud Run に移行して、料金は本当に3分の1になったのか | マスタカの ChangeLog メモ\u003c/a\u003e\u003c/p\u003e\n","contentSnippet":"こんにちは id:masutaka26 です。本日、週次の社内勉強会 FFTT で『引っ越ししたら家賃が3分の1になったかも』というタイトルで、実際は Amazon CloudFront + Heroku で動いていた自分のブログを GCP の Cloud Run に移行した話をしました。モチベーションはスライドにつらつら書きつつも、実際はこの FFTT の発表当番だったからではあります。結果的に満足行く結果にはなったので、これからコード管理などもう少し作り込んでいきます。今後ネタに困ったらまた引っ越せばよいし。Cloud Run もそうですが、Google Domains や Cloud Monitoring の外形監視（稼働時間チェック）など、便利でライトに使える GCP を知ることが出来たことも収穫でした。それでは良い週末を！(^^)/2022-11-04 追記：個人ブログにオチを書きました。Heroku から Cloud Run に移行して、料金は本当に3分の1になったのか | マスタカの ChangeLog メモ","link":"https://developer.feedforce.jp/entry/2022/09/30/180000","isoDate":"2022-09-30T09:00:00.000Z","dateMiliSeconds":1664528400000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20220930/20220930173417.png","authorName":"feedforce"},{"title":"OSS 版 Spectacles を使って、LookML の data tests や validation などを GitHub Actions で継続的に実行させてみた","content":"\u003cp\u003eこんにちは。\u003ca href=\"https://twitter.com/masutaka/status/1550357627779284992\"\u003e自称 Looker エバンジェリスト\u003c/a\u003eの \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e今日は Spectacles というツールを導入して、Looker インスタンスの健全性を高められた話を紹介します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#Spectacles-とは\"\u003eSpectacles とは\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#4-種類のテスト\"\u003e4 種類のテスト\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#基本的な振る舞い\"\u003e基本的な振る舞い\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#どのテストを採用しどのような課題を解決したのか\"\u003eどのテストを採用し、どのような課題を解決したのか\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#SQL-validation\"\u003eSQL validation\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Assert-validation\"\u003eAssert validation\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Content-validation\"\u003eContent validation\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#LookML-validation\"\u003eLookML validation\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#どのような-GitHub-Actions-にしたのか\"\u003eどのような GitHub Actions にしたのか\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#CI-workflow\"\u003eCI workflow\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Schedule-workflow\"\u003eSchedule workflow\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#落ち穂拾い\"\u003e落ち穂拾い\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#作業ブランチのゴミが残ることがある\"\u003e作業ブランチのゴミが残ることがある\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#マシンユーザーを作るか作らないか\"\u003eマシンユーザーを作るか作らないか\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"Spectacles-とは\"\u003eSpectacles とは\u003c/h2\u003e\n\n\u003cp\u003eSpectacles は Looker のサードパーティ CI ツールです。継続的に各種テストを実行し、Looker インスタンスを健全に保つことが出来ます。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.spectacles.dev/\"\u003eクラウド版\u003c/a\u003eと OSS 版があり、それぞれ過去にクラスメソッドや、Zenn の記事で紹介されたことがあります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://dev.classmethod.jp/articles/spectacles-looker-validation/\"\u003eSpectaclesでLooker（LookML）のテストをやってみた | DevelopersIO\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zenn.dev/skryo/articles/4f060327da2bf6\"\u003eLookerのCIツールであるSpectaclesを導入した話\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e今回は OSS 版を使いました。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fspectacles-ci%2Fspectacles\" title=\"GitHub - spectacles-ci/spectacles: A continuous integration tool for Looker and LookML.\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/spectacles-ci/spectacles\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch3 id=\"4-種類のテスト\"\u003e4 種類のテスト\u003c/h3\u003e\n\n\u003cp\u003e2022 年 9 月時点で 4 種類のテストが実装されています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.spectacles.dev/cli/tutorials/validators#the-sql-validator\"\u003eSQL validation\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e全ての Dimension の \u003ca href=\"https://cloud.google.com/looker/docs/reference/param-field-sql\"\u003esql\u003c/a\u003e パラメーターについて、実際にクエリを実行し、その有効性を検証する\u003c/li\u003e\n\u003cli\u003edata warehouse のリソースを過剰に使わないよう工夫されている。例えば BigQuery の料金は発生しない\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" rel=\"footnote\"\u003e1\u003c/a\u003e\u003c/sup\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.spectacles.dev/cli/tutorials/validators#the-assert-validator\"\u003eAssert validation\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eLookML IDE 上でも実行できる LookML data tests を実行する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.spectacles.dev/cli/tutorials/validators#the-content-validator\"\u003eContent validation\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e開発メニューの Content Validator 相当の検証を行い、エラーのある Dashboard や Look を特定する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.spectacles.dev/cli/tutorials/validators/#the-lookml-validator\"\u003eLookML validation\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eLookML IDE 上でも実行できる LookML validation を実行する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch3 id=\"基本的な振る舞い\"\u003e基本的な振る舞い\u003c/h3\u003e\n\n\u003cp\u003eSpectacles は Looker API を使用し、指定した Looker インスタンス上で、LookML data tests や validation などを実行します。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eSpectacles -(Looker API)-\u0026gt; Your Looker Instance\u003c/pre\u003e\n\n\n\u003cp\u003eいわゆるユニットテストでは、テスト環境でソースコードを checkout し、そこでテストを実行しますが、Spectacles はその点は全く違います。\u003c/p\u003e\n\n\u003cp\u003eつまり GitHub Actions 等の CI で動かす場合、LookML コードの checkout は不要ということです。\u003c/p\u003e\n\n\u003ch2 id=\"どのテストを採用しどのような課題を解決したのか\"\u003eどのテストを採用し、どのような課題を解決したのか\u003c/h2\u003e\n\n\u003ch3 id=\"SQL-validation\"\u003eSQL validation\u003c/h3\u003e\n\n\u003cp\u003eいきなりですが、こちらは今回採用出来ませんでした。\u003c/p\u003e\n\n\u003cp\u003e我々の環境で全ての Explore をテスト対象にすると、かなりの数のテストが失敗します。\u003ccode\u003ehidden: yes\u003c/code\u003e な Dimension がおそらく全てです。想定内です。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e$ spectacles sql --project my_project_name --profile -v\u003c/pre\u003e\n\n\n\u003cp\u003eそれならばと、\u003ccode\u003e--ignore-hidden\u003c/code\u003e オプションを付けると、今度はこんなエラーが発生します。どうやら 1 つも Dimension が表示されない Explore があるようです。こちらも想定内です。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eExplore object is missing dimensions, meaning this query won\u0026#39;t have fields and will error. Often this happens because you didn\u0026#39;t include dimensions when you built the project.\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003e--explore\u003c/code\u003e オプションでエラーが発生しない Explore を指定すればよいのですが、Explore が 150 個以上ある関係で、切り分けができていません。\u003c/p\u003e\n\n\u003cp\u003esql パラメーターは壊れていても、実際に Explore で当該 Dimension が使われないとエラーにならないのと、そのエラーが報告されるとも限らないので、いずれは再挑戦したいです。\u003c/p\u003e\n\n\u003ch3 id=\"Assert-validation\"\u003eAssert validation\u003c/h3\u003e\n\n\u003cp\u003e我々の Looker インスタンスでは、BigQuery の外部テーブルに Google スプレッドシートを指定したテーブルを数多く参照しています。つまり人間が編集するデータです。このようなデータはオペミスにより壊れることがあり、primary_key も芋づる式に壊れることがあります。\u003c/p\u003e\n\n\u003cp\u003eprimary_key はほぼ全てテストを書いています\u003csup id=\"fnref:2\"\u003e\u003ca href=\"#fn:2\" rel=\"footnote\"\u003e2\u003c/a\u003e\u003c/sup\u003eが、約 250 個と数が多いです。一方で LookML IDE 上での data tests は同時実行数が 1 に制限されているようで、テストに 10 分以上かかります。commit 前のテストを必須にできない状態でした。そのため、時々テストを手動実行しないと、壊れたことに気づけない課題がありました。\u003c/p\u003e\n\n\u003cp\u003e以上の課題を解決するために、定期的に LookML data tests を実行し、手動実行せずに気付けるようになりました。\u003c/p\u003e\n\n\u003ch3 id=\"Content-validation\"\u003eContent validation\u003c/h3\u003e\n\n\u003cp\u003e今までは私の注意力で Dashboard 約 140 個と Look 約 30 個のエラー数ゼロを継続できていましたが、まさに属人的でした。\u003c/p\u003e\n\n\u003cp\u003eこれも定期的に実行し、Content Validator を手動実行することなく気付けるようになりました。\u003c/p\u003e\n\n\u003ch3 id=\"LookML-validation\"\u003eLookML validation\u003c/h3\u003e\n\n\u003cp\u003e時々 LookML IDE を介さず、ローカル環境で git commit してデプロイすることがあります。そのケースで大きな変更をすることはないものの、validation が通らない LookML がデプロイされる確率はゼロではありません。\u003c/p\u003e\n\n\u003cp\u003eこちらは git push のタイミングで実行することで、健全性を高めることが出来ました。\u003c/p\u003e\n\n\u003ch2 id=\"どのような-GitHub-Actions-にしたのか\"\u003eどのような GitHub Actions にしたのか\u003c/h2\u003e\n\n\u003cp\u003egit push のタイミングで実行する CI workflow と、定期的に実行する Schedule workflow を作りました。\u003c/p\u003e\n\n\u003ch3 id=\"CI-workflow\"\u003eCI workflow\u003c/h3\u003e\n\n\u003cp\u003egit push のたびに、当該 commit のブランチに対して、LookML validation のテストをしています\u003csup id=\"fnref:3\"\u003e\u003ca href=\"#fn:3\" rel=\"footnote\"\u003e3\u003c/a\u003e\u003c/sup\u003e。\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e CI\n\n\u003cspan class=\"synIdentifier\"\u003eon\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003epush\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003ebranches-ignore\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # ①\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synConstant\"\u003e'dev-**'\u003c/span\u003e           \u003cspan class=\"synComment\"\u003e # LookML IDE の個人用開発ブランチ\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synConstant\"\u003e'tmp_spectacles_**'\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # spectacles の --commit-ref オプションが作るブランチ\u003c/span\u003e\n\n\u003cspan class=\"synIdentifier\"\u003ejobs\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003evalidate_lookml\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Validate LookML files\n    \u003cspan class=\"synIdentifier\"\u003eruns-on\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ubuntu-latest\n    \u003cspan class=\"synIdentifier\"\u003etimeout-minutes\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e5\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # デフォルトは 360 分。料金のスパイクを防ぐ\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003econcurrency\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # ② spectacles が複数同時に実行しないようにする\u003c/span\u003e\n      spectacles_should_be_run_in_series\n    \u003cspan class=\"synIdentifier\"\u003esteps\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003euses\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e actions/setup-python@v4\n      \u003cspan class=\"synIdentifier\"\u003ewith\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"synIdentifier\"\u003epython-version\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e'3.x'\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Install Spectacles\n      \u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e pip install spectacles\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Run LookML Validator\n      \u003cspan class=\"synIdentifier\"\u003eenv\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"synIdentifier\"\u003eLOOKER_BASE_URL\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;https://my_instance_name.looker.com\u0026quot;\u003c/span\u003e\n        \u003cspan class=\"synIdentifier\"\u003eLOOKER_CLIENT_ID\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ${{ secrets.SPECTACLES_LOOKER_CLIENT_ID }}\u003cspan class=\"synComment\"\u003e # ③\u003c/span\u003e\n        \u003cspan class=\"synIdentifier\"\u003eLOOKER_CLIENT_SECRET\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ${{ secrets.SPECTACLES_LOOKER_CLIENT_SECRET }}\u003cspan class=\"synComment\"\u003e # ③\u003c/span\u003e\n      \u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e spectacles lookml --project my_project_name --commit-ref \u003cspan class=\"synConstant\"\u003e\u0026quot;$GITHUB_SHA\u0026quot;\u003c/span\u003e -v\n\u003c/pre\u003e\n\n\n\u003cp\u003e①で特定のブランチを除外しています。特に今回のケースでは、\u003ccode\u003etmp_spectacles_**\u003c/code\u003e を設定しないと \u003ccode\u003evalidate_lookml\u003c/code\u003e ジョブが無限に起動し続けるため、絶対に必要です。\u003c/p\u003e\n\n\u003cp\u003e②も結構重要で、CI workflow と次に示す Schedule workflow から起動される spectacles プロセスの同時実行数を 1 に制限しています。\u003c/p\u003e\n\n\u003cp\u003eSpectacles は③と紐づく Looker ユーザーが実際に開発モードで \u003ccode\u003etmp_spectacles_**\u003c/code\u003e というブランチを作り、切り替えます。Looker では 1 人のユーザーが同時に利用できるブランチは 1 つだけです。Spectacles の複数起動は問題が発生するため、今回の制限を設定しました。\u003ca href=\"https://docs.spectacles.dev/cli/guides/how-to-deploy-spectacles/\"\u003e公式ドキュメント\u003c/a\u003eでも言及されています。\u003c/p\u003e\n\n\u003ch3 id=\"Schedule-workflow\"\u003eSchedule workflow\u003c/h3\u003e\n\n\u003cp\u003e早朝と夕方に master（デフォルト）ブランチ上で、Content validation と LookML data tests を実行しています。\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Schedule\n\n\u003cspan class=\"synIdentifier\"\u003eon\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003eschedule\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecron\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;00 21 * * 0-4\u0026quot;\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # 平日の  6:00 JST\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ecron\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;30  7 * * 1-5\u0026quot;\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # 平日の 16:30 JST\u003c/span\u003e\n\n\u003cspan class=\"synIdentifier\"\u003ejobs\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003eschedule\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Scheduled job\n    \u003cspan class=\"synIdentifier\"\u003eruns-on\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ubuntu-latest\n    \u003cspan class=\"synIdentifier\"\u003etimeout-minutes\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e30\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # デフォルトは 360 分。料金のスパイクを防ぐ\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003econcurrency\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # ① spectacles が複数同時に実行しないようにする\u003c/span\u003e\n      spectacles_should_be_run_in_series\n    \u003cspan class=\"synIdentifier\"\u003eenv\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synIdentifier\"\u003eLOOKER_BASE_URL\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;https://my_instance_name.looker.com\u0026quot;\u003c/span\u003e\n      \u003cspan class=\"synIdentifier\"\u003eLOOKER_CLIENT_ID\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ${{ secrets.SPECTACLES_LOOKER_CLIENT_ID }}\n      \u003cspan class=\"synIdentifier\"\u003eLOOKER_CLIENT_SECRET\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ${{ secrets.SPECTACLES_LOOKER_CLIENT_SECRET }}\n    \u003cspan class=\"synIdentifier\"\u003esteps\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003euses\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e actions/setup-python@v4\n      \u003cspan class=\"synIdentifier\"\u003ewith\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"synIdentifier\"\u003epython-version\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e'3.x'\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Install Spectacles\n      \u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e pip install spectacles\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Run Content Validator\n      \u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e spectacles content --project my_project_name -v\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Run LookML data tests\n      \u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e spectacles assert --project my_project_name -v\n\u003c/pre\u003e\n\n\n\u003cp\u003eブランチの時や、master ブランチへのマージ直後ではまだ Dashboard や Look がエラーになることがあるため、Content validation はこのタイミングにしています。\u003c/p\u003e\n\n\u003cp\u003eLookML data tests も 10 分以上かかることと、git push の粒度でやらないと不安というわけではないため、このタイミングにしています。BigQuery の料金もかかりますからね。\u003c/p\u003e\n\n\u003ch2 id=\"落ち穂拾い\"\u003e落ち穂拾い\u003c/h2\u003e\n\n\u003ch3 id=\"作業ブランチのゴミが残ることがある\"\u003e作業ブランチのゴミが残ることがある\u003c/h3\u003e\n\n\u003cp\u003eSpectacles が途中で異常終了すると、LookML IDE と GitHub に \u003ccode\u003etmp_spectacles_b016c8a4dd\u003c/code\u003e といった、Spectacles が作る作業ブランチが残ることがあります。気づいたら削除してあげましょう。\u003c/p\u003e\n\n\u003cp\u003e正常終了の場合は残りません。\u003c/p\u003e\n\n\u003ch3 id=\"マシンユーザーを作るか作らないか\"\u003eマシンユーザーを作るか作らないか\u003c/h3\u003e\n\n\u003cp\u003eLooker はユーザー課金モデルであるため、Spectacles のためにユーザーを作ることに躊躇するかもしれません。私もそうでした。おまけに Developer 相当の権限が必要なため、そこそこの料金です。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.spectacles.dev/app/guides/how-to-create-an-api-key\"\u003eCreate a Looker API Key | Spectacles Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003eWe strongly recommend creating \u003cstrong\u003ea dedicated Spectacles user in Looker\u003c/strong\u003e to ensure a human user doesn't accidentally change the Git branch or turn off development mode in the middle of a validation.\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eですが、公式ドキュメントで強く奨励されているとおり、Spectacles 専用のユーザーを作って下さい。\u003c/p\u003e\n\n\u003cp\u003e人間のユーザーは権限が大きすぎますし、前述のとおり Spectacles は実際に開発モードでブランチを作って切り替えるため、人間の作業とコンフリクトします。\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eSpectacles というツールを導入して、Looker インスタンスの健全性を高められた話をしました。\u003c/p\u003e\n\n\u003cp\u003e導入したのは先月ですが、導入の翌日にタイミング良く Schedule workflow のテストが落ち、primary_key が壊れたことに気づけたことにはニッコリしました。\u003c/p\u003e\n\n\u003cp\u003e私のようなボッチ LookML 開発者は、いかに作業を機械に任せるかが重要だと思います。心の平穏も大事です。また、あとから CI を導入するのは結構大変なので、始めから開発計画に組み込むことをオススメします。\u003c/p\u003e\n\n\u003cp\u003eそれでは良い Looker ライフを！(^^)/\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr/\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\"\u003e\n\u003cp\u003e\u003ca href=\"https://docs.spectacles.dev/app/explanation/limiting-resource-consumption/\"\u003eLimiting Resource Consumption | Spectacles Docs\u003c/a\u003e\u003ca href=\"#fnref:1\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003cli id=\"fn:2\"\u003e\n\u003cp\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2021/08/30/150000\"\u003eLooker で Join 先の view の primary_key をいい感じにテストする方法をようやく見つけた - Feedforce Developer Blog\u003c/a\u003e\u003ca href=\"#fnref:2\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003cli id=\"fn:3\"\u003e\n\u003cp\u003e実際には他のジョブや、失敗時の Slack 通知ジョブもありますが、分かりやすくするために省略しています。\u003ca href=\"#fnref:3\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n\n","contentSnippet":"こんにちは。自称 Looker エバンジェリストの id:masutaka26 です。今日は Spectacles というツールを導入して、Looker インスタンスの健全性を高められた話を紹介します。Spectacles とは4 種類のテスト基本的な振る舞いどのテストを採用し、どのような課題を解決したのかSQL validationAssert validationContent validationLookML validationどのような GitHub Actions にしたのかCI workflowSchedule workflow落ち穂拾い作業ブランチのゴミが残ることがあるマシンユーザーを作るか作らないかまとめSpectacles とはSpectacles は Looker のサードパーティ CI ツールです。継続的に各種テストを実行し、Looker インスタンスを健全に保つことが出来ます。クラウド版と OSS 版があり、それぞれ過去にクラスメソッドや、Zenn の記事で紹介されたことがあります。SpectaclesでLooker（LookML）のテストをやってみた | DevelopersIOLookerのCIツールであるSpectaclesを導入した話今回は OSS 版を使いました。github.com4 種類のテスト2022 年 9 月時点で 4 種類のテストが実装されています。SQL validation全ての Dimension の sql パラメーターについて、実際にクエリを実行し、その有効性を検証するdata warehouse のリソースを過剰に使わないよう工夫されている。例えば BigQuery の料金は発生しない1Assert validationLookML IDE 上でも実行できる LookML data tests を実行するContent validation開発メニューの Content Validator 相当の検証を行い、エラーのある Dashboard や Look を特定するLookML validationLookML IDE 上でも実行できる LookML validation を実行する基本的な振る舞いSpectacles は Looker API を使用し、指定した Looker インスタンス上で、LookML data tests や validation などを実行します。Spectacles -(Looker API)-\u003e Your Looker Instanceいわゆるユニットテストでは、テスト環境でソースコードを checkout し、そこでテストを実行しますが、Spectacles はその点は全く違います。つまり GitHub Actions 等の CI で動かす場合、LookML コードの checkout は不要ということです。どのテストを採用し、どのような課題を解決したのかSQL validationいきなりですが、こちらは今回採用出来ませんでした。我々の環境で全ての Explore をテスト対象にすると、かなりの数のテストが失敗します。hidden: yes な Dimension がおそらく全てです。想定内です。$ spectacles sql --project my_project_name --profile -vそれならばと、--ignore-hidden オプションを付けると、今度はこんなエラーが発生します。どうやら 1 つも Dimension が表示されない Explore があるようです。こちらも想定内です。Explore object is missing dimensions, meaning this query won't have fields and will error. Often this happens because you didn't include dimensions when you built the project.--explore オプションでエラーが発生しない Explore を指定すればよいのですが、Explore が 150 個以上ある関係で、切り分けができていません。sql パラメーターは壊れていても、実際に Explore で当該 Dimension が使われないとエラーにならないのと、そのエラーが報告されるとも限らないので、いずれは再挑戦したいです。Assert validation我々の Looker インスタンスでは、BigQuery の外部テーブルに Google スプレッドシートを指定したテーブルを数多く参照しています。つまり人間が編集するデータです。このようなデータはオペミスにより壊れることがあり、primary_key も芋づる式に壊れることがあります。primary_key はほぼ全てテストを書いています2が、約 250 個と数が多いです。一方で LookML IDE 上での data tests は同時実行数が 1 に制限されているようで、テストに 10 分以上かかります。commit 前のテストを必須にできない状態でした。そのため、時々テストを手動実行しないと、壊れたことに気づけない課題がありました。以上の課題を解決するために、定期的に LookML data tests を実行し、手動実行せずに気付けるようになりました。Content validation今までは私の注意力で Dashboard 約 140 個と Look 約 30 個のエラー数ゼロを継続できていましたが、まさに属人的でした。これも定期的に実行し、Content Validator を手動実行することなく気付けるようになりました。LookML validation時々 LookML IDE を介さず、ローカル環境で git commit してデプロイすることがあります。そのケースで大きな変更をすることはないものの、validation が通らない LookML がデプロイされる確率はゼロではありません。こちらは git push のタイミングで実行することで、健全性を高めることが出来ました。どのような GitHub Actions にしたのかgit push のタイミングで実行する CI workflow と、定期的に実行する Schedule workflow を作りました。CI workflowgit push のたびに、当該 commit のブランチに対して、LookML validation のテストをしています3。name: CIon:  push:    branches-ignore: # ①      - 'dev-**'            # LookML IDE の個人用開発ブランチ      - 'tmp_spectacles_**' # spectacles の --commit-ref オプションが作るブランチjobs:  validate_lookml:    name: Validate LookML files    runs-on: ubuntu-latest    timeout-minutes: 5 # デフォルトは 360 分。料金のスパイクを防ぐ    concurrency: # ② spectacles が複数同時に実行しないようにする      spectacles_should_be_run_in_series    steps:    - uses: actions/setup-python@v4      with:        python-version: '3.x'    - name: Install Spectacles      run: pip install spectacles    - name: Run LookML Validator      env:        LOOKER_BASE_URL: \"https://my_instance_name.looker.com\"        LOOKER_CLIENT_ID: ${{ secrets.SPECTACLES_LOOKER_CLIENT_ID }} # ③        LOOKER_CLIENT_SECRET: ${{ secrets.SPECTACLES_LOOKER_CLIENT_SECRET }} # ③      run: spectacles lookml --project my_project_name --commit-ref \"$GITHUB_SHA\" -v①で特定のブランチを除外しています。特に今回のケースでは、tmp_spectacles_** を設定しないと validate_lookml ジョブが無限に起動し続けるため、絶対に必要です。②も結構重要で、CI workflow と次に示す Schedule workflow から起動される spectacles プロセスの同時実行数を 1 に制限しています。Spectacles は③と紐づく Looker ユーザーが実際に開発モードで tmp_spectacles_** というブランチを作り、切り替えます。Looker では 1 人のユーザーが同時に利用できるブランチは 1 つだけです。Spectacles の複数起動は問題が発生するため、今回の制限を設定しました。公式ドキュメントでも言及されています。Schedule workflow早朝と夕方に master（デフォルト）ブランチ上で、Content validation と LookML data tests を実行しています。name: Scheduleon:  schedule:    - cron: \"00 21 * * 0-4\" # 平日の  6:00 JST    - cron: \"30  7 * * 1-5\" # 平日の 16:30 JSTjobs:  schedule:    name: Scheduled job    runs-on: ubuntu-latest    timeout-minutes: 30 # デフォルトは 360 分。料金のスパイクを防ぐ    concurrency: # ① spectacles が複数同時に実行しないようにする      spectacles_should_be_run_in_series    env:      LOOKER_BASE_URL: \"https://my_instance_name.looker.com\"      LOOKER_CLIENT_ID: ${{ secrets.SPECTACLES_LOOKER_CLIENT_ID }}      LOOKER_CLIENT_SECRET: ${{ secrets.SPECTACLES_LOOKER_CLIENT_SECRET }}    steps:    - uses: actions/setup-python@v4      with:        python-version: '3.x'    - name: Install Spectacles      run: pip install spectacles    - name: Run Content Validator      run: spectacles content --project my_project_name -v    - name: Run LookML data tests      run: spectacles assert --project my_project_name -vブランチの時や、master ブランチへのマージ直後ではまだ Dashboard や Look がエラーになることがあるため、Content validation はこのタイミングにしています。LookML data tests も 10 分以上かかることと、git push の粒度でやらないと不安というわけではないため、このタイミングにしています。BigQuery の料金もかかりますからね。落ち穂拾い作業ブランチのゴミが残ることがあるSpectacles が途中で異常終了すると、LookML IDE と GitHub に tmp_spectacles_b016c8a4dd といった、Spectacles が作る作業ブランチが残ることがあります。気づいたら削除してあげましょう。正常終了の場合は残りません。マシンユーザーを作るか作らないかLooker はユーザー課金モデルであるため、Spectacles のためにユーザーを作ることに躊躇するかもしれません。私もそうでした。おまけに Developer 相当の権限が必要なため、そこそこの料金です。Create a Looker API Key | Spectacles DocsWe strongly recommend creating a dedicated Spectacles user in Looker to ensure a human user doesn't accidentally change the Git branch or turn off development mode in the middle of a validation.ですが、公式ドキュメントで強く奨励されているとおり、Spectacles 専用のユーザーを作って下さい。人間のユーザーは権限が大きすぎますし、前述のとおり Spectacles は実際に開発モードでブランチを作って切り替えるため、人間の作業とコンフリクトします。まとめSpectacles というツールを導入して、Looker インスタンスの健全性を高められた話をしました。導入したのは先月ですが、導入の翌日にタイミング良く Schedule workflow のテストが落ち、primary_key が壊れたことに気づけたことにはニッコリしました。私のようなボッチ LookML 開発者は、いかに作業を機械に任せるかが重要だと思います。心の平穏も大事です。また、あとから CI を導入するのは結構大変なので、始めから開発計画に組み込むことをオススメします。それでは良い Looker ライフを！(^^)/Limiting Resource Consumption | Spectacles Docs↩Looker で Join 先の view の primary_key をいい感じにテストする方法をようやく見つけた - Feedforce Developer Blog↩実際には他のジョブや、失敗時の Slack 通知ジョブもありますが、分かりやすくするために省略しています。↩","link":"https://developer.feedforce.jp/entry/2022/09/16/130000","isoDate":"2022-09-16T04:00:00.000Z","dateMiliSeconds":1663300800000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20220914/20220914170914.png","authorName":"feedforce"},{"title":"Looker User Meetup Online #8 で『BigQuery経由で使うGoogleスプレッドシートのスキーマ管理』の話をした","content":"\u003cp\u003eこんばんは \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e本日、\u003ca href=\"https://looker-japan-user-group.connpass.com/event/253923/\"\u003eLooker User Meetup Online #8\u003c/a\u003e で『BigQuery経由で使うGoogleスプレッドシートのスキーマ管理』の話をしてきました。Looker User Meetup は 5 回目の参加、発表は初めてです。\u003c/p\u003e\n\n\u003ciframe src=\"https://docs.google.com/presentation/d/e/2PACX-1vTlQkD3R2OS415gr51ieTs1pyy3cK0ck8By1PYJ8SZtrFDjWyLP1eD_s7Q4UDH_yvmTDNdHFpZQf0IU/embed?start=false\u0026loop=false\u0026delayms=3000\" frameborder=\"0\" width=\"960\" height=\"410\" allowfullscreen=\"true\" mozallowfullscreen=\"true\" webkitallowfullscreen=\"true\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003eいくつかネタはあったのですが、今回のテーマは「Lookerまでのデータデリバリー、みんなどうしてる？」ということもあり、この 2 年で確立した方法を紹介することとなりました。\u003c/p\u003e\n\n\u003cp\u003ebq CLI ではなく、terraform で管理している方もいらっしゃいました。terraform の更新に追随するのはそれなりに大変だと思いますが、これならスキーマ定義と、実際のスキーマの差異検知は出来そうですね。\u003c/p\u003e\n\n\u003cp\u003e「dbt seed」を使っている方もいらっしゃるようでした。今回 2 つの発表があった dbt ですが、全く触ったことがありません。😇\u003c/p\u003e\n\n\u003cp\u003eあと、P24 で「BigQueryは一番左のシートしか参照できない」と書きましたが、誤りでした。範囲にでシート名も指定すれば出来ることを確認しました。P10 で華麗に「シート範囲」を無視してますね。💦\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://gist.github.com/masutaka/142ca20b802401d12012fe952f2ea1f3\"\u003eP18 の Gist\u003c/a\u003e との差分は以下になります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-diff\" data-lang=\"diff\" data-unlink\u003e\u003cspan class=\"synType\"\u003ediff --git a/define.json b/define.json\u003c/span\u003e\n\u003cspan class=\"synPreProc\"\u003eindex 9429e16..11d391c 100644\u003c/span\u003e\n\u003cspan class=\"synType\"\u003e--- a/define.json\u003c/span\u003e\n\u003cspan class=\"synType\"\u003e+++ b/define.json\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003e@@ -1,7 +1,8 @@\u003c/span\u003e\n {\n   \u0026quot;autodetect\u0026quot;: false,\n   \u0026quot;googleSheetsOptions\u0026quot;: {\n\u003cspan class=\"synSpecial\"\u003e-    \u0026quot;skipLeadingRows\u0026quot;: 1\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e+    \u0026quot;skipLeadingRows\u0026quot;: 1,\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e+    \u0026quot;range\u0026quot;: \u0026quot;マスターデータ!A:E\u0026quot;\u003c/span\u003e\n   },\n   \u0026quot;ignoreUnknownValues\u0026quot;: false,\n   \u0026quot;maxBadRecords\u0026quot;: 0,\n\u003c/pre\u003e\n\n\n\u003cp\u003e一人開発の弊害ではありますが、こうやってアウトプットすることでこそ得られるフィードバックとも言えます。ある意味期待通りです。😄\u003c/p\u003e\n\n\u003cp\u003e次回以降も需要があれば発表したいと思います。\u003c/p\u003e\n","contentSnippet":"こんばんは id:masutaka26 です。本日、Looker User Meetup Online #8 で『BigQuery経由で使うGoogleスプレッドシートのスキーマ管理』の話をしてきました。Looker User Meetup は 5 回目の参加、発表は初めてです。いくつかネタはあったのですが、今回のテーマは「Lookerまでのデータデリバリー、みんなどうしてる？」ということもあり、この 2 年で確立した方法を紹介することとなりました。bq CLI ではなく、terraform で管理している方もいらっしゃいました。terraform の更新に追随するのはそれなりに大変だと思いますが、これならスキーマ定義と、実際のスキーマの差異検知は出来そうですね。「dbt seed」を使っている方もいらっしゃるようでした。今回 2 つの発表があった dbt ですが、全く触ったことがありません。😇あと、P24 で「BigQueryは一番左のシートしか参照できない」と書きましたが、誤りでした。範囲にでシート名も指定すれば出来ることを確認しました。P10 で華麗に「シート範囲」を無視してますね。💦P18 の Gist との差分は以下になります。diff --git a/define.json b/define.jsonindex 9429e16..11d391c 100644--- a/define.json+++ b/define.json@@ -1,7 +1,8 @@ {   \"autodetect\": false,   \"googleSheetsOptions\": {-    \"skipLeadingRows\": 1+    \"skipLeadingRows\": 1,+    \"range\": \"マスターデータ!A:E\"   },   \"ignoreUnknownValues\": false,   \"maxBadRecords\": 0,一人開発の弊害ではありますが、こうやってアウトプットすることでこそ得られるフィードバックとも言えます。ある意味期待通りです。😄次回以降も需要があれば発表したいと思います。","link":"https://developer.feedforce.jp/entry/2022/07/21/210000","isoDate":"2022-07-21T12:00:00.000Z","dateMiliSeconds":1658404800000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"LAMS を導入して、LookML の再利用性を高められた","content":"\u003cp\u003eこんにちは、\u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003ca href=\"https://developer.feedforce.jp/entry/2022/06/17/110000\"\u003e先週\u003c/a\u003eに引き続いてのブログ更新です。\u003c/p\u003e\n\n\u003cp\u003eRuby や JavaScript などのプログラミング言語では、依存関係を管理することでコードの再利用性を高めるとともに、バグの少ないコードを書くことが出来ます。ただ、\u003ca href=\"https://docs.looker.com/ja/data-modeling/learning-lookml/what-is-lookml\"\u003eLookML\u003c/a\u003e はプログラミング言語ではないため、同じ方法が使えません。\u003c/p\u003e\n\n\u003cp\u003e今回は LAMS という LookML Linter を導入することで、LookML の再利用性を高める糸口を見つけました。LAMS を紹介しつつ、その知見を共有します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#LAMS-とは\"\u003eLAMS とは\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#導入方法\"\u003e導入方法\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#ルールの免除\"\u003eルールの免除\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#LookML-の再利用性を高められた-F1-ルール\"\u003eLookML の再利用性を高められた F1 ルール\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#注意事項\"\u003e注意事項\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"LAMS-とは\"\u003eLAMS とは\u003c/h2\u003e\n\n\u003cp\u003eLAMS (Look At Me Sideways) は LookML のスタイルガイドと Linter がセットになったツールです。準公式のツールなのかな？\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Flooker-open-source%2Flook-at-me-sideways\" title=\"GitHub - looker-open-source/look-at-me-sideways: A style guide and linter for Looker\u0026#39;s LookML data modeling language\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.com/looker-open-source/look-at-me-sideways\"\u003egithub.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eLookML IDE に付属する LookML validator が文法的な誤りを検出するのに対して、LAMS はメンテナンス性の高い、もう一歩進んだ LookML を提案します。\u003c/p\u003e\n\n\u003cp\u003e2022-06-21 現在、4 グループ、32 個のルールが定義されています。\u003c/p\u003e\n\n\u003cp\u003e🔗 \u003ca href=\"https://looker-open-source.github.io/look-at-me-sideways/rules.html\"\u003eLAMS Style Guide\u003c/a\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eKey Dimensions (K1 ~ K6)\u003c/li\u003e\n\u003cli\u003eOther Fields (F1 ~ F6)\u003c/li\u003e\n\u003cli\u003eDerived Tables (T1 ~ T15)\u003c/li\u003e\n\u003cli\u003eExplores (E1 ~ E5)\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch2 id=\"導入方法\"\u003e導入方法\u003c/h2\u003e\n\n\u003cp\u003eLinter を後から導入するのは辛いので、可能ならリポジトリを作るタイミングで導入するのが良いと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/looker-open-source/look-at-me-sideways#deployment-examples\"\u003eREADME の Deployment Examples\u003c/a\u003e には、ローカルマシンで実行する方法や、GitHub Actions や CircleCI などで CI する方法がまとまっています。\u003c/p\u003e\n\n\u003cp\u003e今回は GitHub Actions を採用しました。git push するたびに LAMS が実行され、結果を Pull request 上で確認出来ます。参考までにコードを貼っておきます。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e.github/workflows/ci.yml\u003c/strong\u003e\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e CI\n\n\u003cspan class=\"synIdentifier\"\u003eon\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e push\n\n\u003cspan class=\"synIdentifier\"\u003ejobs\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003elams\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e LAMS LookML Linter\n    \u003cspan class=\"synIdentifier\"\u003eruns-on\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ubuntu-latest\n    \u003cspan class=\"synIdentifier\"\u003esteps\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003euses\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e actions/checkout@v3\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003euses\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e actions/setup-node@v3\n      \u003cspan class=\"synIdentifier\"\u003ewith\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"synIdentifier\"\u003enode-version\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e'16'\u003c/span\u003e\u003cspan class=\"synComment\"\u003e # Use LTS https://nodejs.org/en/\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Install LAMS\n      \u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e npm install -g @looker/look-at-me-sideways@2\n    \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Run LAMS\n      \u003cspan class=\"synIdentifier\"\u003eenv\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"synIdentifier\"\u003eLOOKER_LICENSE_KEY\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e ${{ secrets.LOOKER_LICENSE_KEY }}\n      \u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e make lams\n\u003c/pre\u003e\n\n\n\u003cp\u003e\u003cstrong\u003eMakefile\u003c/strong\u003e \u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" rel=\"footnote\"\u003e1\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\n\u003cpre class=\"code makefile\" data-lang=\"makefile\" data-unlink\u003eLAMS := lams\nLOOKER_LICENSE_KEY := ${LOOKER_LICENSE_KEY}\nREPORT_USER := feedmatic_report@example.com\nSOURCE := **/{*.model,*.explore,*.view,*.layer,manifest}.lkml\n\n.PHONY: lams\nlams:\n    @$(LAMS) --reporting=yes --report-license-key=$(LOOKER_LICENSE_KEY) --report-user=$(REPORT_USER) --source=\u0026#39;$(SOURCE)\u0026#39;\u003c/pre\u003e\n\n\n\u003ch2 id=\"ルールの免除\"\u003eルールの免除\u003c/h2\u003e\n\n\u003cp\u003emanifest.lkml にこのように書くと、プロジェクト全体で任意のルールを免除することが出来ます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# LAMS\n# rule_exemptions: {\n#  F2: \u0026#34;Any explanatory message you would like\u0026#34;\n#  F3: \u0026#34;Another explanatory message for a different rule\u0026#34;\n# }\u003c/pre\u003e\n\n\n\u003cp\u003edimension, measure, derived_table 単位でも免除することが出来ます。基本はこちらで免除し、無理そうなら manifest.lkml で免除すると良いでしょう。\u003c/p\u003e\n\n\u003cp\u003e初めから全てのルールをパスすることは少ないと思うので、必要に応じて免除すると良いでしょう。また、LAMS はあくまでスタイルガイドなので、必ずしも全てのルールに対応する必要はありません。\u003c/p\u003e\n\n\u003ch2 id=\"LookML-の再利用性を高められた-F1-ルール\"\u003eLookML の再利用性を高められた F1 ルール\u003c/h2\u003e\n\n\u003cp\u003e32 個のルールのうち、今回は個人的に一番意義というか、感心した \u003ca href=\"https://looker-open-source.github.io/look-at-me-sideways/rules.html#f1\"\u003eF1\u003c/a\u003e ルールを紹介します。\u003c/p\u003e\n\n\u003cp\u003e例えば orders.view から users.view の \u003ccode\u003ecount\u003c/code\u003e measure を参照する、以下のような LookML があったとします。\u003c/p\u003e\n\n\u003cp\u003eLookML 書き始めの頃はこのように書きがちかと思いますが、F1 ルールでは NG です。orders.view が users.view に依存してしまうことで、orders.view の再利用がし辛くなるからです。そもそもこのケースでは LookML validation もエラーになるはずです。\u003csup id=\"fnref:2\"\u003e\u003ca href=\"#fn:2\" rel=\"footnote\"\u003e2\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eview: users {...}\n\nview: orders {\n  ...\n  measure: orders_per_user {\n    sql: ${count} / NULLIF(${users.count},0)\n  }\n}\n\nexplore: orders {} # Errors :(\n\nexplore: users {\n  join: orders {...}\n}\u003c/pre\u003e\n\n\n\u003cp\u003e解決方法がこちらです。まず、依存フィールドだけを抽出した users_orders.view を作ります。この view では sql_table_name や derived_table を設定しません。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eview: users {...}\nview: orders {...}\n\nview: users_orders {\n  # No need for a sql_table_name or derived_table\n  measure: orders_per_user {\n    sql: ${orders.count} / NULLIF(${users.count},0)\n  }\n}\u003c/pre\u003e\n\n\n\u003cp\u003eこうすることで少なくとも orders.explore は users.view に依存しないクリーンな LookML になりました。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eexplore: orders {} # Doesn\u0026#39;t break like before!\u003c/pre\u003e\n\n\n\u003cp\u003e次に users.explore で魔法を使います。users.view と users_orders.view の Join で通常指定するはずの \u003ccode\u003esql_on ... ;;\u003c/code\u003e の代わりに、空の SQL \u003ccode\u003esql: ;;\u003c/code\u003e を指定します。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eexplore: users {\n  join: orders {...}\n  join: users_orders {\n    sql: ;;\n    # Use `sql` instead of `sql_on` and put some whitespace in it\n    relationship: one_to_one\n    view_label: \u0026#34;Orders\u0026#34; # For cleaner explore UI\n  }\n}\u003c/pre\u003e\n\n\n\u003cp\u003eえ？と思うかもしれませんが、これは妥当な LookML です。\u003c/p\u003e\n\n\u003cp\u003eUsers explore が生成する SQL を確認すると分かりますが、\u003ccode\u003eorders_per_user\u003c/code\u003e measure を選択しても Join 句は増えません。しかしこの measure が参照するテーブルは既存の users と orders だけなので、構文エラーになりません。\u003c/p\u003e\n\n\u003cp\u003e初見での理解は難しくなりますが、orders.view の再利用性が高まるのは大きなメリットです。\u003c/p\u003e\n\n\u003ch2 id=\"注意事項\"\u003e注意事項\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://looker-open-source.github.io/look-at-me-sideways/rules.html#k1\"\u003eK1\u003c/a\u003e と \u003ca href=\"https://looker-open-source.github.io/look-at-me-sideways/rules.html#k2\"\u003eK2\u003c/a\u003e のように、一部のルールには依存関係があり、一方を免除するためには両方免除する必要があります。\u003c/p\u003e\n\n\u003cp\u003eあと、まだ \u003ca href=\"https://docs.looker.com/reference/view-params/extension-for-view\"\u003eExtension\u003c/a\u003e と \u003ca href=\"https://docs.looker.com/ja/data-modeling/learning-lookml/refinements\"\u003eRefinements\u003c/a\u003e に対応していません。Issue \u003ca href=\"https://github.com/looker-open-source/look-at-me-sideways/issues/46\"\u003e#46\u003c/a\u003e によると、\u003ca href=\"https://github.com/fabio-looker/node-lookml-parser\"\u003eパーサー\u003c/a\u003e側は対応したそうで、あとは LAMS 本体を対応するだけだそうです。割と致命的な課題...。\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eLookML の Linter である LAMS を紹介しました。うまく使うことで、再利用性やメンテナンス性の高い LookML を書くことが出来るかもしれません。\u003c/p\u003e\n\n\u003cp\u003eそれでは良い Looker ライフを！(^^)/\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr/\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\"\u003e\n\u003cp\u003eMakefile を作ったのは、ローカルで実行しやすくするためです。\u003ca href=\"#fnref:1\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003cli id=\"fn:2\"\u003e\n\u003cp\u003e\u003ca href=\"https://help.looker.com/hc/en-us/articles/360023586293-Error-Unknown-or-Inaccessible-Field\"\u003eF1 ルールに従わずにエラーを回避する方法はあります。\u003c/a\u003e\u003ca href=\"#fnref:2\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n\n","contentSnippet":"こんにちは、id:masutaka26 です。先週に引き続いてのブログ更新です。Ruby や JavaScript などのプログラミング言語では、依存関係を管理することでコードの再利用性を高めるとともに、バグの少ないコードを書くことが出来ます。ただ、LookML はプログラミング言語ではないため、同じ方法が使えません。今回は LAMS という LookML Linter を導入することで、LookML の再利用性を高める糸口を見つけました。LAMS を紹介しつつ、その知見を共有します。LAMS とは導入方法ルールの免除LookML の再利用性を高められた F1 ルール注意事項まとめLAMS とはLAMS (Look At Me Sideways) は LookML のスタイルガイドと Linter がセットになったツールです。準公式のツールなのかな？github.comLookML IDE に付属する LookML validator が文法的な誤りを検出するのに対して、LAMS はメンテナンス性の高い、もう一歩進んだ LookML を提案します。2022-06-21 現在、4 グループ、32 個のルールが定義されています。🔗 LAMS Style GuideKey Dimensions (K1 ~ K6)Other Fields (F1 ~ F6)Derived Tables (T1 ~ T15)Explores (E1 ~ E5)導入方法Linter を後から導入するのは辛いので、可能ならリポジトリを作るタイミングで導入するのが良いと思います。README の Deployment Examples には、ローカルマシンで実行する方法や、GitHub Actions や CircleCI などで CI する方法がまとまっています。今回は GitHub Actions を採用しました。git push するたびに LAMS が実行され、結果を Pull request 上で確認出来ます。参考までにコードを貼っておきます。.github/workflows/ci.ymlname: CIon: pushjobs:  lams:    name: LAMS LookML Linter    runs-on: ubuntu-latest    steps:    - uses: actions/checkout@v3    - uses: actions/setup-node@v3      with:        node-version: '16' # Use LTS https://nodejs.org/en/    - name: Install LAMS      run: npm install -g @looker/look-at-me-sideways@2    - name: Run LAMS      env:        LOOKER_LICENSE_KEY: ${{ secrets.LOOKER_LICENSE_KEY }}      run: make lamsMakefile 1LAMS := lamsLOOKER_LICENSE_KEY := ${LOOKER_LICENSE_KEY}REPORT_USER := feedmatic_report@example.comSOURCE := **/{*.model,*.explore,*.view,*.layer,manifest}.lkml.PHONY: lamslams:    @$(LAMS) --reporting=yes --report-license-key=$(LOOKER_LICENSE_KEY) --report-user=$(REPORT_USER) --source='$(SOURCE)'ルールの免除manifest.lkml にこのように書くと、プロジェクト全体で任意のルールを免除することが出来ます。# LAMS# rule_exemptions: {#  F2: \"Any explanatory message you would like\"#  F3: \"Another explanatory message for a different rule\"# }dimension, measure, derived_table 単位でも免除することが出来ます。基本はこちらで免除し、無理そうなら manifest.lkml で免除すると良いでしょう。初めから全てのルールをパスすることは少ないと思うので、必要に応じて免除すると良いでしょう。また、LAMS はあくまでスタイルガイドなので、必ずしも全てのルールに対応する必要はありません。LookML の再利用性を高められた F1 ルール32 個のルールのうち、今回は個人的に一番意義というか、感心した F1 ルールを紹介します。例えば orders.view から users.view の count measure を参照する、以下のような LookML があったとします。LookML 書き始めの頃はこのように書きがちかと思いますが、F1 ルールでは NG です。orders.view が users.view に依存してしまうことで、orders.view の再利用がし辛くなるからです。そもそもこのケースでは LookML validation もエラーになるはずです。2view: users {...}view: orders {  ...  measure: orders_per_user {    sql: ${count} / NULLIF(${users.count},0)  }}explore: orders {} # Errors :(explore: users {  join: orders {...}}解決方法がこちらです。まず、依存フィールドだけを抽出した users_orders.view を作ります。この view では sql_table_name や derived_table を設定しません。view: users {...}view: orders {...}view: users_orders {  # No need for a sql_table_name or derived_table  measure: orders_per_user {    sql: ${orders.count} / NULLIF(${users.count},0)  }}こうすることで少なくとも orders.explore は users.view に依存しないクリーンな LookML になりました。explore: orders {} # Doesn't break like before!次に users.explore で魔法を使います。users.view と users_orders.view の Join で通常指定するはずの sql_on ... ;; の代わりに、空の SQL sql: ;; を指定します。explore: users {  join: orders {...}  join: users_orders {    sql: ;;    # Use `sql` instead of `sql_on` and put some whitespace in it    relationship: one_to_one    view_label: \"Orders\" # For cleaner explore UI  }}え？と思うかもしれませんが、これは妥当な LookML です。Users explore が生成する SQL を確認すると分かりますが、orders_per_user measure を選択しても Join 句は増えません。しかしこの measure が参照するテーブルは既存の users と orders だけなので、構文エラーになりません。初見での理解は難しくなりますが、orders.view の再利用性が高まるのは大きなメリットです。注意事項K1 と K2 のように、一部のルールには依存関係があり、一方を免除するためには両方免除する必要があります。あと、まだ Extension と Refinements に対応していません。Issue #46 によると、パーサー側は対応したそうで、あとは LAMS 本体を対応するだけだそうです。割と致命的な課題...。まとめLookML の Linter である LAMS を紹介しました。うまく使うことで、再利用性やメンテナンス性の高い LookML を書くことが出来るかもしれません。それでは良い Looker ライフを！(^^)/Makefile を作ったのは、ローカルで実行しやすくするためです。↩F1 ルールに従わずにエラーを回避する方法はあります。↩","link":"https://developer.feedforce.jp/entry/2022/06/21/130000","isoDate":"2022-06-21T04:00:00.000Z","dateMiliSeconds":1655784000000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"Looker で困った時の解決手段まとめ","content":"\u003cp\u003eこんにちは、\u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e今回は少し前に社内に共有した記事を、このブログでも共有します。Looker は Ruby や Python 等のプログラミング言語よりはユーザーが少ないはずで、質問相手がいないと本当に困ります。この記事がその一助になれば幸いです。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#ググる\"\u003eググる\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#チャット\"\u003eチャット\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#問い合わせフォーム\"\u003e問い合わせフォーム\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Looker-Community-en\"\u003eLooker Community (en)\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Looker-Community-ja\"\u003eLooker Community (ja)\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Slack-Looker-User-Group---Japan\"\u003eSlack Looker User Group - Japan\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#番外編-製品についてのアイディアがありますか\"\u003e番外編: 製品についてのアイディアがありますか？\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"ググる\"\u003eググる\u003c/h2\u003e\n\n\u003cp\u003eさすがにこれは基本ですね。💦\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.looker.com/ja\"\u003e公式ドキュメント\u003c/a\u003e に誘導されることもしばしばです。これが結構よく出来ています。\u003ccode\u003elooker table calculation\u003c/code\u003e などと英語でググると、解決にたどり着きやすいかもしれません。\u003c/p\u003e\n\n\u003cp\u003eマニアックなテクニックとして、ググった URL の後ろに \u003ccode\u003e\u0026amp;gl=us\u0026amp;hl=en\u0026amp;gws_rd=cr\u003c/code\u003e を付け、検索対象を英語にして、日本語のノイズを減らす方法もあります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.google.com/search?q=looker+table+calculation\u0026oq=looker+table+calculation\u0026aqs=chrome..69i57.26j0j7\u0026sourceid=chrome\u0026ie=UTF-8\"\u003ehttps://www.google.com/search?q=looker+table+calculation\u0026oq=looker+table+calculation\u0026aqs=chrome..69i57.26j0j7\u0026sourceid=chrome\u0026ie=UTF-8\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e↓\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.google.com/search?q=looker+table+calculation\u0026oq=looker+table+calculation\u0026aqs=chrome..69i57.26j0j7\u0026sourceid=chrome\u0026ie=UTF-8\u0026gl=us\u0026hl=en\u0026gws_rd=cr\"\u003ehttps://www.google.com/search?q=looker+table+calculation\u0026oq=looker+table+calculation\u0026aqs=chrome..69i57.26j0j7\u0026sourceid=chrome\u0026ie=UTF-8\u0026gl=us\u0026hl=en\u0026gws_rd=cr\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e私はこんなブックマークレットを使っています。ちなみに名前は \u003ccode\u003een\u003c/code\u003e です。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003ejavascript:location.href=location.href+\u0026#39;\u0026amp;gl=us\u0026amp;hl=en\u0026amp;gws_rd=cr\u0026#39;\u003c/pre\u003e\n\n\n\u003ch2 id=\"チャット\"\u003eチャット\u003c/h2\u003e\n\n\u003cp\u003eAdmin 権限を持ったユーザーだけが使用できます。\u003c/p\u003e\n\n\u003cp\u003e日本語可ですが、日々混んでいるので急ぎでなければ次の「問い合わせフォーム」が良いと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20220616/20220616165108.png\" width=\"313\" height=\"400\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch2 id=\"問い合わせフォーム\"\u003e問い合わせフォーム\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://help.looker.com/hc/en-us/requests\"\u003ehttps://help.looker.com/hc/en-us/requests\u003c/a\u003e から \u003ccode\u003eCreate a New Request\u003c/code\u003e をクリックします。Looker ユーザーなら誰でも利用可能なのかな？日本語可です。\u003c/p\u003e\n\n\u003cp\u003eこのフォームは割と最近知ったのですが、問い合わせてみたら翌日返信が来て、速やかに解決できました。急がない時はチャットより良いと思います。サポートの方も時間に追われなくて良さそうです。\u003c/p\u003e\n\n\u003cp\u003e今までのチャット履歴もここで確認出来ます。これは知らなかった。\u003c/p\u003e\n\n\u003ch2 id=\"Looker-Community-en\"\u003eLooker Community (en)\u003c/h2\u003e\n\n\u003cp\u003e誰でも利用可能です。日本語不可。頻繁に投稿があります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://community.looker.com/\"\u003ehttps://community.looker.com/\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20220616/20220616173918.png\" width=\"1200\" height=\"489\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch2 id=\"Looker-Community-ja\"\u003eLooker Community (ja)\u003c/h2\u003e\n\n\u003cp\u003e誰でも利用可能な日本語コミュニティです。稀に投稿があります。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://community.looker.com/%E3%83%98%E3%83%AB%E3%83%97%E3%81%A8%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88-101\"\u003eコミュニティフォーラム (Japanese) \u003e ヘルプとサポート\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20220616/20220616174114.png\" width=\"1200\" height=\"458\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e⚠️ \u003ca href=\"https://community.looker.com/%E3%82%B3%E3%83%9F%E3%83%A5%E3%83%8B%E3%83%86%E3%82%A3%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A9%E3%83%A0-japanese-161\"\u003eコミュニティフォーラム (Japanese) のトップ\u003c/a\u003e で \u003ccode\u003eAsk question / Create topic\u003c/code\u003e ボタンをクリックすると en のほうにトピックが作られてしまいます。注意です。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20220616/20220616174411.png\" width=\"1116\" height=\"774\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eこのフォームが正解です。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20220616/20220616174446.png\" width=\"1200\" height=\"690\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch2 id=\"Slack-Looker-User-Group---Japan\"\u003eSlack Looker User Group - Japan\u003c/h2\u003e\n\n\u003cp\u003e日本語の Slack コミュニティもあります。\u003ca href=\"https://community.looker.com/%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%B9%E3%81%A8%E5%91%8A%E7%9F%A5-100/looker%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E4%BC%9Aslack%E3%81%AE%E3%81%94%E6%A1%88%E5%86%85-28903\"\u003e今年の初め (2022-01-14) に作られました\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://join.slack.com/t/lookerusergroup-japan/shared_invite/zt-1auagto9i-cT2lV~cejC7MgxMrzvveow\"\u003eこの招待リンク\u003c/a\u003eから参加出来ます。\u003c/p\u003e\n\n\u003ch2 id=\"番外編-製品についてのアイディアがありますか\"\u003e番外編: 製品についてのアイディアがありますか？\u003c/h2\u003e\n\n\u003cp\u003e新しい機能のアイディアを POST 出来る場所です。Admin 権限を持ったユーザーだけが使用できます。日本語不可です。\u003c/p\u003e\n\n\u003cp\u003e不具合も報告されることがあり、たまに 前述の「問い合わせフォーム」に誘導されています。それで知りました。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20220616/20220616175411.png\" width=\"391\" height=\"500\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003e私が知る限りの「Looker で困った時の解決手段」をまとめました。\u003c/p\u003e\n\n\u003cp\u003e以前紹介した情報収集も日々継続すれば、Looker のスキルはかなり高まる実感があります。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2021%2F08%2F16%2F150000\" title=\"私が１年かけて辿り着いた Looker の情報収集方法を紹介する - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003eそれでは良い Looker ライフを！(^^)/\u003c/p\u003e\n","contentSnippet":"こんにちは、id:masutaka26 です。今回は少し前に社内に共有した記事を、このブログでも共有します。Looker は Ruby や Python 等のプログラミング言語よりはユーザーが少ないはずで、質問相手がいないと本当に困ります。この記事がその一助になれば幸いです。ググるチャット問い合わせフォームLooker Community (en)Looker Community (ja)Slack Looker User Group - Japan番外編: 製品についてのアイディアがありますか？まとめググるさすがにこれは基本ですね。💦公式ドキュメント に誘導されることもしばしばです。これが結構よく出来ています。looker table calculation などと英語でググると、解決にたどり着きやすいかもしれません。マニアックなテクニックとして、ググった URL の後ろに \u0026gl=us\u0026hl=en\u0026gws_rd=cr を付け、検索対象を英語にして、日本語のノイズを減らす方法もあります。https://www.google.com/search?q=looker+table+calculation\u0026oq=looker+table+calculation\u0026aqs=chrome..69i57.26j0j7\u0026sourceid=chrome\u0026ie=UTF-8↓https://www.google.com/search?q=looker+table+calculation\u0026oq=looker+table+calculation\u0026aqs=chrome..69i57.26j0j7\u0026sourceid=chrome\u0026ie=UTF-8\u0026gl=us\u0026hl=en\u0026gws_rd=cr私はこんなブックマークレットを使っています。ちなみに名前は en です。javascript:location.href=location.href+'\u0026gl=us\u0026hl=en\u0026gws_rd=cr'チャットAdmin 権限を持ったユーザーだけが使用できます。日本語可ですが、日々混んでいるので急ぎでなければ次の「問い合わせフォーム」が良いと思います。問い合わせフォームhttps://help.looker.com/hc/en-us/requests から Create a New Request をクリックします。Looker ユーザーなら誰でも利用可能なのかな？日本語可です。このフォームは割と最近知ったのですが、問い合わせてみたら翌日返信が来て、速やかに解決できました。急がない時はチャットより良いと思います。サポートの方も時間に追われなくて良さそうです。今までのチャット履歴もここで確認出来ます。これは知らなかった。Looker Community (en)誰でも利用可能です。日本語不可。頻繁に投稿があります。https://community.looker.com/Looker Community (ja)誰でも利用可能な日本語コミュニティです。稀に投稿があります。コミュニティフォーラム (Japanese) \u003e ヘルプとサポート⚠️ コミュニティフォーラム (Japanese) のトップ で Ask question / Create topic ボタンをクリックすると en のほうにトピックが作られてしまいます。注意です。このフォームが正解です。Slack Looker User Group - Japan日本語の Slack コミュニティもあります。今年の初め (2022-01-14) に作られました。この招待リンクから参加出来ます。番外編: 製品についてのアイディアがありますか？新しい機能のアイディアを POST 出来る場所です。Admin 権限を持ったユーザーだけが使用できます。日本語不可です。不具合も報告されることがあり、たまに 前述の「問い合わせフォーム」に誘導されています。それで知りました。まとめ私が知る限りの「Looker で困った時の解決手段」をまとめました。以前紹介した情報収集も日々継続すれば、Looker のスキルはかなり高まる実感があります。それでは良い Looker ライフを！(^^)/","link":"https://developer.feedforce.jp/entry/2022/06/17/110000","isoDate":"2022-06-17T02:00:00.000Z","dateMiliSeconds":1655431200000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"LookML Validation を 20 秒から 11 秒に高速化出来た","content":"\u003cp\u003eこんにちは、\u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.looker.com/\"\u003eLooker\u003c/a\u003e を使い始めて 3 年目に突入しました。変わらず \u003ca href=\"https://feedmatic.net/\"\u003eFeedmatic\u003c/a\u003e という広告運用コンサルティングのデータ整備をする毎日です。\u003c/p\u003e\n\n\u003cp\u003e今回はここ 1 年の懸案だった LookML Validation の堪え難い遅さを改善出来たので、共有します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#2-年間でコード量が肥大化した\"\u003e2 年間でコード量が肥大化した\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#LookML-Validation-が堪え難いほど遅くなった\"\u003eLookML Validation が堪え難いほど遅くなった\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#My-LookML-Validator-is-slow\"\u003eMy LookML Validator is slow!\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#TLDR\"\u003eTL;DR\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Quick-wins\"\u003eQuick wins\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Long-answer\"\u003eLong answer\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Bonus-note\"\u003eBonus note\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#include-を最適化したら半分弱の時間になった\"\u003einclude を最適化したら半分弱の時間になった\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#余談\"\u003e余談\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#追記-LAMS-を使って-wildcard-include-を禁止する\"\u003e追記: LAMS を使って wildcard include を禁止する\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"2-年間でコード量が肥大化した\"\u003e2 年間でコード量が肥大化した\u003c/h2\u003e\n\n\u003cp\u003e2 年前と比べて Feedmatic プロジェクトの \u003ccode\u003e.lkml\u003c/code\u003e ファイルがものすごく増え、440 個、23,217 行\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" rel=\"footnote\"\u003e1\u003c/a\u003e\u003c/sup\u003eにもなりました。Explore は 62 個、\u003ca href=\"/entry/2021/08/30/150000\"\u003eテスト用\u003c/a\u003eも含めると 150 個もあります。相変わらず\u003ca href=\"/entry/2022/02/04/180000\"\u003eボッチ LookML 開発者\u003c/a\u003eではあるのですが。💦\u003c/p\u003e\n\n\u003cp\u003eさて、\u003ca href=\"/entry/2020/10/23/190000\"\u003eLooker の JumpStart\u003c/a\u003e で教えて頂いた「モデル編成のベストプラクティス」のうちの 1 つにこちらがありました。\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003eユーザーが必要とする答えに簡単にアクセスできる、可能な限り少ない数の explore を使用する。\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eしかし、広告運用の文脈だと、クライアントごとに独自実装が必要なケースが多く、このコード量になってしまいました。💦\u003c/p\u003e\n\n\u003ch2 id=\"LookML-Validation-が堪え難いほど遅くなった\"\u003eLookML Validation が堪え難いほど遅くなった\u003c/h2\u003e\n\n\u003cp\u003eそんな LookML 開発に使用する Looker IDE には LookML Validator が付属しており、git commit 前に強制する設定をしています。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdocs.looker.com%2Fja%2Fdata-modeling%2Fgetting-started%2Flookml-validation%23validating_your_lookml\" title=\"Editing and validating LookML\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://docs.looker.com/ja/data-modeling/getting-started/lookml-validation#validating_your_lookml\"\u003edocs.looker.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e以前は一瞬で完了していましたが、最近は 20 秒以上かかります。ちょっとコメントを書き換えただけでこれだけ待たされるのは、なかなかの苦行です。\u003c/p\u003e\n\n\u003cp\u003e試作した別プロジェクト（41 ファイル、1999 行）はそんなにかからないため、単純にコード量に比例していると思いました。\u003c/p\u003e\n\n\u003cp\u003e念のため Looker のサポートに質問したところ、やはりコード量（プロジェクトのサイズ）が影響しているそう。そして Looker インスタンスの CPU やメモリ使用量に問題はないとのこと。\u003c/p\u003e\n\n\u003cp\u003eさらに、こちらの記事を紹介して頂きました。🙏\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fcommunity.looker.com%2Ftechnical-tips-tricks-1021%2Fmy-lookml-validator-is-slow-23592\" title=\"My LookML Validator is slow! | Looker Community\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://community.looker.com/technical-tips-tricks-1021/my-lookml-validator-is-slow-23592\"\u003ecommunity.looker.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2 id=\"My-LookML-Validator-is-slow\"\u003eMy LookML Validator is slow!\u003c/h2\u003e\n\n\u003cp\u003e長い記事ではないので、ざっと翻訳します。\u003c/p\u003e\n\n\u003ch3 id=\"TLDR\"\u003eTL;DR\u003c/h3\u003e\n\n\u003cp\u003eプロジェクトが大きければ大きいほど、検証には時間がかかります。\u003c/p\u003e\n\n\u003ch3 id=\"Quick-wins\"\u003eQuick wins\u003c/h3\u003e\n\n\u003col\u003e\n\u003cli\u003e戦略的に \"includes\" する\n\n\u003col\u003e\n\u003cli\u003e常に他のすべてのビューをインクルードすることは開発上簡単かもしれないが、命名規則を使って必要なファイルだけを戦略的にインクルードすることで、パフォーマンスを向上させることができる\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e使用しない explore（および join、field など）をコメントアウトまたは削除する\u003c/li\u003e\n\u003cli\u003eプロジェクトを複数のプロジェクトに分割することを検討する\u003c/li\u003e\n\u003c/ol\u003e\n\n\n\u003cp\u003eLookML のベストプラクティスについては、\u003ca href=\"https://community.looker.com/lookml-5/lookml-best-practices-1636\"\u003eこちらの記事\u003c/a\u003eをご覧ください。\u003c/p\u003e\n\n\u003ch3 id=\"Long-answer\"\u003eLong answer\u003c/h3\u003e\n\n\u003cp\u003eLookML のプロジェクトサイズ（総行数）と不要な \u003ccode\u003einclude\u003c/code\u003e の両方が LookML Validator の性能に影響を及ぼします。\u003c/p\u003e\n\n\u003cp\u003eValidation は 2 段階のプロセスで行われます。\u003c/p\u003e\n\n\u003cp\u003e1) 1 回目の検証では、プロジェクト内のすべてのファイルを読み込み、どこにも参照されていないファイルも含めて、メモリに読み込み、ソースコードを 1 モデルずつ完全に翻訳して、「コンパイル」エラーを探します。\u003c/p\u003e\n\n\u003cp\u003e2) 2 回目の検証は、各モデルで開始し、そのモデルから参照されるファイルのみを解析します。そして、そのモデルに基づいてクエリーを構築し、クエリーエラーや「実行時」エラーを探します。また、これらのパスは、すべての検証で行われることも重要です。\u003c/p\u003e\n\n\u003cp\u003e結論として、1 回目の検証は LookML プロジェクトのサイズに、2 回目の検証は不要な \u003ccode\u003einclude\u003c/code\u003e 文に影響されます。したがって、LookML プロジェクトのサイズを適切に保つと同時に、より選択的かつ戦略的な \u003ccode\u003einclude\u003c/code\u003e を推奨するのが良いでしょう。\u003c/p\u003e\n\n\u003ch3 id=\"Bonus-note\"\u003eBonus note\u003c/h3\u003e\n\n\u003cp\u003eExplore ごとのフィールド数は、検証時間という点で非常に重要です。これはしばしばモデルのパースよりも時間がかかります。\u003c/p\u003e\n\n\u003ch2 id=\"include-を最適化したら半分弱の時間になった\"\u003einclude を最適化したら半分弱の時間になった\u003c/h2\u003e\n\n\u003cp\u003e今回は「戦略的に \"includes\" する」をやってみました。\u003c/p\u003e\n\n\u003cp\u003e具体的には 56 個の \u003ccode\u003e.explore.lkml\u003c/code\u003e ファイルを以下のように変更しました。ワイルドカード付きの \u003ccode\u003einclude\u003c/code\u003e を出来るだけ減らしました。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# 変更前\ninclude: \u0026#34;/views/**/*.view\u0026#34;\n\n↓\n\n# 変更後\ninclude: \u0026#34;/views/view1.view\u0026#34;\ninclude: \u0026#34;/views/view2.view\u0026#34;\ninclude: \u0026#34;/views/view3.view\u0026#34;\ninclude: \u0026#34;/views/view4.view\u0026#34;\ninclude: \u0026#34;/views/view5.view\u0026#34;\u003c/pre\u003e\n\n\n\u003cp\u003e結果がこちら。たったこれだけで、20 秒かかっていた LookML validation が 12 秒弱にまで縮まりました。期待以上です！👏😂🎉\u003c/p\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:right;\"\u003e \u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e 変更前（秒） \u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e 変更後（秒） \u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:right;\"\u003e 1 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 20.46 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 12.39 \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:right;\"\u003e 2 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 20.44 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 11.89 \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:right;\"\u003e 3 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 20.05 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 11.69 \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:right;\"\u003e 3 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 20.61 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 11.65 \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:right;\"\u003e 5 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 20.48 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 11.95 \u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:right;\"\u003e 平均 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 20.41 \u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e 11.91 \u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\n\u003cp\u003eついでに、事情があって隠している Explore 10 個\u003csup id=\"fnref:2\"\u003e\u003ca href=\"#fn:2\" rel=\"footnote\"\u003e2\u003c/a\u003e\u003c/sup\u003eの削除を確認してみたら、さらに速くなり、9 秒程度まで縮まりました。なるほど。\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eここ 1 年の懸案だった LookML Validation のパフォーマンスを改善しました。\u003c/p\u003e\n\n\u003cp\u003einclude を最適化するだけで、ここまで速くなるとは驚きでした。おまけに LookML Validation のプロセスも理解することもできました。\u003c/p\u003e\n\n\u003cp\u003e💭 コンパイラ側で良しなにするのは難しいのかな、\u003ca href=\"https://github.com/looker-open-source/look-at-me-sideways\"\u003eLAMS\u003c/a\u003e で警告してくれれば良いのかな。\u003c/p\u003e\n\n\u003cp\u003e引き続き、LookML 開発を妨げる課題があれば、解決していきます。💪\u003c/p\u003e\n\n\u003ch2 id=\"余談\"\u003e余談\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eValidate LookML\u003c/code\u003e をクリックすると、すぐ \u003ccode\u003eValidate LookML\u003c/code\u003e に戻ることがあるのですが、なんででしょう...？ファイル保存直後だとほぼ発生します。\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/170014/170627597-55819ca6-7394-4900-9e33-9ed0c1ce2492.gif\" alt=\"looker\" /\u003e\u003c/p\u003e\n\n\u003cp\u003eValidation が終わる時間くらいまで待つと 2 回クリックしなくて良いみたいです。🙄\u003c/p\u003e\n\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/170014/170627672-f1bf212b-ab73-48f3-9feb-4e8f751984b6.gif\" alt=\"looker2\" /\u003e\u003c/p\u003e\n\n\u003ch2 id=\"追記-LAMS-を使って-wildcard-include-を禁止する\"\u003e追記: LAMS を使って wildcard include を禁止する\u003c/h2\u003e\n\n\u003cp\u003eLookML の Linter として LAMS というものがあります。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2022%2F06%2F21%2F130000\" title=\"LAMS を導入して、LookML の再利用性を高められた - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2022/06/21/130000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eこのカスタムルールを定義することで、今回のようなワイルドカード付きの \u003ccode\u003einclude\u003c/code\u003e を禁止することが出来ます。\u003c/p\u003e\n\n\u003cp\u003emanifest.lkml にこのように書くだけです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# LAMS\n# rule: NO_WINC {\n#  description: \u0026#34;Prohibit wildcard include to avoid increasing LookML verification time\u0026#34;\n#  match: \u0026#34;$.files.*.include.*\u0026#34;\n#  expr_rule: ($let file_path ($get ::project files ::path:2 $file_path))\n#             ($if ($match \u0026#34;\\\\*\u0026#34; ::match)\n#                 ($concat \u0026#34;Found wildcard include \u0026#39;\u0026#34; ::match \u0026#34;\u0026#39; in \u0026#34; ::file_path \u0026#34;\u0026#34;)\n#               true) ;;\n# }\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ca href=\"https://looker-open-source.github.io/look-at-me-sideways/customizing-lams\"\u003eCustomizing LAMS\u003c/a\u003e にさらりと書いてありますが、指摘されたファイル名を出す方法が分からなかったので、Issue \u003ca href=\"https://github.com/looker-open-source/look-at-me-sideways/issues/95\"\u003e#95\u003c/a\u003e で質問したら分かりました。これは分からない。💦\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr/\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\"\u003e\n\u003cp\u003eコメントと空行を除く\u003ca href=\"#fnref:1\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003cli id=\"fn:2\"\u003e\n\u003cp\u003e\u003ccode\u003e.explore.lkml\u003c/code\u003e 10 個、\u003ccode\u003e.view.lkml\u003c/code\u003e 10 個、\u003ccode\u003e.layer.lkml\u003c/code\u003e 31 個\u003ca href=\"#fnref:2\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n\n","contentSnippet":"こんにちは、id:masutaka26 です。Looker を使い始めて 3 年目に突入しました。変わらず Feedmatic という広告運用コンサルティングのデータ整備をする毎日です。今回はここ 1 年の懸案だった LookML Validation の堪え難い遅さを改善出来たので、共有します。2 年間でコード量が肥大化したLookML Validation が堪え難いほど遅くなったMy LookML Validator is slow!TL;DRQuick winsLong answerBonus noteinclude を最適化したら半分弱の時間になったまとめ余談追記: LAMS を使って wildcard include を禁止する2 年間でコード量が肥大化した2 年前と比べて Feedmatic プロジェクトの .lkml ファイルがものすごく増え、440 個、23,217 行1にもなりました。Explore は 62 個、テスト用も含めると 150 個もあります。相変わらずボッチ LookML 開発者ではあるのですが。💦さて、Looker の JumpStart で教えて頂いた「モデル編成のベストプラクティス」のうちの 1 つにこちらがありました。ユーザーが必要とする答えに簡単にアクセスできる、可能な限り少ない数の explore を使用する。しかし、広告運用の文脈だと、クライアントごとに独自実装が必要なケースが多く、このコード量になってしまいました。💦LookML Validation が堪え難いほど遅くなったそんな LookML 開発に使用する Looker IDE には LookML Validator が付属しており、git commit 前に強制する設定をしています。docs.looker.com以前は一瞬で完了していましたが、最近は 20 秒以上かかります。ちょっとコメントを書き換えただけでこれだけ待たされるのは、なかなかの苦行です。試作した別プロジェクト（41 ファイル、1999 行）はそんなにかからないため、単純にコード量に比例していると思いました。念のため Looker のサポートに質問したところ、やはりコード量（プロジェクトのサイズ）が影響しているそう。そして Looker インスタンスの CPU やメモリ使用量に問題はないとのこと。さらに、こちらの記事を紹介して頂きました。🙏community.looker.comMy LookML Validator is slow!長い記事ではないので、ざっと翻訳します。TL;DRプロジェクトが大きければ大きいほど、検証には時間がかかります。Quick wins戦略的に \"includes\" する常に他のすべてのビューをインクルードすることは開発上簡単かもしれないが、命名規則を使って必要なファイルだけを戦略的にインクルードすることで、パフォーマンスを向上させることができる使用しない explore（および join、field など）をコメントアウトまたは削除するプロジェクトを複数のプロジェクトに分割することを検討するLookML のベストプラクティスについては、こちらの記事をご覧ください。Long answerLookML のプロジェクトサイズ（総行数）と不要な include の両方が LookML Validator の性能に影響を及ぼします。Validation は 2 段階のプロセスで行われます。1) 1 回目の検証では、プロジェクト内のすべてのファイルを読み込み、どこにも参照されていないファイルも含めて、メモリに読み込み、ソースコードを 1 モデルずつ完全に翻訳して、「コンパイル」エラーを探します。2) 2 回目の検証は、各モデルで開始し、そのモデルから参照されるファイルのみを解析します。そして、そのモデルに基づいてクエリーを構築し、クエリーエラーや「実行時」エラーを探します。また、これらのパスは、すべての検証で行われることも重要です。結論として、1 回目の検証は LookML プロジェクトのサイズに、2 回目の検証は不要な include 文に影響されます。したがって、LookML プロジェクトのサイズを適切に保つと同時に、より選択的かつ戦略的な include を推奨するのが良いでしょう。Bonus noteExplore ごとのフィールド数は、検証時間という点で非常に重要です。これはしばしばモデルのパースよりも時間がかかります。include を最適化したら半分弱の時間になった今回は「戦略的に \"includes\" する」をやってみました。具体的には 56 個の .explore.lkml ファイルを以下のように変更しました。ワイルドカード付きの include を出来るだけ減らしました。# 変更前include: \"/views/**/*.view\"↓# 変更後include: \"/views/view1.view\"include: \"/views/view2.view\"include: \"/views/view3.view\"include: \"/views/view4.view\"include: \"/views/view5.view\"結果がこちら。たったこれだけで、20 秒かかっていた LookML validation が 12 秒弱にまで縮まりました。期待以上です！👏😂🎉  変更前（秒）  変更後（秒）  1  20.46  12.39  2  20.44  11.89  3  20.05  11.69  3  20.61  11.65  5  20.48  11.95  平均  20.41  11.91 ついでに、事情があって隠している Explore 10 個2の削除を確認してみたら、さらに速くなり、9 秒程度まで縮まりました。なるほど。まとめここ 1 年の懸案だった LookML Validation のパフォーマンスを改善しました。include を最適化するだけで、ここまで速くなるとは驚きでした。おまけに LookML Validation のプロセスも理解することもできました。💭 コンパイラ側で良しなにするのは難しいのかな、LAMS で警告してくれれば良いのかな。引き続き、LookML 開発を妨げる課題があれば、解決していきます。💪余談Validate LookML をクリックすると、すぐ Validate LookML に戻ることがあるのですが、なんででしょう...？ファイル保存直後だとほぼ発生します。Validation が終わる時間くらいまで待つと 2 回クリックしなくて良いみたいです。🙄追記: LAMS を使って wildcard include を禁止するLookML の Linter として LAMS というものがあります。developer.feedforce.jpこのカスタムルールを定義することで、今回のようなワイルドカード付きの include を禁止することが出来ます。manifest.lkml にこのように書くだけです。# LAMS# rule: NO_WINC {#  description: \"Prohibit wildcard include to avoid increasing LookML verification time\"#  match: \"$.files.*.include.*\"#  expr_rule: ($let file_path ($get ::project files ::path:2 $file_path))#             ($if ($match \"\\\\*\" ::match)#                 ($concat \"Found wildcard include '\" ::match \"' in \" ::file_path \"\")#               true) ;;# }Customizing LAMS にさらりと書いてありますが、指摘されたファイル名を出す方法が分からなかったので、Issue #95 で質問したら分かりました。これは分からない。💦コメントと空行を除く↩.explore.lkml 10 個、.view.lkml 10 個、.layer.lkml 31 個↩","link":"https://developer.feedforce.jp/entry/2022/05/30/110000","isoDate":"2022-05-30T02:00:00.000Z","dateMiliSeconds":1653876000000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"『ボッチLookML開発者兼データ整備人を連れてきたよ！』という発表をした","content":"\u003cp\u003eこんにちは \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e本日、週次の社内勉強会 \u003ca href=\"https://developer.feedforce.jp/archive/category/FFTT\"\u003eFFTT\u003c/a\u003e で『ボッチLookML開発者兼データ整備人を連れてきたよ！』というひどいタイトルの発表をしました。\u003c/p\u003e\n\n\u003ciframe src=\"https://docs.google.com/presentation/d/e/2PACX-1vTv911SmUBM9fAk-IKQM9139Q29fU7INnUHwbFeOBxolqyybPdlcFHW2dAHBTgr3P9J_kL0Xdhbe38L/embed?start=false\u0026loop=false\u0026delayms=3000\" frameborder=\"0\" width=\"960\" height=\"410\" allowfullscreen=\"true\" mozallowfullscreen=\"true\" webkitallowfullscreen=\"true\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003e2020 年 4 月から Looker に関わって得たことをまとめた内容であるとともに、1 年半近く前からのアップデートになります。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2020%2F10%2F23%2F190000\" title=\"『4月から取り組んできたLookerの導入から実装までのお話（Redashとも比較）』という発表をした - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2020/10/23/190000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e世に出ている Looker の情報はキラキラしているものが多く、ツラい話をそれほど目にしません。\u003cs\u003e絶対にあるはずなのに！😭\u003c/s\u003e\u003c/p\u003e\n\n\u003cp\u003eそれならば！とツラい話や解決が困難な話を散りばめさせてもらいました。課題が共有されて初めて知見が役に立つと思いますからね。\u003cem\u003e解決した課題もあるよ（小声）。\u003c/em\u003e\u003c/p\u003e\n\n\u003cp\u003eそれでは良い週末を！(^^)/\u003c/p\u003e\n","contentSnippet":"こんにちは id:masutaka26 です。本日、週次の社内勉強会 FFTT で『ボッチLookML開発者兼データ整備人を連れてきたよ！』というひどいタイトルの発表をしました。2020 年 4 月から Looker に関わって得たことをまとめた内容であるとともに、1 年半近く前からのアップデートになります。developer.feedforce.jp世に出ている Looker の情報はキラキラしているものが多く、ツラい話をそれほど目にしません。絶対にあるはずなのに！😭それならば！とツラい話や解決が困難な話を散りばめさせてもらいました。課題が共有されて初めて知見が役に立つと思いますからね。解決した課題もあるよ（小声）。それでは良い週末を！(^^)/","link":"https://developer.feedforce.jp/entry/2022/02/04/180000","isoDate":"2022-02-04T09:00:00.000Z","dateMiliSeconds":1643965200000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"LookML 開発で使っているディレクトリ構造を紹介する","content":"\u003cp\u003eこんにちは、\u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003eこの記事は Looker Advent Calendar 2021 の 13 日目の記事です。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fadvent-calendar%2F2021%2Flooker\" title=\"Calendar for Looker | Advent Calendar 2021 - Qiita\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://qiita.com/advent-calendar/2021/looker\"\u003eqiita.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e昨日は Yappli 阿部さんの「\u003ca href=\"https://tech.yappli.io/entry/2021/12/12/Sexy_Tech_for_You_9\"\u003eLookerの目標値やストップワードを、Googleスプレッドシート連携でお手軽管理【Sexy Tech for You #9】\u003c/a\u003e」でした。Looker を使うとこのような LookML を書くだけで、ビジネスユーザーが SQL を書くことなく、本業に集中できるのはとても良いですよね。\u003c/p\u003e\n\n\u003cp\u003e個人的には、SQL ベースの派生テーブルの中で join するよりも、explore で join したほうが Looker らしく、メンテナンス性が良い気がしました。\u003ca href=\"https://help.looker.com/hc/en-us/articles/360023722974\"\u003esymmetric 集計\u003c/a\u003eが働くため、ファンアウトも避けられます。wikipedia テーブルに関しては、永続的な派生テーブル（PDT）を使って BigQuery のスキャンサイズを抑えるのも良さそうです。\u003c/p\u003e\n\n\u003cp\u003e、、、( ﾟдﾟ)ハッ！ついマジレスをしてしまいました。💦\u003c/p\u003e\n\n\u003cp\u003e今回は dimension が null の measure を（0 ではなく）ø にする少しマニアックな記事を書く予定でしたが、先日の \u003ca href=\"https://looker-japan-user-group.connpass.com/event/233775/\"\u003eLooker User Meetup Online #7\u003c/a\u003e で、LookML のディレクトリ構造を知りたいというチャットをお見かけしたので、今回はその話を書くことにしました。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#今回のプロジェクトの規模感\"\u003e今回のプロジェクトの規模感\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#デフォルトのディレクトリ構造\"\u003eデフォルトのディレクトリ構造？\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#特別なファイル形式を知る\"\u003e特別なファイル形式を知る\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#最近使っているディレクトリ構造\"\u003e最近使っているディレクトリ構造\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#bigquery\"\u003ebigquery/\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#model1modellkml\"\u003emodel1.model.lkml\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#explores\"\u003eexplores/\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#views\"\u003eviews/\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#tests\"\u003etests/\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#manifestlkml\"\u003emanifest.lkml\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#2021-12-29-追記\"\u003e2021-12-29 追記\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"今回のプロジェクトの規模感\"\u003e今回のプロジェクトの規模感\u003c/h2\u003e\n\n\u003cp\u003eプロジェクトの規模感によってディレクトリ構造は変わると思うので、先に書いておきます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eLooker インスタンスに 1 つだけ LookML プロジェクトが存在する\u003c/li\u003e\n\u003cli\u003eBigQuery Dataset 76 個\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e.lkml\u003c/code\u003e ファイル 277 個\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e.model.lkml\u003c/code\u003e ファイル 1 個\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e.explore.lkml\u003c/code\u003e ファイル 56 個\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e.view.lkml\u003c/code\u003e ファイル 139 個\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e.test.lkml\u003c/code\u003e ファイル 78 個\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eLookML 開発者 1 名\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch2 id=\"デフォルトのディレクトリ構造\"\u003eデフォルトのディレクトリ構造？\u003c/h2\u003e\n\n\u003cp\u003eこの記事を書くまで誤解をしていたのですが、デフォルトのディレクトリ構造というものはなかったのですね。この記事を書くために改めて Blank Project を作ったら、ファイルもディレクトリも何もないプロジェクトが作られました。\u003c/p\u003e\n\n\u003cp\u003eモデルファイルを作るとこのようなコードが展開されるので、\u003ccode\u003e.view.lkml\u003c/code\u003e に関しては \u003ccode\u003e/views/\u003c/code\u003e 以下に作る方が多いと思います。私もそうでした。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003einclude: \u0026#34;/views/*.view.lkml\u0026#34;                # include all views in the views/ folder in this project\n# include: \u0026#34;/**/*.view.lkml\u0026#34;                 # include all views in this project\n# include: \u0026#34;my_dashboard.dashboard.lookml\u0026#34;   # include a lookml dashboard called my_dashboard\u003c/pre\u003e\n\n\n\u003cp\u003e例えばこのようになります。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003efeedmatic.model.lkml\nviews\n├── all_media.view.lkml\n└── ga.view.lkml\u003c/pre\u003e\n\n\n\u003cp\u003e開発初期は \u003ccode\u003efeedmatic.model.lkml\u003c/code\u003e に view 以外の、explore や datagroup などをズラズラと書いていました。\u003c/p\u003e\n\n\u003ch2 id=\"特別なファイル形式を知る\"\u003e特別なファイル形式を知る\u003c/h2\u003e\n\n\u003cp\u003eご存知の通り、LookML のファイル形式は \u003ccode\u003e.lkml\u003c/code\u003e です。\u003c/p\u003e\n\n\u003cp\u003eLookML 開発が続くと \u003ccode\u003e.model.lkml\u003c/code\u003e や \u003ccode\u003e.view.lkml\u003c/code\u003e などが増えていきますが、この中で唯一意味を持つのが \u003ccode\u003e.model.lkml\u003c/code\u003e です\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" rel=\"footnote\"\u003e1\u003c/a\u003e\u003c/sup\u003e。その他のファイル形式は整理のために自由に作ることが出来ます。\u003c/p\u003e\n\n\u003cp\u003e例えば \u003ccode\u003efeedmatic.model.lkml\u003c/code\u003e を作ると、\u003ccode\u003efeedmatic\u003c/code\u003e というモデルが定義されます。\u003ccode\u003ehttps://{{your looker domain}}/projects\u003c/code\u003e で確認できます。\u003ccode\u003eall_media.view.lkml\u003c/code\u003e を作っても、何かが作られるわけではありません。\u003c/p\u003e\n\n\u003cp\u003e以上の知識を持った上で、公式ドキュメントを読むと理解が深まるかもしれません。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdocs.looker.com%2Fja%2Fdata-modeling%2Flearning-lookml%2Flookml-terms-and-concepts\" title=\"Looker documentation  |  Google Cloud\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003ch2 id=\"最近使っているディレクトリ構造\"\u003e最近使っているディレクトリ構造\u003c/h2\u003e\n\n\u003cp\u003eこんな感じです。それぞれ解説していきます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003ebigquery\n├── spreadsheet1\n│   ├── define.json\n│   └── schema.json\n└── spreadsheet2\n    ├── define.json\n    └── schema.json\nmodel1.model.lkml\nexplores\n├── corp\n│   ├── base.explore.lkml\n│   ├── name1.explore.lkml\n│   └── name2.explore.lkml\n├── explore1.explore.lkml\n└── explore2.explore.lkml\nviews\n├── corp\n│   ├── base.view.lkml\n│   ├── name1.view.lkml\n│   └── name2.view.lkml\n├── view1.view.lkml\n└── view2.view.lkml\ntests\n└── model1\n    ├── corp\n    │   ├── name1.test.lkml\n    │   └── name2.test.lkml\n    ├── explore1.test.lkml\n    └── explore2.test.lkml\nmanifest.lkml\u003c/pre\u003e\n\n\n\u003ch3 id=\"bigquery\"\u003ebigquery/\u003c/h3\u003e\n\n\u003cp\u003eいきなり LookML 関係ありません。💦\u003c/p\u003e\n\n\u003cp\u003eBigQuery はデータソースに Google スプレッドシートを指定でき、そのスキーマ定義はコード化することが出来ます。\u003c/p\u003e\n\n\u003cp\u003eコード化することで変更履歴を Git で管理できますし、BigQuery CLI を使って簡単に Dataset や Table を作ったり、削除したりが出来ます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e$ bq mk spreadsheet1\n$ bq mk --external_table_definition=./define.json spreadsheet1.gsheet\n$ bq rm -r spreadsheet1\u003c/pre\u003e\n\n\n\u003cp\u003e破壊的な変更をする時は、バージョン名を付けた Dataset を新規作成し、LookML から参照先を変えます。こうすることで、本番環境に影響を与えずに開発することが出来ます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e$ bq mk spreadsheet1_v2\n$ bq mk --external_table_definition=./define.json spreadsheet1_v2.gsheet\u003c/pre\u003e\n\n\n\u003cp\u003eスキーマ定義は公式ドキュメントをご覧下さい。需要があればそんな記事を書きます。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fcloud.google.com%2Fconfig-connector%2Fdocs%2Freference%2Fresource-docs%2Fbigquery%2Fbigquerytable%3Fhl%3Dja\" title=\"BigQueryTable  |  Config Connector Documentation  |  Google Cloud\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003e他の Dataset は ETL ツール\u003csup id=\"fnref:2\"\u003e\u003ca href=\"#fn:2\" rel=\"footnote\"\u003e2\u003c/a\u003e\u003c/sup\u003eが作るためコード化はしていません。\u003c/p\u003e\n\n\u003ch3 id=\"model1modellkml\"\u003emodel1.model.lkml\u003c/h3\u003e\n\n\u003cp\u003e中心となるこのファイルは軽いです。本当にこの程度しか書いていません。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003econnection: \u0026#34;docs_bigquery_db\u0026#34;\n\ninclude: \u0026#34;/explores/**/*.explore\u0026#34;\ninclude: \u0026#34;/tests/model1/**/*.test\u0026#34;\n\nnamed_value_format: jpy_0 {\n  value_format: \u0026#34;\\¥#,##0\u0026#34;\n}\n\nnamed_value_format: jpy_1 {\n  value_format: \u0026#34;\\¥#,##0.0\u0026#34;\n}\n\n# for test\naccess_grant: can_view_explores_for_tests {\n  user_attribute: view_explores_for_tests\n  allowed_values: [\u0026#34;yes\u0026#34;]\n}\u003c/pre\u003e\n\n\n\u003cp\u003e必要な定義は \u003ccode\u003econnection\u003c/code\u003e と \u003ccode\u003einclude\u003c/code\u003e だけです。\u003c/p\u003e\n\n\u003cp\u003einclude 対象を全ての \u003ccode\u003e.explore.lkml\u003c/code\u003e と、このモデルに関連するテスト（\u003ccode\u003etests/feedmatic/\u003c/code\u003e 以下全ての \u003ccode\u003e.test.lkml\u003c/code\u003e）だけにしていることがポイントです。つまり \u003ccode\u003e.model.lkml\u003c/code\u003e は \u003ccode\u003e.explore.lkml\u003c/code\u003e と自分の \u003ccode\u003e.test.lkml\u003c/code\u003e しか知りません。\u003c/p\u003e\n\n\u003cp\u003eあとは蛇足で、\u003ccode\u003enamed_value_format\u003c/code\u003e と、\u003ca href=\"/entry/2021/08/30/150000\"\u003e前回紹介したテスト\u003c/a\u003eに必要な \u003ccode\u003eaccess_grant\u003c/code\u003e だけです。\u003c/p\u003e\n\n\u003ch3 id=\"explores\"\u003eexplores/\u003c/h3\u003e\n\n\u003cp\u003e1 つの explore を 1 つのファイルに定義しています。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eexplores/explore1.explore.lkml\u003c/code\u003e はこのように書いています。\u003ccode\u003e.explore.lkml\u003c/code\u003e は \u003ccode\u003e.view.lkml\u003c/code\u003e しか知りません。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003einclude: \u0026#34;/views/**/*.view\u0026#34;\n\nexplore: explore1 {\n  # ...\n}\u003c/pre\u003e\n\n\n\u003cp\u003e紆余曲折あり、\u003ccode\u003eexplores/corp/name1.explore.lkml\u003c/code\u003e のような取引先ごとの explore もあります。\u003c/p\u003e\n\n\u003cp\u003e基本となる \u003ccode\u003eexplores/corp/base.explore.lkml\u003c/code\u003e はこのような定義です。ファイル名と explore 名を変えていることがポイントです。Ruby の慣習を参考にしました。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eexplore: corp_base {\n  extension: required\n  # ...\n}\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ccode\u003ecorp_base\u003c/code\u003e explore を継承する、各取引先の explore はこのような定義です。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003einclude: \u0026#34;./base.explore\u0026#34;\ninclude: \u0026#34;/views/**/*.view\u0026#34;\n\nexplore: corp_name1 {\n  extends: [corp_base]\n  # ...\n}\u003c/pre\u003e\n\n\n\u003ch3 id=\"views\"\u003eviews/\u003c/h3\u003e\n\n\u003cp\u003eview も explore と同様に、1 view 1 ファイルに定義しています。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eviews/view1.view.lkml\u003c/code\u003e です。\u003ccode\u003e.view.lkml\u003c/code\u003e は \u003ccode\u003e.model.lkml\u003c/code\u003e, \u003ccode\u003e.explore.lkml\u003c/code\u003e, \u003ccode\u003e.test.lkml\u003c/code\u003e の誰も知りません。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eview: view1 {\n  # ...\n}\u003c/pre\u003e\n\n\n\u003cp\u003e取引先ごとの view も同じです。\u003ccode\u003eviews/corp/base.view.lkml\u003c/code\u003e はこんな感じで、\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eview: corp_base {\n  extension: required\n  # ...\n}\u003c/pre\u003e\n\n\n\u003cp\u003e継承先の \u003ccode\u003eviews/corp/name1.view.lkml\u003c/code\u003e はこんな感じです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003einclude: \u0026#34;./base.view\u0026#34;\n\nview: corp_name1 {\n  extends: [corp_base]\n  # ...\n}\u003c/pre\u003e\n\n\n\u003ch3 id=\"tests\"\u003etests/\u003c/h3\u003e\n\n\u003cp\u003eテストはかなり書いており、2021-12-13 現在、184 もあります。\u003c/p\u003e\n\n\u003cp\u003eほぼ explore 単位でファイル分割しています。分割することで、ファイル単位のテストが可能になっています。\u003c/p\u003e\n\n\u003cp\u003eこちらのベストプラクティスに従っています。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fcommunity.looker.com%2Flookml-5%2Flookml-data-tests-recommendations-and-best-practices-20815\" title=\"LookML Data Tests: Recommendations and Best Practices | Looker Community\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003eテスト対象はこんな感じです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e(1) LookML で特別な実装をしていて、壊れても気づくのが難しそうな実装\u003c/li\u003e\n\u003cli\u003e(2) \u003ccode\u003eprimary_key\u003c/code\u003e が重複していないか？ null になっていないか？を全ての view に対して\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e(2) は前回詳しく書きました。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2021%2F08%2F30%2F150000\" title=\"Looker で Join 先の view の primary_key をいい感じにテストする方法をようやく見つけた - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003e実行に時間がかかることが悩みで以前こんな Topic を作りましたが、反応ゼロでした。みなさん課題ではないのかしら？💦\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fcommunity.looker.com%2Flookml-5%2Fis-it-possible-to-run-tests-in-parallel-28222\" title=\"Is it possible to run tests in parallel? | Looker Community\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eprimary_key\u003c/code\u003e は壊れた時に気づくのが難しく、LookML 開発者が私だけということもあるため、機械的に全ての \u003ccode\u003eprimary_key\u003c/code\u003e をテスト出来るようにしています。ただ、全テストは結構時間がかかるので、日に 1 回くらいの頻度で手動実行しています。CI したい...。\u003c/p\u003e\n\n\u003ch3 id=\"manifestlkml\"\u003emanifest.lkml\u003c/h3\u003e\n\n\u003cp\u003eディレクトリ構造とは関係ありませんが、manifest.lkml についても触れておきましょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003ebigquery/\u003c/code\u003e の項で書いたとおり、テーブル定義に破壊的な変更を加える時は \u003ccode\u003edataset_v2\u003c/code\u003e のように Dataset 名にゆるふわバージョンを付けています。つまり割とカジュアルに Dataset 名が変わります。\u003c/p\u003e\n\n\u003cp\u003eそのため、このように manifest.lkml で全ての Dataset 名を定義しています\u003csup id=\"fnref:3\"\u003e\u003ca href=\"#fn:3\" rel=\"footnote\"\u003e3\u003c/a\u003e\u003c/sup\u003e。Dataset 名は複数箇所で使われ得るためです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003econstant: table_name1  { value: \u0026#34;`table1_v2.gsheet`\u0026#34; }\nconstant: table_name2  { value: \u0026#34;`table2.view`\u0026#34; }\u003c/pre\u003e\n\n\n\u003cp\u003e利用例です。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003esql_table_name: @{table_name1} ;;\u003c/pre\u003e\n\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003e現在 LookML 開発で使っているディレクトリ構造を紹介しました。中規模くらいまでの LookML プロジェクトには使える実感があります。\u003c/p\u003e\n\n\u003cp\u003eただ、最近はファイル数が多くなってきて、\u003ccode\u003e.view.lkml\u003c/code\u003e を追加した時に変更する \u003ccode\u003e.explore.lkml\u003c/code\u003e と \u003ccode\u003e.test.lkml\u003c/code\u003e の距離が遠く、実装しづらい課題があります。\u003c/p\u003e\n\n\u003cp\u003eRefinements を使えば解決できるのだろうか、もっと再利用性のあるコードにしたいなど、悩みは尽きないです。\u003c/p\u003e\n\n\u003cp\u003eこちらの記事は読んで手も動かしたのですが、巨大なファイルを分割する、Blocks のようなライブラリをカスタマイズする（？）、以外の使い方を見いだせていません。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fcommunity.looker.com%2F%25E3%2582%25B3%25E3%2583%25A9%25E3%2583%25A0-103%2Frefinements%25E3%2582%2592%25E4%25BD%25BF%25E3%2581%25A3%25E3%2581%25A6lookml%25E3%2581%25AE%25E3%2582%25B3%25E3%2583%25BC%25E3%2583%2589%25E3%2582%2592%25E6%2595%25B4%25E7%2590%2586%25E3%2581%2599%25E3%2582%258B-18809\" title=\"Refinementsを使ってLookMLのコードを整理する | Looker Community\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003e皆さんのディレクトリ構造も是非教えて下さい！\u003c/p\u003e\n\n\u003ch2 id=\"2021-12-29-追記\"\u003e2021-12-29 追記\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://community.looker.com/lookml-5/what-is-the-looker-recommended-folder-structure-for-lookml-development-28826\"\u003eWhat is the looker recommended folder structure for LookML development ? | Looker Community\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eLooker Community にもお悩みの方がいらっしゃいました。返信している Dawid さんはよくお見かけする方で、かなりの熟練者だと思います。\u003c/p\u003e\n\n\u003cp\u003eそんな彼も、今回私が書いた記事のような物理的な構造が良いのか、論理的な構造が良いのか、未だに試行錯誤しているようです。\u003c/p\u003e\n\n\u003cp\u003e始めは物理的なディレクトリ構造から始めて、徐々に変化しながら論理的な構造に近づくのかもしれません。その頃にはステージに応じたベストプラクティスが出ていると良いですね。\u003c/p\u003e\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr/\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\"\u003e\n正確に書くと \u003ccode\u003emanifest.lkml\u003c/code\u003e や \u003ccode\u003e.strings.json\u003c/code\u003e などもありますが、一旦考えなくて良いと思います。\u003ca href=\"#fnref:1\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/li\u003e\n\u003cli id=\"fn:2\"\u003e\n\u003ca href=\"https://funnel.io/\"\u003eFunnel.io\u003c/a\u003e を使っています。\u003ca href=\"#fnref:2\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/li\u003e\n\u003cli id=\"fn:3\"\u003e\n1 行で書いているのはソートしやすくするためです。\u003ca href=\"#fnref:3\" rev=\"footnote\"\u003e\u0026#8617;\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/div\u003e\n\n","contentSnippet":"こんにちは、id:masutaka26 です。この記事は Looker Advent Calendar 2021 の 13 日目の記事です。qiita.com昨日は Yappli 阿部さんの「Lookerの目標値やストップワードを、Googleスプレッドシート連携でお手軽管理【Sexy Tech for You #9】」でした。Looker を使うとこのような LookML を書くだけで、ビジネスユーザーが SQL を書くことなく、本業に集中できるのはとても良いですよね。個人的には、SQL ベースの派生テーブルの中で join するよりも、explore で join したほうが Looker らしく、メンテナンス性が良い気がしました。symmetric 集計が働くため、ファンアウトも避けられます。wikipedia テーブルに関しては、永続的な派生テーブル（PDT）を使って BigQuery のスキャンサイズを抑えるのも良さそうです。、、、( ﾟдﾟ)ハッ！ついマジレスをしてしまいました。💦今回は dimension が null の measure を（0 ではなく）ø にする少しマニアックな記事を書く予定でしたが、先日の Looker User Meetup Online #7 で、LookML のディレクトリ構造を知りたいというチャットをお見かけしたので、今回はその話を書くことにしました。今回のプロジェクトの規模感デフォルトのディレクトリ構造？特別なファイル形式を知る最近使っているディレクトリ構造bigquery/model1.model.lkmlexplores/views/tests/manifest.lkmlまとめ2021-12-29 追記今回のプロジェクトの規模感プロジェクトの規模感によってディレクトリ構造は変わると思うので、先に書いておきます。Looker インスタンスに 1 つだけ LookML プロジェクトが存在するBigQuery Dataset 76 個.lkml ファイル 277 個.model.lkml ファイル 1 個.explore.lkml ファイル 56 個.view.lkml ファイル 139 個.test.lkml ファイル 78 個LookML 開発者 1 名デフォルトのディレクトリ構造？この記事を書くまで誤解をしていたのですが、デフォルトのディレクトリ構造というものはなかったのですね。この記事を書くために改めて Blank Project を作ったら、ファイルもディレクトリも何もないプロジェクトが作られました。モデルファイルを作るとこのようなコードが展開されるので、.view.lkml に関しては /views/ 以下に作る方が多いと思います。私もそうでした。include: \"/views/*.view.lkml\"                # include all views in the views/ folder in this project# include: \"/**/*.view.lkml\"                 # include all views in this project# include: \"my_dashboard.dashboard.lookml\"   # include a lookml dashboard called my_dashboard例えばこのようになります。feedmatic.model.lkmlviews├── all_media.view.lkml└── ga.view.lkml開発初期は feedmatic.model.lkml に view 以外の、explore や datagroup などをズラズラと書いていました。特別なファイル形式を知るご存知の通り、LookML のファイル形式は .lkml です。LookML 開発が続くと .model.lkml や .view.lkml などが増えていきますが、この中で唯一意味を持つのが .model.lkml です1。その他のファイル形式は整理のために自由に作ることが出来ます。例えば feedmatic.model.lkml を作ると、feedmatic というモデルが定義されます。https://{{your looker domain}}/projects で確認できます。all_media.view.lkml を作っても、何かが作られるわけではありません。以上の知識を持った上で、公式ドキュメントを読むと理解が深まるかもしれません。最近使っているディレクトリ構造こんな感じです。それぞれ解説していきます。bigquery├── spreadsheet1│   ├── define.json│   └── schema.json└── spreadsheet2    ├── define.json    └── schema.jsonmodel1.model.lkmlexplores├── corp│   ├── base.explore.lkml│   ├── name1.explore.lkml│   └── name2.explore.lkml├── explore1.explore.lkml└── explore2.explore.lkmlviews├── corp│   ├── base.view.lkml│   ├── name1.view.lkml│   └── name2.view.lkml├── view1.view.lkml└── view2.view.lkmltests└── model1    ├── corp    │   ├── name1.test.lkml    │   └── name2.test.lkml    ├── explore1.test.lkml    └── explore2.test.lkmlmanifest.lkmlbigquery/いきなり LookML 関係ありません。💦BigQuery はデータソースに Google スプレッドシートを指定でき、そのスキーマ定義はコード化することが出来ます。コード化することで変更履歴を Git で管理できますし、BigQuery CLI を使って簡単に Dataset や Table を作ったり、削除したりが出来ます。$ bq mk spreadsheet1$ bq mk --external_table_definition=./define.json spreadsheet1.gsheet$ bq rm -r spreadsheet1破壊的な変更をする時は、バージョン名を付けた Dataset を新規作成し、LookML から参照先を変えます。こうすることで、本番環境に影響を与えずに開発することが出来ます。$ bq mk spreadsheet1_v2$ bq mk --external_table_definition=./define.json spreadsheet1_v2.gsheetスキーマ定義は公式ドキュメントをご覧下さい。需要があればそんな記事を書きます。他の Dataset は ETL ツール2が作るためコード化はしていません。model1.model.lkml中心となるこのファイルは軽いです。本当にこの程度しか書いていません。connection: \"docs_bigquery_db\"include: \"/explores/**/*.explore\"include: \"/tests/model1/**/*.test\"named_value_format: jpy_0 {  value_format: \"\\¥#,##0\"}named_value_format: jpy_1 {  value_format: \"\\¥#,##0.0\"}# for testaccess_grant: can_view_explores_for_tests {  user_attribute: view_explores_for_tests  allowed_values: [\"yes\"]}必要な定義は connection と include だけです。include 対象を全ての .explore.lkml と、このモデルに関連するテスト（tests/feedmatic/ 以下全ての .test.lkml）だけにしていることがポイントです。つまり .model.lkml は .explore.lkml と自分の .test.lkml しか知りません。あとは蛇足で、named_value_format と、前回紹介したテストに必要な access_grant だけです。explores/1 つの explore を 1 つのファイルに定義しています。explores/explore1.explore.lkml はこのように書いています。.explore.lkml は .view.lkml しか知りません。include: \"/views/**/*.view\"explore: explore1 {  # ...}紆余曲折あり、explores/corp/name1.explore.lkml のような取引先ごとの explore もあります。基本となる explores/corp/base.explore.lkml はこのような定義です。ファイル名と explore 名を変えていることがポイントです。Ruby の慣習を参考にしました。explore: corp_base {  extension: required  # ...}corp_base explore を継承する、各取引先の explore はこのような定義です。include: \"./base.explore\"include: \"/views/**/*.view\"explore: corp_name1 {  extends: [corp_base]  # ...}views/view も explore と同様に、1 view 1 ファイルに定義しています。views/view1.view.lkml です。.view.lkml は .model.lkml, .explore.lkml, .test.lkml の誰も知りません。view: view1 {  # ...}取引先ごとの view も同じです。views/corp/base.view.lkml はこんな感じで、view: corp_base {  extension: required  # ...}継承先の views/corp/name1.view.lkml はこんな感じです。include: \"./base.view\"view: corp_name1 {  extends: [corp_base]  # ...}tests/テストはかなり書いており、2021-12-13 現在、184 もあります。ほぼ explore 単位でファイル分割しています。分割することで、ファイル単位のテストが可能になっています。こちらのベストプラクティスに従っています。テスト対象はこんな感じです。(1) LookML で特別な実装をしていて、壊れても気づくのが難しそうな実装(2) primary_key が重複していないか？ null になっていないか？を全ての view に対して(2) は前回詳しく書きました。実行に時間がかかることが悩みで以前こんな Topic を作りましたが、反応ゼロでした。みなさん課題ではないのかしら？💦primary_key は壊れた時に気づくのが難しく、LookML 開発者が私だけということもあるため、機械的に全ての primary_key をテスト出来るようにしています。ただ、全テストは結構時間がかかるので、日に 1 回くらいの頻度で手動実行しています。CI したい...。manifest.lkmlディレクトリ構造とは関係ありませんが、manifest.lkml についても触れておきましょう。bigquery/ の項で書いたとおり、テーブル定義に破壊的な変更を加える時は dataset_v2 のように Dataset 名にゆるふわバージョンを付けています。つまり割とカジュアルに Dataset 名が変わります。そのため、このように manifest.lkml で全ての Dataset 名を定義しています3。Dataset 名は複数箇所で使われ得るためです。constant: table_name1  { value: \"`table1_v2.gsheet`\" }constant: table_name2  { value: \"`table2.view`\" }利用例です。sql_table_name: @{table_name1} ;;まとめ現在 LookML 開発で使っているディレクトリ構造を紹介しました。中規模くらいまでの LookML プロジェクトには使える実感があります。ただ、最近はファイル数が多くなってきて、.view.lkml を追加した時に変更する .explore.lkml と .test.lkml の距離が遠く、実装しづらい課題があります。Refinements を使えば解決できるのだろうか、もっと再利用性のあるコードにしたいなど、悩みは尽きないです。こちらの記事は読んで手も動かしたのですが、巨大なファイルを分割する、Blocks のようなライブラリをカスタマイズする（？）、以外の使い方を見いだせていません。皆さんのディレクトリ構造も是非教えて下さい！2021-12-29 追記What is the looker recommended folder structure for LookML development ? | Looker CommunityLooker Community にもお悩みの方がいらっしゃいました。返信している Dawid さんはよくお見かけする方で、かなりの熟練者だと思います。そんな彼も、今回私が書いた記事のような物理的な構造が良いのか、論理的な構造が良いのか、未だに試行錯誤しているようです。始めは物理的なディレクトリ構造から始めて、徐々に変化しながら論理的な構造に近づくのかもしれません。その頃にはステージに応じたベストプラクティスが出ていると良いですね。manifest.lkml や .strings.json などもありますが、一旦考えなくて良いと思います。↩Funnel.io を使っています。↩↩","link":"https://developer.feedforce.jp/entry/2021/12/13/110000","isoDate":"2021-12-13T02:00:00.000Z","dateMiliSeconds":1639360800000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"GitHub Packages を使ってプライベート gem を社内限定で公開した","content":"\u003cp\u003eこんにちは、\u003ca href=\"http://blog.hatena.ne.jp/daido1976/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/daido1976/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:daido1976\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e先日 GitHub Packages を使ってプライベート gem を社内限定で公開したので、その方法をご紹介します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#GitHub-Packages-とは\"\u003eGitHub Packages とは\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#既存のプライベート-gem-と-GitHub-Packages-との違い\"\u003e既存のプライベート gem と GitHub Packages との違い\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#GitHub-Packages-を使ってプライベート-gem-を社内限定で公開する\"\u003eGitHub Packages を使ってプライベート gem を社内限定で公開する\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#gem-をリリースPublishする方法\"\u003egem をリリース（Publish）する方法\u003c/a\u003e\u003cul\u003e\n                    \u003cli\u003e\u003ca href=\"#ローカルからリリースする\"\u003eローカルからリリースする\u003c/a\u003e\u003c/li\u003e\n                    \u003cli\u003e\u003ca href=\"#CI-からリリースする\"\u003eCI からリリースする\u003c/a\u003e\u003c/li\u003e\n                \u003c/ul\u003e\n            \u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#各環境へのインストール方法\"\u003e各環境へのインストール方法\u003c/a\u003e\u003cul\u003e\n                    \u003cli\u003e\u003ca href=\"#ローカルや本番環境でのインストール\"\u003eローカルや本番環境でのインストール\u003c/a\u003e\u003c/li\u003e\n                    \u003cli\u003e\u003ca href=\"#Dependabot-でのインストール\"\u003eDependabot でのインストール\u003c/a\u003e\u003c/li\u003e\n                \u003c/ul\u003e\n            \u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#関連記事\"\u003e関連記事\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"GitHub-Packages-とは\"\u003eGitHub Packages とは\u003c/h2\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.co.jp%2Ffeatures%2Fpackages\" title=\"Packages\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.co.jp/features/packages\"\u003egithub.co.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eGitHub Packages はライブラリ（パッケージ）のホスティングサービスです。\u003c/p\u003e\n\n\u003cp\u003eRuby の場合 \u003ccode\u003ehttps://rubygems.org\u003c/code\u003e の代わりに \u003ccode\u003ehttps://rubygems.pkg.github.com\u003c/code\u003e に公開するイメージで、認証には GitHub の personal access token などを使います。\u003c/p\u003e\n\n\u003ch2 id=\"既存のプライベート-gem-と-GitHub-Packages-との違い\"\u003e既存のプライベート gem と GitHub Packages との違い\u003c/h2\u003e\n\n\u003cp\u003e既存のプライベート gem は主に git のタグやブランチを指定する方法が用いられますが、以下のようにいくつかの問題があります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# main ブランチの先端を使うのは再現性がない（ブランチ指定した場合も同じ）\u003c/span\u003e\ngem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003egithub\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_name/my_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e# タグを指定しても書き換えられる可能性がある\u003c/span\u003e\ngem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003egithub\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_name/my_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003etag\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ev1.0.0\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e# コミットの参照を指定するのはシンプルに見づらい\u003c/span\u003e\ngem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003egithub\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_name/my_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eref\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e4aded\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eGitHub Packages は \u003ccode\u003erubygems.org\u003c/code\u003e と同じように、バージョン指定が明確かつ一度リリースしたバージョンは変更できないので安全です。\u003c/p\u003e\n\n\u003ch2 id=\"GitHub-Packages-を使ってプライベート-gem-を社内限定で公開する\"\u003eGitHub Packages を使ってプライベート gem を社内限定で公開する\u003c/h2\u003e\n\n\u003cp\u003eここからは実際に GitHub Packages を使ってプライベート gem を社内限定で公開する方法（主にリリースとインストールの仕方）を説明していきます。\u003c/p\u003e\n\n\u003cp\u003e今回は Organization は \u003ccode\u003efeedforce\u003c/code\u003e、gem の名前は \u003ccode\u003esocialplus-rails\u003c/code\u003e という想定です。\u003c/p\u003e\n\n\u003cp\u003e日本語版のドキュメントは文章やサンプルコードが古いケースがあるので、以下の英語版ドキュメントを参照した方が良いです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry\"\u003eWorking with the RubyGems registry - GitHub Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e認証に使う personal access token の権限については以下のドキュメントが詳しいです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.github.com/en/packages/learn-github-packages/about-permissions-for-github-packages\"\u003eAbout permissions for GitHub Packages - GitHub Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3 id=\"gem-をリリースPublishする方法\"\u003egem をリリース（Publish）する方法\u003c/h3\u003e\n\n\u003cp\u003eまずは作成した gem をリリースする方法について説明します。\u003c/p\u003e\n\n\u003ch4 id=\"ローカルからリリースする\"\u003eローカルからリリースする\u003c/h4\u003e\n\n\u003cp\u003eまとめると以下のような手順になります。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003e〜/.gem/credentials\u003c/code\u003e に GitHub の personal access token を追加\n\n\u003cul\u003e\n\u003cli\u003e権限は \u003ccode\u003erepo\u003c/code\u003e と \u003ccode\u003ewrite:packages\u003c/code\u003e が必要\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e$ gem build socialplus-rails.gemspec\u003c/code\u003e で gem をビルド\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eSocialplusRails::VERSION\u003c/code\u003e は \u003ccode\u003e0.1.0\u003c/code\u003e を想定\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e$ gem push --key github --host https://rubygems.pkg.github.com/feedforce socialplus-rails-0.1.0.gem\u003c/code\u003e で push する\n\n\u003cul\u003e\n\u003cli\u003eこの時に personal access token の権限が足りないとエラーになる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\n\u003cp\u003ePush が成功すると \u003ca href=\"https://github.com/orgs/feedforce/packages\"\u003ehttps://github.com/orgs/feedforce/packages\u003c/a\u003e のような Packages のページに反映されます 👏\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/d/daido1976/20211104/20211104160709.png\" alt=\"f:id:daido1976:20211104160709p:plain\" width=\"1200\" height=\"492\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch4 id=\"CI-からリリースする\"\u003eCI からリリースする\u003c/h4\u003e\n\n\u003cp\u003egem のソースコードを更新した際に毎回上記のようにローカルからリリースしても良いのですが、できれば CI からリリースできるように仕組み化したいものです。\u003c/p\u003e\n\n\u003cp\u003eCircleCI の場合、以下のような \u003ccode\u003erelease\u003c/code\u003e コマンドを定義して、リリース用のブランチがマージされた時に実行されるようにすれば OK です。\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# .circleci/config.yml\u003c/span\u003e\n\n\u003cspan class=\"synIdentifier\"\u003eversion\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e2.1\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e# ...\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003ecommands\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003erelease\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003edescription\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Release to GitHub Packages\n    \u003cspan class=\"synIdentifier\"\u003esteps\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Create GitHub Packages Credentials\n          \u003cspan class=\"synIdentifier\"\u003ecommand\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e |\n            mkdir ~/.gem || \u003cspan class=\"synConstant\"\u003etrue\u003c/span\u003e\n            echo -e \u003cspan class=\"synConstant\"\u003e\u0026quot;---\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e\\n\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e:github: Bearer ${GITHUB_ACCESS_TOKEN}\u0026quot;\u003c/span\u003e \u0026gt; ~/.gem/credentials\n            chmod \u003cspan class=\"synConstant\"\u003e0600\u003c/span\u003e ~/.gem/credentials\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Release Gem\n          \u003cspan class=\"synIdentifier\"\u003ecommand\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e |\n            gem build socialplus-rails.gemspec\n            release_version=$(find . -name \u003cspan class=\"synConstant\"\u003e\u0026quot;socialplus-rails-*.gem\u0026quot;\u003c/span\u003e | sed -E \u003cspan class=\"synConstant\"\u003e's/\\.\\/socialplus-rails-(.*).gem/\\1/'\u003c/span\u003e)\n            gem push --key github --host https://rubygems.pkg.github.com/feedforce \u003cspan class=\"synConstant\"\u003e\u0026quot;socialplus-rails-${release_version}.gem\u0026quot;\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch3 id=\"各環境へのインストール方法\"\u003e各環境へのインストール方法\u003c/h3\u003e\n\n\u003cp\u003eここからはリリースした gem を各環境へインストールする方法を説明します。\u003c/p\u003e\n\n\u003cp\u003eGemfile への記述は以下のようにします。\u003ca href=\"#f-ff64d70e\" name=\"fn-ff64d70e\" title=\"See. https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry#installing-a-package\"\u003e*1\u003c/a\u003e\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# Gemfile\u003c/span\u003e\nsource \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ehttps://rubygems.pkg.github.com/feedforce\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e\n  gem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003esocialplus-rails\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e0.1.0\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch4 id=\"ローカルや本番環境でのインストール\"\u003eローカルや本番環境でのインストール\u003c/h4\u003e\n\n\u003cp\u003e以下のように \u003ccode\u003ebundle config\u003c/code\u003e コマンドで認証情報をセットしてから \u003ccode\u003ebundle install\u003c/code\u003e を行います。\u003ca href=\"#f-54facd0e\" name=\"fn-54facd0e\" title=\"環境変数を利用して認証情報をセットすることもできるようです\"\u003e*2\u003c/a\u003e\u003c/p\u003e\n\n\u003cpre class=\"code lang-sh\" data-lang=\"sh\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# `USERNAME:TOKEN` は `{GitHubのユーザ名}:{Personal access token}` という形です（例: `daido1976:7axxx`）\u003c/span\u003e\n$ bundle config https://rubygems.pkg.github.com/feedforce USERNAME:TOKEN\n$ bundle install\n\u003c/pre\u003e\n\n\n\u003cp\u003e※ インストール時の認証に利用する personal access token には \u003ccode\u003eread:packages\u003c/code\u003e の権限のみあれば OK です\u003c/p\u003e\n\n\u003ch4 id=\"Dependabot-でのインストール\"\u003eDependabot でのインストール\u003c/h4\u003e\n\n\u003cp\u003eGitHub Packages のプライベート gem をDependabot の更新対象にしたい場合は追加の設定が必要です。\u003c/p\u003e\n\n\u003cp\u003e以下のように設定ファイルで GitHub Packages の認証情報を渡す準備をします。\u003ca href=\"#f-52f8882d\" name=\"fn-52f8882d\" title=\"See. https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#rubygems-server\"\u003e*3\u003c/a\u003e\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# .github/dependabot.yml\u003c/span\u003e\n\n\u003cspan class=\"synIdentifier\"\u003eversion\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003eregistries\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003erubygems-pkg-github\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003etype\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e rubygems-server\n    \u003cspan class=\"synIdentifier\"\u003eurl\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e https://rubygems.pkg.github.com\n   \u003cspan class=\"synComment\"\u003e # BUNDLE_GITHUB_TOKEN の値は `USERNAME:TOKEN` という形式です\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003etoken\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;${{secrets.BUNDLE_GITHUB_TOKEN}}\u0026quot;\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e以下ドキュメントを参考に GitHub Packages の認証情報（今回の例なら \u003ccode\u003eBUNDLE_GITHUB_TOKEN\u003c/code\u003e）を Dependabot 用の Secret として登録すれば完了です。\u003ca href=\"#f-e337a98d\" name=\"fn-e337a98d\" title=\"Secret はリポジトリ単位とオーガニゼーション単位のどちらでも設定できます\"\u003e*4\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/managing-encrypted-secrets-for-dependabot\"\u003eManaging encrypted secrets for Dependabot - GitHub Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2 id=\"関連記事\"\u003e関連記事\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://tech.pepabo.com/2021/09/10/in-house-rubygems-registry-with-ghes-github-packages/\"\u003eGitHub Enterprise Server\u0026#x306E;GitHub Packages\u0026#x3067;\u0026#x793E;\u0026#x5185;\u0026#x7528;gem\u0026#x3092;\u0026#x30DB;\u0026#x30B9;\u0026#x30C8;\u0026#x3059;\u0026#x308B; - \u0026#x30DA;\u0026#x30D1;\u0026#x30DC;\u0026#x30C6;\u0026#x30C3;\u0026#x30AF;\u0026#x30D6;\u0026#x30ED;\u0026#x30B0;\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://tech.actindi.net/2020/06/12/180000\"\u003eGitHub Actions\u0026#x3092;\u0026#x5229;\u0026#x7528;\u0026#x3057;\u0026#x3066;gem\u0026#x3092;GitHub Packages\u0026#x306B;\u0026#x516C;\u0026#x958B;\u0026#x3059;\u0026#x308B; - \u0026#x30A2;\u0026#x30AF;\u0026#x30C8;\u0026#x30A4;\u0026#x30F3;\u0026#x30C7;\u0026#x30A3;\u0026#x958B;\u0026#x767A;\u0026#x8005;\u0026#x30D6;\u0026#x30ED;\u0026#x30B0;\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chocoby.com/blog/2021/09/21/dependabot-github-packages-gem\"\u003eDependabot \u0026#x3067; GitHub Packages \u0026#x306B;\u0026#x516C;\u0026#x958B;\u0026#x3057;\u0026#x305F; Gem \u0026#x306E;\u0026#x30A2;\u0026#x30C3;\u0026#x30D7;\u0026#x30C7;\u0026#x30FC;\u0026#x30C8;\u0026#x3092;\u0026#x30C1;\u0026#x30A7;\u0026#x30C3;\u0026#x30AF;\u0026#x3059;\u0026#x308B; - \u0026#x6687;\u0026#x4EBA;\u0026#x3058;\u0026#x3083;\u0026#x306A;\u0026#x3044;\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"footnote\"\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-ff64d70e\" name=\"f-ff64d70e\" class=\"footnote-number\"\u003e*1\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003eSee. \u003ca href=\"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry#installing-a-package\"\u003ehttps://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry#installing-a-package\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-54facd0e\" name=\"f-54facd0e\" class=\"footnote-number\"\u003e*2\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://tech.pepabo.com/2021/09/10/in-house-rubygems-registry-with-ghes-github-packages/#%E3%83%AC%E3%82%B8%E3%82%B9%E3%83%88%E3%83%AA%E3%81%8B%E3%82%89%E3%81%AEgem%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89\"\u003e環境変数を利用して認証情報をセットすることもできるようです\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-52f8882d\" name=\"f-52f8882d\" class=\"footnote-number\"\u003e*3\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003eSee. \u003ca href=\"https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#rubygems-server\"\u003ehttps://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#rubygems-server\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-e337a98d\" name=\"f-e337a98d\" class=\"footnote-number\"\u003e*4\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003eSecret はリポジトリ単位とオーガニゼーション単位のどちらでも設定できます\u003c/span\u003e\u003c/p\u003e\n\u003c/div\u003e","contentSnippet":"こんにちは、id:daido1976 です。先日 GitHub Packages を使ってプライベート gem を社内限定で公開したので、その方法をご紹介します。GitHub Packages とは既存のプライベート gem と GitHub Packages との違いGitHub Packages を使ってプライベート gem を社内限定で公開するgem をリリース（Publish）する方法ローカルからリリースするCI からリリースする各環境へのインストール方法ローカルや本番環境でのインストールDependabot でのインストール関連記事GitHub Packages とはgithub.co.jpGitHub Packages はライブラリ（パッケージ）のホスティングサービスです。Ruby の場合 https://rubygems.org の代わりに https://rubygems.pkg.github.com に公開するイメージで、認証には GitHub の personal access token などを使います。既存のプライベート gem と GitHub Packages との違い既存のプライベート gem は主に git のタグやブランチを指定する方法が用いられますが、以下のようにいくつかの問題があります。# main ブランチの先端を使うのは再現性がない（ブランチ指定した場合も同じ）gem 'my_rubygem', github: 'my_name/my_rubygem'# タグを指定しても書き換えられる可能性があるgem 'my_rubygem', github: 'my_name/my_rubygem', tag: 'v1.0.0'# コミットの参照を指定するのはシンプルに見づらいgem 'my_rubygem', github: 'my_name/my_rubygem', ref: '4aded'GitHub Packages は rubygems.org と同じように、バージョン指定が明確かつ一度リリースしたバージョンは変更できないので安全です。GitHub Packages を使ってプライベート gem を社内限定で公開するここからは実際に GitHub Packages を使ってプライベート gem を社内限定で公開する方法（主にリリースとインストールの仕方）を説明していきます。今回は Organization は feedforce、gem の名前は socialplus-rails という想定です。日本語版のドキュメントは文章やサンプルコードが古いケースがあるので、以下の英語版ドキュメントを参照した方が良いです。Working with the RubyGems registry - GitHub Docs認証に使う personal access token の権限については以下のドキュメントが詳しいです。About permissions for GitHub Packages - GitHub Docsgem をリリース（Publish）する方法まずは作成した gem をリリースする方法について説明します。ローカルからリリースするまとめると以下のような手順になります。〜/.gem/credentials に GitHub の personal access token を追加権限は repo と write:packages が必要$ gem build socialplus-rails.gemspec で gem をビルドSocialplusRails::VERSION は 0.1.0 を想定$ gem push --key github --host https://rubygems.pkg.github.com/feedforce socialplus-rails-0.1.0.gem で push するこの時に personal access token の権限が足りないとエラーになるPush が成功すると https://github.com/orgs/feedforce/packages のような Packages のページに反映されます 👏CI からリリースするgem のソースコードを更新した際に毎回上記のようにローカルからリリースしても良いのですが、できれば CI からリリースできるように仕組み化したいものです。CircleCI の場合、以下のような release コマンドを定義して、リリース用のブランチがマージされた時に実行されるようにすれば OK です。# .circleci/config.ymlversion: 2.1# ...commands:  release:    description: Release to GitHub Packages    steps:      - run:          name: Create GitHub Packages Credentials          command: |            mkdir ~/.gem || true            echo -e \"---\\n:github: Bearer ${GITHUB_ACCESS_TOKEN}\" \u003e ~/.gem/credentials            chmod 0600 ~/.gem/credentials      - run:          name: Release Gem          command: |            gem build socialplus-rails.gemspec            release_version=$(find . -name \"socialplus-rails-*.gem\" | sed -E 's/\\.\\/socialplus-rails-(.*).gem/\\1/')            gem push --key github --host https://rubygems.pkg.github.com/feedforce \"socialplus-rails-${release_version}.gem\"各環境へのインストール方法ここからはリリースした gem を各環境へインストールする方法を説明します。Gemfile への記述は以下のようにします。*1# Gemfilesource 'https://rubygems.pkg.github.com/feedforce' do  gem 'socialplus-rails', '0.1.0'endローカルや本番環境でのインストール以下のように bundle config コマンドで認証情報をセットしてから bundle install を行います。*2# `USERNAME:TOKEN` は `{GitHubのユーザ名}:{Personal access token}` という形です（例: `daido1976:7axxx`）$ bundle config https://rubygems.pkg.github.com/feedforce USERNAME:TOKEN$ bundle install※ インストール時の認証に利用する personal access token には read:packages の権限のみあれば OK ですDependabot でのインストールGitHub Packages のプライベート gem をDependabot の更新対象にしたい場合は追加の設定が必要です。以下のように設定ファイルで GitHub Packages の認証情報を渡す準備をします。*3# .github/dependabot.ymlversion: 2registries:  rubygems-pkg-github:    type: rubygems-server    url: https://rubygems.pkg.github.com    # BUNDLE_GITHUB_TOKEN の値は `USERNAME:TOKEN` という形式です    token: \"${{secrets.BUNDLE_GITHUB_TOKEN}}\"以下ドキュメントを参考に GitHub Packages の認証情報（今回の例なら BUNDLE_GITHUB_TOKEN）を Dependabot 用の Secret として登録すれば完了です。*4Managing encrypted secrets for Dependabot - GitHub Docs関連記事GitHub Enterprise ServerのGitHub Packagesで社内用gemをホストする - ペパボテックブログGitHub Actionsを利用してgemをGitHub Packagesに公開する - アクトインディ開発者ブログDependabot で GitHub Packages に公開した Gem のアップデートをチェックする - 暇人じゃない*1:See. https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry#installing-a-package*2:環境変数を利用して認証情報をセットすることもできるようです*3:See. https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#rubygems-server*4:Secret はリポジトリ単位とオーガニゼーション単位のどちらでも設定できます","link":"https://developer.feedforce.jp/entry/2021/11/05/095050","isoDate":"2021-11-05T00:50:50.000Z","dateMiliSeconds":1636073450000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/d/daido1976/20211104/20211104160709.png","authorName":"feedforce"},{"title":"Amazon EKS で高負荷時に CoreDNS が原因で稀にネットワークエラーが発生していた時のトラブルシュート","content":"\u003cp\u003eソーシャルPLUS の開発チームでインフラエンジニア をやっています \u003ca href=\"http://blog.hatena.ne.jp/mayuki123/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/mayuki123/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:mayuki123\u003c/a\u003e です。今月からフィードフォースから分社化をした株式会社ソーシャルPLUS の所属となりましたが、仕事内容は変わらずにサービスのインフラ改善を進めていく事になるかと思います。\u003c/p\u003e\n\n\u003cp\u003e2019年11月に技術スタックを整理してみたという記事から2年弱経過していますが、ソーシャルPLUSのインフラ環境は、一部アプリケーションについてはコンテナ環境を Amazon EKS にホスティングして本番運用するようになりました。あと数ヶ月ほどで全ての環境がEC2からコンテナに置き換えられると良いなと思っています(願望)。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2019%2F11%2F25%2F120000\" title=\"ソーシャルPLUS の技術スタックを整理してみた - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2019/11/25/120000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eそして、既に利用されている機能の一部を Amazon EKS に移行して、しばらく経過した時にアプリケーションでネットワークエラーが稀に発生していました。原因調査をした結果が CoreDNS の負荷によるものと発覚するまでのトラブルシュートの流れについて、記事として書き残しておきます。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#発生していた事象\"\u003e発生していた事象\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Datadog-を活用した原因調査\"\u003eDatadog を活用した原因調査\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#アプリケーションの負荷状況\"\u003eアプリケーションの負荷状況\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#EKS-上のコンテナの調査\"\u003eEKS 上のコンテナの調査\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#EKS-のCoreDNS-の調査\"\u003eEKS のCoreDNS の調査\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#CoreDNS-のデバッグログの有効化\"\u003eCoreDNS のデバッグログの有効化\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Kubernetes-の名前解決について\"\u003eKubernetes の名前解決について\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#CoreDNS-の負荷軽減\"\u003eCoreDNS の負荷軽減\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#ドメインの末尾にドット--を追加する\"\u003eドメインの末尾にドット (.) を追加する\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#etcresolvconf-で-ndots1-の設定をする\"\u003e/etc/resolv.conf で ndots:1 の設定をする\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#その他の-CoreDNS-の負荷軽減の方法\"\u003eその他の CoreDNS の負荷軽減の方法\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#最終的な結果\"\u003e最終的な結果\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#おわりに\"\u003eおわりに\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#おまけ\"\u003eおまけ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"発生していた事象\"\u003e発生していた事象\u003c/h2\u003e\n\n\u003cp\u003eソーシャルPLUSでは、バックエンドのアプリケーションでエラーが発生した時に、Bugsnag を利用して Slack 通知するようにしています。ある時に\u003ccode\u003eMysql2::Error::ConnectionError\u003c/code\u003e が発生しました。単発のネットワークエラーの場合はアプリケーションがリトライする事でサービス影響がない事も多く、一時的な問題と思って静観する事があるかと思います。しかし、また数日後に同じ事象が発生しました。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/mayuki123/20210830/20210830152912.png\" alt=\"f:id:mayuki123:20210830152912p:plain\" width=\"667\" height=\"258\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%8F%E3%82%A4%E3%83%B3%E3%83%AA%E3%83%83%E3%83%92%E3%81%AE%E6%B3%95%E5%89%87\"\u003eハインリッヒの1：29：300の法則\u003c/a\u003eのように、ちょっとした異常を見落としていると重大なサービス障害となってしまう可能性があるので、原因調査を始めます。\u003c/p\u003e\n\n\u003ch2 id=\"Datadog-を活用した原因調査\"\u003eDatadog を活用した原因調査\u003c/h2\u003e\n\n\u003cp\u003eソーシャルPLUSでは、モニタリングサービスの Datadog を利用しているのでメトリクスやログの調査を出来るようになっています。どこが原因かを探り始めました。\u003c/p\u003e\n\n\u003ch3 id=\"アプリケーションの負荷状況\"\u003eアプリケーションの負荷状況\u003c/h3\u003e\n\n\u003cp\u003eまずはアプリケーションで利用するサーバの負荷状況を確認する所から始めました。\u003ccode\u003eMysql2::Error::ConnectionError\u003c/code\u003e が発生した時刻は EKS の Node の CPU 使用率が 70% ほどで、アプリケーションで負荷のかかる処理の最中でした。また、データベースの負荷は少し前に負荷対策の改善をした事もあって、今回の事件の犯人ではなさそうです。他にもEC2 と DB 間でネットワークのボトルネックがないかなどの確認はしましたが、CPU 使用率が高い以外の問題は特に見つかりませんでした。完全犯罪でしょうか。\u003c/p\u003e\n\n\u003ch3 id=\"EKS-上のコンテナの調査\"\u003eEKS 上のコンテナの調査\u003c/h3\u003e\n\n\u003cp\u003eサーバ単体の問題ではないとすると、Amazon EKS で何か起きている事を疑うことにしました。EKSで動かしているコンテナのログは Datadog Logs に送っているので、\u003cstrong\u003eエラーが発生していたアプリケーション以外のログ\u003c/strong\u003e を確認していると、MySQL の ConnectionError が発生した時間帯に下記の Warning のメッセージが出ている事に気づきました。このログは Amazon Kinesis Data Firehose にログを送る Fluent Bit のコンテナで発生しており、エラーが発生してたアプリケーションとは異なるノードに存在してました。\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003e[yyyy/mm/dd hh:mm:ss] [ warn] [net] getaddrinfo(host='kinesis.ap-northeast-1.amazonaws.com'): Name or service not known\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003e同時刻に特定のアプリケーション以外のコンテナも影響を受けていることから、EKS の中で問題がありそうです。元々、EKSに関する技術ブログは目を通すようにしていた事もあり、Kubernetes の DNS の名前解決で問題が発生する場合があるというのは知っていたので、CoreDNSに焦点を当てて調べることにしました。アウトプットをしてくれる人たちには、いつも感謝をしています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://medium.com/cloutive/production-ready-eks-coredns-configuration-6fea830606f8\"\u003eProduction Ready EKS CoreDNS Configuration | by Serkan Capkan | Cloutive Technology Solutions - Tech Blog | Medium\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://creators-note.chatwork.com/entry/2021/01/05/104206#%E4%B8%80%E5%AE%9A%E6%95%B0%E3%81%AEPod%E4%BB%A5%E4%B8%8A%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%A8%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%8C%E4%B8%8D%E5%AE%89%E5%AE%9A%E3%81%AB%E3%81%AA%E3%82%8B\"\u003eEKS\u0026#x3067;DNS\u0026#x3092;\u0026#x5B89;\u0026#x5B9A;\u0026#x3055;\u0026#x305B;\u0026#x308B;\u0026#x305F;\u0026#x3081;\u0026#x306B;\u0026#x5BFE;\u0026#x5FDC;\u0026#x3057;\u0026#x305F;\u0026#x3053;\u0026#x3068; - Chatwork Creator\u0026#39;s Note\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://labs.gree.jp/blog/2020/01/20271/\"\u003e\u0026#x30B9;\u0026#x30DE;\u0026#x30DB;\u0026#x30B2;\u0026#x30FC;\u0026#x30E0;\u0026#x306E; API \u0026#x30B5;\u0026#x30FC;\u0026#x30D0;\u0026#x306B;\u0026#x304A;\u0026#x3051;\u0026#x308B; EKS \u0026#x306E;\u0026#x904B;\u0026#x7528;\u0026#x4E8B;\u0026#x4F8B; | \u0026#x30A8;\u0026#x30F3;\u0026#x30B8;\u0026#x30CB;\u0026#x30A2;\u0026#x30D6;\u0026#x30ED;\u0026#x30B0; | GREE Engineering\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch2 id=\"EKS-のCoreDNS-の調査\"\u003eEKS のCoreDNS の調査\u003c/h2\u003e\n\n\u003cp\u003eDatadog Agent で Kurbernetes の各種メトリクスを収集していて、EKS の CoreDNS の状況も Datadog の Metric Explorer で確認する事が出来るようになっています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.datadoghq.com/ja/integrations/coredns/?tab=docker#%E3%83%A1%E3%83%88%E3%83%AA%E3%82%AF%E3%82%B9\"\u003eDatadog で取得可能な CoreDNS のメトリクス\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e\u003ccode\u003ecoredns.request_count\u003c/code\u003e を確認すると特定の時間帯で CoreDNS へのリクエストが多い状態で、このタイミングでの CoreDNS Pod の CPU 負荷は10％前後でしたが、それ以外に不審なメトリクスは存在しませんでした。まだ事象の原因との確信は持てないですが、負荷がそれなりにかかっていることは確かなのでリクエストが多くなる理由を調べます。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/mayuki123/20210831/20210831151005.png\" alt=\"f:id:mayuki123:20210831151005p:plain\" width=\"522\" height=\"200\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch3 id=\"CoreDNS-のデバッグログの有効化\"\u003eCoreDNS のデバッグログの有効化\u003c/h3\u003e\n\n\u003cp\u003eまずは CoreDNS のデバッグログを確認したいとなるかと思いますが、EKS の CoreDNS はデフォルトだとデバッグログの出力がオフの状態のため、どのようなリクエストが到達しているのかは確認する事ができません。CoreDNS のログを有効化する方法は AWS のナレッジベースにある記事に方法が記載されています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://aws.amazon.com/jp/premiumsupport/knowledge-center/eks-dns-failure/\"\u003eAmazon EKS \u0026#x3067;\u0026#x306E; DNS \u0026#x969C;\u0026#x5BB3;\u0026#x306E;\u0026#x30C8;\u0026#x30E9;\u0026#x30D6;\u0026#x30EB;\u0026#x30B7;\u0026#x30E5;\u0026#x30FC;\u0026#x30C6;\u0026#x30A3;\u0026#x30F3;\u0026#x30B0;\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこの記事によると、Namespace(\u003ccode\u003ekube-system\u003c/code\u003e) に Configmap (\u003ccode\u003ecoredns\u003c/code\u003e) があるので、Corefile 設定に \u003ccode\u003elog\u003c/code\u003e を追加するとデバッグログ が出力されるようになります。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# kubectl -n kube-system edit configmap coredns\nkind: ConfigMap\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        log    # Enabling CoreDNS Logging\n        errors\n        health\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n          pods insecure\n          upstream\n          fallthrough in-addr.arpa ip6.arpa\n        }\n        ...\u003c/pre\u003e\n\n\n\u003cp\u003e上記の設定をすると CoreDNS のPod の標準出力にデバッグログ が出力されるようになります。私の触っていた EKS の環境の場合は、数分ほどで CoreDNS の Pod で reload が発生して元の設定（デバッグログ がオフ）に戻るようになってました。\u003c/p\u003e\n\n\u003ch3 id=\"Kubernetes-の名前解決について\"\u003eKubernetes の名前解決について\u003c/h3\u003e\n\n\u003cp\u003e次にKubernetes 上のコンテナはどのように名前解決するのかを知っておく必要があります。Kurbernetes の Pod の DNS リゾルバー(\u003ccode\u003e/etc/resolv.conf\u003c/code\u003e) のデフォルト設定は下記のようになっています。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e% kubectl exec fluent-bit-46zvl -- cat /etc/resolv.conf\nnameserver 172.20.0.10\nsearch logging.svc.cluster.local svc.cluster.local cluster.local\noptions ndots:5\u003c/pre\u003e\n\n\n\u003cp\u003eこの状態で Fluent Bit のコンテナから Amazon Kinesis の API エンドポイントに疎通する場合は、CoreDNS に8回のリクエストが発生します。これは、IPv4 , IPv6 の2種類の名前解決を \u003ccode\u003esearch\u003c/code\u003e の数だけ名前解決を試みた後で EKS 外に名前解決をする設定になっているからです。この設定になっているおかげで Kubernetes の Service を使った名前解決が出来るようになっています。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/mayuki123/20210831/20210831154909.png\" alt=\"f:id:mayuki123:20210831154909p:plain\" width=\"1200\" height=\"328\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eまた、\u003ccode\u003eoptions ndots:5\u003c/code\u003e の設定は \u003ccode\u003e.\u003c/code\u003e の数が 5個以上の時は最初から外部に名前解決するようになります。そのため、Amazon Aurora や ElastiCache などのデータベースへの クラスターエンドポイントは \u003ccode\u003e.\u003c/code\u003e の数が五個以上あるので、CoreDNSへのリクエスト回数は少なくて済みます。ここを意識しなくてよいのはありがたいですね。\u003c/p\u003e\n\n\u003cp\u003eソーシャルPLUSというプロダクトの特性上、EKS 内のアプリケーションから外部サービスの API を実行する機会が多々あります。特定のタイミングで外部のサービスに大量のAPIリクエストを実行した際に、CoreDNS へのリクエストが増大してしまい不安定になってしまったのではと考えられます。\u003c/p\u003e\n\n\u003ch2 id=\"CoreDNS-の負荷軽減\"\u003eCoreDNS の負荷軽減\u003c/h2\u003e\n\n\u003cp\u003eKurbernetes 上のコンテナの名前解決を知ると、外部サービスのAPI を実行する際には CoreDNS へのリクエストが多くなる事が分かりました。ここで、CoreDNS へのリクエスト数を減らす方法は下記の二つがあります。これも AWS のナレッジベースに方法が記載されているので、詳細は下記の記事を読む方が良いと思います。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://aws.amazon.com/jp/premiumsupport/knowledge-center/eks-dns-failure/\"\u003eAmazon EKS \u0026#x3067;\u0026#x306E; DNS \u0026#x969C;\u0026#x5BB3;\u0026#x306E;\u0026#x30C8;\u0026#x30E9;\u0026#x30D6;\u0026#x30EB;\u0026#x30B7;\u0026#x30E5;\u0026#x30FC;\u0026#x30C6;\u0026#x30A3;\u0026#x30F3;\u0026#x30B0;\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch3 id=\"ドメインの末尾にドット--を追加する\"\u003eドメインの末尾にドット (.) を追加する\u003c/h3\u003e\n\n\u003cp\u003e接続先のドメインの最後に \u003ccode\u003e.\u003c/code\u003e をつけると、EKS の内部で名前解決を複数回しないようになり、CoreDNS へのリクエストの総数が減ります。一例をあげると、\u003ccode\u003eexample.com\u003c/code\u003e ではなく、 \u003ccode\u003eexample.com.\u003c/code\u003e とする事で最初から EKS の外部に名前解決をしてくれるようになります。ドメインが SDK の内部で定義されているような場合など、変更出来ない場合はこの方法は利用出来ないかと思います。\u003c/p\u003e\n\n\u003ch3 id=\"etcresolvconf-で-ndots1-の設定をする\"\u003e\u003ccode\u003e/etc/resolv.conf\u003c/code\u003e で ndots:1 の設定をする\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003e/etc/resolv.conf\u003c/code\u003e に \u003ccode\u003eoptions ndots:5\u003c/code\u003e とデフォルトで設定されている数値を \u003ccode\u003e1\u003c/code\u003e にする事で、ドメインに \u003ccode\u003e.\u003c/code\u003e が含まれている場合は常に EKS の外部に名前解決するようになります。Kubernetes の Manifest に \u003ccode\u003espec.dnsConfig\u003c/code\u003e パラメータを設定する事で Pod 単位で変更が出来ます。ただし、この設定をすると EKS 内部で名前解決をしなくなってしまいますが、\u003ccode\u003e\u0026lt;name\u0026gt;.\u0026lt;namespace\u0026gt;.svc.cluster.local.\u003c/code\u003e のように最後に \u003ccode\u003e.\u003c/code\u003e をつけると名前解決出来ました。Kurbernetes の Service の数が多いとこの方法を周知させるのも大変だと思います。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eapiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hoge\nspec:\n  template:\n    spec:\n      dnsConfig:\n        options:\n          - name: ndots\n            value: \u0026#34;1\u0026#34;\u003c/pre\u003e\n\n\n\u003ch3 id=\"その他の-CoreDNS-の負荷軽減の方法\"\u003eその他の CoreDNS の負荷軽減の方法\u003c/h3\u003e\n\n\u003cp\u003e上記の二つの方法は CoreDNS へのリクエスト数を減らすことで、負荷を軽減するようなアプローチでした。CoreDNS の Pod 数はデフォルトで 2個となりますが、CoreDNS のPod をオートスケールする手段もあります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://kubernetes.io/docs/tasks/administer-cluster/dns-horizontal-autoscaling/\"\u003eAutoscale the DNS Service in a Cluster\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eまた、Daemonset で DNS キャッシュをノード単位で配置するという方法もあります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://kubernetes.io/ja/docs/tasks/administer-cluster/nodelocaldns/\"\u003eKubernetesクラスターでNodeLocal DNSキャッシュを使用する\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこの辺りは他の方が書いた技術ブログも多くあるかと思うので、この記事では特に説明はしないです。\u003c/p\u003e\n\n\u003ch2 id=\"最終的な結果\"\u003e最終的な結果\u003c/h2\u003e\n\n\u003cp\u003eソーシャルPLUSでは最終的に根本原因の CoreDNS へのリクエスト数を減らすために \u003ccode\u003e/etc/resolv.conf\u003c/code\u003e で \u003ccode\u003endots:1\u003c/code\u003e の設定をするようにしました。この設定をアプリケーションの Pod に適応した所、CoreDNS へのリクエスト数は 25% ほどと目に見えて減少させる事が出来ました。キャプチャは載せてないですが、CoreDNS の Pod の CPU使用率も 以前の半分ほどになったので、負荷軽減の目的は達成しました。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/mayuki123/20210831/20210831171734.png\" alt=\"f:id:mayuki123:20210831171734p:plain\" width=\"527\" height=\"187\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eここまで、確信を持てないまま CoreDNS の負荷軽減に取り組みましたが、元々のネットワークエラーであった \u003ccode\u003eMysql2::Error::ConnectionError\u003c/code\u003e のエラーは再発しなくなりました。また、EKS 上の他のコンテナも \u003ccode\u003eName or service not known\u003c/code\u003e のような名前解決が出来ないといったエラーも発生しなくなりました。CoreDNS の負荷を減らす事で悩まされていた問題の解消が出来たと思います。今回のように比較的早い段階で気づく事が出来たので、お客さんへのサービス影響のある問題に発展せずに済みました。\u003c/p\u003e\n\n\u003cp\u003e今後、利用者数が増えてより負荷のかかる状況になってきた時には再発する可能性はありますが、早い段階で気付けるように日々確認するダッシュボードにメトリクスを追加するようにしています。その時がきた場合は CoreDNS の Pod 数の調整や DNS キャッシュの導入が必要になりそうです。\u003c/p\u003e\n\n\u003ch2 id=\"おわりに\"\u003eおわりに\u003c/h2\u003e\n\n\u003cp\u003e最終的には Pod の DNS 設定を調整するだけでネットワークエラーは解決しました。この記事では、結果だけではなくて解決に至るまでの経緯をメインにまとめてみました。実施していて良かったと思うことを下記にまとめます。これらの事が出来ていなければ、今回のようなネットワークエラーはたまに発生する事象として、根本原因の追及は出来なかったと思うので、サービスのオブザーバビリティを整備する事や日々の情報収集は大事ですね。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eアプリケーションのエラーを Slack に通知していた\u003c/li\u003e\n\u003cli\u003eKurbernetes のメトリクスを Datadog で確認できる状態だった\u003c/li\u003e\n\u003cli\u003eコンテナのログを一元的に Datadog Logs  で閲覧できるようにしていた\u003c/li\u003e\n\u003cli\u003e他の人の技術ブログから Kubernetes の CoreDNS が不安定になることを知っていた\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこの記事に間違っている内容や、もっと良い改善方法がある事をご存知の方がいましたら、優しく教えてください。\u003c/p\u003e\n\n\u003ch2 id=\"おまけ\"\u003eおまけ\u003c/h2\u003e\n\n\u003cp\u003e現在、ソーシャルPLUS では作りたい機能が山ほどある状況でまだまだ成長するサービスになると思うので、成長を続けるサービスに携わりたいエンジニアやデザイナーのご応募をお待ちしております！サイトにはまだないですが、インフラエンジニアも近いうちに募集をする事にはなると思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fopen.talentio.com%2F1%2Fc%2Ffeedforce%2Frequisitions%2Fdetail%2F21802\" title=\"Railsエンジニア【Shopify App開発/ID連携サービス】 / 株式会社フィードフォース\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://open.talentio.com/1/c/feedforce/requisitions/detail/21802\"\u003eopen.talentio.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fopen.talentio.com%2F1%2Fc%2Ffeedforce%2Frequisitions%2Fdetail%2F21755\" title=\"フロントエンドエンジニア【Shopifyアプリ開発/ID連携サービス/React/TypeScript】 / 株式会社フィードフォース\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://open.talentio.com/1/c/feedforce/requisitions/detail/21755\"\u003eopen.talentio.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fopen.talentio.com%2F1%2Fc%2Ffeedforce%2Frequisitions%2Fdetail%2F21760\" title=\"UI/UXデザイナー【ID連携サービス/マーケティング支援SaaS】 / 株式会社フィードフォース\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://open.talentio.com/1/c/feedforce/requisitions/detail/21760\"\u003eopen.talentio.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eフィードフォース の他のサービスもエンジニアを募集してますので、興味があればご応募お待ちしております！\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fengineers.recruit.feedforce.jp%2F%3F_ga%3D2.157559610.1029003260.1630297434-1923366822.1626416415%23entry\" title=\"フィードフォース エンジニア・デザイナー採用サイト\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://engineers.recruit.feedforce.jp/?_ga=2.157559610.1029003260.1630297434-1923366822.1626416415#entry\"\u003eengineers.recruit.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n","contentSnippet":"ソーシャルPLUS の開発チームでインフラエンジニア をやっています id:mayuki123 です。今月からフィードフォースから分社化をした株式会社ソーシャルPLUS の所属となりましたが、仕事内容は変わらずにサービスのインフラ改善を進めていく事になるかと思います。2019年11月に技術スタックを整理してみたという記事から2年弱経過していますが、ソーシャルPLUSのインフラ環境は、一部アプリケーションについてはコンテナ環境を Amazon EKS にホスティングして本番運用するようになりました。あと数ヶ月ほどで全ての環境がEC2からコンテナに置き換えられると良いなと思っています(願望)。developer.feedforce.jpそして、既に利用されている機能の一部を Amazon EKS に移行して、しばらく経過した時にアプリケーションでネットワークエラーが稀に発生していました。原因調査をした結果が CoreDNS の負荷によるものと発覚するまでのトラブルシュートの流れについて、記事として書き残しておきます。発生していた事象Datadog を活用した原因調査アプリケーションの負荷状況EKS 上のコンテナの調査EKS のCoreDNS の調査CoreDNS のデバッグログの有効化Kubernetes の名前解決についてCoreDNS の負荷軽減ドメインの末尾にドット (.) を追加する/etc/resolv.conf で ndots:1 の設定をするその他の CoreDNS の負荷軽減の方法最終的な結果おわりにおまけ発生していた事象ソーシャルPLUSでは、バックエンドのアプリケーションでエラーが発生した時に、Bugsnag を利用して Slack 通知するようにしています。ある時にMysql2::Error::ConnectionError が発生しました。単発のネットワークエラーの場合はアプリケーションがリトライする事でサービス影響がない事も多く、一時的な問題と思って静観する事があるかと思います。しかし、また数日後に同じ事象が発生しました。ハインリッヒの1：29：300の法則のように、ちょっとした異常を見落としていると重大なサービス障害となってしまう可能性があるので、原因調査を始めます。Datadog を活用した原因調査ソーシャルPLUSでは、モニタリングサービスの Datadog を利用しているのでメトリクスやログの調査を出来るようになっています。どこが原因かを探り始めました。アプリケーションの負荷状況まずはアプリケーションで利用するサーバの負荷状況を確認する所から始めました。Mysql2::Error::ConnectionError が発生した時刻は EKS の Node の CPU 使用率が 70% ほどで、アプリケーションで負荷のかかる処理の最中でした。また、データベースの負荷は少し前に負荷対策の改善をした事もあって、今回の事件の犯人ではなさそうです。他にもEC2 と DB 間でネットワークのボトルネックがないかなどの確認はしましたが、CPU 使用率が高い以外の問題は特に見つかりませんでした。完全犯罪でしょうか。EKS 上のコンテナの調査サーバ単体の問題ではないとすると、Amazon EKS で何か起きている事を疑うことにしました。EKSで動かしているコンテナのログは Datadog Logs に送っているので、エラーが発生していたアプリケーション以外のログ を確認していると、MySQL の ConnectionError が発生した時間帯に下記の Warning のメッセージが出ている事に気づきました。このログは Amazon Kinesis Data Firehose にログを送る Fluent Bit のコンテナで発生しており、エラーが発生してたアプリケーションとは異なるノードに存在してました。[yyyy/mm/dd hh:mm:ss] [ warn] [net] getaddrinfo(host='kinesis.ap-northeast-1.amazonaws.com'): Name or service not known同時刻に特定のアプリケーション以外のコンテナも影響を受けていることから、EKS の中で問題がありそうです。元々、EKSに関する技術ブログは目を通すようにしていた事もあり、Kubernetes の DNS の名前解決で問題が発生する場合があるというのは知っていたので、CoreDNSに焦点を当てて調べることにしました。アウトプットをしてくれる人たちには、いつも感謝をしています。Production Ready EKS CoreDNS Configuration | by Serkan Capkan | Cloutive Technology Solutions - Tech Blog | MediumEKSでDNSを安定させるために対応したこと - Chatwork Creator's Noteスマホゲームの API サーバにおける EKS の運用事例 | エンジニアブログ | GREE EngineeringEKS のCoreDNS の調査Datadog Agent で Kurbernetes の各種メトリクスを収集していて、EKS の CoreDNS の状況も Datadog の Metric Explorer で確認する事が出来るようになっています。Datadog で取得可能な CoreDNS のメトリクスcoredns.request_count を確認すると特定の時間帯で CoreDNS へのリクエストが多い状態で、このタイミングでの CoreDNS Pod の CPU 負荷は10％前後でしたが、それ以外に不審なメトリクスは存在しませんでした。まだ事象の原因との確信は持てないですが、負荷がそれなりにかかっていることは確かなのでリクエストが多くなる理由を調べます。CoreDNS のデバッグログの有効化まずは CoreDNS のデバッグログを確認したいとなるかと思いますが、EKS の CoreDNS はデフォルトだとデバッグログの出力がオフの状態のため、どのようなリクエストが到達しているのかは確認する事ができません。CoreDNS のログを有効化する方法は AWS のナレッジベースにある記事に方法が記載されています。Amazon EKS での DNS 障害のトラブルシューティングこの記事によると、Namespace(kube-system) に Configmap (coredns) があるので、Corefile 設定に log を追加するとデバッグログ が出力されるようになります。# kubectl -n kube-system edit configmap corednskind: ConfigMapapiVersion: v1data:  Corefile: |    .:53 {        log    # Enabling CoreDNS Logging        errors        health        kubernetes cluster.local in-addr.arpa ip6.arpa {          pods insecure          upstream          fallthrough in-addr.arpa ip6.arpa        }        ...上記の設定をすると CoreDNS のPod の標準出力にデバッグログ が出力されるようになります。私の触っていた EKS の環境の場合は、数分ほどで CoreDNS の Pod で reload が発生して元の設定（デバッグログ がオフ）に戻るようになってました。Kubernetes の名前解決について次にKubernetes 上のコンテナはどのように名前解決するのかを知っておく必要があります。Kurbernetes の Pod の DNS リゾルバー(/etc/resolv.conf) のデフォルト設定は下記のようになっています。% kubectl exec fluent-bit-46zvl -- cat /etc/resolv.confnameserver 172.20.0.10search logging.svc.cluster.local svc.cluster.local cluster.localoptions ndots:5この状態で Fluent Bit のコンテナから Amazon Kinesis の API エンドポイントに疎通する場合は、CoreDNS に8回のリクエストが発生します。これは、IPv4 , IPv6 の2種類の名前解決を search の数だけ名前解決を試みた後で EKS 外に名前解決をする設定になっているからです。この設定になっているおかげで Kubernetes の Service を使った名前解決が出来るようになっています。また、options ndots:5 の設定は . の数が 5個以上の時は最初から外部に名前解決するようになります。そのため、Amazon Aurora や ElastiCache などのデータベースへの クラスターエンドポイントは . の数が五個以上あるので、CoreDNSへのリクエスト回数は少なくて済みます。ここを意識しなくてよいのはありがたいですね。ソーシャルPLUSというプロダクトの特性上、EKS 内のアプリケーションから外部サービスの API を実行する機会が多々あります。特定のタイミングで外部のサービスに大量のAPIリクエストを実行した際に、CoreDNS へのリクエストが増大してしまい不安定になってしまったのではと考えられます。CoreDNS の負荷軽減Kurbernetes 上のコンテナの名前解決を知ると、外部サービスのAPI を実行する際には CoreDNS へのリクエストが多くなる事が分かりました。ここで、CoreDNS へのリクエスト数を減らす方法は下記の二つがあります。これも AWS のナレッジベースに方法が記載されているので、詳細は下記の記事を読む方が良いと思います。Amazon EKS での DNS 障害のトラブルシューティングドメインの末尾にドット (.) を追加する接続先のドメインの最後に . をつけると、EKS の内部で名前解決を複数回しないようになり、CoreDNS へのリクエストの総数が減ります。一例をあげると、example.com ではなく、 example.com. とする事で最初から EKS の外部に名前解決をしてくれるようになります。ドメインが SDK の内部で定義されているような場合など、変更出来ない場合はこの方法は利用出来ないかと思います。/etc/resolv.conf で ndots:1 の設定をする/etc/resolv.conf に options ndots:5 とデフォルトで設定されている数値を 1 にする事で、ドメインに . が含まれている場合は常に EKS の外部に名前解決するようになります。Kubernetes の Manifest に spec.dnsConfig パラメータを設定する事で Pod 単位で変更が出来ます。ただし、この設定をすると EKS 内部で名前解決をしなくなってしまいますが、\u003cname\u003e.\u003cnamespace\u003e.svc.cluster.local. のように最後に . をつけると名前解決出来ました。Kurbernetes の Service の数が多いとこの方法を周知させるのも大変だと思います。apiVersion: apps/v1kind: Deploymentmetadata:  name: hogespec:  template:    spec:      dnsConfig:        options:          - name: ndots            value: \"1\"その他の CoreDNS の負荷軽減の方法上記の二つの方法は CoreDNS へのリクエスト数を減らすことで、負荷を軽減するようなアプローチでした。CoreDNS の Pod 数はデフォルトで 2個となりますが、CoreDNS のPod をオートスケールする手段もあります。Autoscale the DNS Service in a Clusterまた、Daemonset で DNS キャッシュをノード単位で配置するという方法もあります。KubernetesクラスターでNodeLocal DNSキャッシュを使用するこの辺りは他の方が書いた技術ブログも多くあるかと思うので、この記事では特に説明はしないです。最終的な結果ソーシャルPLUSでは最終的に根本原因の CoreDNS へのリクエスト数を減らすために /etc/resolv.conf で ndots:1 の設定をするようにしました。この設定をアプリケーションの Pod に適応した所、CoreDNS へのリクエスト数は 25% ほどと目に見えて減少させる事が出来ました。キャプチャは載せてないですが、CoreDNS の Pod の CPU使用率も 以前の半分ほどになったので、負荷軽減の目的は達成しました。ここまで、確信を持てないまま CoreDNS の負荷軽減に取り組みましたが、元々のネットワークエラーであった Mysql2::Error::ConnectionError のエラーは再発しなくなりました。また、EKS 上の他のコンテナも Name or service not known のような名前解決が出来ないといったエラーも発生しなくなりました。CoreDNS の負荷を減らす事で悩まされていた問題の解消が出来たと思います。今回のように比較的早い段階で気づく事が出来たので、お客さんへのサービス影響のある問題に発展せずに済みました。今後、利用者数が増えてより負荷のかかる状況になってきた時には再発する可能性はありますが、早い段階で気付けるように日々確認するダッシュボードにメトリクスを追加するようにしています。その時がきた場合は CoreDNS の Pod 数の調整や DNS キャッシュの導入が必要になりそうです。おわりに最終的には Pod の DNS 設定を調整するだけでネットワークエラーは解決しました。この記事では、結果だけではなくて解決に至るまでの経緯をメインにまとめてみました。実施していて良かったと思うことを下記にまとめます。これらの事が出来ていなければ、今回のようなネットワークエラーはたまに発生する事象として、根本原因の追及は出来なかったと思うので、サービスのオブザーバビリティを整備する事や日々の情報収集は大事ですね。アプリケーションのエラーを Slack に通知していたKurbernetes のメトリクスを Datadog で確認できる状態だったコンテナのログを一元的に Datadog Logs  で閲覧できるようにしていた他の人の技術ブログから Kubernetes の CoreDNS が不安定になることを知っていたこの記事に間違っている内容や、もっと良い改善方法がある事をご存知の方がいましたら、優しく教えてください。おまけ現在、ソーシャルPLUS では作りたい機能が山ほどある状況でまだまだ成長するサービスになると思うので、成長を続けるサービスに携わりたいエンジニアやデザイナーのご応募をお待ちしております！サイトにはまだないですが、インフラエンジニアも近いうちに募集をする事にはなると思います。open.talentio.comopen.talentio.comopen.talentio.comフィードフォース の他のサービスもエンジニアを募集してますので、興味があればご応募お待ちしております！engineers.recruit.feedforce.jp","link":"https://developer.feedforce.jp/entry/2021/09/02/134725","isoDate":"2021-09-02T04:47:25.000Z","dateMiliSeconds":1630558045000,"imageUrl":"https://cdn.user.blog.st-hatena.com/default_entry_og_image/4268819/1588226000876991","authorName":"feedforce"},{"title":"Looker で Join 先の view の primary_key をいい感じにテストする方法をようやく見つけた","content":"\u003cp\u003eこんにちは、\u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\n先週はまるっと夏休みにしてました。今日からまた \u003ca href=\"https://ja.looker.com/\"\u003eLooker\u003c/a\u003e と戯れる日々が始まります。\u003c/p\u003e\n\n\u003cp\u003e丸１年 Looker と戯れてきて最近ようやく、\u003cstrong\u003eJoin 先の view でも\u003c/strong\u003e primary_key が壊れてないことを保証するテストの書き方が分かったので、今回紹介します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#Looker-における-primary_key-の役割\"\u003eLooker における primary_key の役割\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#primary_key-の実装例\"\u003eprimary_key の実装例\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#LookML-開発におけるテスト\"\u003eLookML 開発におけるテスト\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Join-先の-view-は-primary_key-をテスト出来ないことがある\"\u003eJoin 先の view は primary_key をテスト出来ないことがある\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Join-先の-view-の-primary_key-をいい感じにテストする\"\u003eJoin 先の view の primary_key をいい感じにテストする\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめと所感\"\u003eまとめと所感\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#おまけ\"\u003eおまけ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"Looker-における-primary_key-の役割\"\u003eLooker における primary_key の役割\u003c/h2\u003e\n\n\u003cp\u003eLooker には \u003ca href=\"https://help.looker.com/hc/en-us/articles/360023722974\"\u003eSymmetric Aggregates\u003c/a\u003e という、合計を重複させない素晴らしい仕組みがあります。以前このブログでも紹介しました。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2020%2F10%2F23%2F190000\" title=\"『4月から取り組んできたLookerの導入から実装までのお話（Redashとも比較）』という発表をした - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003eその Symmetric Aggregates では \u003ca href=\"https://docs.looker.com/reference/field-params/primary_key\"\u003eprimary_key\u003c/a\u003e が重要な役割を果たします。適切に設定されていないと、以下のような問題が発生します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eprimary_key が重複すると fanout エラーが発生することがある\u003c/li\u003e\n\u003cli\u003eprimary_key が null だと Measure が 0 になることがある\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこのような問題は大概、ふわっと質問が来て発覚します。今のタスクを保留にして調査することは精神的になかなか辛いものがあり、それなりに時間も費やすことになるため、可能な限り事前に避けたいところです。\u003c/p\u003e\n\n\u003ch2 id=\"primary_key-の実装例\"\u003eprimary_key の実装例\u003c/h2\u003e\n\n\u003cp\u003e私が所属する \u003ca href=\"https://feedmatic.net/\"\u003eFeedmatic\u003c/a\u003e では、ウェブ広告や Google Analytics のデータを扱っています。正規化されたきれいなデータは少なく、Rails の id のようなユニークなカラムは存在しないことが多いです。\u003c/p\u003e\n\n\u003cp\u003eそのため、このようにいくつかの Dimension を組み合わせて primary_key を定義します。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003edimension: id {\n  primary_key: yes\n  type: string\n  sql: CONCAT(${dimension1}, ${dimension2}, IFNULL(${dimension3}, \u0026#39;\u0026#39;)) ;;\n  hidden: yes\n}\u003c/pre\u003e\n\n\n\u003cp\u003e※ \u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%BC%E3%82%BF%E3%82%A6%E3%82%A7%E3%82%A2%E3%83%8F%E3%82%A6%E3%82%B9\"\u003eDWH\u003c/a\u003e は BigQuery を使っています。\u003c/p\u003e\n\n\u003cp\u003eこれで済めばよいのですが、上の例だとある日突然 dimension2 が null になり始めたり、全ての string 型の Dimension を使っても重複し始めることがあります。データの性格は理解していたつもりでしたが、実際どちらもありました。😭\u003c/p\u003e\n\n\u003ch2 id=\"LookML-開発におけるテスト\"\u003eLookML 開発におけるテスト\u003c/h2\u003e\n\n\u003cp\u003e以上の課題を解決するために、\u003ca href=\"https://docs.looker.com/reference/model-params/test\"\u003etest\u003c/a\u003e パラメータが使えます。\u003c/p\u003e\n\n\u003cp\u003e例えばこのような \u003ccode\u003eparent\u003c/code\u003e explore があったとします。Join がないのでシンプルです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eexplore: parent {\n  ...\n}\n\nview: parent {\n  dimension: id {\n    primary_key: yes\n    ...\n  }\n\n  measure: count {\n    type: count\n  }\n}\u003c/pre\u003e\n\n\n\u003cp\u003e私はこのようなテストを書いて、全ての \u003ccode\u003eparent.id\u003c/code\u003e が null でないことと、重複しないことを保証させています。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003etest: parent_id_is_not_null {\n  explore_source: parent {\n    column: id {}\n    sorts: [parent.id: asc]\n    limit: 1\n  }\n  assert: id_is_not_null {\n    expression: NOT is_null(${parent.id}) ;;\n  }\n}\n\ntest: parent_id_is_unique {\n  explore_source: parent {\n    column: id {}\n    column: count {}\n    sorts: [parent.count: desc]\n    limit: 1\n  }\n  assert: id_is_unique {\n    expression: ${parent.count} = 1 ;;\n  }\n}\u003c/pre\u003e\n\n\n\u003cp\u003e👉 ソート時に null が先頭と末尾のどちらに来るかは、DWH の実装によります。\u003c/p\u003e\n\n\u003ch2 id=\"Join-先の-view-は-primary_key-をテスト出来ないことがある\"\u003eJoin 先の view は primary_key をテスト出来ないことがある\u003c/h2\u003e\n\n\u003cp\u003eさて、\u003ccode\u003echild\u003c/code\u003e view を Join する必要が出てきました。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eexplore: parent {\n  join: child {\n    type: left_outer\n    relationship: one_to_many\n    sql_on: ... ;;\n  }\n}\n\nview: parent {\n  dimension: id {\n    primary_key: yes\n    ...\n  }\n\n  measure: count {\n    type: count\n  }\n}\n\nview: child {\n  dimension: id {\n    primary_key: yes\n    ...\n  }\n\n  measure: count {\n    type: count\n    hidden: yes\n  }\n}\u003c/pre\u003e\n\n\n\u003cp\u003e同じように \u003ccode\u003echild.id\u003c/code\u003e のテストを書きましたが、うまくいきません。\u003ccode\u003eis_not_null\u003c/code\u003e はまだしも、\u003ccode\u003eis_unique\u003c/code\u003e がダメです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# これは OK\ntest: parent_child_id_is_not_null {\n  explore_source: parent {\n    column: id { field: child.id }\n    sorts: [child.id: asc]\n    limit: 1\n  }\n  assert: child_id_is_not_null {\n    expression: NOT is_null(${child.id}) ;;\n  }\n}\n\n# parent の count になり、テストが通らない。\ntest: parent_child_id_is_unique {\n  explore_source: parent {\n    column: id { field: child.id }\n    column: count { field: child.count }\n    sorts: [parent.count: desc]\n    limit: 1\n  }\n  assert: child_id_is_unique {\n    expression: ${child.count} = 1 ;;\n  }\n}\u003c/pre\u003e\n\n\n\u003cp\u003eよく考えれば当たり前の話で、Join した状態でテストを書いているからです。そもそも \u003ccode\u003echild\u003c/code\u003e view の primary_key のテストをしたいだけなのに、Join は邪魔です。\u003c/p\u003e\n\n\u003ch2 id=\"Join-先の-view-の-primary_key-をいい感じにテストする\"\u003eJoin 先の view の primary_key をいい感じにテストする\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003echild\u003c/code\u003e view と同じファイルに、こっそり \u003ccode\u003echild\u003c/code\u003e explore を定義します。\u003ca href=\"https://docs.looker.com/ja/reference/explore-params/hidden-for-explore\"\u003ehidden\u003c/a\u003e にして存在を消しています。さらに \u003ca href=\"https://docs.looker.com/reference/explore-params/required_access_grants-for-explore\"\u003erequired_access_grants\u003c/a\u003e で、開発者以外の URL 直打ちによるアクセスも防いでいます。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eview: child {\n  dimension: id {\n    primary_key: yes\n    ...\n  }\n\n  measure: count {\n    type: count\n    hidden: yes\n  }\n}\n\n# Define for test\nexplore: child {\n  hidden: yes\n  required_access_grants: [can_view_explores_for_tests]\n}\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ca href=\"https://docs.looker.com/reference/model-params/access_grant\"\u003eaccess_grant\u003c/a\u003e である \u003ccode\u003ecan_view_explores_for_tests\u003c/code\u003e はこのような定義です。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# For tests\naccess_grant: can_view_explores_for_tests {\n  user_attribute: view_explores_for_tests\n  allowed_values: [\u0026#34;yes\u0026#34;]\n}\u003c/pre\u003e\n\n\n\u003cp\u003e\u003ca href=\"https://docs.looker.com/admin-options/settings/user-attributes\"\u003eUser attribute\u003c/a\u003e である \u003ccode\u003eview_explores_for_tests\u003c/code\u003e は、今回のような「Join 先の view をテストすること」全般に使います。User Access は \u003ccode\u003eNone\u003c/code\u003e、Default Value も \u003ccode\u003eno\u003c/code\u003e です。開発者用の Group を作り、その Group value を \u003ccode\u003eyes\u003c/code\u003e にしました。\u003c/p\u003e\n\n\u003cp\u003eここまでやらずとも全員アクセス不可でも良いのですが、テストが落ちた時に「クエリの探索」からの調査ができなくなるので、開発者にはアクセス権を与えるポリシーにしています。\u003c/p\u003e\n\n\u003cp\u003eあとは \u003ccode\u003eparent\u003c/code\u003e explore と同じようにテストを書くだけです。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003etest: child_id_is_not_null {\n  explore_source: child {\n    column: id {}\n    sorts: [child.id: asc]\n    limit: 1\n  }\n  assert: id_is_not_null {\n    expression: NOT is_null(${child.id}) ;;\n  }\n}\n\ntest: child_id_is_unique {\n  explore_source: child {\n    column: id {}\n    column: count {}\n    sorts: [child.count: desc]\n    limit: 1\n  }\n  assert: id_is_unique {\n    expression: ${child.count} = 1 ;;\n  }\n}\u003c/pre\u003e\n\n\n\u003cp\u003eテストは通っても、LookML validation error が発生するかもしれません。その時は \u003ca href=\"https://docs.looker.com/ja/reference/explore-params/fields-for-explore\"\u003efields\u003c/a\u003e パラメータを使って、露出する field を限定すると良いでしょう。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# Define for test\nexplore: child {\n  hidden: yes\n  required_access_grants: [can_view_explores_for_tests]\n  fields: [child.id, child.count] # Avoid LookML validation error\n}\u003c/pre\u003e\n\n\n\u003cp\u003eこのテクニックは \u003ca href=\"https://help.looker.com/hc/en-us/articles/360023586293-Error-Unknown-or-Inaccessible-Field\"\u003eError: Unknown or Inaccessible Field – Looker Help Center\u003c/a\u003e でも紹介されています。\u003c/p\u003e\n\n\u003ch2 id=\"まとめと所感\"\u003eまとめと所感\u003c/h2\u003e\n\n\u003cp\u003eLookML 開発者で、且つテストを書いていて、且つ Join 先の view の primary_key に課題を抱えている、大変ニッチな層向けに記事を書きました。どこかの誰かに参考になれば幸いです。\u003c/p\u003e\n\n\u003cp\u003eもっと良い方法や、今回のやり方はここがマズイとかあれば \u003ca href=\"https://twitter.com/masutaka\"\u003e@masutaka\u003c/a\u003e にお知らせ頂けると大変うれしいです。🙏\u003c/p\u003e\n\n\u003cp\u003eFeedmatic では今回のような view は数十もあり、primary_key のテストはまだ書き始めたばかりです。\u003c/p\u003e\n\n\u003cp\u003eLooker ではテストは直列でしか実行されないようで、書けば書くほど全テストが遅くなるのはモヤモヤしています。さすがに要望しようと思ってますが。\u003c/p\u003e\n\n\u003cp\u003eそれに関連して、最近ディレクトリやファイル構成を再検討しました。次回はその記事を書く予定です。\u003c/p\u003e\n\n\u003ch2 id=\"おまけ\"\u003eおまけ\u003c/h2\u003e\n\n\u003cp\u003e今回の記事を書く過程で、中の人が書いたベストプラクティスを見つけました。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fcommunity.looker.com%2Flookml-5%2Flookml-data-tests-recommendations-and-best-practices-20815\" title=\"LookML Data Tests: Recommendations and Best Practices | Looker Community\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003e今回の記事ほど細かいテクニックは書かれていませんが、全体を網羅した良記事なので要チェックです。\u003c/p\u003e\n","contentSnippet":"こんにちは、id:masutaka26 です。先週はまるっと夏休みにしてました。今日からまた Looker と戯れる日々が始まります。丸１年 Looker と戯れてきて最近ようやく、Join 先の view でも primary_key が壊れてないことを保証するテストの書き方が分かったので、今回紹介します。Looker における primary_key の役割primary_key の実装例LookML 開発におけるテストJoin 先の view は primary_key をテスト出来ないことがあるJoin 先の view の primary_key をいい感じにテストするまとめと所感おまけLooker における primary_key の役割Looker には Symmetric Aggregates という、合計を重複させない素晴らしい仕組みがあります。以前このブログでも紹介しました。その Symmetric Aggregates では primary_key が重要な役割を果たします。適切に設定されていないと、以下のような問題が発生します。primary_key が重複すると fanout エラーが発生することがあるprimary_key が null だと Measure が 0 になることがあるこのような問題は大概、ふわっと質問が来て発覚します。今のタスクを保留にして調査することは精神的になかなか辛いものがあり、それなりに時間も費やすことになるため、可能な限り事前に避けたいところです。primary_key の実装例私が所属する Feedmatic では、ウェブ広告や Google Analytics のデータを扱っています。正規化されたきれいなデータは少なく、Rails の id のようなユニークなカラムは存在しないことが多いです。そのため、このようにいくつかの Dimension を組み合わせて primary_key を定義します。dimension: id {  primary_key: yes  type: string  sql: CONCAT(${dimension1}, ${dimension2}, IFNULL(${dimension3}, '')) ;;  hidden: yes}※ DWH は BigQuery を使っています。これで済めばよいのですが、上の例だとある日突然 dimension2 が null になり始めたり、全ての string 型の Dimension を使っても重複し始めることがあります。データの性格は理解していたつもりでしたが、実際どちらもありました。😭LookML 開発におけるテスト以上の課題を解決するために、test パラメータが使えます。例えばこのような parent explore があったとします。Join がないのでシンプルです。explore: parent {  ...}view: parent {  dimension: id {    primary_key: yes    ...  }  measure: count {    type: count  }}私はこのようなテストを書いて、全ての parent.id が null でないことと、重複しないことを保証させています。test: parent_id_is_not_null {  explore_source: parent {    column: id {}    sorts: [parent.id: asc]    limit: 1  }  assert: id_is_not_null {    expression: NOT is_null(${parent.id}) ;;  }}test: parent_id_is_unique {  explore_source: parent {    column: id {}    column: count {}    sorts: [parent.count: desc]    limit: 1  }  assert: id_is_unique {    expression: ${parent.count} = 1 ;;  }}👉 ソート時に null が先頭と末尾のどちらに来るかは、DWH の実装によります。Join 先の view は primary_key をテスト出来ないことがあるさて、child view を Join する必要が出てきました。explore: parent {  join: child {    type: left_outer    relationship: one_to_many    sql_on: ... ;;  }}view: parent {  dimension: id {    primary_key: yes    ...  }  measure: count {    type: count  }}view: child {  dimension: id {    primary_key: yes    ...  }  measure: count {    type: count    hidden: yes  }}同じように child.id のテストを書きましたが、うまくいきません。is_not_null はまだしも、is_unique がダメです。# これは OKtest: parent_child_id_is_not_null {  explore_source: parent {    column: id { field: child.id }    sorts: [child.id: asc]    limit: 1  }  assert: child_id_is_not_null {    expression: NOT is_null(${child.id}) ;;  }}# parent の count になり、テストが通らない。test: parent_child_id_is_unique {  explore_source: parent {    column: id { field: child.id }    column: count { field: child.count }    sorts: [parent.count: desc]    limit: 1  }  assert: child_id_is_unique {    expression: ${child.count} = 1 ;;  }}よく考えれば当たり前の話で、Join した状態でテストを書いているからです。そもそも child view の primary_key のテストをしたいだけなのに、Join は邪魔です。Join 先の view の primary_key をいい感じにテストするchild view と同じファイルに、こっそり child explore を定義します。hidden にして存在を消しています。さらに required_access_grants で、開発者以外の URL 直打ちによるアクセスも防いでいます。view: child {  dimension: id {    primary_key: yes    ...  }  measure: count {    type: count    hidden: yes  }}# Define for testexplore: child {  hidden: yes  required_access_grants: [can_view_explores_for_tests]}access_grant である can_view_explores_for_tests はこのような定義です。# For testsaccess_grant: can_view_explores_for_tests {  user_attribute: view_explores_for_tests  allowed_values: [\"yes\"]}User attribute である view_explores_for_tests は、今回のような「Join 先の view をテストすること」全般に使います。User Access は None、Default Value も no です。開発者用の Group を作り、その Group value を yes にしました。ここまでやらずとも全員アクセス不可でも良いのですが、テストが落ちた時に「クエリの探索」からの調査ができなくなるので、開発者にはアクセス権を与えるポリシーにしています。あとは parent explore と同じようにテストを書くだけです。test: child_id_is_not_null {  explore_source: child {    column: id {}    sorts: [child.id: asc]    limit: 1  }  assert: id_is_not_null {    expression: NOT is_null(${child.id}) ;;  }}test: child_id_is_unique {  explore_source: child {    column: id {}    column: count {}    sorts: [child.count: desc]    limit: 1  }  assert: id_is_unique {    expression: ${child.count} = 1 ;;  }}テストは通っても、LookML validation error が発生するかもしれません。その時は fields パラメータを使って、露出する field を限定すると良いでしょう。# Define for testexplore: child {  hidden: yes  required_access_grants: [can_view_explores_for_tests]  fields: [child.id, child.count] # Avoid LookML validation error}このテクニックは Error: Unknown or Inaccessible Field – Looker Help Center でも紹介されています。まとめと所感LookML 開発者で、且つテストを書いていて、且つ Join 先の view の primary_key に課題を抱えている、大変ニッチな層向けに記事を書きました。どこかの誰かに参考になれば幸いです。もっと良い方法や、今回のやり方はここがマズイとかあれば @masutaka にお知らせ頂けると大変うれしいです。🙏Feedmatic では今回のような view は数十もあり、primary_key のテストはまだ書き始めたばかりです。Looker ではテストは直列でしか実行されないようで、書けば書くほど全テストが遅くなるのはモヤモヤしています。さすがに要望しようと思ってますが。それに関連して、最近ディレクトリやファイル構成を再検討しました。次回はその記事を書く予定です。おまけ今回の記事を書く過程で、中の人が書いたベストプラクティスを見つけました。今回の記事ほど細かいテクニックは書かれていませんが、全体を網羅した良記事なので要チェックです。","link":"https://developer.feedforce.jp/entry/2021/08/30/150000","isoDate":"2021-08-30T06:00:00.000Z","dateMiliSeconds":1630303200000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"私が１年かけて辿り着いた Looker の情報収集方法を紹介する","content":"\u003cp\u003eこんばんは、\u003cdel\u003e徳川家ｙ\u003c/del\u003e \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e以前紹介したように、去年から \u003ca href=\"https://ja.looker.com/\"\u003eLooker\u003c/a\u003e を使ったウェブ広告数値の可視化や BI \u003ca href=\"#f-25b67c2a\" name=\"fn-25b67c2a\" title=\"Business Intelligence\"\u003e*1\u003c/a\u003e に取り組んでいます。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2020%2F10%2F23%2F190000\" title=\"『4月から取り組んできたLookerの導入から実装までのお話（Redashとも比較）』という発表をした - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003eLookML 開発者として LookML を書き始めて困ったのが、Looker の情報が少ないように見えたことです。\u003c/p\u003e\n\n\u003cp\u003eLookML を含む Looker のドキュメントは充実しているのですが、それらを組み合わせた応用的なフロー情報が少なく感じました。ビジネスユーザー向けの情報も同様です。\u003c/p\u003e\n\n\u003cp\u003e現在は網羅的、かつ集約した情報を取得できているので、その方法をご紹介します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#情報源をリストアップする\"\u003e「情報源」をリストアップする\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#少し脱線\"\u003e少し脱線...\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#情報源の取得方法への課題\"\u003e「情報源」の取得方法への課題\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#今はどうなったか\"\u003e今はどうなったか？\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Looker-Communityのフィードが存在した件\"\u003e「Looker Community」のフィードが存在した件\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Looker-の記事一覧--DevelopersIOのフィードを作った件\"\u003e「Looker の記事一覧 | DevelopersIO」のフィードを作った件\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#追記\"\u003e追記\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"情報源をリストアップする\"\u003e「情報源」をリストアップする\u003c/h2\u003e\n\n\u003cp\u003e初めはこれらをたまに見に行ったり、Slack の \u003ccode\u003e/feed subscribe\u003c/code\u003e \u003ca href=\"#f-e46aea89\" name=\"fn-e46aea89\" title=\"Slack に RSS フィードを追加する | Slack\"\u003e*2\u003c/a\u003e で購読したりしてました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://community.looker.com/\"\u003eLooker Community\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e公式フォーラム。英語で Question や Conversation が出来る\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"https://community.looker.com/%E3%82%B3%E3%83%9F%E3%83%A5%E3%83%8B%E3%83%86%E3%82%A3%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A9%E3%83%A0-japanese-161\"\u003eLooker 日本語コミュニティフォーラム\u003c/a\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e「Looker Community」の日本語版。\u003ca href=\"https://docs.looker.com/relnotes/intro\"\u003eRelease Notes\u003c/a\u003e の日本語訳には本当に感謝 🙏\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e「ニュースと告知」「ヘルプとサポート」「コラム」はそれぞれ Subscribe 出来る。メールで通知される\u003c/p\u003e\n\n\u003cp\u003e  \u003cfigure class=\"figure-image figure-image-fotolife\" title=\"Looker 日本語コミュニティフォーラム\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20210815/20210815145002.png\" alt=\"f:id:masutaka26:20210815145002p:plain\" width=\"1200\" height=\"382\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eLooker 日本語コミュニティフォーラム\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ca href=\"https://www.facebook.com/groups/721814241538725\"\u003eLooker APAC Forum | Facebook\u003c/a\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eリリース案内や事例紹介など\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://dev.classmethod.jp/tags/looker/\"\u003eLooker の記事一覧 | DevelopersIO\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eご存知クラスメソッドさんのブログ。国内最多の記事量と投稿頻度\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zenn.dev/topics/looker\"\u003eLookerの記事一覧 | Zenn\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eZenn にもそれなりの頻度で投稿される\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/tags/looker\"\u003eLooker - Qiita\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003eQiita はもう少し頻度は落ちるかな\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/search?q=%23looker%20lang%3Aja\u0026amp;f=live\u0026amp;vertical=default\"\u003e#looker lang:ja - Twitter 検索\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e以上の情報をふわっと取得できる。\u003ccode\u003elooker lang:ja\u003c/code\u003e や \u003ccode\u003e#looker\u003c/code\u003e だとノイズが多いのでこれに落ち着いた\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch2 id=\"少し脱線\"\u003e少し脱線...\u003c/h2\u003e\n\n\u003cp\u003eLooker Community には過去一度だけ質問しました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://community.looker.com/lookml-5/how-do-i-dynamically-switch-view-name-in-sql-parameter-of-dimension-27831\"\u003eHow do I dynamically switch view name in sql parameter of dimension? | Looker Community\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e私は日本語サポートに頼ることが多い傾向です。最近はだいぶ減らせています。\u003c/p\u003e\n\n\u003cp\u003e扱う情報を外に出せないので、外に出せるところまで昇華するのは難しいですね。🌀\u003c/p\u003e\n\n\u003cp\u003eLooker の水野さんが日本語訳して下さっている、Looker のリリースノート \u003ca href=\"#f-c898f381\" name=\"fn-c898f381\" title=\"例: Looker 21.12 リリースノート | Looker Community\"\u003e*3\u003c/a\u003e は、去年の 12 月から社内向けにこんな記事を書いて、Looker に徹底的に向き合うようにしています。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"Looker 21.12 のリリースノートを眺めてみた\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20210815/20210815160438.png\" alt=\"f:id:masutaka26:20210815160438p:plain\" width=\"1200\" height=\"849\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eLooker 21.12 のリリースノートを眺めてみた\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003e今まで書いた記事です。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"Looker のリリースノートを眺めてみたシリーズ\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20210815/20210815160356.png\" alt=\"f:id:masutaka26:20210815160356p:plain\" width=\"1200\" height=\"887\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eLooker のリリースノートを眺めてみたシリーズ\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003ch2 id=\"情報源の取得方法への課題\"\u003e「情報源」の取得方法への課題\u003c/h2\u003e\n\n\u003cp\u003eRSS/Atom（フィード）を配信していないサイトがほとんどで、見に行くのがかなり面倒でした。\u003c/p\u003e\n\n\u003cp\u003eそのものズバリなフィードは Zenn と Qiita だけです。クラスメソッドさんは Looker タグのフィードが存在せず、当時は Twitter で捕捉してました。\u003c/p\u003e\n\n\u003ch2 id=\"今はどうなったか\"\u003e今はどうなったか？\u003c/h2\u003e\n\n\u003cp\u003eほぼすべてを社内の Slack channel \u003ccode\u003e#news-looker\u003c/code\u003e に集約させることが出来ました。\u003c/p\u003e\n\n\u003cp\u003e以下が実際に購読しているフィードです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://community.looker.com/feed/buzzcapture\"\u003ehttps://community.looker.com/feed/buzzcapture\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e「Looker Community」のフィード。後述する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://feed43.com/developersio-looker.xml\"\u003ehttps://feed43.com/developersio-looker.xml\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e「Looker の記事一覧 | DevelopersIO」のフィード。後述する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zenn.dev/topics/looker/feed\"\u003ehttps://zenn.dev/topics/looker/feed\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e「Lookerの記事一覧 | Zenn」のフィード\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/tags/looker/feed\"\u003ehttps://qiita.com/tags/looker/feed\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e「Looker - Qiita」のフィード\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eTwitter は \u003ca href=\"https://ifttt.com/\"\u003eIFTTT\u003c/a\u003e を使って、同 channel に POST しています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eIf\u003c/code\u003e New tweet from search \u003ccode\u003e#looker OR LookML lang:ja -rt\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eThen\u003c/code\u003e Post to channel\n\n\u003cul\u003e\n\u003cli\u003eChannel: \u003ccode\u003e#news-looker\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eMessage: \u003ccode\u003e@{{UserName}} : {{Text}} (via Twitter {{LinkToTweet}})\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e「Looker APAC Forum | Facebook」は集約できませんでしたが、Twitter にも流れることがあるので、一旦考えないことにしました。\u003c/p\u003e\n\n\u003ch2 id=\"Looker-Communityのフィードが存在した件\"\u003e「Looker Community」のフィードが存在した件\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://community.looker.com/%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%B9%E3%81%A8%E5%91%8A%E7%9F%A5-100/%E3%82%AB%E3%83%86%E3%82%B4%E3%83%AA-the-kitchen-table-%E3%81%8C%E5%85%AC%E9%96%8B%E3%81%95%E3%82%8C%E3%81%BE%E3%81%97%E3%81%9F-24032?postid=45126#post45126\"\u003eLooker の水野さんに聞いたら、調べて教えて下さいました。\u003c/a\u003e🙏\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e(1) 新しいトピックの投稿\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://community.looker.com/feed/topics\"\u003ehttps://community.looker.com/feed/topics\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e(2) 全ての新しい投稿（最初の投稿（タイトル＋ボディ）+ 全てのリプライ）\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://community.looker.com/feed/buzzcapture\"\u003ehttps://community.looker.com/feed/buzzcapture\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eアナウンス記事です。\n\u003ca href=\"https://community.looker.com/%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%B9%E3%81%A8%E5%91%8A%E7%9F%A5-100/looker%E3%82%B3%E3%83%9F%E3%83%A5%E3%83%8B%E3%83%86%E3%82%A3%E3%81%AErss%E3%83%95%E3%82%A3%E3%83%BC%E3%83%89-25553?postid=46404#post46404\"\u003eLookerコミュニティのRSSフィード | Looker Community\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e(1) と (2) は両方とも「Looker 日本語コミュニティフォーラム」の情報も流れてきます。\u003c/p\u003e\n\n\u003cp\u003e今は (2) を購読しており、トラフィックはそれなりにあります。もちろんほぼ全て英語です。辛かったら (1) にすると良いと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://community.looker.com/\"\u003ehttps://community.looker.com/\u003c/a\u003e の HTML には RSS/Atom 情報がないので、これらのフィードに気づける人は少ないと思います。Looker さんには是非お願いしたいところです。\u003c/p\u003e\n\n\u003ch2 id=\"Looker-の記事一覧--DevelopersIOのフィードを作った件\"\u003e「Looker の記事一覧 | DevelopersIO」のフィードを作った件\u003c/h2\u003e\n\n\u003cp\u003eないものは仕方がないので、\u003ca href=\"https://feed43.com/\"\u003eFeed43\u003c/a\u003e というサービスで作りました。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fmasutaka.net%2Fchalow%2F2021-03-14-1.html\" title=\"フィード（RSS/Atom）を配信していないサイトのフィードを Feed43 で作成する\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003e出来たのが \u003ca href=\"https://feed43.com/developersio-looker.xml\"\u003ehttps://feed43.com/developersio-looker.xml\u003c/a\u003e です。どなたでも購読可能です。よろしければどうぞ。\u003c/p\u003e\n\n\u003cp\u003eHTML をパースしているだけなので、HTML 構造が変わったら壊れることはあると思います。気づけたら直します。\u003c/p\u003e\n\n\u003cp\u003e本当は \u003ca href=\"https://dev.classmethod.jp/tags/looker/\"\u003ehttps://dev.classmethod.jp/tags/looker/\u003c/a\u003e のフィードがあれば良いのですけどね。今後に期待です。\u003c/p\u003e\n\n\u003cp\u003e[Update] そのものズバリ \u003ca href=\"https://dev.classmethod.jp/feed/?tag=looker\"\u003ehttps://dev.classmethod.jp/feed/?tag=looker\u003c/a\u003e を \u003ca href=\"https://twitter.com/sh19910711/status/1427429573117964306\"\u003eTwitterで教えて\u003c/a\u003e頂きました。ありがとうございます！\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003e私が１年かけて辿り着いた、Looker の情報取得方法をご紹介しました。\u003c/p\u003e\n\n\u003cp\u003eこれで Looker の情報は大量にインプット出来たので、今後はコミュニティにアウトプットしていきます。🔥\n※ ネタは少しあるけど、時間がない。(^^;\u003c/p\u003e\n\n\u003cp\u003e皆さんにも参考になれば幸いです。他にもあれば \u003ca href=\"https://twitter.com/masutaka\"\u003e@masutaka\u003c/a\u003e に教えて下さい！\u003c/p\u003e\n\n\u003ch2 id=\"追記\"\u003e追記\u003c/h2\u003e\n\n\u003cblockquote\u003e\u003cp\u003e他にもあれば \u003ca href=\"https://twitter.com/masutaka\"\u003e@masutaka\u003c/a\u003e に教えて下さい！\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003e記事にも登場して頂いた Looker の水野さん \u003ca href=\"https://twitter.com/tomoya_cs\"\u003e@tomoya_cs\u003c/a\u003e をフォローするとさらに捗ると思います。\u003c/p\u003e\n\n\u003cp\u003e\u003cblockquote data-conversation=\"none\" class=\"twitter-tweet\" data-lang=\"ja\"\u003e\u003cp lang=\"ja\" dir=\"ltr\"\u003eLookerの情報収集本当に至難と思いますが、まとめていただきありがとうございます😭\u003cbr\u003eあとは私をフォローいただけると最新情報が入手しやすくなるかと（アウトプットがんばります🙇‍♂️） \u003ca href=\"https://t.co/eDQz8A5VCC\"\u003ehttps://t.co/eDQz8A5VCC\u003c/a\u003e\u003c/p\u003e\u0026mdash; tomoya | Looker CS (@tomoya_cs) \u003ca href=\"https://twitter.com/tomoya_cs/status/1428194155943972872?ref_src=twsrc%5Etfw\"\u003e2021年8月19日\u003c/a\u003e\u003c/blockquote\u003e \u003cscript async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"\u003e\u003c/script\u003e \u003c/p\u003e\n\u003cdiv class=\"footnote\"\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-25b67c2a\" name=\"f-25b67c2a\" class=\"footnote-number\"\u003e*1\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%93%E3%82%B8%E3%83%8D%E3%82%B9%E3%82%A4%E3%83%B3%E3%83%86%E3%83%AA%E3%82%B8%E3%82%A7%E3%83%B3%E3%82%B9\"\u003eBusiness Intelligence\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-e46aea89\" name=\"f-e46aea89\" class=\"footnote-number\"\u003e*2\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://slack.com/intl/ja-jp/help/articles/218688467-Slack-%E3%81%AB-RSS-%E3%83%95%E3%82%A3%E3%83%BC%E3%83%89%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B\"\u003eSlack に RSS フィードを追加する | Slack\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-c898f381\" name=\"f-c898f381\" class=\"footnote-number\"\u003e*3\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e例: \u003ca href=\"https://community.looker.com/%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%B9%E3%81%A8%E5%91%8A%E7%9F%A5-100/looker-21-12-%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%8E%E3%83%BC%E3%83%88-27799\"\u003eLooker 21.12 リリースノート | Looker Community\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003c/div\u003e","contentSnippet":"こんばんは、徳川家ｙ id:masutaka26 です。以前紹介したように、去年から Looker を使ったウェブ広告数値の可視化や BI *1 に取り組んでいます。LookML 開発者として LookML を書き始めて困ったのが、Looker の情報が少ないように見えたことです。LookML を含む Looker のドキュメントは充実しているのですが、それらを組み合わせた応用的なフロー情報が少なく感じました。ビジネスユーザー向けの情報も同様です。現在は網羅的、かつ集約した情報を取得できているので、その方法をご紹介します。「情報源」をリストアップする少し脱線...「情報源」の取得方法への課題今はどうなったか？「Looker Community」のフィードが存在した件「Looker の記事一覧 | DevelopersIO」のフィードを作った件まとめ追記「情報源」をリストアップする初めはこれらをたまに見に行ったり、Slack の /feed subscribe *2 で購読したりしてました。Looker Community公式フォーラム。英語で Question や Conversation が出来るLooker 日本語コミュニティフォーラム「Looker Community」の日本語版。Release Notes の日本語訳には本当に感謝 🙏「ニュースと告知」「ヘルプとサポート」「コラム」はそれぞれ Subscribe 出来る。メールで通知される  Looker 日本語コミュニティフォーラムLooker APAC Forum | Facebookリリース案内や事例紹介などLooker の記事一覧 | DevelopersIOご存知クラスメソッドさんのブログ。国内最多の記事量と投稿頻度Lookerの記事一覧 | ZennZenn にもそれなりの頻度で投稿されるLooker - QiitaQiita はもう少し頻度は落ちるかな#looker lang:ja - Twitter 検索以上の情報をふわっと取得できる。looker lang:ja や #looker だとノイズが多いのでこれに落ち着いた少し脱線...Looker Community には過去一度だけ質問しました。How do I dynamically switch view name in sql parameter of dimension? | Looker Community私は日本語サポートに頼ることが多い傾向です。最近はだいぶ減らせています。扱う情報を外に出せないので、外に出せるところまで昇華するのは難しいですね。🌀Looker の水野さんが日本語訳して下さっている、Looker のリリースノート *3 は、去年の 12 月から社内向けにこんな記事を書いて、Looker に徹底的に向き合うようにしています。Looker 21.12 のリリースノートを眺めてみた今まで書いた記事です。Looker のリリースノートを眺めてみたシリーズ「情報源」の取得方法への課題RSS/Atom（フィード）を配信していないサイトがほとんどで、見に行くのがかなり面倒でした。そのものズバリなフィードは Zenn と Qiita だけです。クラスメソッドさんは Looker タグのフィードが存在せず、当時は Twitter で捕捉してました。今はどうなったか？ほぼすべてを社内の Slack channel #news-looker に集約させることが出来ました。以下が実際に購読しているフィードです。https://community.looker.com/feed/buzzcapture「Looker Community」のフィード。後述するhttps://feed43.com/developersio-looker.xml「Looker の記事一覧 | DevelopersIO」のフィード。後述するhttps://zenn.dev/topics/looker/feed「Lookerの記事一覧 | Zenn」のフィードhttps://qiita.com/tags/looker/feed「Looker - Qiita」のフィードTwitter は IFTTT を使って、同 channel に POST しています。If New tweet from search #looker OR LookML lang:ja -rtThen Post to channelChannel: #news-lookerMessage: @{{UserName}} : {{Text}} (via Twitter {{LinkToTweet}})「Looker APAC Forum | Facebook」は集約できませんでしたが、Twitter にも流れることがあるので、一旦考えないことにしました。「Looker Community」のフィードが存在した件Looker の水野さんに聞いたら、調べて教えて下さいました。🙏(1) 新しいトピックの投稿https://community.looker.com/feed/topics(2) 全ての新しい投稿（最初の投稿（タイトル＋ボディ）+ 全てのリプライ）https://community.looker.com/feed/buzzcaptureアナウンス記事です。LookerコミュニティのRSSフィード | Looker Community(1) と (2) は両方とも「Looker 日本語コミュニティフォーラム」の情報も流れてきます。今は (2) を購読しており、トラフィックはそれなりにあります。もちろんほぼ全て英語です。辛かったら (1) にすると良いと思います。https://community.looker.com/ の HTML には RSS/Atom 情報がないので、これらのフィードに気づける人は少ないと思います。Looker さんには是非お願いしたいところです。「Looker の記事一覧 | DevelopersIO」のフィードを作った件ないものは仕方がないので、Feed43 というサービスで作りました。出来たのが https://feed43.com/developersio-looker.xml です。どなたでも購読可能です。よろしければどうぞ。HTML をパースしているだけなので、HTML 構造が変わったら壊れることはあると思います。気づけたら直します。本当は https://dev.classmethod.jp/tags/looker/ のフィードがあれば良いのですけどね。今後に期待です。[Update] そのものズバリ https://dev.classmethod.jp/feed/?tag=looker を Twitterで教えて頂きました。ありがとうございます！まとめ私が１年かけて辿り着いた、Looker の情報取得方法をご紹介しました。これで Looker の情報は大量にインプット出来たので、今後はコミュニティにアウトプットしていきます。🔥※ ネタは少しあるけど、時間がない。(^^;皆さんにも参考になれば幸いです。他にもあれば @masutaka に教えて下さい！追記他にもあれば @masutaka に教えて下さい！記事にも登場して頂いた Looker の水野さん @tomoya_cs をフォローするとさらに捗ると思います。Lookerの情報収集本当に至難と思いますが、まとめていただきありがとうございます😭あとは私をフォローいただけると最新情報が入手しやすくなるかと（アウトプットがんばります🙇‍♂️） https://t.co/eDQz8A5VCC— tomoya | Looker CS (@tomoya_cs) 2021年8月19日  *1:Business Intelligence*2:Slack に RSS フィードを追加する | Slack*3:例: Looker 21.12 リリースノート | Looker Community","link":"https://developer.feedforce.jp/entry/2021/08/16/150000","isoDate":"2021-08-16T06:00:00.000Z","dateMiliSeconds":1629093600000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/masutaka26/20201023/20201023184859.png","authorName":"feedforce"},{"title":"Firestore エミュレーターを使ったテスト同士の競合が起きないようにしていい感じにテストできるようにした話","content":"\u003cp\u003eこんにちは、エンジニアの \u003ca href=\"http://blog.hatena.ne.jp/len_prog/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/len_prog/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:len_prog\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e私が所属している \u003ca href=\"https://ecbooster.jp/\"\u003eEC Booster\u003c/a\u003e チームでは、「\u003ca href=\"https://support.ecbooster.jp/ja/articles/4854572-%E3%82%AB%E3%82%A4%E3%82%BC%E3%83%B3%E3%82%AB%E3%83%BC%E3%83%89%E3%81%AE%E6%A6%82%E8%A6%81%E3%81%A8%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eカイゼンカード\u003c/a\u003e」機能の開発に Firebase を採用しています。\u003cbr /\u003e\nその中でも特に Cloud Functions for Firebase と Cloud Firestore をメインで使用しており、これらの採用により短い開発期間で機能をリリースすることができました 🎉\u003c/p\u003e\n\n\u003cp\u003eしかし、Firebase を採用したことで苦労したことが全く無かったわけではありません。\u003cbr /\u003e\n特に、テスト周りはインターネット上にもあまり情報が多くない状況で、色々ハマりながら開発をしてきました。\u003c/p\u003e\n\n\u003cp\u003eそこで、今回の記事では、いくつかあったハマりごとの中でも特に厄介だったものについて対策を書いていきます。\u003c/p\u003e\n\n\u003ch1\u003eFirestore Emulator のプロジェクト共有時のデータ競合\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://firebase.google.com/docs/emulator-suite?hl=ja\"\u003eFirebase Local Emulator Suite\u003c/a\u003e を使って Firestore に接続するテストを書いていた際に、\u003cbr /\u003e\nテストを単体で実行した場合には通るのに、他のテストと並列に実行した場合のみドキュメントの状態が予期せぬものになりテストが落ちてしまうことに悩まされました。\u003c/p\u003e\n\n\u003cp\u003e調査の結果、これは、接続先プロジェクトがすべてのテストで同じになってしまっているのが原因ということが分かりました。\u003c/p\u003e\n\n\u003cp\u003eこの状態で同じドキュメントを書き換えるテストが並列で走ってしまった場合、実行タイミングによってはドキュメントが予期せぬ状態になってしまいます。\u003cbr /\u003e\nまた、テスト結果が不安定だとテストが信用できず、実装を保証するものになりません。\u003c/p\u003e\n\n\u003cp\u003eこのままでは役に立つテストが書けないと思い試行錯誤した結果、\u003cstrong\u003eテストごとに違うプロジェクトの Firestore に接続する\u003c/strong\u003eことでそれぞれのテストが独立した状態で実行でき、結果としてデータ競合が防げることが分かりました。\u003c/p\u003e\n\n\u003cp\u003e以下、サンプルアプリケーションを用いてこの方法について書いていきます。\u003c/p\u003e\n\n\u003ch1\u003eサンプルアプリケーションの概要\u003c/h1\u003e\n\n\u003cp\u003e今回は、サンプルとして簡易的な RPG を開発することを想定します。\u003cbr /\u003e\nゲームに登場するキャラクターは、以下のような構造のドキュメントを持つ \u003ccode\u003echaracters\u003c/code\u003e コレクションで管理されています。\u003c/p\u003e\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  name: \u003cspan class=\"synType\"\u003estring\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n  level: \u003cspan class=\"synType\"\u003enumber\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n  job: \u003cspan class=\"synType\"\u003estring\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eまた、このゲームでは以下の行動のみが可能と仮定します(これだけじゃゲームとして成り立たないと思いますが、簡単のためということでお許しください)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eキャラクターは、レベルアップすることができる\u003c/li\u003e\n\u003cli\u003eキャラクターは、転職することができる\n\n\u003cul\u003e\n\u003cli\u003e転職すると、キャラクターのレベルが1に戻る\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eなお、アプリケーション上においてキャラクターのレベルアップは、\u003ccode\u003echaracterLevelUpUseCase\u003c/code\u003e、キャラクターの転職は \u003ccode\u003echaracterJobChangeUseCase\u003c/code\u003e という関数を呼ぶことで行えることとします。\u003c/p\u003e\n\n\u003cp\u003eここからは、実際にこれら2つの関数のテストコードが競合する様子を見ていきます。\u003c/p\u003e\n\n\u003ch1\u003eデータ競合発生時の構成\u003c/h1\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/l/len_prog/20210624/20210624165133.png\" alt=\"f:id:len_prog:20210624165133p:plain:w500\" width=\"1200\" height=\"790\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" style=\"width:500px\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003echaracterJobChangeUseCase\u003c/code\u003e と \u003ccode\u003echaracterLevelUpUseCase\u003c/code\u003e が \u003ccode\u003emy-game\u003c/code\u003e プロジェクトの Firestore を共有してしまっています。\u003cbr /\u003e\nこの状態で両方の関数から同じドキュメントを書き換えてしまった場合、データ競合が発生する可能性があります。\u003cbr /\u003e\nこの場合、実際のコードは以下のようになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterJobChangeUseCase.spec.ts\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e * \u003cspan class=\"synStatement\"\u003eas\u003c/span\u003e admin \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;firebase-admin\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e characterJobChangeUseCase \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;@/usecases/characterJobChangeUseCase\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;my-game\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// ここが問題\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e charactersCollection \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e admin\n  .firestore\u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e\n  .collection\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;characters\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\ndescribe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003echaracterJobChangeUseCase\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e targetCharacterId \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;target-character-id\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\n  beforeEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.set\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n        name: \u003cspan class=\"synConstant\"\u003e\u0026quot;アルス\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        level: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        job: \u003cspan class=\"synConstant\"\u003e\u0026quot;すっぴん\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  afterEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.\u003cspan class=\"synStatement\"\u003edelete();\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  it\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;キャラクターが転職した場合、レベルが1に戻ること\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003easync\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e characterJobChangeUseCase\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1に戻る\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e jobChangedCharacter \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e(await\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.get\u003cspan class=\"synStatement\"\u003e())\u003c/span\u003e.data\u003cspan class=\"synStatement\"\u003e();\u003c/span\u003e\n\n    expect\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003ejobChangedCharacter.level\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.toBe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 実行タイミング次第では、1になるはずが11になってしまう！\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterLevelUpUseCase.spec.ts\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e * \u003cspan class=\"synStatement\"\u003eas\u003c/span\u003e admin \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;firebase-admin\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e characterLevelUpUseCase \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;@/usecases/characterLevelUpUseCase\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;my-game\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// ここが問題\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e charactersCollection \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e admin\n  .firestore\u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e\n  .collection\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;characters\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\ndescribe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003echaracterLevelUpUseCase\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e targetCharacterId \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;target-character-id\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\n  beforeEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.set\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n        name: \u003cspan class=\"synConstant\"\u003e\u0026quot;アルス\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        level: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        job: \u003cspan class=\"synConstant\"\u003e\u0026quot;すっぴん\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  afterEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.\u003cspan class=\"synStatement\"\u003edelete();\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  it\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;キャラクターがレベルアップした場合、レベルが1上がること\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003easync\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e characterLevelUpUseCase\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1上がる\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e grownCharacter \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e(await\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.get\u003cspan class=\"synStatement\"\u003e())\u003c/span\u003e.data\u003cspan class=\"synStatement\"\u003e();\u003c/span\u003e\n\n    expect\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003egrownCharacter.level\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.toBe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e11\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 実行タイミング次第では、11になるはずが1に戻ってしまう！\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e見ての通り、両方のテストが \u003ccode\u003emy-game\u003c/code\u003e プロジェクトの Firestore の、ID: \u003ccode\u003etarget-character-id\u003c/code\u003e のドキュメントを更新してしまっています。\u003cbr /\u003e\nこれらのテストコードを並列で実行した場合、\u003cstrong\u003eキャラクターが転職したのにレベルが1に戻らない\u003c/strong\u003e、\u003cstrong\u003eキャラクターがレベルアップしたはずなのになぜかレベル1に戻ってしまう\u003c/strong\u003eなど予期せぬ状態になってしまい、\nテストが落ちてしまう可能性があります。\u003c/p\u003e\n\n\u003cp\u003eこの状態ではテストコードが信用できないので、テストごとに向き先プロジェクトを変えてこの問題を解決していきます。\u003c/p\u003e\n\n\u003ch1\u003eデータ競合解決後の構成\u003c/h1\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/l/len_prog/20210705/20210705113933.png\" alt=\"f:id:len_prog:20210705113933p:plain:w500\" width=\"1200\" height=\"779\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" style=\"width:500px\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e上図②③のようにテストごとに接続先プロジェクトを独立させることで、他のテストとの並列実行が原因のデータ競合を防ぐことができます。\u003cbr /\u003e\n具体的には、以下のように \u003ccode\u003eadmin.initializeApp()\u003c/code\u003eの第一引数に他のテストと重複しないプロジェクトID を渡すようにします。\u003c/p\u003e\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterJobChangeUseCase.spec.ts\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;character-job-change-use-case-spec\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e//  図の②に対応\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterLevelUpUseCase.spec.ts\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;character-level-up-use-case-spec\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 図の③に対応\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e変更後のコードの全体像は以下のようになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterJobChangeUseCase.spec.ts\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e * \u003cspan class=\"synStatement\"\u003eas\u003c/span\u003e admin \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;firebase-admin\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e characterJobChangeUseCase \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;@/usecases/characterJobChangeUseCase\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;character-job-change-use-case-spec\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e//  図の②に対応\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e// ここから下は構成変更前のコードと同じ\u003c/span\u003e\n\n\u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e charactersCollection \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e admin\n  .firestore\u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e\n  .collection\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;characters\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\ndescribe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003echaracterJobChangeUseCase\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e targetCharacterId \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;target-character-id\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\n  beforeEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.set\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n        name: \u003cspan class=\"synConstant\"\u003e\u0026quot;アルス\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        level: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        job: \u003cspan class=\"synConstant\"\u003e\u0026quot;すっぴん\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  afterEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.\u003cspan class=\"synStatement\"\u003edelete();\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  it\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;キャラクターが転職した場合、レベルが1に戻ること\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003easync\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e characterJobChangeUseCase\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1に戻る\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e jobChangedCharacter \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e(await\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.get\u003cspan class=\"synStatement\"\u003e())\u003c/span\u003e.data\u003cspan class=\"synStatement\"\u003e();\u003c/span\u003e\n\n    expect\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003ejobChangedCharacter.level\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.toBe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 転職するとレベルが1に戻ることを検証できるようになった\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterLevelUpUseCase.spec.ts\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e * \u003cspan class=\"synStatement\"\u003eas\u003c/span\u003e admin \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;firebase-admin\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e characterLevelUpUseCase \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;@/usecases/characterLevelUpUseCase\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;character-level-up-use-case-spec\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 図の③に対応\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e// ここから下は構成変更前のコードと同じ\u003c/span\u003e\n\n\u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e charactersCollection \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e admin\n  .firestore\u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e\n  .collection\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;characters\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\ndescribe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003echaracterLevelUpUseCase\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e targetCharacterId \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;target-character-id\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\n  beforeEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.set\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n        name: \u003cspan class=\"synConstant\"\u003e\u0026quot;アルス\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        level: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        job: \u003cspan class=\"synConstant\"\u003e\u0026quot;すっぴん\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  afterEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.\u003cspan class=\"synStatement\"\u003edelete();\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  it\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;キャラクターがレベルアップした場合、レベルが1上がること\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003easync\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e characterLevelUpUseCase\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1上がる\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e grownCharacter \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e(await\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.get\u003cspan class=\"synStatement\"\u003e())\u003c/span\u003e.data\u003cspan class=\"synStatement\"\u003e();\u003c/span\u003e\n\n    expect\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003egrownCharacter.level\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.toBe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e11\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// レベルアップした場合にレベルが1上がることを検証できるようになった\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eこのようにテストごとに向き先プロジェクトを変えることで、それぞれのテストで担保したいことをちゃんと担保できるようになります。\u003c/p\u003e\n\n\u003ch1\u003eちょっと微妙な点\u003c/h1\u003e\n\n\u003cp\u003e上記の方法でテストごとに独立した環境の Firestore を操作できるようになり、データ競合を防げるようになりました。\u003c/p\u003e\n\n\u003cp\u003eしかし、この方法にはひとつだけ微妙な点があります。\u003cbr /\u003e\n問題の説明のために、先程掲載した\u003ccode\u003e競合解決後の構成図\u003c/code\u003eを再掲します。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/l/len_prog/20210705/20210705113933.png\" alt=\"f:id:len_prog:20210705113933p:plain:w500\" width=\"1200\" height=\"779\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" style=\"width:500px\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e上図①の接続先は、\u003ccode\u003e$ firebase use\u003c/code\u003e で指定したプロジェクトか、\u003ccode\u003e$ firebase emulators:start\u003c/code\u003e に \u003ccode\u003e--project\u003c/code\u003eを渡した場合にはそのプロジェクトになり、そのほかの方法で変えることは今のところできないようです。\u003c/p\u003e\n\n\u003cp\u003eそのため、プロジェクトをテストごとに分けた場合、上図②③のテスト中にテスト自体は動くものの、Firebase Emulator の UI からデータの内容を見ることはできなくなります。\u003c/p\u003e\n\n\u003cp\u003e一応、接続先を \u003ccode\u003e$ firebase use\u003c/code\u003e で指定しているものに切り替えるようコードを書き換えたりすればデバッグはできますが、\nいちいち書き換えの手間が生じるので若干面倒です。\u003c/p\u003e\n\n\u003cp\u003eまた、これは Firebase Enulator の UI で立ち上がっているすべてのプロジェクトの Firestore を見られるようになれば解決する問題ではあり、実際に \u003ca href=\"https://github.com/firebase/firebase-tools-ui\"\u003efirebase/firebase-tools-ui\u003c/a\u003e リポジトリに \u003ca href=\"https://github.com/firebase/firebase-tools-ui/issues/281\"\u003eissue\u003c/a\u003e も立っていますが、すぐに対応が終わりそうには見えない状況なので、しばらくは不便な状況が続くことが予想されます。\u003c/p\u003e\n\n\u003ch1\u003e所感\u003c/h1\u003e\n\n\u003cp\u003eFirebase は便利ですが、当然ながら全くハマらずに開発できる銀の弾丸ではないですね。\u003cbr /\u003e\nしかし、基本的には便利でドキュメントもそれなりに読みやすく、個人的には使っていて満足感があります。\u003c/p\u003e\n\n\u003cp\u003e今後も日々の開発で得た Firebase や GCP 周りの TIPS を書いていけたらと思っておりますので、よろしくお願いいたします 🙏\u003c/p\u003e\n","contentSnippet":"こんにちは、エンジニアの id:len_prog です。私が所属している EC Booster チームでは、「カイゼンカード」機能の開発に Firebase を採用しています。しかし、Firebase を採用したことで苦労したことが全く無かったわけではありません。そこで、今回の記事では、いくつかあったハマりごとの中でも特に厄介だったものについて対策を書いていきます。Firestore Emulator のプロジェクト共有時のデータ競合Firebase Local Emulator Suite を使って Firestore に接続するテストを書いていた際に、調査の結果、これは、接続先プロジェクトがすべてのテストで同じになってしまっているのが原因ということが分かりました。この状態で同じドキュメントを書き換えるテストが並列で走ってしまった場合、実行タイミングによってはドキュメントが予期せぬ状態になってしまいます。このままでは役に立つテストが書けないと思い試行錯誤した結果、テストごとに違うプロジェクトの Firestore に接続することでそれぞれのテストが独立した状態で実行でき、結果としてデータ競合が防げることが分かりました。以下、サンプルアプリケーションを用いてこの方法について書いていきます。サンプルアプリケーションの概要今回は、サンプルとして簡易的な RPG を開発することを想定します。characters コレクションで管理されています。{  name: string;  level: number;  job: string;}また、このゲームでは以下の行動のみが可能と仮定します(これだけじゃゲームとして成り立たないと思いますが、簡単のためということでお許しください)キャラクターは、レベルアップすることができるキャラクターは、転職することができる転職すると、キャラクターのレベルが1に戻るなお、アプリケーション上においてキャラクターのレベルアップは、characterLevelUpUseCase、キャラクターの転職は characterJobChangeUseCase という関数を呼ぶことで行えることとします。ここからは、実際にこれら2つの関数のテストコードが競合する様子を見ていきます。データ競合発生時の構成characterJobChangeUseCase と characterLevelUpUseCase が my-game プロジェクトの Firestore を共有してしまっています。// functions/src/usecases/characterJobChangeUseCase.spec.tsimport * as admin from \"firebase-admin\";import { characterJobChangeUseCase } from \"@/usecases/characterJobChangeUseCase\";admin.initializeApp({  projectId: \"my-game\", // ここが問題});const charactersCollection = admin  .firestore()  .collection(\"characters\");describe(characterJobChangeUseCase, () =\u003e {  const targetCharacterId = \"target-character-id\";  beforeEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).set({        name: \"アルス\",        level: 10,        job: \"すっぴん\";    });  });  afterEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).delete();  });  it(\"キャラクターが転職した場合、レベルが1に戻ること\", async () =\u003e {    await characterJobChangeUseCase(targetCharacterId); // characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1に戻る    const jobChangedCharacter = (await charactersCollection.doc(targetCharacterId).get()).data();    expect(jobChangedCharacter.level).toBe(1); // 実行タイミング次第では、1になるはずが11になってしまう！  });});// functions/src/usecases/characterLevelUpUseCase.spec.tsimport * as admin from \"firebase-admin\";import { characterLevelUpUseCase } from \"@/usecases/characterLevelUpUseCase\";admin.initializeApp({  projectId: \"my-game\", // ここが問題});const charactersCollection = admin  .firestore()  .collection(\"characters\");describe(characterLevelUpUseCase, () =\u003e {  const targetCharacterId = \"target-character-id\";  beforeEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).set({        name: \"アルス\",        level: 10,        job: \"すっぴん\";    });  });  afterEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).delete();  });  it(\"キャラクターがレベルアップした場合、レベルが1上がること\", async () =\u003e {    await characterLevelUpUseCase(targetCharacterId); // characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1上がる    const grownCharacter = (await charactersCollection.doc(targetCharacterId).get()).data();    expect(grownCharacter.level).toBe(11); // 実行タイミング次第では、11になるはずが1に戻ってしまう！  });});見ての通り、両方のテストが my-game プロジェクトの Firestore の、ID: target-character-id のドキュメントを更新してしまっています。キャラクターが転職したのにレベルが1に戻らない、キャラクターがレベルアップしたはずなのになぜかレベル1に戻ってしまうなど予期せぬ状態になってしまい、テストが落ちてしまう可能性があります。この状態ではテストコードが信用できないので、テストごとに向き先プロジェクトを変えてこの問題を解決していきます。データ競合解決後の構成上図②③のようにテストごとに接続先プロジェクトを独立させることで、他のテストとの並列実行が原因のデータ競合を防ぐことができます。admin.initializeApp()の第一引数に他のテストと重複しないプロジェクトID を渡すようにします。// functions/src/usecases/characterJobChangeUseCase.spec.tsadmin.initializeApp({  projectId: \"character-job-change-use-case-spec\", //  図の②に対応});// functions/src/usecases/characterLevelUpUseCase.spec.tsadmin.initializeApp({  projectId: \"character-level-up-use-case-spec\", // 図の③に対応});変更後のコードの全体像は以下のようになります。// functions/src/usecases/characterJobChangeUseCase.spec.tsimport * as admin from \"firebase-admin\";import { characterJobChangeUseCase } from \"@/usecases/characterJobChangeUseCase\";admin.initializeApp({  projectId: \"character-job-change-use-case-spec\", //  図の②に対応});// ここから下は構成変更前のコードと同じconst charactersCollection = admin  .firestore()  .collection(\"characters\");describe(characterJobChangeUseCase, () =\u003e {  const targetCharacterId = \"target-character-id\";  beforeEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).set({        name: \"アルス\",        level: 10,        job: \"すっぴん\";    });  });  afterEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).delete();  });  it(\"キャラクターが転職した場合、レベルが1に戻ること\", async () =\u003e {    await characterJobChangeUseCase(targetCharacterId); // characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1に戻る    const jobChangedCharacter = (await charactersCollection.doc(targetCharacterId).get()).data();    expect(jobChangedCharacter.level).toBe(1); // 転職するとレベルが1に戻ることを検証できるようになった  });});// functions/src/usecases/characterLevelUpUseCase.spec.tsimport * as admin from \"firebase-admin\";import { characterLevelUpUseCase } from \"@/usecases/characterLevelUpUseCase\";admin.initializeApp({  projectId: \"character-level-up-use-case-spec\", // 図の③に対応});// ここから下は構成変更前のコードと同じconst charactersCollection = admin  .firestore()  .collection(\"characters\");describe(characterLevelUpUseCase, () =\u003e {  const targetCharacterId = \"target-character-id\";  beforeEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).set({        name: \"アルス\",        level: 10,        job: \"すっぴん\";    });  });  afterEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).delete();  });  it(\"キャラクターがレベルアップした場合、レベルが1上がること\", async () =\u003e {    await characterLevelUpUseCase(targetCharacterId); // characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1上がる    const grownCharacter = (await charactersCollection.doc(targetCharacterId).get()).data();    expect(grownCharacter.level).toBe(11); // レベルアップした場合にレベルが1上がることを検証できるようになった  });});このようにテストごとに向き先プロジェクトを変えることで、それぞれのテストで担保したいことをちゃんと担保できるようになります。ちょっと微妙な点上記の方法でテストごとに独立した環境の Firestore を操作できるようになり、データ競合を防げるようになりました。しかし、この方法にはひとつだけ微妙な点があります。競合解決後の構成図を再掲します。上図①の接続先は、$ firebase use で指定したプロジェクトか、$ firebase emulators:start に --projectを渡した場合にはそのプロジェクトになり、そのほかの方法で変えることは今のところできないようです。そのため、プロジェクトをテストごとに分けた場合、上図②③のテスト中にテスト自体は動くものの、Firebase Emulator の UI からデータの内容を見ることはできなくなります。一応、接続先を $ firebase use で指定しているものに切り替えるようコードを書き換えたりすればデバッグはできますが、いちいち書き換えの手間が生じるので若干面倒です。また、これは Firebase Enulator の UI で立ち上がっているすべてのプロジェクトの Firestore を見られるようになれば解決する問題ではあり、実際に firebase/firebase-tools-ui リポジトリに issue も立っていますが、すぐに対応が終わりそうには見えない状況なので、しばらくは不便な状況が続くことが予想されます。所感Firebase は便利ですが、当然ながら全くハマらずに開発できる銀の弾丸ではないですね。今後も日々の開発で得た Firebase や GCP 周りの TIPS を書いていけたらと思っておりますので、よろしくお願いいたします 🙏","link":"https://developer.feedforce.jp/entry/2021/07/07/103917","isoDate":"2021-07-07T01:39:17.000Z","dateMiliSeconds":1625621957000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/l/len_prog/20210705/20210705113933.png","authorName":"feedforce"},{"title":"『ここがつらいよ普段使いのLinux』という発表をした","content":"\u003cp\u003eこんにちは \u003ca href=\"http://blog.hatena.ne.jp/masutaka26/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/masutaka26/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:masutaka26\u003c/a\u003e です。いよいよ明後日は \u003ca href=\"https://jp.rizinff.com/_ct/17440570\"\u003eRIZIN.28\u003c/a\u003e ですね！東京ドームで MMA（総合格闘技）のイベントが行われるのは、約 17 年半ぶりだそうです（Wikipedia 調べ）。ドキが胸胸します。\u003c/p\u003e\n\n\u003cp\u003e本日、週次の社内勉強会 \u003ca href=\"https://developer.feedforce.jp/archive/category/FFTT\"\u003eFFTT\u003c/a\u003e で『ここがつらいよ普段使いのLinux』という発表をしました。タイトルは違いますが、気にしないで下さい。\u003c/p\u003e\n\n\u003ciframe src=\"https://docs.google.com/presentation/d/e/2PACX-1vTBXZg9pczERJABgT3Uuu922Ktcc91HHl00QOtySt7fFtxrL4NZOcco1BtkK_pDuFkO0Uo-JuAwBkoC/embed?start=false\u0026loop=false\u0026delayms=3000\" frameborder=\"0\" width=\"960\" height=\"400\" allowfullscreen=\"true\" mozallowfullscreen=\"true\" webkitallowfullscreen=\"true\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003eMac が重い時に IME 切り替えが一瞬遅れて、例えば「feedforce」とタイプする時に「ふぇえ...」になる現象に悩まされていました。\u003c/p\u003e\n\n\u003cp\u003eそこで約 10 年ぶりに Windows PC を購入して、同じく約 10 年ぶりに Linux を普段使いし始めました。\u003c/p\u003e\n\n\u003cp\u003e数々の諸問題が発生しましたが、無事全部解決（？）したお話です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eキーボードショートカットがつらい\u003c/li\u003e\n\u003cli\u003eタッチパッドがつらい\u003c/li\u003e\n\u003cli\u003e指紋認証出来なくてつらい\u003c/li\u003e\n\u003cli\u003eたまにスリープから復帰しなくてつらい（一番つらい）\u003c/li\u003e\n\u003cli\u003eちょっとした画像編集に GIMP を使うのはつらい\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eみんなも Mac を捨てて Linux を使うといいと思うよ！\u003c/p\u003e\n\n\u003cp\u003eそれでは！\u003c/p\u003e\n\n\u003cp\u003e\u003cdiv class=\"hatena-asin-detail\"\u003e\u003ca href=\"https://www.amazon.co.jp/exec/obidos/ASIN/4871908240/hatena-blog-22/\" class=\"hatena-asin-detail-image-link\" target=\"_blank\" rel=\"noopener\"\u003e\u003cimg src=\"https://m.media-amazon.com/images/I/51NEN46FW9L._SL500_.jpg\" class=\"hatena-asin-detail-image\" alt=\"だれでもできるLinuxセットアップ―無料(ただ)なのに頼れるOSリヌクス\" title=\"だれでもできるLinuxセットアップ―無料(ただ)なのに頼れるOSリヌクス\"\u003e\u003c/a\u003e\u003cdiv class=\"hatena-asin-detail-info\"\u003e\u003cp class=\"hatena-asin-detail-title\"\u003e\u003ca href=\"https://www.amazon.co.jp/exec/obidos/ASIN/4871908240/hatena-blog-22/\" target=\"_blank\" rel=\"noopener\"\u003eだれでもできるLinuxセットアップ―無料(ただ)なのに頼れるOSリヌクス\u003c/a\u003e\u003c/p\u003e\u003cul class=\"hatena-asin-detail-meta\"\u003e\u003cli\u003e\u003cspan class=\"hatena-asin-detail-label\"\u003e作者:\u003c/span\u003e\u003ca href=\"http://d.hatena.ne.jp/keyword/%CE%EB%CC%DA%20%C5%AF%BA%C8\" class=\"keyword\"\u003e鈴木 哲哉\u003c/a\u003e\u003c/li\u003e\u003cli\u003eオーエス出版\u003c/li\u003e\u003c/ul\u003e\u003ca href=\"https://www.amazon.co.jp/exec/obidos/ASIN/4871908240/hatena-blog-22/\" class=\"asin-detail-buy\" target=\"_blank\" rel=\"noopener\"\u003eAmazon\u003c/a\u003e\u003c/div\u003e\u003c/div\u003e\u003c/p\u003e\n","contentSnippet":"こんにちは id:masutaka26 です。いよいよ明後日は RIZIN.28 ですね！東京ドームで MMA（総合格闘技）のイベントが行われるのは、約 17 年半ぶりだそうです（Wikipedia 調べ）。ドキが胸胸します。本日、週次の社内勉強会 FFTT で『ここがつらいよ普段使いのLinux』という発表をしました。タイトルは違いますが、気にしないで下さい。Mac が重い時に IME 切り替えが一瞬遅れて、例えば「feedforce」とタイプする時に「ふぇえ...」になる現象に悩まされていました。そこで約 10 年ぶりに Windows PC を購入して、同じく約 10 年ぶりに Linux を普段使いし始めました。数々の諸問題が発生しましたが、無事全部解決（？）したお話です。キーボードショートカットがつらいタッチパッドがつらい指紋認証出来なくてつらいたまにスリープから復帰しなくてつらい（一番つらい）ちょっとした画像編集に GIMP を使うのはつらいみんなも Mac を捨てて Linux を使うといいと思うよ！それでは！だれでもできるLinuxセットアップ―無料(ただ)なのに頼れるOSリヌクス作者:鈴木 哲哉オーエス出版Amazon","link":"https://developer.feedforce.jp/entry/2021/06/11/180000","isoDate":"2021-06-11T09:00:00.000Z","dateMiliSeconds":1623402000000,"imageUrl":"https://m.media-amazon.com/images/I/51NEN46FW9L._SL500_.jpg","authorName":"feedforce"},{"title":"【2021年夏】半期に1度の Engineer’s Principles Award 受賞者を紹介します","content":"\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/f/feedforce_recruit/20210611/20210611163915.jpg\" alt=\"f:id:feedforce_recruit:20210611163915j:plain\" width=\"1200\" height=\"700\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eこんにちは。人事の今岡と申します。\n2021年もあっという間に6月ですね。\u003c/p\u003e\n\n\u003cp\u003eフィードフォースでは先日オンライン納会が開催され、半期に一度の「Engineer’s Principles Award 2021 Summer」の受賞者が発表されました。\n今回アワードを受賞した開発メンバーと表彰内容をご紹介します。\u003c/p\u003e\n\n\u003cp\u003e前回の表彰者紹介はコチラ\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2020%2F12%2F28%2F131042\" title=\"半期に1度の Engineer’s Principles Award 受賞者を紹介します - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2020/12/28/131042\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003eEngineer’s Principles Award とは\u003c/h2\u003e\n\n\u003cp\u003eEngineer’s Principles とは、フィードフォースの開発メンバー向けに現場が主体となって設定した、5つの行動指針です。\n半期に一度、開発メンバー同士で投票を行い、行動指針の項目ごとに最も体現しているメンバーが選ばれ表彰されます。\u003c/p\u003e\n\n\u003cp\u003eEngineer’s Principles についてはこちら\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fmedia.feedforce.jp%2Fn%2Fnd1f2236470b3\" title=\"フィードフォースが目指すエンジニア像とは。「Engineer’s Principles」を紹介します｜フィードフォースのnote\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://media.feedforce.jp/n/nd1f2236470b3\"\u003emedia.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003e受賞者紹介\u003c/h2\u003e\n\n\u003cp\u003e※表彰コメントは本来社内向けのものであるため一部変更させていただいています。受賞者によって各種アカウントを載せています。\u003c/p\u003e\n\n\u003ch3\u003e🏆「Stay Humble; 常に謙虚であるべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@len_prog さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\n社内でメジャーな Rails 以外でバックエンドを実装する際に、なぜそうするのかという理由やレイヤーの切り方を他のメンバーにわかりやすく説明していました。\n一方、自分自身で苦手なことがあった場合に、他の人に相談したり、フィードバックを求めそれを受け入れる姿勢は、まさに Stay Humble だと思いました。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e \u003ca href=\"https://twitter.com/len_prog\"\u003eLen (@len_prog)\u003c/a\u003e , \u003ci class=\"blogicon-entry\"\u003e\u003c/i\u003e \u003ca href=\"https://len-prog.hatenablog.com/\"\u003eBlog\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e@katsunn さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\n事前に色々なアイデアを用意しつつも、相談の過程でお互いの認識や意図を踏まえたうえで改善を進めていく一方、ただ受け入れるだけではなく、\nプロフェッショナルとして自分なりに咀嚼したアウトプットにしていく姿勢が非常に素晴らしく、ベンチマークにすべきだと感じました。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e  \u003ca href=\"https://twitter.com/nomo_017\"\u003eのもち(@nomo_017)\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e🏆「Be Positive \u0026amp; Proactive; 常に肯定的・主体的であるべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@sukechannnn さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nエンジニアとして様々なチームビルディングや開発手法を試しているだけではなく、ビジネス視点からも方向性を考え、\nプロダクトオーナーとしてプロダクトを成長させようとしている姿勢は、まさにこの言葉にぴったりだと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e \u003ca href=\"https://twitter.com/sukechannnn\"\u003e sukechannnn (@sukechannnn)\u003c/a\u003e , \u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/sukechannnn\"\u003esukechannnn\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e@daido1976 さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\n分野を問わず新しいことに前向きに挑戦し、気になったことはどんどん質問するのに加え、\n育休中のメンバーに代わって、率先してチームを引っ張っている行動力が素晴らしいと思いました。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e  \u003ca href=\"https://twitter.com/daido1976\"\u003eDaido Shota (@daido1976)\u003c/a\u003e , \u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e  \u003ca href=\"https://github.com/daido1976\"\u003e daido1976\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e🏆「Be Prepared; 常に来たるべき機会に備えるべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@daido1976 さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\n自分のキャリアや目指すべき方向を踏まえつつ、常にアンテナを立てて知識を広く持とうとしている姿勢がよいと感じています。\nさらに、そうして蓄積したスキルを開発だけではなく、自ら手を挙げ講師をつとめた新卒向け Web 研修にも活かしている点がまさに Be Prepared だと思いました。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e  \u003ca href=\"https://twitter.com/daido1976\"\u003eDaido Shota (@daido1976)\u003c/a\u003e , \u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e  \u003ca href=\"https://github.com/daido1976\"\u003e daido1976\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e@namikingsoft さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nOmni Hub の開発において、あまり開発経験がなかったはずの Rust を使いこなしつつ WAF を含めたインフラ構築をしていて、\n@namikingsoft さんの強みが発揮される局面でした。また dfplus.io でもパフォーマンス改善でコアな知識を活かすなど、まさにこれまでの準備の賜物だと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/namikingsoft\"\u003enamikingsoft\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e🏆「Share All; 己の知見、試行、失敗、遍く共有すべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@masutaka さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nLooker 導入において知見や失敗など社内共有しているほか、そもそも  esa にどう記録すべきかといった、「共有のための知見の共有」にまで配慮しています。\nSlack や esa 、Blog への共有はエンジニアのみならず、全社的にプラスの影響を与えていて、まさに共有の神様と言えるでしょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e \u003ca href=\"https://twitter.com/masutaka\"\u003eTakashi Masuda (@masutaka)\u003c/a\u003e , \u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/masutaka\"\u003emasutaka\u003c/a\u003e , \u003ci class=\"blogicon-entry\"\u003e\u003c/i\u003e \u003ca href=\"https://masutaka.net/\"\u003eBlog\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e@kogai さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nShopify 周りでは、社内だけでなく社外に対してのプレゼンスを示しています。また Omni Hub の開発で多忙な中、\n社内勉強会 Rust の会では実際の新規事業のプロダクトコードを題材に実践的な知見を共有するなど、その共有力はフィードフォースエンジニアの鑑（かがみ）だと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e \u003ca href=\"https://twitter.com/iamchawan\"\u003e茶碗 (@iamchawan)\u003c/a\u003e ,\u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/kogai\"\u003ekogai\u003c/a\u003e , \u003ci class=\"blogicon-entry\"\u003e\u003c/i\u003e \u003ca href=\"https://k9bookshelf.com/blogs/development\"\u003eBlog\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e🏆「Just Do It; 全力でやりきるべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@namikingsoftさん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nOmni  Hub リリースまでの道筋をきちんと立ててスケジュール以上の速さで完走して去っていくその姿は、まさに Just Do It でした。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/namikingsoft\"\u003enamikingsoft\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e周囲の賞賛・承認を共有するよい機会に\u003c/h2\u003e\n\n\u003cp\u003e以上、延べ9名の受賞者でした。\u003c/p\u003e\n\n\u003cp\u003e表彰コメントは、\u003cstrong\u003e開発メンバー同士の投票時に自由記述できるコメントがもとになっているので\u003c/strong\u003e、周囲からの賞賛・承認の声を全社で共有できるよい機会となっています。\u003c/p\u003e\n\n\u003cp\u003e前回に引き続き連続受賞しているメンバーもいますが、投票コメントには毎回違ったエピソードが集まっており、日ごろから継続的に実践をしているからこそ周りのエンジニアの目に留まるのだと感じました。\u003c/p\u003e\n\n\u003cp\u003e受賞者のみなさん、おめでとうございました！\u003c/p\u003e\n","contentSnippet":"こんにちは。人事の今岡と申します。2021年もあっという間に6月ですね。フィードフォースでは先日オンライン納会が開催され、半期に一度の「Engineer’s Principles Award 2021 Summer」の受賞者が発表されました。今回アワードを受賞した開発メンバーと表彰内容をご紹介します。前回の表彰者紹介はコチラdeveloper.feedforce.jpEngineer’s Principles Award とはEngineer’s Principles とは、フィードフォースの開発メンバー向けに現場が主体となって設定した、5つの行動指針です。半期に一度、開発メンバー同士で投票を行い、行動指針の項目ごとに最も体現しているメンバーが選ばれ表彰されます。Engineer’s Principles についてはこちらmedia.feedforce.jp受賞者紹介※表彰コメントは本来社内向けのものであるため一部変更させていただいています。受賞者によって各種アカウントを載せています。🏆「Stay Humble; 常に謙虚であるべし」受賞者@len_prog さん表彰コメント： Len (@len_prog) ,  Blog@katsunn さん表彰コメント：  のもち(@nomo_017)🏆「Be Positive \u0026 Proactive; 常に肯定的・主体的であるべし」受賞者@sukechannnn さん表彰コメント：  sukechannnn (@sukechannnn) ,  sukechannnn@daido1976 さん表彰コメント：  Daido Shota (@daido1976) ,    daido1976🏆「Be Prepared; 常に来たるべき機会に備えるべし」受賞者@daido1976 さん表彰コメント：  Daido Shota (@daido1976) ,    daido1976@namikingsoft さん表彰コメント： namikingsoft🏆「Share All; 己の知見、試行、失敗、遍く共有すべし」受賞者@masutaka さん表彰コメント： Takashi Masuda (@masutaka) ,  masutaka ,  Blog@kogai さん表彰コメント： 茶碗 (@iamchawan) , kogai ,  Blog🏆「Just Do It; 全力でやりきるべし」受賞者@namikingsoftさん表彰コメント： namikingsoft周囲の賞賛・承認を共有するよい機会に以上、延べ9名の受賞者でした。表彰コメントは、開発メンバー同士の投票時に自由記述できるコメントがもとになっているので、周囲からの賞賛・承認の声を全社で共有できるよい機会となっています。前回に引き続き連続受賞しているメンバーもいますが、投票コメントには毎回違ったエピソードが集まっており、日ごろから継続的に実践をしているからこそ周りのエンジニアの目に留まるのだと感じました。受賞者のみなさん、おめでとうございました！","link":"https://developer.feedforce.jp/entry/2021/06/11/164253","isoDate":"2021-06-11T07:42:53.000Z","dateMiliSeconds":1623397373000,"imageUrl":"https://cdn.user.blog.st-hatena.com/default_entry_og_image/4268819/1588226000876991","authorName":"feedforce"},{"title":"プランニングの難しさを乗り越えて...スクラム開発が良い感じになった話","content":"\u003cp\u003eこんにちは。フィードフォースの \u003ca href=\"https://ecbooster.jp/\"\u003eEC Booster\u003c/a\u003e チームで開発（主にプロダクトオーナー）をしている \u003ca href=\"https://twitter.com/sukechannnn\"\u003e@sukechannnn\u003c/a\u003e です。元々ずっとバックエンドエンジニアでしたが、最近プロダクトオーナーをやるようになりました（理由はのちほど！）。\u003c/p\u003e\n\n\u003cp\u003e昨年のアドベントカレンダーで \u003ca href=\"https://developer.feedforce.jp/entry/2020/12/11/172338\"\u003e半年モブプロしたらチームが大きく成長した話\u003c/a\u003e というブログを書いたのですが、2021年3月から \u003cstrong\u003eモブプロを取り入れたスクラム開発\u003c/strong\u003e をしています。それに伴って、\"モブプロ\" と \"個人タスク⇢レビュー\" の両軸で開発するようになりました（\u003ca href=\"https://prtimes.jp/main/html/rd/p/000000040.000071307.html\"\u003e先日リリースしたカイゼンカード\u003c/a\u003e はスクラムで開発しました）。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2020%2F12%2F11%2F172338\" title=\"半年モブプロしたらチームが大きく成長した話 - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003e今は良い感じに回っていますが、そうなるまでに色々と試行錯誤したので、そこで得た学びをお伝えできればと思います。全員リモートワークで開発するなら、モブプロを取り入れたスクラムはおすすめです！\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#モブプロの良さと難しさ\"\u003eモブプロの良さと難しさ\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#そうだスクラムしよう\"\u003eそうだ、スクラムしよう！\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#プランニングが終わらない問題\"\u003eプランニングが終わらない問題\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#原因はissue-が散らかっていることだった\"\u003e原因は「issue が散らかっていること」だった\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#issue-をグルーピング優先順位はそれぞれで\"\u003eissue をグルーピング、優先順位はそれぞれで\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"モブプロの良さと難しさ\"\u003eモブプロの良さと難しさ\u003c/h2\u003e\n\n\u003cp\u003eモブプロ中心の開発を初めた当初は、以下の利点を感じていました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eドメイン知識の共有がしやすい\u003c/li\u003e\n\u003cli\u003eコンテキストの共有がしやすい（\"何をどう作るか\" という議論もしやすい）\u003c/li\u003e\n\u003cli\u003eレビューが要らない\u003c/li\u003e\n\u003cli\u003eリモートワークでもさみしくない（だいじ）\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eしばらくモブプロを続ける中で、開発メンバー全員がドメイン知識やフロント〜バックエンド全体の技術的な知識を共有している状態になりました。なので、なにか悩みがあってモブプロで共有すると「わかる〜」となるし、何より単純に仲良くなったと思います（ﾖｼｯ!!）。\u003c/p\u003e\n\n\u003cp\u003e一方で、だんだんと \u003cstrong\u003eモブプロだけ\u003c/strong\u003e の開発が窮屈になってきました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e知識の共有が進んできて \"全員でやらなくても良くない？\" というタスクが増えてきた\u003c/li\u003e\n\u003cli\u003e個人でじっくり考えた方が良いタスクもあるのが分かった（新しい技術の調査、設計の見直しなど）\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこれはチームが成長したことで出てきた嬉しい悩みなのですが、とはいえ完全にモブプロを辞めるのも上述したメリットを失いそうで怖い...。チーム全員で「今後どう開発していこう？」というのを話し合い、\u003cstrong\u003eモブプロを取り入れたスクラム開発\u003c/strong\u003e を試してみることにしました。\u003c/p\u003e\n\n\u003ch2 id=\"そうだスクラムしよう\"\u003eそうだ、スクラムしよう！\u003c/h2\u003e\n\n\u003cp\u003eスクラム開発をしようと思ったのは、ストーリーポイント\u003ca href=\"#f-9495249b\" name=\"fn-9495249b\" title=\"ストーリーポイント：プロダクトバックログ（タスク）を見積もるためにチームが使う単位で、前回の見積もりに対する相対評価を用いる\"\u003e*1\u003c/a\u003eで見積もって \u003cstrong\u003eベロシティ\u003ca href=\"#f-33d76d3d\" name=\"fn-33d76d3d\" title=\"ベロシティ：スプリントの期間でチームが届けることができる見積もり（ストーリーポイント）の合計のこと\"\u003e*2\u003c/a\u003eを測りたい\u003c/strong\u003e という別の目的もありました。\u003c/p\u003e\n\n\u003cp\u003eモブプロで開発していると新機能のメイン開発は着実に進んでいくのですが、それ以外の細かいタスク（主に保守系）が見積もりづらい状況で、空いた時間にやるという形になってしまっていました（それ用に時間は設けていましたが）。\u003c/p\u003e\n\n\u003cp\u003eモブプロ以外の個人タスクを計画的にやりたい、見積もりもしっかりやりたい、ということで、スクラムを導入することで、\u003cstrong\u003eモブプロと個人開発のいいとこ取り\u003c/strong\u003e をしようと考えました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e新機能開発などのコンテキストの共有が重要なタスクは引き続きモブプロでやる\n\n\u003cul\u003e\n\u003cli\u003eストーリーポイントで見積もる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eそれ以外は個人タスクとして各自で進められるように、プランニングでしっかり整理する\n\n\u003cul\u003e\n\u003cli\u003e個人タスクもストーリーポイントで見積もる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e全てのタスクをストーリーポイントで見積もるのでベロシティが測れるようになる\n\n\u003cul\u003e\n\u003cli\u003e振り返りで見積もりの精度を上げられる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eめっちゃ良さそう...そう思っていざやってみたところ、１つ大きな壁にぶち当たってしまいました。\u003c/p\u003e\n\n\u003ch2 id=\"プランニングが終わらない問題\"\u003eプランニングが終わらない問題\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.shoeisha.co.jp/book/detail/9784798130507\"\u003eエッセンシャルスクラム\u003c/a\u003eにもある通り、１週間のプランニングに２時間以上かけるべきではありません。僕らは「１スプリント=１週間」で回しているため、２時間の予定で始めたプランニングですが、これが終わらない...。最初から何回かは４時間以上かかり、全員ヘトヘトになってしまいました。\u003c/p\u003e\n\n\u003cp\u003eモブプロはプランニングが簡単です。全員やることが同じなので、基本的にタスクが直列で繋がっていきます。そのため「今スプリントはここから⇢ここまで」という感じで Sprint Backlog 的なものを決めることができました。\u003c/p\u003e\n\n\u003cp\u003eしかし、スクラムの見積もりはもっと横断的なものです。単純に、今取り組んでいるものだけ見れば良いのではなく、これから取り組むものをたくさんある issue から選ぶ必要があります。そう、この \u003cstrong\u003eたくさんある issue の中から今スプリントにやるタスクを選ぶこと\u003c/strong\u003e に時間がかかってしまうのです。\u003c/p\u003e\n\n\u003cp\u003e以前にもスクラム開発を試したことがあるのですが、その時もこれが原因でプランニングがとても大変でした。気にするトピックが多すぎてだんだん何について議論してるか分からなくなり、空中戦になってしまうんですよね...。\u003c/p\u003e\n\n\u003cp\u003eその原因は、主に以下の２つでした。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバックログの整理/管理に責任を持つ人（プロダクトオーナー\u003ca href=\"#f-339964b7\" name=\"fn-339964b7\" title=\"プロダクトオーナー：プロダクトバックログの管理をする人で、優先順位を付けることに責任を持つ（１人の人間が務める、委員会ではない）\"\u003e*3\u003c/a\u003e）がいなかった\u003c/li\u003e\n\u003cli\u003eissue の数と種類が多く、バックログリファインメント\u003ca href=\"#f-f2375d03\" name=\"fn-f2375d03\" title=\"バックログリファインメント：プランニングの前にプロダクトバックログを見直し、プランニング可能な状態にしておくこと\"\u003e*4\u003c/a\u003eをしても整理しきれなかった\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eプロダクトオーナー不在の問題は、元々それっぽいことをしていた僕が、改めてプロダクトオーナーやりますと手を上げ、バックログ管理の責任を持つことになりました。\u003c/p\u003e\n\n\u003cp\u003eそれでも、バックログリファインメントが上手く行かない問題は残っていました。リファインメントの概念は理解していて、しっかり時間も取っていたのに、いざプランニングをすると色々な issue を見すぎて伸びてしまう...。過去に何度も直面したこの問題に、改めて取り組むことにしました。\u003c/p\u003e\n\n\u003ch2 id=\"原因はissue-が散らかっていることだった\"\u003e原因は「issue が散らかっていること」だった\u003c/h2\u003e\n\n\u003cp\u003e僕たちが開発している EC Booster は、ショッピング広告の自動運用やデータフィードの更新など、様々なジョブが裏で動いています。そのため、運用作業が日々発生し、運用の中で見つかる例外ケースやバグの修正が多々あります。\nまた、フロントエンドとバックエンドを全員が開発するため、１つのリポジトリで管理していることもあり、色々な種類の issue が１つのレーンに入り乱れてしまっていました。\u003c/p\u003e\n\n\u003cp\u003eそのため、優先順位を付けるのも難しく、また「次スプリントで何をどこまでやるか？」を判断するのが難しくなってしまっていました。\u003c/p\u003e\n\n\u003cp\u003eプロダクトバックログを整理しなければ、というのは分かっているのですが、スクラムに関する本やブログには整理の方法は書いてありません。どうやって整理したら分かりやすくなるかな...と考えていたところ、同僚が共有してくれた以下の記事が参考になりました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://note.com/gonjyu/n/nd7bf3efa0728\"\u003eエンジニア歴17年の俺が、事業系の開発タスクをバンバン投げてくる非エンジニアに、保守の必要性を死ぬほど分かりやすく説明する。\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこの記事の中で「issueには \"種類\" がある」と言っていて、issue の種類別に整理された図が載っていました。これだ...！\u003c/p\u003e\n\n\u003ch2 id=\"issue-をグルーピング優先順位はそれぞれで\"\u003eissue をグルーピング、優先順位はそれぞれで\u003c/h2\u003e\n\n\u003cp\u003e上記の記事を参考に、issue を \u003cstrong\u003e新機能開発\u003c/strong\u003e、\u003cstrong\u003eバグ修正/運用改善\u003c/strong\u003e、\u003cstrong\u003eライブラリーアップデート\u003c/strong\u003e に分けて、それぞれのレーンで優先順位を付けるようにしました。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"issue をグルーピング、優先順位はそれぞれで\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/s/sukechannnn/20210526/20210526215948.png\" alt=\"f:id:sukechannnn:20210526215948p:plain\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eissue をグルーピング、優先順位はそれぞれで\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003eissue の種類が同じなので、優先順位を付けるのは簡単です。さらに、スプリントバックログに入れるタスクを \u003cstrong\u003e新機能開発：運用系 = ６：４\u003c/strong\u003e の割合にする、という決めを作りました。さらに、何回かスプリントを回してベロシティも見えてきました。\u003c/p\u003e\n\n\u003cp\u003eここまで情報が揃うと \u003cstrong\u003e次のスプリントで何をやるか決める基準\u003c/strong\u003e ができてきます。\u003c/p\u003e\n\n\u003cp\u003eそもそもの「次のプランニングでどの issue について話すか？」というのも、それぞれのレーンで優先順位が高い issue を６：４のバランスとベロシティを参考に選べるようになりました。\u003cstrong\u003eプランニングの前\u003c/strong\u003eにプロダクトオーナーが（開発チームと協力しながら）当たりを付けておくことで、プランニングで話すトピックを事前に共有できるようになり、開発メンバーそれぞれが事前に頭を整理しておくこともできるようになりました。\u003c/p\u003e\n\n\u003cp\u003eこれにより、プランニングがかなりスムーズに進むようになったので、いよいよスクラムが回り始めました。新機能開発はモブプロの同期的な開発で、それ以外のタスクは個人タスク⇢レビューという非同期な開発で進められるようになり、デリバリーの最大化を目指しつつ、個人の稼働率も上げられるようになりました。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"GitHub Project を使ってタスク管理してる様子...横に長いんですが、情報が整理されてる方が優先順位を付けやすい\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/s/sukechannnn/20210526/20210526212511.png\" alt=\"f:id:sukechannnn:20210526212511p:plain\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eGitHub Project を使ってタスク管理してる様子...横に長いんですが、情報が整理されてる方が優先順位を付けやすい\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eissue をグルーピングしそれぞれで優先順位を付けたことで、プランニングが時間内に収まるようになっただけでなく、プランニングで話すトピックを絞ったことでより深い議論をすることができるようになりました。今は「モブプロを取り入れたスクラム」がとても良い感じに回っています！\u003c/p\u003e\n\n\u003cp\u003e↓ EC Booster チームでの「スプリントの回し方」資料を公開しているので、気になった方はぜひ見てみてください！（もっとこうしたら良いよ！という助言などあれば頂けると嬉しいです！）\u003c/p\u003e\n\n\u003ciframe src=\"https://docs.google.com/presentation/d/e/2PACX-1vTQY639rUAwDDtLfj_c9WbU1E0IlDSFzAbrP-XFCmbg8V_sNKPX_pCvKpiy50CQpS02nXvZnQHBb6JT/embed?start=false\u0026loop=false\u0026delayms=3000\" frameborder=\"0\" width=\"960\" height=\"569\" allowfullscreen=\"true\" mozallowfullscreen=\"true\" webkitallowfullscreen=\"true\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003eこんな感じ開発している EC Booster ですが、ただ今 \u003cstrong\u003eバックエンド（Ruby, Rails）が得意なエンジニアを猛烈に必要としています！！！\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eもしちょっっっとでも興味があれば、 \u003cstrong\u003e僕とお話しましょう！\u003c/strong\u003e 以下から気軽に応募してください！\n\u003ca href=\"https://open.talentio.com/1/c/feedforce/requisitions/detail/19785\"\u003ehttps://open.talentio.com/1/c/feedforce/requisitions/detail/19785\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e最後まで読んでいただき、ありがとうございました！\u003c/p\u003e\n\u003cdiv class=\"footnote\"\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-9495249b\" name=\"f-9495249b\" class=\"footnote-number\"\u003e*1\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://www.ryuzee.com/contents/blog/3716\"\u003eストーリーポイント\u003c/a\u003e：プロダクトバックログ（タスク）を見積もるためにチームが使う単位で、前回の見積もりに対する相対評価を用いる\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-33d76d3d\" name=\"f-33d76d3d\" class=\"footnote-number\"\u003e*2\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://www.ryuzee.com/contents/blog/4802\"\u003eベロシティ\u003c/a\u003e：スプリントの期間でチームが届けることができる見積もり（ストーリーポイント）の合計のこと\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-339964b7\" name=\"f-339964b7\" class=\"footnote-number\"\u003e*3\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://www.ryuzee.com/contents/blog/7143\"\u003eプロダクトオーナー\u003c/a\u003e：プロダクトバックログの管理をする人で、優先順位を付けることに責任を持つ（１人の人間が務める、委員会ではない）\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-f2375d03\" name=\"f-f2375d03\" class=\"footnote-number\"\u003e*4\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://www.ryuzee.com/contents/blog/5024\"\u003eバックログリファインメント\u003c/a\u003e：プランニングの前にプロダクトバックログを見直し、プランニング可能な状態にしておくこと\u003c/span\u003e\u003c/p\u003e\n\u003c/div\u003e","contentSnippet":"こんにちは。フィードフォースの EC Booster チームで開発（主にプロダクトオーナー）をしている @sukechannnn です。元々ずっとバックエンドエンジニアでしたが、最近プロダクトオーナーをやるようになりました（理由はのちほど！）。昨年のアドベントカレンダーで 半年モブプロしたらチームが大きく成長した話 というブログを書いたのですが、2021年3月から モブプロを取り入れたスクラム開発 をしています。それに伴って、\"モブプロ\" と \"個人タスク⇢レビュー\" の両軸で開発するようになりました（先日リリースしたカイゼンカード はスクラムで開発しました）。今は良い感じに回っていますが、そうなるまでに色々と試行錯誤したので、そこで得た学びをお伝えできればと思います。全員リモートワークで開発するなら、モブプロを取り入れたスクラムはおすすめです！モブプロの良さと難しさそうだ、スクラムしよう！プランニングが終わらない問題原因は「issue が散らかっていること」だったissue をグルーピング、優先順位はそれぞれでまとめモブプロの良さと難しさモブプロ中心の開発を初めた当初は、以下の利点を感じていました。ドメイン知識の共有がしやすいコンテキストの共有がしやすい（\"何をどう作るか\" という議論もしやすい）レビューが要らないリモートワークでもさみしくない（だいじ）しばらくモブプロを続ける中で、開発メンバー全員がドメイン知識やフロント〜バックエンド全体の技術的な知識を共有している状態になりました。なので、なにか悩みがあってモブプロで共有すると「わかる〜」となるし、何より単純に仲良くなったと思います（ﾖｼｯ!!）。一方で、だんだんと モブプロだけ の開発が窮屈になってきました。知識の共有が進んできて \"全員でやらなくても良くない？\" というタスクが増えてきた個人でじっくり考えた方が良いタスクもあるのが分かった（新しい技術の調査、設計の見直しなど）これはチームが成長したことで出てきた嬉しい悩みなのですが、とはいえ完全にモブプロを辞めるのも上述したメリットを失いそうで怖い...。チーム全員で「今後どう開発していこう？」というのを話し合い、モブプロを取り入れたスクラム開発 を試してみることにしました。そうだ、スクラムしよう！スクラム開発をしようと思ったのは、ストーリーポイント*1で見積もって ベロシティ*2を測りたい という別の目的もありました。モブプロで開発していると新機能のメイン開発は着実に進んでいくのですが、それ以外の細かいタスク（主に保守系）が見積もりづらい状況で、空いた時間にやるという形になってしまっていました（それ用に時間は設けていましたが）。モブプロ以外の個人タスクを計画的にやりたい、見積もりもしっかりやりたい、ということで、スクラムを導入することで、モブプロと個人開発のいいとこ取り をしようと考えました。新機能開発などのコンテキストの共有が重要なタスクは引き続きモブプロでやるストーリーポイントで見積もるそれ以外は個人タスクとして各自で進められるように、プランニングでしっかり整理する個人タスクもストーリーポイントで見積もる全てのタスクをストーリーポイントで見積もるのでベロシティが測れるようになる振り返りで見積もりの精度を上げられるめっちゃ良さそう...そう思っていざやってみたところ、１つ大きな壁にぶち当たってしまいました。プランニングが終わらない問題エッセンシャルスクラムにもある通り、１週間のプランニングに２時間以上かけるべきではありません。僕らは「１スプリント=１週間」で回しているため、２時間の予定で始めたプランニングですが、これが終わらない...。最初から何回かは４時間以上かかり、全員ヘトヘトになってしまいました。モブプロはプランニングが簡単です。全員やることが同じなので、基本的にタスクが直列で繋がっていきます。そのため「今スプリントはここから⇢ここまで」という感じで Sprint Backlog 的なものを決めることができました。しかし、スクラムの見積もりはもっと横断的なものです。単純に、今取り組んでいるものだけ見れば良いのではなく、これから取り組むものをたくさんある issue から選ぶ必要があります。そう、この たくさんある issue の中から今スプリントにやるタスクを選ぶこと に時間がかかってしまうのです。以前にもスクラム開発を試したことがあるのですが、その時もこれが原因でプランニングがとても大変でした。気にするトピックが多すぎてだんだん何について議論してるか分からなくなり、空中戦になってしまうんですよね...。その原因は、主に以下の２つでした。バックログの整理/管理に責任を持つ人（プロダクトオーナー*3）がいなかったissue の数と種類が多く、バックログリファインメント*4をしても整理しきれなかったプロダクトオーナー不在の問題は、元々それっぽいことをしていた僕が、改めてプロダクトオーナーやりますと手を上げ、バックログ管理の責任を持つことになりました。それでも、バックログリファインメントが上手く行かない問題は残っていました。リファインメントの概念は理解していて、しっかり時間も取っていたのに、いざプランニングをすると色々な issue を見すぎて伸びてしまう...。過去に何度も直面したこの問題に、改めて取り組むことにしました。原因は「issue が散らかっていること」だった僕たちが開発している EC Booster は、ショッピング広告の自動運用やデータフィードの更新など、様々なジョブが裏で動いています。そのため、運用作業が日々発生し、運用の中で見つかる例外ケースやバグの修正が多々あります。また、フロントエンドとバックエンドを全員が開発するため、１つのリポジトリで管理していることもあり、色々な種類の issue が１つのレーンに入り乱れてしまっていました。そのため、優先順位を付けるのも難しく、また「次スプリントで何をどこまでやるか？」を判断するのが難しくなってしまっていました。プロダクトバックログを整理しなければ、というのは分かっているのですが、スクラムに関する本やブログには整理の方法は書いてありません。どうやって整理したら分かりやすくなるかな...と考えていたところ、同僚が共有してくれた以下の記事が参考になりました。エンジニア歴17年の俺が、事業系の開発タスクをバンバン投げてくる非エンジニアに、保守の必要性を死ぬほど分かりやすく説明する。この記事の中で「issueには \"種類\" がある」と言っていて、issue の種類別に整理された図が載っていました。これだ...！issue をグルーピング、優先順位はそれぞれで上記の記事を参考に、issue を 新機能開発、バグ修正/運用改善、ライブラリーアップデート に分けて、それぞれのレーンで優先順位を付けるようにしました。issue をグルーピング、優先順位はそれぞれでissue の種類が同じなので、優先順位を付けるのは簡単です。さらに、スプリントバックログに入れるタスクを 新機能開発：運用系 = ６：４ の割合にする、という決めを作りました。さらに、何回かスプリントを回してベロシティも見えてきました。ここまで情報が揃うと 次のスプリントで何をやるか決める基準 ができてきます。そもそもの「次のプランニングでどの issue について話すか？」というのも、それぞれのレーンで優先順位が高い issue を６：４のバランスとベロシティを参考に選べるようになりました。プランニングの前にプロダクトオーナーが（開発チームと協力しながら）当たりを付けておくことで、プランニングで話すトピックを事前に共有できるようになり、開発メンバーそれぞれが事前に頭を整理しておくこともできるようになりました。これにより、プランニングがかなりスムーズに進むようになったので、いよいよスクラムが回り始めました。新機能開発はモブプロの同期的な開発で、それ以外のタスクは個人タスク⇢レビューという非同期な開発で進められるようになり、デリバリーの最大化を目指しつつ、個人の稼働率も上げられるようになりました。GitHub Project を使ってタスク管理してる様子...横に長いんですが、情報が整理されてる方が優先順位を付けやすいまとめissue をグルーピングしそれぞれで優先順位を付けたことで、プランニングが時間内に収まるようになっただけでなく、プランニングで話すトピックを絞ったことでより深い議論をすることができるようになりました。今は「モブプロを取り入れたスクラム」がとても良い感じに回っています！↓ EC Booster チームでの「スプリントの回し方」資料を公開しているので、気になった方はぜひ見てみてください！（もっとこうしたら良いよ！という助言などあれば頂けると嬉しいです！）こんな感じ開発している EC Booster ですが、ただ今 バックエンド（Ruby, Rails）が得意なエンジニアを猛烈に必要としています！！！もしちょっっっとでも興味があれば、 僕とお話しましょう！ 以下から気軽に応募してください！https://open.talentio.com/1/c/feedforce/requisitions/detail/19785最後まで読んでいただき、ありがとうございました！*1:ストーリーポイント：プロダクトバックログ（タスク）を見積もるためにチームが使う単位で、前回の見積もりに対する相対評価を用いる*2:ベロシティ：スプリントの期間でチームが届けることができる見積もり（ストーリーポイント）の合計のこと*3:プロダクトオーナー：プロダクトバックログの管理をする人で、優先順位を付けることに責任を持つ（１人の人間が務める、委員会ではない）*4:バックログリファインメント：プランニングの前にプロダクトバックログを見直し、プランニング可能な状態にしておくこと","link":"https://developer.feedforce.jp/entry/2021/05/31/104813","isoDate":"2021-05-31T01:48:13.000Z","dateMiliSeconds":1622425693000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/s/sukechannnn/20210526/20210526215948.png","authorName":"feedforce"},{"title":"エンジニアキャリアパスをアップデートしました","content":"\u003cp\u003eこんにちは、\u003ca href=\"https://twitter.com/meihong\"\u003emeihong\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e株式会社フィードフォースでは\u003ca href=\"https://media.feedforce.jp/n/nc7a2e89635eb\"\u003e定期評価ではなく本人の希望するタイミングで評価を行う制度\u003c/a\u003eを導入しています。具体的には、各等級ごとに満たすべき基準・条件、またはスキルがあらかじめ提示されており、それを満たしていれば次の等級に進める制度になります。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fmedia.feedforce.jp%2Fn%2Fn222a08fd3e2b\" title=\"半年に1回の評価制度を毎月の評価制度に変えた話｜フィードフォースのnote\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://media.feedforce.jp/n/n222a08fd3e2b\"\u003emedia.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eこの基準やスキルを私たちはキャリアパスと呼んでいますが、今回、エンジニアのキャリアパスをアップデートしましたのでご紹介したいと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/meihong/20210524/20210524010544.png\" alt=\"f:id:meihong:20210524010544p:plain\" width=\"1200\" height=\"630\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch2\u003eなぜキャリアパスをアップデートしたのか\u003c/h2\u003e\n\n\u003cp\u003eもともとのキャリアパスは\u003ca href=\"https://media.feedforce.jp/n/n222a08fd3e2b\"\u003e導入当初に設計されたもの\u003c/a\u003eをベースに、マネージャやエンジニア、新規事業向けエンジニアといった個々人の志向に応じて細分化されていました。\u003c/p\u003e\n\n\u003cp\u003eこれはこれでよくできたものだったのですが、しばらく運用している中でいくつかの課題点を感じるようになってきました。\n例えば、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e志向ごとに分かれすぎていて、志向を横断した動きが想定しづらくなった。\u003c/li\u003e\n\u003cli\u003e独り立ちと判断される等級であるメンバーとその一つ上のシニアの境界に「見えない高い壁」が存在するようになった。\u003c/li\u003e\n\u003cli\u003eシニア以上の等級になるとチームや会社を牽引することを求められ、技術をそれ以上深掘りすることに対して会社がどう考えているのかが見えづらくなった。\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eといったところです。\u003c/p\u003e\n\n\u003cp\u003e特にキャリアパス全体として、職種問わず等級が上がれば上がるほどチームや会社への影響力が求められる設計になっています。\u003c/p\u003e\n\n\u003cp\u003eもちろんエンジニアも全体への影響力は持つべきなのですが、その持ち方は他の職種と異なり、技術力の広さ、深さといった持ち方もあるのではないかと考えるようになりました。\u003c/p\u003e\n\n\u003cp\u003eここで、個人的にはプロフェッショナルとしてのスキルは体積であり、その底面積はスキルの幅広さだと考えています。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/meihong/20210523/20210523235853.png\" alt=\"f:id:meihong:20210523235853p:plain\" width=\"1200\" height=\"731\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e極端に底面積が狭いのはさすがに現時点では厳しいとは思いますが、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e底面積がそれなりである代わりに高さ(= 深さ)がある\u003c/li\u003e\n\u003cli\u003e底面積が広い (= 引き出しが多い) 反面高さはそこまででもない\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eの両者は体積という意味では同じはずです。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/meihong/20210524/20210524000640.png\" alt=\"f:id:meihong:20210524000640p:plain\" width=\"1200\" height=\"576\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eこの両者が共存できる余地が欲しいと考えていました。\u003c/p\u003e\n\n\u003cp\u003eそんな中、弊社デザイナーのキャリアパスがアップデートされました。その中でも目を引いたのは、必須スキルと専門スキルという考え方です。\u003c/p\u003e\n\n\u003cp\u003e必須スキルはデザイナーとして必ず持っていて欲しいスキルである一方、専門スキルは本人の志向、特性に応じてピックアップできるというもので、大学の専攻を思い出す建て付けでした。\u003c/p\u003e\n\n\u003cp\u003e\u003cs\u003eこれをパクる\u003c/s\u003eこれにインスパイアされて、エンジニアのキャリアパスもアップデートすることにしました。\u003c/p\u003e\n\n\u003ch2\u003eどのように更新したのか\u003c/h2\u003e\n\n\u003cp\u003e結果から先にお伝えしておくと、大まかに以下のような方向性に改訂しました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e志向ごとのキャリアパスは止めた。\u003c/li\u003e\n\u003cli\u003e旧来の「志向」を専門スキルに分解し、専門スキルの組み合わせで個々人の志向・特性を表現できるようにした。\u003c/li\u003e\n\u003cli\u003e等級が上がれば上がるほど満たすべき専門スキルの最低数が増えるようにした。\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eその結果として、例えば\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバックエンドエンジニアに特化\u003c/li\u003e\n\u003cli\u003eフルスタックエンジニア\u003c/li\u003e\n\u003cli\u003eフルスタックな知識をベースに事業の 0 → 1 フェイズに参画できるエンジニア\u003c/li\u003e\n\u003cli\u003eカスタマーサクセスエンジニア\u003c/li\u003e\n\u003cli\u003eアジャイルコーチ\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eといった、実際に社内に存在している各エンジニアの志向や得意なポイントを表現できるようになりました。\u003c/p\u003e\n\n\u003ch2\u003e産みの苦しみ\u003c/h2\u003e\n\n\u003cp\u003eここに至るまでには色々な葛藤がありました。\n社内の esa にキャリアパスを更新したいと宣言はしたものの、社内のエンジニア個々人の顔を思い浮かべつつ何を専門スキルとして設定するかを考えると想像以上に難しい問題だということに気付きました。\u003c/p\u003e\n\n\u003ch3\u003e必須スキルと専門スキル\u003c/h3\u003e\n\n\u003cp\u003eそもそも必須スキルと専門スキルとは何か、そこの定義から考えることにしました。\u003c/p\u003e\n\n\u003cp\u003e必須スキルとは文字通り、全てのエンジニアが共通に要求されるスキルセットのことです。どちらかというと「バックエンド」「フロントエンド」といった用語で定義されるスキルセットというよりも「フィードフォースに所属するエンジニアとしての振る舞い方」ではないでしょうか。\u003c/p\u003e\n\n\u003cp\u003eそう考えながら改訂前のキャリアパスを改めて眺めていると、改訂前のキャリアパスはその振る舞いを定義していることに気付きました。その結果、改訂前のキャリアパスが必須スキルのベースとなりました。\u003c/p\u003e\n\n\u003cp\u003eそうです、キャリアパスの改訂によって、より要求水準が上がったとも言えます。\u003c/p\u003e\n\n\u003cp\u003e一方、専門スキルは、本人の得意分野、志向、特性を定義するものです。\nその志向・方向性で貢献するのであれば、各等級ごとにどの水準の成果を出すべきか。それを定義するものが専門スキルになります。\u003c/p\u003e\n\n\u003ch3\u003e専門スキルとはどうあるべきか\u003c/h3\u003e\n\n\u003cp\u003e本人の志向を定義するものが専門スキルと説明しましたが、例えばカスタマーサクセスエンジニアやエンジニアリングマネージャといった職種にしてもエンジニアの延長である以上はエンジニアとしての「共通言語」を身につけているべきです。\u003c/p\u003e\n\n\u003cp\u003eその「共通言語」とは、例えば設計力であったり、フロントエンドやバックエンドのスキルが該当します。\u003c/p\u003e\n\n\u003cp\u003eこういった知識を前提として例えば事業開発であったりチームビルディングを行うべきで、これらの知識がなければエンジニアとの「共通言語」を持っていないと判断せざるを得ません。\u003c/p\u003e\n\n\u003cp\u003e一方で、「フロントエンド力」と「バックエンド力」が同じくらい強いエンジニアというのは SSR エンジニアで、そうそう市場には存在しません。そこで、フルスタックとはいえどこかの分野に軸足を置くことができる制度というのも必須に感じました。\u003c/p\u003e\n\n\u003cp\u003eただ、ここの軸足とはあくまでも「フロントエンド」「バックエンド」「インフラ」といった区分けで、エンジニアとしてコードを書き続ける選択をするのであれば、フロントエンド/バックエンド/インフラといった区分に関係なく設計力・実装力が担保されているべきでしょう。\u003c/p\u003e\n\n\u003ch3\u003e17 の専門スキル\u003c/h3\u003e\n\n\u003cp\u003eここのバランス感が非常に難しい点でしたが、これを元に 17 の専門スキルを定義しました。\nただし、17 の専門スキルは完全に独立しているわけではなく、以下 6 つは本人の志向を定義するものとして、必ずどれか一つが必須選択としました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバックエンド\u003c/li\u003e\n\u003cli\u003eフロントエンド\u003c/li\u003e\n\u003cli\u003eデータベース\u003c/li\u003e\n\u003cli\u003e基盤\u003c/li\u003e\n\u003cli\u003eカスタマーサクセス\u003c/li\u003e\n\u003cli\u003e組織支援\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eさらに、上記のうち以下 4 つを選択した場合は「実装・設計」と呼ばれるスキルが必須となります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバックエンド\u003c/li\u003e\n\u003cli\u003eフロントエンド\u003c/li\u003e\n\u003cli\u003eデータベース\u003c/li\u003e\n\u003cli\u003e基盤\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこれにより、コードを書き続けるのであればただコードを書くだけでなく、実装力・設計力が要求される建て付けを実現しました。\u003c/p\u003e\n\n\u003cp\u003eまた、詳細は省きますが、さらにいくつかの例外を設置することで、「全ての分野で等しく強い SSR なフルスタックエンジニア」が求められないようにしています。\u003c/p\u003e\n\n\u003chr /\u003e\n\n\u003cp\u003e様々なエッジケースを考慮したせいでちょっと複雑になった感の否めない新しいキャリアパスですが、以前のものと比べるとその分より柔軟なものになったと思います。\u003c/p\u003e\n\n\u003cp\u003e今回は敢えて詳細を省きましたが、\u003ca href=\"https://engineers.recruit.feedforce.jp/#entry\"\u003eご興味をお持ちいただけたら是非カジュアル面談でねっちょりとご説明します\u003c/a\u003e！\u003c/p\u003e\n","contentSnippet":"こんにちは、meihong です。株式会社フィードフォースでは定期評価ではなく本人の希望するタイミングで評価を行う制度を導入しています。具体的には、各等級ごとに満たすべき基準・条件、またはスキルがあらかじめ提示されており、それを満たしていれば次の等級に進める制度になります。media.feedforce.jpこの基準やスキルを私たちはキャリアパスと呼んでいますが、今回、エンジニアのキャリアパスをアップデートしましたのでご紹介したいと思います。なぜキャリアパスをアップデートしたのかもともとのキャリアパスは導入当初に設計されたものをベースに、マネージャやエンジニア、新規事業向けエンジニアといった個々人の志向に応じて細分化されていました。これはこれでよくできたものだったのですが、しばらく運用している中でいくつかの課題点を感じるようになってきました。例えば、志向ごとに分かれすぎていて、志向を横断した動きが想定しづらくなった。独り立ちと判断される等級であるメンバーとその一つ上のシニアの境界に「見えない高い壁」が存在するようになった。シニア以上の等級になるとチームや会社を牽引することを求められ、技術をそれ以上深掘りすることに対して会社がどう考えているのかが見えづらくなった。といったところです。特にキャリアパス全体として、職種問わず等級が上がれば上がるほどチームや会社への影響力が求められる設計になっています。もちろんエンジニアも全体への影響力は持つべきなのですが、その持ち方は他の職種と異なり、技術力の広さ、深さといった持ち方もあるのではないかと考えるようになりました。ここで、個人的にはプロフェッショナルとしてのスキルは体積であり、その底面積はスキルの幅広さだと考えています。極端に底面積が狭いのはさすがに現時点では厳しいとは思いますが、底面積がそれなりである代わりに高さ(= 深さ)がある底面積が広い (= 引き出しが多い) 反面高さはそこまででもないの両者は体積という意味では同じはずです。この両者が共存できる余地が欲しいと考えていました。そんな中、弊社デザイナーのキャリアパスがアップデートされました。その中でも目を引いたのは、必須スキルと専門スキルという考え方です。必須スキルはデザイナーとして必ず持っていて欲しいスキルである一方、専門スキルは本人の志向、特性に応じてピックアップできるというもので、大学の専攻を思い出す建て付けでした。これをパクるこれにインスパイアされて、エンジニアのキャリアパスもアップデートすることにしました。どのように更新したのか結果から先にお伝えしておくと、大まかに以下のような方向性に改訂しました。志向ごとのキャリアパスは止めた。旧来の「志向」を専門スキルに分解し、専門スキルの組み合わせで個々人の志向・特性を表現できるようにした。等級が上がれば上がるほど満たすべき専門スキルの最低数が増えるようにした。その結果として、例えばバックエンドエンジニアに特化フルスタックエンジニアフルスタックな知識をベースに事業の 0 → 1 フェイズに参画できるエンジニアカスタマーサクセスエンジニアアジャイルコーチといった、実際に社内に存在している各エンジニアの志向や得意なポイントを表現できるようになりました。産みの苦しみここに至るまでには色々な葛藤がありました。社内の esa にキャリアパスを更新したいと宣言はしたものの、社内のエンジニア個々人の顔を思い浮かべつつ何を専門スキルとして設定するかを考えると想像以上に難しい問題だということに気付きました。必須スキルと専門スキルそもそも必須スキルと専門スキルとは何か、そこの定義から考えることにしました。必須スキルとは文字通り、全てのエンジニアが共通に要求されるスキルセットのことです。どちらかというと「バックエンド」「フロントエンド」といった用語で定義されるスキルセットというよりも「フィードフォースに所属するエンジニアとしての振る舞い方」ではないでしょうか。そう考えながら改訂前のキャリアパスを改めて眺めていると、改訂前のキャリアパスはその振る舞いを定義していることに気付きました。その結果、改訂前のキャリアパスが必須スキルのベースとなりました。そうです、キャリアパスの改訂によって、より要求水準が上がったとも言えます。一方、専門スキルは、本人の得意分野、志向、特性を定義するものです。その志向・方向性で貢献するのであれば、各等級ごとにどの水準の成果を出すべきか。それを定義するものが専門スキルになります。専門スキルとはどうあるべきか本人の志向を定義するものが専門スキルと説明しましたが、例えばカスタマーサクセスエンジニアやエンジニアリングマネージャといった職種にしてもエンジニアの延長である以上はエンジニアとしての「共通言語」を身につけているべきです。その「共通言語」とは、例えば設計力であったり、フロントエンドやバックエンドのスキルが該当します。こういった知識を前提として例えば事業開発であったりチームビルディングを行うべきで、これらの知識がなければエンジニアとの「共通言語」を持っていないと判断せざるを得ません。一方で、「フロントエンド力」と「バックエンド力」が同じくらい強いエンジニアというのは SSR エンジニアで、そうそう市場には存在しません。そこで、フルスタックとはいえどこかの分野に軸足を置くことができる制度というのも必須に感じました。ただ、ここの軸足とはあくまでも「フロントエンド」「バックエンド」「インフラ」といった区分けで、エンジニアとしてコードを書き続ける選択をするのであれば、フロントエンド/バックエンド/インフラといった区分に関係なく設計力・実装力が担保されているべきでしょう。17 の専門スキルここのバランス感が非常に難しい点でしたが、これを元に 17 の専門スキルを定義しました。ただし、17 の専門スキルは完全に独立しているわけではなく、以下 6 つは本人の志向を定義するものとして、必ずどれか一つが必須選択としました。バックエンドフロントエンドデータベース基盤カスタマーサクセス組織支援さらに、上記のうち以下 4 つを選択した場合は「実装・設計」と呼ばれるスキルが必須となります。バックエンドフロントエンドデータベース基盤これにより、コードを書き続けるのであればただコードを書くだけでなく、実装力・設計力が要求される建て付けを実現しました。また、詳細は省きますが、さらにいくつかの例外を設置することで、「全ての分野で等しく強い SSR なフルスタックエンジニア」が求められないようにしています。様々なエッジケースを考慮したせいでちょっと複雑になった感の否めない新しいキャリアパスですが、以前のものと比べるとその分より柔軟なものになったと思います。今回は敢えて詳細を省きましたが、ご興味をお持ちいただけたら是非カジュアル面談でねっちょりとご説明します！","link":"https://developer.feedforce.jp/entry/career_path_revised_2021","isoDate":"2021-05-24T02:00:00.000Z","dateMiliSeconds":1621821600000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/meihong/20210524/20210524010544.png","authorName":"feedforce"}]},"__N_SSG":true},"page":"/members/[name]","query":{"name":"feedforce"},"buildId":"LvfWKiHANYHG1L9p-H7CD","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["link",{"rel":"icon shortcut","type":"image/png","href":"https://engineers.feedforce.jp/logo.png"}],["link",{"rel":"stylesheet","href":"https://fonts.googleapis.com/css2?family=Inter:wght@400;700\u0026display=swap"}],["title",{"children":"feedforce | Feedforce Engineers' Blogs"}],["meta",{"property":"og:title","content":"feedforce"}],["meta",{"property":"og:url","content":"https://engineers.feedforce.jp/members/feedforce"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"property":"og:site","content":"Feedforce Engineers' Blogs"}],["meta",{"property":"og:image","content":"https://engineers.feedforce.jp/og.png"}],["link",{"rel":"canonical","href":"https://engineers.feedforce.jp/members/feedforce"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Feedforce Engineers' Blogs","href":"https://engineers.feedforce.jp/rss.xml"}],["link",{"rel":"alternate","type":"application/atom+xml","title":"Feedforce Engineers' Blogs","href":"https://engineers.feedforce.jp/atom.xml"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-fa276ba060a4a8ac7eef.js"></script><script src="/_next/static/chunks/main-8a83f0fd99327c4684a8.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.1daf1ec1ecf144ee9147.js" async=""></script><script src="/_next/static/chunks/commons.9e003f150a446b53bdd9.js" async=""></script><script src="/_next/static/chunks/pages/_app-99db904e083fc7f74e35.js" async=""></script><script src="/_next/static/chunks/588505f8033a39c9ef82bc46b1145ac9fd1db500.41c1f7a773377a30b183.js" async=""></script><script src="/_next/static/chunks/pages/members/%5Bname%5D-42a7756adc6c0800b4dc.js" async=""></script><script src="/_next/static/LvfWKiHANYHG1L9p-H7CD/_buildManifest.js" async=""></script><script src="/_next/static/LvfWKiHANYHG1L9p-H7CD/_ssgManifest.js" async=""></script></body></html>