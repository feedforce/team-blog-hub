<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon shortcut" type="image/png" href="https://engineers.feedforce.jp/logo.png"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&amp;display=swap"/><title>feedforce | Feedforce Engineers&#x27; Blogs</title><meta property="og:title" content="feedforce"/><meta property="og:url" content="https://engineers.feedforce.jp/members/feedforce"/><meta name="twitter:card" content="summary_large_image"/><meta property="og:site" content="Feedforce Engineers&#x27; Blogs"/><meta property="og:image" content="https://engineers.feedforce.jp/og.png"/><link rel="canonical" href="https://engineers.feedforce.jp/members/feedforce"/><link rel="alternate" type="application/rss+xml" title="Feedforce Engineers&#x27; Blogs" href="https://engineers.feedforce.jp/rss.xml"/><link rel="alternate" type="application/atom+xml" title="Feedforce Engineers&#x27; Blogs" href="https://engineers.feedforce.jp/atom.xml"/><link rel="preload" href="/_next/static/css/d7faf1fdf25fe7d3262e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d7faf1fdf25fe7d3262e.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-8a83f0fd99327c4684a8.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.1daf1ec1ecf144ee9147.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.9e003f150a446b53bdd9.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-99db904e083fc7f74e35.js" as="script"/><link rel="preload" href="/_next/static/chunks/588505f8033a39c9ef82bc46b1145ac9fd1db500.3cbfcbb348d8e2af19e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/members/%5Bname%5D-42a7756adc6c0800b4dc.js" as="script"/></head><body><div id="__next"><header class="site-header"><div class="content-wrapper"><div class="site-header__inner"><a class="site-header__logo-link" href="/"><img src="https://engineers.feedforce.jp/logo.svg" alt="Feedforce Engineers&#x27; Blogs" class="site-header__logo-img"/></a><div class="site-header__links"><a href="https://feedforcegroup.jp" class="site-header__link">Company</a><a href="https://github.com/feedforce" class="site-header__link">GitHub</a><a href="https://engineers.recruit.feedforce.jp" class="site-header__link">Recruit</a></div></div></div></header><section class="member"><div class="content-wrapper"><header class="member-header"><div class="member-header__avatar"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" alt="feedforce" width="100" height="100" class="member-header__avatar-img"/></div><h1 class="member-header__name">feedforce</h1><p class="member-header__bio">Feedforce Developer Blog</p><div class="member-header__links"></div></header><div class="member-posts-container"><div class="post-list"><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2022-12-16T14:57:31.000Z" class="post-link__date">10 days ago</time></div></a><a href="https://developer.feedforce.jp/entry/2022/12/16/235731" class="post-link__main-link"><h2 class="post-link__title">【約 50 回】2022 年、家族で毎週ふりかえりをした話</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-11-05T00:50:50.000Z" class="post-link__date">a year ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/11/05/095050" class="post-link__main-link"><h2 class="post-link__title">GitHub Packages を使ってプライベート gem を社内限定で公開した</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-09-02T04:47:25.000Z" class="post-link__date">a year ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/09/02/134725" class="post-link__main-link"><h2 class="post-link__title">Amazon EKS で高負荷時に CoreDNS が原因で稀にネットワークエラーが発生していた時のトラブルシュート</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-07-07T01:39:17.000Z" class="post-link__date">a year ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/07/07/103917" class="post-link__main-link"><h2 class="post-link__title">Firestore エミュレーターを使ったテスト同士の競合が起きないようにしていい感じにテストできるようにした話</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-06-11T07:42:53.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/06/11/164253" class="post-link__main-link"><h2 class="post-link__title">【2021年夏】半期に1度の Engineer’s Principles Award 受賞者を紹介します</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-05-31T01:48:13.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/2021/05/31/104813" class="post-link__main-link"><h2 class="post-link__title">プランニングの難しさを乗り越えて...スクラム開発が良い感じになった話</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/feedforce"><img src="https://engineers.feedforce.jp/avatars/feedforce.jpg" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">feedforce</div><time dateTime="2021-05-24T02:00:00.000Z" class="post-link__date">2 years ago</time></div></a><a href="https://developer.feedforce.jp/entry/career_path_revised_2021" class="post-link__main-link"><h2 class="post-link__title">エンジニアキャリアパスをアップデートしました</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=developer.feedforce.jp" width="14" height="14" class="post-link__site-favicon"/>developer.feedforce.jp</div></a></article></div></div></div></section><footer class="site-footer"><div class="content-wrapper"><p>© <!-- -->Feedforce Group Inc.</p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"member":{"name":"feedforce","bio":"Feedforce Developer Blog","avatarSrc":"/avatars/feedforce.jpg","sources":["https://developer.feedforce.jp/rss"]},"postItems":[{"title":"【約 50 回】2022 年、家族で毎週ふりかえりをした話","content":"\u003cp\u003eこの記事は、Feedforce Group Advent Calendar 2022 の16日目の記事です。\u003c/p\u003e\n\n\u003ciframe src=\"https://adventar.org/calendars/7898/embed\" width=\"620\" height=\"450\" frameborder=\"0\" loading=\"lazy\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003e昨日は、アナグラム田中さんによる「クラス制のキャラ育成ができるRPGってキャリア形成のそれと似ているな...って思っただけの話」でした！\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fnote.com%2Fhyroki1980%2Fn%2Fn2f4ff15b1848\" title=\"クラス制のキャラ育成ができるRPGってキャリア形成のそれと似ているな...って思っただけの話｜Hiroki Tanaka｜note\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\" loading=\"lazy\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://note.com/hyroki1980/n/n2f4ff15b1848\"\u003enote.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e私はつい最近、フロントエンドエンジニアからスクラムマスターに社内で「転職（ドラクエ的表現）」したところでして、学生時代のアルバイトで貯めていた経験なんかが意外なところで活きたなぁと感じていたところがあったため、とてもしっくりくる内容でした！\u003c/p\u003e\n\n\u003cp\u003eまた、運用型広告というジョブのアビリティの豊富さ・プレイスタイルの幅広さが視覚的に表現されており、運用型広告というジョブの魅力がガッツリ伝わってきました。\u003cbr/\u003e\n余談ですが、自分も赤魔道士大好きです。\u003c/p\u003e\n\n\u003cp\u003e何の話なんだろう？と思った未読の方、是非本文を楽しんでください！\u003c/p\u003e\n\n\u003ch2 id=\"まえがき\"\u003eまえがき\u003c/h2\u003e\n\n\u003cp\u003e本記事では、この 1 年間家族でやってきたふりかえりについて書きます。\u003cbr/\u003e\nまずは 3 行で記事を紹介します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e2022 年、家族で毎週ふりかえりをした\u003c/li\u003e\n\u003cli\u003eふりかえりをすると、たくさんいいことがあった\u003c/li\u003e\n\u003cli\u003eたくさんの課題があり、工夫して乗り越えた\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこの記事は「家族のふりかえり」にフォーカスしたものですが、家族以外の親密な人とのふりかえりや、自分ひとりのふりかえりをしたい方にも届けたいと思って書きました。\u003cbr/\u003e\n個人のふりかえりとしても適用できます（「よかったこと」の「問題を共有できる」は軽く読み流してください）ので、よかったら読んでみてください。\u003c/p\u003e\n\n\u003ch2 id=\"はじめに\"\u003eはじめに\u003c/h2\u003e\n\n\u003ch3 id=\"自己紹介\"\u003e自己紹介\u003c/h3\u003e\n\n\u003cp\u003eこんにちは、はじめまして。 @zomysan と申します。\u003cbr/\u003e\nソーシャル PLUS のスクラムマスターです。\u003c/p\u003e\n\n\u003cp\u003e弊社は東京にオフィスのある会社ですが、私は関西からフルリモートで勤務しています。\u003cbr/\u003e\nフルリモートもスクラムマスターも初めての経験ですが、チームの方々に支えられ、毎日楽しく働いています！\u003c/p\u003e\n\n\u003ch3 id=\"家族について\"\u003e家族について\u003c/h3\u003e\n\n\u003cp\u003e二人暮らしです。同い年で、ゲーム、絵を描く、お菓子を食べるなど共通の趣味が多く仲良しです。\u003cbr/\u003e\n一緒に暮らし始めて今年で 9 年目になります。犬と猫が飼えるところへ引っ越すことがいまの一番の目標です。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e自分: \u003ca href=\"https://twitter.com/zomysan\"\u003e@zomysan\u003c/a\u003e\n\n\u003cul\u003e\n\u003cli\u003e犬好き\u003c/li\u003e\n\u003cli\u003e個人開発プロダクトを開発中\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e家族\n\n\u003cul\u003e\n\u003cli\u003e猫好き\u003c/li\u003e\n\u003cli\u003eWeb エンジニアを目指し勉強中\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch3 id=\"ふりかえりのきっかけ\"\u003eふりかえりのきっかけ\u003c/h3\u003e\n\n\u003cp\u003e2022 年 1 月、それぞれの 1 年の目標を立てました。\u003cbr/\u003e\n2021 年までも目標を立ててはいたのですが、毎年毎年日常を過ごすうちに目標について忘れてしまっていました。今年はなにかしら成し遂げたいと思い、私から毎週のふりかえりの実施を提案したところ家族も快諾してくれたため、実施することにしました。\u003c/p\u003e\n\n\u003ch2 id=\"ふりかえりの内容\"\u003eふりかえりの内容\u003c/h2\u003e\n\n\u003cp\u003e実施しているふりかえりについて紹介します。\u003c/p\u003e\n\n\u003ch3 id=\"いつどれくらいやるか\"\u003eいつどれくらいやるか\u003c/h3\u003e\n\n\u003cp\u003e毎週土曜日午前、2 時間の開催としています。\u003cbr/\u003e\n毎週 2 時間と表現すると重たく感じますが、雑談やコミュニケーションを兼ねた時間なので、いまのところ家族間での合意はできています。\u003c/p\u003e\n\n\u003ch3 id=\"ふりかえりの目的\"\u003eふりかえりの目的\u003c/h3\u003e\n\n\u003cp\u003eわが家では、ふりかえりの目的を下記のとおり定めています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eありたい姿に向かって、自分がどれくらい進んだのか？\u003c/li\u003e\n\u003cli\u003eありたい姿に向かって、正しい方向に進めているのか？\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e「ありたい姿」というと何やら大袈裟な感じがしますが、大層なものでなくても構わないです。\u003cbr/\u003e\nたとえば、「できるだけ健康で、美味しいものを食べる自分」「スプラトゥーンがうまい自分」「できる限りしんどいことはしたくない」みたいなものは、全部「ありたい姿」のひとつです。\u003cbr/\u003e\nこういう感じなら、誰しも「ありたい姿」を持っているのではないでしょうか？\u003c/p\u003e\n\n\u003cp\u003eふりかえりをすることで、自分の生活と「ありたい姿」のギャップを確認し、そこを目指すための軌道修正ができます。\nわが家では週に 1 度ふりかえりをしているので、「ありたい姿」を目指すための軌道修正が毎週できているということになります。\u003c/p\u003e\n\n\u003ch3 id=\"YKPT--ファイブフィンガー\"\u003eYKPT + ファイブフィンガー\u003c/h3\u003e\n\n\u003cp\u003eいわゆる「YKPT」という方法を少しアレンジし、ふりかえりをおこなっています。\u003c/p\u003e\n\n\u003cp\u003eYKPT の詳細は省きますが、客観的事実のみから成る「やったこと(Y)」、「やったこと」に基づく「よかったこと（Keep）」、「改善したいこと（Problem）」を書き出し、それに基づいて「次やること（Try）」を決めるという手法です。\u003c/p\u003e\n\n\u003cp\u003eまた、ファイブフィンガーという手法で、ふりかえりのふりかえりをおこなっています。\u003cbr/\u003e\nふりかえりについてもカイゼンを繰り返し、次の週はもっとよいふりかえりができるようにしたいと考えています。\u003c/p\u003e\n\n\u003cp\u003eこれらと併せて、家計簿等を見返す「お金のふりかえり」、アプリの利用時間やゲームのプレイ時間等を見返す「時間のふりかえり」もやっているのですが、今回はこれらについての詳細は省きます。\u003c/p\u003e\n\n\u003ch3 id=\"実際の様子\"\u003e実際の様子\u003c/h3\u003e\n\n\u003cp\u003e実際のふりかえりの様子をスクリーンショットですこし紹介します。これは「やったこと」「よかったこと」「改善したいこと」の一部が見えています。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/z/zomysan/20221217/20221217004703.png\" width=\"1200\" height=\"900\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch2 id=\"ふりかえりをしてよかったこと\"\u003eふりかえりをしてよかったこと\u003c/h2\u003e\n\n\u003cp\u003eさて、ここまではふりかえりの概要を紹介してきました。ここからいよいよ、約50回のふりかえりから得た経験について紹介していきます！\u003cbr/\u003e\nまずは、ふりかえりをしてよかったことについて挙げます。\u003c/p\u003e\n\n\u003ch3 id=\"問題を共有できる\"\u003e問題を共有できる\u003c/h3\u003e\n\n\u003cp\u003e一緒に暮らしていると、ちょっとした困りごとや、変えてもらうようお願いしたいことが出てくるものですよね。\u003cbr/\u003e\nわが家ではふりかえりの場がそういった「問題」を共有する場所として機能しています。\u003c/p\u003e\n\n\u003cp\u003e「いまは改善したいことを挙げる時間ですよ」と区切られていることで、ちょっと言い出しにくいことも表現しやすいです。「発生した課題と解決方法」で詳しくお話ししますが、言い出しにくいことを言い出すための工夫もしています。\u003c/p\u003e\n\n\u003cp\u003e1 年のふりかえりを通して、どういう課題であっても、「相手を責めたり押し付けたりするのではなく、解決方法について一緒に真剣に考える」ことで解決することを信じ、安心して話せるようになりました。このことで、さらに「改善したいこと」が出てきやすくなり、カイゼンにつながっています。\u003c/p\u003e\n\n\u003ch3 id=\"課題が解決する\"\u003e課題が解決する\u003c/h3\u003e\n\n\u003cp\u003eふりかえりをせずに過ごしていると、困っていることがあってもなんとなくそのまま過ごしてしまいます。ふりかえりで「改善したいこと」「困っていること」をあらためて書き出すことで、すぐに対応できます。\u003cbr/\u003e\nたとえば、「寒くて目が覚める」という課題を数年間見過ごしてきたのですが、今年は敷く毛布を買って対応できました。\u003c/p\u003e\n\n\u003cp\u003eそのほかには、「本を読む時間が 0 分だった」という客観的事実から、「寝る前に本を読む時間をとる」という改善すべきことが見つかりました。\u003cbr/\u003e\nこれに対し、「自由時間を就寝時間ギリギリまでではなく、30 分前までとする」という行動をとり、無事に 1 週間に数時間の読書時間を確保できるようになりました。\u003c/p\u003e\n\n\u003ch3 id=\"悩まなくていい悩みを捨てられる\"\u003e悩まなくていい悩みを捨てられる\u003c/h3\u003e\n\n\u003cp\u003e「課題が解決する」では、本を読む時間を確保できるようになったことについてお話ししました。\u003cbr/\u003e\nじつはその後私に起きたことなのですが、個人開発の時間が膨らんで読書時間が減っていってしまいました。個人開発の時間を削ることについても考えたのですが、「いまは読書よりも開発の時間をとることを優先したい」と考えている自分に気づきました。読書できていないことで悩まなくていいのだと、漠然と持っていた「できていない気持ち」を捨てることができました。\u003c/p\u003e\n\n\u003cp\u003e日常を過ごしていると、ついあれもこれもと考えてしまいがちです。ふりかえりの場で自分の優先順位を確認することで、自分が本当に集中したいこととそうでないことを振り分け、優先度の低いことに心を煩わされないようにしたいですね。\u003c/p\u003e\n\n\u003cp\u003eそれはそうとして、なんとかして読書の時間は確保したいものです。明日の家族会議で話してもいいかもしれません。\u003c/p\u003e\n\n\u003ch3 id=\"出来事が蓄積される\"\u003e出来事が蓄積される\u003c/h3\u003e\n\n\u003cp\u003e「やったこと」でその週にあったことを客観的事実として挙げます。これは、「よかったこと」「改善したいこと」につなげるための思い出しなのですが、挙げた「やったこと」自体にも価値があると感じます。\u003c/p\u003e\n\n\u003cp\u003e書いたカードは、すべてとっておき、ふりかえりをした順番に蓄積していきます。そうすると、楽しかったお出かけや、美味しかった自炊、外食、達成したことや困ったことなど、さまざまな「今年 1 年あったこと」のまとめになります。\u003c/p\u003e\n\n\u003cp\u003eもうすぐ年末休みなので、我が家でも家族で 1 年分の「あったこと」をまとめて見返す予定です。とても楽しみです！\u003c/p\u003e\n\n\u003ch2 id=\"発生した課題と解決方法\"\u003e発生した課題と解決方法\u003c/h2\u003e\n\n\u003cp\u003eここまでふりかえりの良かったところについて書きましたが、楽にこれらを得たわけではありませんでした。\u003c/p\u003e\n\n\u003cp\u003eふりかえりをやっていくと、大小さまざまな課題が発生します。\u003cbr/\u003e\nその中でもインパクトが大きかったものについて、どういう課題だったか、どのように解決したのかを紹介します。\u003c/p\u003e\n\n\u003ch3 id=\"決めた次やることを忘れてしまう\"\u003e決めた「次やること」を忘れてしまう\u003c/h3\u003e\n\n\u003cp\u003eせっかく「次やること」を決めてリストにしたのに、すっかり忘れたまま 1 週間を過ごす。\u003cbr/\u003e\nそして、次週のふりかえりの開始時「こんなのあったな……」と呆然とリストを眺める、ということがありました。\u003c/p\u003e\n\n\u003ch4 id=\"-解決方法-朝会を実施\"\u003e→ 解決方法: 朝会を実施\u003c/h4\u003e\n\n\u003cp\u003e「次やること」で決めたことを守れているか、やると決めたタスクはこなせているかを確認するため、朝にも短い家族会議をすることに決めました。わが家ではそのまま朝会と呼んでいます。\u003c/p\u003e\n\n\u003cp\u003e朝会で「次やること」を確認することで、日常のなにかを変えるような取り組み（「水をしっかり飲むためにお湯を 10 時に沸かす」など）についてあらためて認識できます。また、タスク的な取り組み（「敷き毛布を買う」「保温ケトルを買う」など）についても、その日の TODO に落とし込むなどして 1 週間のうちに確実に消化しきることができるようになりました。\u003c/p\u003e\n\n\u003cp\u003e余談ではありますが、朝会ではふりかえりの「次やること」の確認に加え、以下のような取り組みもやっています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e直近の家族の目標を確認\u003c/li\u003e\n\u003cli\u003e当日・直近のスケジュール確認\u003c/li\u003e\n\u003cli\u003eそれぞれの「今日の TODO」を付箋に書く\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこれも朝会をやっていく過程で試行錯誤があり、ふりかえりを通して今の形になりました。\u003c/p\u003e\n\n\u003ch3 id=\"改善したいことの話し合いが精神的につらくなる\"\u003e「改善したいこと」の話し合いが精神的につらくなる\u003c/h3\u003e\n\n\u003cp\u003e「改善したいこと」の深掘りではお互いにマイナスのフィードバックをするような場面も多く、「えっ」「いやいや」と言いたい気持ちになる場面もあります。\u003cbr/\u003e\nもちろん「改善したいこと」について話すわけだから、重たい話になって当然です。しかしあまりにも重いムードが続くと、ふりかえり自体に悪いイメージ・忌避感を持ち、ふりかえり自体から遠ざかってしまいます。\u003c/p\u003e\n\n\u003ch4 id=\"-解決方法-おやつ休憩を挟む\"\u003e→ 解決方法: おやつ休憩を挟む\u003c/h4\u003e\n\n\u003cp\u003e現在、わが家の「改善したいこと」を話す流れは以下のようになりました。\u003cbr/\u003e\nまず「改善したいこと」を各々がカードに書いたら、お互いにコメントをテキストで書きます。そして「おやつ休憩」を挟み、そのあと深掘りの会話をします。\u003c/p\u003e\n\n\u003cp\u003eおやつは血糖値を上げて脳の栄養になってくれそうな甘いものを選びます。紅茶やコーヒーなど、用意していたおやつに合いそうな飲み物もふたりで一緒に用意します。\u003c/p\u003e\n\n\u003cp\u003eまず文章で見て、自分なりに受け止める時間があり、楽しいおやつの時間も挟むので、反射的に言い返すことから喧嘩になる可能性が大幅に下がります。そのころには、最初に感じた「えっ」という衝撃はずいぶん和らいでいます。\u003c/p\u003e\n\n\u003cp\u003e余談ですが、元気なうちに「改善したいこと」の話を済ませてしまうという解決方法もあるかもしれません。わが家では「その週のふりかえりで食べるお菓子を選ぶ」という楽しいイベントが一つ加わり、ふりかえりの時間が楽しみになるという嬉しい副作用もあったので、今のやり方を続けています。\u003c/p\u003e\n\n\u003ch3 id=\"ふりかえりへの取り組み方に差が出てしまう\"\u003eふりかえりへの取り組み方に差が出てしまう\u003c/h3\u003e\n\n\u003cp\u003e一緒にやると決めたふりかえりですが、お互いがずっと高いモチベーションで取り組めていたわけではありません。\u003cbr/\u003e\nやりたいことがあるときや、ちょっと気になってることがあるとき、単純に疲れているときなど、ふりかえりの場に集中できていないこともありました。\u003c/p\u003e\n\n\u003cp\u003e「ちゃんとやってよ」と言い合うのは簡単ですが、集中できないのは集中できないなりの理由があるということです。ただ、これではせっかくのふりかえりの質が保てませんし、最悪ふりかえりのせいで言い争いが起きてしまいます。\u003c/p\u003e\n\n\u003ch4 id=\"-解決方法-ふりかえりについてふりかえりあらためてふりかえりの意義を共有する\"\u003e→ 解決方法: ふりかえりについてふりかえり、あらためてふりかえりの意義を共有する\u003c/h4\u003e\n\n\u003cp\u003eどうすべきなのか、一旦休んだほうがいいのかな、と思っていたところ、2022 年に開催された\u003ca href=\"https://www.scrumosaka.org/\"\u003eスクラムフェス大阪\u003c/a\u003eで、とてもタイムリーなセッションに出会いました。\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003e\u003ca href=\"https://confengine.com/conferences/scrum-fest-osaka-2022/proposal/16535\"\u003eふりかえりをふりかえるための「ふりかえりチェックシート」を使ってふりかえろう！\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003eこのセッションで紹介されたのは、ふりかえりがうまくいっているのかをさまざまな観点からチェックし、話し合うためのチェックシートです。ぜひ一度\u003ca href=\"https://miro.com/miroverse/retrospective-check-sheet-japanese/\"\u003eこちら\u003c/a\u003eからシートの現物をごらんいただきたいです。\u003c/p\u003e\n\n\u003cp\u003eわが家でも、このチェックシートにふたりで取り組みました。\u003cbr/\u003e\nまずは各自でチェックシートを埋めていきます。書き終わったら、ひとつずつ結果を共有していきました。一致しているものもあれば、そうでないものもありました。お互いの抱えていた課題感を共有し、議論し、解決のためにいくつかのアクションが決まりました。ふりかえりに感じていたモヤモヤが解消され、より雰囲気よくふりかえりに取り組めるようになりました。\u003c/p\u003e\n\n\u003cp\u003eしかし、シートの効果はそれだけではありませんでした。このシートのチェック項目は、場づくり、アイデア出し、思い出しといった「ふりかえりの要素」ごとに整理されています。\u003cbr/\u003e\nそして、「なぜその要素がふりかえりに重要なのか」「その要素がふりかえりにどう影響をあたえるのか」といった解説が併記されています。\u003cbr/\u003e\nこの解説を読みながら自分たちのふりかえりをふりかえり、議論したことで、二人のあいだで「質の高いふりかえりに何が重要なのか」についての共通認識を持てたことが一番の収穫だったように思います。\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eふりかえりをしてよかったことをまとめます。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e問題を家族で共有できる\u003c/li\u003e\n\u003cli\u003e課題が解決する\u003c/li\u003e\n\u003cli\u003e悩まなくていい悩みを捨てられる\u003c/li\u003e\n\u003cli\u003e出来事が蓄積される\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eまた、ふりかえりをよいものにするために取り組んだことは以下のとおりです。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eふりかえったことは、毎日確認する機会をつくる\u003c/li\u003e\n\u003cli\u003eふりかえり自体のふりかえりもする\u003c/li\u003e\n\u003cli\u003eごきげんでいるために、おやつ休憩を挟む\u003c/li\u003e\n\u003cli\u003eありたい姿を認識する\u003c/li\u003e\n\u003cli\u003eふりかえりの意義を共有する\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e長い記事を読んでいただき、感謝しかありません。\u003cbr/\u003e\n今思い返すと、家族でやってきたことが、この冬からはじめたスクラムマスターとしての仕事にも活かせているのではないかと思っています。\u003c/p\u003e\n\n\u003cp\u003e2023 年、プライベートについてもふりかえりをはじめてみませんか？\u003c/p\u003e\n\n\u003cp\u003eTwitter でもふりかえりのことなど発信していきたいと思っていますので、興味があれば是非そちらもチェックしていただければと思います！\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://twitter.com/zomysan\"\u003ehttps://twitter.com/zomysan\u003c/a\u003e\u003c/p\u003e\n","contentSnippet":"この記事は、Feedforce Group Advent Calendar 2022 の16日目の記事です。昨日は、アナグラム田中さんによる「クラス制のキャラ育成ができるRPGってキャリア形成のそれと似ているな...って思っただけの話」でした！note.com私はつい最近、フロントエンドエンジニアからスクラムマスターに社内で「転職（ドラクエ的表現）」したところでして、学生時代のアルバイトで貯めていた経験なんかが意外なところで活きたなぁと感じていたところがあったため、とてもしっくりくる内容でした！また、運用型広告というジョブのアビリティの豊富さ・プレイスタイルの幅広さが視覚的に表現されており、運用型広告というジョブの魅力がガッツリ伝わってきました。何の話なんだろう？と思った未読の方、是非本文を楽しんでください！まえがき本記事では、この 1 年間家族でやってきたふりかえりについて書きます。2022 年、家族で毎週ふりかえりをしたふりかえりをすると、たくさんいいことがあったたくさんの課題があり、工夫して乗り越えたこの記事は「家族のふりかえり」にフォーカスしたものですが、家族以外の親密な人とのふりかえりや、自分ひとりのふりかえりをしたい方にも届けたいと思って書きました。はじめに自己紹介こんにちは、はじめまして。 @zomysan と申します。弊社は東京にオフィスのある会社ですが、私は関西からフルリモートで勤務しています。家族について二人暮らしです。同い年で、ゲーム、絵を描く、お菓子を食べるなど共通の趣味が多く仲良しです。自分: @zomysan犬好き個人開発プロダクトを開発中家族猫好きWeb エンジニアを目指し勉強中ふりかえりのきっかけ2022 年 1 月、それぞれの 1 年の目標を立てました。ふりかえりの内容実施しているふりかえりについて紹介します。いつどれくらいやるか毎週土曜日午前、2 時間の開催としています。ふりかえりの目的わが家では、ふりかえりの目的を下記のとおり定めています。ありたい姿に向かって、自分がどれくらい進んだのか？ありたい姿に向かって、正しい方向に進めているのか？「ありたい姿」というと何やら大袈裟な感じがしますが、大層なものでなくても構わないです。ふりかえりをすることで、自分の生活と「ありたい姿」のギャップを確認し、そこを目指すための軌道修正ができます。わが家では週に 1 度ふりかえりをしているので、「ありたい姿」を目指すための軌道修正が毎週できているということになります。YKPT + ファイブフィンガーいわゆる「YKPT」という方法を少しアレンジし、ふりかえりをおこなっています。YKPT の詳細は省きますが、客観的事実のみから成る「やったこと(Y)」、「やったこと」に基づく「よかったこと（Keep）」、「改善したいこと（Problem）」を書き出し、それに基づいて「次やること（Try）」を決めるという手法です。また、ファイブフィンガーという手法で、ふりかえりのふりかえりをおこなっています。これらと併せて、家計簿等を見返す「お金のふりかえり」、アプリの利用時間やゲームのプレイ時間等を見返す「時間のふりかえり」もやっているのですが、今回はこれらについての詳細は省きます。実際の様子実際のふりかえりの様子をスクリーンショットですこし紹介します。これは「やったこと」「よかったこと」「改善したいこと」の一部が見えています。ふりかえりをしてよかったことさて、ここまではふりかえりの概要を紹介してきました。ここからいよいよ、約50回のふりかえりから得た経験について紹介していきます！問題を共有できる一緒に暮らしていると、ちょっとした困りごとや、変えてもらうようお願いしたいことが出てくるものですよね。「いまは改善したいことを挙げる時間ですよ」と区切られていることで、ちょっと言い出しにくいことも表現しやすいです。「発生した課題と解決方法」で詳しくお話ししますが、言い出しにくいことを言い出すための工夫もしています。1 年のふりかえりを通して、どういう課題であっても、「相手を責めたり押し付けたりするのではなく、解決方法について一緒に真剣に考える」ことで解決することを信じ、安心して話せるようになりました。このことで、さらに「改善したいこと」が出てきやすくなり、カイゼンにつながっています。課題が解決するふりかえりをせずに過ごしていると、困っていることがあってもなんとなくそのまま過ごしてしまいます。ふりかえりで「改善したいこと」「困っていること」をあらためて書き出すことで、すぐに対応できます。そのほかには、「本を読む時間が 0 分だった」という客観的事実から、「寝る前に本を読む時間をとる」という改善すべきことが見つかりました。悩まなくていい悩みを捨てられる「課題が解決する」では、本を読む時間を確保できるようになったことについてお話ししました。日常を過ごしていると、ついあれもこれもと考えてしまいがちです。ふりかえりの場で自分の優先順位を確認することで、自分が本当に集中したいこととそうでないことを振り分け、優先度の低いことに心を煩わされないようにしたいですね。それはそうとして、なんとかして読書の時間は確保したいものです。明日の家族会議で話してもいいかもしれません。出来事が蓄積される「やったこと」でその週にあったことを客観的事実として挙げます。これは、「よかったこと」「改善したいこと」につなげるための思い出しなのですが、挙げた「やったこと」自体にも価値があると感じます。書いたカードは、すべてとっておき、ふりかえりをした順番に蓄積していきます。そうすると、楽しかったお出かけや、美味しかった自炊、外食、達成したことや困ったことなど、さまざまな「今年 1 年あったこと」のまとめになります。もうすぐ年末休みなので、我が家でも家族で 1 年分の「あったこと」をまとめて見返す予定です。とても楽しみです！発生した課題と解決方法ここまでふりかえりの良かったところについて書きましたが、楽にこれらを得たわけではありませんでした。ふりかえりをやっていくと、大小さまざまな課題が発生します。決めた「次やること」を忘れてしまうせっかく「次やること」を決めてリストにしたのに、すっかり忘れたまま 1 週間を過ごす。→ 解決方法: 朝会を実施「次やること」で決めたことを守れているか、やると決めたタスクはこなせているかを確認するため、朝にも短い家族会議をすることに決めました。わが家ではそのまま朝会と呼んでいます。朝会で「次やること」を確認することで、日常のなにかを変えるような取り組み（「水をしっかり飲むためにお湯を 10 時に沸かす」など）についてあらためて認識できます。また、タスク的な取り組み（「敷き毛布を買う」「保温ケトルを買う」など）についても、その日の TODO に落とし込むなどして 1 週間のうちに確実に消化しきることができるようになりました。余談ではありますが、朝会ではふりかえりの「次やること」の確認に加え、以下のような取り組みもやっています。直近の家族の目標を確認当日・直近のスケジュール確認それぞれの「今日の TODO」を付箋に書くこれも朝会をやっていく過程で試行錯誤があり、ふりかえりを通して今の形になりました。「改善したいこと」の話し合いが精神的につらくなる「改善したいこと」の深掘りではお互いにマイナスのフィードバックをするような場面も多く、「えっ」「いやいや」と言いたい気持ちになる場面もあります。→ 解決方法: おやつ休憩を挟む現在、わが家の「改善したいこと」を話す流れは以下のようになりました。おやつは血糖値を上げて脳の栄養になってくれそうな甘いものを選びます。紅茶やコーヒーなど、用意していたおやつに合いそうな飲み物もふたりで一緒に用意します。まず文章で見て、自分なりに受け止める時間があり、楽しいおやつの時間も挟むので、反射的に言い返すことから喧嘩になる可能性が大幅に下がります。そのころには、最初に感じた「えっ」という衝撃はずいぶん和らいでいます。余談ですが、元気なうちに「改善したいこと」の話を済ませてしまうという解決方法もあるかもしれません。わが家では「その週のふりかえりで食べるお菓子を選ぶ」という楽しいイベントが一つ加わり、ふりかえりの時間が楽しみになるという嬉しい副作用もあったので、今のやり方を続けています。ふりかえりへの取り組み方に差が出てしまう一緒にやると決めたふりかえりですが、お互いがずっと高いモチベーションで取り組めていたわけではありません。「ちゃんとやってよ」と言い合うのは簡単ですが、集中できないのは集中できないなりの理由があるということです。ただ、これではせっかくのふりかえりの質が保てませんし、最悪ふりかえりのせいで言い争いが起きてしまいます。→ 解決方法: ふりかえりについてふりかえり、あらためてふりかえりの意義を共有するどうすべきなのか、一旦休んだほうがいいのかな、と思っていたところ、2022 年に開催されたスクラムフェス大阪で、とてもタイムリーなセッションに出会いました。ふりかえりをふりかえるための「ふりかえりチェックシート」を使ってふりかえろう！このセッションで紹介されたのは、ふりかえりがうまくいっているのかをさまざまな観点からチェックし、話し合うためのチェックシートです。ぜひ一度こちらからシートの現物をごらんいただきたいです。わが家でも、このチェックシートにふたりで取り組みました。しかし、シートの効果はそれだけではありませんでした。このシートのチェック項目は、場づくり、アイデア出し、思い出しといった「ふりかえりの要素」ごとに整理されています。まとめふりかえりをしてよかったことをまとめます。問題を家族で共有できる課題が解決する悩まなくていい悩みを捨てられる出来事が蓄積されるまた、ふりかえりをよいものにするために取り組んだことは以下のとおりです。ふりかえったことは、毎日確認する機会をつくるふりかえり自体のふりかえりもするごきげんでいるために、おやつ休憩を挟むありたい姿を認識するふりかえりの意義を共有する長い記事を読んでいただき、感謝しかありません。2023 年、プライベートについてもふりかえりをはじめてみませんか？Twitter でもふりかえりのことなど発信していきたいと思っていますので、興味があれば是非そちらもチェックしていただければと思います！https://twitter.com/zomysan","link":"https://developer.feedforce.jp/entry/2022/12/16/235731","isoDate":"2022-12-16T14:57:31.000Z","dateMiliSeconds":1671202651000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/z/zomysan/20221217/20221217004703.png","authorName":"feedforce"},{"title":"GitHub Packages を使ってプライベート gem を社内限定で公開した","content":"\u003cp\u003eこんにちは、\u003ca href=\"http://blog.hatena.ne.jp/daido1976/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/daido1976/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:daido1976\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e先日 GitHub Packages を使ってプライベート gem を社内限定で公開したので、その方法をご紹介します。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#GitHub-Packages-とは\"\u003eGitHub Packages とは\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#既存のプライベート-gem-と-GitHub-Packages-との違い\"\u003e既存のプライベート gem と GitHub Packages との違い\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#GitHub-Packages-を使ってプライベート-gem-を社内限定で公開する\"\u003eGitHub Packages を使ってプライベート gem を社内限定で公開する\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#gem-をリリースPublishする方法\"\u003egem をリリース（Publish）する方法\u003c/a\u003e\u003cul\u003e\n                    \u003cli\u003e\u003ca href=\"#ローカルからリリースする\"\u003eローカルからリリースする\u003c/a\u003e\u003c/li\u003e\n                    \u003cli\u003e\u003ca href=\"#CI-からリリースする\"\u003eCI からリリースする\u003c/a\u003e\u003c/li\u003e\n                \u003c/ul\u003e\n            \u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#各環境へのインストール方法\"\u003e各環境へのインストール方法\u003c/a\u003e\u003cul\u003e\n                    \u003cli\u003e\u003ca href=\"#ローカルや本番環境でのインストール\"\u003eローカルや本番環境でのインストール\u003c/a\u003e\u003c/li\u003e\n                    \u003cli\u003e\u003ca href=\"#Dependabot-でのインストール\"\u003eDependabot でのインストール\u003c/a\u003e\u003c/li\u003e\n                \u003c/ul\u003e\n            \u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#関連記事\"\u003e関連記事\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"GitHub-Packages-とは\"\u003eGitHub Packages とは\u003c/h2\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.co.jp%2Ffeatures%2Fpackages\" title=\"Packages\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://github.co.jp/features/packages\"\u003egithub.co.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eGitHub Packages はライブラリ（パッケージ）のホスティングサービスです。\u003c/p\u003e\n\n\u003cp\u003eRuby の場合 \u003ccode\u003ehttps://rubygems.org\u003c/code\u003e の代わりに \u003ccode\u003ehttps://rubygems.pkg.github.com\u003c/code\u003e に公開するイメージで、認証には GitHub の personal access token などを使います。\u003c/p\u003e\n\n\u003ch2 id=\"既存のプライベート-gem-と-GitHub-Packages-との違い\"\u003e既存のプライベート gem と GitHub Packages との違い\u003c/h2\u003e\n\n\u003cp\u003e既存のプライベート gem は主に git のタグやブランチを指定する方法が用いられますが、以下のようにいくつかの問題があります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# main ブランチの先端を使うのは再現性がない（ブランチ指定した場合も同じ）\u003c/span\u003e\ngem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003egithub\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_name/my_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e# タグを指定しても書き換えられる可能性がある\u003c/span\u003e\ngem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003egithub\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_name/my_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003etag\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ev1.0.0\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e# コミットの参照を指定するのはシンプルに見づらい\u003c/span\u003e\ngem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003egithub\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003emy_name/my_rubygem\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synConstant\"\u003eref\u003c/span\u003e: \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e4aded\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eGitHub Packages は \u003ccode\u003erubygems.org\u003c/code\u003e と同じように、バージョン指定が明確かつ一度リリースしたバージョンは変更できないので安全です。\u003c/p\u003e\n\n\u003ch2 id=\"GitHub-Packages-を使ってプライベート-gem-を社内限定で公開する\"\u003eGitHub Packages を使ってプライベート gem を社内限定で公開する\u003c/h2\u003e\n\n\u003cp\u003eここからは実際に GitHub Packages を使ってプライベート gem を社内限定で公開する方法（主にリリースとインストールの仕方）を説明していきます。\u003c/p\u003e\n\n\u003cp\u003e今回は Organization は \u003ccode\u003efeedforce\u003c/code\u003e、gem の名前は \u003ccode\u003esocialplus-rails\u003c/code\u003e という想定です。\u003c/p\u003e\n\n\u003cp\u003e日本語版のドキュメントは文章やサンプルコードが古いケースがあるので、以下の英語版ドキュメントを参照した方が良いです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry\"\u003eWorking with the RubyGems registry - GitHub Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e認証に使う personal access token の権限については以下のドキュメントが詳しいです。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.github.com/en/packages/learn-github-packages/about-permissions-for-github-packages\"\u003eAbout permissions for GitHub Packages - GitHub Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3 id=\"gem-をリリースPublishする方法\"\u003egem をリリース（Publish）する方法\u003c/h3\u003e\n\n\u003cp\u003eまずは作成した gem をリリースする方法について説明します。\u003c/p\u003e\n\n\u003ch4 id=\"ローカルからリリースする\"\u003eローカルからリリースする\u003c/h4\u003e\n\n\u003cp\u003eまとめると以下のような手順になります。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003e〜/.gem/credentials\u003c/code\u003e に GitHub の personal access token を追加\n\n\u003cul\u003e\n\u003cli\u003e権限は \u003ccode\u003erepo\u003c/code\u003e と \u003ccode\u003ewrite:packages\u003c/code\u003e が必要\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e$ gem build socialplus-rails.gemspec\u003c/code\u003e で gem をビルド\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eSocialplusRails::VERSION\u003c/code\u003e は \u003ccode\u003e0.1.0\u003c/code\u003e を想定\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e$ gem push --key github --host https://rubygems.pkg.github.com/feedforce socialplus-rails-0.1.0.gem\u003c/code\u003e で push する\n\n\u003cul\u003e\n\u003cli\u003eこの時に personal access token の権限が足りないとエラーになる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\n\n\u003cp\u003ePush が成功すると \u003ca href=\"https://github.com/orgs/feedforce/packages\"\u003ehttps://github.com/orgs/feedforce/packages\u003c/a\u003e のような Packages のページに反映されます 👏\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/d/daido1976/20211104/20211104160709.png\" alt=\"f:id:daido1976:20211104160709p:plain\" width=\"1200\" height=\"492\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch4 id=\"CI-からリリースする\"\u003eCI からリリースする\u003c/h4\u003e\n\n\u003cp\u003egem のソースコードを更新した際に毎回上記のようにローカルからリリースしても良いのですが、できれば CI からリリースできるように仕組み化したいものです。\u003c/p\u003e\n\n\u003cp\u003eCircleCI の場合、以下のような \u003ccode\u003erelease\u003c/code\u003e コマンドを定義して、リリース用のブランチがマージされた時に実行されるようにすれば OK です。\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# .circleci/config.yml\u003c/span\u003e\n\n\u003cspan class=\"synIdentifier\"\u003eversion\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e2.1\u003c/span\u003e\n\u003cspan class=\"synComment\"\u003e# ...\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003ecommands\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003erelease\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003edescription\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Release to GitHub Packages\n    \u003cspan class=\"synIdentifier\"\u003esteps\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Create GitHub Packages Credentials\n          \u003cspan class=\"synIdentifier\"\u003ecommand\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e |\n            mkdir ~/.gem || \u003cspan class=\"synConstant\"\u003etrue\u003c/span\u003e\n            echo -e \u003cspan class=\"synConstant\"\u003e\u0026quot;---\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e\\n\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e:github: Bearer ${GITHUB_ACCESS_TOKEN}\u0026quot;\u003c/span\u003e \u0026gt; ~/.gem/credentials\n            chmod \u003cspan class=\"synConstant\"\u003e0600\u003c/span\u003e ~/.gem/credentials\n      \u003cspan class=\"synStatement\"\u003e- \u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003erun\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"synIdentifier\"\u003ename\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e Release Gem\n          \u003cspan class=\"synIdentifier\"\u003ecommand\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e |\n            gem build socialplus-rails.gemspec\n            release_version=$(find . -name \u003cspan class=\"synConstant\"\u003e\u0026quot;socialplus-rails-*.gem\u0026quot;\u003c/span\u003e | sed -E \u003cspan class=\"synConstant\"\u003e's/\\.\\/socialplus-rails-(.*).gem/\\1/'\u003c/span\u003e)\n            gem push --key github --host https://rubygems.pkg.github.com/feedforce \u003cspan class=\"synConstant\"\u003e\u0026quot;socialplus-rails-${release_version}.gem\u0026quot;\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch3 id=\"各環境へのインストール方法\"\u003e各環境へのインストール方法\u003c/h3\u003e\n\n\u003cp\u003eここからはリリースした gem を各環境へインストールする方法を説明します。\u003c/p\u003e\n\n\u003cp\u003eGemfile への記述は以下のようにします。\u003ca href=\"#f-ff64d70e\" name=\"fn-ff64d70e\" title=\"See. https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry#installing-a-package\"\u003e*1\u003c/a\u003e\u003c/p\u003e\n\n\u003cpre class=\"code lang-ruby\" data-lang=\"ruby\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# Gemfile\u003c/span\u003e\nsource \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003ehttps://rubygems.pkg.github.com/feedforce\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e \u003cspan class=\"synStatement\"\u003edo\u003c/span\u003e\n  gem \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003esocialplus-rails\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e, \u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e0.1.0\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e'\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eend\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003ch4 id=\"ローカルや本番環境でのインストール\"\u003eローカルや本番環境でのインストール\u003c/h4\u003e\n\n\u003cp\u003e以下のように \u003ccode\u003ebundle config\u003c/code\u003e コマンドで認証情報をセットしてから \u003ccode\u003ebundle install\u003c/code\u003e を行います。\u003ca href=\"#f-54facd0e\" name=\"fn-54facd0e\" title=\"環境変数を利用して認証情報をセットすることもできるようです\"\u003e*2\u003c/a\u003e\u003c/p\u003e\n\n\u003cpre class=\"code lang-sh\" data-lang=\"sh\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# `USERNAME:TOKEN` は `{GitHubのユーザ名}:{Personal access token}` という形です（例: `daido1976:7axxx`）\u003c/span\u003e\n$ bundle config https://rubygems.pkg.github.com/feedforce USERNAME:TOKEN\n$ bundle install\n\u003c/pre\u003e\n\n\n\u003cp\u003e※ インストール時の認証に利用する personal access token には \u003ccode\u003eread:packages\u003c/code\u003e の権限のみあれば OK です\u003c/p\u003e\n\n\u003ch4 id=\"Dependabot-でのインストール\"\u003eDependabot でのインストール\u003c/h4\u003e\n\n\u003cp\u003eGitHub Packages のプライベート gem をDependabot の更新対象にしたい場合は追加の設定が必要です。\u003c/p\u003e\n\n\u003cp\u003e以下のように設定ファイルで GitHub Packages の認証情報を渡す準備をします。\u003ca href=\"#f-52f8882d\" name=\"fn-52f8882d\" title=\"See. https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#rubygems-server\"\u003e*3\u003c/a\u003e\u003c/p\u003e\n\n\u003cpre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e# .github/dependabot.yml\u003c/span\u003e\n\n\u003cspan class=\"synIdentifier\"\u003eversion\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e2\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003eregistries\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003erubygems-pkg-github\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003etype\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e rubygems-server\n    \u003cspan class=\"synIdentifier\"\u003eurl\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e https://rubygems.pkg.github.com\n   \u003cspan class=\"synComment\"\u003e # BUNDLE_GITHUB_TOKEN の値は `USERNAME:TOKEN` という形式です\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003etoken\u003c/span\u003e\u003cspan class=\"synSpecial\"\u003e:\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;${{secrets.BUNDLE_GITHUB_TOKEN}}\u0026quot;\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e以下ドキュメントを参考に GitHub Packages の認証情報（今回の例なら \u003ccode\u003eBUNDLE_GITHUB_TOKEN\u003c/code\u003e）を Dependabot 用の Secret として登録すれば完了です。\u003ca href=\"#f-e337a98d\" name=\"fn-e337a98d\" title=\"Secret はリポジトリ単位とオーガニゼーション単位のどちらでも設定できます\"\u003e*4\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/managing-encrypted-secrets-for-dependabot\"\u003eManaging encrypted secrets for Dependabot - GitHub Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2 id=\"関連記事\"\u003e関連記事\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://tech.pepabo.com/2021/09/10/in-house-rubygems-registry-with-ghes-github-packages/\"\u003eGitHub Enterprise Server\u0026#x306E;GitHub Packages\u0026#x3067;\u0026#x793E;\u0026#x5185;\u0026#x7528;gem\u0026#x3092;\u0026#x30DB;\u0026#x30B9;\u0026#x30C8;\u0026#x3059;\u0026#x308B; - \u0026#x30DA;\u0026#x30D1;\u0026#x30DC;\u0026#x30C6;\u0026#x30C3;\u0026#x30AF;\u0026#x30D6;\u0026#x30ED;\u0026#x30B0;\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://tech.actindi.net/2020/06/12/180000\"\u003eGitHub Actions\u0026#x3092;\u0026#x5229;\u0026#x7528;\u0026#x3057;\u0026#x3066;gem\u0026#x3092;GitHub Packages\u0026#x306B;\u0026#x516C;\u0026#x958B;\u0026#x3059;\u0026#x308B; - \u0026#x30A2;\u0026#x30AF;\u0026#x30C8;\u0026#x30A4;\u0026#x30F3;\u0026#x30C7;\u0026#x30A3;\u0026#x958B;\u0026#x767A;\u0026#x8005;\u0026#x30D6;\u0026#x30ED;\u0026#x30B0;\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://chocoby.com/blog/2021/09/21/dependabot-github-packages-gem\"\u003eDependabot \u0026#x3067; GitHub Packages \u0026#x306B;\u0026#x516C;\u0026#x958B;\u0026#x3057;\u0026#x305F; Gem \u0026#x306E;\u0026#x30A2;\u0026#x30C3;\u0026#x30D7;\u0026#x30C7;\u0026#x30FC;\u0026#x30C8;\u0026#x3092;\u0026#x30C1;\u0026#x30A7;\u0026#x30C3;\u0026#x30AF;\u0026#x3059;\u0026#x308B; - \u0026#x6687;\u0026#x4EBA;\u0026#x3058;\u0026#x3083;\u0026#x306A;\u0026#x3044;\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"footnote\"\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-ff64d70e\" name=\"f-ff64d70e\" class=\"footnote-number\"\u003e*1\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003eSee. \u003ca href=\"https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry#installing-a-package\"\u003ehttps://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry#installing-a-package\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-54facd0e\" name=\"f-54facd0e\" class=\"footnote-number\"\u003e*2\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://tech.pepabo.com/2021/09/10/in-house-rubygems-registry-with-ghes-github-packages/#%E3%83%AC%E3%82%B8%E3%82%B9%E3%83%88%E3%83%AA%E3%81%8B%E3%82%89%E3%81%AEgem%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89\"\u003e環境変数を利用して認証情報をセットすることもできるようです\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-52f8882d\" name=\"f-52f8882d\" class=\"footnote-number\"\u003e*3\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003eSee. \u003ca href=\"https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#rubygems-server\"\u003ehttps://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#rubygems-server\u003c/a\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-e337a98d\" name=\"f-e337a98d\" class=\"footnote-number\"\u003e*4\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003eSecret はリポジトリ単位とオーガニゼーション単位のどちらでも設定できます\u003c/span\u003e\u003c/p\u003e\n\u003c/div\u003e","contentSnippet":"こんにちは、id:daido1976 です。先日 GitHub Packages を使ってプライベート gem を社内限定で公開したので、その方法をご紹介します。GitHub Packages とは既存のプライベート gem と GitHub Packages との違いGitHub Packages を使ってプライベート gem を社内限定で公開するgem をリリース（Publish）する方法ローカルからリリースするCI からリリースする各環境へのインストール方法ローカルや本番環境でのインストールDependabot でのインストール関連記事GitHub Packages とはgithub.co.jpGitHub Packages はライブラリ（パッケージ）のホスティングサービスです。Ruby の場合 https://rubygems.org の代わりに https://rubygems.pkg.github.com に公開するイメージで、認証には GitHub の personal access token などを使います。既存のプライベート gem と GitHub Packages との違い既存のプライベート gem は主に git のタグやブランチを指定する方法が用いられますが、以下のようにいくつかの問題があります。# main ブランチの先端を使うのは再現性がない（ブランチ指定した場合も同じ）gem 'my_rubygem', github: 'my_name/my_rubygem'# タグを指定しても書き換えられる可能性があるgem 'my_rubygem', github: 'my_name/my_rubygem', tag: 'v1.0.0'# コミットの参照を指定するのはシンプルに見づらいgem 'my_rubygem', github: 'my_name/my_rubygem', ref: '4aded'GitHub Packages は rubygems.org と同じように、バージョン指定が明確かつ一度リリースしたバージョンは変更できないので安全です。GitHub Packages を使ってプライベート gem を社内限定で公開するここからは実際に GitHub Packages を使ってプライベート gem を社内限定で公開する方法（主にリリースとインストールの仕方）を説明していきます。今回は Organization は feedforce、gem の名前は socialplus-rails という想定です。日本語版のドキュメントは文章やサンプルコードが古いケースがあるので、以下の英語版ドキュメントを参照した方が良いです。Working with the RubyGems registry - GitHub Docs認証に使う personal access token の権限については以下のドキュメントが詳しいです。About permissions for GitHub Packages - GitHub Docsgem をリリース（Publish）する方法まずは作成した gem をリリースする方法について説明します。ローカルからリリースするまとめると以下のような手順になります。〜/.gem/credentials に GitHub の personal access token を追加権限は repo と write:packages が必要$ gem build socialplus-rails.gemspec で gem をビルドSocialplusRails::VERSION は 0.1.0 を想定$ gem push --key github --host https://rubygems.pkg.github.com/feedforce socialplus-rails-0.1.0.gem で push するこの時に personal access token の権限が足りないとエラーになるPush が成功すると https://github.com/orgs/feedforce/packages のような Packages のページに反映されます 👏CI からリリースするgem のソースコードを更新した際に毎回上記のようにローカルからリリースしても良いのですが、できれば CI からリリースできるように仕組み化したいものです。CircleCI の場合、以下のような release コマンドを定義して、リリース用のブランチがマージされた時に実行されるようにすれば OK です。# .circleci/config.ymlversion: 2.1# ...commands:  release:    description: Release to GitHub Packages    steps:      - run:          name: Create GitHub Packages Credentials          command: |            mkdir ~/.gem || true            echo -e \"---\\n:github: Bearer ${GITHUB_ACCESS_TOKEN}\" \u003e ~/.gem/credentials            chmod 0600 ~/.gem/credentials      - run:          name: Release Gem          command: |            gem build socialplus-rails.gemspec            release_version=$(find . -name \"socialplus-rails-*.gem\" | sed -E 's/\\.\\/socialplus-rails-(.*).gem/\\1/')            gem push --key github --host https://rubygems.pkg.github.com/feedforce \"socialplus-rails-${release_version}.gem\"各環境へのインストール方法ここからはリリースした gem を各環境へインストールする方法を説明します。Gemfile への記述は以下のようにします。*1# Gemfilesource 'https://rubygems.pkg.github.com/feedforce' do  gem 'socialplus-rails', '0.1.0'endローカルや本番環境でのインストール以下のように bundle config コマンドで認証情報をセットしてから bundle install を行います。*2# `USERNAME:TOKEN` は `{GitHubのユーザ名}:{Personal access token}` という形です（例: `daido1976:7axxx`）$ bundle config https://rubygems.pkg.github.com/feedforce USERNAME:TOKEN$ bundle install※ インストール時の認証に利用する personal access token には read:packages の権限のみあれば OK ですDependabot でのインストールGitHub Packages のプライベート gem をDependabot の更新対象にしたい場合は追加の設定が必要です。以下のように設定ファイルで GitHub Packages の認証情報を渡す準備をします。*3# .github/dependabot.ymlversion: 2registries:  rubygems-pkg-github:    type: rubygems-server    url: https://rubygems.pkg.github.com    # BUNDLE_GITHUB_TOKEN の値は `USERNAME:TOKEN` という形式です    token: \"${{secrets.BUNDLE_GITHUB_TOKEN}}\"以下ドキュメントを参考に GitHub Packages の認証情報（今回の例なら BUNDLE_GITHUB_TOKEN）を Dependabot 用の Secret として登録すれば完了です。*4Managing encrypted secrets for Dependabot - GitHub Docs関連記事GitHub Enterprise ServerのGitHub Packagesで社内用gemをホストする - ペパボテックブログGitHub Actionsを利用してgemをGitHub Packagesに公開する - アクトインディ開発者ブログDependabot で GitHub Packages に公開した Gem のアップデートをチェックする - 暇人じゃない*1:See. https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-rubygems-registry#installing-a-package*2:環境変数を利用して認証情報をセットすることもできるようです*3:See. https://docs.github.com/en/code-security/supply-chain-security/keeping-your-dependencies-updated-automatically/configuration-options-for-dependency-updates#rubygems-server*4:Secret はリポジトリ単位とオーガニゼーション単位のどちらでも設定できます","link":"https://developer.feedforce.jp/entry/2021/11/05/095050","isoDate":"2021-11-05T00:50:50.000Z","dateMiliSeconds":1636073450000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/d/daido1976/20211104/20211104160709.png","authorName":"feedforce"},{"title":"Amazon EKS で高負荷時に CoreDNS が原因で稀にネットワークエラーが発生していた時のトラブルシュート","content":"\u003cp\u003eソーシャルPLUS の開発チームでインフラエンジニア をやっています \u003ca href=\"http://blog.hatena.ne.jp/mayuki123/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/mayuki123/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:mayuki123\u003c/a\u003e です。今月からフィードフォースから分社化をした株式会社ソーシャルPLUS の所属となりましたが、仕事内容は変わらずにサービスのインフラ改善を進めていく事になるかと思います。\u003c/p\u003e\n\n\u003cp\u003e2019年11月に技術スタックを整理してみたという記事から2年弱経過していますが、ソーシャルPLUSのインフラ環境は、一部アプリケーションについてはコンテナ環境を Amazon EKS にホスティングして本番運用するようになりました。あと数ヶ月ほどで全ての環境がEC2からコンテナに置き換えられると良いなと思っています(願望)。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2019%2F11%2F25%2F120000\" title=\"ソーシャルPLUS の技術スタックを整理してみた - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2019/11/25/120000\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eそして、既に利用されている機能の一部を Amazon EKS に移行して、しばらく経過した時にアプリケーションでネットワークエラーが稀に発生していました。原因調査をした結果が CoreDNS の負荷によるものと発覚するまでのトラブルシュートの流れについて、記事として書き残しておきます。\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#発生していた事象\"\u003e発生していた事象\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#Datadog-を活用した原因調査\"\u003eDatadog を活用した原因調査\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#アプリケーションの負荷状況\"\u003eアプリケーションの負荷状況\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#EKS-上のコンテナの調査\"\u003eEKS 上のコンテナの調査\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#EKS-のCoreDNS-の調査\"\u003eEKS のCoreDNS の調査\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#CoreDNS-のデバッグログの有効化\"\u003eCoreDNS のデバッグログの有効化\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#Kubernetes-の名前解決について\"\u003eKubernetes の名前解決について\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#CoreDNS-の負荷軽減\"\u003eCoreDNS の負荷軽減\u003c/a\u003e\u003cul\u003e\n            \u003cli\u003e\u003ca href=\"#ドメインの末尾にドット--を追加する\"\u003eドメインの末尾にドット (.) を追加する\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#etcresolvconf-で-ndots1-の設定をする\"\u003e/etc/resolv.conf で ndots:1 の設定をする\u003c/a\u003e\u003c/li\u003e\n            \u003cli\u003e\u003ca href=\"#その他の-CoreDNS-の負荷軽減の方法\"\u003eその他の CoreDNS の負荷軽減の方法\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n    \u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#最終的な結果\"\u003e最終的な結果\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#おわりに\"\u003eおわりに\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#おまけ\"\u003eおまけ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"発生していた事象\"\u003e発生していた事象\u003c/h2\u003e\n\n\u003cp\u003eソーシャルPLUSでは、バックエンドのアプリケーションでエラーが発生した時に、Bugsnag を利用して Slack 通知するようにしています。ある時に\u003ccode\u003eMysql2::Error::ConnectionError\u003c/code\u003e が発生しました。単発のネットワークエラーの場合はアプリケーションがリトライする事でサービス影響がない事も多く、一時的な問題と思って静観する事があるかと思います。しかし、また数日後に同じ事象が発生しました。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/mayuki123/20210830/20210830152912.png\" alt=\"f:id:mayuki123:20210830152912p:plain\" width=\"667\" height=\"258\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%83%8F%E3%82%A4%E3%83%B3%E3%83%AA%E3%83%83%E3%83%92%E3%81%AE%E6%B3%95%E5%89%87\"\u003eハインリッヒの1：29：300の法則\u003c/a\u003eのように、ちょっとした異常を見落としていると重大なサービス障害となってしまう可能性があるので、原因調査を始めます。\u003c/p\u003e\n\n\u003ch2 id=\"Datadog-を活用した原因調査\"\u003eDatadog を活用した原因調査\u003c/h2\u003e\n\n\u003cp\u003eソーシャルPLUSでは、モニタリングサービスの Datadog を利用しているのでメトリクスやログの調査を出来るようになっています。どこが原因かを探り始めました。\u003c/p\u003e\n\n\u003ch3 id=\"アプリケーションの負荷状況\"\u003eアプリケーションの負荷状況\u003c/h3\u003e\n\n\u003cp\u003eまずはアプリケーションで利用するサーバの負荷状況を確認する所から始めました。\u003ccode\u003eMysql2::Error::ConnectionError\u003c/code\u003e が発生した時刻は EKS の Node の CPU 使用率が 70% ほどで、アプリケーションで負荷のかかる処理の最中でした。また、データベースの負荷は少し前に負荷対策の改善をした事もあって、今回の事件の犯人ではなさそうです。他にもEC2 と DB 間でネットワークのボトルネックがないかなどの確認はしましたが、CPU 使用率が高い以外の問題は特に見つかりませんでした。完全犯罪でしょうか。\u003c/p\u003e\n\n\u003ch3 id=\"EKS-上のコンテナの調査\"\u003eEKS 上のコンテナの調査\u003c/h3\u003e\n\n\u003cp\u003eサーバ単体の問題ではないとすると、Amazon EKS で何か起きている事を疑うことにしました。EKSで動かしているコンテナのログは Datadog Logs に送っているので、\u003cstrong\u003eエラーが発生していたアプリケーション以外のログ\u003c/strong\u003e を確認していると、MySQL の ConnectionError が発生した時間帯に下記の Warning のメッセージが出ている事に気づきました。このログは Amazon Kinesis Data Firehose にログを送る Fluent Bit のコンテナで発生しており、エラーが発生してたアプリケーションとは異なるノードに存在してました。\u003c/p\u003e\n\n\u003cblockquote\u003e\u003cp\u003e[yyyy/mm/dd hh:mm:ss] [ warn] [net] getaddrinfo(host='kinesis.ap-northeast-1.amazonaws.com'): Name or service not known\u003c/p\u003e\u003c/blockquote\u003e\n\n\u003cp\u003e同時刻に特定のアプリケーション以外のコンテナも影響を受けていることから、EKS の中で問題がありそうです。元々、EKSに関する技術ブログは目を通すようにしていた事もあり、Kubernetes の DNS の名前解決で問題が発生する場合があるというのは知っていたので、CoreDNSに焦点を当てて調べることにしました。アウトプットをしてくれる人たちには、いつも感謝をしています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://medium.com/cloutive/production-ready-eks-coredns-configuration-6fea830606f8\"\u003eProduction Ready EKS CoreDNS Configuration | by Serkan Capkan | Cloutive Technology Solutions - Tech Blog | Medium\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://creators-note.chatwork.com/entry/2021/01/05/104206#%E4%B8%80%E5%AE%9A%E6%95%B0%E3%81%AEPod%E4%BB%A5%E4%B8%8A%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%A8%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%8C%E4%B8%8D%E5%AE%89%E5%AE%9A%E3%81%AB%E3%81%AA%E3%82%8B\"\u003eEKS\u0026#x3067;DNS\u0026#x3092;\u0026#x5B89;\u0026#x5B9A;\u0026#x3055;\u0026#x305B;\u0026#x308B;\u0026#x305F;\u0026#x3081;\u0026#x306B;\u0026#x5BFE;\u0026#x5FDC;\u0026#x3057;\u0026#x305F;\u0026#x3053;\u0026#x3068; - Chatwork Creator\u0026#39;s Note\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://labs.gree.jp/blog/2020/01/20271/\"\u003e\u0026#x30B9;\u0026#x30DE;\u0026#x30DB;\u0026#x30B2;\u0026#x30FC;\u0026#x30E0;\u0026#x306E; API \u0026#x30B5;\u0026#x30FC;\u0026#x30D0;\u0026#x306B;\u0026#x304A;\u0026#x3051;\u0026#x308B; EKS \u0026#x306E;\u0026#x904B;\u0026#x7528;\u0026#x4E8B;\u0026#x4F8B; | \u0026#x30A8;\u0026#x30F3;\u0026#x30B8;\u0026#x30CB;\u0026#x30A2;\u0026#x30D6;\u0026#x30ED;\u0026#x30B0; | GREE Engineering\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch2 id=\"EKS-のCoreDNS-の調査\"\u003eEKS のCoreDNS の調査\u003c/h2\u003e\n\n\u003cp\u003eDatadog Agent で Kurbernetes の各種メトリクスを収集していて、EKS の CoreDNS の状況も Datadog の Metric Explorer で確認する事が出来るようになっています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.datadoghq.com/ja/integrations/coredns/?tab=docker#%E3%83%A1%E3%83%88%E3%83%AA%E3%82%AF%E3%82%B9\"\u003eDatadog で取得可能な CoreDNS のメトリクス\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003e\u003ccode\u003ecoredns.request_count\u003c/code\u003e を確認すると特定の時間帯で CoreDNS へのリクエストが多い状態で、このタイミングでの CoreDNS Pod の CPU 負荷は10％前後でしたが、それ以外に不審なメトリクスは存在しませんでした。まだ事象の原因との確信は持てないですが、負荷がそれなりにかかっていることは確かなのでリクエストが多くなる理由を調べます。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/mayuki123/20210831/20210831151005.png\" alt=\"f:id:mayuki123:20210831151005p:plain\" width=\"522\" height=\"200\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch3 id=\"CoreDNS-のデバッグログの有効化\"\u003eCoreDNS のデバッグログの有効化\u003c/h3\u003e\n\n\u003cp\u003eまずは CoreDNS のデバッグログを確認したいとなるかと思いますが、EKS の CoreDNS はデフォルトだとデバッグログの出力がオフの状態のため、どのようなリクエストが到達しているのかは確認する事ができません。CoreDNS のログを有効化する方法は AWS のナレッジベースにある記事に方法が記載されています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://aws.amazon.com/jp/premiumsupport/knowledge-center/eks-dns-failure/\"\u003eAmazon EKS \u0026#x3067;\u0026#x306E; DNS \u0026#x969C;\u0026#x5BB3;\u0026#x306E;\u0026#x30C8;\u0026#x30E9;\u0026#x30D6;\u0026#x30EB;\u0026#x30B7;\u0026#x30E5;\u0026#x30FC;\u0026#x30C6;\u0026#x30A3;\u0026#x30F3;\u0026#x30B0;\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこの記事によると、Namespace(\u003ccode\u003ekube-system\u003c/code\u003e) に Configmap (\u003ccode\u003ecoredns\u003c/code\u003e) があるので、Corefile 設定に \u003ccode\u003elog\u003c/code\u003e を追加するとデバッグログ が出力されるようになります。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e# kubectl -n kube-system edit configmap coredns\nkind: ConfigMap\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        log    # Enabling CoreDNS Logging\n        errors\n        health\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n          pods insecure\n          upstream\n          fallthrough in-addr.arpa ip6.arpa\n        }\n        ...\u003c/pre\u003e\n\n\n\u003cp\u003e上記の設定をすると CoreDNS のPod の標準出力にデバッグログ が出力されるようになります。私の触っていた EKS の環境の場合は、数分ほどで CoreDNS の Pod で reload が発生して元の設定（デバッグログ がオフ）に戻るようになってました。\u003c/p\u003e\n\n\u003ch3 id=\"Kubernetes-の名前解決について\"\u003eKubernetes の名前解決について\u003c/h3\u003e\n\n\u003cp\u003e次にKubernetes 上のコンテナはどのように名前解決するのかを知っておく必要があります。Kurbernetes の Pod の DNS リゾルバー(\u003ccode\u003e/etc/resolv.conf\u003c/code\u003e) のデフォルト設定は下記のようになっています。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003e% kubectl exec fluent-bit-46zvl -- cat /etc/resolv.conf\nnameserver 172.20.0.10\nsearch logging.svc.cluster.local svc.cluster.local cluster.local\noptions ndots:5\u003c/pre\u003e\n\n\n\u003cp\u003eこの状態で Fluent Bit のコンテナから Amazon Kinesis の API エンドポイントに疎通する場合は、CoreDNS に8回のリクエストが発生します。これは、IPv4 , IPv6 の2種類の名前解決を \u003ccode\u003esearch\u003c/code\u003e の数だけ名前解決を試みた後で EKS 外に名前解決をする設定になっているからです。この設定になっているおかげで Kubernetes の Service を使った名前解決が出来るようになっています。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/mayuki123/20210831/20210831154909.png\" alt=\"f:id:mayuki123:20210831154909p:plain\" width=\"1200\" height=\"328\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eまた、\u003ccode\u003eoptions ndots:5\u003c/code\u003e の設定は \u003ccode\u003e.\u003c/code\u003e の数が 5個以上の時は最初から外部に名前解決するようになります。そのため、Amazon Aurora や ElastiCache などのデータベースへの クラスターエンドポイントは \u003ccode\u003e.\u003c/code\u003e の数が五個以上あるので、CoreDNSへのリクエスト回数は少なくて済みます。ここを意識しなくてよいのはありがたいですね。\u003c/p\u003e\n\n\u003cp\u003eソーシャルPLUSというプロダクトの特性上、EKS 内のアプリケーションから外部サービスの API を実行する機会が多々あります。特定のタイミングで外部のサービスに大量のAPIリクエストを実行した際に、CoreDNS へのリクエストが増大してしまい不安定になってしまったのではと考えられます。\u003c/p\u003e\n\n\u003ch2 id=\"CoreDNS-の負荷軽減\"\u003eCoreDNS の負荷軽減\u003c/h2\u003e\n\n\u003cp\u003eKurbernetes 上のコンテナの名前解決を知ると、外部サービスのAPI を実行する際には CoreDNS へのリクエストが多くなる事が分かりました。ここで、CoreDNS へのリクエスト数を減らす方法は下記の二つがあります。これも AWS のナレッジベースに方法が記載されているので、詳細は下記の記事を読む方が良いと思います。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://aws.amazon.com/jp/premiumsupport/knowledge-center/eks-dns-failure/\"\u003eAmazon EKS \u0026#x3067;\u0026#x306E; DNS \u0026#x969C;\u0026#x5BB3;\u0026#x306E;\u0026#x30C8;\u0026#x30E9;\u0026#x30D6;\u0026#x30EB;\u0026#x30B7;\u0026#x30E5;\u0026#x30FC;\u0026#x30C6;\u0026#x30A3;\u0026#x30F3;\u0026#x30B0;\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003ch3 id=\"ドメインの末尾にドット--を追加する\"\u003eドメインの末尾にドット (.) を追加する\u003c/h3\u003e\n\n\u003cp\u003e接続先のドメインの最後に \u003ccode\u003e.\u003c/code\u003e をつけると、EKS の内部で名前解決を複数回しないようになり、CoreDNS へのリクエストの総数が減ります。一例をあげると、\u003ccode\u003eexample.com\u003c/code\u003e ではなく、 \u003ccode\u003eexample.com.\u003c/code\u003e とする事で最初から EKS の外部に名前解決をしてくれるようになります。ドメインが SDK の内部で定義されているような場合など、変更出来ない場合はこの方法は利用出来ないかと思います。\u003c/p\u003e\n\n\u003ch3 id=\"etcresolvconf-で-ndots1-の設定をする\"\u003e\u003ccode\u003e/etc/resolv.conf\u003c/code\u003e で ndots:1 の設定をする\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003e/etc/resolv.conf\u003c/code\u003e に \u003ccode\u003eoptions ndots:5\u003c/code\u003e とデフォルトで設定されている数値を \u003ccode\u003e1\u003c/code\u003e にする事で、ドメインに \u003ccode\u003e.\u003c/code\u003e が含まれている場合は常に EKS の外部に名前解決するようになります。Kubernetes の Manifest に \u003ccode\u003espec.dnsConfig\u003c/code\u003e パラメータを設定する事で Pod 単位で変更が出来ます。ただし、この設定をすると EKS 内部で名前解決をしなくなってしまいますが、\u003ccode\u003e\u0026lt;name\u0026gt;.\u0026lt;namespace\u0026gt;.svc.cluster.local.\u003c/code\u003e のように最後に \u003ccode\u003e.\u003c/code\u003e をつけると名前解決出来ました。Kurbernetes の Service の数が多いとこの方法を周知させるのも大変だと思います。\u003c/p\u003e\n\n\u003cpre class=\"code\" data-lang=\"\" data-unlink\u003eapiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hoge\nspec:\n  template:\n    spec:\n      dnsConfig:\n        options:\n          - name: ndots\n            value: \u0026#34;1\u0026#34;\u003c/pre\u003e\n\n\n\u003ch3 id=\"その他の-CoreDNS-の負荷軽減の方法\"\u003eその他の CoreDNS の負荷軽減の方法\u003c/h3\u003e\n\n\u003cp\u003e上記の二つの方法は CoreDNS へのリクエスト数を減らすことで、負荷を軽減するようなアプローチでした。CoreDNS の Pod 数はデフォルトで 2個となりますが、CoreDNS のPod をオートスケールする手段もあります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://kubernetes.io/docs/tasks/administer-cluster/dns-horizontal-autoscaling/\"\u003eAutoscale the DNS Service in a Cluster\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eまた、Daemonset で DNS キャッシュをノード単位で配置するという方法もあります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://kubernetes.io/ja/docs/tasks/administer-cluster/nodelocaldns/\"\u003eKubernetesクラスターでNodeLocal DNSキャッシュを使用する\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこの辺りは他の方が書いた技術ブログも多くあるかと思うので、この記事では特に説明はしないです。\u003c/p\u003e\n\n\u003ch2 id=\"最終的な結果\"\u003e最終的な結果\u003c/h2\u003e\n\n\u003cp\u003eソーシャルPLUSでは最終的に根本原因の CoreDNS へのリクエスト数を減らすために \u003ccode\u003e/etc/resolv.conf\u003c/code\u003e で \u003ccode\u003endots:1\u003c/code\u003e の設定をするようにしました。この設定をアプリケーションの Pod に適応した所、CoreDNS へのリクエスト数は 25% ほどと目に見えて減少させる事が出来ました。キャプチャは載せてないですが、CoreDNS の Pod の CPU使用率も 以前の半分ほどになったので、負荷軽減の目的は達成しました。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/mayuki123/20210831/20210831171734.png\" alt=\"f:id:mayuki123:20210831171734p:plain\" width=\"527\" height=\"187\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eここまで、確信を持てないまま CoreDNS の負荷軽減に取り組みましたが、元々のネットワークエラーであった \u003ccode\u003eMysql2::Error::ConnectionError\u003c/code\u003e のエラーは再発しなくなりました。また、EKS 上の他のコンテナも \u003ccode\u003eName or service not known\u003c/code\u003e のような名前解決が出来ないといったエラーも発生しなくなりました。CoreDNS の負荷を減らす事で悩まされていた問題の解消が出来たと思います。今回のように比較的早い段階で気づく事が出来たので、お客さんへのサービス影響のある問題に発展せずに済みました。\u003c/p\u003e\n\n\u003cp\u003e今後、利用者数が増えてより負荷のかかる状況になってきた時には再発する可能性はありますが、早い段階で気付けるように日々確認するダッシュボードにメトリクスを追加するようにしています。その時がきた場合は CoreDNS の Pod 数の調整や DNS キャッシュの導入が必要になりそうです。\u003c/p\u003e\n\n\u003ch2 id=\"おわりに\"\u003eおわりに\u003c/h2\u003e\n\n\u003cp\u003e最終的には Pod の DNS 設定を調整するだけでネットワークエラーは解決しました。この記事では、結果だけではなくて解決に至るまでの経緯をメインにまとめてみました。実施していて良かったと思うことを下記にまとめます。これらの事が出来ていなければ、今回のようなネットワークエラーはたまに発生する事象として、根本原因の追及は出来なかったと思うので、サービスのオブザーバビリティを整備する事や日々の情報収集は大事ですね。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eアプリケーションのエラーを Slack に通知していた\u003c/li\u003e\n\u003cli\u003eKurbernetes のメトリクスを Datadog で確認できる状態だった\u003c/li\u003e\n\u003cli\u003eコンテナのログを一元的に Datadog Logs  で閲覧できるようにしていた\u003c/li\u003e\n\u003cli\u003e他の人の技術ブログから Kubernetes の CoreDNS が不安定になることを知っていた\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこの記事に間違っている内容や、もっと良い改善方法がある事をご存知の方がいましたら、優しく教えてください。\u003c/p\u003e\n\n\u003ch2 id=\"おまけ\"\u003eおまけ\u003c/h2\u003e\n\n\u003cp\u003e現在、ソーシャルPLUS では作りたい機能が山ほどある状況でまだまだ成長するサービスになると思うので、成長を続けるサービスに携わりたいエンジニアやデザイナーのご応募をお待ちしております！サイトにはまだないですが、インフラエンジニアも近いうちに募集をする事にはなると思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fopen.talentio.com%2F1%2Fc%2Ffeedforce%2Frequisitions%2Fdetail%2F21802\" title=\"Railsエンジニア【Shopify App開発/ID連携サービス】 / 株式会社フィードフォース\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://open.talentio.com/1/c/feedforce/requisitions/detail/21802\"\u003eopen.talentio.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fopen.talentio.com%2F1%2Fc%2Ffeedforce%2Frequisitions%2Fdetail%2F21755\" title=\"フロントエンドエンジニア【Shopifyアプリ開発/ID連携サービス/React/TypeScript】 / 株式会社フィードフォース\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://open.talentio.com/1/c/feedforce/requisitions/detail/21755\"\u003eopen.talentio.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fopen.talentio.com%2F1%2Fc%2Ffeedforce%2Frequisitions%2Fdetail%2F21760\" title=\"UI/UXデザイナー【ID連携サービス/マーケティング支援SaaS】 / 株式会社フィードフォース\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://open.talentio.com/1/c/feedforce/requisitions/detail/21760\"\u003eopen.talentio.com\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eフィードフォース の他のサービスもエンジニアを募集してますので、興味があればご応募お待ちしております！\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fengineers.recruit.feedforce.jp%2F%3F_ga%3D2.157559610.1029003260.1630297434-1923366822.1626416415%23entry\" title=\"フィードフォース エンジニア・デザイナー採用サイト\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://engineers.recruit.feedforce.jp/?_ga=2.157559610.1029003260.1630297434-1923366822.1626416415#entry\"\u003eengineers.recruit.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n","contentSnippet":"ソーシャルPLUS の開発チームでインフラエンジニア をやっています id:mayuki123 です。今月からフィードフォースから分社化をした株式会社ソーシャルPLUS の所属となりましたが、仕事内容は変わらずにサービスのインフラ改善を進めていく事になるかと思います。2019年11月に技術スタックを整理してみたという記事から2年弱経過していますが、ソーシャルPLUSのインフラ環境は、一部アプリケーションについてはコンテナ環境を Amazon EKS にホスティングして本番運用するようになりました。あと数ヶ月ほどで全ての環境がEC2からコンテナに置き換えられると良いなと思っています(願望)。developer.feedforce.jpそして、既に利用されている機能の一部を Amazon EKS に移行して、しばらく経過した時にアプリケーションでネットワークエラーが稀に発生していました。原因調査をした結果が CoreDNS の負荷によるものと発覚するまでのトラブルシュートの流れについて、記事として書き残しておきます。発生していた事象Datadog を活用した原因調査アプリケーションの負荷状況EKS 上のコンテナの調査EKS のCoreDNS の調査CoreDNS のデバッグログの有効化Kubernetes の名前解決についてCoreDNS の負荷軽減ドメインの末尾にドット (.) を追加する/etc/resolv.conf で ndots:1 の設定をするその他の CoreDNS の負荷軽減の方法最終的な結果おわりにおまけ発生していた事象ソーシャルPLUSでは、バックエンドのアプリケーションでエラーが発生した時に、Bugsnag を利用して Slack 通知するようにしています。ある時にMysql2::Error::ConnectionError が発生しました。単発のネットワークエラーの場合はアプリケーションがリトライする事でサービス影響がない事も多く、一時的な問題と思って静観する事があるかと思います。しかし、また数日後に同じ事象が発生しました。ハインリッヒの1：29：300の法則のように、ちょっとした異常を見落としていると重大なサービス障害となってしまう可能性があるので、原因調査を始めます。Datadog を活用した原因調査ソーシャルPLUSでは、モニタリングサービスの Datadog を利用しているのでメトリクスやログの調査を出来るようになっています。どこが原因かを探り始めました。アプリケーションの負荷状況まずはアプリケーションで利用するサーバの負荷状況を確認する所から始めました。Mysql2::Error::ConnectionError が発生した時刻は EKS の Node の CPU 使用率が 70% ほどで、アプリケーションで負荷のかかる処理の最中でした。また、データベースの負荷は少し前に負荷対策の改善をした事もあって、今回の事件の犯人ではなさそうです。他にもEC2 と DB 間でネットワークのボトルネックがないかなどの確認はしましたが、CPU 使用率が高い以外の問題は特に見つかりませんでした。完全犯罪でしょうか。EKS 上のコンテナの調査サーバ単体の問題ではないとすると、Amazon EKS で何か起きている事を疑うことにしました。EKSで動かしているコンテナのログは Datadog Logs に送っているので、エラーが発生していたアプリケーション以外のログ を確認していると、MySQL の ConnectionError が発生した時間帯に下記の Warning のメッセージが出ている事に気づきました。このログは Amazon Kinesis Data Firehose にログを送る Fluent Bit のコンテナで発生しており、エラーが発生してたアプリケーションとは異なるノードに存在してました。[yyyy/mm/dd hh:mm:ss] [ warn] [net] getaddrinfo(host='kinesis.ap-northeast-1.amazonaws.com'): Name or service not known同時刻に特定のアプリケーション以外のコンテナも影響を受けていることから、EKS の中で問題がありそうです。元々、EKSに関する技術ブログは目を通すようにしていた事もあり、Kubernetes の DNS の名前解決で問題が発生する場合があるというのは知っていたので、CoreDNSに焦点を当てて調べることにしました。アウトプットをしてくれる人たちには、いつも感謝をしています。Production Ready EKS CoreDNS Configuration | by Serkan Capkan | Cloutive Technology Solutions - Tech Blog | MediumEKSでDNSを安定させるために対応したこと - Chatwork Creator's Noteスマホゲームの API サーバにおける EKS の運用事例 | エンジニアブログ | GREE EngineeringEKS のCoreDNS の調査Datadog Agent で Kurbernetes の各種メトリクスを収集していて、EKS の CoreDNS の状況も Datadog の Metric Explorer で確認する事が出来るようになっています。Datadog で取得可能な CoreDNS のメトリクスcoredns.request_count を確認すると特定の時間帯で CoreDNS へのリクエストが多い状態で、このタイミングでの CoreDNS Pod の CPU 負荷は10％前後でしたが、それ以外に不審なメトリクスは存在しませんでした。まだ事象の原因との確信は持てないですが、負荷がそれなりにかかっていることは確かなのでリクエストが多くなる理由を調べます。CoreDNS のデバッグログの有効化まずは CoreDNS のデバッグログを確認したいとなるかと思いますが、EKS の CoreDNS はデフォルトだとデバッグログの出力がオフの状態のため、どのようなリクエストが到達しているのかは確認する事ができません。CoreDNS のログを有効化する方法は AWS のナレッジベースにある記事に方法が記載されています。Amazon EKS での DNS 障害のトラブルシューティングこの記事によると、Namespace(kube-system) に Configmap (coredns) があるので、Corefile 設定に log を追加するとデバッグログ が出力されるようになります。# kubectl -n kube-system edit configmap corednskind: ConfigMapapiVersion: v1data:  Corefile: |    .:53 {        log    # Enabling CoreDNS Logging        errors        health        kubernetes cluster.local in-addr.arpa ip6.arpa {          pods insecure          upstream          fallthrough in-addr.arpa ip6.arpa        }        ...上記の設定をすると CoreDNS のPod の標準出力にデバッグログ が出力されるようになります。私の触っていた EKS の環境の場合は、数分ほどで CoreDNS の Pod で reload が発生して元の設定（デバッグログ がオフ）に戻るようになってました。Kubernetes の名前解決について次にKubernetes 上のコンテナはどのように名前解決するのかを知っておく必要があります。Kurbernetes の Pod の DNS リゾルバー(/etc/resolv.conf) のデフォルト設定は下記のようになっています。% kubectl exec fluent-bit-46zvl -- cat /etc/resolv.confnameserver 172.20.0.10search logging.svc.cluster.local svc.cluster.local cluster.localoptions ndots:5この状態で Fluent Bit のコンテナから Amazon Kinesis の API エンドポイントに疎通する場合は、CoreDNS に8回のリクエストが発生します。これは、IPv4 , IPv6 の2種類の名前解決を search の数だけ名前解決を試みた後で EKS 外に名前解決をする設定になっているからです。この設定になっているおかげで Kubernetes の Service を使った名前解決が出来るようになっています。また、options ndots:5 の設定は . の数が 5個以上の時は最初から外部に名前解決するようになります。そのため、Amazon Aurora や ElastiCache などのデータベースへの クラスターエンドポイントは . の数が五個以上あるので、CoreDNSへのリクエスト回数は少なくて済みます。ここを意識しなくてよいのはありがたいですね。ソーシャルPLUSというプロダクトの特性上、EKS 内のアプリケーションから外部サービスの API を実行する機会が多々あります。特定のタイミングで外部のサービスに大量のAPIリクエストを実行した際に、CoreDNS へのリクエストが増大してしまい不安定になってしまったのではと考えられます。CoreDNS の負荷軽減Kurbernetes 上のコンテナの名前解決を知ると、外部サービスのAPI を実行する際には CoreDNS へのリクエストが多くなる事が分かりました。ここで、CoreDNS へのリクエスト数を減らす方法は下記の二つがあります。これも AWS のナレッジベースに方法が記載されているので、詳細は下記の記事を読む方が良いと思います。Amazon EKS での DNS 障害のトラブルシューティングドメインの末尾にドット (.) を追加する接続先のドメインの最後に . をつけると、EKS の内部で名前解決を複数回しないようになり、CoreDNS へのリクエストの総数が減ります。一例をあげると、example.com ではなく、 example.com. とする事で最初から EKS の外部に名前解決をしてくれるようになります。ドメインが SDK の内部で定義されているような場合など、変更出来ない場合はこの方法は利用出来ないかと思います。/etc/resolv.conf で ndots:1 の設定をする/etc/resolv.conf に options ndots:5 とデフォルトで設定されている数値を 1 にする事で、ドメインに . が含まれている場合は常に EKS の外部に名前解決するようになります。Kubernetes の Manifest に spec.dnsConfig パラメータを設定する事で Pod 単位で変更が出来ます。ただし、この設定をすると EKS 内部で名前解決をしなくなってしまいますが、\u003cname\u003e.\u003cnamespace\u003e.svc.cluster.local. のように最後に . をつけると名前解決出来ました。Kurbernetes の Service の数が多いとこの方法を周知させるのも大変だと思います。apiVersion: apps/v1kind: Deploymentmetadata:  name: hogespec:  template:    spec:      dnsConfig:        options:          - name: ndots            value: \"1\"その他の CoreDNS の負荷軽減の方法上記の二つの方法は CoreDNS へのリクエスト数を減らすことで、負荷を軽減するようなアプローチでした。CoreDNS の Pod 数はデフォルトで 2個となりますが、CoreDNS のPod をオートスケールする手段もあります。Autoscale the DNS Service in a Clusterまた、Daemonset で DNS キャッシュをノード単位で配置するという方法もあります。KubernetesクラスターでNodeLocal DNSキャッシュを使用するこの辺りは他の方が書いた技術ブログも多くあるかと思うので、この記事では特に説明はしないです。最終的な結果ソーシャルPLUSでは最終的に根本原因の CoreDNS へのリクエスト数を減らすために /etc/resolv.conf で ndots:1 の設定をするようにしました。この設定をアプリケーションの Pod に適応した所、CoreDNS へのリクエスト数は 25% ほどと目に見えて減少させる事が出来ました。キャプチャは載せてないですが、CoreDNS の Pod の CPU使用率も 以前の半分ほどになったので、負荷軽減の目的は達成しました。ここまで、確信を持てないまま CoreDNS の負荷軽減に取り組みましたが、元々のネットワークエラーであった Mysql2::Error::ConnectionError のエラーは再発しなくなりました。また、EKS 上の他のコンテナも Name or service not known のような名前解決が出来ないといったエラーも発生しなくなりました。CoreDNS の負荷を減らす事で悩まされていた問題の解消が出来たと思います。今回のように比較的早い段階で気づく事が出来たので、お客さんへのサービス影響のある問題に発展せずに済みました。今後、利用者数が増えてより負荷のかかる状況になってきた時には再発する可能性はありますが、早い段階で気付けるように日々確認するダッシュボードにメトリクスを追加するようにしています。その時がきた場合は CoreDNS の Pod 数の調整や DNS キャッシュの導入が必要になりそうです。おわりに最終的には Pod の DNS 設定を調整するだけでネットワークエラーは解決しました。この記事では、結果だけではなくて解決に至るまでの経緯をメインにまとめてみました。実施していて良かったと思うことを下記にまとめます。これらの事が出来ていなければ、今回のようなネットワークエラーはたまに発生する事象として、根本原因の追及は出来なかったと思うので、サービスのオブザーバビリティを整備する事や日々の情報収集は大事ですね。アプリケーションのエラーを Slack に通知していたKurbernetes のメトリクスを Datadog で確認できる状態だったコンテナのログを一元的に Datadog Logs  で閲覧できるようにしていた他の人の技術ブログから Kubernetes の CoreDNS が不安定になることを知っていたこの記事に間違っている内容や、もっと良い改善方法がある事をご存知の方がいましたら、優しく教えてください。おまけ現在、ソーシャルPLUS では作りたい機能が山ほどある状況でまだまだ成長するサービスになると思うので、成長を続けるサービスに携わりたいエンジニアやデザイナーのご応募をお待ちしております！サイトにはまだないですが、インフラエンジニアも近いうちに募集をする事にはなると思います。open.talentio.comopen.talentio.comopen.talentio.comフィードフォース の他のサービスもエンジニアを募集してますので、興味があればご応募お待ちしております！engineers.recruit.feedforce.jp","link":"https://developer.feedforce.jp/entry/2021/09/02/134725","isoDate":"2021-09-02T04:47:25.000Z","dateMiliSeconds":1630558045000,"imageUrl":"https://cdn.user.blog.st-hatena.com/default_entry_og_image/4268819/1588226000876991","authorName":"feedforce"},{"title":"Firestore エミュレーターを使ったテスト同士の競合が起きないようにしていい感じにテストできるようにした話","content":"\u003cp\u003eこんにちは、エンジニアの \u003ca href=\"http://blog.hatena.ne.jp/len_prog/\" class=\"hatena-id-icon\"\u003e\u003cimg src=\"https://cdn.profile-image.st-hatena.com/users/len_prog/profile.png\" width=\"16\" height=\"16\" alt=\"\" class=\"hatena-id-icon\"\u003eid:len_prog\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e私が所属している \u003ca href=\"https://ecbooster.jp/\"\u003eEC Booster\u003c/a\u003e チームでは、「\u003ca href=\"https://support.ecbooster.jp/ja/articles/4854572-%E3%82%AB%E3%82%A4%E3%82%BC%E3%83%B3%E3%82%AB%E3%83%BC%E3%83%89%E3%81%AE%E6%A6%82%E8%A6%81%E3%81%A8%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eカイゼンカード\u003c/a\u003e」機能の開発に Firebase を採用しています。\u003cbr /\u003e\nその中でも特に Cloud Functions for Firebase と Cloud Firestore をメインで使用しており、これらの採用により短い開発期間で機能をリリースすることができました 🎉\u003c/p\u003e\n\n\u003cp\u003eしかし、Firebase を採用したことで苦労したことが全く無かったわけではありません。\u003cbr /\u003e\n特に、テスト周りはインターネット上にもあまり情報が多くない状況で、色々ハマりながら開発をしてきました。\u003c/p\u003e\n\n\u003cp\u003eそこで、今回の記事では、いくつかあったハマりごとの中でも特に厄介だったものについて対策を書いていきます。\u003c/p\u003e\n\n\u003ch1\u003eFirestore Emulator のプロジェクト共有時のデータ競合\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://firebase.google.com/docs/emulator-suite?hl=ja\"\u003eFirebase Local Emulator Suite\u003c/a\u003e を使って Firestore に接続するテストを書いていた際に、\u003cbr /\u003e\nテストを単体で実行した場合には通るのに、他のテストと並列に実行した場合のみドキュメントの状態が予期せぬものになりテストが落ちてしまうことに悩まされました。\u003c/p\u003e\n\n\u003cp\u003e調査の結果、これは、接続先プロジェクトがすべてのテストで同じになってしまっているのが原因ということが分かりました。\u003c/p\u003e\n\n\u003cp\u003eこの状態で同じドキュメントを書き換えるテストが並列で走ってしまった場合、実行タイミングによってはドキュメントが予期せぬ状態になってしまいます。\u003cbr /\u003e\nまた、テスト結果が不安定だとテストが信用できず、実装を保証するものになりません。\u003c/p\u003e\n\n\u003cp\u003eこのままでは役に立つテストが書けないと思い試行錯誤した結果、\u003cstrong\u003eテストごとに違うプロジェクトの Firestore に接続する\u003c/strong\u003eことでそれぞれのテストが独立した状態で実行でき、結果としてデータ競合が防げることが分かりました。\u003c/p\u003e\n\n\u003cp\u003e以下、サンプルアプリケーションを用いてこの方法について書いていきます。\u003c/p\u003e\n\n\u003ch1\u003eサンプルアプリケーションの概要\u003c/h1\u003e\n\n\u003cp\u003e今回は、サンプルとして簡易的な RPG を開発することを想定します。\u003cbr /\u003e\nゲームに登場するキャラクターは、以下のような構造のドキュメントを持つ \u003ccode\u003echaracters\u003c/code\u003e コレクションで管理されています。\u003c/p\u003e\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  name: \u003cspan class=\"synType\"\u003estring\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n  level: \u003cspan class=\"synType\"\u003enumber\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n  job: \u003cspan class=\"synType\"\u003estring\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eまた、このゲームでは以下の行動のみが可能と仮定します(これだけじゃゲームとして成り立たないと思いますが、簡単のためということでお許しください)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eキャラクターは、レベルアップすることができる\u003c/li\u003e\n\u003cli\u003eキャラクターは、転職することができる\n\n\u003cul\u003e\n\u003cli\u003e転職すると、キャラクターのレベルが1に戻る\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eなお、アプリケーション上においてキャラクターのレベルアップは、\u003ccode\u003echaracterLevelUpUseCase\u003c/code\u003e、キャラクターの転職は \u003ccode\u003echaracterJobChangeUseCase\u003c/code\u003e という関数を呼ぶことで行えることとします。\u003c/p\u003e\n\n\u003cp\u003eここからは、実際にこれら2つの関数のテストコードが競合する様子を見ていきます。\u003c/p\u003e\n\n\u003ch1\u003eデータ競合発生時の構成\u003c/h1\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/l/len_prog/20210624/20210624165133.png\" alt=\"f:id:len_prog:20210624165133p:plain:w500\" width=\"1200\" height=\"790\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" style=\"width:500px\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003echaracterJobChangeUseCase\u003c/code\u003e と \u003ccode\u003echaracterLevelUpUseCase\u003c/code\u003e が \u003ccode\u003emy-game\u003c/code\u003e プロジェクトの Firestore を共有してしまっています。\u003cbr /\u003e\nこの状態で両方の関数から同じドキュメントを書き換えてしまった場合、データ競合が発生する可能性があります。\u003cbr /\u003e\nこの場合、実際のコードは以下のようになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterJobChangeUseCase.spec.ts\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e * \u003cspan class=\"synStatement\"\u003eas\u003c/span\u003e admin \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;firebase-admin\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e characterJobChangeUseCase \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;@/usecases/characterJobChangeUseCase\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;my-game\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// ここが問題\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e charactersCollection \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e admin\n  .firestore\u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e\n  .collection\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;characters\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\ndescribe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003echaracterJobChangeUseCase\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e targetCharacterId \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;target-character-id\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\n  beforeEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.set\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n        name: \u003cspan class=\"synConstant\"\u003e\u0026quot;アルス\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        level: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        job: \u003cspan class=\"synConstant\"\u003e\u0026quot;すっぴん\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  afterEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.\u003cspan class=\"synStatement\"\u003edelete();\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  it\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;キャラクターが転職した場合、レベルが1に戻ること\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003easync\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e characterJobChangeUseCase\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1に戻る\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e jobChangedCharacter \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e(await\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.get\u003cspan class=\"synStatement\"\u003e())\u003c/span\u003e.data\u003cspan class=\"synStatement\"\u003e();\u003c/span\u003e\n\n    expect\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003ejobChangedCharacter.level\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.toBe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 実行タイミング次第では、1になるはずが11になってしまう！\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterLevelUpUseCase.spec.ts\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e * \u003cspan class=\"synStatement\"\u003eas\u003c/span\u003e admin \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;firebase-admin\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e characterLevelUpUseCase \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;@/usecases/characterLevelUpUseCase\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;my-game\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// ここが問題\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e charactersCollection \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e admin\n  .firestore\u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e\n  .collection\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;characters\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\ndescribe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003echaracterLevelUpUseCase\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e targetCharacterId \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;target-character-id\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\n  beforeEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.set\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n        name: \u003cspan class=\"synConstant\"\u003e\u0026quot;アルス\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        level: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        job: \u003cspan class=\"synConstant\"\u003e\u0026quot;すっぴん\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  afterEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.\u003cspan class=\"synStatement\"\u003edelete();\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  it\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;キャラクターがレベルアップした場合、レベルが1上がること\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003easync\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e characterLevelUpUseCase\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1上がる\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e grownCharacter \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e(await\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.get\u003cspan class=\"synStatement\"\u003e())\u003c/span\u003e.data\u003cspan class=\"synStatement\"\u003e();\u003c/span\u003e\n\n    expect\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003egrownCharacter.level\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.toBe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e11\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 実行タイミング次第では、11になるはずが1に戻ってしまう！\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e見ての通り、両方のテストが \u003ccode\u003emy-game\u003c/code\u003e プロジェクトの Firestore の、ID: \u003ccode\u003etarget-character-id\u003c/code\u003e のドキュメントを更新してしまっています。\u003cbr /\u003e\nこれらのテストコードを並列で実行した場合、\u003cstrong\u003eキャラクターが転職したのにレベルが1に戻らない\u003c/strong\u003e、\u003cstrong\u003eキャラクターがレベルアップしたはずなのになぜかレベル1に戻ってしまう\u003c/strong\u003eなど予期せぬ状態になってしまい、\nテストが落ちてしまう可能性があります。\u003c/p\u003e\n\n\u003cp\u003eこの状態ではテストコードが信用できないので、テストごとに向き先プロジェクトを変えてこの問題を解決していきます。\u003c/p\u003e\n\n\u003ch1\u003eデータ競合解決後の構成\u003c/h1\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/l/len_prog/20210705/20210705113933.png\" alt=\"f:id:len_prog:20210705113933p:plain:w500\" width=\"1200\" height=\"779\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" style=\"width:500px\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e上図②③のようにテストごとに接続先プロジェクトを独立させることで、他のテストとの並列実行が原因のデータ競合を防ぐことができます。\u003cbr /\u003e\n具体的には、以下のように \u003ccode\u003eadmin.initializeApp()\u003c/code\u003eの第一引数に他のテストと重複しないプロジェクトID を渡すようにします。\u003c/p\u003e\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterJobChangeUseCase.spec.ts\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;character-job-change-use-case-spec\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e//  図の②に対応\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterLevelUpUseCase.spec.ts\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;character-level-up-use-case-spec\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 図の③に対応\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003e変更後のコードの全体像は以下のようになります。\u003c/p\u003e\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterJobChangeUseCase.spec.ts\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e * \u003cspan class=\"synStatement\"\u003eas\u003c/span\u003e admin \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;firebase-admin\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e characterJobChangeUseCase \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;@/usecases/characterJobChangeUseCase\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;character-job-change-use-case-spec\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e//  図の②に対応\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e// ここから下は構成変更前のコードと同じ\u003c/span\u003e\n\n\u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e charactersCollection \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e admin\n  .firestore\u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e\n  .collection\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;characters\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\ndescribe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003echaracterJobChangeUseCase\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e targetCharacterId \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;target-character-id\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\n  beforeEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.set\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n        name: \u003cspan class=\"synConstant\"\u003e\u0026quot;アルス\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        level: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        job: \u003cspan class=\"synConstant\"\u003e\u0026quot;すっぴん\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  afterEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.\u003cspan class=\"synStatement\"\u003edelete();\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  it\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;キャラクターが転職した場合、レベルが1に戻ること\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003easync\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e characterJobChangeUseCase\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1に戻る\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e jobChangedCharacter \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e(await\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.get\u003cspan class=\"synStatement\"\u003e())\u003c/span\u003e.data\u003cspan class=\"synStatement\"\u003e();\u003c/span\u003e\n\n    expect\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003ejobChangedCharacter.level\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.toBe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e1\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 転職するとレベルが1に戻ることを検証できるようになった\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\n\n\u003cpre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink\u003e\u003cspan class=\"synComment\"\u003e// functions/src/usecases/characterLevelUpUseCase.spec.ts\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e * \u003cspan class=\"synStatement\"\u003eas\u003c/span\u003e admin \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;firebase-admin\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\u003cspan class=\"synStatement\"\u003eimport\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e characterLevelUpUseCase \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e \u003cspan class=\"synStatement\"\u003efrom\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;@/usecases/characterLevelUpUseCase\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\nadmin.initializeApp\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  projectId: \u003cspan class=\"synConstant\"\u003e\u0026quot;character-level-up-use-case-spec\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// 図の③に対応\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"synComment\"\u003e// ここから下は構成変更前のコードと同じ\u003c/span\u003e\n\n\u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e charactersCollection \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e admin\n  .firestore\u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e\n  .collection\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;characters\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\ndescribe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003echaracterLevelUpUseCase\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e targetCharacterId \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synConstant\"\u003e\u0026quot;target-character-id\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n\n  beforeEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.set\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n        name: \u003cspan class=\"synConstant\"\u003e\u0026quot;アルス\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        level: \u003cspan class=\"synConstant\"\u003e10\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e\n        job: \u003cspan class=\"synConstant\"\u003e\u0026quot;すっぴん\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  afterEach\u003cspan class=\"synStatement\"\u003e(async\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.\u003cspan class=\"synStatement\"\u003edelete();\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\n  it\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e\u0026quot;キャラクターがレベルアップした場合、レベルが1上がること\u0026quot;\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e,\u003c/span\u003e \u003cspan class=\"synStatement\"\u003easync\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e()\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"synIdentifier\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003eawait\u003c/span\u003e characterLevelUpUseCase\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1上がる\u003c/span\u003e\n    \u003cspan class=\"synStatement\"\u003econst\u003c/span\u003e grownCharacter \u003cspan class=\"synStatement\"\u003e=\u003c/span\u003e \u003cspan class=\"synStatement\"\u003e(await\u003c/span\u003e charactersCollection.doc\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003etargetCharacterId\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.get\u003cspan class=\"synStatement\"\u003e())\u003c/span\u003e.data\u003cspan class=\"synStatement\"\u003e();\u003c/span\u003e\n\n    expect\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003egrownCharacter.level\u003cspan class=\"synStatement\"\u003e)\u003c/span\u003e.toBe\u003cspan class=\"synStatement\"\u003e(\u003c/span\u003e\u003cspan class=\"synConstant\"\u003e11\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e \u003cspan class=\"synComment\"\u003e// レベルアップした場合にレベルが1上がることを検証できるようになった\u003c/span\u003e\n  \u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003cspan class=\"synIdentifier\"\u003e}\u003c/span\u003e\u003cspan class=\"synStatement\"\u003e);\u003c/span\u003e\n\u003c/pre\u003e\n\n\n\u003cp\u003eこのようにテストごとに向き先プロジェクトを変えることで、それぞれのテストで担保したいことをちゃんと担保できるようになります。\u003c/p\u003e\n\n\u003ch1\u003eちょっと微妙な点\u003c/h1\u003e\n\n\u003cp\u003e上記の方法でテストごとに独立した環境の Firestore を操作できるようになり、データ競合を防げるようになりました。\u003c/p\u003e\n\n\u003cp\u003eしかし、この方法にはひとつだけ微妙な点があります。\u003cbr /\u003e\n問題の説明のために、先程掲載した\u003ccode\u003e競合解決後の構成図\u003c/code\u003eを再掲します。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/l/len_prog/20210705/20210705113933.png\" alt=\"f:id:len_prog:20210705113933p:plain:w500\" width=\"1200\" height=\"779\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" style=\"width:500px\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e上図①の接続先は、\u003ccode\u003e$ firebase use\u003c/code\u003e で指定したプロジェクトか、\u003ccode\u003e$ firebase emulators:start\u003c/code\u003e に \u003ccode\u003e--project\u003c/code\u003eを渡した場合にはそのプロジェクトになり、そのほかの方法で変えることは今のところできないようです。\u003c/p\u003e\n\n\u003cp\u003eそのため、プロジェクトをテストごとに分けた場合、上図②③のテスト中にテスト自体は動くものの、Firebase Emulator の UI からデータの内容を見ることはできなくなります。\u003c/p\u003e\n\n\u003cp\u003e一応、接続先を \u003ccode\u003e$ firebase use\u003c/code\u003e で指定しているものに切り替えるようコードを書き換えたりすればデバッグはできますが、\nいちいち書き換えの手間が生じるので若干面倒です。\u003c/p\u003e\n\n\u003cp\u003eまた、これは Firebase Enulator の UI で立ち上がっているすべてのプロジェクトの Firestore を見られるようになれば解決する問題ではあり、実際に \u003ca href=\"https://github.com/firebase/firebase-tools-ui\"\u003efirebase/firebase-tools-ui\u003c/a\u003e リポジトリに \u003ca href=\"https://github.com/firebase/firebase-tools-ui/issues/281\"\u003eissue\u003c/a\u003e も立っていますが、すぐに対応が終わりそうには見えない状況なので、しばらくは不便な状況が続くことが予想されます。\u003c/p\u003e\n\n\u003ch1\u003e所感\u003c/h1\u003e\n\n\u003cp\u003eFirebase は便利ですが、当然ながら全くハマらずに開発できる銀の弾丸ではないですね。\u003cbr /\u003e\nしかし、基本的には便利でドキュメントもそれなりに読みやすく、個人的には使っていて満足感があります。\u003c/p\u003e\n\n\u003cp\u003e今後も日々の開発で得た Firebase や GCP 周りの TIPS を書いていけたらと思っておりますので、よろしくお願いいたします 🙏\u003c/p\u003e\n","contentSnippet":"こんにちは、エンジニアの id:len_prog です。私が所属している EC Booster チームでは、「カイゼンカード」機能の開発に Firebase を採用しています。しかし、Firebase を採用したことで苦労したことが全く無かったわけではありません。そこで、今回の記事では、いくつかあったハマりごとの中でも特に厄介だったものについて対策を書いていきます。Firestore Emulator のプロジェクト共有時のデータ競合Firebase Local Emulator Suite を使って Firestore に接続するテストを書いていた際に、調査の結果、これは、接続先プロジェクトがすべてのテストで同じになってしまっているのが原因ということが分かりました。この状態で同じドキュメントを書き換えるテストが並列で走ってしまった場合、実行タイミングによってはドキュメントが予期せぬ状態になってしまいます。このままでは役に立つテストが書けないと思い試行錯誤した結果、テストごとに違うプロジェクトの Firestore に接続することでそれぞれのテストが独立した状態で実行でき、結果としてデータ競合が防げることが分かりました。以下、サンプルアプリケーションを用いてこの方法について書いていきます。サンプルアプリケーションの概要今回は、サンプルとして簡易的な RPG を開発することを想定します。characters コレクションで管理されています。{  name: string;  level: number;  job: string;}また、このゲームでは以下の行動のみが可能と仮定します(これだけじゃゲームとして成り立たないと思いますが、簡単のためということでお許しください)キャラクターは、レベルアップすることができるキャラクターは、転職することができる転職すると、キャラクターのレベルが1に戻るなお、アプリケーション上においてキャラクターのレベルアップは、characterLevelUpUseCase、キャラクターの転職は characterJobChangeUseCase という関数を呼ぶことで行えることとします。ここからは、実際にこれら2つの関数のテストコードが競合する様子を見ていきます。データ競合発生時の構成characterJobChangeUseCase と characterLevelUpUseCase が my-game プロジェクトの Firestore を共有してしまっています。// functions/src/usecases/characterJobChangeUseCase.spec.tsimport * as admin from \"firebase-admin\";import { characterJobChangeUseCase } from \"@/usecases/characterJobChangeUseCase\";admin.initializeApp({  projectId: \"my-game\", // ここが問題});const charactersCollection = admin  .firestore()  .collection(\"characters\");describe(characterJobChangeUseCase, () =\u003e {  const targetCharacterId = \"target-character-id\";  beforeEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).set({        name: \"アルス\",        level: 10,        job: \"すっぴん\";    });  });  afterEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).delete();  });  it(\"キャラクターが転職した場合、レベルが1に戻ること\", async () =\u003e {    await characterJobChangeUseCase(targetCharacterId); // characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1に戻る    const jobChangedCharacter = (await charactersCollection.doc(targetCharacterId).get()).data();    expect(jobChangedCharacter.level).toBe(1); // 実行タイミング次第では、1になるはずが11になってしまう！  });});// functions/src/usecases/characterLevelUpUseCase.spec.tsimport * as admin from \"firebase-admin\";import { characterLevelUpUseCase } from \"@/usecases/characterLevelUpUseCase\";admin.initializeApp({  projectId: \"my-game\", // ここが問題});const charactersCollection = admin  .firestore()  .collection(\"characters\");describe(characterLevelUpUseCase, () =\u003e {  const targetCharacterId = \"target-character-id\";  beforeEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).set({        name: \"アルス\",        level: 10,        job: \"すっぴん\";    });  });  afterEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).delete();  });  it(\"キャラクターがレベルアップした場合、レベルが1上がること\", async () =\u003e {    await characterLevelUpUseCase(targetCharacterId); // characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1上がる    const grownCharacter = (await charactersCollection.doc(targetCharacterId).get()).data();    expect(grownCharacter.level).toBe(11); // 実行タイミング次第では、11になるはずが1に戻ってしまう！  });});見ての通り、両方のテストが my-game プロジェクトの Firestore の、ID: target-character-id のドキュメントを更新してしまっています。キャラクターが転職したのにレベルが1に戻らない、キャラクターがレベルアップしたはずなのになぜかレベル1に戻ってしまうなど予期せぬ状態になってしまい、テストが落ちてしまう可能性があります。この状態ではテストコードが信用できないので、テストごとに向き先プロジェクトを変えてこの問題を解決していきます。データ競合解決後の構成上図②③のようにテストごとに接続先プロジェクトを独立させることで、他のテストとの並列実行が原因のデータ競合を防ぐことができます。admin.initializeApp()の第一引数に他のテストと重複しないプロジェクトID を渡すようにします。// functions/src/usecases/characterJobChangeUseCase.spec.tsadmin.initializeApp({  projectId: \"character-job-change-use-case-spec\", //  図の②に対応});// functions/src/usecases/characterLevelUpUseCase.spec.tsadmin.initializeApp({  projectId: \"character-level-up-use-case-spec\", // 図の③に対応});変更後のコードの全体像は以下のようになります。// functions/src/usecases/characterJobChangeUseCase.spec.tsimport * as admin from \"firebase-admin\";import { characterJobChangeUseCase } from \"@/usecases/characterJobChangeUseCase\";admin.initializeApp({  projectId: \"character-job-change-use-case-spec\", //  図の②に対応});// ここから下は構成変更前のコードと同じconst charactersCollection = admin  .firestore()  .collection(\"characters\");describe(characterJobChangeUseCase, () =\u003e {  const targetCharacterId = \"target-character-id\";  beforeEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).set({        name: \"アルス\",        level: 10,        job: \"すっぴん\";    });  });  afterEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).delete();  });  it(\"キャラクターが転職した場合、レベルが1に戻ること\", async () =\u003e {    await characterJobChangeUseCase(targetCharacterId); // characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1に戻る    const jobChangedCharacter = (await charactersCollection.doc(targetCharacterId).get()).data();    expect(jobChangedCharacter.level).toBe(1); // 転職するとレベルが1に戻ることを検証できるようになった  });});// functions/src/usecases/characterLevelUpUseCase.spec.tsimport * as admin from \"firebase-admin\";import { characterLevelUpUseCase } from \"@/usecases/characterLevelUpUseCase\";admin.initializeApp({  projectId: \"character-level-up-use-case-spec\", // 図の③に対応});// ここから下は構成変更前のコードと同じconst charactersCollection = admin  .firestore()  .collection(\"characters\");describe(characterLevelUpUseCase, () =\u003e {  const targetCharacterId = \"target-character-id\";  beforeEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).set({        name: \"アルス\",        level: 10,        job: \"すっぴん\";    });  });  afterEach(async () =\u003e {    await charactersCollection.doc(targetCharacterId).delete();  });  it(\"キャラクターがレベルアップした場合、レベルが1上がること\", async () =\u003e {    await characterLevelUpUseCase(targetCharacterId); // characterJobChangeUsecase#handle に渡された引数の ID を持つユーザーのレベルが1上がる    const grownCharacter = (await charactersCollection.doc(targetCharacterId).get()).data();    expect(grownCharacter.level).toBe(11); // レベルアップした場合にレベルが1上がることを検証できるようになった  });});このようにテストごとに向き先プロジェクトを変えることで、それぞれのテストで担保したいことをちゃんと担保できるようになります。ちょっと微妙な点上記の方法でテストごとに独立した環境の Firestore を操作できるようになり、データ競合を防げるようになりました。しかし、この方法にはひとつだけ微妙な点があります。競合解決後の構成図を再掲します。上図①の接続先は、$ firebase use で指定したプロジェクトか、$ firebase emulators:start に --projectを渡した場合にはそのプロジェクトになり、そのほかの方法で変えることは今のところできないようです。そのため、プロジェクトをテストごとに分けた場合、上図②③のテスト中にテスト自体は動くものの、Firebase Emulator の UI からデータの内容を見ることはできなくなります。一応、接続先を $ firebase use で指定しているものに切り替えるようコードを書き換えたりすればデバッグはできますが、いちいち書き換えの手間が生じるので若干面倒です。また、これは Firebase Enulator の UI で立ち上がっているすべてのプロジェクトの Firestore を見られるようになれば解決する問題ではあり、実際に firebase/firebase-tools-ui リポジトリに issue も立っていますが、すぐに対応が終わりそうには見えない状況なので、しばらくは不便な状況が続くことが予想されます。所感Firebase は便利ですが、当然ながら全くハマらずに開発できる銀の弾丸ではないですね。今後も日々の開発で得た Firebase や GCP 周りの TIPS を書いていけたらと思っておりますので、よろしくお願いいたします 🙏","link":"https://developer.feedforce.jp/entry/2021/07/07/103917","isoDate":"2021-07-07T01:39:17.000Z","dateMiliSeconds":1625621957000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/l/len_prog/20210705/20210705113933.png","authorName":"feedforce"},{"title":"【2021年夏】半期に1度の Engineer’s Principles Award 受賞者を紹介します","content":"\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/f/feedforce_recruit/20210611/20210611163915.jpg\" alt=\"f:id:feedforce_recruit:20210611163915j:plain\" width=\"1200\" height=\"700\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eこんにちは。人事の今岡と申します。\n2021年もあっという間に6月ですね。\u003c/p\u003e\n\n\u003cp\u003eフィードフォースでは先日オンライン納会が開催され、半期に一度の「Engineer’s Principles Award 2021 Summer」の受賞者が発表されました。\n今回アワードを受賞した開発メンバーと表彰内容をご紹介します。\u003c/p\u003e\n\n\u003cp\u003e前回の表彰者紹介はコチラ\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2020%2F12%2F28%2F131042\" title=\"半期に1度の Engineer’s Principles Award 受賞者を紹介します - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://developer.feedforce.jp/entry/2020/12/28/131042\"\u003edeveloper.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003eEngineer’s Principles Award とは\u003c/h2\u003e\n\n\u003cp\u003eEngineer’s Principles とは、フィードフォースの開発メンバー向けに現場が主体となって設定した、5つの行動指針です。\n半期に一度、開発メンバー同士で投票を行い、行動指針の項目ごとに最も体現しているメンバーが選ばれ表彰されます。\u003c/p\u003e\n\n\u003cp\u003eEngineer’s Principles についてはこちら\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fmedia.feedforce.jp%2Fn%2Fnd1f2236470b3\" title=\"フィードフォースが目指すエンジニア像とは。「Engineer’s Principles」を紹介します｜フィードフォースのnote\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://media.feedforce.jp/n/nd1f2236470b3\"\u003emedia.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003ch2\u003e受賞者紹介\u003c/h2\u003e\n\n\u003cp\u003e※表彰コメントは本来社内向けのものであるため一部変更させていただいています。受賞者によって各種アカウントを載せています。\u003c/p\u003e\n\n\u003ch3\u003e🏆「Stay Humble; 常に謙虚であるべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@len_prog さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\n社内でメジャーな Rails 以外でバックエンドを実装する際に、なぜそうするのかという理由やレイヤーの切り方を他のメンバーにわかりやすく説明していました。\n一方、自分自身で苦手なことがあった場合に、他の人に相談したり、フィードバックを求めそれを受け入れる姿勢は、まさに Stay Humble だと思いました。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e \u003ca href=\"https://twitter.com/len_prog\"\u003eLen (@len_prog)\u003c/a\u003e , \u003ci class=\"blogicon-entry\"\u003e\u003c/i\u003e \u003ca href=\"https://len-prog.hatenablog.com/\"\u003eBlog\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e@katsunn さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\n事前に色々なアイデアを用意しつつも、相談の過程でお互いの認識や意図を踏まえたうえで改善を進めていく一方、ただ受け入れるだけではなく、\nプロフェッショナルとして自分なりに咀嚼したアウトプットにしていく姿勢が非常に素晴らしく、ベンチマークにすべきだと感じました。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e  \u003ca href=\"https://twitter.com/nomo_017\"\u003eのもち(@nomo_017)\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e🏆「Be Positive \u0026amp; Proactive; 常に肯定的・主体的であるべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@sukechannnn さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nエンジニアとして様々なチームビルディングや開発手法を試しているだけではなく、ビジネス視点からも方向性を考え、\nプロダクトオーナーとしてプロダクトを成長させようとしている姿勢は、まさにこの言葉にぴったりだと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e \u003ca href=\"https://twitter.com/sukechannnn\"\u003e sukechannnn (@sukechannnn)\u003c/a\u003e , \u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/sukechannnn\"\u003esukechannnn\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e@daido1976 さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\n分野を問わず新しいことに前向きに挑戦し、気になったことはどんどん質問するのに加え、\n育休中のメンバーに代わって、率先してチームを引っ張っている行動力が素晴らしいと思いました。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e  \u003ca href=\"https://twitter.com/daido1976\"\u003eDaido Shota (@daido1976)\u003c/a\u003e , \u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e  \u003ca href=\"https://github.com/daido1976\"\u003e daido1976\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e🏆「Be Prepared; 常に来たるべき機会に備えるべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@daido1976 さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\n自分のキャリアや目指すべき方向を踏まえつつ、常にアンテナを立てて知識を広く持とうとしている姿勢がよいと感じています。\nさらに、そうして蓄積したスキルを開発だけではなく、自ら手を挙げ講師をつとめた新卒向け Web 研修にも活かしている点がまさに Be Prepared だと思いました。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e  \u003ca href=\"https://twitter.com/daido1976\"\u003eDaido Shota (@daido1976)\u003c/a\u003e , \u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e  \u003ca href=\"https://github.com/daido1976\"\u003e daido1976\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e@namikingsoft さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nOmni Hub の開発において、あまり開発経験がなかったはずの Rust を使いこなしつつ WAF を含めたインフラ構築をしていて、\n@namikingsoft さんの強みが発揮される局面でした。また dfplus.io でもパフォーマンス改善でコアな知識を活かすなど、まさにこれまでの準備の賜物だと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/namikingsoft\"\u003enamikingsoft\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e🏆「Share All; 己の知見、試行、失敗、遍く共有すべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@masutaka さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nLooker 導入において知見や失敗など社内共有しているほか、そもそも  esa にどう記録すべきかといった、「共有のための知見の共有」にまで配慮しています。\nSlack や esa 、Blog への共有はエンジニアのみならず、全社的にプラスの影響を与えていて、まさに共有の神様と言えるでしょう。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e \u003ca href=\"https://twitter.com/masutaka\"\u003eTakashi Masuda (@masutaka)\u003c/a\u003e , \u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/masutaka\"\u003emasutaka\u003c/a\u003e , \u003ci class=\"blogicon-entry\"\u003e\u003c/i\u003e \u003ca href=\"https://masutaka.net/\"\u003eBlog\u003c/a\u003e\u003c/p\u003e\n\n\u003ch4\u003e@kogai さん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nShopify 周りでは、社内だけでなく社外に対してのプレゼンスを示しています。また Omni Hub の開発で多忙な中、\n社内勉強会 Rust の会では実際の新規事業のプロダクトコードを題材に実践的な知見を共有するなど、その共有力はフィードフォースエンジニアの鑑（かがみ）だと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"blogicon-twitter\"\u003e\u003c/i\u003e \u003ca href=\"https://twitter.com/iamchawan\"\u003e茶碗 (@iamchawan)\u003c/a\u003e ,\u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/kogai\"\u003ekogai\u003c/a\u003e , \u003ci class=\"blogicon-entry\"\u003e\u003c/i\u003e \u003ca href=\"https://k9bookshelf.com/blogs/development\"\u003eBlog\u003c/a\u003e\u003c/p\u003e\n\n\u003ch3\u003e🏆「Just Do It; 全力でやりきるべし」受賞者\u003c/h3\u003e\n\n\u003ch4\u003e@namikingsoftさん\u003c/h4\u003e\n\n\u003cp\u003e表彰コメント：\u003cbr /\u003e\nOmni  Hub リリースまでの道筋をきちんと立ててスケジュール以上の速さで完走して去っていくその姿は、まさに Just Do It でした。\u003c/p\u003e\n\n\u003cp\u003e\u003ci class=\"fa fa-github\" aria-hidden=\"true\"\u003e\u003c/i\u003e \u003ca href=\"https://github.com/namikingsoft\"\u003enamikingsoft\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e周囲の賞賛・承認を共有するよい機会に\u003c/h2\u003e\n\n\u003cp\u003e以上、延べ9名の受賞者でした。\u003c/p\u003e\n\n\u003cp\u003e表彰コメントは、\u003cstrong\u003e開発メンバー同士の投票時に自由記述できるコメントがもとになっているので\u003c/strong\u003e、周囲からの賞賛・承認の声を全社で共有できるよい機会となっています。\u003c/p\u003e\n\n\u003cp\u003e前回に引き続き連続受賞しているメンバーもいますが、投票コメントには毎回違ったエピソードが集まっており、日ごろから継続的に実践をしているからこそ周りのエンジニアの目に留まるのだと感じました。\u003c/p\u003e\n\n\u003cp\u003e受賞者のみなさん、おめでとうございました！\u003c/p\u003e\n","contentSnippet":"こんにちは。人事の今岡と申します。2021年もあっという間に6月ですね。フィードフォースでは先日オンライン納会が開催され、半期に一度の「Engineer’s Principles Award 2021 Summer」の受賞者が発表されました。今回アワードを受賞した開発メンバーと表彰内容をご紹介します。前回の表彰者紹介はコチラdeveloper.feedforce.jpEngineer’s Principles Award とはEngineer’s Principles とは、フィードフォースの開発メンバー向けに現場が主体となって設定した、5つの行動指針です。半期に一度、開発メンバー同士で投票を行い、行動指針の項目ごとに最も体現しているメンバーが選ばれ表彰されます。Engineer’s Principles についてはこちらmedia.feedforce.jp受賞者紹介※表彰コメントは本来社内向けのものであるため一部変更させていただいています。受賞者によって各種アカウントを載せています。🏆「Stay Humble; 常に謙虚であるべし」受賞者@len_prog さん表彰コメント： Len (@len_prog) ,  Blog@katsunn さん表彰コメント：  のもち(@nomo_017)🏆「Be Positive \u0026 Proactive; 常に肯定的・主体的であるべし」受賞者@sukechannnn さん表彰コメント：  sukechannnn (@sukechannnn) ,  sukechannnn@daido1976 さん表彰コメント：  Daido Shota (@daido1976) ,    daido1976🏆「Be Prepared; 常に来たるべき機会に備えるべし」受賞者@daido1976 さん表彰コメント：  Daido Shota (@daido1976) ,    daido1976@namikingsoft さん表彰コメント： namikingsoft🏆「Share All; 己の知見、試行、失敗、遍く共有すべし」受賞者@masutaka さん表彰コメント： Takashi Masuda (@masutaka) ,  masutaka ,  Blog@kogai さん表彰コメント： 茶碗 (@iamchawan) , kogai ,  Blog🏆「Just Do It; 全力でやりきるべし」受賞者@namikingsoftさん表彰コメント： namikingsoft周囲の賞賛・承認を共有するよい機会に以上、延べ9名の受賞者でした。表彰コメントは、開発メンバー同士の投票時に自由記述できるコメントがもとになっているので、周囲からの賞賛・承認の声を全社で共有できるよい機会となっています。前回に引き続き連続受賞しているメンバーもいますが、投票コメントには毎回違ったエピソードが集まっており、日ごろから継続的に実践をしているからこそ周りのエンジニアの目に留まるのだと感じました。受賞者のみなさん、おめでとうございました！","link":"https://developer.feedforce.jp/entry/2021/06/11/164253","isoDate":"2021-06-11T07:42:53.000Z","dateMiliSeconds":1623397373000,"imageUrl":"https://cdn.user.blog.st-hatena.com/default_entry_og_image/4268819/1588226000876991","authorName":"feedforce"},{"title":"プランニングの難しさを乗り越えて...スクラム開発が良い感じになった話","content":"\u003cp\u003eこんにちは。フィードフォースの \u003ca href=\"https://ecbooster.jp/\"\u003eEC Booster\u003c/a\u003e チームで開発（主にプロダクトオーナー）をしている \u003ca href=\"https://twitter.com/sukechannnn\"\u003e@sukechannnn\u003c/a\u003e です。元々ずっとバックエンドエンジニアでしたが、最近プロダクトオーナーをやるようになりました（理由はのちほど！）。\u003c/p\u003e\n\n\u003cp\u003e昨年のアドベントカレンダーで \u003ca href=\"https://developer.feedforce.jp/entry/2020/12/11/172338\"\u003e半年モブプロしたらチームが大きく成長した話\u003c/a\u003e というブログを書いたのですが、2021年3月から \u003cstrong\u003eモブプロを取り入れたスクラム開発\u003c/strong\u003e をしています。それに伴って、\"モブプロ\" と \"個人タスク⇢レビュー\" の両軸で開発するようになりました（\u003ca href=\"https://prtimes.jp/main/html/rd/p/000000040.000071307.html\"\u003e先日リリースしたカイゼンカード\u003c/a\u003e はスクラムで開発しました）。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdeveloper.feedforce.jp%2Fentry%2F2020%2F12%2F11%2F172338\" title=\"半年モブプロしたらチームが大きく成長した話 - Feedforce Developer Blog\" class=\"embed-card embed-blogcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003c/p\u003e\n\n\u003cp\u003e今は良い感じに回っていますが、そうなるまでに色々と試行錯誤したので、そこで得た学びをお伝えできればと思います。全員リモートワークで開発するなら、モブプロを取り入れたスクラムはおすすめです！\u003c/p\u003e\n\n\u003cul class=\"table-of-contents\"\u003e\n    \u003cli\u003e\u003ca href=\"#モブプロの良さと難しさ\"\u003eモブプロの良さと難しさ\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#そうだスクラムしよう\"\u003eそうだ、スクラムしよう！\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#プランニングが終わらない問題\"\u003eプランニングが終わらない問題\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#原因はissue-が散らかっていることだった\"\u003e原因は「issue が散らかっていること」だった\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#issue-をグルーピング優先順位はそれぞれで\"\u003eissue をグルーピング、優先順位はそれぞれで\u003c/a\u003e\u003c/li\u003e\n    \u003cli\u003e\u003ca href=\"#まとめ\"\u003eまとめ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"モブプロの良さと難しさ\"\u003eモブプロの良さと難しさ\u003c/h2\u003e\n\n\u003cp\u003eモブプロ中心の開発を初めた当初は、以下の利点を感じていました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eドメイン知識の共有がしやすい\u003c/li\u003e\n\u003cli\u003eコンテキストの共有がしやすい（\"何をどう作るか\" という議論もしやすい）\u003c/li\u003e\n\u003cli\u003eレビューが要らない\u003c/li\u003e\n\u003cli\u003eリモートワークでもさみしくない（だいじ）\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eしばらくモブプロを続ける中で、開発メンバー全員がドメイン知識やフロント〜バックエンド全体の技術的な知識を共有している状態になりました。なので、なにか悩みがあってモブプロで共有すると「わかる〜」となるし、何より単純に仲良くなったと思います（ﾖｼｯ!!）。\u003c/p\u003e\n\n\u003cp\u003e一方で、だんだんと \u003cstrong\u003eモブプロだけ\u003c/strong\u003e の開発が窮屈になってきました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e知識の共有が進んできて \"全員でやらなくても良くない？\" というタスクが増えてきた\u003c/li\u003e\n\u003cli\u003e個人でじっくり考えた方が良いタスクもあるのが分かった（新しい技術の調査、設計の見直しなど）\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこれはチームが成長したことで出てきた嬉しい悩みなのですが、とはいえ完全にモブプロを辞めるのも上述したメリットを失いそうで怖い...。チーム全員で「今後どう開発していこう？」というのを話し合い、\u003cstrong\u003eモブプロを取り入れたスクラム開発\u003c/strong\u003e を試してみることにしました。\u003c/p\u003e\n\n\u003ch2 id=\"そうだスクラムしよう\"\u003eそうだ、スクラムしよう！\u003c/h2\u003e\n\n\u003cp\u003eスクラム開発をしようと思ったのは、ストーリーポイント\u003ca href=\"#f-9495249b\" name=\"fn-9495249b\" title=\"ストーリーポイント：プロダクトバックログ（タスク）を見積もるためにチームが使う単位で、前回の見積もりに対する相対評価を用いる\"\u003e*1\u003c/a\u003eで見積もって \u003cstrong\u003eベロシティ\u003ca href=\"#f-33d76d3d\" name=\"fn-33d76d3d\" title=\"ベロシティ：スプリントの期間でチームが届けることができる見積もり（ストーリーポイント）の合計のこと\"\u003e*2\u003c/a\u003eを測りたい\u003c/strong\u003e という別の目的もありました。\u003c/p\u003e\n\n\u003cp\u003eモブプロで開発していると新機能のメイン開発は着実に進んでいくのですが、それ以外の細かいタスク（主に保守系）が見積もりづらい状況で、空いた時間にやるという形になってしまっていました（それ用に時間は設けていましたが）。\u003c/p\u003e\n\n\u003cp\u003eモブプロ以外の個人タスクを計画的にやりたい、見積もりもしっかりやりたい、ということで、スクラムを導入することで、\u003cstrong\u003eモブプロと個人開発のいいとこ取り\u003c/strong\u003e をしようと考えました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e新機能開発などのコンテキストの共有が重要なタスクは引き続きモブプロでやる\n\n\u003cul\u003e\n\u003cli\u003eストーリーポイントで見積もる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eそれ以外は個人タスクとして各自で進められるように、プランニングでしっかり整理する\n\n\u003cul\u003e\n\u003cli\u003e個人タスクもストーリーポイントで見積もる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e全てのタスクをストーリーポイントで見積もるのでベロシティが測れるようになる\n\n\u003cul\u003e\n\u003cli\u003e振り返りで見積もりの精度を上げられる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eめっちゃ良さそう...そう思っていざやってみたところ、１つ大きな壁にぶち当たってしまいました。\u003c/p\u003e\n\n\u003ch2 id=\"プランニングが終わらない問題\"\u003eプランニングが終わらない問題\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.shoeisha.co.jp/book/detail/9784798130507\"\u003eエッセンシャルスクラム\u003c/a\u003eにもある通り、１週間のプランニングに２時間以上かけるべきではありません。僕らは「１スプリント=１週間」で回しているため、２時間の予定で始めたプランニングですが、これが終わらない...。最初から何回かは４時間以上かかり、全員ヘトヘトになってしまいました。\u003c/p\u003e\n\n\u003cp\u003eモブプロはプランニングが簡単です。全員やることが同じなので、基本的にタスクが直列で繋がっていきます。そのため「今スプリントはここから⇢ここまで」という感じで Sprint Backlog 的なものを決めることができました。\u003c/p\u003e\n\n\u003cp\u003eしかし、スクラムの見積もりはもっと横断的なものです。単純に、今取り組んでいるものだけ見れば良いのではなく、これから取り組むものをたくさんある issue から選ぶ必要があります。そう、この \u003cstrong\u003eたくさんある issue の中から今スプリントにやるタスクを選ぶこと\u003c/strong\u003e に時間がかかってしまうのです。\u003c/p\u003e\n\n\u003cp\u003e以前にもスクラム開発を試したことがあるのですが、その時もこれが原因でプランニングがとても大変でした。気にするトピックが多すぎてだんだん何について議論してるか分からなくなり、空中戦になってしまうんですよね...。\u003c/p\u003e\n\n\u003cp\u003eその原因は、主に以下の２つでした。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバックログの整理/管理に責任を持つ人（プロダクトオーナー\u003ca href=\"#f-339964b7\" name=\"fn-339964b7\" title=\"プロダクトオーナー：プロダクトバックログの管理をする人で、優先順位を付けることに責任を持つ（１人の人間が務める、委員会ではない）\"\u003e*3\u003c/a\u003e）がいなかった\u003c/li\u003e\n\u003cli\u003eissue の数と種類が多く、バックログリファインメント\u003ca href=\"#f-f2375d03\" name=\"fn-f2375d03\" title=\"バックログリファインメント：プランニングの前にプロダクトバックログを見直し、プランニング可能な状態にしておくこと\"\u003e*4\u003c/a\u003eをしても整理しきれなかった\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eプロダクトオーナー不在の問題は、元々それっぽいことをしていた僕が、改めてプロダクトオーナーやりますと手を上げ、バックログ管理の責任を持つことになりました。\u003c/p\u003e\n\n\u003cp\u003eそれでも、バックログリファインメントが上手く行かない問題は残っていました。リファインメントの概念は理解していて、しっかり時間も取っていたのに、いざプランニングをすると色々な issue を見すぎて伸びてしまう...。過去に何度も直面したこの問題に、改めて取り組むことにしました。\u003c/p\u003e\n\n\u003ch2 id=\"原因はissue-が散らかっていることだった\"\u003e原因は「issue が散らかっていること」だった\u003c/h2\u003e\n\n\u003cp\u003e僕たちが開発している EC Booster は、ショッピング広告の自動運用やデータフィードの更新など、様々なジョブが裏で動いています。そのため、運用作業が日々発生し、運用の中で見つかる例外ケースやバグの修正が多々あります。\nまた、フロントエンドとバックエンドを全員が開発するため、１つのリポジトリで管理していることもあり、色々な種類の issue が１つのレーンに入り乱れてしまっていました。\u003c/p\u003e\n\n\u003cp\u003eそのため、優先順位を付けるのも難しく、また「次スプリントで何をどこまでやるか？」を判断するのが難しくなってしまっていました。\u003c/p\u003e\n\n\u003cp\u003eプロダクトバックログを整理しなければ、というのは分かっているのですが、スクラムに関する本やブログには整理の方法は書いてありません。どうやって整理したら分かりやすくなるかな...と考えていたところ、同僚が共有してくれた以下の記事が参考になりました。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://note.com/gonjyu/n/nd7bf3efa0728\"\u003eエンジニア歴17年の俺が、事業系の開発タスクをバンバン投げてくる非エンジニアに、保守の必要性を死ぬほど分かりやすく説明する。\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこの記事の中で「issueには \"種類\" がある」と言っていて、issue の種類別に整理された図が載っていました。これだ...！\u003c/p\u003e\n\n\u003ch2 id=\"issue-をグルーピング優先順位はそれぞれで\"\u003eissue をグルーピング、優先順位はそれぞれで\u003c/h2\u003e\n\n\u003cp\u003e上記の記事を参考に、issue を \u003cstrong\u003e新機能開発\u003c/strong\u003e、\u003cstrong\u003eバグ修正/運用改善\u003c/strong\u003e、\u003cstrong\u003eライブラリーアップデート\u003c/strong\u003e に分けて、それぞれのレーンで優先順位を付けるようにしました。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"issue をグルーピング、優先順位はそれぞれで\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/s/sukechannnn/20210526/20210526215948.png\" alt=\"f:id:sukechannnn:20210526215948p:plain\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eissue をグルーピング、優先順位はそれぞれで\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003cp\u003eissue の種類が同じなので、優先順位を付けるのは簡単です。さらに、スプリントバックログに入れるタスクを \u003cstrong\u003e新機能開発：運用系 = ６：４\u003c/strong\u003e の割合にする、という決めを作りました。さらに、何回かスプリントを回してベロシティも見えてきました。\u003c/p\u003e\n\n\u003cp\u003eここまで情報が揃うと \u003cstrong\u003e次のスプリントで何をやるか決める基準\u003c/strong\u003e ができてきます。\u003c/p\u003e\n\n\u003cp\u003eそもそもの「次のプランニングでどの issue について話すか？」というのも、それぞれのレーンで優先順位が高い issue を６：４のバランスとベロシティを参考に選べるようになりました。\u003cstrong\u003eプランニングの前\u003c/strong\u003eにプロダクトオーナーが（開発チームと協力しながら）当たりを付けておくことで、プランニングで話すトピックを事前に共有できるようになり、開発メンバーそれぞれが事前に頭を整理しておくこともできるようになりました。\u003c/p\u003e\n\n\u003cp\u003eこれにより、プランニングがかなりスムーズに進むようになったので、いよいよスクラムが回り始めました。新機能開発はモブプロの同期的な開発で、それ以外のタスクは個人タスク⇢レビューという非同期な開発で進められるようになり、デリバリーの最大化を目指しつつ、個人の稼働率も上げられるようになりました。\u003c/p\u003e\n\n\u003cp\u003e\u003cfigure class=\"figure-image figure-image-fotolife\" title=\"GitHub Project を使ってタスク管理してる様子...横に長いんですが、情報が整理されてる方が優先順位を付けやすい\"\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/s/sukechannnn/20210526/20210526212511.png\" alt=\"f:id:sukechannnn:20210526212511p:plain\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003cfigcaption\u003eGitHub Project を使ってタスク管理してる様子...横に長いんですが、情報が整理されてる方が優先順位を付けやすい\u003c/figcaption\u003e\u003c/figure\u003e\u003c/p\u003e\n\n\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\n\n\u003cp\u003eissue をグルーピングしそれぞれで優先順位を付けたことで、プランニングが時間内に収まるようになっただけでなく、プランニングで話すトピックを絞ったことでより深い議論をすることができるようになりました。今は「モブプロを取り入れたスクラム」がとても良い感じに回っています！\u003c/p\u003e\n\n\u003cp\u003e↓ EC Booster チームでの「スプリントの回し方」資料を公開しているので、気になった方はぜひ見てみてください！（もっとこうしたら良いよ！という助言などあれば頂けると嬉しいです！）\u003c/p\u003e\n\n\u003ciframe src=\"https://docs.google.com/presentation/d/e/2PACX-1vTQY639rUAwDDtLfj_c9WbU1E0IlDSFzAbrP-XFCmbg8V_sNKPX_pCvKpiy50CQpS02nXvZnQHBb6JT/embed?start=false\u0026loop=false\u0026delayms=3000\" frameborder=\"0\" width=\"960\" height=\"569\" allowfullscreen=\"true\" mozallowfullscreen=\"true\" webkitallowfullscreen=\"true\"\u003e\u003c/iframe\u003e\n\n\n\u003cp\u003eこんな感じ開発している EC Booster ですが、ただ今 \u003cstrong\u003eバックエンド（Ruby, Rails）が得意なエンジニアを猛烈に必要としています！！！\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eもしちょっっっとでも興味があれば、 \u003cstrong\u003e僕とお話しましょう！\u003c/strong\u003e 以下から気軽に応募してください！\n\u003ca href=\"https://open.talentio.com/1/c/feedforce/requisitions/detail/19785\"\u003ehttps://open.talentio.com/1/c/feedforce/requisitions/detail/19785\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e最後まで読んでいただき、ありがとうございました！\u003c/p\u003e\n\u003cdiv class=\"footnote\"\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-9495249b\" name=\"f-9495249b\" class=\"footnote-number\"\u003e*1\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://www.ryuzee.com/contents/blog/3716\"\u003eストーリーポイント\u003c/a\u003e：プロダクトバックログ（タスク）を見積もるためにチームが使う単位で、前回の見積もりに対する相対評価を用いる\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-33d76d3d\" name=\"f-33d76d3d\" class=\"footnote-number\"\u003e*2\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://www.ryuzee.com/contents/blog/4802\"\u003eベロシティ\u003c/a\u003e：スプリントの期間でチームが届けることができる見積もり（ストーリーポイント）の合計のこと\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-339964b7\" name=\"f-339964b7\" class=\"footnote-number\"\u003e*3\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://www.ryuzee.com/contents/blog/7143\"\u003eプロダクトオーナー\u003c/a\u003e：プロダクトバックログの管理をする人で、優先順位を付けることに責任を持つ（１人の人間が務める、委員会ではない）\u003c/span\u003e\u003c/p\u003e\n\u003cp class=\"footnote\"\u003e\u003ca href=\"#fn-f2375d03\" name=\"f-f2375d03\" class=\"footnote-number\"\u003e*4\u003c/a\u003e\u003cspan class=\"footnote-delimiter\"\u003e:\u003c/span\u003e\u003cspan class=\"footnote-text\"\u003e\u003ca href=\"https://www.ryuzee.com/contents/blog/5024\"\u003eバックログリファインメント\u003c/a\u003e：プランニングの前にプロダクトバックログを見直し、プランニング可能な状態にしておくこと\u003c/span\u003e\u003c/p\u003e\n\u003c/div\u003e","contentSnippet":"こんにちは。フィードフォースの EC Booster チームで開発（主にプロダクトオーナー）をしている @sukechannnn です。元々ずっとバックエンドエンジニアでしたが、最近プロダクトオーナーをやるようになりました（理由はのちほど！）。昨年のアドベントカレンダーで 半年モブプロしたらチームが大きく成長した話 というブログを書いたのですが、2021年3月から モブプロを取り入れたスクラム開発 をしています。それに伴って、\"モブプロ\" と \"個人タスク⇢レビュー\" の両軸で開発するようになりました（先日リリースしたカイゼンカード はスクラムで開発しました）。今は良い感じに回っていますが、そうなるまでに色々と試行錯誤したので、そこで得た学びをお伝えできればと思います。全員リモートワークで開発するなら、モブプロを取り入れたスクラムはおすすめです！モブプロの良さと難しさそうだ、スクラムしよう！プランニングが終わらない問題原因は「issue が散らかっていること」だったissue をグルーピング、優先順位はそれぞれでまとめモブプロの良さと難しさモブプロ中心の開発を初めた当初は、以下の利点を感じていました。ドメイン知識の共有がしやすいコンテキストの共有がしやすい（\"何をどう作るか\" という議論もしやすい）レビューが要らないリモートワークでもさみしくない（だいじ）しばらくモブプロを続ける中で、開発メンバー全員がドメイン知識やフロント〜バックエンド全体の技術的な知識を共有している状態になりました。なので、なにか悩みがあってモブプロで共有すると「わかる〜」となるし、何より単純に仲良くなったと思います（ﾖｼｯ!!）。一方で、だんだんと モブプロだけ の開発が窮屈になってきました。知識の共有が進んできて \"全員でやらなくても良くない？\" というタスクが増えてきた個人でじっくり考えた方が良いタスクもあるのが分かった（新しい技術の調査、設計の見直しなど）これはチームが成長したことで出てきた嬉しい悩みなのですが、とはいえ完全にモブプロを辞めるのも上述したメリットを失いそうで怖い...。チーム全員で「今後どう開発していこう？」というのを話し合い、モブプロを取り入れたスクラム開発 を試してみることにしました。そうだ、スクラムしよう！スクラム開発をしようと思ったのは、ストーリーポイント*1で見積もって ベロシティ*2を測りたい という別の目的もありました。モブプロで開発していると新機能のメイン開発は着実に進んでいくのですが、それ以外の細かいタスク（主に保守系）が見積もりづらい状況で、空いた時間にやるという形になってしまっていました（それ用に時間は設けていましたが）。モブプロ以外の個人タスクを計画的にやりたい、見積もりもしっかりやりたい、ということで、スクラムを導入することで、モブプロと個人開発のいいとこ取り をしようと考えました。新機能開発などのコンテキストの共有が重要なタスクは引き続きモブプロでやるストーリーポイントで見積もるそれ以外は個人タスクとして各自で進められるように、プランニングでしっかり整理する個人タスクもストーリーポイントで見積もる全てのタスクをストーリーポイントで見積もるのでベロシティが測れるようになる振り返りで見積もりの精度を上げられるめっちゃ良さそう...そう思っていざやってみたところ、１つ大きな壁にぶち当たってしまいました。プランニングが終わらない問題エッセンシャルスクラムにもある通り、１週間のプランニングに２時間以上かけるべきではありません。僕らは「１スプリント=１週間」で回しているため、２時間の予定で始めたプランニングですが、これが終わらない...。最初から何回かは４時間以上かかり、全員ヘトヘトになってしまいました。モブプロはプランニングが簡単です。全員やることが同じなので、基本的にタスクが直列で繋がっていきます。そのため「今スプリントはここから⇢ここまで」という感じで Sprint Backlog 的なものを決めることができました。しかし、スクラムの見積もりはもっと横断的なものです。単純に、今取り組んでいるものだけ見れば良いのではなく、これから取り組むものをたくさんある issue から選ぶ必要があります。そう、この たくさんある issue の中から今スプリントにやるタスクを選ぶこと に時間がかかってしまうのです。以前にもスクラム開発を試したことがあるのですが、その時もこれが原因でプランニングがとても大変でした。気にするトピックが多すぎてだんだん何について議論してるか分からなくなり、空中戦になってしまうんですよね...。その原因は、主に以下の２つでした。バックログの整理/管理に責任を持つ人（プロダクトオーナー*3）がいなかったissue の数と種類が多く、バックログリファインメント*4をしても整理しきれなかったプロダクトオーナー不在の問題は、元々それっぽいことをしていた僕が、改めてプロダクトオーナーやりますと手を上げ、バックログ管理の責任を持つことになりました。それでも、バックログリファインメントが上手く行かない問題は残っていました。リファインメントの概念は理解していて、しっかり時間も取っていたのに、いざプランニングをすると色々な issue を見すぎて伸びてしまう...。過去に何度も直面したこの問題に、改めて取り組むことにしました。原因は「issue が散らかっていること」だった僕たちが開発している EC Booster は、ショッピング広告の自動運用やデータフィードの更新など、様々なジョブが裏で動いています。そのため、運用作業が日々発生し、運用の中で見つかる例外ケースやバグの修正が多々あります。また、フロントエンドとバックエンドを全員が開発するため、１つのリポジトリで管理していることもあり、色々な種類の issue が１つのレーンに入り乱れてしまっていました。そのため、優先順位を付けるのも難しく、また「次スプリントで何をどこまでやるか？」を判断するのが難しくなってしまっていました。プロダクトバックログを整理しなければ、というのは分かっているのですが、スクラムに関する本やブログには整理の方法は書いてありません。どうやって整理したら分かりやすくなるかな...と考えていたところ、同僚が共有してくれた以下の記事が参考になりました。エンジニア歴17年の俺が、事業系の開発タスクをバンバン投げてくる非エンジニアに、保守の必要性を死ぬほど分かりやすく説明する。この記事の中で「issueには \"種類\" がある」と言っていて、issue の種類別に整理された図が載っていました。これだ...！issue をグルーピング、優先順位はそれぞれで上記の記事を参考に、issue を 新機能開発、バグ修正/運用改善、ライブラリーアップデート に分けて、それぞれのレーンで優先順位を付けるようにしました。issue をグルーピング、優先順位はそれぞれでissue の種類が同じなので、優先順位を付けるのは簡単です。さらに、スプリントバックログに入れるタスクを 新機能開発：運用系 = ６：４ の割合にする、という決めを作りました。さらに、何回かスプリントを回してベロシティも見えてきました。ここまで情報が揃うと 次のスプリントで何をやるか決める基準 ができてきます。そもそもの「次のプランニングでどの issue について話すか？」というのも、それぞれのレーンで優先順位が高い issue を６：４のバランスとベロシティを参考に選べるようになりました。プランニングの前にプロダクトオーナーが（開発チームと協力しながら）当たりを付けておくことで、プランニングで話すトピックを事前に共有できるようになり、開発メンバーそれぞれが事前に頭を整理しておくこともできるようになりました。これにより、プランニングがかなりスムーズに進むようになったので、いよいよスクラムが回り始めました。新機能開発はモブプロの同期的な開発で、それ以外のタスクは個人タスク⇢レビューという非同期な開発で進められるようになり、デリバリーの最大化を目指しつつ、個人の稼働率も上げられるようになりました。GitHub Project を使ってタスク管理してる様子...横に長いんですが、情報が整理されてる方が優先順位を付けやすいまとめissue をグルーピングしそれぞれで優先順位を付けたことで、プランニングが時間内に収まるようになっただけでなく、プランニングで話すトピックを絞ったことでより深い議論をすることができるようになりました。今は「モブプロを取り入れたスクラム」がとても良い感じに回っています！↓ EC Booster チームでの「スプリントの回し方」資料を公開しているので、気になった方はぜひ見てみてください！（もっとこうしたら良いよ！という助言などあれば頂けると嬉しいです！）こんな感じ開発している EC Booster ですが、ただ今 バックエンド（Ruby, Rails）が得意なエンジニアを猛烈に必要としています！！！もしちょっっっとでも興味があれば、 僕とお話しましょう！ 以下から気軽に応募してください！https://open.talentio.com/1/c/feedforce/requisitions/detail/19785最後まで読んでいただき、ありがとうございました！*1:ストーリーポイント：プロダクトバックログ（タスク）を見積もるためにチームが使う単位で、前回の見積もりに対する相対評価を用いる*2:ベロシティ：スプリントの期間でチームが届けることができる見積もり（ストーリーポイント）の合計のこと*3:プロダクトオーナー：プロダクトバックログの管理をする人で、優先順位を付けることに責任を持つ（１人の人間が務める、委員会ではない）*4:バックログリファインメント：プランニングの前にプロダクトバックログを見直し、プランニング可能な状態にしておくこと","link":"https://developer.feedforce.jp/entry/2021/05/31/104813","isoDate":"2021-05-31T01:48:13.000Z","dateMiliSeconds":1622425693000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/s/sukechannnn/20210526/20210526215948.png","authorName":"feedforce"},{"title":"エンジニアキャリアパスをアップデートしました","content":"\u003cp\u003eこんにちは、\u003ca href=\"https://twitter.com/meihong\"\u003emeihong\u003c/a\u003e です。\u003c/p\u003e\n\n\u003cp\u003e株式会社フィードフォースでは\u003ca href=\"https://media.feedforce.jp/n/nc7a2e89635eb\"\u003e定期評価ではなく本人の希望するタイミングで評価を行う制度\u003c/a\u003eを導入しています。具体的には、各等級ごとに満たすべき基準・条件、またはスキルがあらかじめ提示されており、それを満たしていれば次の等級に進める制度になります。\u003c/p\u003e\n\n\u003cp\u003e\u003ciframe src=\"https://hatenablog-parts.com/embed?url=https%3A%2F%2Fmedia.feedforce.jp%2Fn%2Fn222a08fd3e2b\" title=\"半年に1回の評価制度を毎月の評価制度に変えた話｜フィードフォースのnote\" class=\"embed-card embed-webcard\" scrolling=\"no\" frameborder=\"0\" style=\"display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;\"\u003e\u003c/iframe\u003e\u003ccite class=\"hatena-citation\"\u003e\u003ca href=\"https://media.feedforce.jp/n/n222a08fd3e2b\"\u003emedia.feedforce.jp\u003c/a\u003e\u003c/cite\u003e\u003c/p\u003e\n\n\u003cp\u003eこの基準やスキルを私たちはキャリアパスと呼んでいますが、今回、エンジニアのキャリアパスをアップデートしましたのでご紹介したいと思います。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/meihong/20210524/20210524010544.png\" alt=\"f:id:meihong:20210524010544p:plain\" width=\"1200\" height=\"630\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003ch2\u003eなぜキャリアパスをアップデートしたのか\u003c/h2\u003e\n\n\u003cp\u003eもともとのキャリアパスは\u003ca href=\"https://media.feedforce.jp/n/n222a08fd3e2b\"\u003e導入当初に設計されたもの\u003c/a\u003eをベースに、マネージャやエンジニア、新規事業向けエンジニアといった個々人の志向に応じて細分化されていました。\u003c/p\u003e\n\n\u003cp\u003eこれはこれでよくできたものだったのですが、しばらく運用している中でいくつかの課題点を感じるようになってきました。\n例えば、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e志向ごとに分かれすぎていて、志向を横断した動きが想定しづらくなった。\u003c/li\u003e\n\u003cli\u003e独り立ちと判断される等級であるメンバーとその一つ上のシニアの境界に「見えない高い壁」が存在するようになった。\u003c/li\u003e\n\u003cli\u003eシニア以上の等級になるとチームや会社を牽引することを求められ、技術をそれ以上深掘りすることに対して会社がどう考えているのかが見えづらくなった。\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eといったところです。\u003c/p\u003e\n\n\u003cp\u003e特にキャリアパス全体として、職種問わず等級が上がれば上がるほどチームや会社への影響力が求められる設計になっています。\u003c/p\u003e\n\n\u003cp\u003eもちろんエンジニアも全体への影響力は持つべきなのですが、その持ち方は他の職種と異なり、技術力の広さ、深さといった持ち方もあるのではないかと考えるようになりました。\u003c/p\u003e\n\n\u003cp\u003eここで、個人的にはプロフェッショナルとしてのスキルは体積であり、その底面積はスキルの幅広さだと考えています。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/meihong/20210523/20210523235853.png\" alt=\"f:id:meihong:20210523235853p:plain\" width=\"1200\" height=\"731\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003e極端に底面積が狭いのはさすがに現時点では厳しいとは思いますが、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e底面積がそれなりである代わりに高さ(= 深さ)がある\u003c/li\u003e\n\u003cli\u003e底面積が広い (= 引き出しが多い) 反面高さはそこまででもない\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eの両者は体積という意味では同じはずです。\u003c/p\u003e\n\n\u003cp\u003e\u003cspan itemscope itemtype=\"http://schema.org/Photograph\"\u003e\u003cimg src=\"https://cdn-ak.f.st-hatena.com/images/fotolife/m/meihong/20210524/20210524000640.png\" alt=\"f:id:meihong:20210524000640p:plain\" width=\"1200\" height=\"576\" loading=\"lazy\" title=\"\" class=\"hatena-fotolife\" itemprop=\"image\"\u003e\u003c/span\u003e\u003c/p\u003e\n\n\u003cp\u003eこの両者が共存できる余地が欲しいと考えていました。\u003c/p\u003e\n\n\u003cp\u003eそんな中、弊社デザイナーのキャリアパスがアップデートされました。その中でも目を引いたのは、必須スキルと専門スキルという考え方です。\u003c/p\u003e\n\n\u003cp\u003e必須スキルはデザイナーとして必ず持っていて欲しいスキルである一方、専門スキルは本人の志向、特性に応じてピックアップできるというもので、大学の専攻を思い出す建て付けでした。\u003c/p\u003e\n\n\u003cp\u003e\u003cs\u003eこれをパクる\u003c/s\u003eこれにインスパイアされて、エンジニアのキャリアパスもアップデートすることにしました。\u003c/p\u003e\n\n\u003ch2\u003eどのように更新したのか\u003c/h2\u003e\n\n\u003cp\u003e結果から先にお伝えしておくと、大まかに以下のような方向性に改訂しました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e志向ごとのキャリアパスは止めた。\u003c/li\u003e\n\u003cli\u003e旧来の「志向」を専門スキルに分解し、専門スキルの組み合わせで個々人の志向・特性を表現できるようにした。\u003c/li\u003e\n\u003cli\u003e等級が上がれば上がるほど満たすべき専門スキルの最低数が増えるようにした。\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eその結果として、例えば\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバックエンドエンジニアに特化\u003c/li\u003e\n\u003cli\u003eフルスタックエンジニア\u003c/li\u003e\n\u003cli\u003eフルスタックな知識をベースに事業の 0 → 1 フェイズに参画できるエンジニア\u003c/li\u003e\n\u003cli\u003eカスタマーサクセスエンジニア\u003c/li\u003e\n\u003cli\u003eアジャイルコーチ\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eといった、実際に社内に存在している各エンジニアの志向や得意なポイントを表現できるようになりました。\u003c/p\u003e\n\n\u003ch2\u003e産みの苦しみ\u003c/h2\u003e\n\n\u003cp\u003eここに至るまでには色々な葛藤がありました。\n社内の esa にキャリアパスを更新したいと宣言はしたものの、社内のエンジニア個々人の顔を思い浮かべつつ何を専門スキルとして設定するかを考えると想像以上に難しい問題だということに気付きました。\u003c/p\u003e\n\n\u003ch3\u003e必須スキルと専門スキル\u003c/h3\u003e\n\n\u003cp\u003eそもそも必須スキルと専門スキルとは何か、そこの定義から考えることにしました。\u003c/p\u003e\n\n\u003cp\u003e必須スキルとは文字通り、全てのエンジニアが共通に要求されるスキルセットのことです。どちらかというと「バックエンド」「フロントエンド」といった用語で定義されるスキルセットというよりも「フィードフォースに所属するエンジニアとしての振る舞い方」ではないでしょうか。\u003c/p\u003e\n\n\u003cp\u003eそう考えながら改訂前のキャリアパスを改めて眺めていると、改訂前のキャリアパスはその振る舞いを定義していることに気付きました。その結果、改訂前のキャリアパスが必須スキルのベースとなりました。\u003c/p\u003e\n\n\u003cp\u003eそうです、キャリアパスの改訂によって、より要求水準が上がったとも言えます。\u003c/p\u003e\n\n\u003cp\u003e一方、専門スキルは、本人の得意分野、志向、特性を定義するものです。\nその志向・方向性で貢献するのであれば、各等級ごとにどの水準の成果を出すべきか。それを定義するものが専門スキルになります。\u003c/p\u003e\n\n\u003ch3\u003e専門スキルとはどうあるべきか\u003c/h3\u003e\n\n\u003cp\u003e本人の志向を定義するものが専門スキルと説明しましたが、例えばカスタマーサクセスエンジニアやエンジニアリングマネージャといった職種にしてもエンジニアの延長である以上はエンジニアとしての「共通言語」を身につけているべきです。\u003c/p\u003e\n\n\u003cp\u003eその「共通言語」とは、例えば設計力であったり、フロントエンドやバックエンドのスキルが該当します。\u003c/p\u003e\n\n\u003cp\u003eこういった知識を前提として例えば事業開発であったりチームビルディングを行うべきで、これらの知識がなければエンジニアとの「共通言語」を持っていないと判断せざるを得ません。\u003c/p\u003e\n\n\u003cp\u003e一方で、「フロントエンド力」と「バックエンド力」が同じくらい強いエンジニアというのは SSR エンジニアで、そうそう市場には存在しません。そこで、フルスタックとはいえどこかの分野に軸足を置くことができる制度というのも必須に感じました。\u003c/p\u003e\n\n\u003cp\u003eただ、ここの軸足とはあくまでも「フロントエンド」「バックエンド」「インフラ」といった区分けで、エンジニアとしてコードを書き続ける選択をするのであれば、フロントエンド/バックエンド/インフラといった区分に関係なく設計力・実装力が担保されているべきでしょう。\u003c/p\u003e\n\n\u003ch3\u003e17 の専門スキル\u003c/h3\u003e\n\n\u003cp\u003eここのバランス感が非常に難しい点でしたが、これを元に 17 の専門スキルを定義しました。\nただし、17 の専門スキルは完全に独立しているわけではなく、以下 6 つは本人の志向を定義するものとして、必ずどれか一つが必須選択としました。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバックエンド\u003c/li\u003e\n\u003cli\u003eフロントエンド\u003c/li\u003e\n\u003cli\u003eデータベース\u003c/li\u003e\n\u003cli\u003e基盤\u003c/li\u003e\n\u003cli\u003eカスタマーサクセス\u003c/li\u003e\n\u003cli\u003e組織支援\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eさらに、上記のうち以下 4 つを選択した場合は「実装・設計」と呼ばれるスキルが必須となります。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eバックエンド\u003c/li\u003e\n\u003cli\u003eフロントエンド\u003c/li\u003e\n\u003cli\u003eデータベース\u003c/li\u003e\n\u003cli\u003e基盤\u003c/li\u003e\n\u003c/ul\u003e\n\n\n\u003cp\u003eこれにより、コードを書き続けるのであればただコードを書くだけでなく、実装力・設計力が要求される建て付けを実現しました。\u003c/p\u003e\n\n\u003cp\u003eまた、詳細は省きますが、さらにいくつかの例外を設置することで、「全ての分野で等しく強い SSR なフルスタックエンジニア」が求められないようにしています。\u003c/p\u003e\n\n\u003chr /\u003e\n\n\u003cp\u003e様々なエッジケースを考慮したせいでちょっと複雑になった感の否めない新しいキャリアパスですが、以前のものと比べるとその分より柔軟なものになったと思います。\u003c/p\u003e\n\n\u003cp\u003e今回は敢えて詳細を省きましたが、\u003ca href=\"https://engineers.recruit.feedforce.jp/#entry\"\u003eご興味をお持ちいただけたら是非カジュアル面談でねっちょりとご説明します\u003c/a\u003e！\u003c/p\u003e\n","contentSnippet":"こんにちは、meihong です。株式会社フィードフォースでは定期評価ではなく本人の希望するタイミングで評価を行う制度を導入しています。具体的には、各等級ごとに満たすべき基準・条件、またはスキルがあらかじめ提示されており、それを満たしていれば次の等級に進める制度になります。media.feedforce.jpこの基準やスキルを私たちはキャリアパスと呼んでいますが、今回、エンジニアのキャリアパスをアップデートしましたのでご紹介したいと思います。なぜキャリアパスをアップデートしたのかもともとのキャリアパスは導入当初に設計されたものをベースに、マネージャやエンジニア、新規事業向けエンジニアといった個々人の志向に応じて細分化されていました。これはこれでよくできたものだったのですが、しばらく運用している中でいくつかの課題点を感じるようになってきました。例えば、志向ごとに分かれすぎていて、志向を横断した動きが想定しづらくなった。独り立ちと判断される等級であるメンバーとその一つ上のシニアの境界に「見えない高い壁」が存在するようになった。シニア以上の等級になるとチームや会社を牽引することを求められ、技術をそれ以上深掘りすることに対して会社がどう考えているのかが見えづらくなった。といったところです。特にキャリアパス全体として、職種問わず等級が上がれば上がるほどチームや会社への影響力が求められる設計になっています。もちろんエンジニアも全体への影響力は持つべきなのですが、その持ち方は他の職種と異なり、技術力の広さ、深さといった持ち方もあるのではないかと考えるようになりました。ここで、個人的にはプロフェッショナルとしてのスキルは体積であり、その底面積はスキルの幅広さだと考えています。極端に底面積が狭いのはさすがに現時点では厳しいとは思いますが、底面積がそれなりである代わりに高さ(= 深さ)がある底面積が広い (= 引き出しが多い) 反面高さはそこまででもないの両者は体積という意味では同じはずです。この両者が共存できる余地が欲しいと考えていました。そんな中、弊社デザイナーのキャリアパスがアップデートされました。その中でも目を引いたのは、必須スキルと専門スキルという考え方です。必須スキルはデザイナーとして必ず持っていて欲しいスキルである一方、専門スキルは本人の志向、特性に応じてピックアップできるというもので、大学の専攻を思い出す建て付けでした。これをパクるこれにインスパイアされて、エンジニアのキャリアパスもアップデートすることにしました。どのように更新したのか結果から先にお伝えしておくと、大まかに以下のような方向性に改訂しました。志向ごとのキャリアパスは止めた。旧来の「志向」を専門スキルに分解し、専門スキルの組み合わせで個々人の志向・特性を表現できるようにした。等級が上がれば上がるほど満たすべき専門スキルの最低数が増えるようにした。その結果として、例えばバックエンドエンジニアに特化フルスタックエンジニアフルスタックな知識をベースに事業の 0 → 1 フェイズに参画できるエンジニアカスタマーサクセスエンジニアアジャイルコーチといった、実際に社内に存在している各エンジニアの志向や得意なポイントを表現できるようになりました。産みの苦しみここに至るまでには色々な葛藤がありました。社内の esa にキャリアパスを更新したいと宣言はしたものの、社内のエンジニア個々人の顔を思い浮かべつつ何を専門スキルとして設定するかを考えると想像以上に難しい問題だということに気付きました。必須スキルと専門スキルそもそも必須スキルと専門スキルとは何か、そこの定義から考えることにしました。必須スキルとは文字通り、全てのエンジニアが共通に要求されるスキルセットのことです。どちらかというと「バックエンド」「フロントエンド」といった用語で定義されるスキルセットというよりも「フィードフォースに所属するエンジニアとしての振る舞い方」ではないでしょうか。そう考えながら改訂前のキャリアパスを改めて眺めていると、改訂前のキャリアパスはその振る舞いを定義していることに気付きました。その結果、改訂前のキャリアパスが必須スキルのベースとなりました。そうです、キャリアパスの改訂によって、より要求水準が上がったとも言えます。一方、専門スキルは、本人の得意分野、志向、特性を定義するものです。その志向・方向性で貢献するのであれば、各等級ごとにどの水準の成果を出すべきか。それを定義するものが専門スキルになります。専門スキルとはどうあるべきか本人の志向を定義するものが専門スキルと説明しましたが、例えばカスタマーサクセスエンジニアやエンジニアリングマネージャといった職種にしてもエンジニアの延長である以上はエンジニアとしての「共通言語」を身につけているべきです。その「共通言語」とは、例えば設計力であったり、フロントエンドやバックエンドのスキルが該当します。こういった知識を前提として例えば事業開発であったりチームビルディングを行うべきで、これらの知識がなければエンジニアとの「共通言語」を持っていないと判断せざるを得ません。一方で、「フロントエンド力」と「バックエンド力」が同じくらい強いエンジニアというのは SSR エンジニアで、そうそう市場には存在しません。そこで、フルスタックとはいえどこかの分野に軸足を置くことができる制度というのも必須に感じました。ただ、ここの軸足とはあくまでも「フロントエンド」「バックエンド」「インフラ」といった区分けで、エンジニアとしてコードを書き続ける選択をするのであれば、フロントエンド/バックエンド/インフラといった区分に関係なく設計力・実装力が担保されているべきでしょう。17 の専門スキルここのバランス感が非常に難しい点でしたが、これを元に 17 の専門スキルを定義しました。ただし、17 の専門スキルは完全に独立しているわけではなく、以下 6 つは本人の志向を定義するものとして、必ずどれか一つが必須選択としました。バックエンドフロントエンドデータベース基盤カスタマーサクセス組織支援さらに、上記のうち以下 4 つを選択した場合は「実装・設計」と呼ばれるスキルが必須となります。バックエンドフロントエンドデータベース基盤これにより、コードを書き続けるのであればただコードを書くだけでなく、実装力・設計力が要求される建て付けを実現しました。また、詳細は省きますが、さらにいくつかの例外を設置することで、「全ての分野で等しく強い SSR なフルスタックエンジニア」が求められないようにしています。様々なエッジケースを考慮したせいでちょっと複雑になった感の否めない新しいキャリアパスですが、以前のものと比べるとその分より柔軟なものになったと思います。今回は敢えて詳細を省きましたが、ご興味をお持ちいただけたら是非カジュアル面談でねっちょりとご説明します！","link":"https://developer.feedforce.jp/entry/career_path_revised_2021","isoDate":"2021-05-24T02:00:00.000Z","dateMiliSeconds":1621821600000,"imageUrl":"https://cdn-ak.f.st-hatena.com/images/fotolife/m/meihong/20210524/20210524010544.png","authorName":"feedforce"}]},"__N_SSG":true},"page":"/members/[name]","query":{"name":"feedforce"},"buildId":"mi63eZuVRmqxethcaeHA7","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"name":"viewport","content":"width=device-width"}],["meta",{"charSet":"utf-8"}],["link",{"rel":"icon shortcut","type":"image/png","href":"https://engineers.feedforce.jp/logo.png"}],["link",{"rel":"stylesheet","href":"https://fonts.googleapis.com/css2?family=Inter:wght@400;700\u0026display=swap"}],["title",{"children":"feedforce | Feedforce Engineers' Blogs"}],["meta",{"property":"og:title","content":"feedforce"}],["meta",{"property":"og:url","content":"https://engineers.feedforce.jp/members/feedforce"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"property":"og:site","content":"Feedforce Engineers' Blogs"}],["meta",{"property":"og:image","content":"https://engineers.feedforce.jp/og.png"}],["link",{"rel":"canonical","href":"https://engineers.feedforce.jp/members/feedforce"}],["link",{"rel":"alternate","type":"application/rss+xml","title":"Feedforce Engineers' Blogs","href":"https://engineers.feedforce.jp/rss.xml"}],["link",{"rel":"alternate","type":"application/atom+xml","title":"Feedforce Engineers' Blogs","href":"https://engineers.feedforce.jp/atom.xml"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-fa276ba060a4a8ac7eef.js"></script><script src="/_next/static/chunks/main-8a83f0fd99327c4684a8.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.1daf1ec1ecf144ee9147.js" async=""></script><script src="/_next/static/chunks/commons.9e003f150a446b53bdd9.js" async=""></script><script src="/_next/static/chunks/pages/_app-99db904e083fc7f74e35.js" async=""></script><script src="/_next/static/chunks/588505f8033a39c9ef82bc46b1145ac9fd1db500.3cbfcbb348d8e2af19e7.js" async=""></script><script src="/_next/static/chunks/pages/members/%5Bname%5D-42a7756adc6c0800b4dc.js" async=""></script><script src="/_next/static/mi63eZuVRmqxethcaeHA7/_buildManifest.js" async=""></script><script src="/_next/static/mi63eZuVRmqxethcaeHA7/_ssgManifest.js" async=""></script></body></html>